<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CNC Planner Pro</title>
<style>
 /* ================================================================
 CNC PLANER PRO v18 ‚Äî INDUSTRIAL DESIGN
 Best-in-class Professional Maschinenbau Aesthetic
 Based on: Golden Standards + MBS Angebot Analysis
 ================================================================ */
 
 :root {
 /* Colors */
 --color-primary: #1F2937;
 --color-primary-hover: #111827;
 --color-primary-light: #374151;
 --color-text: #111827;
 --color-text-secondary: #374151;
 --color-text-muted: #6B7280;
 --color-text-hint: #9CA3AF;
 --color-bg: #F9FAFB;
 --color-surface: #FFFFFF;
 --color-bg-subtle: #F3F4F6;
 --color-bg-muted: #F3F4F6;
 --color-bg-emphasis: #E5E7EB;
 --color-bg-elevated: #FFFFFF;
 --color-border: #E5E7EB;
 --color-border-light: #F3F4F6;
 --color-success: #059669;
 --color-success-light: #ECFDF5;
 --color-warning: #D97706;
 --color-warning-light: #FFFBEB;
 --color-error: #DC2626;
 --color-error-light: #FEF2F2;
 --color-info: #2563EB;
 --color-info-light: #EFF6FF;
 /* Type */
 --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
 --font-mono: "SF Mono", Monaco, "Cascadia Code", Consolas, monospace;
 --text-xs: 0.6875rem;
 --text-sm: 0.8125rem;
 --text-base: 0.8125rem;
 --text-lg: 0.9375rem;
 --text-xl: 1.0625rem;
 --text-2xl: 1.25rem;
 --text-3xl: 1.375rem;
 --font-normal: 400;
 --font-medium: 500;
 --font-semibold: 600;
 --font-bold: 700;
 --leading-tight: 1.3;
 --leading-normal: 1.5;
 --leading-relaxed: 1.65;
 /* Spacing ‚Äî tighter */
 --space-1: 0.25rem;
 --space-2: 0.375rem;
 --space-3: 0.5rem;
 --space-4: 0.75rem;
 --space-5: 1rem;
 --space-6: 1.25rem;
 --space-8: 1.5rem;
 --space-10: 2rem;
 --space-12: 2.5rem;
 /* Layout */
 --sidebar-width: 200px;
 --header-height: 44px;
 /* Borders */
 --radius: 6px;
 --radius-sm: 4px;
 --radius-md: 8px;
 /* Shadows */
 --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
 --shadow-card: 0 1px 3px rgba(0,0,0,0.08);
 }
 
 /* ================================================================
 RESET & BASE
 ================================================================ */
 
 *, *::before, *::after {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }
 
 html, body {
 height: 100%;
 }
 
 body {
 font-family: var(--font-sans);
 font-size: var(--text-base);
 line-height: var(--leading-normal);
 color: var(--color-text);
 background: var(--color-bg);
 -webkit-font-smoothing: antialiased;
 -moz-osx-font-smoothing: grayscale;
 }
 
 /* ================================================================
 LAYOUT
 ================================================================ */
 
 .app {
 display: flex;
 min-height: 100vh;
 }
 
 /* === SIDEBAR === */
 .sidebar {
 width: var(--sidebar-width);
 background: var(--color-primary);
 color: white;
 display: flex;
 flex-direction: column;
 border-right: 1px solid rgba(0, 0, 0, 0.1);
 }
 
 .sidebar-header {
 padding: var(--space-4) var(--space-4);
 border-bottom: 1px solid rgba(255, 255, 255, 0.08);
 }
 
 .sidebar-logo {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 }
 
 .sidebar-logo-icon {
 width: 28px;
 height: 28px;
 background: rgba(255, 255, 255, 0.15);
 border-radius: var(--radius-sm);
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: var(--font-bold);
 font-size: 11px;
 }
 
 .sidebar-logo-text {
 font-size: var(--text-base);
 font-weight: var(--font-semibold);
 letter-spacing: -0.01em;
 }
 
 .sidebar-logo-text span {
 font-weight: var(--font-normal);
 opacity: 0.8;
 }
 
 /* === NAVIGATION === */
 .sidebar-nav {
 flex: 1;
 padding: var(--space-4);
 overflow-y: auto;
 }
 
 .nav-item {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 padding: 6px 10px;
 margin-bottom: 1px;
 background: transparent;
 border: none;
 border-left: 2px solid transparent;
 border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
 color: rgba(255, 255, 255, 0.6);
 font-size: 13px;
 font-weight: var(--font-normal);
 cursor: pointer;
 transition: all 100ms ease;
 width: 100%;
 text-align: left;
 }
 
 .nav-item:hover {
 background: rgba(255, 255, 255, 0.06);
 color: rgba(255, 255, 255, 0.9);
 }
 
 .nav-item.active {
 background: rgba(255, 255, 255, 0.1);
 border-left-color: #D97706;
 color: white;
 font-weight: var(--font-medium);
 }
 
 /* === MAIN CONTENT === */
 .main-content {
 flex: 1;
 overflow-y: auto;
 padding: var(--space-5) var(--space-6);
 max-width: 880px;
 }
 
 /* === HEADER === */
 .main-header {
 height: var(--header-height);
 background: var(--color-surface);
 border-bottom: 1px solid var(--color-border);
 display: flex;
 align-items: center;
 justify-content: space-between;
 padding: 0 var(--space-6);
 flex-shrink: 0;
 }
 
 .main-title {
 font-size: 15px;
 font-weight: var(--font-semibold);
 color: var(--color-text);
 letter-spacing: -0.01em;
 }
 
 /* === CONTENT AREA === */
 .content-area {
 flex: 1;
 overflow-y: auto;
 padding: var(--space-5) var(--space-6);
 max-width: 880px;
 }
 
 .section {
 display: none;
 }
 
 .section.active {
 display: block;
 }
 
 /* ================================================================
 CARDS
 ================================================================ */
 
 .card {
 background: var(--color-surface);
 border: 1px solid var(--color-border);
 border-radius: var(--radius);
 margin-bottom: var(--space-4);
 }
 
 .card-header {
 padding: 8px 12px;
 border-bottom: 1px solid var(--color-border);
 background: var(--color-bg-subtle);
 font-weight: var(--font-semibold);
 font-size: 12px;
 text-transform: uppercase;
 letter-spacing: 0.4px;
 color: var(--color-text-muted);
 display: flex;
 align-items: center;
 justify-content: space-between;
 }
 
 /* NO colored headers - all same gray */
 .card-header-primary,
 .card-header-info,
 .card-header-success,
 .card-header-warning {
 background: var(--color-bg-muted);
 border-bottom-color: var(--color-border-light);
 }
 
 .card-body {
 padding: 12px;
 }
 
 /* ================================================================
 TABLES (Main Component)
 ================================================================ */
 
 .table {
 width: 100%;
 border-collapse: collapse;
 font-size: var(--text-base);
 }
 
 /* === TABLE HEADER === */
 .table thead {
 background: var(--color-bg-muted); /* Hellgrau wie MBS #F0F0F0 */
 }
 
 .table th {
 padding: var(--space-2) var(--space-3);
 text-align: left;
 font-weight: var(--font-semibold);
 color: var(--color-text-secondary);
 border-bottom: 2px solid var(--color-border);
 font-size: var(--text-sm);
 text-transform: uppercase;
 letter-spacing: 0.05em;
 }
 
 .table th:last-child,
 .table th.right {
 text-align: right;
 }
 
 /* === TABLE BODY === */
 .table td {
 padding: var(--space-3);
 border-bottom: 1px solid var(--color-border-light);
 color: var(--color-text);
 }
 
 .table td:last-child,
 .table td.right {
 text-align: right;
 font-variant-numeric: tabular-nums;
 font-weight: var(--font-medium);
 }
 
 .table tr:last-child td {
 border-bottom: none;
 }
 
 .table tbody tr:hover {
 background: var(--color-bg-subtle);
 }
 
 /* === SPECIAL ROWS === */
 .table .subtotal-row {
 background: var(--color-bg-subtle);
 font-weight: var(--font-medium);
 }
 
 .table .total-row {
 background: var(--color-bg-muted);
 border-top: 2px solid var(--color-border);
 font-weight: var(--font-bold);
 font-size: var(--text-lg);
 }
 
 .table .grand-total-row {
 background: var(--color-primary);
 color: white;
 font-weight: var(--font-bold);
 font-size: var(--text-xl);
 }
 
 /* === POSITION NUMBER (10, 20, 30...) === */
 .table .position-nr {
 width: 50px;
 text-align: right;
 font-weight: normal;
 font-variant-numeric: tabular-nums;
 }
 
 /* Drawing Number (Zeichnungsnummer) */
 .drawing-number {
 font-size: 13px;
 color: #374151;
 font-family: var(--font-mono);
 margin-top: 2px;
 }
 
 /* === MONOSPACE === */
 .table .mono {
 font-family: var(--font-mono);
 font-size: var(--text-sm);
 }
 
 /* ================================================================
 GRID LAYOUTS
 ================================================================ */
 
 .grid-2 {
 display: grid;
 grid-template-columns: 1fr 1fr;
 gap: var(--space-4);
 }
 
 .grid-3 {
 display: grid;
 grid-template-columns: repeat(3, 1fr);
 gap: var(--space-4);
 }
 
 /* ================================================================
 TYPOGRAPHY
 ================================================================ */
 
 h1, h2, h3, h4, h5, h6 {
 font-weight: var(--font-semibold);
 line-height: var(--leading-tight);
 color: var(--color-text);
 margin-bottom: var(--space-4);
 }
 
 h1 { font-size: var(--text-3xl); }
 h2 { font-size: var(--text-2xl); }
 h3 { font-size: var(--text-xl); }
 h4 { font-size: var(--text-lg); }
 
 /* ================================================================
 BUTTONS
 ================================================================ */
 
 .btn {
 display: inline-flex;
 align-items: center;
 justify-content: center;
 gap: 6px;
 padding: 0 12px;
 height: 32px;
 border-radius: var(--radius-sm);
 font-size: 13px;
 font-weight: var(--font-medium);
 cursor: pointer;
 transition: all 100ms ease;
 border: 1px solid var(--color-border);
 background: white;
 color: var(--color-text);
 white-space: nowrap;
 }
 
 .btn:hover {
 background: var(--color-bg-subtle);
 border-color: var(--color-text-muted);
 }
 
 .btn-primary {
 background: var(--color-primary);
 color: white;
 border-color: var(--color-primary);
 }
 
 .btn-primary:hover {
 background: var(--color-primary-hover);
 }
 
 .btn-secondary {
 background: white;
 color: var(--color-text-secondary);
 }
 
 .btn-sm {
 height: 26px;
 padding: 0 8px;
 font-size: 12px;
 }
 
 /* ================================================================
 FORM INPUTS
 ================================================================ */
 
 input[type="text"],
 input[type="number"],
 input[type="email"],
 select,
 textarea {
 width: 100%;
 padding: 0 10px;
 height: 32px;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 font-size: 13px;
 font-family: var(--font-sans);
 color: var(--color-text);
 background: white;
 transition: border-color 100ms;
 }
 
 textarea { height: auto; padding: 8px 10px; }
 
 input:focus,
 select:focus,
 textarea:focus {
 outline: none;
 border-color: var(--color-primary);
 box-shadow: 0 0 0 1px var(--color-primary);
 }
 
 /* ================================================================
 INFO BOX
 ================================================================ */
 
 .info-box {
 background: var(--color-bg-subtle);
 border: 1px solid var(--color-border-light);
 border-left-width: 3px;
 border-left-color: var(--color-primary);
 padding: var(--space-3) var(--space-4);
 border-radius: var(--radius);
 font-size: var(--text-sm);
 line-height: var(--leading-relaxed);
 color: var(--color-text-secondary);
 }
 
 /* ================================================================
 ANGEBOT-SPECIFIC
 ================================================================ */
 
 /* === PART INFO === */
 .part-info {
 margin-bottom: var(--space-4);
 }
 
 .part-name {
 font-size: var(--text-lg);
 font-weight: var(--font-semibold);
 color: var(--color-text);
 }
 
 .drawing-nr {
 font-size: var(--text-sm);
 color: var(--color-text-muted);
 font-family: var(--font-mono);
 margin-top: var(--space-1);
 }
 
 .drawing-nr::before {
 content: "Zeichnung-Nr.: ";
 font-family: var(--font-sans);
 }
 
 /* === VALIDITY === */
 .validity {
 font-size: var(--text-sm);
 color: var(--color-text-muted);
 margin-top: var(--space-2);
 }
 
 .validity strong {
 color: var(--color-text);
 font-weight: var(--font-semibold);
 }
 
 /* === DISCLAIMER === */
 .disclaimer {
 padding: var(--space-4);
 background: var(--color-bg-subtle);
 border-left: 3px solid var(--color-border);
 font-size: var(--text-sm);
 color: var(--color-text-secondary);
 line-height: var(--leading-relaxed);
 margin-top: var(--space-6);
 }
 
 /* === LEGAL FOOTER === */
 .legal-footer {
 margin-top: var(--space-12);
 padding-top: var(--space-6);
 border-top: 1px solid var(--color-border-light);
 font-size: var(--text-xs);
 color: var(--color-text-muted);
 line-height: var(--leading-relaxed);
 }
 
 .contact-footer {
 margin-top: var(--space-6);
 font-size: var(--text-xs);
 color: var(--color-text-hint);
 line-height: var(--leading-tight);
 }
 
 /* ================================================================
 LOADING OVERLAY
 ================================================================ */
 
 .loading-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(255, 255, 255, 0.95);
 display: none;
 align-items: center;
 justify-content: center;
 z-index: 9999;
 }
 
 .loading-overlay.active {
 display: flex;
 }
 
 .loading-spinner {
 width: 48px;
 height: 48px;
 border: 4px solid var(--color-border-light);
 border-top-color: var(--color-primary);
 border-radius: 50%;
 animation: spin 0.8s linear infinite;
 }
 
 @keyframes spin {
 to { transform: rotate(360deg); }
 }
 
 /* ================================================================
 UTILITIES
 ================================================================ */
 
 .mb-4 { margin-bottom: var(--space-4); }
 .mb-6 { margin-bottom: var(--space-6); }
 .mb-8 { margin-bottom: var(--space-8); }
 .mt-4 { margin-top: var(--space-4); }
 .mt-6 { margin-top: var(--space-6); }
 
 /* ================================================================
 PRINT STYLES
 ================================================================ */
 
 /* Badges */
 .badge {
 display: inline-block;
 font-size: 10px;
 font-weight: 600;
 padding: 2px 8px;
 border-radius: 3px;
 margin-left: var(--space-2);
 }
 .badge-info { background: var(--color-info-light); color: var(--color-info); }
 .badge-error { background: var(--color-error-light); color: var(--color-error); }
 .badge-success { background: var(--color-success-light); color: var(--color-success); }
 .badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
 
 /* Price Hero */
 .price-hero {
 text-align: center;
 padding: var(--space-5) 0;
 margin-bottom: var(--space-4);
 }
 .price-label { font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
 .price-value { font-size: 36px; font-weight: 700; color: var(--color-text); font-family: var(--font-mono); letter-spacing: -1px; }
 .price-detail { font-size: 12px; color: var(--color-text-hint); margin-top: 4px; }
 
 .confidence-badge {
 display: inline-flex;
 align-items: center;
 gap: var(--space-2);
 padding: var(--space-2) var(--space-3);
 border-radius: var(--radius-md);
 font-size: 12px;
 margin-top: var(--space-3);
 }
 .confidence-high { background: var(--color-success-light); color: var(--color-success); }
 .confidence-medium { background: var(--color-warning-light); color: var(--color-warning); }
 .confidence-low { background: var(--color-error-light); color: var(--color-error); }
 
 /* Cost Breakdown */
 .cost-breakdown { padding: var(--space-3); }
 .cost-row {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-2) 0;
 border-bottom: 1px solid var(--color-border-light);
 }
 .cost-row:last-child { border-bottom: none; }
 .cost-row.subtotal { background: var(--color-bg); padding: var(--space-2) var(--space-3); margin: var(--space-2) calc(-1 * var(--space-3)); border-bottom: none; }
 .cost-row.total { background: var(--color-primary); color: white; padding: var(--space-3); margin: var(--space-2) calc(-1 * var(--space-3)) calc(-1 * var(--space-3)); border-radius: 0 0 var(--radius-md) var(--radius-md); border-bottom: none; }
 .cost-label { font-size: 13px; }
 .cost-value { font-weight: 600; font-family: var(--font-mono); font-size: 14px; }
 .cost-formula { font-size: 11px; color: var(--color-text-muted); font-family: var(--font-mono); }
 
 /* Code Block */
 .code-block {
 background: #1a1a2e;
 color: #e2e8f0;
 padding: var(--space-4);
 border-radius: var(--radius-md);
 font-family: var(--font-mono);
 font-size: 12px;
 line-height: 1.6;
 overflow-x: auto;
 white-space: pre;
 }
 .code-comment { color: #6b7280; }
 .code-keyword { color: #60a5fa; }
 .code-number { color: #34d399; }
 
 /* Contact Footer */
 .contact-footer { font-size: 11px; color: var(--color-text-hint); }
 
 /* Instruction sections */
 .instruction-section { margin-bottom: var(--space-4); }
 .instruction-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-3) var(--space-4);
 background: var(--color-bg);
 border-bottom: 1px solid var(--color-border);
 }
 .instruction-content { padding: var(--space-4); }
 
 /* Dimension groups */
 .dimension-group {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 margin-bottom: var(--space-3);
 }
 .dimension-group .form-group { margin-bottom: 0; flex: 1; }
 .dimension-separator { color: var(--color-text-muted); font-size: 16px; }
 .input-with-unit {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 }
 .input-with-unit .input { flex: 1; }
 .input-unit { font-size: 12px; color: var(--color-text-muted); white-space: nowrap; }
 
 /* Tooltip */
 .tooltip { position: relative; }
 
 /* Main content */
 main.main { flex: 1; overflow-y: auto; }
 
 /* Nav sections */
 .nav-section { margin-bottom: var(--space-3); }
 .nav-section-title {
 font-size: 10px;
 font-weight: var(--font-semibold);
 text-transform: uppercase;
 letter-spacing: 0.8px;
 color: rgba(255, 255, 255, 0.35);
 padding: 8px 12px 4px;
 }
 
 /* Select */
 .select {
 width: 100%;
 padding: var(--space-2) var(--space-3);
 border: 1px solid var(--color-border);
 border-radius: var(--radius);
 background: white;
 font-size: var(--text-base);
 color: var(--color-text);
 font-family: var(--font-sans);
 appearance: auto;
 }
 .select:focus { outline: 2px solid var(--color-primary); outline-offset: -1px; }
 
 /* Form groups */
 .form-group { margin-bottom: 12px; }
 
 /* Form utilities */
 .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: var(--color-text-secondary); }
 .form-label-caps { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-2); color: var(--color-text-muted); }
 .input-mono { font-family: var(--font-mono); }
 .input-sm { padding: var(--space-1) var(--space-2); font-size: 13px; }
 .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4); }
 .warning-box { background: var(--color-warning-light); border-left: 3px solid var(--color-warning); padding: var(--space-3); border-radius: var(--radius-sm); font-size: 13px; margin-bottom: var(--space-4); }
 
 /* Main actions */
 .main-actions { display: flex; gap: var(--space-2); }
 
 /* Loading steps */
 .loading-steps { margin-top: var(--space-5); }
 .loading-step {
 display: flex;
 align-items: center;
 gap: var(--space-3);
 padding: var(--space-2) 0;
 color: var(--color-text-muted);
 font-size: 14px;
 }
 .loading-step.active { color: var(--color-primary); font-weight: 600; }
 .loading-step.done { color: var(--color-success); }
 .loading-step-icon {
 width: 24px;
 height: 24px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 12px;
 font-weight: 600;
 background: var(--color-bg);
 border: 1px solid var(--color-border);
 }
 .loading-step.active .loading-step-icon { background: var(--color-primary); color: white; border-color: var(--color-primary); }
 .loading-step.done .loading-step-icon { background: var(--color-success); color: white; border-color: var(--color-success); }
 
 /* Feedback */
 .feedback-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); margin-bottom: var(--space-4); }
 .feedback-option {
 display: flex;
 flex-direction: column;
 align-items: center;
 gap: var(--space-2);
 padding: var(--space-4);
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 cursor: pointer;
 transition: border-color 0.15s;
 }
 .feedback-option:hover { border-color: var(--color-primary); }
 .feedback-option.selected { border-color: var(--color-primary); background: var(--color-bg); }
 .feedback-option-icon { font-size: 24px; }
 .feedback-option-label { font-size: 12px; font-weight: 600; }
 .feedback-card { margin-bottom: var(--space-4); }
 
 /* Sticky Feedback FAB */
 .feedback-fab {
 position: fixed;
 bottom: 20px;
 right: 20px;
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background: var(--color-primary);
 color: white;
 border: none;
 font-size: 18px;
 font-weight: 700;
 cursor: pointer;
 box-shadow: 0 2px 8px rgba(0,0,0,0.2);
 z-index: 1000;
 transition: transform 0.15s;
 }
 .feedback-fab:hover { transform: scale(1.1); }
 
 .feedback-panel {
 position: fixed;
 bottom: 70px;
 right: 20px;
 width: 280px;
 background: white;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-lg);
 box-shadow: 0 4px 20px rgba(0,0,0,0.15);
 z-index: 1001;
 display: none;
 overflow: hidden;
 }
 .feedback-panel.open { display: block; }
 .feedback-panel-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: 10px 14px;
 border-bottom: 1px solid var(--color-border);
 font-size: 13px;
 }
 .feedback-panel-body { padding: 12px 14px; }
 .feedback-panel-success {
 padding: 24px 14px;
 text-align: center;
 color: var(--color-success);
 }
 
 .fb-type-btn {
 flex: 1;
 padding: 5px 0;
 font-size: 11px;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 background: var(--color-bg);
 cursor: pointer;
 transition: all 0.1s;
 }
 .fb-type-btn.active {
 background: var(--color-primary);
 color: white;
 border-color: var(--color-primary);
 }
 
 /* AI Chat */
 .ai-msg code { background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px; }

 @media print { .feedback-fab, .feedback-panel { display: none !important; } }
 
 /* Cost detail expandables */
 .cost-detail {
 padding: 8px 12px;
 background: var(--color-bg-subtle);
 border-top: 1px solid var(--color-border);
 font-size: 12px;
 }
 .cost-detail-table {
 width: 100%;
 border-collapse: collapse;
 }
 .cost-detail-table td {
 padding: 3px 0;
 color: var(--color-text-secondary);
 }
 .cost-detail-table td.right {
 text-align: right;
 }
 .cost-detail-table tr.subtotal td {
 border-top: 1px solid var(--color-border);
 padding-top: 4px;
 font-weight: 500;
 }
 .cost-detail-table tr.total td {
 border-top: 2px solid var(--color-primary);
 padding-top: 5px;
 color: var(--color-text);
 }
 .cost-detail-note {
 margin-top: 6px;
 font-size: 11px;
 color: var(--color-text-hint);
 font-style: italic;
 }
 
 .part-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
 gap: var(--space-4);
 margin-bottom: var(--space-5);
 }
 
 .part-card {
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 overflow: hidden;
 cursor: pointer;
 transition: border-color 0.15s, box-shadow 0.15s;
 background: white;
 }
 
 .part-card:hover {
 border-color: var(--color-text-muted);
 box-shadow: var(--shadow-sm);
 }
 
 .part-card.selected {
 border-color: var(--color-primary);
 box-shadow: 0 0 0 1px var(--color-primary);
 }
 
 .part-thumb {
 height: 120px;
 background: #FAFAFA;
 display: flex;
 align-items: center;
 justify-content: center;
 overflow: hidden;
 border-bottom: 1px solid var(--color-border);
 }
 
 .part-thumb img {
 max-width: 100%;
 max-height: 100%;
 object-fit: contain;
 }
 
 .part-info {
 padding: 8px 10px;
 }
 
 .part-name {
 font-weight: 600;
 font-size: 13px;
 margin-bottom: 1px;
 }
 
 .part-number {
 font-family: var(--font-mono);
 font-size: 10px;
 color: var(--color-text-hint);
 margin-bottom: 4px;
 }
 
 .part-meta {
 display: flex;
 gap: var(--space-2);
 font-size: 11px;
 color: var(--color-text-muted);
 }
 
 .part-price {
 font-weight: 600;
 color: var(--color-primary);
 margin-left: auto;
 }
 
 .trust-badges {
 display: flex;
 gap: var(--space-4);
 margin-bottom: var(--space-5);
 }
 
 .trust-badge {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 font-size: 13px;
 color: var(--color-text-muted);
 }
 
 .trust-badge svg {
 width: 18px;
 height: 18px;
 flex-shrink: 0;
 stroke: var(--color-text-muted);
 }
 
 .scope-notice {
 background: var(--color-bg);
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 margin-bottom: var(--space-5);
 overflow: hidden;
 }
 
 .scope-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-3) var(--space-4);
 cursor: pointer;
 }
 
 .scope-content {
 display: none;
 padding: var(--space-4);
 border-top: 1px solid var(--color-border);
 font-size: 13px;
 }
 
 .scope-content.open,
 .scope-content.expanded {
 display: block;
 }
 
 .op-badge {
 display: inline-flex;
 align-items: center;
 justify-content: center;
 width: 28px;
 height: 28px;
 border-radius: var(--radius-sm);
 background: var(--color-bg-elevated);
 border: 1px solid var(--color-border);
 font-size: 12px;
 font-weight: 600;
 font-family: var(--font-mono);
 color: var(--color-text);
 }
 
 .op-badge.critical {
 background: var(--color-warning-light);
 border-color: var(--color-warning);
 color: var(--color-warning);
 }
 
 .op-params {
 display: flex;
 gap: var(--space-3);
 font-size: 11px;
 font-family: var(--font-mono);
 color: var(--color-text-muted);
 }
 
 .op-params span {
 white-space: nowrap;
 }
 
 @media print {
 /* Hide UI-only elements */
 .sidebar,
 .main-header,
 .loading-overlay,
 .nav-section-title,
 .sidebar-footer,
 .feedback-fab,
 .feedback-panel,
 .scope-notice,
 .trust-badges,
 .part-grid,
 .upload-area,
 #werkstuckConfig,
 #partWarningsContainer,
 #warningsContainer,
 .confidence-badge,
 #customOpsContainer,
 #mainActions {
 display: none !important;
 }
 
 /* Hide interactive elements but keep display values */
 button, .btn, select { display: none !important; }
 input[type="number"], input[type="text"], input[type="date"], textarea { display: none !important; }
 
 /* Show values in table cells */
 td input[type="number"], td input[type="text"], th input { 
 display: inline !important; 
 border: none !important; 
 background: none !important; 
 padding: 0 !important; 
 font-size: inherit !important;
 width: auto !important;
 }
 
 /* Show checkboxes as visual indicator */
 input[type="checkbox"] { display: inline !important; }
 
 /* Hide abgew√§hlte OPs im Print */
 div[style*="opacity: 0.35"], div[style*="opacity:0.35"] { display: none !important; }
 tr[style*="opacity: 0.35"], tr[style*="opacity:0.35"] { display: none !important; }
 
 /* Info-Boxen im Print behalten */
 .info-box { 
 display: block !important;
 border: 1px solid #ccc !important;
 background: #f9f9f9 !important;
 -webkit-print-color-adjust: exact;
 print-color-adjust: exact;
 font-size: 9px !important;
 padding: 6px 10px !important;
 margin-bottom: 8px !important;
 }
 
 .app { display: block; }
 .main { margin: 0; padding: 0; }
 .main-content { margin: 0; padding: 0; }
 .content-area { padding: 0; max-width: 100%; }
 
 /* Show only active section */
 .section { display: none !important; }
 .section.active { display: block !important; }
 
 /* Cards */
 .card {
 border: 1px solid #ccc;
 box-shadow: none;
 page-break-inside: avoid;
 margin-bottom: 10px;
 break-inside: avoid;
 }
 .card-header {
 background: #f0f0f0 !important;
 color: #111 !important;
 -webkit-print-color-adjust: exact;
 print-color-adjust: exact;
 padding: 6px 12px !important;
 font-size: 11px !important;
 }

 /* Tables */
 table { font-size: 10px; border-collapse: collapse; }
 .table th, .table td { padding: 3px 6px !important; }
 .table th { background: #f5f5f5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
 
 /* Cost breakdown */
 .cost-row { padding: 4px 12px !important; }
 .cost-detail { padding: 4px 8px !important; font-size: 10px !important; }
 .cost-detail-table td { padding: 1px 0 !important; }
 
 /* DB Rechnung */
 #dbTable th, #dbTable td { padding: 3px 6px !important; }
 
 /* Quantity table */
 #quantityTable th, #quantityTable td { font-size: 10px !important; }
 
 /* OP details ‚Äî show all expanded for print */
 .op-params { font-size: 9px; }
 div[id$="-detail"] { page-break-inside: avoid; break-inside: avoid; }
 
 /* OP rows */
 div[style*="border-bottom: 1px solid"] { page-break-inside: avoid; break-inside: avoid; }
 
 /* Price display */
 .price-main { font-size: 24px !important; }
 .price-value { font-size: 20px !important; }
 
 /* Angebot: eigenes Layout belassen */
 #section-quote .card-body { padding: 20px !important; }
 #section-quote .card-header { display: none !important; }
 
 /* Typography */
 body { font-size: 11px; color: #000; font-family: Arial, Helvetica, sans-serif; }
 
 /* Page header ‚Äî dynamisch je nach Section */
 .main::before {
 content: "CNC Planner Pro";
 display: block;
 font-size: 14px;
 font-weight: 700;
 margin-bottom: 8px;
 padding-bottom: 6px;
 border-bottom: 2px solid #111;
 }
 
 /* Angebot: keinen extra Header */
 #section-quote.active ~ .main::before,
 .main:has(#section-quote.active)::before {
 display: none !important;
 }
 
 @page {
 margin: 12mm 15mm;
 size: A4;
 }
 
 @page :first { margin-top: 15mm; }
 }
</style>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
<div style="font-size: 16px; font-weight: 500; color: var(--color-text);">Generiere Unterlagen...</div>
<div class="loading-steps">
<div class="loading-step" id="loadStep1">
<span class="loading-step-icon">1</span>
<span>Geometrie analysieren</span>
</div>
<div class="loading-step" id="loadStep2">
<span class="loading-step-icon">2</span>
<span>Bearbeitungszeiten berechnen</span>
</div>
<div class="loading-step" id="loadStep3">
<span class="loading-step-icon">3</span>
<span>Werkzeugeinsatz</span>
</div>
<div class="loading-step" id="loadStep4">
<span class="loading-step-icon">4</span>
<span>Maschinencode generieren</span>
</div>
<div class="loading-step" id="loadStep5">
<span class="loading-step-icon">5</span>
<span>Fertigungsanweisung erstellen</span>
</div>
</div>
</div>
 
<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar">
<div class="sidebar-header">
<div class="sidebar-logo">
<div class="sidebar-logo-icon">CP</div>
<div class="sidebar-logo-text">CNC Planner <span>Pro</span></div>
<span style="background: var(--color-warning); color: white; font-size: 9px; padding: 2px 6px; border-radius: 3px; margin-left: 8px; font-weight: 600;">BETA</span>
</div>
</div>
 
<nav class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">Vorkalkulation</div>
<button class="nav-item active" data-section="part" onclick="showSection('part', this)">
<span>Werkst√ºck</span>
</button>
<button class="nav-item" data-section="checklist" onclick="showSection('checklist', this)">
<span>Pr√ºfprotokoll</span>
<span class="checklist-badge" id="checklistBadge" style="display:none; background:var(--color-primary); color:#fff; font-size:10px; border-radius:8px; padding:1px 6px; margin-left:6px;">0</span>
</button>
<button class="nav-item" data-section="result" onclick="showSection('result', this)">
<span>Kalkulation</span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Fertigung</div>
<button class="nav-item" data-section="instructions" onclick="showSection('instructions', this)">
<span>Fertigungsanweisung</span>
</button>
<button class="nav-item" data-section="tools" onclick="showSection('tools', this)">
<span>Werkzeuge</span>
</button>
<button class="nav-item" data-section="code" onclick="showSection('code', this)">
<span>NC-Code</span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Ausgabe</div>
<button class="nav-item" data-section="quote" onclick="showSection('quote', this)">
<span>Angebot</span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Auswertung</div>
<button class="nav-item" data-section="feedback" onclick="showSection('feedback', this)">
<span>Nachkalkulation</span>
</button>
</div>

<div class="nav-section">
<div class="nav-section-title">Konfiguration</div>
<button class="nav-item" data-section="params" onclick="showSection('params', this)">
<span>Preise &amp; S√§tze</span>
</button>
<button class="nav-item" data-section="settings" onclick="showSection('settings', this)">
<span>Einstellungen</span>
</button>
</div>
</nav>
 
<div class="sidebar-footer">
<div style="font-size:10px;color:var(--color-text-hint);text-align:center;padding:var(--space-2) 0;">CNC Planner Pro v0.18 beta</div>
</div>
</aside>
 
<!-- MAIN CONTENT -->
<main class="main">
<header class="main-header">
<h1 class="main-title" id="mainTitle">Werkst√ºck</h1>
<div class="main-actions" id="mainActions" style="display:none;">
<button class="btn btn-secondary btn-sm" onclick="window.print()">Drucken / PDF</button>
</div>
</header>
 
<div class="main-content">
<!-- ========================================
 SECTION: TEIL AUSW√ÑHLEN
 ======================================== -->
<div class="section active" id="section-part">
<!-- Trust Badges -->
<div class="trust-badges">
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9,12 12,15 16,10"/></svg>
 Integrierte Nachkalkulation
</div>
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
 Vorkalkulation in unter 30 Sekunden
</div>
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
 Fertigungsanweisung und NC-Code
</div>
</div>
 
<!-- Scope Notice -->
<div class="scope-notice">
<div class="scope-header" onclick="toggleScope()">
<div>
<div style="font-weight: 600; color: var(--color-text);">Einsatzbereich und Systemgrenzen</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Abgedeckte Fertigungsverfahren, Werkstoffe und Toleranzbereiche</div>
</div>
<svg id="scopeChevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="2" style="transition: transform 0.2s;"><polyline points="6 9 12 15 18 9"/></svg>
</div>
<div class="scope-content" id="scopeContent">
<div class="grid-2" style="margin-bottom: var(--space-4);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Abgedeckt</div>
<ul style="font-size: 13px; color: var(--color-text-secondary); padding-left: var(--space-4);">
<li>Prismatische Werkst√ºcke (Platten, Adapter, Geh√§use)</li>
<li>Bohrungen, Senkungen, Gewinde (M3‚ÄìM16)</li>
<li>Taschen, Nuten, Planfl√§chen</li>
<li>3-Achs-Fr√§sbearbeitung</li>
<li>Bau-, Verg√ºtungs-, Edelstahl, Aluminium, Kunststoff</li>
</ul>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Au√üerhalb des Einsatzbereichs</div>
<ul style="font-size: 13px; color: var(--color-text-secondary); padding-left: var(--space-4);">
<li>Freiformfl√§chen / 5-Achs-Simultanbearbeitung</li>
<li>Hochwarmfeste Legierungen (Titan, Inconel)</li>
<li>Toleranzen enger als IT7</li>
<li>Drehteile, Erodieren, Schleifen</li>
</ul>
</div>
</div>
<div class="info-box">
<strong>Referenzmaschine:</strong> 3-Achs-BAZ (Hermle C 400). Stundens√§tze unter Konfiguration ‚Üí Preise &amp; S√§tze anpassbar.<br>
<strong>Kalkulationsgenauigkeit:</strong> Richtwerte auf Basis REFA/VDI 3321 ‚Äî Abgleich mit betrieblicher Nachkalkulation empfohlen.
</div>
</div>
</div>
 
<!-- Part Selection -->
<div style="font-weight: 600; margin-bottom: var(--space-3);">Letzte analysierte Bauteile</div>
<div class="part-grid" id="partGrid">
<!-- Filled by JS -->
</div>
 
<!-- File Upload -->
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-body" style="text-align: center; padding: var(--space-8);">
<div style="font-size: 32px; margin-bottom: var(--space-3); color: var(--color-text-muted);">üìÅ</div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Neues Bauteil analysieren</div>
<div style="font-size: 13px; color: var(--color-text-muted); margin-bottom: var(--space-4);">STEP-Datei hochladen oder hier ablegen ‚Ä¢ .step, .stp, .pdf</div>
<input type="file" id="fileInput" accept=".step,.stp,.pdf" style="display: none;">
<button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Datei ausw√§hlen</button>
</div>
</div>
 
<!-- Werkst√ºck -->
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-header"><span>Werkst√ºck</span></div>
<div class="card-body">
<div class="form-group">
<label class="form-label">Werkstoff</label>
<select class="select" id="materialSelect">
<optgroup label="Edelstahl">
<option value="1.4301">1.4301 (V2A)</option>
<option value="1.4404">1.4404 (V4A)</option>
<option value="1.4571">1.4571</option>
</optgroup>
<optgroup label="Baustahl">
<option value="S235JR" selected>S235JR</option>
<option value="S355J2">S355J2</option>
<option value="C45">C45</option>
</optgroup>
<optgroup label="Verg√ºtungsstahl">
<option value="42CrMo4">42CrMo4</option>
<option value="34CrNiMo6">34CrNiMo6</option>
</optgroup>
<optgroup label="Aluminium">
<option value="AlMg3">AlMg3</option>
<option value="AlMgSi1">AlMgSi1 (6082)</option>
<option value="Al7075">Al7075-T6</option>
</optgroup>
<optgroup label="Buntmetalle">
<option value="CuZn39Pb3">Messing CuZn39Pb3</option>
<option value="CuSn8">Bronze CuSn8</option>
</optgroup>
<optgroup label="Guss">
<option value="GJS-700">GJS-700-2 (Sph√§roguss)</option>
<option value="GJS-400">GJS-400-15 (Sph√§roguss)</option>
<option value="GJL-250">GJL-250 (Grauguss)</option>
</optgroup>
<optgroup label="Kunststoff">
<option value="POM">POM</option>
<option value="PA6">PA6 (Nylon)</option>
<option value="PEEK">PEEK</option>
</optgroup>
</select>
</div>
 
<div class="form-group">
<label class="form-label">Rohma√üe</label>
<div class="dimension-group">
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimX" value="440">
<span class="input-unit">mm</span>
</div>
</div>
<span class="dimension-separator">√ó</span>
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimY" value="50">
<span class="input-unit">mm</span>
</div>
</div>
<span class="dimension-separator">√ó</span>
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimZ" value="20">
<span class="input-unit">mm</span>
</div>
</div>
</div>
</div>
 
<div class="grid-3" style="gap: var(--space-4);">
<div class="form-group">
<label class="form-label">St√ºckzahl</label>
<div class="input-with-unit">
<input type="number" class="input input-mono" id="quantity" value="1" min="1">
<span class="input-unit">Stk</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Toleranzklasse</label>
<select class="select" id="toleranzKlasse">
<option value="IT11">IT11 (Grob)</option>
<option value="IT9" selected>IT9 (Standard)</option>
<option value="IT8">IT8 (Genau)</option>
<option value="IT7">IT7 (Fein)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Oberfl√§che (Ra)</label>
<select class="select" id="oberflaeche">
<option value="12.5">Ra 12,5 (Schruppen)</option>
<option value="6.3" selected>Ra 6,3 (Standard)</option>
<option value="3.2">Ra 3,2 (Schlichten)</option>
<option value="1.6">Ra 1,6 (Feinschlichten)</option>
<option value="0.8">Ra 0,8 (Poliert)</option>
</select>
</div>
</div>
 
<!-- Spannungen ‚Äî editierbare Liste -->
<div class="card" id="werkstuckConfig" style="margin-top: var(--space-4);">
<div class="card-header">
<span>Aufspannungen</span>
<button class="btn btn-sm btn-secondary" onclick="addClamping()">+ Hinzuf√ºgen</button>
</div>
<div class="card-body" style="padding:0;">
<table class="table" id="clampingTable">
<thead>
<tr>
<th style="width:40px;">Nr.</th>
<th>Spannmittel</th>
<th class="right" style="width:100px;">R√ºstzeit</th>
<th style="min-width:220px;">Herleitung / Feedback</th>
<th style="width:40px;"></th>
</tr>
</thead>
<tbody id="clampingRows">
<tr>
<td class="mono">1</td>
<td>
<select class="select" onchange="updateClampingTotal()">
<option value="schraubstock" selected>Schraubstock</option>
<option value="schraubstock2">2√ó Schraubstock (Langteil)</option>
<option value="tischspannung">Tischspannung / Pratzen</option>
<option value="nullpunkt">Nullpunktspannsystem</option>
<option value="spezial">Sondervorrichtung</option>
</select>
</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="15" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
<td style="min-width:220px;"><div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">REFA Richtwert Schraubstock</div></td>
<td></td>
</tr>
<tr>
<td class="mono">2</td>
<td>
<select class="select" onchange="updateClampingTotal()">
<option value="schraubstock" selected>Schraubstock</option>
<option value="schraubstock2">2√ó Schraubstock (Langteil)</option>
<option value="tischspannung">Tischspannung / Pratzen</option>
<option value="nullpunkt">Nullpunktspannsystem</option>
<option value="spezial">Sondervorrichtung</option>
</select>
</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="10" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
<td style="min-width:220px;"><div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">Folgeaufspannung (reduziert)</div></td>
<td style="text-align:center;"><button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">√ó</button></td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:600;background:var(--color-bg-subtle);">
<td colspan="2">Gesamte R√ºstzeit</td>
<td class="right mono" id="totalSetupTimeDisplay">25 min</td>
<td></td>
<td></td>
</tr>
</tfoot>
</table>
</div>
</div>

</div>
</div>

<!-- Plausibilit√§tshinweise (Werkst√ºck/Aufspannung) -->
<div id="partWarningsContainer" style="margin-top: var(--space-3);"></div>

<!-- BERECHNEN Button -->
<div style="margin-top: var(--space-4);">
<button class="btn btn-primary" onclick="runCalculation()" style="width:100%; height:44px; font-size:15px; font-weight:600;">
Berechnen ‚Üí
</button>
</div>

</div>
 
<!-- ========================================
 SECTION: PR√úFPROTOKOLL
 ======================================== -->
<div class="section" id="section-checklist">
<div class="card">
<div class="card-header"><span>üß† Pr√ºfprotokoll ‚Äî Fehlende Angaben kl√§ren</span></div>
<div class="card-body">
<p style="color: var(--color-text-muted); margin-bottom: var(--space-4);">
Der CNC Planner Pro pr√ºft automatisch, ob alle kalkulationsrelevanten Informationen vorliegen. 
<strong style="color: var(--color-danger);">Rote Fragen</strong> m√ºssen beantwortet werden, bevor die Kalkulation freigegeben wird.
<span style="color: var(--color-warning);">Gelbe Fragen</span> verbessern die Genauigkeit.
</p>

<div id="checklistQuestions" style="display:flex; flex-direction:column; gap: var(--space-3);">
<!-- Questions injected by generateChecklist() -->
</div>

<div id="checklistSummary" style="margin-top: var(--space-5); padding: var(--space-4); border-radius: var(--radius); background: var(--color-surface-alt); display:none;">
<div style="font-weight:600; margin-bottom: var(--space-2);">üìã Protokoll-Zusammenfassung</div>
<div id="checklistSummaryContent"></div>
</div>

<div style="margin-top: var(--space-4); display:flex; gap: var(--space-3); flex-wrap: wrap;">
<button class="btn btn-primary" onclick="submitChecklist()">‚úÖ Pr√ºfung abschlie√üen ‚Üí Kalkulation</button>
<button class="btn btn-secondary" onclick="exportChecklistPDF()">üìÑ Protokoll exportieren</button>
</div>
</div>
</div>

<!-- Feedback an Entwickler -->
<div class="card" style="margin-top: var(--space-4);">
<div class="card-header"><span>üí¨ Feedback an Entwickler</span></div>
<div class="card-body">
<p style="color: var(--color-text-muted); margin-bottom: var(--space-3); font-size: 13px;">
√Ñnderungsw√ºnsche, Fehler oder Verbesserungsvorschl√§ge? Direkt an den Entwickler senden.
<br><em>Hinweis: Hier nur Feedback zur Software ‚Äî Bauteil-Fragen oben beantworten.</em>
</p>
<textarea id="devFeedbackText" rows="3" style="width:100%; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius); font-family: inherit; font-size: 13px; resize: vertical;" placeholder="z.B. 'Feld f√ºr Oberfl√§chenangabe fehlt' oder 'Stundensatz stimmt nicht'"></textarea>
<button class="btn btn-secondary btn-sm" style="margin-top: var(--space-2);" onclick="sendDevFeedback()">üì® Feedback senden</button>
<div id="devFeedbackStatus" style="margin-top: var(--space-2); font-size: 12px;"></div>
</div>
</div>
</div>

<!-- ========================================
 SECTION: PARAMETER
 ======================================== -->
<div class="section" id="section-params">
<div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-5); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-3);">
<button class="btn btn-sm btn-primary" id="tabParamPreis" onclick="showParamTab('preis')">Stundens√§tze</button>
<button class="btn btn-sm btn-secondary" id="tabParamMaterial" onclick="showParamTab('material')">Materialpreise</button>
<button class="btn btn-sm btn-secondary" id="tabParamZuschlag" onclick="showParamTab('zuschlag')">Zuschl√§ge</button>
</div>
 
<!-- Hidden elements for backward compatibility -->
<span id="setupTimeDisplay" style="display:none;">25 min</span>
<span id="setupCostDisplay" style="display:none;">EUR 37,92</span>
<span id="clampingDescription" style="display:none;"></span>
<select id="clampingSelect" style="display:none;"><option value="schraubstock" selected></option></select>
<select id="setupCount" style="display:none;"><option value="2" selected></option></select>
 
<div id="param-preis" style="display: block;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Maschinenstundens√§tze (EUR/h)</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Arbeitsgang</th>
<th class="right">Lohn (EUR/h)</th>
<th class="right">Maschine (EUR/h)</th>
<th class="right">Gesamt (EUR/h)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CNC-Fr√§sen (3-Achs)</strong></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="38" id="rateCncLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="32" id="rateCncMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" style="font-weight: 600;" id="rateCncTotal">EUR 70</td>
</tr>
<tr>
<td>CNC-Fr√§sen (5-Achs)</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="52" id="rate5AxLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="68" id="rate5AxMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rate5AxTotal">EUR 120</td>
</tr>
<tr>
<td>CNC-Drehen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="45" id="rateDrehenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="38" id="rateDrehenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateDrehenTotal">EUR 83</td>
</tr>
<tr>
<td>S√§gen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="35" id="rateSaegenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="10" id="rateSaegenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateSaegenTotal">EUR 45</td>
</tr>
<tr>
<td>Entgraten / Schleifen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="28" id="rateEntgratenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="3" id="rateEntgratenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateEntgratenTotal">EUR 31</td>
</tr>
<tr>
<td>Qualit√§tspr√ºfung</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="45" id="ratePruefLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="15" id="ratePruefMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="ratePruefTotal">EUR 60</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Hinweis:</strong> Maschinenstundensatz = Lohnkosten + Maschinenkosten (Abschreibung, Energie, Wartung, Raumkosten). Branchen√ºblich: EUR 65-95/h f√ºr 3-Achs, EUR 90-140/h f√ºr 5-Achs.
</div>
</div>
 
<!-- TAB: Materialpreise -->
<div id="param-material" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Materialpreise (EUR/kg)</span></div>
<div class="card-body">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-4);">
 Tagesaktuelle Preise vom Stahlhandel √ºbernehmen. Verschnitt wird separat berechnet.
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Baustahl</div>
<div class="grid-4" style="gap: var(--space-3); margin-bottom: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">S235JR</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="1.40" step="0.01" id="matS235JR" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">S355J2</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="3.00" step="0.01" id="matS355J2" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">C45</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="1.80" step="0.01" id="matC45" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">42CrMo4</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.20" step="0.01" id="mat42CrMo4" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Edelstahl</div>
<div class="grid-4" style="gap: var(--space-3); margin-bottom: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4301 (V2A)</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.80" step="0.01" id="mat14301" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4404 (V4A)</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="5.50" step="0.01" id="mat14404" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4571</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="5.20" step="0.01" id="mat14571" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">Duplex</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="18.00" step="0.01" id="matDuplex" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Aluminium</div>
<div class="grid-4" style="gap: var(--space-3);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">AlMg3</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.50" step="0.01" id="matAlMg3" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">AlMgSi1</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.80" step="0.01" id="matAlMgSi1" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">Al7075-T6</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="12.00" step="0.01" id="matAl7075" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
</div>
</div>
</div>
 
<!-- TAB: Zuschl√§ge -->
<div id="param-zuschlag" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Zuschlagskalkulation (Industriestandard)</span></div>
<div class="card-body">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-4);">
 Zuschlagss√§tze nach betriebswirtschaftlicher Kalkulationsmethode. Basis: Herstellkosten.
</div>
 
<table class="table">
<thead>
<tr>
<th>Zuschlagsart</th>
<th style="width: 120px;">Satz (%)</th>
<th>Basis</th>
<th>Branchen√ºblich</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<strong>Materialgemeinkosten (MGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Einkauf, Lager, Handling</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="5" id="zuschlagMGK" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Materialkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr>
<td>
<strong>Fertigungsgemeinkosten (FGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Meister, Instandhaltung, Energie</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="0" id="zuschlagFGK" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Fertigungskosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">100-200% (oft in MSS)</td>
</tr>
<tr style="background: var(--color-info-light);">
<td>
<strong>AV-Aufschlag</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Arbeitsvorbereitung, Programmierung, CAM</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="12" id="zuschlagAV" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Fertigungskosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr style="background: var(--color-bg);">
<td colspan="4" style="font-weight: 600; color: var(--color-text-secondary);">= Herstellkosten (HK)</td>
</tr>
<tr>
<td>
<strong>Verwaltungsgemeinkosten (VwGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Buchhaltung, IT, Gesch√§ftsf√ºhrung</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="10" id="zuschlagVwGK" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Herstellkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">8-15%</td>
</tr>
<tr>
<td>
<strong>Vertriebsgemeinkosten (VtGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Angebote, Kundenbetreuung, Versand</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="5" id="zuschlagVtGK" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Herstellkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">3-8%</td>
</tr>
<tr style="background: var(--color-bg);">
<td colspan="4" style="font-weight: 600; color: var(--color-text-secondary);">= Selbstkosten (SK)</td>
</tr>
<tr style="background: var(--color-success-light);">
<td>
<strong>Gewinnzuschlag / Marge</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Unternehmensgewinn</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="8" id="zuschlagGewinn" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Selbstkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr style="background: var(--color-primary); color: white;">
<td colspan="4" style="font-weight: 600;">= Angebotspreis (netto)</td>
</tr>
</tbody>
</table>
</div>
</div>
</div><!-- /param-zuschlag -->
 
<div id="param-maschine" style="display: none;">
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-header"><span>Maschine</span></div>
<div class="card-body">
<div class="form-group">
<label class="form-label">CNC-Typ</label>
<select class="select" id="cncType">
<option value="3-achs" selected>3-Achs</option>
<option value="5-achs">5-Achs</option>
</select>
</div>
</div>
</div>
</div>
 
<!-- Plausibility Warnings -->
<div id="warningsContainer"></div>
 
<button class="btn btn-primary" onclick="runCalculation()" style="width:100%;">Berechnen und Kalkulation anzeigen ‚Üí</button>
</div>
 
<!-- ========================================
 SECTION: ERGEBNIS
 ======================================== -->
<div class="section" id="section-result">
<!-- Price Hero with Confidence -->
<div class="price-hero">
<div class="price-label">St√ºckpreis</div>
<div class="price-value" id="priceDisplay">EUR 64,89</div>
<div class="price-detail">inkl. Material, Bearbeitung, Einrichtung</div>
<div class="confidence-badge confidence-medium" id="confidenceBadge">
<span></span>Richtwert ‚Äî Abgleich mit Nachkalkulation empfohlen
</div>
</div>
 
<div class="grid-2">
<!-- Kostenaufschl√ºsselung -->
<div class="card">
<div class="card-header"><span>Kostenaufschl√ºsselung</span><span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;">Klick f√ºr Details</span></div>
<div class="cost-breakdown" style="border: none; border-radius: 0;">

<!-- Material -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('mat')">
<div style="flex:1;">
<div class="cost-label">Material + MGK <span style="color:var(--color-text-hint);font-size:11px;">‚ñæ</span></div>
<div class="cost-formula" id="matFormula">2,2 kg √ó EUR 6,79/kg + 10% MGK</div>
</div>
<div class="cost-value" id="matCost">EUR 16,42</div>
</div>
<div id="costDetail-mat" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Rohma√üe</td><td class="right mono" id="cdMatDims">440 √ó 50 √ó 20 mm</td></tr>
<tr><td>Volumen</td><td class="right mono" id="cdMatVol">440 cm¬≥</td></tr>
<tr><td>Werkstoff / Dichte</td><td class="right mono" id="cdMatDensity">S235JR / 7,85 g/cm¬≥</td></tr>
<tr><td>Gewicht (Rohteil)</td><td class="right mono" id="cdMatWeight">2,20 kg</td></tr>
<tr><td>Materialpreis</td><td class="right mono" id="cdMatPrice">EUR 6,79/kg</td></tr>
<tr><td>Materialkosten (netto)</td><td class="right mono" id="cdMatNet">EUR 14,93</td></tr>
<tr><td>+ Verschnitt/Aufma√ü (10%)</td><td class="right mono" id="cdMatScrap">EUR 1,49</td></tr>
<tr class="subtotal"><td>Materialeinzelkosten (MEK)</td><td class="right mono" id="cdMatMEK">EUR 16,42</td></tr>
<tr><td>+ MGK (10%)</td><td class="right mono" id="cdMatMGK">EUR 1,64</td></tr>
<tr class="total"><td><strong>Materialkosten gesamt</strong></td><td class="right mono" id="cdMatTotal"><strong>EUR 18,07</strong></td></tr>
</table>
<div class="cost-detail-note">MGK = Materialgemeinkosten (Lager, Beschaffung, Qualit√§tspr√ºfung Wareneingang)</div>
</div>

<!-- Fertigung -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('mach')">
<div style="flex:1;">
<div class="cost-label">Fertigung + AV <span style="color:var(--color-text-hint);font-size:11px;">‚ñæ</span></div>
<div class="cost-formula" id="machFormula">12,5 min √ó EUR 91/h + 8% AV</div>
</div>
<div class="cost-value" id="machCost">EUR 18,96</div>
</div>
<div id="costDetail-mach" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Bearbeitungszeit (t<sub>h</sub> + t<sub>n</sub>)</td><td class="right mono" id="cdMachTime">12,5 min</td></tr>
<tr><td>Lohnkosten</td><td class="right mono" id="cdMachLabor">EUR 49/h</td></tr>
<tr><td>Maschinenstundensatz</td><td class="right mono" id="cdMachRate">EUR 42/h</td></tr>
<tr><td>Gesamtstundensatz</td><td class="right mono" id="cdMachTotal">EUR 91/h</td></tr>
<tr><td>Fertigungskosten (netto)</td><td class="right mono" id="cdMachNet">EUR 18,96</td></tr>
<tr class="subtotal"><td>Fertigungseinzelkosten (FEK)</td><td class="right mono" id="cdMachFEK">EUR 18,96</td></tr>
<tr><td>+ AV-Aufschlag (8%)</td><td class="right mono" id="cdMachAV">EUR 1,52</td></tr>
<tr class="total"><td><strong>Fertigungskosten gesamt</strong></td><td class="right mono" id="cdMachGesamt"><strong>EUR 20,48</strong></td></tr>
</table>
<div class="cost-detail-note">AV = Arbeitsvorbereitung (Programmierung, Pr√ºfplanung, Werkzeugvoreinstellung)</div>
</div>

<!-- Einrichtung -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('setup')">
<div style="flex:1;">
<div class="cost-label">R√ºsten <span style="color:var(--color-text-hint);font-size:11px;">‚ñæ</span></div>
<div class="cost-formula" id="setupFormula">25 min √ó EUR 91/h √∑ 1</div>
</div>
<div class="cost-value" id="setupCost">EUR 37,92</div>
</div>
<div id="costDetail-setup" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Spannmittel</td><td class="right mono" id="cdSetupClamping">Schraubstock</td></tr>
<tr><td>R√ºstzeit (Grundzeit)</td><td class="right mono" id="cdSetupBase">15 min</td></tr>
<tr><td>Aufspannungen</td><td class="right mono" id="cdSetupCount">2</td></tr>
<tr><td>R√ºstzeit (gesamt)</td><td class="right mono" id="cdSetupTime">25,0 min</td></tr>
<tr><td>Stundensatz</td><td class="right mono">EUR 91/h</td></tr>
<tr><td>R√ºstkosten (gesamt)</td><td class="right mono" id="cdSetupTotal">EUR 37,92</td></tr>
<tr><td>St√ºckzahl</td><td class="right mono" id="cdSetupQty">1</td></tr>
<tr class="total"><td><strong>R√ºstkosten / St√ºck</strong></td><td class="right mono" id="cdSetupPerPiece"><strong>EUR 37,92</strong></td></tr>
</table>
<div class="cost-detail-note">Bei St√ºckzahl 10: EUR 3,79/St√ºck ¬∑ Bei 100: EUR 0,38/St√ºck</div>
</div>

<!-- Werkzeugverschlei√ü entf√§llt ‚Äî im Maschinenstundensatz enthalten -->

<!-- VwGK + VtGK -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('overhead')">
<div style="flex:1;">
<div class="cost-label">VwGK + VtGK <span style="color:var(--color-text-hint);font-size:11px;">‚ñæ</span></div>
<div class="cost-formula" id="additionalFormula">Verwaltung + Vertrieb</div>
</div>
<div class="cost-value" id="additionalCost">EUR 15,17</div>
</div>
<div id="costDetail-overhead" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Herstellkosten (HK)</td><td class="right mono" id="cdOhHK">EUR 89,38</td></tr>
<tr><td>+ Verwaltungsgemeinkosten (12%)</td><td class="right mono" id="cdOhVwGK">EUR 10,73</td></tr>
<tr><td>+ Vertriebsgemeinkosten (5%)</td><td class="right mono" id="cdOhVtGK">EUR 4,47</td></tr>
<tr class="total"><td><strong>Gemeinkosten gesamt</strong></td><td class="right mono" id="cdOhTotal"><strong>EUR 15,20</strong></td></tr>
</table>
<div class="cost-detail-note">VwGK = Verwaltung, Buchhaltung, IT, Gesch√§ftsf√ºhrung ¬∑ VtGK = Vertrieb, Angebotserstellung, Kundenpflege</div>
</div>

<div class="cost-row subtotal">
<div class="cost-label">Selbstkosten</div>
<div class="cost-value" id="totalCost">EUR 109,21</div>
</div>
<div class="cost-row">
<div class="cost-label">+ Gewinn (<span id="marginDisplay">10</span>%)</div>
<div class="cost-value" id="marginCost">EUR 10,92</div>
</div>
<div class="cost-row total">
<div class="cost-label">Angebotspreis</div>
<div class="cost-value" id="sellPrice">EUR 120,13</div>
</div>
</div>
</div>
 
<!-- Mengenstaffel -->
<div class="card">
<div class="card-header"><span>Mengenstaffel</span></div>
<div class="card-body">
<table class="table">
<thead>
<tr>
<th>St√ºckzahl</th>
<th class="right">Pro St√ºck</th>
<th class="right">Gesamt</th>
</tr>
</thead>
<tbody id="quantityTable"></tbody>
</table>
 
<div class="info-box" style="margin-top: var(--space-4);">
 Bei gr√∂√üeren Mengen sinkt der St√ºckpreis, da Einricht- und Pr√ºfkosten verteilt werden.
</div>
</div>
</div>
</div>
 
<!-- Deckungsbeitragsrechnung -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Deckungsbeitragsrechnung</span></div>
<div class="card-body" style="padding: 0;">
<table class="table" id="dbTable">
<thead>
<tr>
<th></th>
<th class="right" style="width:120px;">pro St√ºck</th>
<th class="right" style="width:120px;">Auftrag (<span id="dbQtyHead">1</span> Stk)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Angebotspreis (netto)</td>
<td class="right mono" id="dbAngebotspreis">EUR 120,13</td>
<td class="right mono" id="dbAngebotspreis_t">EUR 120,13</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì Materialeinzelkosten (MEK)</td>
<td class="right mono" id="dbMEK">EUR 14,93</td>
<td class="right mono" id="dbMEK_t">EUR 14,93</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì Fertigungseinzelkosten (FEK)</td>
<td class="right mono" id="dbFEK">EUR 18,96</td>
<td class="right mono" id="dbFEK_t">EUR 18,96</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì Sondereinzelkosten (R√ºsten)</td>
<td class="right mono" id="dbSetup">EUR 37,92</td>
<td class="right mono" id="dbSetup_t">EUR 37,92</td>
</tr>
<tr style="font-weight: 600; background: var(--color-bg-subtle);">
<td>= Deckungsbeitrag I</td>
<td class="right mono" id="dbDB1">EUR 48,32</td>
<td class="right mono" id="dbDB1_t">EUR 48,32</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì MGK (<span id="dbMGKpct">10</span>%)</td>
<td class="right mono" id="dbMGK">EUR 1,49</td>
<td class="right mono" id="dbMGK_t">EUR 1,49</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì AV (<span id="dbAVpct">8</span>%)</td>
<td class="right mono" id="dbAV">EUR 1,52</td>
<td class="right mono" id="dbAV_t">EUR 1,52</td>
</tr>
<!-- Werkzeugverschlei√ü entf√§llt ‚Äî im Maschinenstundensatz -->
<tr style="font-weight: 600; background: var(--color-bg-subtle);">
<td>= Deckungsbeitrag II</td>
<td class="right mono" id="dbDB2">EUR 24,57</td>
<td class="right mono" id="dbDB2_t">EUR 24,57</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì VwGK (<span id="dbVwGKpct">12</span>%)</td>
<td class="right mono" id="dbVwGK">EUR 10,73</td>
<td class="right mono" id="dbVwGK_t">EUR 10,73</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">‚Äì VtGK (<span id="dbVtGKpct">5</span>%)</td>
<td class="right mono" id="dbVtGK">EUR 4,47</td>
<td class="right mono" id="dbVtGK_t">EUR 4,47</td>
</tr>
<tr style="font-weight: 700; border-top: 2px solid var(--color-primary);">
<td>= Betriebsergebnis</td>
<td class="right mono" id="dbGewinn">EUR 10,92</td>
<td class="right mono" id="dbGewinn_t">EUR 10,92</td>
</tr>
<tr>
<td>Gewinnmarge</td>
<td class="right mono" id="dbMarge">9,1%</td>
<td class="right mono" id="dbMarge_t">9,1%</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Gesamtauftragswert -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-body" style="display: flex; align-items: center; justify-content: space-between;">
<span style="color: var(--color-text-secondary);">Gesamtauftragswert (netto):</span>
<strong style="font-size: 18px; font-family: var(--font-mono);" id="orderTotal">EUR 120,13</strong>
</div>
</div>
<!-- Hidden for backward compat -->
<input type="hidden" id="marginInput" value="10">

<!-- Kalkulationsgrundlage -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Kalkulationsverfahren</span></div>
<div class="card-body">
<div class="grid-2" style="font-size: 13px; margin-bottom: var(--space-4);">
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Kalkulationsart</div>
<div>Zuschlagskalkulation (differenzierend)</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Stundens√§tze</div>
<div>Aus Nachkalkulation, betriebsspezifisch anpassbar</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Zeitermittlung</div>
<div>Formelbasiert nach REFA / VDI 3321</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Materialkosten</div>
<div>Tagespreise Stahlhandel + Verschnitt + MGK</div>
</div>
</div>
 
<!-- Normen & Methodik -->
<div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
<div style="font-weight: 600; margin-bottom: var(--space-2);">Normengrundlage</div>
<div style="font-size: 13px; color: var(--color-text-secondary); line-height: 1.7;">
<strong>REFA ‚Äî Zeitgliederung</strong><br>
 ‚Ä¢ Auftragszeit T = R√ºstzeit t<sub>r</sub> + Ausf√ºhrungszeit t<sub>a</sub><br>
 ‚Ä¢ Grundzeit t<sub>g</sub> = Hauptzeit t<sub>h</sub> + Nebenzeit t<sub>n</sub><br>
 ‚Ä¢ St√ºckzeit t<sub>e</sub> = Grundzeit + Verteilzeit (t<sub>v</sub>) + Erholzeit (t<sub>er</sub>)<br><br>
 
<strong>VDI 3321 ‚Äî Schnittdaten</strong><br>
 ‚Ä¢ v<sub>c</sub> = œÄ √ó d √ó n / 1000 [m/min]<br>
 ‚Ä¢ v<sub>f</sub> = f<sub>z</sub> √ó z √ó n [mm/min]<br>
 ‚Ä¢ t<sub>h</sub> = L / v<sub>f</sub> [min]<br><br>
 
<strong>DIN 8580 ‚Äî Fertigungsverfahren</strong><br>
 Hauptgruppe 3: Trennen ‚Äî Spanen mit geometrisch bestimmter Schneide<br><br>
 
<strong>DIN EN 10027 ‚Äî Werkstoffbezeichnungen</strong><br>
 Kurzname, Werkstoffnummer, mechanische Kennwerte, Zerspanbarkeitsgruppe
</div>
</div>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: ANGEBOT
 ======================================== -->
<div class="section" id="section-quote">
    <div class="card">
        <div class="card-header">
            <span>Angebot ANG-2026-0042</span>
            <div style="display: flex; gap: var(--space-2);">
                <button class="btn btn-secondary btn-sm" onclick="copyQuote()">Kopieren</button>
                <button class="btn btn-primary btn-sm" onclick="window.print()">Drucken / PDF</button>
            </div>
        </div>
        <div class="card-body" style="max-width: 800px; margin: 0 auto;">
            
            <!-- Header mit Firmendaten -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-8); margin-bottom: var(--space-8); padding-bottom: var(--space-6); border-bottom: 1px solid var(--color-border-light);">
                
                <!-- Linke Spalte: Absender + Empf√§nger -->
                <div>
                    <div style="font-size: var(--text-xs); color: var(--color-text-hint); margin-bottom: var(--space-4);" id="quoteSenderLine">
                        CNC Planner Pro ‚Ä¢ Musterstra√üe 1 ‚Ä¢ 12345 Musterstadt
                    </div>
                    
                    <div style="font-size: var(--text-base); color: var(--color-text); line-height: var(--leading-relaxed); cursor: text;" title="Doppelklick zum Bearbeiten">
                        <strong id="quoteCustomerName" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">M√ºller Industrie GmbH</strong><br>
                        <span id="quoteCustomerStreet" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">Hauptstra√üe 26</span><br>
                        <span id="quoteCustomerCity" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">09619 Mulda</span>
                    </div>
                </div>
                
                <!-- Rechte Spalte: Angebotsdaten -->
                <div style="font-size: var(--text-sm);">
                    <table style="width: 100%;">
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Angebot</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteNumber">20260072</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Datum</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteDate">06.02.2026</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Kunden-Nr.</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteCustomerId">‚Äî</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Bearbeiter</td>
                            <td style="text-align: right; padding: var(--space-1) 0;">KI-Assistent</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Betreff -->
            <p style="font-weight: 700; font-size: var(--text-lg); margin-bottom: var(--space-5);" id="quoteDesc">Angebot ‚Äî CNC-Fertigung Verbindungsplatte</p>
            
            <!-- Anrede -->
            <div style="margin-bottom: var(--space-6); font-size: var(--text-base); line-height: var(--leading-relaxed);">
                <p style="margin-bottom: var(--space-4);"><strong>Sehr geehrte Damen und Herren,</strong></p>
                <p>wir bedanken uns f√ºr Ihre Anfrage und bieten Ihnen gerne, wie folgt an:</p>
            </div>
            
            <!-- Haupt-Tabelle (wie MBS) -->
            <table class="table" style="margin-bottom: var(--space-8);">
                <thead>
                    <tr>
                        <th style="width: 50px;">Pos</th>
                        <th style="width: 100px;">Artikelnr.</th>
                        <th>Bezeichnung</th>
                        <th class="right" style="width: 80px;">Menge</th>
                        <th class="right" style="width: 100px;">Einzelpreis</th>
                        <th class="right" style="width: 100px;">Gesamtpreis</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Position 1 (klassisch) -->
                    <tr>
                        <td class="position-nr">1</td>
                        <td class="mono">E-CNC-0001</td>
                        <td>
                            <div style="font-weight: var(--font-semibold);" id="quotePart1Name">Verbindungsplatte</div>
                            <div class="drawing-number" style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1); font-family: var(--font-mono);" id="quotePart1Drawing">2500473.01.11.02.00.001</div>
                            <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">Werkstoff S235JR</div>
                        </td>
                        <td class="right mono" id="quotePart1Qty">1 Stck.</td>
                        <td class="right mono" id="quotePart1EP">EUR 170,76</td>
                        <td class="right mono" id="quotePart1GP">EUR 170,76</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Summen -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: var(--space-8);">
                <div style="width: 300px;">
                    <div style="display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-base);">
                        <span style="color: var(--color-text-secondary);">Zwischensumme</span>
                        <span class="mono" id="quoteSubtotal">EUR 170,76</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-base); border-top: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-secondary);">+ MwSt. 19%</span>
                        <span class="mono" id="quoteTax">EUR 32,44</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: var(--space-4) 0; font-size: var(--text-xl); font-weight: var(--font-bold); border-top: 2px solid var(--color-primary);">
                        <span>GESAMTBETRAG</span>
                        <span class="mono" id="quoteTotal">EUR 203,20</span>
                    </div>
                </div>
            </div>
            
            <!-- G√ºltigkeit prominent -->
            <div class="info-box" style="margin-bottom: var(--space-8);">
                <strong>Angebotsg√ºltigkeit:</strong> Freibleibend mit einer G√ºltigkeit von 4 Wochen 
                (bis <strong id="quoteValidUntil">06.03.2026</strong>)
            </div>
            
            <!-- Bedingungen -->
            <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: var(--leading-relaxed); margin-bottom: var(--space-8); padding: var(--space-4); background: var(--color-bg-subtle); border-radius: var(--radius);">
                <p style="margin-bottom: var(--space-3);">
                    <strong>Preiskalkulation:</strong> 
                    Die Preiskalkulation basiert auf derzeit g√ºltigen Materialaufschlagspreisen und Standard-Fertigungsparametern. 
                    √Ñnderungen innerhalb der Angebotsg√ºltigkeit behalten sich eventuelle Nachkalkulationen und Anpassungen vor 
                    bei stark schwankenden Marktpreisen.
                </p>
                
                <p style="margin-bottom: var(--space-3);">
                    <strong>Genauigkeit:</strong> 
                    Vorkalkulation auf Basis von REFA-Zeitermittlung und VDI 3321 Schnittdaten. Richtwerte ‚Äî Abgleich mit betrieblicher Nachkalkulation empfohlen.
                    F√ºr Pr√§zisionsangebote bei Serienproduktion empfehlen wir eine manuelle Nachkalkulation.
                </p>
                
                <p style="margin-bottom: var(--space-3);">
                    <strong>Zahlungsbedingungen:</strong> 
                    <span id="quoteZahlungsziel">14</span> Tage netto nach Rechnungsdatum. 
                    F√ºr Bestellungen unter EUR 100,00 Warenwert berechnen wir einen Mindermengenzuschlag von pauschal EUR 35,00.
                </p>
                
                <p>
                    <strong>Lieferzeit:</strong> 
                    Ca. <span id="quoteLieferzeit">3-4 Wochen</span> nach Auftragseingang (abh√§ngig von Materialverf√ºgbarkeit und aktueller Auslastung).
                </p>
            </div>
            
            <!-- Footer mit Kontaktdaten -->
            <div class="contact-footer" style="padding-top: var(--space-6); border-top: 1px solid var(--color-border-light);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); font-size: var(--text-xs); color: var(--color-text-hint); line-height: var(--leading-relaxed);">
                    <div id="quoteFooterContact">
                        <strong style="color: var(--color-text-muted);">CNC Planner Pro</strong><br>
                        Musterstra√üe 1<br>
                        12345 Musterstadt<br>
                        <br>
                        Telefon: +49 123 456789<br>
                        E-Mail: info@cnc-planer-pro.de
                    </div>
                    <div>
                        <strong style="color: var(--color-text-muted);">Rechtliches</strong><br>
                        Gesch√§ftsf√ºhrer: [Name]<br>
                        Handelsregister: [Nummer]<br>
                        Registergericht: [Ort]<br>
                        USt-ID: [Nummer]<br>
                        <br>
                        IBAN: [IBAN] | BIC: [BIC]
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
<div class="section" id="section-instructions">
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Vorschlag ‚Äî keine verbindliche Fertigungsplanung.</strong> Der Operationsplan zeigt m√∂gliche Arbeitsg√§nge f√ºr dieses Bauteilprofil. Nicht alle OPs sind f√ºr jedes Bauteil erforderlich. Die Kalkulation rechnet mit einer bauteilproportionalen Gesamtzeit ‚Äî nicht mit der Summe aller hier gelisteten OPs.<br><br>
<strong>Bitte pr√ºfen und anpassen:</strong> OPs per Checkbox abw√§hlen, die f√ºr Ihr konkretes Bauteil nicht zutreffen. √úber ‚Äû+ Arbeitsgang" k√∂nnen fehlende Arbeitsg√§nge erg√§nzt werden.
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5);">
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-primary btn-sm" onclick="window.print()">Drucken / PDF</button>
</div>
</div>
 
<!-- Document Header -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-body">
<div style="display: flex; justify-content: space-between; margin-bottom: var(--space-5); padding-bottom: var(--space-4); border-bottom: 3px solid var(--color-primary);">
<div>
<h3 style="color: var(--color-primary); font-size: 18px; font-weight: 700;">FERTIGUNGSANWEISUNG</h3>
<p id="faPartName" style="color: var(--color-text-muted); font-size: 13px;">Verbindungsplatte ‚Äî 2500473.01.11.02.00.001</p>
</div>
<div style="text-align: right; font-size: 13px; color: var(--color-text-muted);">
<div>Freigabe: 05.02.2026</div>
<div>Version: 1.0</div>
</div>
</div>
 
<div class="grid-3" style="margin-bottom: var(--space-4);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Werkst√ºck</div>
<table style="font-size: 13px; width: 100%;">
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Werkstoff:</td><td id="faMaterial" style="padding: 2px 0;"><strong>S235JR</strong></td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Rohteil:</td><td id="faRawDims" style="padding: 2px 0;">440 √ó 50 √ó 20 mm</td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Gewicht:</td><td id="faWeight" style="padding: 2px 0;">2,2 kg</td></tr>
</table>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Maschine</div>
<table style="font-size: 13px; width: 100%;">
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Maschine:</td><td style="padding: 2px 0;"><strong>Hermle C 400</strong></td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Steuerung:</td><td style="padding: 2px 0;">Heidenhain TNC 640</td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Zeit:</td><td id="faMachiningTime" style="padding: 2px 0;"><strong>12,5 min</strong></td></tr>
</table>
</div>
<!-- Zeichnung Upload entfernt -->
</div>
 
<div class="info-box">
<strong>Toleranzen:</strong> Allgemein DIN ISO 2768-mK ‚Ä¢ Oberfl√§che Rz 25
</div>
</div>
</div>

<!-- Zeichnungs-Vorschau -->
<div class="card" style="margin-bottom: var(--space-5);" id="drawingCard">
<div class="card-header" style="cursor: pointer;" onclick="toggleDrawing()">
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span id="drawingChevron" style="transition: transform 0.2s;">‚ñ∂</span>
<span>Zeichnung anzeigen</span>
<span id="drawingPartNumber" style="font-size: 12px; color: var(--color-text-muted); font-family: var(--font-mono);">2500473.01.11.02.00.001</span>
</div>
<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openDrawingFullscreen()">Vollbild</button>
</div>
<div class="card-body" id="drawingContent" style="display: none; text-align: center; background: var(--color-bg);">
<img id="drawingImage" src="demo-parts/2500473.01.11.02.00.001.pdf.png" alt="Zeichnung" 
 style="max-width: 100%; max-height: 400px; object-fit: contain; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: white;"
 onerror="this.parentElement.innerHTML='<div style=\'padding:40px;color:var(--color-text-muted);\'>Keine Zeichnung verf√ºgbar</div>'">
</div>
</div>
 
<!-- Operationen-Tabelle mit Berechnungsdetails -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header">
<span>Operationen und Bearbeitungszeiten</span>
<div style="display:flex;align-items:center;gap:var(--space-2);">
<span style="font-size: 11px; font-weight: 400; color: var(--color-text-muted);">n [U/min] ¬∑ vf [mm/min] ¬∑ ap [mm]</span>
<button class="btn btn-secondary btn-sm" onclick="exportFertigungsCSV()" style="margin-left:var(--space-3);">CSV</button>
</div>
</div>
<div class="card-body" style="padding: 0;">
 
<!-- OP10 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op10')">
<span class="op-badge" style="margin-right: var(--space-3);">10</span>
<span style="flex: 1;"><strong>Planfr√§sen Oberseite</strong>
<div class="op-params"><span>n 800</span><span>vf 300</span><span>ap 2,0</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T1 √ò63</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>2,7 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op10-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkst√ºck -->
<rect x="20" y="40" width="120" height="60" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Fr√§ser -->
<circle cx="50" cy="30" r="20" fill="#1E3A5F" opacity="0.8"/>
<line x1="50" y1="30" x2="50" y2="45" stroke="#1E3A5F" stroke-width="3"/>
<!-- Bahnen -->
<line x1="30" y1="55" x2="130" y2="55" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<line x1="130" y1="70" x2="30" y2="70" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<line x1="30" y1="85" x2="130" y2="85" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<!-- Pfeil -->
<polygon points="130,55 125,52 125,58" fill="#059669"/>
<!-- Ma√üe -->
<text x="75" y="115" font-size="10" fill="#64748B" text-anchor="middle">130 mm</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Bahnstrategie: Zeilenweise</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 1,9 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Fl√§che: 130 √ó 130 mm = 16.900 mm¬≤<br>
 Bahnabstand: a<sub>e</sub>= 45 mm (70% von √ò63)<br>
 Anzahl Bahnen: 130 / 45 = 3 Bahnen<br>
 Verfahrweg: L = 3 √ó 130 = 390 mm<br>
 Vorschub: v<sub>f</sub>= 485 mm/min<br>
 Zustellungen: 2 (bei a<sub>p</sub>= 2 mm)<br>
<strong>t<sub>h</sub>= (390 √ó 2) / 485 = 1,61 min</strong><br>
 + Sicherheit 20% =<strong>1,9 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel: 0,3 min<br>
 Anfahren Z+100 ‚Üí Z+2: 0,2 min<br>
 Positionieren X/Y: 0,2 min<br>
 Spindel Start/Stop: 0,1 min<br>
<strong>t<sub>n</sub>= 0,8 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP20 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op20')">
<span class="op-badge" style="margin-right: var(--space-3);">20</span>
<span style="flex: 1;"><strong>Schruppen Au√üenkontur √ò120</strong>
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 √ò20</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>8,0 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op20-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkst√ºck (Querschnitt) -->
<rect x="30" y="20" width="100" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Kontur (Kreis) -->
<circle cx="80" cy="60" r="40" fill="none" stroke="#DC2626" stroke-width="2" stroke-dasharray="4"/>
<!-- Fr√§ser -->
<circle cx="120" cy="60" r="10" fill="#1E3A5F" opacity="0.8"/>
<!-- Pfeil Bewegung -->
<path d="M 120 50 A 40 40 0 0 0 80 20" fill="none" stroke="#059669" stroke-width="2"/>
<polygon points="82,22 78,18 84,18" fill="#059669"/>
<!-- Ma√üe -->
<text x="80" y="65" font-size="10" fill="#64748B" text-anchor="middle">√ò120</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Konturparallel, 6 Ebenen</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 6,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Konturl√§nge: U = œÄ √ó 120 = 377 mm<br>
 Tiefe: 42 mm, a<sub>p</sub>= 8 mm<br>
 Zustellungen: 42 / 8 = 6 Ebenen<br>
 Aufma√ü abtragen: 5 mm radial<br>
 Bahnen pro Ebene: 5 / 10 = 1<br>
 Verfahrweg: L = 377 √ó 6 = 2.262 mm<br>
 Vorschub: v<sub>f</sub>= 960 mm/min<br>
<strong>t<sub>h</sub>= 2.262 / 960 = 2,4 min</strong><br>
 √ó 1,5 (Komplexit√§t + Positionierung) =<strong>6,2 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 1,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel: 0,3 min<br>
 6√ó Zustellung Z: 6 √ó 0,15 = 0,9 min<br>
 Positionieren: 0,4 min<br>
 Sp√§ne blasen: 0,2 min<br>
<strong>t<sub>n</sub>= 1,8 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP30 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op30')">
<span class="op-badge" style="margin-right: var(--space-3);">30</span>
<span style="flex: 1;"><strong>Taschenfr√§sen</strong>
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 √ò20</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>5,7 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op30-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkst√ºck -->
<rect x="20" y="20" width="120" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Tasche -->
<rect x="50" y="40" width="60" height="40" fill="#94A3B8" stroke="#475569" stroke-width="1"/>
<!-- Fr√§sbahnen -->
<line x1="55" y1="50" x2="105" y2="50" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="105" y1="55" x2="55" y2="55" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="55" y1="60" x2="105" y2="60" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="105" y1="65" x2="55" y2="65" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="55" y1="70" x2="105" y2="70" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<!-- Fr√§ser -->
<circle cx="75" cy="55" r="8" fill="#1E3A5F" opacity="0.8"/>
<!-- Ma√üe -->
<text x="80" y="95" font-size="9" fill="#64748B" text-anchor="middle">60√ó40 mm</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Tasche: Zeilenr√§umen</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 4,5 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Taschengr√∂√üe: 60 √ó 40 mm<br>
 Tiefe: 15 mm, a<sub>p</sub>= 8 mm<br>
 Zustellungen: 2 Ebenen<br>
 Zeilenabstand: a<sub>e</sub>= 10 mm<br>
 Bahnen: 60 / 10 = 6 pro Ebene<br>
 Verfahrweg: L = 6 √ó 40 √ó 2 = 480 mm<br>
 + R√§umen Mitte: 200 mm<br>
 Vorschub: v<sub>f</sub>= 960 mm/min<br>
<strong>t<sub>h</sub>= 680 / 960 = 0,7 min √ó 4 Passes = 2,8 min (+Sicherheit = 4,5 min)</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 1,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Kein WZ-Wechsel (T2 bereits)<br>
 Positionieren zur Tasche: 0,3 min<br>
 2√ó Zustellung Z: 0,3 min<br>
 R√ºckzug + Sp√§ne: 0,6 min<br>
<strong>t<sub>n</sub>= 1,2 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP40 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op40')">
<span class="op-badge" style="margin-right: var(--space-3);">40</span>
<span style="flex: 1;">Konturfr√§sen
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 √ò20</span>
<span class="mono" style="width: 80px; text-align: right;">4,4 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op40-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 3,5 min</strong><br><br>
Konturl√§nge: ca. 520 mm<br>
Zustelltiefe: a<sub>p</sub>= 1,5 mm (2 Zustellungen)<br>
Verfahrweg: L = 520 √ó 2 = 1040 mm<br>
v<sub>f</sub>= 480 mm/min<br>
t<sub>h</sub>= 1040 / 480 = 2,17<br>
+ Sicherheit 20% √ó 1,6 Passes ‚âà3,5 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,9 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
Positionieren: 0,3 min<br>
Zustellung + Anfahren: 0,3 min
</div>
</div>
</div>
</div>

<!-- OP50 KRITISCH -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op50')">
<span class="op-badge critical" style="margin-right: var(--space-3);">50</span>
<span style="flex: 1;"><strong>Schlichten √ò120 h5</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 2400</span><span>vf 768</span><span>ap 0,3</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T3 √ò16</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>5,1 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op50-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 2px solid var(--color-error); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkst√ºck -->
<circle cx="80" cy="60" r="50" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Fertigma√ü -->
<circle cx="80" cy="60" r="40" fill="none" stroke="#DC2626" stroke-width="2"/>
<!-- Aufma√ü (Spirale angedeutet) -->
<path d="M 120 60 A 40 40 0 1 1 80 20" fill="none" stroke="#059669" stroke-width="1.5"/>
<path d="M 118 60 A 38 38 0 1 1 80 22" fill="none" stroke="#059669" stroke-width="1" opacity="0.6"/>
<!-- Fr√§ser -->
<circle cx="120" cy="60" r="8" fill="#1E3A5F" opacity="0.8"/>
<!-- Toleranz-Box -->
<rect x="55" y="85" width="50" height="18" fill="#FEE2E2" stroke="#DC2626" stroke-width="1" rx="2"/>
<text x="80" y="97" font-size="9" fill="#DC2626" text-anchor="middle" font-weight="bold">h5: ¬±0,018</text>
<!-- Ma√ü -->
<text x="80" y="65" font-size="11" fill="#DC2626" text-anchor="middle" font-weight="bold">√ò120</text>
</svg>
<div style="font-size: 10px; color: var(--color-error); margin-top: 4px; font-weight: 600;">KRITISCH: Spiralbahn</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-error);">Hauptzeit t<sub>h</sub>= 4,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Kontur: U = œÄ √ó 120 = 377 mm<br>
 Schlichttiefe: 42 mm<br>
 Zustellung: a<sub>p</sub>= 0,3 mm<br>
 Durchg√§nge: 42 / 0,3 = 140<br>
 ‚Üí Spiralbahn: 1 Durchgang<br>
 Verfahrweg: L = 377 + (42 √ó œÄ) = 509 mm<br>
<span style="color: var(--color-error);">Reduzierter Vorschub wg. h5!</span><br>
 v<sub>f</sub>= 280 mm/min (statt 557)<br>
<strong>t<sub>h</sub>= 509 / 280 √ó 2 = 3,6 min</strong><br>
 + Mess-Stopp 20% =<strong>4,2 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,9 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel T3: 0,3 min<br>
 Anfahren vorsichtig: 0,3 min<br>
 Zwischenmessung: 0,2 min<br>
 Positionieren: 0,1 min<br>
<strong>t<sub>n</sub>= 0,9 min</strong>
</div>
<div style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-error-light); border-radius: var(--radius-sm); color: var(--color-error); font-size: 11px;">
 Toleranz h5 = 0/-0,018 mm<br>
 Nur 18 ¬µm Spielraum!
</div>
</div>
</div>
</div>
</div>
 
<!-- OP60 KRITISCH -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op60')">
<span class="op-badge critical" style="margin-right: var(--space-3);">60</span>
<span style="flex: 1;"><strong>Feinbohren √ò26 H7</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 1100</span><span>vf 98</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T11</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>4,1 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op60-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 2px solid var(--color-error); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkst√ºck Schnitt -->
<rect x="30" y="20" width="100" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Bohrung -->
<rect x="70" y="20" width="20" height="60" fill="#94A3B8" stroke="#475569" stroke-width="1"/>
<!-- Feinbohrkopf -->
<rect x="72" y="5" width="16" height="25" fill="#1E3A5F" rx="2"/>
<circle cx="80" cy="35" r="10" fill="none" stroke="#DC2626" stroke-width="2"/>
<!-- Pfeil runter -->
<line x1="80" y1="40" x2="80" y2="70" stroke="#059669" stroke-width="2"/>
<polygon points="80,70 76,62 84,62" fill="#059669"/>
<!-- Ma√üe -->
<text x="80" y="95" font-size="9" fill="#DC2626" text-anchor="middle" font-weight="bold">√ò26 H7</text>
<text x="130" y="55" font-size="8" fill="#64748B">35mm</text>
<!-- Toleranz -->
<rect x="100" y="70" width="45" height="16" fill="#FEE2E2" stroke="#DC2626" stroke-width="1" rx="2"/>
<text x="122" y="81" font-size="8" fill="#DC2626" text-anchor="middle">+0,021/0</text>
</svg>
<div style="font-size: 10px; color: var(--color-error); margin-top: 4px; font-weight: 600;">Feinbohrkopf 3√ó</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-error);">Hauptzeit t<sub>h</sub>= 3,3 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Bohrtiefe: 35 mm<br>
 Vorschub: v<sub>f</sub>= 98 mm/min<br>
 Einfahren: L = 35 mm<br>
 Ausfahren: L = 35 mm (langsam)<br>
 Ausfahren v<sub>f</sub>= 50 mm/min<br>
 t<sub>ein</sub>= 35 / 98 = 0,36 min<br>
 t<sub>aus</sub>= 35 / 50 = 0,70 min<br>
 √ó 3 Bohrungen = 3,18 min<br>
<strong>t<sub>h</sub>= 3,3 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel T11: 0,3 min<br>
 3√ó Positionieren: 0,3 min<br>
 Feinbohrkopf einstellen: 0,2 min<br>
<strong>t<sub>n</sub>= 0,8 min</strong>
</div>
<div style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-error-light); border-radius: var(--radius-sm); color: var(--color-error); font-size: 11px;">
 Toleranz H7 = +0,021/0 mm<br>
 Feinbohrkopf-Einstellung dokumentieren!
</div>
</div>
</div>
</div>
</div>
 
<!-- OP70 -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op70')">
<span class="op-badge critical" style="margin-right: var(--space-3);">70</span>
<span style="flex: 1;"><strong>Feinbohren √ò44 H7</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 900</span><span>vf 75</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T12</span>
<span class="mono" style="width: 80px; text-align: right;">4,7 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op70-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 3,8 min</strong><br><br>
Bohrtiefe: 50 mm<br>
Bearbeitungszugabe: 0,15 mm auf Radius<br>
v<sub>f</sub>= 75 mm/min (langsam f√ºr IT7)<br>
Vorbohren: √ò43,7 ‚Üí Feinbohren: √ò44 H7<br>
3 Durchg√§nge √† 0,05 mm = 3 √ó 50/75<br>
+ Messunterbrechung: 1,8 min<br>
t<sub>h</sub>‚âà 3,8 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,9 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
Innenmessschraube einsetzen: 0,3 min<br>
Positionieren + Spanblasluft: 0,3 min<br><br>
<strong style="color: var(--color-error);">Toleranz H7: +0,000 / +0,025 mm</strong><br>
Nachmessen nach jedem Durchgang!
</div>
</div>
</div>
</div>

<!-- OP80 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op80')">
<span class="op-badge" style="margin-right: var(--space-3);">80</span>
<span style="flex: 1;">Bohren M8 Gewinde (4√ó)
<div class="op-params"><span>n 1800</span><span>vf 320</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T5 √ò6,8</span>
<span class="mono" style="width: 80px; text-align: right;">1,9 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op80-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 1,2 min</strong><br><br>
4√ó Kernlochbohrung √ò6,8 mm<br>
Bohrtiefe: 20 mm (durchgehend)<br>
v<sub>f</sub>= 320 mm/min<br>
t<sub>h</sub>= 4 √ó 20 / 320 = 0,25 min<br>
+ Anbohrzyklen + Sp√§nebrechen<br>
‚âà 1,2 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,7 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
4√ó Positionieren: 0,2 min<br>
Sp√§ne ausblasen: 0,2 min
</div>
</div>
</div>
</div>

<!-- OP90 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op90')">
<span class="op-badge" style="margin-right: var(--space-3);">90</span>
<span style="flex: 1;">Gewindefr√§sen M8 (4√ó)
<div class="op-params"><span>n 1500</span><span>vf 250</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T13</span>
<span class="mono" style="width: 80px; text-align: right;">2,6 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op90-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 2,0 min</strong><br><br>
4√ó M8 Gewinde, Steigung 1,25 mm<br>
Gewindetiefe: 15 mm<br>
Helixinterpolation: 12 Umdrehungen/Gewinde<br>
v<sub>f</sub>= 250 mm/min<br>
t<sub>h</sub>= 4 √ó (12 √ó œÄ √ó 4) / 250 ‚âà 2,0 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,6 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
4√ó Positionieren: 0,2 min<br>
Gewindelehre pr√ºfen: 0,1 min
</div>
</div>
</div>
</div>

<!-- OP100 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op100')">
<span class="op-badge" style="margin-right: var(--space-3);">100</span>
<span style="flex: 1;">Entgraten, Pr√ºfen</span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">‚Äî</span>
<span class="mono" style="width: 80px; text-align: right;">5,0 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
</div>
<div id="op100-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Entgraten: 3,0 min</strong><br><br>
Alle Kanten entgraten (manuell)<br>
Gratfreiheit pr√ºfen (Fingerprobe)<br>
Bohrungseing√§nge senken
</div>
<div>
<strong>Pr√ºfen: 2,0 min</strong><br><br>
Sichtkontrolle Oberfl√§che<br>
Ma√ükontrolle Hauptma√üe (Messschieber)<br>
Gewindepaarung M8 pr√ºfen (Lehre)<br>
Freigabe / Dokumentation
</div>
</div>
</div>
</div>
 
<!-- SUMME -->
<div id="opSumRow" style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); background: var(--color-primary); color: white; font-weight: 600;">
<span style="flex: 1;">SUMME</span>
<span class="mono" id="opSumDetail" style="margin-right: var(--space-4);">10 Arbeitsg√§nge</span>
<span class="mono" id="opSumTotal" style="width: 80px; text-align: right;">44,2 min</span>
</div>
</div>

<!-- Arbeitsgang hinzuf√ºgen -->
<div style="display:flex;gap:var(--space-3);margin-bottom:var(--space-5);">
<button class="btn btn-secondary btn-sm" onclick="addCustomOP()">+ Arbeitsgang hinzuf√ºgen</button>
</div>

<!-- Container f√ºr manuell hinzugef√ºgte OPs -->
<div id="customOpsContainer"></div>

<!-- Qualit√§tspr√ºfung -->
<div class="instruction-section">
<div class="instruction-header">
<h4>Qualit√§tspr√ºfung</h4>
<div style="display:flex;align-items:center;gap:var(--space-2);">
<span class="badge badge-info">QS</span>
<button class="btn btn-secondary btn-sm" onclick="exportPruefCSV()">CSV</button>
</div>
</div>
<div class="instruction-content">
<table class="table" id="pruefTable">
<thead>
<tr>
<th style="width:30px;"></th>
<th>Pr√ºfmerkmal</th>
<th>Soll</th>
<th>Pr√ºfmittel</th>
<th class="right">Zeit</th>
<th style="width:30px;"></th>
</tr>
</thead>
<tbody id="pruefBody">
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>√ò26 H7</td>
<td class="mono">26,000 / 26,021</td>
<td>Innenmessschraube</td>
<td class="right mono">0,8 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">√ó</button></td>
</tr>
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>H√∂he</td>
<td class="mono">20,0 ¬±0,1</td>
<td>Messschieber</td>
<td class="right mono">0,3 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">√ó</button></td>
</tr>
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>Oberfl√§che</td>
<td class="mono">Rz ‚â§ 25</td>
<td>Vergleichsmuster</td>
<td class="right mono">0,5 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">√ó</button></td>
</tr>
</tbody>
</table>
<button class="btn btn-secondary btn-sm" onclick="addPruefRow()" style="margin-top:var(--space-3);">+ Pr√ºfmerkmal hinzuf√ºgen</button>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: KALKULATION (Detailliert)
 ======================================== -->
<div class="section" id="section-calculation">
 
<!-- Legende -->
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Berechnungsformel:</strong>t<sub>h</sub>= Verfahrweg L [mm] √∑ Vorschub v<sub>f</sub>[mm/min] &nbsp;|&nbsp; 
<strong>Nebenzeit:</strong> Werkzeugwechsel + Positionieren + Zustellung + Sp√§ne entfernen
</div>
 
<!-- 2-Spalten Layout: Maschine + Material -->
<div class="grid-2" style="margin-bottom: var(--space-5);">
<!-- Maschinenzeitkalkulation -->
<div class="card">
<div class="card-header"><span>Maschinenzeitkalkulation</span></div>
<div class="card-body">
<table class="table">
<tbody>
<tr>
<td>Hauptzeit (th)</td>
<td class="right mono" id="calcTh">31,2 min</td>
</tr>
<tr>
<td>Nebenzeit (tn)</td>
<td class="right mono" id="calcTn">8,0 min</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gesamtzeit</td>
<td class="right mono" id="calcTimeTotal">39,2 min</td>
</tr>
<tr>
<td>√ó Stundensatz</td>
<td class="right mono">EUR 91/h</td>
</tr>
<tr style="background: var(--color-info-light); font-weight: 600;">
<td>= Maschinenkosten</td>
<td class="right mono" id="calcMachCost">EUR 59,47</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<!-- Materialkalkulation -->
<div class="card">
<div class="card-header"><span>Materialkalkulation</span></div>
<div class="card-body">
<table class="table">
<tbody>
<tr>
<td>Rohma√üe</td>
<td class="right mono" id="calcRawDims">130 √ó 130 √ó 47 mm</td>
</tr>
<tr>
<td>Volumen</td>
<td class="right mono" id="calcVolume">794.170 mm¬≥</td>
</tr>
<tr>
<td>Werkstoff / Dichte</td>
<td class="right mono" id="calcDensity">S235JR / 7,85 g/cm¬≥</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gewicht</td>
<td class="right mono" id="calcWeight">6,23 kg</td>
</tr>
<tr>
<td>√ó Preis + 10% Verschnitt</td>
<td class="right mono" id="calcMatFormula">EUR 6,79/kg √ó 1,1</td>
</tr>
<tr style="background: var(--color-success-light); font-weight: 600;">
<td>= Materialkosten</td>
<td class="right mono" id="calcMatCost">EUR 46,57</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
 
<!-- Einrichtkosten -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Einrichtkosten (R√ºstzeit)</span></div>
<div class="card-body">
<div class="grid-2">
<table class="table">
<tbody>
<tr>
<td>Spannmethode</td>
<td class="right" id="calcClamping">Schraubstock</td>
</tr>
<tr>
<td>Basis-Einrichtzeit</td>
<td class="right mono">15 min</td>
</tr>
<tr>
<td>Aufspannungen</td>
<td class="right mono" id="calcSetups">2√ó</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gesamt-Einrichtzeit</td>
<td class="right mono" id="calcSetupTime">24 min</td>
</tr>
</tbody>
</table>
<table class="table">
<tbody>
<tr>
<td>√ó Stundensatz</td>
<td class="right mono">EUR 91/h</td>
</tr>
<tr style="background: var(--color-warning-light); font-weight: 600;">
<td>= Einrichtkosten</td>
<td class="right mono" id="calcSetupCostDetail">EUR 36,40</td>
</tr>
<tr>
<td>√∑ St√ºckzahl</td>
<td class="right mono" id="calcQtyDetail">1</td>
</tr>
<tr style="font-weight: 600;">
<td>= Pro St√ºck</td>
<td class="right mono" id="calcSetupPerPiece">EUR 36,40</td>
</tr>
</tbody>
</table>
</div>
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Tipp:</strong> Bei Serienproduktion werden Einrichtkosten auf alle Teile verteilt ‚Äî der St√ºckpreis sinkt erheblich.
</div>
</div>
</div>
 
<!-- Berechnungsmethodik -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Normengrundlage</span></div>
<div class="card-body" style="font-size: 13px; line-height: 1.7;">
<div class="grid-2">
<div>
<strong style="color: var(--color-primary);">REFA</strong><br>
<span style="color: var(--color-text-secondary);">
 T = t<sub>r</sub> + t<sub>a</sub><br>
 t<sub>g</sub> = t<sub>h</sub> + t<sub>n</sub>
</span>
</div>
<div>
<strong style="color: var(--color-primary);">VDI 3321</strong><br>
<span style="color: var(--color-text-secondary);">
 v<sub>c</sub> = œÄ√ód√ón / 1000<br>
 t<sub>h</sub> = L / v<sub>f</sub>
</span>
</div>
<div>
<strong style="color: var(--color-primary);">DIN 8580</strong><br>
<span style="color: var(--color-text-secondary);">Hauptgruppe 3 ‚Äî Spanen</span>
</div>
<div>
<strong style="color: var(--color-primary);">DIN EN 10027</strong><br>
<span style="color: var(--color-text-secondary);">Werkstoffbezeichnungen und Kennwerte</span>
</div>
</div>
</div>
</div>
 
<!-- Gesamtkalkulation -->
<div class="card">
<div class="card-header card-header-primary"><span>Gesamtkalkulation</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Kostenart</th>
<th class="right">Berechnung</th>
<th class="right">Pro St√ºck</th>
<th class="right">Gesamt</th>
</tr>
</thead>
<tbody id="calcSummaryBody">
<tr><td colspan="4" style="text-align:center; color: var(--color-text-muted);">Bitte zuerst Berechnung durchf√ºhren</td></tr>
</tbody>
</table>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: WERKZEUGE
 ======================================== -->
</div>
<div class="section" id="section-tools">
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Automatisch generiert</strong> auf Grundlage des Operationsplans und der VDI 3321 Schnittdatenrichtwerte. Werkzeugkosten sind im Maschinenstundensatz enthalten und werden nicht separat kalkuliert. Standzeiten dienen der Werkzeugplanung.
</div>
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Schnittparameter</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table" id="cuttingParamsTable">
<thead>
<tr>
<th>Werkzeug</th>
<th>Operation</th>
<th class="right">Vc [m/min]</th>
<th class="right">n [U/min]</th>
<th class="right">fz [mm/Z]</th>
<th class="right">vf [mm/min]</th>
<th class="right">ap [mm]</th>
<th class="right">ae [mm]</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>T1</strong> Planfr√§ser √ò63</td>
<td>Planfr√§sen</td>
<td class="right mono">160</td>
<td class="right mono">808</td>
<td class="right mono">0,15</td>
<td class="right mono">485</td>
<td class="right mono">2,0</td>
<td class="right mono">45</td>
</tr>
<tr>
<td><strong>T2</strong> VHM-Fr√§ser √ò20</td>
<td>Schruppen</td>
<td class="right mono">150</td>
<td class="right mono">2400</td>
<td class="right mono">0,10</td>
<td class="right mono">960</td>
<td class="right mono">8,0</td>
<td class="right mono">10</td>
</tr>
<tr>
<td><strong>T3</strong> VHM-Schlichtfr√§ser √ò16</td>
<td>Schlichten</td>
<td class="right mono">120</td>
<td class="right mono">2400</td>
<td class="right mono">0,08</td>
<td class="right mono">768</td>
<td class="right mono">0,3</td>
<td class="right mono">8</td>
</tr>
<tr>
<td><strong>T11</strong> Feinbohrkopf √ò26</td>
<td>Feinbohren</td>
<td class="right mono">100</td>
<td class="right mono">1225</td>
<td class="right mono">0,08</td>
<td class="right mono">98</td>
<td class="right mono">0,15</td>
<td class="right mono">‚Äî</td>
</tr>
<tr>
<td><strong>T12</strong> Feinbohrkopf √ò44</td>
<td>Feinbohren</td>
<td class="right mono">100</td>
<td class="right mono">723</td>
<td class="right mono">0,08</td>
<td class="right mono">58</td>
<td class="right mono">0,15</td>
<td class="right mono">‚Äî</td>
</tr>
<tr>
<td><strong>T13</strong> Gewindefr√§ser M8</td>
<td>Gewinde</td>
<td class="right mono">80</td>
<td class="right mono">3183</td>
<td class="right mono">‚Äî</td>
<td class="right mono">1,25</td>
<td class="right mono">1,25</td>
<td class="right mono">‚Äî</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Legende:</strong> Vc = Schnittgeschwindigkeit | n = Drehzahl | fz = Vorschub pro Zahn | vf = Vorschubgeschwindigkeit | ap = Schnitttiefe | ae = Zustellung
</div>
 
<div class="card">
<div class="card-header"><span>Werkzeugeinsatz</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Werkzeug</th>
<th class="right">Preis [EUR]</th>
<th class="right">Standzeit [min]</th>
<th class="right">Einsatzzeit [min]</th>
<th class="right">Verschlei√ü [EUR]</th>
</tr>
</thead>
<tbody>
<tr>
<td>T1 Planfr√§ser √ò63 (WSP)</td>
<td class="right mono">45,00</td>
<td class="right mono">120</td>
<td class="right mono">2,7</td>
<td class="right mono">1,01</td>
</tr>
<tr>
<td>T2 VHM-Fr√§ser √ò20</td>
<td class="right mono">185,00</td>
<td class="right mono">90</td>
<td class="right mono">5,1</td>
<td class="right mono">10,48</td>
</tr>
<tr>
<td>T3 VHM-Schlichtfr√§ser √ò16</td>
<td class="right mono">165,00</td>
<td class="right mono">80</td>
<td class="right mono">3,6</td>
<td class="right mono">7,43</td>
</tr>
<tr>
<td>T11/T12 Feinbohrk√∂pfe</td>
<td class="right mono">35,00</td>
<td class="right mono">200</td>
<td class="right mono">1,4</td>
<td class="right mono">0,25</td>
</tr>
<tr>
<td>T13 Gewindefr√§ser M8</td>
<td class="right mono">89,00</td>
<td class="right mono">100</td>
<td class="right mono">1,8</td>
<td class="right mono">1,60</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gesamt</td>
<td class="right mono">‚Äî</td>
<td class="right mono">‚Äî</td>
<td class="right mono">14,6</td>
<td class="right mono">EUR 20,77</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="warning-box" style="margin-top: var(--space-5);">
<strong>Hinweis:</strong> Werkzeugkosten sind im Maschinenstundensatz enthalten. Die √úbersicht dient der Werkzeugplanung und Standzeit-Dokumentation. Standzeiten sind werkstoffabh√§ngig und k√∂nnen bei schwerzerspanbaren Materialien um 30-50 % reduziert sein.
</div>
 
</div>
 
<!-- ========================================
 SECTION: NC-CODE
 ======================================== -->
<div class="section" id="section-code">
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Entwurf ‚Äî nicht direkt an der Maschine verwenden.</strong> Generiert auf Grundlage des Operationsplans und der gew√§hlten Steuerung. Werkzeugdaten, Nullpunkt, Sicherheitsebene und Verfahrwege m√ºssen vor dem Einsatz an die jeweilige Maschine angepasst werden. Simulation vor dem ersten Durchlauf ist zwingend erforderlich.
</div>

<div style="display: grid; grid-template-columns: 1fr 320px; gap: var(--space-4);">
<!-- LEFT: NC Code -->
<div>
<div class="card">
<div class="card-header">
<span>NC-Code Generator</span>
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-primary btn-sm" id="btnHeidenhain" onclick="setCodeFormat('heidenhain')">Heidenhain</button>
<button class="btn btn-secondary btn-sm" id="btnSiemens" onclick="setCodeFormat('siemens')">Siemens</button>
<button class="btn btn-secondary btn-sm" id="btnFanuc" onclick="setCodeFormat('fanuc')">Fanuc</button>
</div>
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-secondary btn-sm" onclick="copyCode()">Kopieren</button>
<button class="btn btn-primary btn-sm" onclick="downloadCode()">Download</button>
</div>
</div>
<div class="card-body" style="padding: 0;">
<div class="code-block" id="codeBlock" style="max-height: 600px; overflow-y: auto;">
<pre id="codeContent"><span class="code-comment">; ========================================</span>
<span class="code-comment">; CNC PLANNER PRO ‚Äî Automatisch generiert</span>
<span class="code-comment">; ========================================</span>
<span class="code-comment">; Werkst√ºck: Verbindungsplatte</span>
<span class="code-comment">; Werkstoff: S235JR</span>
<span class="code-comment">; Maschine: Hermle C 400</span>
<span class="code-comment">; Steuerung: Heidenhain TNC 640</span>
<span class="code-comment">; ========================================</span>

<span class="code-keyword">BEGIN PGM</span>VERBINDUNGSPLATTE<span class="code-keyword">MM</span>

<span class="code-comment">; --- WERKZEUGLISTE ---</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">1</span>L+<span class="code-number">0</span>R+<span class="code-number">31.5</span><span class="code-comment">; Planfr√§ser √ò63</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">2</span>L+<span class="code-number">0</span>R+<span class="code-number">10</span><span class="code-comment">; VHM-Fr√§ser √ò20</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">11</span>L+<span class="code-number">0</span>R+<span class="code-number">13</span><span class="code-comment">; Feinbohrkopf √ò26</span>

<span class="code-comment">; OP10: PLANFR√ÑSEN</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">1</span>Z S<span class="code-number">800</span>
L Z+<span class="code-number">100</span>R0 FMAX M3
L X+<span class="code-number">0</span>Y+<span class="code-number">0</span>FMAX

<span class="code-keyword">CYCL DEF</span><span class="code-number">230</span><span class="code-keyword">FACE MILLING</span>
 Q<span class="code-number">225</span>=+<span class="code-number">0</span>
 Q<span class="code-number">218</span>=<span class="code-number">450</span>
 Q<span class="code-number">219</span>=<span class="code-number">60</span>
 Q<span class="code-number">202</span>=<span class="code-number">2</span>
 Q<span class="code-number">207</span>=<span class="code-number">300</span>

<span class="code-keyword">CYCL CALL</span>
L Z+<span class="code-number">100</span>FMAX
M5

<span class="code-comment">; OP20: KONTUR</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">2</span>Z S<span class="code-number">2500</span>
M3
<span class="code-comment">; ... weitere Bearbeitung</span>

<span class="code-comment">; OP30: FEINBOHREN √ò26 H7</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">11</span>Z S<span class="code-number">1200</span>
M3
L X+<span class="code-number">220</span>Y+<span class="code-number">25</span>FMAX

<span class="code-keyword">CYCL DEF</span><span class="code-number">201</span><span class="code-keyword">BORING</span>
 Q<span class="code-number">200</span>=<span class="code-number">2</span>
 Q<span class="code-number">201</span>=-<span class="code-number">25</span>
 Q<span class="code-number">206</span>=<span class="code-number">100</span>

<span class="code-keyword">CYCL CALL</span>
L Z+<span class="code-number">100</span>FMAX
M5
M30

<span class="code-keyword">END PGM</span>VERBINDUNGSPLATTE<span class="code-keyword">MM</span></pre>
</div>
</div>
</div>
 
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Programm-Info:</strong> <span id="codeLineCount">85</span> Zeilen | Gesch√§tzte Laufzeit: <span id="codeRuntime">12,5 min</span> | Maschine: Hermle C 400<br>
<strong>Hinweis:</strong> Der generierte NC-Code dient als Ausgangsbasis und muss vor der Fertigung am Simulator oder der Maschine verifiziert werden.
</div>
</div>

<!-- RIGHT: AI Assistant Panel -->
<div>
<div class="card" style="position: sticky; top: var(--space-4);">
<div class="card-header" style="background: var(--color-primary); color: white; border-bottom-color: var(--color-primary-light);">
<div style="display: flex; align-items: center; gap: var(--space-2);">
<span>ü§ñ</span>
<span>AI-Assistent</span>
</div>
<span style="font-size: 10px; opacity: 0.7; font-weight: 400;">NC-Code</span>
</div>
<div class="card-body" style="padding: 0;">
<!-- Scope indicator -->
<div style="padding: 8px 12px; background: var(--color-info-light); border-bottom: 1px solid var(--color-border-light); font-size: 11px; color: var(--color-info);">
<strong>Kontext:</strong> NC-Code ‚Äî √Ñnderungen nur an Steuerungscode, Werkzeugen und Schnittparametern m√∂glich.
</div>

<!-- Chat history -->
<div id="aiChatHistory" style="max-height: 350px; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px;">
<div class="ai-msg ai-msg-system" style="font-size: 11px; color: var(--color-text-muted); text-align: center; padding: 8px;">
Ich kann den NC-Code anpassen: Werkzeuge √§ndern, Schnittdaten optimieren, OPs erg√§nzen, Steuerungsformat wechseln.
</div>
</div>

<!-- Quick actions -->
<div style="padding: 8px 12px; border-top: 1px solid var(--color-border-light); display: flex; flex-wrap: wrap; gap: 4px;">
<button class="btn btn-sm" onclick="aiQuickAction('code', 'Generiere vollst√§ndigen NC-Code f√ºr alle Operationen')" style="font-size:10px;height:24px;">Vollst√§ndig generieren</button>
<button class="btn btn-sm" onclick="aiQuickAction('code', 'Optimiere Schnittdaten f√ºr S355')" style="font-size:10px;height:24px;">Schnittdaten optimieren</button>
<button class="btn btn-sm" onclick="aiQuickAction('code', 'F√ºge Sicherheitsabfragen hinzu')" style="font-size:10px;height:24px;">Sicherheit +</button>
<button class="btn btn-sm" onclick="aiQuickAction('code', 'Konvertiere zu Siemens 840D')" style="font-size:10px;height:24px;">‚Üí Siemens</button>
</div>

<!-- Input -->
<div style="padding: 8px 12px; border-top: 1px solid var(--color-border); display: flex; gap: 6px;">
<input type="text" class="input" id="aiChatInput" placeholder="z.B. √Ñndere Drehzahl f√ºr OP10 auf 600..." 
 style="font-size: 12px; height: 36px;" 
 onkeydown="if(event.key==='Enter')sendAiMessage('code')">
<button class="btn btn-primary btn-sm" onclick="sendAiMessage('code')" style="height: 36px; min-width: 36px; padding: 0;">‚Üí</button>
</div>
</div>
</div>

<!-- Feedback collected -->
<div class="card" style="margin-top: var(--space-4);">
<div class="card-header"><span>Werker-Feedback</span><span id="feedbackCount" style="font-size:10px;font-weight:400;">0 Eintr√§ge</span></div>
<div class="card-body" id="feedbackLog" style="max-height: 200px; overflow-y: auto;">
<div style="font-size: 11px; color: var(--color-text-hint); text-align: center; padding: var(--space-4);">
Noch kein Feedback eingegangen.<br>Nutzen Sie üì± "Werker fragen" in der Fertigungsanweisung.
</div>
</div>
</div>
</div>
</div><!-- /grid -->
</div>
 
<!-- ========================================
 SECTION: FEEDBACK & CROSS-LEARNINGS
 ======================================== -->
<div class="section" id="section-feedback">
 
<!-- Tabs -->
<div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-5); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-3);">
<button class="btn btn-sm btn-primary" id="tabFeedbackHistorie" onclick="showFeedbackTab('historie')">Historie</button>
<button class="btn btn-sm btn-secondary" id="tabFeedbackEingabe" onclick="showFeedbackTab('eingabe')">Soll-Ist-Vergleich</button>
<button class="btn btn-sm btn-secondary" id="tabFeedbackLearnings" onclick="showFeedbackTab('learnings')">Erkenntnisse</button>
<button class="btn btn-sm btn-secondary" id="tabFeedbackDashboard" onclick="showFeedbackTab('dashboard')">Dashboard</button>
</div>

<!-- TAB: Dashboard -->
<div id="feedback-dashboard" style="display: none;">

<!-- KPI Karten -->
<div class="grid-4" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiAuftraege">47</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Angebote</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--color-success);" id="kpiAnnahme">68 %</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Annahmequote</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiVolumen">EUR 124.500</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Auftragsvolumen</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiDurchschnitt">EUR 2.649</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">√ò Auftragswert</div>
</div>
</div>
</div>

<!-- Zweite Reihe -->
<div class="grid-3" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--color-warning);" id="kpiAbweichung">+18 %</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">√ò Abweichung Soll/Ist</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiNachkalk">12 / 47</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Nachkalkuliert</div>
<div style="margin-top:6px;">
<div style="height:6px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:26%;height:100%;background:var(--color-primary);border-radius:3px;" id="kpiNachkalkBar"></div>
</div>
<div style="font-size:10px;color:var(--color-text-muted);margin-top:2px;" id="kpiNachkalkPct">26 %</div>
</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiDurchlauf">3,2 Wo.</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">√ò Durchlaufzeit</div>
</div>
</div>
</div>

<!-- Verlustgr√ºnde -->
<div class="grid-2" style="gap: var(--space-5); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-header"><span>Verlustgr√ºnde (abgelehnte Angebote)</span></div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:var(--space-3);" id="kpiVerlustgruende">
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Preis zu hoch</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:43%;height:100%;background:var(--color-error);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">43 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Lieferzeit</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:27%;height:100%;background:var(--color-warning);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">27 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Kapazit√§t</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:20%;height:100%;background:var(--color-info);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">20 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Sonstiges</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:10%;height:100%;background:var(--color-text-muted);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">10 %</span>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header"><span>Werkstoff-Verteilung (Auftr√§ge)</span></div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:var(--space-3);" id="kpiWerkstoffe">
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">S235JR</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:52%;height:100%;background:var(--color-primary);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">52 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">AlMg3</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:23%;height:100%;background:#6366f1;border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">23 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">1.4301</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:15%;height:100%;background:#f59e0b;border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">15 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Andere</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:10%;height:100%;background:var(--color-text-muted);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">10 %</span>
</div>
</div>
</div>
</div>
</div>

<!-- Monats√ºbersicht -->
<div class="card">
<div class="card-header"><span>Monatliche Entwicklung</span></div>
<div class="card-body" style="padding:0;overflow-x:auto;">
<table class="table">
<thead>
<tr>
<th>Monat</th>
<th class="right">Angebote</th>
<th class="right">Auftr√§ge</th>
<th class="right">Quote</th>
<th class="right">Volumen</th>
<th class="right">√ò Abweichung</th>
</tr>
</thead>
<tbody>
<tr>
<td>Feb 2026</td>
<td class="right mono">8</td>
<td class="right mono">5</td>
<td class="right mono" style="color:var(--color-success);">63 %</td>
<td class="right mono">EUR 18.400</td>
<td class="right mono" style="color:var(--color-warning);">+22 %</td>
</tr>
<tr>
<td>Jan 2026</td>
<td class="right mono">12</td>
<td class="right mono">9</td>
<td class="right mono" style="color:var(--color-success);">75 %</td>
<td class="right mono">EUR 31.200</td>
<td class="right mono" style="color:var(--color-warning);">+16 %</td>
</tr>
<tr>
<td>Dez 2025</td>
<td class="right mono">10</td>
<td class="right mono">6</td>
<td class="right mono">60 %</td>
<td class="right mono">EUR 24.800</td>
<td class="right mono" style="color:var(--color-warning);">+19 %</td>
</tr>
<tr>
<td>Nov 2025</td>
<td class="right mono">9</td>
<td class="right mono">7</td>
<td class="right mono" style="color:var(--color-success);">78 %</td>
<td class="right mono">EUR 28.300</td>
<td class="right mono" style="color:var(--color-success);">+12 %</td>
</tr>
<tr>
<td>Okt 2025</td>
<td class="right mono">8</td>
<td class="right mono">5</td>
<td class="right mono">63 %</td>
<td class="right mono">EUR 21.800</td>
<td class="right mono" style="color:var(--color-warning);">+21 %</td>
</tr>
</tbody>
<tfoot style="font-weight:600;background:var(--color-bg-subtle);">
<tr>
<td>Gesamt</td>
<td class="right mono">47</td>
<td class="right mono">32</td>
<td class="right mono">68 %</td>
<td class="right mono">EUR 124.500</td>
<td class="right mono">+18 %</td>
</tr>
</tfoot>
</table>
</div>
</div>

</div>
 
<!-- TAB: Soll-Ist-Vergleich (Erfassung) -->
<div id="feedback-eingabe" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Soll-Ist-Vergleich erfassen</span></div>
<div class="card-body">

<!-- Auftragsstatus -->
<div class="grid-4" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Projekt-Nr.</label>
<input type="text" class="input input-mono" id="fbProjektNr" value="2500473.01" readonly style="background: var(--color-bg);">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Datum</label>
<input type="date" class="input" id="fbDatum" value="2026-02-05">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Erfasser</label>
<input type="text" class="input" id="fbErfasser" placeholder="K√ºrzel">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Auftragsstatus</label>
<select class="select" id="fbAuftragsstatus" onchange="toggleAblehnungsgrund()">
<option value="angenommen">Angenommen</option>
<option value="abgelehnt">Abgelehnt</option>
<option value="offen">Offen</option>
</select>
</div>
</div>

<!-- Ablehnungsgrund (nur bei abgelehnt) -->
<div id="fbAblehnungBox" style="display:none;margin-bottom:var(--space-5);">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom:0;">
<label class="form-label">Ablehnungsgrund</label>
<select class="select" id="fbAblehnungsgrund">
<option value="">‚Äî</option>
<option value="preis">Preis zu hoch</option>
<option value="lieferzeit">Lieferzeit zu lang</option>
<option value="kapazitaet">Keine Kapazit√§t</option>
<option value="technik">Technisch nicht machbar</option>
<option value="wettbewerb">Wettbewerber g√ºnstiger</option>
<option value="sonstiges">Sonstiges</option>
</select>
</div>
<div class="form-group" style="margin-bottom:0;">
<label class="form-label">Wettbewerbspreis (falls bekannt)</label>
<div class="input-with-unit">
<input type="number" class="input input-mono" id="fbWettbewerbspreis" placeholder="‚Äî" step="0.01">
<span class="input-unit">EUR</span>
</div>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-text-muted); font-size: 12px; text-transform: uppercase;">Zeitabweichungen pro Operation</div>
 
<table class="table" style="margin-bottom: var(--space-5);">
<thead>
<tr>
<th style="width: 80px;">OP</th>
<th>Beschreibung</th>
<th style="width: 100px;">Kalk.</th>
<th style="width: 100px;">Ist</th>
<th style="width: 80px;">Delta</th>
<th style="width: 150px;">Grund</th>
<th>Notiz</th>
</tr>
</thead>
<tbody id="feedbackOpsTable">
<tr>
<td class="mono">OP10</td>
<td>Planfr√§sen</td>
<td class="mono right">2,7 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz">Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder="z.B. Fr√§skanten n√∂tig"></td>
</tr>
<tr>
<td class="mono">OP20</td>
<td>Kontur schruppen</td>
<td class="mono right">8,0 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz">Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder=""></td>
</tr>
<tr>
<td class="mono">OP30</td>
<td>Taschenfr√§sen</td>
<td class="mono right">5,7 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz">Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder=""></td>
</tr>
<tr>
<td class="mono">OP40</td>
<td>Bohren / Gewinde</td>
<td class="mono right">4,6 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz">Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder=""></td>
</tr>
<tr style="background: rgba(254,226,226,0.3);">
<td class="mono" style="color: var(--color-error);">OP50</td>
<td>Schlichten h5</td>
<td class="mono right">5,1 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz" selected>Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder="z.B. 3√ó nachgemessen"></td>
</tr>
<tr style="background: rgba(254,226,226,0.3);">
<td class="mono" style="color: var(--color-error);">OP60</td>
<td>Feinbohren H7</td>
<td class="mono right">4,1 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" step="0.1" onchange="updateFeedbackDelta(this)"></td>
<td class="mono right" data-delta>‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;">
<option value="">‚Äî</option>
<option value="einrichtung">Einrichtung</option>
<option value="werkzeug">Werkzeug</option>
<option value="material">Material</option>
<option value="toleranz">Toleranz</option>
<option value="nc">NC-Programm</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" placeholder=""></td>
</tr>
</tbody>
<tfoot style="background: var(--color-bg); font-weight: 600;">
<tr>
<td colspan="2">Einrichtung (Setup)</td>
<td class="mono right">25 min</td>
<td><input type="number" class="input input-sm input-mono" style="width: 70px;" id="fbSetupIst" step="1" onchange="updateSetupDelta()"></td>
<td class="mono right" id="fbSetupDelta">‚Äî</td>
<td>
<select class="input input-sm" style="width: 130px;" id="fbSetupGrund">
<option value="">‚Äî</option>
<option value="fraeskanten">Fr√§skanten</option>
<option value="ausrichten">Ausrichten</option>
<option value="nullpunkt">Nullpunkt</option>
<option value="spannung">Spannung</option>
<option value="sonstiges">Sonstiges</option>
</select>
</td>
<td><input type="text" class="input input-sm" id="fbSetupNotiz" placeholder="z.B. Fr√§skanten f√ºr Parallelspanner"></td>
</tr>
<tr style="background: var(--color-primary); color: white;">
<td colspan="2">GESAMT</td>
<td class="mono right">55 min</td>
<td class="mono right" id="fbGesamtIst">‚Äî min</td>
<td class="mono right" id="fbGesamtDelta">‚Äî</td>
<td colspan="2"></td>
</tr>
</tfoot>
</table>
 
<!-- Visuelle Zusammenfassung -->
<div class="grid-3" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryDelta">‚Äî</div>
<div style="font-size:11px;color:var(--color-text-muted);">Zeitabweichung gesamt</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryCost">‚Äî</div>
<div style="font-size:11px;color:var(--color-text-muted);">Kostenabweichung</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryOps">0 / 4</div>
<div style="font-size:11px;color:var(--color-text-muted);">OPs erfasst</div>
</div>
</div>
</div>

<div class="grid-2" style="gap: var(--space-5);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-3);">Fertigungsergebnis</div>
<div style="display: flex; flex-direction: column; gap: var(--space-2);">
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="io_erst" checked>i.O. ‚Äî Erstfertigung
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="io_korrektur">i.O. ‚Äî nach Korrektur
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="nacharbeit">Nacharbeit erforderlich
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="ausschuss">Ausschuss
</label>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-3);">Korrekturvorschlag</div>
<textarea class="input" id="fbEmpfehlung" rows="4" placeholder="Was beim n√§chsten Mal anders machen? z.B. Vorschub -20% bei h5, Messzeit einplanen"></textarea>
</div>
</div>
</div>
</div>
 
<div style="display: flex; gap: var(--space-3);">
<button class="btn btn-primary" onclick="saveFeedback()">Nachkalkulation speichern</button>
<button class="btn btn-secondary" onclick="clearFeedbackForm()">Formular leeren</button>
</div>
</div>
 
<!-- TAB: Cross-Learnings -->
<div id="feedback-learnings" style="display: none;">
 
<!-- Kalkulations-Genauigkeit -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Kalkulationsgenauigkeit</span></div>
<div class="card-body">
<div class="grid-3" style="gap: var(--space-5); text-align: center;">
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-warning);" id="avgDeviation">+18%</div>
<div style="font-size: 12px; color: var(--color-text-muted);">√ò Abweichung</div>
<div style="font-size: 11px; color: var(--color-text-muted);">(Richtwert)</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-primary);" id="feedbackCount">12</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Feedbacks</div>
<div style="font-size: 11px; color: var(--color-text-muted);">erfasst</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-success);" id="patternsFound">3</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Muster</div>
<div style="font-size: 11px; color: var(--color-text-muted);">erkannt</div>
</div>
</div>
 
<div style="margin-top: var(--space-5);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-2);">H√§ufigste Zeitfresser</div>
<div style="display: flex; flex-direction: column; gap: var(--space-2);">
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Einrichtung</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 72%; height: 100%; background: var(--color-error);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-error);">+18%</span>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Toleranz</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 60%; height: 100%; background: var(--color-warning);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-warning);">+15%</span>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Bearbeitung</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 12%; height: 100%; background: var(--color-success);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-success);">+3%</span>
</div>
</div>
</div>
</div>
</div>
 
<!-- Erkannte Muster -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Erkannte Abweichungsmuster</span></div>
<div class="card-body" style="padding: 0;">
<div id="patternsContainer">
 
<!-- Muster 1 -->
<div style="padding: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Einrichtzeit bei Parallelspanner</div>
<div style="font-size: 12px; color: var(--color-text-muted);">H√§ufigkeit: 8/12 Auftr√§ge (67%) ‚Ä¢ √ò Mehraufwand: +12 min</div>
</div>
<span style="background: var(--color-error-light); color: var(--color-error); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">HOCH</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">Fr√§skanten f√ºr Parallelspanner fehlen in der Kalkulation. Werker m√ºssen zus√§tzlich Fl√§chen anfr√§sen.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Setup-Zeit +15 min bei Spannart "Parallelspanner"</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('setup_parallel', 15)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('setup_parallel')">Ignorieren</button>
</div>
</div>
 
<!-- Muster 2 -->
<div style="padding: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Toleranz h5/H7 untersch√§tzt</div>
<div style="font-size: 12px; color: var(--color-text-muted);">H√§ufigkeit: 5/7 Passungen (71%) ‚Ä¢ √ò Mehraufwand: +4 min pro Passung</div>
</div>
<span style="background: var(--color-warning-light); color: var(--color-warning); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">MITTEL</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">Messzeit und reduzierter Vorschub bei engen Toleranzen nicht ausreichend einkalkuliert.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Toleranz-Faktor 1.3√ó f√ºr h5/H7</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('tolerance_factor', 1.3)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('tolerance_factor')">Ignorieren</button>
</div>
</div>
 
<!-- Muster 3 -->
<div style="padding: var(--space-4);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Material S235: Rohteil-√úberma√ü</div>
<div style="font-size: 12px; color: var(--color-text-muted);">H√§ufigkeit: 4/10 Auftr√§ge (40%) ‚Ä¢ √ò Mehraufwand: +3 min</div>
</div>
<span style="background: var(--color-info-light); color: var(--color-info); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">NIEDRIG</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">S235 Rohteile haben oft 0.3-0.5mm √úberma√ü. Zus√§tzlicher Planfr√§s-Durchgang n√∂tig.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Rohteil-Aufma√ü auf 1.0mm bei S235</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('s235_aufmass', 1.0)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('s235_aufmass')">Ignorieren</button>
</div>
</div>
 
</div>
</div>
</div>
 
<!-- Empfehlungen aus Feedback -->
<div class="card">
<div class="card-header"><span>Korrekturvorschl√§ge</span></div>
<div class="card-body" style="padding: 0;">
<div id="recommendationsContainer">
<div style="padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-light); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"Bei Parallelspanner Fr√§skanten einplanen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">3√ó gemeldet ‚Ä¢ Zuletzt: 05.02.2026</div>
</div>
</div>
<div style="padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-light); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"h5-Toleranz: Vorschub -20%, Messzeit einplanen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">2√ó gemeldet ‚Ä¢ Zuletzt: 04.02.2026</div>
</div>
</div>
<div style="padding: var(--space-3) var(--space-4); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"S235 Rohteil oft mit √úberma√ü ‚Äî erst planfr√§sen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">1√ó gemeldet ‚Ä¢ Zuletzt: 03.02.2026</div>
</div>
</div>
</div>
</div>
</div>
 
</div>
 
<!-- TAB: Historie -->
<div id="feedback-historie">
<div class="card">
<div class="card-header">
<span>Nachkalkulationen</span>
<div>
<button class="btn btn-sm btn-secondary" onclick="exportFeedbackCSV()">CSV Export</button>
</div>
</div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Datum</th>
<th>Projekt</th>
<th>Erfasser</th>
<th class="right">Kalk.</th>
<th class="right">Ist</th>
<th class="right">Delta</th>
<th>Hauptgrund</th>
<th>Ergebnis</th>
</tr>
</thead>
<tbody id="feedbackHistoryTable">
<tr>
<td class="mono">05.02.2026</td>
<td class="mono">2500473.01</td>
<td>M. Schmidt</td>
<td class="mono right">42 min</td>
<td class="mono right">48 min</td>
<td class="mono right" style="color: var(--color-error);">+14%</td>
<td>Einrichtung</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">04.02.2026</td>
<td class="mono">2500112.03</td>
<td>K. Weber</td>
<td class="mono right">28 min</td>
<td class="mono right">26 min</td>
<td class="mono right" style="color: var(--color-success);">-7%</td>
<td>‚Äî</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">03.02.2026</td>
<td class="mono">2500098.01</td>
<td>M. Schmidt</td>
<td class="mono right">35 min</td>
<td class="mono right">43 min</td>
<td class="mono right" style="color: var(--color-error);">+23%</td>
<td>Toleranz</td>
<td>Nacharbeit</td>
</tr>
<tr>
<td class="mono">02.02.2026</td>
<td class="mono">2500087.02</td>
<td>T. M√ºller</td>
<td class="mono right">52 min</td>
<td class="mono right">55 min</td>
<td class="mono right" style="color: var(--color-warning);">+6%</td>
<td>Material</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">01.02.2026</td>
<td class="mono">2500076.01</td>
<td>K. Weber</td>
<td class="mono right">18 min</td>
<td class="mono right">17 min</td>
<td class="mono right" style="color: var(--color-success);">-6%</td>
<td>‚Äî</td>
<td>i.O.</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Stand:</strong> 12 Nachkalkulationen ‚Ä¢ √ò Abweichung Soll/Ist: +18 % ‚Ä¢ 
<span style="color: var(--color-success);">83% i.O.</span>‚Ä¢ 
<span style="color: var(--color-warning);">17% Nacharbeit</span>
</div>
</div>
 
</div>
 
<!-- ========================================
 SECTION: EINSTELLUNGEN
 ======================================== -->
<div class="section" id="section-settings">
<!-- TAB: Firmendaten -->
<div id="settings-firma">
<div class="card">
<div class="card-header"><span>Firmendaten</span></div>
<div class="card-body">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group">
<label class="form-label">Firmenname</label>
<input type="text" class="input" value="Muster CNC GmbH" id="firmaName">
</div>
<div class="form-group">
<label class="form-label">Ansprechpartner</label>
<input type="text" class="input" value="Max Mustermann" id="firmaAnsprech">
</div>
<div class="form-group">
<label class="form-label">Bearbeiter / K√ºrzel</label>
<input type="text" class="input" value="" id="firmaBearbeiter" placeholder="z.B. MS, KW">
</div>
<div class="form-group">
<label class="form-label">Abteilung</label>
<input type="text" class="input" value="" id="firmaAbteilung" placeholder="z.B. Arbeitsvorbereitung">
</div>
<div class="form-group">
<label class="form-label">Stra√üe</label>
<input type="text" class="input" value="Industriestra√üe 42" id="firmaStrasse">
</div>
<div class="form-group">
<label class="form-label">PLZ / Ort</label>
<input type="text" class="input" value="01234 Musterstadt" id="firmaOrt">
</div>
<div class="form-group">
<label class="form-label">Telefon</label>
<input type="text" class="input" value="+49 123 456789" id="firmaTel">
</div>
<div class="form-group">
<label class="form-label">E-Mail</label>
<input type="email" class="input" value="info@muster-cnc.de" id="firmaEmail">
</div>
<div class="form-group">
<label class="form-label">Steuernummer</label>
<input type="text" class="input" value="DE123456789" id="firmaSteuer">
</div>
<div class="form-group">
<label class="form-label">Bankverbindung</label>
<input type="text" class="input" value="DE89 3704 0044 0532 0130 00" id="firmaIBAN">
</div>
</div>
</div>
</div>
 
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Angebots- und Dokumenteneinstellungen</span></div>
<div class="card-body">
<div class="grid-3" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">G√ºltigkeit (Tage)</label>
<input type="number" class="input input-mono" value="30" id="angebotsGueltigkeit">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Standard-Lieferzeit</label>
<input type="text" class="input" value="3-4 Wochen" id="standardLieferzeit">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Zahlungsziel (Tage)</label>
<input type="number" class="input input-mono" value="14" id="zahlungsziel">
</div>
</div>
</div>
</div>
</div>
 
<!-- Firmenlogo -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Firmenlogo</span></div>
<div class="card-body">
<div style="display:flex;align-items:center;gap:var(--space-4);">
<div id="logoPreview" style="width:120px;height:60px;border:1px dashed var(--color-border);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--color-text-muted);overflow:hidden;">
Kein Logo
</div>
<div>
<input type="file" id="logoUpload" accept="image/*" style="display:none;" onchange="previewLogo(this)">
<button class="btn btn-secondary btn-sm" onclick="document.getElementById('logoUpload').click()">Logo hochladen</button>
<div style="font-size:11px;color:var(--color-text-muted);margin-top:4px;">PNG oder JPG, max. 200√ó100 px empfohlen</div>
</div>
</div>
</div>
</div>

<!-- Sprache & Darstellung -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Darstellung</span></div>
<div class="card-body">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Sprache</label>
<select class="select" id="settingLanguage">
<option value="de" selected>Deutsch</option>
<option value="en" disabled>English (in Vorbereitung)</option>
</select>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">W√§hrung</label>
<select class="select" id="settingCurrency">
<option value="EUR" selected>EUR</option>
<option value="CHF">CHF</option>
<option value="USD" disabled>USD (in Vorbereitung)</option>
</select>
</div>
</div>
</div>
</div>

<!-- Buttons -->
<div style="margin-top: var(--space-5); display: flex; gap: var(--space-3); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
<button class="btn btn-primary" onclick="saveSettings()">Einstellungen speichern</button>
<button class="btn btn-secondary" onclick="resetSettings()">Zur√ºcksetzen</button>
<button class="btn btn-secondary" style="margin-left: auto;" onclick="exportSettings()">Export JSON</button>
<button class="btn btn-secondary" onclick="importSettings()">Import</button>
</div>
 
<p style="margin-top: var(--space-4); font-size: 12px; color: var(--color-text-muted);">
 Einstellungen werden lokal im Browser gespeichert (localStorage). Export erstellt eine JSON-Datei f√ºr Backup oder √úbertragung auf andere Ger√§te.
</p>

<!-- Nutzerdokumentation -->
<div class="card" style="margin-top: var(--space-6);">
<div class="card-header" style="cursor:pointer;" onclick="document.getElementById('userDocContent').style.display = document.getElementById('userDocContent').style.display === 'none' ? 'block' : 'none'">
<span>Nutzerdokumentation</span>
<span style="float:right; font-size: 12px; color: var(--color-text-muted);">‚ñº Auf-/Zuklappen</span>
</div>
<div class="card-body" id="userDocContent" style="display:none; font-size: 13px; line-height: 1.7; max-height: 70vh; overflow-y: auto;">

<div style="font-weight: 700; font-size: 16px; margin-bottom: var(--space-4); padding-bottom: var(--space-3); border-bottom: 2px solid var(--color-border);">CNC Planner Pro ‚Äî Nutzerdokumentation</div>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">1. √úberblick</div>
<p>CNC Planner Pro ist ein Vorkalkulations-Werkzeug f√ºr CNC-Lohnfertiger. Es ersetzt den Taschenrechner und die Excel-Tabelle ‚Äî nicht das ERP-System.</p>
<p><strong>Was das Tool macht:</strong> Automatische Zeitermittlung, Zuschlagskalkulation, Fertigungsanweisung, Angebotsvorlage, NC-Code-Entwurf.</p>
<p><strong>Was das Tool NICHT macht:</strong> Kein ERP-Ersatz, keine verbindlichen Preise ohne Kalibrierung, kein produktionsfertiger NC-Code.</p>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">2. Schnellstart</div>
<ol style="padding-left: var(--space-5); color: var(--color-text-secondary);">
<li><strong>Einstellungen ‚Üí Preise &amp; S√§tze anpassen:</strong> Ihre Stundens√§tze, Materialpreise, Zuschlagss√§tze</li>
<li><strong>Firmendaten eintragen</strong> (f√ºr Angebotsvorlage)</li>
<li><strong>Bauteil w√§hlen oder Abmessungen eingeben</strong></li>
<li><strong>‚ÄûBerechnen + Kalkulation anzeigen" klicken</strong></li>
</ol>
<div class="info-box" style="margin: var(--space-3) 0;">Die voreingestellten Werte basieren auf Erfahrungswerten eines s√§chsischen Lohnfertigers. Ohne Anpassung an Ihren Betrieb sind die Ergebnisse nur Richtwerte.</div>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">3. Kalkulationsschema</div>
<p>Differenzierende Zuschlagskalkulation (Industriestandard):</p>
<div style="font-family: var(--font-mono); font-size: 12px; background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-sm); margin-bottom: var(--space-3); border: 1px solid var(--color-border-light);">
MEK (Material) + MGK% ‚Üí Materialkosten<br>
FEK (Fertigung) + AV% ‚Üí Fertigungskosten<br>
= HERSTELLKOSTEN<br>
+ VwGK% + VtGK% = SELBSTKOSTEN<br>
+ Gewinn% = <strong>ANGEBOTSPREIS</strong>
</div>

<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Zuschlag</th><th class="right">Voreinstellung</th><th>Bezugsgr√∂√üe</th><th class="right">Typisch</th></tr></thead>
<tbody>
<tr><td>MGK</td><td class="right mono">5 %</td><td>Materialeinzelkosten</td><td class="right">3‚Äì15 %</td></tr>
<tr><td>AV</td><td class="right mono">12 %</td><td>Fertigungseinzelkosten</td><td class="right">8‚Äì15 %</td></tr>
<tr><td>VwGK</td><td class="right mono">10 %</td><td>Herstellkosten</td><td class="right">8‚Äì15 %</td></tr>
<tr><td>VtGK</td><td class="right mono">5 %</td><td>Herstellkosten</td><td class="right">3‚Äì8 %</td></tr>
<tr><td>Gewinn</td><td class="right mono">8 %</td><td>Selbstkosten</td><td class="right">5‚Äì15 %</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">4. Stundens√§tze</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Arbeitsgang</th><th class="right">Lohn</th><th class="right">Maschine</th><th class="right">Gesamt</th></tr></thead>
<tbody>
<tr><td>CNC-Fr√§sen</td><td class="right mono">38 EUR/h</td><td class="right mono">32 EUR/h</td><td class="right mono"><strong>70 EUR/h</strong></td></tr>
<tr><td>S√§gen</td><td class="right mono">35 EUR/h</td><td class="right mono">10 EUR/h</td><td class="right mono"><strong>45 EUR/h</strong></td></tr>
<tr><td>Entgraten</td><td class="right mono">28 EUR/h</td><td class="right mono">3 EUR/h</td><td class="right mono"><strong>31 EUR/h</strong></td></tr>
</tbody>
</table>
<p style="color: var(--color-text-muted); font-size: 12px;">Werkzeugkosten sind im Maschinenstundensatz enthalten.</p>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">5. Werkstoffdatenbank</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Werkstoff</th><th>Bezeichnung</th><th class="right">Dichte</th><th class="right">Preis/kg</th><th class="right">Zeitfaktor</th></tr></thead>
<tbody>
<tr><td>S235JR</td><td>Baustahl</td><td class="right mono">7,85</td><td class="right mono">1,40</td><td class="right mono">1,00</td></tr>
<tr><td>S355J2</td><td>Feinkornbaustahl</td><td class="right mono">7,85</td><td class="right mono">1,65</td><td class="right mono">1,02</td></tr>
<tr><td>C45</td><td>Verg√ºtungsstahl</td><td class="right mono">7,85</td><td class="right mono">1,80</td><td class="right mono">1,10</td></tr>
<tr><td>1.4301</td><td>V2A</td><td class="right mono">7,90</td><td class="right mono">4,80</td><td class="right mono">1,25</td></tr>
<tr><td>1.4404</td><td>V4A</td><td class="right mono">7,95</td><td class="right mono">5,50</td><td class="right mono">1,30</td></tr>
<tr><td>1.4571</td><td>Edelstahl</td><td class="right mono">8,00</td><td class="right mono">5,20</td><td class="right mono">1,35</td></tr>
<tr><td>AlMg3</td><td>Aluminium</td><td class="right mono">2,66</td><td class="right mono">4,50</td><td class="right mono">0,70</td></tr>
<tr><td>AlMgSi1</td><td>Aluminium</td><td class="right mono">2,70</td><td class="right mono">4,80</td><td class="right mono">0,72</td></tr>
<tr><td>Al7075</td><td>Alu hochfest</td><td class="right mono">2,81</td><td class="right mono">8,50</td><td class="right mono">0,85</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">6. Bereiche im √úberblick</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Bereich</th><th>Funktion</th><th>Export</th></tr></thead>
<tbody>
<tr><td><strong>Kalkulation</strong></td><td>Zuschlagskalkulation, Kosten√ºbersicht, DB-Rechnung, Staffelpreise</td><td>PDF</td></tr>
<tr><td><strong>Fertigungsanweisung</strong></td><td>Operationsplan, Schnittdaten, Pr√ºfmerkmale. OPs an-/abw√§hlbar.</td><td>PDF, CSV</td></tr>
<tr><td><strong>Angebot</strong></td><td>Professionelle Angebotsvorlage mit Firmenkopf</td><td>PDF</td></tr>
<tr><td><strong>Werkzeuge</strong></td><td>Schnittparameter, Werkzeugeinsatz, Standzeiten</td><td>PDF</td></tr>
<tr><td><strong>NC-Code</strong></td><td>Entwurf f√ºr Heidenhain, Siemens, Fanuc</td><td>Kopieren</td></tr>
<tr><td><strong>Nachkalkulation</strong></td><td>Soll-Ist-Vergleich, Historie, Erkenntnisse, Dashboard</td><td>CSV</td></tr>
<tr><td><strong>Einstellungen</strong></td><td>Stundens√§tze, Materialpreise, Zuschl√§ge, Firmendaten</td><td>JSON</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">7. Normen &amp; Standards</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Norm</th><th>Anwendung</th></tr></thead>
<tbody>
<tr><td>REFA</td><td>Zeitgliederung (Haupt-, Neben-, R√ºstzeit)</td></tr>
<tr><td>VDI 3321</td><td>Schnittdatenrichtwerte</td></tr>
<tr><td>DIN 8580</td><td>Fertigungsverfahren</td></tr>
<tr><td>DIN EN 10027</td><td>Werkstoffbezeichnungen</td></tr>
<tr><td>DIN ISO 2768-mK</td><td>Allgemeintoleranzen</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">8. Datenschutz</div>
<p>Alle Daten verbleiben lokal im Browser. Es werden keine Daten an externe Server √ºbertragen. Einstellungen werden im lokalen Browserspeicher (localStorage) gespeichert.</p>

</div>
</div>

<!-- Kurzreferenz -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Kurzreferenz</span></div>
<div class="card-body" style="font-size: 13px; line-height: 1.7;">
<div style="font-weight: 600; margin-bottom: var(--space-3);">Workflow</div>
<ol style="padding-left: var(--space-5); margin-bottom: var(--space-4); color: var(--color-text-secondary);">
<li><strong>Teil ausw√§hlen</strong> ‚Äî Bauteil aus Bibliothek oder manuell anlegen</li>
<li><strong>Werkst√ºck konfigurieren</strong> ‚Äî Material, Rohma√üe, St√ºckzahl, Aufspannungen</li>
<li><strong>Berechnen</strong> ‚Äî Vorkalkulation auf Basis der hinterlegten Parameter</li>
<li><strong>Ergebnis pr√ºfen</strong> ‚Äî Kostenaufschl√ºsselung, Deckungsbeitragsrechnung</li>
<li><strong>Fertigungsanweisung</strong> ‚Äî Operationsplan mit Schnittdaten und Skizzen</li>
<li><strong>Angebot erstellen</strong> ‚Äî Automatisch aus Kalkulation generiert</li>
<li><strong>NC-Code</strong> ‚Äî Maschinencode f√ºr Heidenhain, Siemens oder Fanuc</li>
<li><strong>Nachkalkulation</strong> ‚Äî Ist-Zeiten erfassen, Abweichungen analysieren</li>
</ol>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Kalkulationsmethodik</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
Die Vorkalkulation basiert auf der differenzierenden Zuschlagskalkulation nach industriellem Standard.
Zeitermittlung erfolgt formelbasiert nach REFA-Methodik, Schnittdaten nach VDI 3321.
Zuschlagss√§tze (MGK, AV, VwGK, VtGK, Gewinn) sind betriebsspezifisch unter "Preise &amp; S√§tze" anpassbar.
Die Ergebnisse sind formelbasierte Richtwerte. Ein Abgleich mit der betrieblichen Nachkalkulation wird empfohlen.
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Tastenkombinationen</div>
<table class="table" style="margin-bottom: var(--space-4);">
<tbody>
<tr><td style="width: 180px;"><kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">Strg</kbd> + <kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">P</kbd></td><td style="color:var(--color-text-secondary);">PDF-Druck</td></tr>
<tr><td><kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">Strg</kbd> + <kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">S</kbd></td><td style="color:var(--color-text-secondary);">Einstellungen speichern</td></tr>
</tbody>
</table>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Datenformat</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-5);">
Alle Kalkulationsdaten werden lokal im Browser verarbeitet. Es werden keine Daten an externe Server √ºbertragen.
Exportformate: CSV (Nachkalkulation), JSON (Einstellungen), PDF (Angebot/Fertigungsanweisung).
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Bekannte Einschr√§nkungen</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-5); line-height: 1.7;">
<table class="table" style="font-size: 13px;">
<thead>
<tr><th style="width:30%;">Bereich</th><th>Einschr√§nkung</th></tr>
</thead>
<tbody>
<tr><td><strong>Geometrie-Erkennung</strong></td><td>Keine CAD-Analyse. Operationsplan wird aus Abmessungen und Werkstoff abgeleitet ‚Äî nicht aus der tats√§chlichen Bauteilgeometrie. Fehlende oder √ºberfl√ºssige Arbeitsg√§nge sind m√∂glich.</td></tr>
<tr><td><strong>Aufspannungen</strong></td><td>Vereinfachte Darstellung (1‚Äì2 Aufspannungen). Bei mehrseitiger Bearbeitung, Hinterschnitten oder komplexen Spannlagen sind zus√§tzliche Umspannungen n√∂tig, die manuell erg√§nzt werden m√ºssen.</td></tr>
<tr><td><strong>R√ºstzeiten</strong></td><td>Pauschale Sch√§tzung. Tats√§chliche R√ºstzeiten h√§ngen stark von Vorrichtungen, Spannmitteln, Erfahrung des Einrichters und Maschinenzustand ab.</td></tr>
<tr><td><strong>Sonderprozesse</strong></td><td>Nicht abgedeckt: W√§rmebehandlung, Oberfl√§chenbeschichtung, Schleifen (au√üer als vereinfachte OP), Erodieren, Montage, externe Bearbeitung.</td></tr>
<tr><td><strong>Bearbeitungszeiten</strong></td><td>Richtwerte nach VDI 3321. Abweichungen von ¬±30 % zur Realit√§t sind ohne betriebsspezifische Kalibrierung m√∂glich ‚Äî insbesondere bei engen Toleranzen und schwerzerspanbaren Werkstoffen.</td></tr>
<tr><td><strong>NC-Code</strong></td><td>Entwurf, kein Produktionscode. Simulation vor erstem Einsatz zwingend erforderlich.</td></tr>
<tr><td><strong>Bauteilkomplexit√§t</strong></td><td>Optimiert f√ºr prismatische Fr√§steile (Platten, Bl√∂cke, einfache 3D-Konturen). Nicht ausgelegt f√ºr Freiformfl√§chen, 5-Achs-Simultanbearbeitung oder Drehteile.</td></tr>
</tbody>
</table>
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">H√§ufige Fragen (FAQ)</div>
<div style="font-size:13px;color:var(--color-text-secondary);line-height:1.7;">

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich eigene Werkzeuge eintragen?</div>
Derzeit nicht. Die Werkzeugliste wird automatisch aus dem Operationsplan abgeleitet. Eigene Werkzeugdatenbanken (T-Nummern, Geometrien, Standzeiten) sind f√ºr eine zuk√ºnftige Version geplant.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Was passiert, wenn eine Operation fehlt?</div>
Der Operationsplan wird auf Basis der Bauteilgeometrie und Toleranzen erstellt. Prozesse au√üerhalb der spanenden Bearbeitung (W√§rmebehandlung, Beschichtung, Oberfl√§chenveredelung, Montage) werden nicht erfasst und m√ºssen separat kalkuliert werden. √úber die Nachkalkulation k√∂nnen Sie Abweichungen dokumentieren und bei zuk√ºnftigen Auftr√§gen manuell ber√ºcksichtigen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Wie verl√§sslich ist die Vorkalkulation?</div>
Die Kalkulation basiert auf Schnittdatenrichtwerten (VDI 3321), REFA-Zeitbausteinen und hinterlegten Maschinenstundens√§tzen. Die Ergebnisse sind eine qualifizierte Sch√§tzung ‚Äî nicht gleichzusetzen mit einer Nachkalkulation auf Basis realer Fertigungsdaten. Die Hauptunsicherheiten liegen bei R√ºstzeiten (stark auftrags- und mitarbeiterabh√§ngig), engen Toleranzen und schwerzerspanbaren Werkstoffen. Je mehr Nachkalkulationen erfasst werden, desto besser k√∂nnen Sie die hinterlegten Werte an Ihren Betrieb anpassen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich die Zuschlagss√§tze √§ndern?</div>
Ja. Unter Konfiguration ‚Üí Preise &amp; S√§tze ‚Üí Tab "Zuschl√§ge". Die hinterlegten Werte (MGK, AV, VwGK, VtGK, Gewinn) sind branchen√ºbliche Richtwerte und sollten an Ihre betriebliche Kostenrechnung angepasst werden.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich Materialpreise aktualisieren?</div>
Ja. Unter Konfiguration ‚Üí Preise &amp; S√§tze ‚Üí Tab "Materialpreise". Die voreingestellten Preise dienen als Orientierung. Empfehlung: Mit aktuellen Einkaufspreisen Ihres Stahlhandels abgleichen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Ist der NC-Code direkt an der Maschine verwendbar?</div>
Nein. Der generierte NC-Code ist ein Entwurf, der als Ausgangsbasis dient. Vor dem Einsatz m√ºssen Werkzeugdaten, Nullpunkt, Sicherheitsebene und Verfahrwege gepr√ºft und an die jeweilige Maschine angepasst werden. Eine Simulation vor dem ersten Durchlauf ist zwingend erforderlich.
</div>

<div>
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Wo werden meine Daten gespeichert?</div>
Alle Daten verbleiben lokal in Ihrem Browser (localStorage). Es werden keine Daten an Server √ºbertragen. √úber "Export JSON" in den Einstellungen k√∂nnen Sie Ihre Konfiguration sichern.
</div>

</div>
</div>
</div>

<!-- App-Info -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Systeminformationen</span></div>
<div class="card-body" style="padding: 0;">
<table class="table">
<tbody>
<tr>
<td style="width:200px; color: var(--color-text-muted);">Anwendung</td>
<td>CNC Planner Pro</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Version</td>
<td class="mono">v0.18.0-beta</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Build</td>
<td class="mono">2026-02-06</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Referenzmaschine</td>
<td>Hermle C 400 (3-Achs-BAZ)</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Steuerungen</td>
<td>Heidenhain TNC 640, Siemens 840D, Fanuc 0i-MF</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Normen</td>
<td>REFA, VDI 3321, DIN 8580, DIN EN 10027</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Datenspeicherung</td>
<td>Lokal (localStorage), keine Cloud-Anbindung</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Lizenz</td>
<td>Propriet√§r ‚Äî Alle Rechte vorbehalten</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

</div>
</main>

<!-- Sticky Feedback Button -->
<button class="feedback-fab" style="bottom: 70px; background: var(--color-success); font-size: 14px;" onclick="askWorkerFeedbackGeneric()" title="Werker fragen">üì±</button>
<button class="feedback-fab" id="feedbackFab" onclick="toggleFeedbackPanel()">?</button>

<!-- Feedback Flyout -->
<div class="feedback-panel" id="feedbackPanel">
<div class="feedback-panel-header">
<span style="font-weight:600;">Feedback</span>
<button onclick="toggleFeedbackPanel()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--color-text-muted);padding:0;line-height:1;">&times;</button>
</div>
<div class="feedback-panel-body">
<div style="font-size:12px;color:var(--color-text-muted);margin-bottom:8px;">Seite: <span id="fbCurrentPage" style="font-weight:500;color:var(--color-text);">Teil</span></div>
<div style="display:flex;gap:6px;margin-bottom:10px;">
<button class="fb-type-btn" data-type="bug" onclick="selectFbType(this)">Fehler</button>
<button class="fb-type-btn" data-type="idea" onclick="selectFbType(this)">Verbesserung</button>
<button class="fb-type-btn" data-type="question" onclick="selectFbType(this)">Frage</button>
</div>
<textarea id="fbQuickText" class="input" rows="3" placeholder="Was ist aufgefallen?" style="font-size:13px;resize:vertical;"></textarea>
<button class="btn btn-primary btn-sm" onclick="sendQuickFeedback()" style="width:100%;margin-top:8px;">Absenden</button>
</div>
<div class="feedback-panel-success" id="fbSuccess" style="display:none;">
<div style="font-size:24px;margin-bottom:4px;">&#10003;</div>
<div style="font-size:13px;font-weight:500;">Danke f√ºr das Feedback</div>
<div style="font-size:12px;color:var(--color-text-muted);">Wird in der Nachkalkulation gespeichert.</div>
</div>
</div>
</div>
 
<!-- ================================================================
 JAVASCRIPT
 ================================================================ -->
<script>
 // ================================================================
 // DATA
 // ================================================================
 
 const MATERIALS = {
 // Edelstahl (Einkaufspreise Halbzeug, nicht Stahlhandel-Liste)
 '1.4301': { name: '1.4301 (V2A)', price: 4.80, density: 7.90, timeFactor: 1.25 },
 '1.4404': { name: '1.4404 (V4A)', price: 5.50, density: 7.95, timeFactor: 1.30 },
 '1.4571': { name: '1.4571', price: 5.20, density: 8.00, timeFactor: 1.35 },
 // Baustahl
 'S235JR': { name: 'S235JR', price: 1.40, density: 7.85, timeFactor: 1.00 },
 'S355J2': { name: 'S355J2', price: 3.00, density: 7.85, timeFactor: 1.02 },
 'C45': { name: 'C45', price: 1.80, density: 7.85, timeFactor: 1.05 },
 // Verg√ºtungsstahl
 '42CrMo4': { name: '42CrMo4', price: 2.20, density: 7.85, timeFactor: 1.15 },
 '34CrNiMo6': { name: '34CrNiMo6', price: 3.00, density: 7.85, timeFactor: 1.20 },
 // Aluminium
 'AlMg3': { name: 'AlMg3', price: 4.50, density: 2.66, timeFactor: 0.65 },
 'AlMgSi1': { name: 'AlMgSi1', price: 4.80, density: 2.70, timeFactor: 0.68 },
 'Al7075': { name: 'Al7075-T6', price: 8.50, density: 2.81, timeFactor: 0.75 },
 // Buntmetalle
 'CuZn39Pb3': { name: 'Messing', price: 7.00, density: 8.47, timeFactor: 0.70 },
 'CuSn8': { name: 'Bronze', price: 12.00, density: 8.80, timeFactor: 0.75 },
 // Kunststoff
 'POM': { name: 'POM', price: 3.50, density: 1.41, timeFactor: 0.45 },
 'PA6': { name: 'PA6 (Nylon)', price: 4.00, density: 1.14, timeFactor: 0.50 },
 'PEEK': { name: 'PEEK', price: 75.00, density: 1.32, timeFactor: 0.55 },
 // Guss
 'GJS-700': { name: 'GJS-700-2 (Sph√§roguss)', price: 3.80, density: 7.10, timeFactor: 1.18 },
 'GJS-400': { name: 'GJS-400-15 (Sph√§roguss)', price: 3.20, density: 7.10, timeFactor: 1.05 },
 'GJL-250': { name: 'GJL-250 (Grauguss)', price: 2.50, density: 7.20, timeFactor: 0.90 }
 };
 
 const CLAMPING = {
 'schraubstock': { time: 15, desc: 'Teil in Maschinenschraubstock spannen, Parallelit√§t pr√ºfen, Nullpunkt antasten.' },
 'schraubstock2': { time: 25, desc: 'Zwei Schraubst√∂cke f√ºr Langteile. Beide auf gleiche H√∂he ausrichten.' },
 'tischspannung': { time: 35, desc: 'Tischspannung mit Pratzen. F√ºr gro√üe oder unregelm√§√üige Werkst√ºcke.' },
 'nullpunkt': { time: 5, desc: 'Nullpunktspannsystem. Schnellstes Wechseln, h√∂chste Wiederholgenauigkeit.' },
 'spezial': { time: 45, desc: 'Sondervorrichtung. Aufw√§ndiger Aufbau, f√ºr Serienteile rentabel.' }
 };
 
 const PROJECTS = {
 verbindungsplatte: {
 id: 'verbindungsplatte',
 name: 'Verbindungsplatte',
 partNumber: '2500473.01.11.02.00.001',
 material: 'S235JR',
 dims: { x: 440, y: 50, z: 20 },
 baseTime: 12.5,
 unitPrice: 28.40,
 thumbnail: 'demo-parts/2500473.01.11.02.00.001.pdf.png'
 },
 adapterplatte: {
 id: 'adapterplatte',
 name: 'Adapterplatte',
 partNumber: '2500473.01.01.02.01.001',
 material: 'AlMg3',
 dims: { x: 85, y: 70, z: 55 },
 baseTime: 24.8,
 unitPrice: 52.15,
 thumbnail: 'demo-parts/2500473.01.01.02.01.001.pdf.png'
 },
 block: {
 id: 'block',
 name: 'Block',
 partNumber: '2500473.01.01.01.01.001',
 material: 'AlMg3',
 dims: { x: 120, y: 105, z: 40 },
 baseTime: 35.2,
 unitPrice: 89.50,
 thumbnail: 'demo-parts/2500473.01.01.01.01.001.pdf.png'
 },
 lagerungstraverse: {
 id: 'lagerungstraverse',
 name: 'Lagerungstraverse',
 partNumber: '10028104.79',
 material: 'S355J2',
 dims: { x: 2095, y: 500, z: 190 },
 baseTime: 475,
 unitPrice: 19730,
 quantity: 4,
 thumbnail: '',
 source: 'Anfrage 6000063225 ‚Äî KBA Koenig & Bauer',
 clampings: [
 { type: 'tischspannung', time: 50, desc: 'Unterseite ‚Äî Pratzen auf Maschinentisch, WZ einwechseln, Nullpunkt' },
 { type: 'tischspannung', time: 38, desc: 'Oberseite ‚Äî Wenden, Planfr√§sen, Taschen, Langl√∂cher' },
 { type: 'tischspannung', time: 39, desc: 'Stirnseite 1 ‚Äî Kontrollma√ü 1508¬±0.1' },
 { type: 'tischspannung', time: 37, desc: 'Stirnseite 2 ‚Äî Kontrollma√ü 1400¬±0.1, Gesamtl√§nge 2095' }
 ],
 operations: [
 { nr: 10, name: 'S√§gen & Vorbereitung', tool: 'Bands√§ge', time: 28, rate: 'saegen',
 detail: 'Rohteil abl√§ngen 2150mm, Schnittkanten grob entgraten. Rohgewicht ~1.856kg.' },
 { nr: 20, name: 'Planfr√§sen Unterseite', tool: 'T1 √ò80 Planfr√§ser', time: 55, rate: 'cnc',
 params: 'n 600 ¬∑ vf 750 ¬∑ ap 2,0',
 detail: 'Referenzfl√§che 2095√ó500mm herstellen. ae=64mm (80% √ò80), 8 Bahnen, 2mm Zustellung. Schlichtzugabe 0,2mm.' },
 { nr: 30, name: 'Bohrungen Unterseite', tool: 'T2 √ò16 VHM + T3 √ò10 VHM', time: 44, rate: 'cnc',
 params: '8√ó √ò16 H7 + 4√ó √ò10 H7',
 detail: '8√ó √ò16 H7 (Befestigung, t=190mm): Zentrierung + Bohren + Senken = 4min/Bohrung. 4√ó √ò10 H7 (Messreferenz): 3min/Bohrung.' },
 { nr: 40, name: 'Planfr√§sen Oberseite', tool: 'T1 √ò80 Planfr√§ser', time: 52, rate: 'cnc',
 params: 'n 600 ¬∑ vf 750 ¬∑ ap 2,0',
 detail: 'Parallelfl√§che zu Unterseite, Sollma√ü 190mm ¬±0.05. Schlichtzugabe 0,2mm f√ºr Ra 3,2.' },
 { nr: 50, name: 'Taschen fr√§sen (4√ó)', tool: 'T4 √ò20 VHM', time: 46, rate: 'cnc',
 params: 'n 2400 ¬∑ vf 960 ¬∑ ap 4,0',
 detail: 'Tasche 1: 400√ó280mm t=50mm (18min). Tasche 2: 275√ó180mm t=35mm (12min). Taschen 3-4: 150√ó100mm t=25mm (2√ó8min).' },
 { nr: 60, name: 'Langl√∂cher (3√ó)', tool: 'T4 √ò20 VHM', time: 24, rate: 'cnc',
 params: '3√ó ca. 120√ó40mm durchgehend',
 detail: 'Pro Langloch: Vorbohren √ò16 + Ausfr√§sen Kontur = 8min. Durchgangsbearbeitung.' },
 { nr: 70, name: 'Konturfr√§sen Au√üen', tool: 'T5 √ò16 VHM', time: 28, rate: 'cnc',
 params: 'n 3000 ¬∑ vf 600 ¬∑ ap 4,0',
 detail: 'Brennschnitt-Zugabe 2mm abtragen. Umfangsl√§nge ~6m, 2 Zustellungen (Schrupp + Schlicht). vf=600mm/min f√ºr S355.' },
 { nr: 80, name: 'Stirnseite 1 (Planfr√§sen + Bohrungen)', tool: 'T1 √ò80 + T6 √ò12 VHM', time: 40, rate: 'cnc',
 params: 'Kontrollma√ü 1508 ¬±0.1',
 detail: 'Planfr√§sen 500√ó190mm auf Sollma√ü 1508¬±0.1 von Referenz (22min). 6√ó √ò12 H8 t=80mm (18min).' },
 { nr: 90, name: 'Stirnseite 2 (Planfr√§sen + Bohrungen + Kontrollma√ü)', tool: 'T1 √ò80 + T6 √ò12 VHM', time: 57, rate: 'cnc',
 params: 'Kontrollma√ü 1400¬±0.1, 335¬±0.1, Gesamt 2095',
 detail: 'Planfr√§sen Gegenseite 500√ó190mm (24min). 6√ó √ò12 H8 (18min). Kontrollma√ü 335¬±0.1 (15min).' },
 { nr: 100, name: 'Entgraten', tool: 'Manuell (Schleifer/Feile)', time: 68, rate: 'entgraten',
 detail: 'Au√üenkonturen ~6m (22min). Taschenkanten 4√ó ~2m (18min). Langlochkanten 3√ó (12min). Bohrungskanten 24√ó beidseitig (16min).' },
 { nr: 110, name: 'Qualit√§tspr√ºfung & Messprotokoll', tool: '3D-Messarm / KMG', time: 55, rate: 'cnc',
 params: '¬±0.1mm Kontrollma√üe',
 detail: 'Messaufbau & Kalibrierung (8min). 4√ó kritische Ma√üe mit 3D-Messarm (18min). 8√ó Bohrungen mit Lehre (12min). Oberfl√§che visuell (5min). Protokoll (12min).' }
 ]
 }
 };
 
 let RATES = {
 cnc: { labor: 38, machine: 32 },
 saegen: { labor: 35, machine: 10 },
 entgraten: { labor: 28, machine: 3 }
 };
 
 let currentProject = null;
 
 // ================================================================
 // DEUTSCHE FORMATIERUNG LIBRARY
 // ================================================================
 
 const DEFormatter = {
     date(date) {
         return date.toLocaleDateString('de-DE', {
             day: '2-digit',
             month: '2-digit',
             year: 'numeric'
         });
     },
     
     price(amount) {
         const formatted = amount.toLocaleString('de-DE', {
             minimumFractionDigits: 2,
             maximumFractionDigits: 2
         });
         return `EUR ${formatted}`;
     },
     
     length(value, unit = 'mm') {
         return `${Math.round(value)} ${unit}`;
     },
     
     weight(value) {
         return `${value.toFixed(2).replace('.', ',')} kg`;
     },
     
     time(minutes) {
         if (minutes < 60) return `${minutes.toFixed(1).replace('.', ',')} min`;
         return `${(minutes/60).toFixed(1).replace('.', ',')} h`;
     },
     
     quantity(num, unit = 'Stck.') {
         return `${Math.round(num)} ${unit}`;
     }
 };
 
 // ================================================================
 // QUOTE / ANGEBOT FUNCTIONS
 // ================================================================
 
 function calculateValidity() {
     const gueltigkeit = parseInt(document.getElementById('angebotsGueltigkeit')?.value) || 28;
     const today = new Date();
     const validUntil = new Date(today);
     validUntil.setDate(today.getDate() + gueltigkeit);
     
     document.getElementById('quoteDate').textContent = DEFormatter.date(today);
     document.getElementById('quoteValidUntil').textContent = DEFormatter.date(validUntil);
     
     // Sync settings to quote conditions
     const zahlungsziel = document.getElementById('zahlungsziel')?.value || '14';
     const lieferzeit = document.getElementById('standardLieferzeit')?.value || '3-4 Wochen';
     const zielEl = document.getElementById('quoteZahlungsziel');
     const lieferEl = document.getElementById('quoteLieferzeit');
     if (zielEl) zielEl.textContent = zahlungsziel;
     if (lieferEl) lieferEl.textContent = lieferzeit;
 }
 
 function generatePositions(parts) {
     return parts.map((part, index) => ({
         ...part,
         position: index + 1  // 1, 2, 3... (klassisch)
     }));
 }
 
 function renderQuote(data) {
     if (!data || !data.parts) {
         console.warn('renderQuote: No data provided');
         return;
     }
     
     const parts = generatePositions(data.parts);
     
     let html = '';
     parts.forEach(part => {
         html += `
             <tr>
                 <td class="position-nr">${part.position}</td>
                 <td class="mono">${part.articleNumber || 'E-CNC-' + String(part.position).padStart(4, '0')}</td>
                 <td>
                     <div style="font-weight: var(--font-semibold);">${part.name}</div>
                     <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1); font-family: var(--font-mono);">
                         ${part.drawingNumber || part.partNumber || ''}
                     </div>
                     ${part.material ? `<div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">Werkstoff ${part.material}</div>` : ''}
                 </td>
                 <td class="right mono">${DEFormatter.quantity(part.quantity || 1)}</td>
                 <td class="right mono">${DEFormatter.price(part.price || 0)}</td>
                 <td class="right mono">${DEFormatter.price((part.price || 0) * (part.quantity || 1))}</td>
             </tr>
         `;
     });
     
     const tbody = document.querySelector('#section-quote .table tbody');
     if (tbody) {
         tbody.innerHTML = html;
     }
     
     // Summen berechnen
     const subtotal = parts.reduce((sum, p) => sum + (p.price || 0) * (p.quantity || 1), 0);
     const tax = subtotal * 0.19;
     const total = subtotal + tax;
     
     const subtotalEl = document.getElementById('quoteSubtotal');
     const taxEl = document.getElementById('quoteTax');
     const totalEl = document.getElementById('quoteTotal');
     
     if (subtotalEl) subtotalEl.textContent = DEFormatter.price(subtotal);
     if (taxEl) taxEl.textContent = DEFormatter.price(tax);
     if (totalEl) totalEl.textContent = DEFormatter.price(total);
     
     // G√ºltigkeit berechnen
     calculateValidity();
 }
 
 function syncSettingsToQuote() {
     const name = document.getElementById('firmaName')?.value || 'CNC Planner Pro';
     const strasse = document.getElementById('firmaStrasse')?.value || '';
     const ort = document.getElementById('firmaOrt')?.value || '';
     const tel = document.getElementById('firmaTel')?.value || '';
     const email = document.getElementById('firmaEmail')?.value || '';
     
     const senderEl = document.getElementById('quoteSenderLine');
     if (senderEl) senderEl.textContent = `${name} ‚Ä¢ ${strasse} ‚Ä¢ ${ort}`;
     
     const footerEl = document.getElementById('quoteFooterContact');
     if (footerEl) {
         footerEl.innerHTML = `
             <strong style="color: var(--color-text-muted);">${name}</strong><br>
             ${strasse}<br>
             ${ort}<br>
             <br>
             Telefon: ${tel}<br>
             E-Mail: ${email}`;
     }
     
     calculateValidity();
 }
 
 function copyQuote() {
 const quoteEl = document.querySelector('#section-quote .card-body');
 if (!quoteEl) return;
 
 // Copy as plain text
 const text = quoteEl.innerText;
 navigator.clipboard.writeText(text).then(() => {
 const btn = document.querySelector('#section-quote .btn-secondary');
 if (btn) {
 const orig = btn.textContent;
 btn.textContent = 'Kopiert';
 setTimeout(() => { btn.textContent = orig; }, 1500);
 }
 }).catch(() => {
 // Fallback: select + copy
 const range = document.createRange();
 range.selectNodeContents(quoteEl);
 const sel = window.getSelection();
 sel.removeAllRanges();
 sel.addRange(range);
 document.execCommand('copy');
 sel.removeAllRanges();
 });
 }
 
 // ================================================================
 // NAVIGATION
 // ================================================================
 
 const SECTION_TITLES = {
 'part': 'Werkst√ºck',
 'checklist': 'Pr√ºfprotokoll',
 'params': 'Preise & S√§tze',
 'result': 'Kalkulation',
 'calculation': 'Detailkalkulation',
 'tools': 'Werkzeuge',
 'quote': 'Angebot',
 'instructions': 'Fertigungsanweisung',
 'code': 'NC-Code',
 'feedback': 'Nachkalkulation',
 'settings': 'Einstellungen'
 };
 
 // confirmAndGoToParams removed ‚Äî workflow now uses runCalculation()
 
 function showSection(name, btn) {
 document.querySelectorAll('.nav-item').forEach(item =>item.classList.remove('active'));
 if (btn) btn.classList.add('active');
 
 document.querySelectorAll('.section').forEach(section =>section.classList.remove('active'));
 
 if (name === 'checklist') {
 generateChecklist();
 document.getElementById('section-checklist').classList.add('active');
 document.getElementById('mainTitle').textContent = SECTION_TITLES[name] || name;
 { const _e = document.getElementById('mainActions'); if(_e) _e.style.display = 'flex'; }
 return;
 }
 
 if (name === 'instructions') {
 calculate();
 document.getElementById('section-instructions').classList.add('active');
 document.getElementById('mainTitle').textContent = SECTION_TITLES[name] || name;
 { const _e = document.getElementById('mainActions'); if(_e) _e.style.display = 'flex'; }
 return;
 }
 
 if (name === 'result') {
 // Always recalculate when switching to Kalkulation
 calculate();
 document.getElementById('section-result').classList.add('active');
 const calcSection = document.getElementById('section-calculation');
 if (calcSection) calcSection.classList.add('active');
 document.getElementById('mainTitle').textContent = 'Kalkulation';
 { const _e = document.getElementById('mainActions'); if(_e) _e.style.display = 'flex'; }
 return;
 }
 
 document.getElementById('section-' + name).classList.add('active');
 document.getElementById('mainTitle').textContent = SECTION_TITLES[name] || name;
 }
 
 function showParamTab(tab) {
 // Hide all param tabs
 ['preis', 'material', 'zuschlag', 'maschine'].forEach(t => {
 const el = document.getElementById('param-' + t);
 if (el) el.style.display = 'none';
 });
 // Reset all tab buttons
 ['tabParamPreis', 'tabParamMaterial', 'tabParamZuschlag', 'tabParamMaschine'].forEach(id => {
 const el = document.getElementById(id);
 if (el) el.className = 'btn btn-sm btn-secondary';
 });
 // Show selected
 const panel = document.getElementById('param-' + tab);
 if (panel) panel.style.display = 'block';
 const btn = document.getElementById('tabParam' + tab.charAt(0).toUpperCase() + tab.slice(1));
 if (btn) btn.className = 'btn btn-sm btn-primary';
 }
 
 function toggleScope() {
 const content = document.getElementById('scopeContent');
 const chevron = document.getElementById('scopeChevron');
 content.classList.toggle('expanded');
 chevron.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)';
 }
 
 function toggleDrawing(contentId = 'drawingContent', chevronId = 'drawingChevron') {
 const content = document.getElementById(contentId);
 const chevron = document.getElementById(chevronId);
 if (content.style.display === 'none') {
 content.style.display = 'block';
 chevron.textContent = '‚ñº';
 } else {
 content.style.display = 'none';
 chevron.textContent = '‚ñ∂';
 }
 }
 
 function openDrawingFullscreen(imageId = 'drawingImage') {
 const img = document.getElementById(imageId);
 if (img && img.src) {
 window.open(img.src, '_blank');
 }
 }
 
 // ================================================================
 // FERTIGUNGSANWEISUNG: OP Management
 // ================================================================
 
 let customOpCounter = 110;
 
 function initOpControls() {
 // Add checkbox + disable toggle to each existing OP row
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const header = opDiv.querySelector('[onclick*="toggleOpDetail"]');
 if (!header) return;
 
 // Insert checkbox before op-badge
 const badge = header.querySelector('.op-badge');
 if (badge && !header.querySelector('input[type="checkbox"]')) {
 const cb = document.createElement('input');
 cb.type = 'checkbox';
 cb.checked = true;
 cb.style.cssText = 'margin-right:var(--space-2);cursor:pointer;';
 cb.onchange = function() {
 const row = this.closest('div[style*="border-bottom"]');
 if (row) {
 row.style.opacity = this.checked ? '1' : '0.35';
 const detail = row.querySelector('[id$="-detail"]');
 if (detail && !this.checked) detail.style.display = 'none';
 }
 updateOpSum();
 };
 header.insertBefore(cb, badge);
 }
 });
 }
 
 function updateOpSum() {
 let total = 0;
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const cb = opDiv.querySelector('input[type="checkbox"]');
 if (cb && !cb.checked) return;
 const timeSpan = opDiv.querySelector('.mono[style*="text-align: right"] strong, .mono[style*="text-align: right"]');
 if (timeSpan) {
 const t = parseFloat(timeSpan.textContent.replace(',','.').replace(' min','')) || 0;
 total += t;
 }
 });
 // Custom OPs
 document.querySelectorAll('#customOpsContainer .custom-op-row').forEach(row => {
 const cb = row.querySelector('input[type="checkbox"]');
 if (cb && !cb.checked) return;
 const timeInput = row.querySelector('.custom-op-time');
 total += parseFloat(timeInput?.value) || 0;
 });
 const el = document.getElementById('opSumTotal');
 if (el) el.textContent = total.toFixed(1).replace('.',',') + ' min';
 }
 
 function addCustomOP() {
 const container = document.getElementById('customOpsContainer');
 if (!container) return;
 const opNum = customOpCounter;
 customOpCounter += 10;
 
 const div = document.createElement('div');
 div.className = 'custom-op-row card';
 div.style.marginBottom = 'var(--space-3)';
 div.innerHTML = `
 <div class="card-body" style="padding:var(--space-3) var(--space-4);">
 <div style="display:flex;align-items:center;gap:var(--space-3);">
 <input type="checkbox" checked onchange="updateOpSum()" style="cursor:pointer;">
 <span class="op-badge">${opNum}</span>
 <input type="text" class="input input-sm" placeholder="Beschreibung (z.B. W√§rmebehandlung)" style="flex:1;">
 <input type="text" class="input input-sm" placeholder="Werkzeug" style="width:80px;">
 <input type="number" class="input input-sm input-mono custom-op-time" placeholder="min" style="width:70px;" step="0.1" onchange="updateOpSum()">
 <input type="text" class="input input-sm" placeholder="Anmerkung" style="width:150px;">
 <button class="btn btn-sm" onclick="this.closest('.custom-op-row').remove();updateOpSum();" style="padding:0 6px;color:var(--color-text-muted);border:none;" title="Entfernen">√ó</button>
 </div>
 </div>`;
 container.appendChild(div);
 }
 
 function exportFertigungsCSV() {
 let csv = 'OP;Beschreibung;Werkzeug;Zeit [min];Status\\n';
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const cb = opDiv.querySelector('input[type="checkbox"]');
 const badge = opDiv.querySelector('.op-badge');
 const header = opDiv.querySelector('[onclick*="toggleOpDetail"]');
 if (!header || !badge) return;
 const strong = header.querySelector('strong');
 const desc = strong ? strong.textContent.trim() : '';
 const tool = header.querySelector('.mono')?.textContent.trim() || '';
 const timeEl = header.querySelectorAll('.mono');
 const time = timeEl.length >= 2 ? timeEl[timeEl.length-1].textContent.trim().replace(' min','') : '';
 const status = (cb && !cb.checked) ? 'Abgew√§hlt' : 'Aktiv';
 csv += `${badge.textContent};${desc};${tool};${time};${status}\\n`;
 });
 // Custom OPs
 document.querySelectorAll('#customOpsContainer .custom-op-row').forEach(row => {
 const inputs = row.querySelectorAll('input');
 const cb = inputs[0];
 const badge = row.querySelector('.op-badge');
 csv += `${badge?.textContent || ''};${inputs[1]?.value || ''};${inputs[2]?.value || ''};${inputs[3]?.value || ''};${cb.checked ? 'Aktiv' : 'Abgew√§hlt'}\\n`;
 });
 
 const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv;charset=utf-8;' });
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'fertigungsanweisung.csv';
 a.click();
 }
 
 // Pr√ºfmerkmale
 function togglePruefRow(cb) {
 const row = cb.closest('tr');
 if (row) row.style.opacity = cb.checked ? '1' : '0.35';
 }
 
 function removePruefRow(btn) {
 const row = btn.closest('tr');
 if (row && confirm('Pr√ºfmerkmal entfernen?')) row.remove();
 }
 
 function addPruefRow() {
 const tbody = document.getElementById('pruefBody');
 if (!tbody) return;
 const tr = document.createElement('tr');
 tr.innerHTML = `
 <td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
 <td><input type="text" class="input input-sm" placeholder="Merkmal" style="width:120px;"></td>
 <td><input type="text" class="input input-sm input-mono" placeholder="Soll-Wert" style="width:140px;"></td>
 <td><input type="text" class="input input-sm" placeholder="Pr√ºfmittel" style="width:130px;"></td>
 <td class="right"><input type="text" class="input input-sm input-mono" placeholder="min" style="width:60px;"></td>
 <td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">√ó</button></td>`;
 tbody.appendChild(tr);
 }
 
 function exportPruefCSV() {
 let csv = 'Pr√ºfmerkmal;Soll;Pr√ºfmittel;Zeit [min];Status\\n';
 document.querySelectorAll('#pruefBody tr').forEach(tr => {
 const cb = tr.querySelector('input[type="checkbox"]');
 const cells = tr.querySelectorAll('td');
 if (cells.length < 5) return;
 const merkmal = cells[1].querySelector('input')?.value || cells[1].textContent.trim();
 const soll = cells[2].querySelector('input')?.value || cells[2].textContent.trim();
 const mittel = cells[3].querySelector('input')?.value || cells[3].textContent.trim();
 const zeit = cells[4].querySelector('input')?.value || cells[4].textContent.trim().replace(' min','');
 const status = (cb && !cb.checked) ? 'Abgew√§hlt' : 'Aktiv';
 csv += `${merkmal};${soll};${mittel};${zeit};${status}\\n`;
 });
 const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv;charset=utf-8;' });
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'pruefplan.csv';
 a.click();
 }
 
 function toggleOpDetail(opId) {
 const detail = document.getElementById(opId + '-detail');
 if (detail) {
 detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
 }
 }
 
 // === STICKY FEEDBACK ===
 let fbSelectedType = '';
 
 function toggleFeedbackPanel() {
 const panel = document.getElementById('feedbackPanel');
 const success = document.getElementById('fbSuccess');
 panel.classList.toggle('open');
 if (panel.classList.contains('open')) {
 // Detect current page
 const active = document.querySelector('.section.active');
 const pageNames = {
 'section-part': 'Teil',
 'section-params': 'Preise & S√§tze',
 'section-result': 'Kalkulation',
 'section-instructions': 'Fertigungsanweisung',
 'section-quote': 'Angebot',
 'section-code': 'NC-Code',
 'section-tools': 'Werkzeuge',
 'section-feedback': 'Nachkalkulation',
 'section-settings': 'Einstellungen'
 };
 document.getElementById('fbCurrentPage').textContent = pageNames[active?.id] || '‚Äî';
 success.style.display = 'none';
 document.querySelector('.feedback-panel-body').style.display = 'block';
 }
 }
 
 function selectFbType(btn) {
 document.querySelectorAll('.fb-type-btn').forEach(b => b.classList.remove('active'));
 btn.classList.add('active');
 fbSelectedType = btn.dataset.type;
 }
 
 function sendQuickFeedback() {
 const text = document.getElementById('fbQuickText').value.trim();
 if (!text) { document.getElementById('fbQuickText').focus(); return; }
 
 const entry = {
 ts: new Date().toISOString(),
 page: document.getElementById('fbCurrentPage').textContent,
 type: fbSelectedType || 'general',
 text: text
 };
 
 // Save to localStorage
 const stored = JSON.parse(localStorage.getItem('cncplanner_feedback') || '[]');
 stored.push(entry);
 localStorage.setItem('cncplanner_feedback', JSON.stringify(stored));
 
 // Show success
 document.querySelector('.feedback-panel-body').style.display = 'none';
 document.getElementById('fbSuccess').style.display = 'block';
 document.getElementById('fbQuickText').value = '';
 document.querySelectorAll('.fb-type-btn').forEach(b => b.classList.remove('active'));
 fbSelectedType = '';
 
 setTimeout(() => toggleFeedbackPanel(), 1500);
 }
 
 // ================================================================
 // AI ASSISTANT (Demo ‚Äî simulated LLM responses)
 // ================================================================

 const AI_SCOPES = {
 'code': {
 label: 'NC-Code',
 allowed: ['Steuerungscode', 'Werkzeuge', 'Schnittparameter', 'Drehzahl', 'Vorschub', 'Zyklen', 'Format'],
 hint: '√Ñnderungen nur an Steuerungscode, Werkzeugen und Schnittparametern m√∂glich.'
 },
 'result': {
 label: 'Kalkulation',
 allowed: ['Zuschl√§ge', 'Marge', 'St√ºckzahl', 'Verschnitt'],
 hint: '√Ñnderungen an Zuschl√§gen, Marge und Kalkulationsparametern m√∂glich.'
 },
 'instructions': {
 label: 'Fertigungsanweisung',
 allowed: ['Operationen', 'Reihenfolge', 'Zeiten', 'Werkzeuge', 'Schnittdaten'],
 hint: '√Ñnderungen an Operationen, Zeiten und Schnittdaten m√∂glich.'
 },
 'part': {
 label: 'Werkst√ºck',
 allowed: ['Material', 'Ma√üe', 'St√ºckzahl', 'Spannung', 'Toleranz'],
 hint: '√Ñnderungen an Werkst√ºckdaten, Material und Aufspannungen m√∂glich.'
 }
 };

 let chatHistories = { code: [], result: [], instructions: [], part: [] };

 function sendAiMessage(scope) {
 const input = document.getElementById('aiChatInput');
 if (!input) return;
 const msg = input.value.trim();
 if (!msg) return;
 input.value = '';

 addChatMessage(scope, 'user', msg);

 // Check if request is in scope
 const scopeInfo = AI_SCOPES[scope];
 const outOfScope = isOutOfScope(msg, scope);

 if (outOfScope) {
 setTimeout(() => {
 addChatMessage(scope, 'system',
 `‚ö†Ô∏è Diese √Ñnderung betrifft den Bereich "${outOfScope}" ‚Äî bitte dort vornehmen. ` +
 `Hier k√∂nnen nur Werte im Bereich "${scopeInfo.label}" ge√§ndert werden.`
 );
 }, 300);
 return;
 }

 // Simulated AI response (demo)
 setTimeout(() => {
 const response = generateDemoResponse(msg, scope);
 addChatMessage(scope, 'ai', response);
 }, 500 + Math.random() * 1000);
 }

 function aiQuickAction(scope, msg) {
 const input = document.getElementById('aiChatInput');
 if (input) input.value = msg;
 sendAiMessage(scope);
 }

 function addChatMessage(scope, role, text) {
 const container = document.getElementById('aiChatHistory');
 if (!container) return;

 const colors = {
 user: 'background: var(--color-primary); color: white; margin-left: 40px;',
 ai: 'background: var(--color-bg-subtle); border: 1px solid var(--color-border); margin-right: 40px;',
 system: 'background: var(--color-warning-light); border: 1px solid var(--color-warning); color: var(--color-warning); margin-right: 20px;'
 };
 const labels = { user: '', ai: 'ü§ñ ', system: '‚ö†Ô∏è ' };

 const div = document.createElement('div');
 div.style.cssText = `padding: 8px 10px; border-radius: 8px; font-size: 12px; line-height: 1.5; ${colors[role]}`;
 div.innerHTML = `${labels[role]}${text}`;
 container.appendChild(div);
 container.scrollTop = container.scrollHeight;

 chatHistories[scope] = chatHistories[scope] || [];
 chatHistories[scope].push({ role, text, time: Date.now() });
 }

 function isOutOfScope(msg, currentScope) {
 const lower = msg.toLowerCase();
 const crossRefs = {
 'code': { triggers: ['material √§ndern', 'werkstoff', 'st√ºckzahl', 'marge', 'zuschlag', 'preis √§ndern'], target: 'Werkst√ºck / Kalkulation' },
 'result': { triggers: ['nc-code', 'heidenhain', 'drehzahl', 'vorschub', 'g-code', 'operation hinzuf√ºgen'], target: 'NC-Code / Fertigungsanweisung' },
 'instructions': { triggers: ['marge', 'zuschlag', 'material √§ndern', 'preis', 'st√ºckzahl √§ndern'], target: 'Werkst√ºck / Kalkulation' },
 'part': { triggers: ['nc-code', 'heidenhain', 'g-code', 'marge √§ndern', 'zuschlag √§ndern'], target: 'NC-Code / Kalkulation' }
 };

 const check = crossRefs[currentScope];
 if (!check) return null;
 for (const trigger of check.triggers) {
 if (lower.includes(trigger)) return check.target;
 }
 return null;
 }

 function generateDemoResponse(msg, scope) {
 const lower = msg.toLowerCase();
 const partName = currentProject?.name || 'Bauteil';

 // NC-Code scope
 if (scope === 'code') {
 if (lower.includes('vollst√§ndig') || lower.includes('generier')) {
 return `NC-Code f√ºr "${partName}" wird generiert...<br><br>` +
 `<strong>In Produktion:</strong> LLM generiert vollst√§ndigen Heidenhain-Code basierend auf den ${currentProject?.operations?.length || '?'} Arbeitsg√§ngen.<br><br>` +
 `<em>Demo-Modus: Der Code links zeigt einen Auszug. In der Vollversion wird der komplette Code mit allen OPs, Werkzeugwechseln und Zyklen erzeugt.</em>`;
 }
 if (lower.includes('drehzahl') || lower.includes('speed')) {
 return `Drehzahl-Anpassung erkannt.<br><br>` +
 `Aktuelle Empfehlung f√ºr S355:<br>` +
 `‚Ä¢ Planfr√§ser √ò80: n=600 U/min (v<sub>c</sub>=150 m/min)<br>` +
 `‚Ä¢ VHM √ò20: n=2400 U/min (v<sub>c</sub>=150 m/min)<br>` +
 `‚Ä¢ VHM √ò16: n=3000 U/min (v<sub>c</sub>=150 m/min)<br><br>` +
 `Soll ich die Werte im Code aktualisieren?`;
 }
 if (lower.includes('sicherheit')) {
 return `Sicherheitsabfragen hinzugef√ºgt:<br>` +
 `‚Ä¢ <code>CYCL DEF 32.0 TOLERANZ</code> vor jedem Bearbeitungsschritt<br>` +
 `‚Ä¢ Werkzeugl√§ngenpr√ºfung nach jedem Wechsel<br>` +
 `‚Ä¢ Spindelstrom-√úberwachung f√ºr Werkzeugbruch<br>` +
 `‚Ä¢ M0 (optionaler Halt) vor erster Zustellung`;
 }
 if (lower.includes('siemens') || lower.includes('konvertier')) {
 return `Konvertierung Heidenhain ‚Üí Siemens 840D:<br><br>` +
 `‚Ä¢ <code>CYCL DEF 230</code> ‚Üí <code>CYCLE71</code><br>` +
 `‚Ä¢ <code>TOOL CALL</code> ‚Üí <code>T="..." M6</code><br>` +
 `‚Ä¢ <code>L X... Y... FMAX</code> ‚Üí <code>G0 X... Y...</code><br>` +
 `‚Ä¢ <code>CYCL CALL</code> ‚Üí <code>MCALL</code><br><br>` +
 `<em>In Produktion: Vollst√§ndige Konvertierung mit Syntax-Validierung.</em>`;
 }
 if (lower.includes('schnittdaten') || lower.includes('optimier')) {
 return `Schnittdaten-Optimierung f√ºr ${currentProject?.material || 'S355'}:<br><br>` +
 `<strong>Empfehlung (konservativ):</strong><br>` +
 `‚Ä¢ Planfr√§sen: v<sub>c</sub>=150, f<sub>z</sub>=0.15, a<sub>p</sub>=2.0<br>` +
 `‚Ä¢ Konturfr√§sen: v<sub>c</sub>=140, f<sub>z</sub>=0.08, a<sub>p</sub>=4.0<br>` +
 `‚Ä¢ Bohren: v<sub>c</sub>=80, f=0.15 mm/U<br><br>` +
 `Quelle: Sandvik CoroPlus, Walter GPS ‚Äî angepasst an Maschinensteifigkeit C 400.`;
 }
 return `Verstanden. Ich passe den NC-Code entsprechend an.<br><br><em>Demo-Modus: In der Vollversion wird der Code links live aktualisiert.</em>`;
 }

 return `Eingabe erkannt: "${msg}"<br><br><em>Demo-Modus: In der Vollversion werden die Werte auf dieser Seite direkt angepasst.</em>`;
 }

 function toggleCostDetail(id) {
 const detail = document.getElementById('costDetail-' + id);
 if (detail) {
 detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
 }
 }
 
 // === CLAMPING LIST (editable) ===
 function addClamping() {
 const tbody = document.getElementById('clampingRows');
 const count = tbody.rows.length + 1;
 const tr = document.createElement('tr');
 tr.innerHTML = `
 <td class="mono">${count}</td>
 <td>
 <select class="select" onchange="updateClampingTotal()">
 <option value="schraubstock">Schraubstock</option>
 <option value="schraubstock2">2√ó Schraubstock (Langteil)</option>
 <option value="tischspannung">Tischspannung / Pratzen</option>
 <option value="nullpunkt">Nullpunktspannsystem</option>
 <option value="spezial">Sondervorrichtung</option>
 </select>
 </td>
 <td class="right"><input type="number" class="input input-sm input-mono" value="10" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
 <td style="min-width:220px;">
 <div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">Manuelle Eingabe</div>
 </td>
 <td style="text-align:center;"><button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">√ó</button></td>
 `;
 tbody.appendChild(tr);
 updateClampingTotal();
 }
 
 function removeClamping(btn) {
 const tbody = document.getElementById('clampingRows');
 if (tbody.rows.length <= 1) return; // keep at least 1
 btn.closest('tr').remove();
 // Renumber
 Array.from(tbody.rows).forEach((r, i) => { r.cells[0].textContent = i + 1; });
 updateClampingTotal();
 }
 
 function updateClampingTotal() {
 const tbody = document.getElementById('clampingRows');
 let total = 0;
 Array.from(tbody.rows).forEach(r => {
 const input = r.querySelector('input[type="number"]');
 if (input) total += parseFloat(input.value) || 0;
 });
 document.getElementById('totalSetupTimeDisplay').textContent = total + ' min';
 // Update hidden legacy fields
 { const _e = document.getElementById('setupTimeDisplay'); if(_e) _e.textContent = total + ' min'; }
 { const _e = document.getElementById('setupCount'); if(_e) _e.value = tbody.rows.length; }
 }
 
 function getClampingTotalTime() {
 const tbody = document.getElementById('clampingRows');
 if (!tbody) return 25;
 let total = 0;
 Array.from(tbody.rows).forEach(r => {
 const input = r.querySelector('input[type="number"]');
 if (input) total += parseFloat(input.value) || 0;
 });
 return total;
 }
 
 // ================================================================
 // PART SELECTION
 // ================================================================
 
 function renderPartGrid() {
 const grid = document.getElementById('partGrid');
 grid.innerHTML = Object.values(PROJECTS).map(p =>`
<div class="part-card ${currentProject?.id === p.id ? 'selected' : ''}" onclick="selectProject('${p.id}')">
<div class="part-thumb">
<img src="${p.thumbnail}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span style=\\'color:var(--color-text-muted);font-size:11px;\\'>Keine Vorschau</span>'">
</div>
<div class="part-info">
<div class="part-name">${p.name}</div>
<div class="part-number">${p.partNumber}</div>
<div class="part-meta">
<span>${p.baseTime} min</span>
<span>${p.material}</span>
<span class="part-price">${DEFormatter.price(p.unitPrice)}</span>
</div>
</div>
</div>
 `).join('');
 }
 
 function selectProject(id) {
 currentProject = PROJECTS[id];
 
 // Fill form fields ‚Äî NO auto-calculate, NO loading animation
 document.getElementById('materialSelect').value = currentProject.material;
 document.getElementById('dimX').value = currentProject.dims.x;
 document.getElementById('dimY').value = currentProject.dims.y;
 document.getElementById('dimZ').value = currentProject.dims.z;
 if (currentProject.quantity) {
 document.getElementById('quantity').value = currentProject.quantity;
 }
 
 // Load custom clampings if defined
 if (currentProject.clampings) {
 const tbody = document.getElementById('clampingRows');
 tbody.innerHTML = '';
 currentProject.clampings.forEach((c, i) => {
 const row = tbody.insertRow();
 const explanation = getClampingExplanation(c.type, c.time, currentProject, i);
 row.innerHTML = `
 <td class="mono">${i + 1}</td>
 <td>
 <select class="select" onchange="updateClampingTotal()">
 <option value="schraubstock" ${c.type === 'schraubstock' ? 'selected' : ''}>Schraubstock</option>
 <option value="schraubstock2" ${c.type === 'schraubstock2' ? 'selected' : ''}>2√ó Schraubstock (Langteil)</option>
 <option value="tischspannung" ${c.type === 'tischspannung' ? 'selected' : ''}>Tischspannung / Pratzen</option>
 <option value="nullpunkt" ${c.type === 'nullpunkt' ? 'selected' : ''}>Nullpunktspannsystem</option>
 <option value="spezial" ${c.type === 'spezial' ? 'selected' : ''}>Sondervorrichtung</option>
 </select>
 <div style="font-size:11px;color:var(--color-text-muted);margin-top:2px;">${c.desc || ''}</div>
 </td>
 <td class="right"><input type="number" class="input input-sm input-mono" value="${c.time}" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
 <td style="min-width:220px;">
 <div style="font-size:11px;color:var(--color-text-secondary);line-height:1.5;padding:4px 8px;background:var(--color-bg-subtle);border-radius:var(--radius-sm);border-left:2px solid var(--color-info);">
 ${explanation}
 </div>
 </td>
 <td style="text-align:center;">${i > 0 ? '<button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">√ó</button>' : ''}</td>
 `;
 });
 updateClampingTotal();
 }
 
 // Load operations into Fertigungsanweisung if defined
 if (currentProject.operations) {
 renderOperations(currentProject.operations);
 }
 
 renderPartGrid();
 
 // Generate checklist for this project
 checklistAnswers = {};
 checklistCompleted = false;
 generateChecklist();
 
 // Scroll to config section below
 const configCard = document.getElementById('werkstuckConfig');
 if (configCard) configCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
 }
 
 // ================================================================
 // PR√úFPROTOKOLL ‚Äî Intelligenter Fragebogen
 // ================================================================

 const CHECKLIST_QUESTIONS = [
 // Kritisch (rot) ‚Äî m√ºssen beantwortet werden
 {
 id: 'cl_werkstoff',
 priority: 'critical',
 label: 'Werkstoff best√§tigen',
 question: 'Welcher Werkstoff wird tats√§chlich gefertigt?',
 reason: 'Werkstoff bestimmt Schnittdaten, Bearbeitungszeit und Materialkosten. Falsche Angabe = ¬±300% Preisunterschied.',
 type: 'select',
 options: [], // filled dynamically from MATERIALS
 condition: (proj) => true, // always ask
 effect: (val) => `Werkstoff ‚Üí ${val}, Schnittdaten und Preise angepasst`
 },
 {
 id: 'cl_rohteil',
 priority: 'critical',
 label: 'Rohteil-Herkunft',
 question: 'Wird das Rohteil beigestellt oder selbst beschafft?',
 reason: 'Bei Beistellung entfallen Materialkosten komplett ‚Äî oft 20-40% des Angebotspreises.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: 'eigenbeschaffung', label: 'Eigenbeschaffung (wir kaufen Material)' },
 { value: 'beistellung', label: 'Beistellung durch Auftraggeber' },
 { value: 'unklar', label: 'Noch unklar ‚Äî R√ºckfrage n√∂tig' }
 ],
 condition: (proj) => true,
 effect: (val) => val === 'beistellung' ? 'Material = ‚Ç¨0 (Beistellung)' : val === 'eigenbeschaffung' ? 'Materialeinkauf + MGK wird kalkuliert' : 'Kl√§rung n√∂tig'
 },
 {
 id: 'cl_materialpreis',
 priority: 'critical',
 label: 'Materialpreis aktuell',
 question: 'Aktueller Einkaufspreis pro kg?',
 reason: 'Default-Preise sind oft veraltet. Bei 1.500 kg Bauteil = ‚Ç¨1/kg Unterschied = ‚Ç¨1.500 Fehler.',
 type: 'number',
 unit: '‚Ç¨/kg',
 placeholder: 'z.B. 3.00',
 condition: (proj) => {
 const ans = checklistAnswers['cl_rohteil'];
 return !ans || ans !== 'beistellung';
 },
 effect: (val) => `Materialpreis ‚Üí ‚Ç¨${parseFloat(val).toFixed(2)}/kg`
 },
 {
 id: 'cl_brennschnitt',
 priority: 'critical',
 label: 'Brennschnitt / Rohkontur',
 question: 'Wie wird das Rohteil angeliefert?',
 reason: 'Brennschnitt-Aufma√ü bestimmt, wie viel Material abgetragen werden muss ‚Üí Bearbeitungszeit ¬±30%.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: 'brennschnitt_3mm', label: 'Brennschnitt, ca. 3mm Aufma√ü' },
 { value: 'brennschnitt_5mm', label: 'Brennschnitt, ca. 5mm Aufma√ü' },
 { value: 'gesaegt', label: 'Ges√§gt (Rechteck-Rohling)' },
 { value: 'geschmiedet', label: 'Schmiedeteil' },
 { value: 'unklar', label: 'Noch unklar' }
 ],
 condition: (proj) => proj && (proj.dims.x > 500 || proj.dims.y > 500),
 effect: (val) => {
 const map = { brennschnitt_3mm: '3mm ‚Üí weniger Schruppzeit', brennschnitt_5mm: '5mm ‚Üí mehr Schruppzeit', gesaegt: 'Rechteck ‚Üí volle Konturbearbeitung', geschmiedet: 'Schmiedeteil ‚Üí individuelle Aufma√üe' };
 return map[val] || 'Kl√§rung n√∂tig';
 }
 },
 // Empfohlen (gelb)
 {
 id: 'cl_toleranz',
 priority: 'recommended',
 label: 'Engste Toleranz',
 question: 'Engste geforderte Ma√ütoleranz?',
 reason: 'Enge Toleranzen erfordern Schlichtbearbeitung, Temperierung und mehr Messaufwand.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: '0.01', label: '¬±0.01 mm (Pr√§zision, Schleifen empfohlen)' },
 { value: '0.02', label: '¬±0.02 mm (Feinbearbeitung)' },
 { value: '0.05', label: '¬±0.05 mm (Standard Schlichten)' },
 { value: '0.1', label: '¬±0.1 mm (Normal)' },
 { value: '0.5', label: '¬±0.5 mm (Grob)' }
 ],
 condition: (proj) => true,
 effect: (val) => parseFloat(val) <= 0.02 ? 'Schleifen/Feinbearbeitung eingeplant' : parseFloat(val) <= 0.05 ? 'Schlichtaufma√ü + langsamer Vorschub' : 'Standardbearbeitung'
 },
 {
 id: 'cl_oberflaeche',
 priority: 'recommended',
 label: 'Oberfl√§cheng√ºte',
 question: 'Geforderte Oberfl√§cheng√ºte (Ra)?',
 reason: 'Ra < 1.6 erfordert spezielle Schlichtstrategien und l√§ngere Bearbeitungszeit.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: '0.8', label: 'Ra 0.8 (Schleifen/Honen)' },
 { value: '1.6', label: 'Ra 1.6 (Fein-Schlichten)' },
 { value: '3.2', label: 'Ra 3.2 (Standard Schlichten)' },
 { value: '6.3', label: 'Ra 6.3 (Schruppen reicht)' },
 { value: '12.5', label: 'Ra 12.5 (Roh)' }
 ],
 condition: (proj) => true,
 effect: (val) => parseFloat(val) <= 1.6 ? 'Zus√§tzliche Schlichtg√§nge n√∂tig' : 'Standardbearbeitung'
 },
 {
 id: 'cl_losgroesse',
 priority: 'recommended',
 label: 'Wiederholauftrag?',
 question: 'Ist dies ein Einzelauftrag oder Wiederholauftrag?',
 reason: 'Bei Wiederholauftr√§gen lohnt sich Vorrichtungsbau ‚Üí R√ºstzeit sinkt ab 2. Los um 40-60%.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: 'einmal', label: 'Einmalauftrag' },
 { value: 'serie_klein', label: 'Kleinserie (5-20 Stk/Jahr)' },
 { value: 'serie_mittel', label: 'Mittelserie (20-100 Stk/Jahr)' },
 { value: 'serie_gross', label: 'Gro√üserie (>100 Stk/Jahr)' }
 ],
 condition: (proj) => true,
 effect: (val) => val === 'einmal' ? 'Keine Vorrichtung' : val === 'serie_klein' ? 'Einfache Vorrichtung empfohlen' : 'Vorrichtungsbau kalkulieren'
 },
 {
 id: 'cl_pruefmittel',
 priority: 'recommended',
 label: 'Pr√ºfanforderungen',
 question: 'Welche Pr√ºfung/Dokumentation wird gefordert?',
 reason: 'Erstmusterpr√ºfbericht (EMPB) oder 3D-Vermessung kosten 30-120 min extra.',
 type: 'select',
 options: [
 { value: '', label: '‚Äî Bitte w√§hlen ‚Äî' },
 { value: 'keine', label: 'Keine besondere Pr√ºfung' },
 { value: 'handmessung', label: 'Standard Handmessung' },
 { value: '3d_messung', label: '3D-Koordinatenmessung' },
 { value: 'empb', label: 'Erstmusterpr√ºfbericht (EMPB/PPAP)' }
 ],
 condition: (proj) => true,
 effect: (val) => {
 const map = { keine: 'Keine Zusatzzeit', handmessung: '+15 min/St√ºck', '3d_messung': '+45 min/St√ºck', empb: '+120 min Erstmuster + Dokumentation' };
 return map[val] || '';
 }
 }
 ];

 let checklistAnswers = {};
 let checklistCompleted = false;

 function generateChecklist() {
 const container = document.getElementById('checklistQuestions');
 if (!container) return;
 container.innerHTML = '';

 // Dynamically fill material options
 const matQ = CHECKLIST_QUESTIONS.find(q => q.id === 'cl_werkstoff');
 if (matQ) {
 matQ.options = [{ value: '', label: '‚Äî Bitte w√§hlen ‚Äî' }];
 Object.keys(MATERIALS).forEach(k => {
 matQ.options.push({ value: k, label: `${MATERIALS[k].name} (‚Ç¨${MATERIALS[k].price.toFixed(2)}/kg, œÅ ${MATERIALS[k].density} g/cm¬≥)` });
 });
 // Pre-select current material
 if (currentProject?.material) {
 checklistAnswers['cl_werkstoff'] = checklistAnswers['cl_werkstoff'] || currentProject.material;
 }
 }

 let criticalCount = 0;
 let openCount = 0;

 CHECKLIST_QUESTIONS.forEach(q => {
 if (!q.condition(currentProject)) return;

 const answered = checklistAnswers[q.id] !== undefined && checklistAnswers[q.id] !== '';
 if (!answered && q.priority === 'critical') criticalCount++;
 if (!answered) openCount++;

 const borderColor = q.priority === 'critical' ? 'var(--color-danger)' : 'var(--color-warning)';
 const bgColor = answered ? 'var(--color-bg-subtle)' : (q.priority === 'critical' ? 'rgba(220,53,69,0.05)' : 'rgba(255,193,7,0.05)');
 const icon = answered ? '‚úÖ' : (q.priority === 'critical' ? 'üî¥' : 'üü°');

 let inputHtml = '';
 if (q.type === 'select') {
 inputHtml = `<select class="select" style="max-width:400px;" onchange="answerChecklist('${q.id}', this.value)">
 ${q.options.map(o => `<option value="${o.value}" ${checklistAnswers[q.id] === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
 </select>`;
 } else if (q.type === 'number') {
 inputHtml = `<div style="display:flex;align-items:center;gap:8px;">
 <input type="number" step="0.01" class="input input-sm" style="width:120px;" 
 value="${checklistAnswers[q.id] || ''}" placeholder="${q.placeholder || ''}"
 onchange="answerChecklist('${q.id}', this.value)">
 <span style="color:var(--color-text-muted);font-size:13px;">${q.unit || ''}</span>
 </div>`;
 }

 const effectText = answered && q.effect ? q.effect(checklistAnswers[q.id]) : '';

 container.innerHTML += `
 <div class="checklist-item" style="padding: var(--space-3); border-left: 3px solid ${borderColor}; background: ${bgColor}; border-radius: var(--radius);">
 <div style="display:flex; align-items:center; gap: 8px; margin-bottom: 4px;">
 <span>${icon}</span>
 <strong style="font-size: 14px;">${q.label}</strong>
 <span style="font-size:11px; padding:1px 6px; border-radius:8px; background:${q.priority === 'critical' ? 'var(--color-danger)' : 'var(--color-warning)'}; color:#fff;">
 ${q.priority === 'critical' ? 'Pflicht' : 'Empfohlen'}
 </span>
 </div>
 <div style="font-size:14px; margin-bottom: 8px; font-weight: 500;">${q.question}</div>
 <div style="font-size:12px; color:var(--color-text-muted); margin-bottom: 8px;">
 üí° <em>${q.reason}</em>
 </div>
 ${inputHtml}
 ${effectText ? `<div style="margin-top:6px; font-size:12px; color:var(--color-success);">‚Üí ${effectText}</div>` : ''}
 </div>`;
 });

 // Update badge
 const badge = document.getElementById('checklistBadge');
 if (badge) {
 if (openCount > 0) {
 badge.style.display = 'inline';
 badge.textContent = openCount;
 badge.style.background = criticalCount > 0 ? 'var(--color-danger)' : 'var(--color-warning)';
 } else {
 badge.style.display = 'inline';
 badge.textContent = '‚úì';
 badge.style.background = 'var(--color-success)';
 }
 }

 // Update summary
 updateChecklistSummary();
 }

 function answerChecklist(id, value) {
 checklistAnswers[id] = value;

 // Apply material change immediately
 if (id === 'cl_werkstoff' && value && MATERIALS[value]) {
 document.getElementById('materialSelect').value = value;
 }

 // Apply material price
 if (id === 'cl_materialpreis' && parseFloat(value) > 0) {
 const matKey = document.getElementById('materialSelect').value;
 if (MATERIALS[matKey]) {
 MATERIALS[matKey].price = parseFloat(value);
 }
 }

 // Re-check conditional visibility
 generateChecklist();
 }

 function updateChecklistSummary() {
 const container = document.getElementById('checklistSummaryContent');
 const wrapper = document.getElementById('checklistSummary');
 if (!container || !wrapper) return;

 const answered = Object.entries(checklistAnswers).filter(([k, v]) => v !== '' && v !== undefined);
 if (answered.length === 0) { wrapper.style.display = 'none'; return; }

 wrapper.style.display = 'block';
 let html = '<table style="width:100%;font-size:13px;border-collapse:collapse;">';
 html += '<tr style="border-bottom:1px solid var(--color-border);"><th style="text-align:left;padding:4px 8px;">Pr√ºfpunkt</th><th style="text-align:left;padding:4px 8px;">Antwort</th><th style="text-align:left;padding:4px 8px;">Auswirkung</th></tr>';

 CHECKLIST_QUESTIONS.forEach(q => {
 if (!q.condition(currentProject)) return;
 const val = checklistAnswers[q.id];
 if (val === undefined || val === '') return;

 let displayVal = val;
 if (q.type === 'select') {
 const opt = q.options.find(o => o.value === val);
 displayVal = opt ? opt.label : val;
 } else if (q.unit) {
 displayVal = val + ' ' + q.unit;
 }

 const effect = q.effect ? q.effect(val) : '';
 html += `<tr style="border-bottom:1px solid var(--color-border);">
 <td style="padding:4px 8px;">${q.label}</td>
 <td style="padding:4px 8px;"><strong>${displayVal}</strong></td>
 <td style="padding:4px 8px; color:var(--color-text-muted);">${effect}</td>
 </tr>`;
 });
 html += '</table>';
 container.innerHTML = html;
 }

 function submitChecklist() {
 // Check critical questions
 const unanswered = CHECKLIST_QUESTIONS.filter(q => 
 q.priority === 'critical' && q.condition(currentProject) && (!checklistAnswers[q.id] || checklistAnswers[q.id] === '')
 );

 if (unanswered.length > 0) {
 alert('‚ö†Ô∏è Bitte alle Pflichtfragen (rot) beantworten:\n\n' + unanswered.map(q => '‚Ä¢ ' + q.label).join('\n'));
 return;
 }

 checklistCompleted = true;

 // Apply answers to calculation
 if (checklistAnswers['cl_rohteil'] === 'beistellung') {
 // Material cost = 0 ‚Äî set price to 0 temporarily
 const matKey = document.getElementById('materialSelect').value;
 if (MATERIALS[matKey]) MATERIALS[matKey].price = 0;
 }

 // Switch to Kalkulation
 const btn = document.querySelector('[data-section="result"]');
 showSection('result', btn);
 }

 function exportChecklistPDF() {
 // Simple print-based export
 const content = document.getElementById('checklistSummaryContent')?.innerHTML;
 if (!content) { alert('Keine Antworten zum Exportieren.'); return; }

 const w = window.open('', '_blank');
 w.document.write(`<html><head><title>Pr√ºfprotokoll ‚Äî ${currentProject?.name || 'Bauteil'}</title>
 <style>body{font-family:Helvetica Neue,Arial,sans-serif;padding:40px;font-size:13px;}
 table{width:100%;border-collapse:collapse;}th,td{padding:6px 10px;border:1px solid #ddd;text-align:left;}
 th{background:#f5f5f5;}h1{font-size:18px;margin-bottom:4px;}h2{font-size:14px;color:#666;margin-bottom:20px;}</style></head>
 <body><h1>Pr√ºfprotokoll</h1><h2>${currentProject?.name || 'Bauteil'} ‚Äî ${currentProject?.partNumber || ''} ‚Äî ${new Date().toLocaleDateString('de-DE')}</h2>
 ${content}
 <p style="margin-top:30px;font-size:11px;color:#999;">Erstellt mit CNC Planner Pro ‚Äî ${new Date().toLocaleString('de-DE')}</p>
 </body></html>`);
 w.document.close();
 w.print();
 }

 function sendDevFeedback() {
 const text = document.getElementById('devFeedbackText')?.value?.trim();
 if (!text) { alert('Bitte Feedback eingeben.'); return; }

 const status = document.getElementById('devFeedbackStatus');
 const payload = {
 type: 'cnc-planner-feedback',
 project: currentProject?.name || 'Unbekannt',
 partNumber: currentProject?.partNumber || '',
 feedback: text,
 timestamp: new Date().toISOString(),
 checklistState: { ...checklistAnswers }
 };

 // Store locally
 const feedbackLog = JSON.parse(localStorage.getItem('cncPlannerFeedback') || '[]');
 feedbackLog.push(payload);
 localStorage.setItem('cncPlannerFeedback', JSON.stringify(feedbackLog));

 // Show WhatsApp link to developer
 const msg = encodeURIComponent(`[CNC Planner Feedback] ${currentProject?.name || 'Bauteil'}: ${text}`);
 
 if (status) {
 status.innerHTML = `‚úÖ Feedback gespeichert! <a href="https://wa.me/4915123039208?text=${msg}" target="_blank" style="color:var(--color-primary);">üì® Per WhatsApp an Entwickler senden</a>`;
 }
 document.getElementById('devFeedbackText').value = '';
 }

 // ================================================================
 // CLAMPING EXPLANATION & WORKER FEEDBACK
 // ================================================================

 function getClampingExplanation(type, time, project, index) {
 const dims = project?.dims || { x: 100, y: 100, z: 20 };
 const weight = (dims.x * dims.y * dims.z / 1000 * (MATERIALS[project?.material]?.density || 7.85)) / 1000;
 const isFirst = index === 0;

 const explanations = {
 'tischspannung': {
 base: 20,
 items: [
 { label: 'Pratzen setzen (4-6√ó)', time: isFirst ? 15 : 10, note: weight > 500 ? 'Kran erforderlich' : '' },
 { label: 'Ausrichten / Parallelit√§t', time: isFirst ? 8 : 5, note: '' },
 { label: 'WZ einwechseln', time: isFirst ? 8 : 6, note: isFirst ? '3-5 Werkzeuge' : '2-3 Werkzeuge' },
 { label: 'Nullpunkt antasten', time: isFirst ? 7 : 5, note: '' },
 { label: 'Programm laden/pr√ºfen', time: isFirst ? 5 : 3, note: '' },
 ...(weight > 200 ? [{ label: 'Kranhandling (>' + Math.round(weight) + 'kg)', time: 7, note: '‚ö†Ô∏è Schwerlast' }] : [])
 ]
 },
 'schraubstock': {
 base: 8,
 items: [
 { label: 'Einlegen & Spannen', time: 3, note: '' },
 { label: 'Parallelit√§t pr√ºfen', time: 4, note: '' },
 { label: 'Nullpunkt antasten', time: 5, note: '' },
 { label: 'WZ + Programm', time: isFirst ? 5 : 3, note: '' }
 ]
 },
 'schraubstock2': {
 base: 12,
 items: [
 { label: '2√ó Schraubstock ausrichten', time: 8, note: '' },
 { label: 'Teil einlegen', time: 5, note: '' },
 { label: 'Nullpunkt + Programm', time: 8, note: '' }
 ]
 },
 'nullpunkt': {
 base: 3,
 items: [
 { label: 'Palette einsetzen', time: 2, note: 'Schnellwechsel' },
 { label: 'Verriegeln + Programm', time: 3, note: '' }
 ]
 },
 'spezial': {
 base: 25,
 items: [
 { label: 'Vorrichtung montieren', time: 20, note: '' },
 { label: 'Teil einlegen & sichern', time: 10, note: '' },
 { label: 'Nullpunkt + Programm', time: 10, note: '' }
 ]
 }
 };

 const exp = explanations[type] || explanations['schraubstock'];
 let html = '<table style="width:100%;font-size:10px;font-family:var(--font-mono);">';
 let calcTotal = 0;
 exp.items.forEach(item => {
 calcTotal += item.time;
 html += `<tr>
 <td style="padding:1px 0;color:var(--color-text-muted);">${item.label}</td>
 <td style="text-align:right;padding:1px 0;">${item.time} min</td>
 ${item.note ? `<td style="padding:1px 4px;color:var(--color-warning);font-size:9px;">${item.note}</td>` : '<td></td>'}
 </tr>`;
 });
 const diff = time - calcTotal;
 if (Math.abs(diff) > 1) {
 html += `<tr><td style="padding:1px 0;color:var(--color-text-hint);">Rundung/Puffer</td><td style="text-align:right;padding:1px 0;">${diff > 0 ? '+' : ''}${diff} min</td><td></td></tr>`;
 }
 html += `<tr style="border-top:1px solid var(--color-border);font-weight:600;"><td style="padding:2px 0;">Gesamt</td><td style="text-align:right;padding:2px 0;">${time} min</td><td></td></tr>`;
 html += '</table>';
 return html;
 }

 function askWorkerFeedbackGeneric() {
 // Detect current section
 const activeSection = document.querySelector('.section.active');
 const sectionId = activeSection?.id?.replace('section-', '') || 'unbekannt';
 const sectionNames = {
 'part': 'Werkst√ºck',
 'result': 'Kalkulation',
 'instructions': 'Fertigungsanweisung',
 'tools': 'Werkzeuge',
 'code': 'NC-Code',
 'quote': 'Angebot',
 'feedback': 'Nachkalkulation',
 'params': 'Preise & S√§tze',
 'settings': 'Einstellungen'
 };
 const sectionName = sectionNames[sectionId] || sectionId;
 const partName = currentProject?.name || 'Bauteil';
 const partNr = currentProject?.partNumber || '';

 const question = prompt(
 `Werker-Feedback anfordern\n\nAktueller Bereich: ${sectionName}\nBauteil: ${partName}\n\nWas m√∂chten Sie den Werker fragen?`,
 ''
 );
 if (!question) return;

 askWorkerFeedback(
 sectionName,
 question,
 0
 );
 }

 function askWorkerFeedback(step, description, estimatedTime) {
 const partName = currentProject?.name || 'Bauteil';
 const partNr = currentProject?.partNumber || '';
 const timeInfo = estimatedTime > 0
 ? `\n‚è±Ô∏è Gesch√§tzte Zeit: ${estimatedTime} min\n\nBitte antworten Sie:\n‚úÖ Passt so\nüîÑ Korrektur: ___ min (mit Begr√ºndung)\n‚ùå Nicht realistisch, weil: ___`
 : `\nBitte antworten Sie mit Ihrer Einsch√§tzung:`;

 const message = encodeURIComponent(
 `üîß CNC Planner Pro ‚Äî Feedback gefragt\n\n` +
 `Bauteil: ${partName} (${partNr})\n` +
 `Bereich: ${step}\n` +
 `Frage: ${description}` +
 timeInfo
 );
 
 // Show modal to enter phone number or use stored
 const stored = localStorage.getItem('cncplanner_worker_phone') || '';
 const phone = prompt(
 'WhatsApp-Nummer des Werkers/Meisters eingeben:\n(Format: +49151...)\n\nGespeicherte Nr: ' + (stored || 'keine'),
 stored
 );
 if (!phone) return;
 localStorage.setItem('cncplanner_worker_phone', phone);
 const cleanPhone = phone.replace(/[^0-9]/g, '');
 window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
 }

 function renderOperations(ops) {
 const container = document.querySelector('#section-instructions .card-body');
 if (!container) return;
 // Find the ops card (the one with "Operationen und Bearbeitungszeiten")
 const opsCards = document.querySelectorAll('#section-instructions .card');
 let opsCard = null;
 opsCards.forEach(c => {
 const hdr = c.querySelector('.card-header');
 if (hdr && hdr.textContent.includes('Operationen')) opsCard = c;
 });
 if (!opsCard) return;
 const body = opsCard.querySelector('.card-body');
 if (!body) return;
 
 let totalTime = 0;
 body.innerHTML = ops.map(op => {
 totalTime += op.time;
 const rateLabel = op.rate === 'saegen' ? 'S√§gen' : op.rate === 'entgraten' ? 'Entgraten' : 'CNC';
 const rateObj = RATES[op.rate] || RATES.cnc;
 const rate = rateObj.labor + rateObj.machine;
 const cost = (op.time / 60) * rate;
 return `
 <div style="border-bottom: 1px solid var(--color-border);">
 <div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
 <span class="op-badge" style="margin-right: var(--space-3);">${op.nr}</span>
 <span style="flex: 1;">
 <strong>${op.name}</strong>
 ${op.params ? `<div class="op-params"><span>${op.params}</span></div>` : ''}
 </span>
 <span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">${op.tool}</span>
 <span class="mono" style="width: 80px; text-align: right;"><strong>${op.time} min</strong></span>
 <span style="margin-left: var(--space-3); font-size: 12px; color: var(--color-text-hint);">${DEFormatter.price(cost)}</span>
 <span style="margin-left: var(--space-2); color: var(--color-text-muted);">‚ñº</span>
 </div>
 <div style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
 <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: var(--space-4);">
 <div>
 <div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Beschreibung</div>
 <div style="color: var(--color-text-secondary); line-height: 1.7;">${op.detail}</div>
 </div>
 <div>
 <div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Kalkulation</div>
 <div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Zeit: ${op.time} min = ${(op.time/60).toFixed(2)} h<br>
 Kostensatz: ${DEFormatter.price(rate)}/h (${rateLabel})<br>
 Lohn: ${DEFormatter.price(rateObj.labor)}/h ¬∑ Maschine: ${DEFormatter.price(rateObj.machine)}/h<br>
 <strong>Kosten: ${DEFormatter.price(cost)}</strong>
 </div>
 </div>
 <div style="display:flex;flex-direction:column;gap:var(--space-2);min-width:100px;">
 <button class="btn btn-sm" onclick="askWorkerFeedback('AG ${op.nr}: ${op.name}', '${(op.detail || '').replace(/'/g, "\\'")}', ${op.time})" style="font-size:10px;height:26px;color:var(--color-success);border-color:var(--color-success);">
 üì± Werker fragen
 </button>
 <div style="font-size:10px;color:var(--color-text-hint);text-align:center;">Unsicher?<br>Feedback einholen</div>
 </div>
 </div>
 </div>
 </div>`;
 }).join('') + `
 <div style="display: flex; justify-content: space-between; padding: var(--space-3) var(--space-4); background: var(--color-bg-muted); font-weight: 600;">
 <span>Gesamtzeit Bearbeitung</span>
 <span class="mono">${totalTime} min = ${(totalTime/60).toFixed(1)} h</span>
 </div>`;
 }
 
 function runCalculation() {
 // Triggered by explicit "Berechnen" button
 showLoading();
 
 calculate();
 
 // Update instruction header
 if (currentProject) {
 document.getElementById('faPartName').textContent = `${currentProject.name} ‚Äî ${currentProject.partNumber}`;
 const descEl = document.getElementById('quoteDesc');
 if (descEl) descEl.textContent = `Angebot ‚Äî CNC-Fertigung ${currentProject.name}`;
 }
 
 setTimeout(() => {
 hideLoading();
 { const _e = document.getElementById('mainActions'); if(_e) _e.style.display = 'flex'; }
 showSection('result', document.querySelector('.nav-item[data-section="result"]'));
 }, 2500);
 }
 
 // ================================================================
 // CALCULATION
 // ================================================================
 
 function calculate() {
 const mat = MATERIALS[document.getElementById('materialSelect').value];
 const x = parseFloat(document.getElementById('dimX').value) || 100;
 const y = parseFloat(document.getElementById('dimY').value) || 100;
 const z = parseFloat(document.getElementById('dimZ').value) || 20;
 const qty = parseInt(document.getElementById('quantity').value) || 1;
 // marginInput is now hidden, synced from zuschlagGewinn
 const margin = parseFloat(document.getElementById('zuschlagGewinn')?.value) || 10;
 { const _e = document.getElementById('marginInput'); if(_e) _e.value = margin; }
 const scrap = parseFloat(document.getElementById('settingScrap')?.value) || 10;
 // Werkzeugkosten entfallen ‚Äî bei KMU im Maschinenstundensatz enthalten
 const toolWear = 0;
 const vat = parseFloat(document.getElementById('settingVat')?.value) || 19;
 
 // Clamping ‚Äî from editable table
 const totalSetupTime = getClampingTotalTime();
 const clampingType = document.getElementById('clampingSelect')?.value || 'schraubstock';
 const clampingData = CLAMPING[clampingType] || CLAMPING.schraubstock;
 const setupCount = document.getElementById('clampingRows')?.rows.length || 2;
 
 // Rates
 const cncRate = RATES.cnc.labor + RATES.cnc.machine;
 const entgratenRate = RATES.entgraten.labor + RATES.entgraten.machine;
 const saegenRate = RATES.saegen.labor + RATES.saegen.machine;
 
 // Setup cost
 const setupCost = (totalSetupTime / 60) * cncRate;
 const setupCostPerPiece = setupCost / qty;
 
 // Volume & Weight
 const volumeMm3 = x * y * z;
 const volumeCm3 = volumeMm3 / 1000;
 const weightKg = (volumeCm3 * mat.density) / 1000;
 
 // Material cost
 const materialCost = weightKg * mat.price * (1 + scrap / 100);
 
 // Machining time & cost ‚Äî use operations if defined, else formula
 let machiningTime, machineCost;
 let additionalCost = 0;
 let additionalDesc = [];

 if (currentProject?.operations && currentProject.operations.length > 0) {
 // Operations-based: sum up all ops with their respective rates
 machiningTime = 0;
 machineCost = 0;
 currentProject.operations.forEach(op => {
 const opRates = RATES[op.rate] || RATES.cnc;
 const opRate = opRates.labor + opRates.machine;
 machiningTime += op.time;
 machineCost += (op.time / 60) * opRate;
 });
 // Additional ops are INCLUDED in operations ‚Äî don't double-count
 } else {
 // Formula-based (legacy)
 const refVolume = currentProject ? (currentProject.dims.x * currentProject.dims.y * currentProject.dims.z) / 1000 : 440;
 const baseTime = currentProject ? currentProject.baseTime : 12.5;
 const sizeFactor = volumeCm3 / refVolume;
 machiningTime = baseTime * Math.pow(sizeFactor, 0.7) * mat.timeFactor;
 machineCost = (machiningTime / 60) * cncRate;

 // Additional operations (only for formula-based, not ops-based)
 if (document.getElementById('opEntgraten')?.checked) {
 const t = parseFloat(document.getElementById('opEntgratenTime')?.value) || 5;
 additionalCost += (t / 60) * entgratenRate;
 additionalDesc.push('Entgraten ' + t + ' min');
 }
 if (document.getElementById('opSaegen')?.checked) {
 const t = parseFloat(document.getElementById('opSaegenTime')?.value) || 3;
 additionalCost += (t / 60) * saegenRate;
 additionalDesc.push('S√§gen ' + t + ' min');
 }
 if (document.getElementById('opPruefung')?.checked) {
 const t = parseFloat(document.getElementById('opPruefungTime')?.value) || 5;
 additionalCost += (t / 60) * cncRate;
 additionalDesc.push('Pr√ºfung ' + t + ' min');
 }
 }
 
 // Tool cost
 const toolCost = toolWear * mat.timeFactor;
 
 // ================================================================
 // ZUSCHLAGSKALKULATION (Industriestandard)
 // ================================================================
 
 // Zuschlagss√§tze aus Einstellungen lesen
 const zuschlagMGK = parseFloat(document.getElementById('zuschlagMGK')?.value) || 10; // Materialgemeinkosten
 const zuschlagAV = parseFloat(document.getElementById('zuschlagAV')?.value) || 8; // AV-Aufschlag
 const zuschlagVwGK = parseFloat(document.getElementById('zuschlagVwGK')?.value) || 12; // Verwaltung
 const zuschlagVtGK = parseFloat(document.getElementById('zuschlagVtGK')?.value) || 5; // Vertrieb
 const zuschlagGewinn = parseFloat(document.getElementById('zuschlagGewinn')?.value) || 10; // Gewinn
 
 // 1. Materialkosten + MGK
 const materialMitGK = materialCost * (1 + zuschlagMGK / 100);
 
 // 2. Fertigungskosten (Maschine + R√ºsten + Nebenzeiten)
 const fertigungskosten = machineCost + setupCostPerPiece + additionalCost;
 
 // 3. Fertigungskosten + AV-Aufschlag
 const fertigungMitAV = fertigungskosten * (1 + zuschlagAV / 100);
 
 // 4. HERSTELLKOSTEN (HK)
 const herstellkosten = materialMitGK + fertigungMitAV + toolCost;
 
 // 5. + Verwaltungs-GK + Vertriebs-GK = SELBSTKOSTEN (SK)
 const vwGKBetrag = herstellkosten * (zuschlagVwGK / 100);
 const vtGKBetrag = herstellkosten * (zuschlagVtGK / 100);
 const selbstkosten = herstellkosten + vwGKBetrag + vtGKBetrag;
 
 // 6. + Gewinn = ANGEBOTSPREIS
 const gewinnBetrag = selbstkosten * (zuschlagGewinn / 100);
 const angebotspreis = selbstkosten + gewinnBetrag;
 
 // F√ºr Kompatibilit√§t: alte Variablen updaten
 const totalCost = herstellkosten; // Herstellkosten als "Kosten"
 const marginAmount = gewinnBetrag;
 const sellPrice = angebotspreis;
 const orderTotal = sellPrice * qty;
 const mwstAmount = orderTotal * (vat / 100);
 const totalWithVat = orderTotal + mwstAmount;
 
 // Deckungsbeitrag
 const deckungsbeitrag = angebotspreis - (materialCost + fertigungskosten + toolCost);
 const dbProzent = (deckungsbeitrag / angebotspreis) * 100;
 
 // Reference volume for confidence (always defined)
 const refVolume = currentProject ? (currentProject.dims.x * currentProject.dims.y * currentProject.dims.z) / 1000 : 440;

 // Confidence
 let confidenceClass = 'confidence-medium';
 let confidenceText = ' Richtwert ‚Äî Nachkalkulation empfohlen';
 if (currentProject?.operations) {
 confidenceClass = 'confidence-high';
 confidenceText = 'üü¢ ¬±10% ‚Äî Operationsbasierte Kalkulation';
 } else if (mat.timeFactor >1.2) {
 confidenceClass = 'confidence-low';
 confidenceText = 'üî¥ ¬±25% ‚Äî Schwerzerspanbarer Werkstoff';
 } else if (currentProject && Math.abs(volumeCm3 - refVolume)< refVolume * 0.2) {
 confidenceClass = 'confidence-high';
 confidenceText = 'üü¢ ¬±10% ‚Äî √Ñhnlich wie Referenzteil';
 }
 
 // Update UI ‚Äî using DEFormatter for consistent EUR formatting
 document.getElementById('setupTimeDisplay').textContent = DEFormatter.time(totalSetupTime);
 document.getElementById('setupCostDisplay').textContent = DEFormatter.price(setupCost);
 
 { const _e = document.getElementById('liveWeight'); if(_e) _e.textContent = DEFormatter.weight(weightKg); }
 { const _e = document.getElementById('liveMaterial'); if(_e) _e.textContent = DEFormatter.price(materialCost); }
 { const _e = document.getElementById('liveTime'); if(_e) _e.textContent = DEFormatter.time(machiningTime); }
 { const _e = document.getElementById('liveMachine'); if(_e) _e.textContent = DEFormatter.price(machineCost); }
 
 document.getElementById('priceDisplay').textContent = DEFormatter.price(sellPrice);
 document.getElementById('confidenceBadge').className = 'confidence-badge ' + confidenceClass;
 document.getElementById('confidenceBadge').innerHTML = '<span>' + confidenceText.split(' ')[0] + '</span>' + confidenceText.split(' ').slice(1).join(' ');
 
 document.getElementById('matCost').textContent = DEFormatter.price(materialMitGK);
 document.getElementById('matFormula').textContent = DEFormatter.weight(weightKg) + ' √ó ' + DEFormatter.price(mat.price) + '/kg + ' + zuschlagMGK + '% MGK';
 document.getElementById('machCost').textContent = DEFormatter.price(fertigungMitAV);
 if (currentProject?.operations) {
 document.getElementById('machFormula').textContent = DEFormatter.time(machiningTime) + ' (' + currentProject.operations.length + ' AGs, gemischte S√§tze) + ' + zuschlagAV + '% AV';
 } else {
 document.getElementById('machFormula').textContent = DEFormatter.time(machiningTime) + ' √ó EUR ' + cncRate + '/h + ' + zuschlagAV + '% AV';
 }
 const _set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
 _set('setupCost', DEFormatter.price(setupCostPerPiece));
 _set('setupFormula', DEFormatter.time(totalSetupTime) + ' √ó EUR ' + cncRate + '/h √∑ ' + qty);
 _set('toolCost', DEFormatter.price(toolCost));
 _set('additionalCost', DEFormatter.price(vwGKBetrag + vtGKBetrag));
 _set('additionalFormula', zuschlagVwGK + '% VwGK + ' + zuschlagVtGK + '% VtGK');
 _set('totalCost', DEFormatter.price(selbstkosten));
 _set('marginDisplay', zuschlagGewinn);
 _set('marginCost', DEFormatter.price(gewinnBetrag));
 _set('sellPrice', DEFormatter.price(angebotspreis));
 _set('orderTotal', DEFormatter.price(orderTotal));
 
 // === COST DETAIL PANELS (transparency) ===
 const cd = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
 const cdB = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = '<strong>' + val + '</strong>'; };
 
 // Material detail
 cd('cdMatDims', x + ' √ó ' + y + ' √ó ' + z + ' mm');
 cd('cdMatVol', Math.round(volumeCm3 * 1000).toLocaleString('de-DE') + ' mm¬≥');
 cd('cdMatDensity', mat.name + ' / ' + mat.density.toFixed(2).replace('.',',') + ' g/cm¬≥');
 cd('cdMatWeight', DEFormatter.weight(weightKg));
 cd('cdMatPrice', DEFormatter.price(mat.price) + '/kg');
 cd('cdMatNet', DEFormatter.price(weightKg * mat.price));
 cd('cdMatScrap', DEFormatter.price(weightKg * mat.price * scrap / 100));
 cd('cdMatMEK', DEFormatter.price(materialCost));
 cd('cdMatMGK', DEFormatter.price(materialCost * zuschlagMGK / 100));
 cdB('cdMatTotal', DEFormatter.price(materialMitGK));
 
 // Fertigung detail
 cd('cdMachTime', DEFormatter.time(machiningTime));
 if (currentProject?.operations) {
 cd('cdMachLabor', currentProject.operations.length + ' Arbeitsg√§nge');
 cd('cdMachRate', 'gemischte S√§tze');
 cd('cdMachTotal', '‚Üí Fertigungsanweisung');
 } else {
 cd('cdMachLabor', 'EUR ' + RATES.cnc.labor + '/h');
 cd('cdMachRate', 'EUR ' + RATES.cnc.machine + '/h');
 cd('cdMachTotal', 'EUR ' + cncRate + '/h');
 }
 cd('cdMachNet', DEFormatter.price(machineCost));
 cd('cdMachFEK', DEFormatter.price(machineCost));
 cd('cdMachAV', DEFormatter.price(machineCost * zuschlagAV / 100));
 cdB('cdMachGesamt', DEFormatter.price(fertigungMitAV));
 
 // Setup detail
 cd('cdSetupClamping', document.getElementById('clampingSelect')?.selectedOptions[0]?.text || 'Schraubstock');
 cd('cdSetupBase', DEFormatter.time(CLAMPING[document.getElementById('clampingSelect')?.value || 'schraubstock'].time));
 cd('cdSetupCount', setupCount);
 cd('cdSetupTime', DEFormatter.time(totalSetupTime));
 cd('cdSetupTotal', DEFormatter.price(setupCost));
 cd('cdSetupQty', qty);
 cdB('cdSetupPerPiece', DEFormatter.price(setupCostPerPiece));
 
 // Tool detail
 cd('cdToolFactor', mat.timeFactor.toFixed(1).replace('.',',') + '√ó');
 cd('cdToolTime', DEFormatter.time(machiningTime));
 cdB('cdToolTotal', DEFormatter.price(toolCost));
 cd('toolFormula', mat.timeFactor > 1 ? 'EUR 20,74 √ó ' + mat.timeFactor.toFixed(1).replace('.',',') + ' (Werkstoff-Faktor)' : 'Pauschale, werkstoffabh√§ngig');
 
 // Overhead detail
 cd('cdOhHK', DEFormatter.price(herstellkosten));
 cd('cdOhVwGK', DEFormatter.price(vwGKBetrag));
 cd('cdOhVtGK', DEFormatter.price(vtGKBetrag));
 cdB('cdOhTotal', DEFormatter.price(vwGKBetrag + vtGKBetrag));
 
 // === DECKUNGSBEITRAGSRECHNUNG ===
 const dbMEK = materialCost; // Materialeinzelkosten (vor MGK)
 const dbFEK = machineCost; // Fertigungseinzelkosten (vor AV)
 const dbSetup = setupCostPerPiece;
 const dbDB1 = angebotspreis - dbMEK - dbFEK - dbSetup;
 const dbMGKval = materialCost * zuschlagMGK / 100;
 const dbAVval = machineCost * zuschlagAV / 100;
 const dbDB2 = dbDB1 - dbMGKval - dbAVval - toolCost;
 const dbGewinn = angebotspreis - selbstkosten;
 const dbMargePercent = angebotspreis > 0 ? (dbGewinn / angebotspreis * 100) : 0;
 
 // Per-piece column
 cd('dbAngebotspreis', DEFormatter.price(angebotspreis));
 cd('dbMEK', DEFormatter.price(dbMEK));
 cd('dbFEK', DEFormatter.price(dbFEK));
 cd('dbSetup', DEFormatter.price(dbSetup));
 cd('dbDB1', DEFormatter.price(dbDB1));
 cd('dbMGKpct', zuschlagMGK);
 cd('dbMGK', DEFormatter.price(dbMGKval));
 cd('dbAVpct', zuschlagAV);
 cd('dbAV', DEFormatter.price(dbAVval));
 cd('dbTool', DEFormatter.price(toolCost));
 cd('dbDB2', DEFormatter.price(dbDB2));
 cd('dbVwGKpct', zuschlagVwGK);
 cd('dbVwGK', DEFormatter.price(vwGKBetrag));
 cd('dbVtGKpct', zuschlagVtGK);
 cd('dbVtGK', DEFormatter.price(vtGKBetrag));
 cd('dbGewinn', DEFormatter.price(dbGewinn));
 cd('dbMarge', dbMargePercent.toFixed(1).replace('.',',') + ' %');
 
 // Order column (√ó qty)
 cd('dbQtyHead', qty);
 cd('dbAngebotspreis_t', DEFormatter.price(angebotspreis * qty));
 cd('dbMEK_t', DEFormatter.price(dbMEK * qty));
 cd('dbFEK_t', DEFormatter.price(dbFEK * qty));
 cd('dbSetup_t', DEFormatter.price(setupCost)); // R√ºstkosten sind fix, nicht √ó qty
 cd('dbDB1_t', DEFormatter.price((angebotspreis - dbMEK - dbFEK) * qty - setupCost));
 cd('dbMGK_t', DEFormatter.price(dbMGKval * qty));
 cd('dbAV_t', DEFormatter.price(dbAVval * qty));
 cd('dbTool_t', DEFormatter.price(toolCost * qty));
 cd('dbDB2_t', DEFormatter.price(((angebotspreis - dbMEK - dbFEK) * qty - setupCost) - (dbMGKval + dbAVval + toolCost) * qty));
 cd('dbVwGK_t', DEFormatter.price(vwGKBetrag * qty));
 cd('dbVtGK_t', DEFormatter.price(vtGKBetrag * qty));
 const totalGewinn = dbGewinn * qty;
 cd('dbGewinn_t', DEFormatter.price(totalGewinn));
 const totalUmsatz = angebotspreis * qty;
 cd('dbMarge_t', totalUmsatz > 0 ? (totalGewinn / totalUmsatz * 100).toFixed(1).replace('.',',') + ' %' : '‚Äî');
 
 // Quantity table with full Zuschlagskalkulation
 const qtys = [1, 5, 10, 25, 50];
 document.getElementById('quantityTable').innerHTML = qtys.map(q =>{
 const setupPerPiece = setupCost / q;
 const fert = machineCost + setupPerPiece + additionalCost;
 const fertMitAV = fert * (1 + zuschlagAV / 100);
 const hk = materialMitGK + fertMitAV + toolCost;
 const sk = hk * (1 + (zuschlagVwGK + zuschlagVtGK) / 100);
 const ap = sk * (1 + zuschlagGewinn / 100);
 const totalSell = ap * q;
 return `<tr>
<td class="mono">${q}</td>
<td class="right mono">${DEFormatter.price(ap)}</td>
<td class="right mono">${DEFormatter.price(totalSell)}</td>
</tr>`;
 }).join('');
 
 // Quote ‚Äî handled by renderQuote() in QUOTE SECTION UPDATE below
 // Old manual quote updates removed to prevent format conflicts with DEFormatter
 
 // Detail Kalkulation Tab (section-calculation)
 const calcThEl = document.getElementById('calcTh');
 if (calcThEl) {
     document.getElementById('calcTh').textContent = DEFormatter.time(machiningTime * 0.8);
     document.getElementById('calcTn').textContent = DEFormatter.time(machiningTime * 0.2);
     document.getElementById('calcTimeTotal').textContent = DEFormatter.time(machiningTime);
     document.getElementById('calcMachCost').textContent = DEFormatter.price(machineCost);
     document.getElementById('calcRawDims').textContent = x + ' √ó ' + y + ' √ó ' + z + ' mm';
     document.getElementById('calcVolume').textContent = Math.round(volumeCm3 * 1000).toLocaleString('de-DE') + ' mm¬≥';
     document.getElementById('calcDensity').textContent = mat.name + ' / ' + mat.density.toFixed(2).replace('.', ',') + ' g/cm¬≥';
     document.getElementById('calcWeight').textContent = DEFormatter.weight(weightKg);
     document.getElementById('calcMatFormula').textContent = DEFormatter.price(mat.price) + '/kg √ó 1,1';
     document.getElementById('calcMatCost').textContent = DEFormatter.price(materialCost);
     document.getElementById('calcSetupTime').textContent = DEFormatter.time(totalSetupTime);
     document.getElementById('calcSetupCostDetail').textContent = DEFormatter.price(setupCost);
     document.getElementById('calcSetups').textContent = (document.getElementById('secondSetup')?.checked ? '2' : '1') + '√ó';
     document.getElementById('calcQtyDetail').textContent = qty;
     document.getElementById('calcSetupPerPiece').textContent = DEFormatter.price(setupCostPerPiece);
     
     // Gesamtkalkulation Summary Table
     const summaryBody = document.getElementById('calcSummaryBody');
     if (summaryBody) {
         const nebenzeitKosten = machineCost * 0.12; // ~12% der Maschinenkosten
         const herstellkosten = materialMitGK + fertigungMitAV + toolCost + setupCostPerPiece + nebenzeitKosten;
         summaryBody.innerHTML = `
         <tr>
             <td>Material</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">${DEFormatter.weight(weightKg)} √ó ${DEFormatter.price(mat.price)}/kg + ${zuschlagMGK}% MGK</td>
             <td class="right mono">${DEFormatter.price(materialMitGK)}</td>
             <td class="right mono">${DEFormatter.price(materialMitGK * qty)}</td>
         </tr>
         <tr>
             <td>Fertigung${currentProject?.operations ? ' ('+currentProject.operations.length+' AGs)' : ''}</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">${currentProject?.operations ? DEFormatter.time(machiningTime) + ' (ops-basiert)' : DEFormatter.time(machiningTime) + ' √ó EUR ' + cncRate + '/h'} + ${zuschlagAV}% AV</td>
             <td class="right mono">${DEFormatter.price(fertigungMitAV)}</td>
             <td class="right mono">${DEFormatter.price(fertigungMitAV * qty)}</td>
         </tr>
         <tr>
             <td>Werkzeugverschlei√ü</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">pauschal (werkstoffabh.)</td>
             <td class="right mono">${DEFormatter.price(toolCost)}</td>
             <td class="right mono">${DEFormatter.price(toolCost * qty)}</td>
         </tr>
         <tr style="background: var(--color-warning-light);">
             <td>Einrichtung</td>
             <td class="right mono" style="color: var(--color-warning); font-size: 12px;">${DEFormatter.time(totalSetupTime)} √ó EUR ${cncRate}/h √∑ ${qty}</td>
             <td class="right mono" style="color: var(--color-warning);">${DEFormatter.price(setupCostPerPiece)}</td>
             <td class="right mono">${DEFormatter.price(setupCost)}</td>
         </tr>
         <tr style="background: var(--color-bg);">
             <td>Nebenzeiten</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">Entgraten + Pr√ºfung</td>
             <td class="right mono">${DEFormatter.price(nebenzeitKosten)}</td>
             <td class="right mono">${DEFormatter.price(nebenzeitKosten * qty)}</td>
         </tr>
         <tr style="background: var(--color-bg); font-weight: 600;">
             <td>HERSTELLKOSTEN</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(selbstkosten)}</td>
             <td class="right mono">${DEFormatter.price(selbstkosten * qty)}</td>
         </tr>
         <tr>
             <td>+ Marge ${zuschlagGewinn}%</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(gewinnBetrag)}</td>
             <td class="right mono">${DEFormatter.price(gewinnBetrag * qty)}</td>
         </tr>
         <tr style="background: var(--color-primary); color: white; font-weight: 600;">
             <td>VERKAUFSPREIS</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(angebotspreis)}</td>
             <td class="right mono">${DEFormatter.price(orderTotal)}</td>
         </tr>`;
     }
 }
 
 // Instructions
 document.getElementById('faMaterial').innerHTML = '<strong>' + mat.name + '</strong>';
 document.getElementById('faRawDims').textContent = x + ' √ó ' + y + ' √ó ' + z + ' mm';
 document.getElementById('faWeight').textContent = DEFormatter.weight(weightKg);
 document.getElementById('faMachiningTime').innerHTML = '<strong>' + DEFormatter.time(machiningTime) + '</strong>';
 
 // ================================================================
 // QUOTE SECTION UPDATE (renderQuote with calculated data)
 // ================================================================
 const partName = currentProject ? currentProject.name : document.getElementById('partName')?.value || 'Bauteil';
 const drawingNumber = currentProject ? currentProject.partNumber : document.getElementById('partNumber')?.value || '';
 const materialName = mat.name || document.getElementById('materialSelect').value;
 
 const quoteData = {
     parts: [{
         name: partName,
         drawingNumber: drawingNumber,
         material: materialName,
         quantity: qty,
         price: angebotspreis,
         articleNumber: 'E-CNC-0001'
     }]
 };
 
 renderQuote(quoteData);
 
 // Plausibility warnings
 checkPlausibility(x, y, z, mat, clampingType);
 }
 
 function checkPlausibility(x, y, z, mat, clamping) {
 const partWarnings = [];
 const calcWarnings = [];
 
 // Werkst√ºck/Aufspannung ‚Üí Teil-Bereich
 if (x > 400 && clamping === 'schraubstock') {
 partWarnings.push({ type: 'warning', text: `L√§nge ${x} mm: Pr√ºfen ob Schraubstock-Kapazit√§t ausreicht. 2√ó Schraubstock oder Tischspannung empfohlen.` });
 }
 if (z > 100) {
 partWarnings.push({ type: 'warning', text: `H√∂he ${z} mm: Werkzeug√ºberhang beachten. Vibrationsgefahr bei tiefen Taschen.` });
 }
 if (Math.max(x,y) / Math.min(x,y,z) > 10) {
 partWarnings.push({ type: 'info', text: `Ung√ºnstiges Seitenverh√§ltnis: Durchbiegung/Vibration pr√ºfen.` });
 }
 
 // Fertigung/Material ‚Üí Kalkulations-Bereich
 if (mat.timeFactor > 1.3) {
 calcWarnings.push({ type: 'info', text: `Schwerzerspanbarer Werkstoff (${mat.name}): Reduzierte Schnittdaten, erh√∂hter Werkzeugverschlei√ü.` });
 }
 
 const renderWarnings = (container, warnings) => {
 if (!container) return;
 container.innerHTML = warnings.length > 0 ? warnings.map(w => `
<div class="${w.type === 'warning' ? 'warning-box' : 'info-box'}" style="margin-bottom: var(--space-3);">
<strong>${w.type === 'warning' ? 'Warnung' : 'Hinweis'}:</strong> ${w.text}
</div>`).join('') : '';
 };
 
 renderWarnings(document.getElementById('partWarningsContainer'), partWarnings);
 renderWarnings(document.getElementById('warningsContainer'), calcWarnings);
 }
 
 // ================================================================
 // SETTINGS
 // ================================================================
 
 function updateRates() {
 RATES.cnc.labor = parseFloat(document.getElementById('rateCncLabor').value) || 38;
 RATES.cnc.machine = parseFloat(document.getElementById('rateCncMachine').value) || 32;
 RATES.saegen.labor = parseFloat(document.getElementById('rateSaegenLabor').value) || 35;
 RATES.saegen.machine = parseFloat(document.getElementById('rateSaegenMachine').value) || 10;
 RATES.entgraten.labor = parseFloat(document.getElementById('rateEntgratenLabor').value) || 28;
 RATES.entgraten.machine = parseFloat(document.getElementById('rateEntgratenMachine').value) || 3;
 
 document.getElementById('rateCncTotal').textContent = 'EUR ' + (RATES.cnc.labor + RATES.cnc.machine);
 document.getElementById('rateSaegenTotal').textContent = 'EUR ' + (RATES.saegen.labor + RATES.saegen.machine);
 document.getElementById('rateEntgratenTotal').textContent = 'EUR ' + (RATES.entgraten.labor + RATES.entgraten.machine);
 
 calculate();
 }
 
 function updateMaterials() {
 MATERIALS['S235JR'].price = parseFloat(document.getElementById('matS235JR').value) || 1.40;
 MATERIALS['S355J2'].price = parseFloat(document.getElementById('matS355J2')?.value) || 3.00;
 MATERIALS['C45'].price = parseFloat(document.getElementById('matC45')?.value) || 1.80;
 MATERIALS['1.4301'].price = parseFloat(document.getElementById('mat14301')?.value) || 4.80;
 MATERIALS['1.4404'].price = parseFloat(document.getElementById('mat14404')?.value) || 5.50;
 MATERIALS['1.4571'].price = parseFloat(document.getElementById('mat14571').value) || 5.20;
 MATERIALS['AlMg3'].price = parseFloat(document.getElementById('matAlMg3').value) || 4.50;
 MATERIALS['AlMgSi1'].price = parseFloat(document.getElementById('matAlMgSi1')?.value) || 4.80;
 MATERIALS['42CrMo4'].price = parseFloat(document.getElementById('mat42CrMo4').value) || 2.20;
 calculate();
 }
 
 function saveSettings() {
 const settings = { 
     RATES, 
     MATERIALS,
     firma: {
         name: document.getElementById('firmaName')?.value,
         ansprech: document.getElementById('firmaAnsprech')?.value,
         strasse: document.getElementById('firmaStrasse')?.value,
         ort: document.getElementById('firmaOrt')?.value,
         tel: document.getElementById('firmaTel')?.value,
         email: document.getElementById('firmaEmail')?.value,
         steuer: document.getElementById('firmaSteuer')?.value,
         iban: document.getElementById('firmaIBAN')?.value
     },
     angebot: {
         gueltigkeit: document.getElementById('angebotsGueltigkeit')?.value,
         lieferzeit: document.getElementById('standardLieferzeit')?.value,
         zahlungsziel: document.getElementById('zahlungsziel')?.value
     }
 };
 localStorage.setItem('cncplanner_settings_v18', JSON.stringify(settings));
 syncSettingsToQuote();
 alert('Einstellungen gespeichert und auf Angebot √ºbertragen.');
 }
 
 function loadSettings() {
 const saved = localStorage.getItem('cncplanner_settings_v18') || localStorage.getItem('cncplanner_settings_v16');
 if (saved) {
 try {
     const settings = JSON.parse(saved);
     if (settings.RATES) Object.assign(RATES, settings.RATES);
     if (settings.MATERIALS) Object.assign(MATERIALS, settings.MATERIALS);
     if (settings.firma) {
         if (settings.firma.name) document.getElementById('firmaName').value = settings.firma.name;
         if (settings.firma.ansprech) document.getElementById('firmaAnsprech').value = settings.firma.ansprech;
         if (settings.firma.strasse) document.getElementById('firmaStrasse').value = settings.firma.strasse;
         if (settings.firma.ort) document.getElementById('firmaOrt').value = settings.firma.ort;
         if (settings.firma.tel) document.getElementById('firmaTel').value = settings.firma.tel;
         if (settings.firma.email) document.getElementById('firmaEmail').value = settings.firma.email;
         if (settings.firma.steuer) document.getElementById('firmaSteuer').value = settings.firma.steuer;
         if (settings.firma.iban) document.getElementById('firmaIBAN').value = settings.firma.iban;
     }
     if (settings.angebot) {
         if (settings.angebot.gueltigkeit) document.getElementById('angebotsGueltigkeit').value = settings.angebot.gueltigkeit;
         if (settings.angebot.lieferzeit) document.getElementById('standardLieferzeit').value = settings.angebot.lieferzeit;
         if (settings.angebot.zahlungsziel) document.getElementById('zahlungsziel').value = settings.angebot.zahlungsziel;
     }
     syncSettingsToQuote();
 } catch(e) { console.warn('Settings load error:', e); }
 }
 }
 
 function resetSettings() {
 localStorage.removeItem('cncplanner_settings_v16');
 location.reload();
 }
 
 // ================================================================
 // FEEDBACK SYSTEM
 // ================================================================
 
 // Initialize feedback storage
 let feedbackHistory = JSON.parse(localStorage.getItem('cncplanner_feedback') || '[]');
 
 function showFeedbackTab(tab) {
 // Hide all tabs
 ['dashboard', 'eingabe', 'learnings', 'historie'].forEach(t => {
 const el = document.getElementById('feedback-' + t);
 if (el) el.style.display = 'none';
 });
 
 // Reset all buttons
 ['Dashboard', 'Eingabe', 'Learnings', 'Historie'].forEach(t => {
 const el = document.getElementById('tabFeedback' + t);
 if (el) el.className = 'btn btn-sm btn-secondary';
 });
 
 // Show selected tab
 document.getElementById('feedback-' + tab).style.display = 'block';
 document.getElementById('tabFeedback' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 'btn btn-sm btn-primary';
 
 // Update displays
 if (tab === 'learnings') updateCrossLearnings();
 if (tab === 'historie') updateFeedbackHistory();
 }
 
 function toggleAblehnungsgrund() {
 const status = document.getElementById('fbAuftragsstatus')?.value;
 const box = document.getElementById('fbAblehnungBox');
 if (box) box.style.display = status === 'abgelehnt' ? 'block' : 'none';
 }
 
 function updateFeedbackSummary() {
 const rows = document.querySelectorAll('#feedbackOpsTable tr');
 let filled = 0, totalSoll = 0, totalIst = 0;
 rows.forEach(r => {
 const sollCell = r.cells[2];
 const istInput = r.querySelector('input[type="number"]');
 if (sollCell && istInput && istInput.value) {
 filled++;
 const soll = parseFloat(sollCell.textContent.replace(',','.')) || 0;
 const ist = parseFloat(istInput.value) || 0;
 totalSoll += soll;
 totalIst += ist;
 }
 });
 // Setup row
 const setupIst = parseFloat(document.getElementById('fbSetupIst')?.value) || 0;
 const setupSoll = 25;
 if (setupIst > 0) { totalSoll += setupSoll; totalIst += setupIst; filled++; }
 
 const totalOps = rows.length + 1; // +1 for setup
 const el = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
 
 el('fbSummaryOps', filled + ' / ' + totalOps);
 
 if (filled > 0 && totalSoll > 0) {
 const deltaPct = ((totalIst - totalSoll) / totalSoll * 100);
 const sign = deltaPct > 0 ? '+' : '';
 const color = Math.abs(deltaPct) <= 10 ? 'var(--color-success)' : deltaPct > 20 ? 'var(--color-error)' : 'var(--color-warning)';
 const deltaEl = document.getElementById('fbSummaryDelta');
 if (deltaEl) { deltaEl.textContent = sign + deltaPct.toFixed(0).replace('.',',') + ' %'; deltaEl.style.color = color; }
 
 const costDiff = (totalIst - totalSoll) / 60 * 91; // EUR 91/h
 const costEl = document.getElementById('fbSummaryCost');
 if (costEl) { costEl.textContent = (costDiff > 0 ? '+' : '') + DEFormatter.price(costDiff); costEl.style.color = color; }
 }
 }
 
 function updateFeedbackDelta(input) {
 const row = input.closest('tr');
 const kalkCell = row.cells[2].textContent;
 const kalkMin = parseFloat(kalkCell.replace(',', '.').replace(' min', ''));
 const istMin = parseFloat(input.value) || 0;
 const deltaCell = row.querySelector('[data-delta]');
 
 if (istMin >0) {
 const delta = istMin - kalkMin;
 const sign = delta >= 0 ? '+' : '';
 deltaCell.textContent = sign + delta.toFixed(1).replace('.', ',') + ' min';
 deltaCell.style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 } else {
 deltaCell.textContent = '‚Äî';
 deltaCell.style.color = '';
 }
 
 updateGesamtzeit();
 updateFeedbackSummary();
 }
 
 function updateSetupDelta() {
 const kalk = 25; // Kalkulierte Setup-Zeit
 const ist = parseFloat(document.getElementById('fbSetupIst').value) || 0;
 const deltaEl = document.getElementById('fbSetupDelta');
 
 if (ist >0) {
 const delta = ist - kalk;
 const sign = delta >= 0 ? '+' : '';
 deltaEl.textContent = sign + delta + ' min';
 deltaEl.style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 } else {
 deltaEl.textContent = '‚Äî';
 deltaEl.style.color = '';
 }
 
 updateGesamtzeit();
 updateFeedbackSummary();
 }
 
 function updateGesamtzeit() {
 let gesamtIst = 0;
 let gesamtKalk = 42; // Demo value
 
 // Sum all OP times
 document.querySelectorAll('#feedbackOpsTable input[type="number"]').forEach(input =>{
 gesamtIst += parseFloat(input.value) || 0;
 });
 
 // Add setup
 gesamtIst += parseFloat(document.getElementById('fbSetupIst').value) || 0;
 
 if (gesamtIst >0) {
 document.getElementById('fbGesamtIst').textContent = gesamtIst.toFixed(1).replace('.', ',') + ' min';
 const delta = ((gesamtIst - gesamtKalk) / gesamtKalk * 100);
 const sign = delta >= 0 ? '+' : '';
 document.getElementById('fbGesamtDelta').textContent = sign + delta.toFixed(0) + '%';
 document.getElementById('fbGesamtDelta').style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 }
 }
 
 function saveFeedback() {
 const feedback = {
 id: Date.now(),
 projektNr: document.getElementById('fbProjektNr').value,
 datum: document.getElementById('fbDatum').value,
 erfasser: document.getElementById('fbErfasser').value || 'Anonym',
 zeitKalk: 42, // Demo
 zeitIst: parseFloat(document.getElementById('fbGesamtIst').textContent) || 42,
 setupKalk: 25,
 setupIst: parseFloat(document.getElementById('fbSetupIst').value) || 25,
 setupGrund: document.getElementById('fbSetupGrund').value,
 setupNotiz: document.getElementById('fbSetupNotiz').value,
 ergebnis: document.querySelector('input[name="fbErgebnis"]:checked')?.value || 'io_erst',
 empfehlung: document.getElementById('fbEmpfehlung').value,
 ops: []
 };
 
 // Collect OP data
 document.querySelectorAll('#feedbackOpsTable tr').forEach(row =>{
 const opCell = row.cells[0];
 if (opCell && opCell.textContent.startsWith('OP')) {
 const istInput = row.querySelector('input[type="number"]');
 const grundSelect = row.querySelector('select');
 const notizInput = row.querySelectorAll('input[type="text"]')[0];
 
 if (istInput && istInput.value) {
 feedback.ops.push({
 op: opCell.textContent,
 kalk: parseFloat(row.cells[2].textContent.replace(',', '.')) || 0,
 ist: parseFloat(istInput.value) || 0,
 grund: grundSelect?.value || '',
 notiz: notizInput?.value || ''
 });
 }
 }
 });
 
 // Save
 feedbackHistory.push(feedback);
 localStorage.setItem('cncplanner_feedback', JSON.stringify(feedbackHistory));
 
 alert(' Feedback gespeichert!\n\nDanke f√ºr die R√ºckmeldung. Das System lernt mit jedem Feedback.');
 clearFeedbackForm();
 }
 
 function clearFeedbackForm() {
 document.querySelectorAll('#feedbackOpsTable input').forEach(i =>i.value = '');
 document.querySelectorAll('#feedbackOpsTable select').forEach(s =>s.selectedIndex = 0);
 document.querySelectorAll('[data-delta]').forEach(d =>{ d.textContent = '‚Äî'; d.style.color = ''; });
 document.getElementById('fbSetupIst').value = '';
 document.getElementById('fbSetupDelta').textContent = '‚Äî';
 document.getElementById('fbSetupGrund').selectedIndex = 0;
 document.getElementById('fbSetupNotiz').value = '';
 document.getElementById('fbGesamtIst').textContent = '‚Äî min';
 document.getElementById('fbGesamtDelta').textContent = '‚Äî';
 document.getElementById('fbEmpfehlung').value = '';
 }
 
 function updateCrossLearnings() {
 const count = feedbackHistory.length;
 document.getElementById('feedbackCount').textContent = count;
 
 if (count >0) {
 // Calculate average deviation
 let totalDev = 0;
 feedbackHistory.forEach(f =>{
 totalDev += ((f.zeitIst - f.zeitKalk) / f.zeitKalk) * 100;
 });
 const avgDev = totalDev / count;
 document.getElementById('avgDeviation').textContent = (avgDev >= 0 ? '+' : '') + avgDev.toFixed(0) + '%';
 document.getElementById('avgDeviation').style.color = avgDev >15 ? 'var(--color-error)' : avgDev >0 ? 'var(--color-warning)' : 'var(--color-success)';
 }
 }
 
 function updateFeedbackHistory() {
 const tbody = document.getElementById('feedbackHistoryTable');
 if (feedbackHistory.length === 0) return;
 
 // Add real feedback to table (prepend to demo data)
 const realRows = feedbackHistory.slice(-5).reverse().map(f =>{
 const delta = ((f.zeitIst - f.zeitKalk) / f.zeitKalk * 100);
 const deltaColor = delta >10 ? 'var(--color-error)' : delta< -5 ? 'var(--color-success)' : 'var(--color-warning)';
 const ergebnis = f.ergebnis === 'io_erst' || f.ergebnis === 'io_korrektur' ? ' i.O.' : f.ergebnis === 'nacharbeit' ? ' Nacharbeit' : ' Ausschuss';
 
 return `<tr>
<td class="mono">${f.datum.split('-').reverse().join('.')}</td>
<td class="mono">${f.projektNr}</td>
<td>${f.erfasser}</td>
<td class="mono right">${f.zeitKalk} min</td>
<td class="mono right">${f.zeitIst.toFixed(0)} min</td>
<td class="mono right" style="color: ${deltaColor};">${delta >= 0 ? '+' : ''}${delta.toFixed(0)}%</td>
<td>${f.setupGrund || '‚Äî'}</td>
<td>${ergebnis}</td>
</tr>`;
 }).join('');
 }
 
 function applyPattern(patternId, value) {
 // Apply pattern to calculation
 if (patternId === 'setup_parallel') {
 alert(' Muster angewendet!\n\nSetup-Zeit bei Parallelspanner wird um +' + value + ' min erh√∂ht.');
 localStorage.setItem('pattern_setup_parallel', value);
 } else if (patternId === 'tolerance_factor') {
 alert(' Muster angewendet!\n\nToleranz-Faktor f√ºr h5/H7 auf ' + value + '√ó gesetzt.');
 localStorage.setItem('pattern_tolerance_factor', value);
 } else if (patternId === 's235_aufmass') {
 alert(' Muster angewendet!\n\nRohteil-Aufma√ü f√ºr S235 auf ' + value + ' mm gesetzt.');
 localStorage.setItem('pattern_s235_aufmass', value);
 }
 }
 
 function ignorePattern(patternId) {
 alert('Muster ignoriert. Wird bei gen√ºgend neuen Feedbacks erneut gepr√ºft.');
 }
 
 function exportFeedbackCSV() {
 if (feedbackHistory.length === 0) {
 alert('Keine Feedback-Daten vorhanden.');
 return;
 }
 
 let csv = 'Datum;Projekt;Erfasser;Kalk (min);Ist (min);Delta %;Grund;Ergebnis;Empfehlung\n';
 feedbackHistory.forEach(f =>{
 const delta = ((f.zeitIst - f.zeitKalk) / f.zeitKalk * 100).toFixed(0);
 csv += `${f.datum};${f.projektNr};${f.erfasser};${f.zeitKalk};${f.zeitIst};${delta};${f.setupGrund};${f.ergebnis};${f.empfehlung}\n`;
 });
 
 const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
 const link = document.createElement('a');
 link.href = URL.createObjectURL(blob);
 link.download = 'cnc_feedback_export.csv';
 link.click();
 }
 
 function showSettingsTab(tab) {
 // Hide all tabs
 { const _e = document.getElementById('settings-stunden'); if(_e) _e.style.display = 'none'; }
 { const _e = document.getElementById('settings-material'); if(_e) _e.style.display = 'none'; }
 { const _e = document.getElementById('settings-zuschlag'); if(_e) _e.style.display = 'none'; }
 document.getElementById('settings-firma').style.display = 'none';
 
 // Reset all buttons
 { const _e = document.getElementById('tabStunden'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabMaterial'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabZuschlag'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabFirma'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 
 // Show selected tab
 document.getElementById('settings-' + tab).style.display = 'block';
 document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 'btn btn-sm btn-primary';
 }
 
 function exportSettings() {
 const settings = { RATES, MATERIALS };
 const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'cncplanner-settings.json';
 a.click();
 }
 
 function importSettings() {
 alert('Import-Funktion: Datei ausw√§hlen (Coming soon)');
 }
 
 // ================================================================
 // EXPORT
 // ================================================================
 
 function previewLogo(input) {
 const preview = document.getElementById('logoPreview');
 if (input.files && input.files[0]) {
 const reader = new FileReader();
 reader.onload = function(e) {
 preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
 localStorage.setItem('cncplanner_logo', e.target.result);
 };
 reader.readAsDataURL(input.files[0]);
 }
 }
 
 function updatePriceCompare() {
 const compareEl = document.getElementById('comparePrice');
 const resultEl = document.getElementById('priceCompareResult');
 const barEl = document.getElementById('priceCompareBar');
 if (!compareEl || !resultEl) return;
 
 const compare = parseFloat(compareEl.value);
 const sellEl = document.getElementById('sellPrice');
 const ownText = sellEl ? sellEl.textContent.replace(/[^0-9,.-]/g,'').replace('.','').replace(',','.') : '0';
 const own = parseFloat(ownText) || 0;
 
 if (!compare || compare <= 0 || own <= 0) {
 resultEl.innerHTML = '<span style="color:var(--color-text-muted);">Vergleichspreis eingeben</span>';
 barEl.innerHTML = '';
 return;
 }
 
 const diff = own - compare;
 const pct = ((diff / compare) * 100);
 const isHigher = diff > 0;
 const color = isHigher ? 'var(--color-error)' : 'var(--color-success)';
 const sign = isHigher ? '+' : '';
 
 resultEl.innerHTML = `
 <span style="font-weight:600;color:${color};">${sign}${pct.toFixed(1).replace('.',',')} %</span>
 <span style="color:var(--color-text-muted);"> (${sign}${DEFormatter.price(diff)})</span><br>
 <span style="font-size:12px;color:var(--color-text-muted);">Eigene Kalkulation vs. Vergleich</span>
 `;
 
 const maxVal = Math.max(own, compare);
 const ownW = (own / maxVal * 100);
 const compW = (compare / maxVal * 100);
 barEl.innerHTML = `
 <div style="font-size:11px;color:var(--color-text-muted);margin-bottom:2px;">Eigene</div>
 <div style="height:12px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;margin-bottom:4px;">
 <div style="width:${ownW}%;height:100%;background:${color};border-radius:3px;"></div>
 </div>
 <div style="font-size:11px;color:var(--color-text-muted);margin-bottom:2px;">Vergleich</div>
 <div style="height:12px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
 <div style="width:${compW}%;height:100%;background:var(--color-primary);border-radius:3px;"></div>
 </div>
 `;
 }
 
 function exportCSV() {
 alert('CSV Export ‚Äî Coming soon');
 }
 
 function copyCode() {
 const code = document.querySelector('#codeBlock pre').textContent;
 navigator.clipboard.writeText(code);
 alert('Code kopiert!');
 }
 
 function downloadCode() {
 const code = document.querySelector('#codeBlock pre').textContent;
 const blob = new Blob([code], { type: 'text/plain' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'programm.h';
 a.click();
 }
 
 function setCodeFormat(format) {
 document.querySelectorAll('[id^="btn"]').forEach(btn =>{
 btn.classList.remove('btn-primary');
 btn.classList.add('btn-secondary');
 });
 document.getElementById('btn' + format.charAt(0).toUpperCase() + format.slice(1)).classList.remove('btn-secondary');
 document.getElementById('btn' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('btn-primary');
 // TODO: Switch code templates
 }
 
 // ================================================================
 // LOADING ANIMATION
 // ================================================================
 
 function showLoading() {
 document.getElementById('loadingOverlay').classList.add('active');
 animateLoadingSteps();
 }
 
 function hideLoading() {
 document.getElementById('loadingOverlay').classList.remove('active');
 document.querySelectorAll('.loading-step').forEach(step =>{
 step.classList.remove('active', 'done');
 });
 }
 
 function animateLoadingSteps() {
 const steps = ['loadStep1', 'loadStep2', 'loadStep3', 'loadStep4', 'loadStep5'];
 let i = 0;
 
 function nextStep() {
 if (i >0) {
 document.getElementById(steps[i - 1]).classList.remove('active');
 document.getElementById(steps[i - 1]).classList.add('done');
 document.getElementById(steps[i - 1]).querySelector('.loading-step-icon').textContent = '‚úì';
 }
 if (i< steps.length) {
 document.getElementById(steps[i]).classList.add('active');
 i++;
 setTimeout(nextStep, 400 + Math.random() * 200);
 } else {
 setTimeout(hideLoading, 300);
 }
 }
 
 nextStep();
 }
 
 // ================================================================
 // FEEDBACK
 // ================================================================
 
 let selectedFeedback = null;
 
 function selectFeedback(el, type) {
 document.querySelectorAll('.feedback-option').forEach(opt =>opt.classList.remove('selected'));
 el.classList.add('selected');
 selectedFeedback = type;
 }
 
 function submitFeedback() {
 const comment = document.getElementById('feedbackComment').value;
 if (!selectedFeedback && !comment) {
 alert('Bitte w√§hlen Sie eine Feedback-Option oder geben Sie einen Kommentar ein.');
 return;
 }
 
 // In production: send to server
 console.log('Feedback:', { type: selectedFeedback, comment, project: currentProject?.id });
 
 alert('Vielen Dank f√ºr Ihr Feedback! Wir nutzen es, um die Kalkulation zu verbessern.');
 
 // Reset
 document.querySelectorAll('.feedback-option').forEach(opt =>opt.classList.remove('selected'));
 document.getElementById('feedbackComment').value = '';
 selectedFeedback = null;
 }
 
 // ================================================================
 // INIT
 // ================================================================
 
 document.addEventListener('DOMContentLoaded', function() {
 loadSettings();
 renderPartGrid();
 calculate();
 initOpControls();
 
 // Initialize quote section
 calculateValidity();
 
 // Optional: Render quote with example data
 // Uncomment to auto-populate quote table:
 /*
 const exampleQuoteData = {
     parts: [{
         name: 'Verbindungsplatte',
         drawingNumber: '2500473.01.11.02.00.001',
         material: 'S235JR',
         quantity: 1,
         price: 170.76,
         articleNumber: 'E-CNC-0001'
     }]
 };
 renderQuote(exampleQuoteData);
 */
 });
</script>
</body>
</html>
