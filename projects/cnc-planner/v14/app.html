<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Planner Pro ‚Äî Fertigungsplanung & Kalkulation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* === DESIGN SYSTEM === */
        :root {
            --primary: #1e3a5f;
            --primary-dark: #152a45;
            --primary-light: #2d5a8a;
            --accent: #2563eb;
            --accent-dark: #1d4ed8;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --radius: 6px;
            --radius-lg: 12px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* === AUTH SCREEN === */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .auth-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }

        .auth-header {
            background: var(--gray-50);
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid var(--gray-200);
        }

        .auth-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0 auto 15px;
        }

        .auth-header h1 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        .auth-header p {
            color: var(--gray-500);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .auth-body {
            padding: 30px;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.15s;
        }

        .auth-tab:hover { color: var(--gray-700); }
        .auth-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .auth-footer {
            padding: 20px 30px;
            background: var(--gray-50);
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* === HEADER === */
        .header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .logo-text {
            font-weight: 700;
            color: var(--gray-900);
            font-size: 1.1rem;
        }

        .logo-text span { color: var(--primary); }

        .nav-menu {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-item {
            padding: 8px 16px;
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }

        .nav-item:hover { background: var(--gray-100); color: var(--gray-900); }
        .nav-item.active { background: var(--primary); color: white; }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }

        .user-menu:hover { background: var(--gray-100); }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-info { text-align: right; }
        .user-name { font-weight: 500; font-size: 0.9rem; }
        .user-role { font-size: 0.75rem; color: var(--gray-500); }

        /* === BUTTONS === */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.15s;
            border: none;
            cursor: pointer;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-accent:hover { background: var(--accent-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-secondary { background: white; color: var(--gray-700); border: 1px solid var(--gray-300); }
        .btn-secondary:hover { background: var(--gray-50); }
        .btn-ghost { background: transparent; color: var(--gray-600); }
        .btn-ghost:hover { background: var(--gray-100); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-lg { padding: 14px 28px; font-size: 1rem; }
        .btn-block { width: 100%; }

        /* === FORM ELEMENTS === */
        .form-group { margin-bottom: 18px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.15s;
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        .form-input::placeholder { color: var(--gray-400); }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        /* === PAGES === */
        .page { display: none; }
        .page.active { display: block; }

        /* === DASHBOARD === */
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .dashboard-subtitle {
            color: var(--gray-500);
            margin-top: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* === PROJECT CARDS === */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.2s;
            cursor: pointer;
        }

        .project-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .project-card-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .project-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .project-card-subtitle {
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .project-card-body {
            padding: 20px;
        }

        .project-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .project-meta-item {
            font-size: 0.85rem;
        }

        .project-meta-label {
            color: var(--gray-500);
            font-size: 0.75rem;
        }

        .project-meta-value {
            font-weight: 500;
            color: var(--gray-800);
        }

        .project-card-footer {
            padding: 15px 20px;
            background: var(--gray-50);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-price {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .project-actions {
            display: flex;
            gap: 8px;
        }

        /* New Project Card */
        .new-project-card {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 250px;
        }

        .new-project-card:hover {
            border-color: var(--primary);
            background: white;
        }

        .new-project-icon {
            width: 60px;
            height: 60px;
            background: var(--gray-200);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: var(--gray-500);
        }

        .new-project-card:hover .new-project-icon {
            background: var(--primary);
            color: white;
        }

        .new-project-text {
            font-weight: 500;
            color: var(--gray-600);
        }

        /* === EDITOR === */
        .editor-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 60px);
        }

        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }
        }

        .editor-sidebar {
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            max-height: calc(100vh - 60px);
        }

        .editor-section {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .editor-section:last-child { border-bottom: none; }

        .editor-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .editor-section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* File Upload */
        .upload-zone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--gray-50);
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: white;
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(37, 99, 235, 0.05);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-text {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .upload-hint {
            color: var(--gray-400);
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .upload-preview {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
        }

        .upload-preview.active { display: block; }

        .upload-file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .upload-file-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            color: white;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .upload-file-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .upload-file-size {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Operations */
        .operations-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .operation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--gray-50);
            border-radius: var(--radius);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s;
        }

        .operation-item:hover {
            background: white;
            border-color: var(--gray-200);
        }

        .operation-item.selected {
            background: rgba(37, 99, 235, 0.08);
            border-color: var(--accent);
        }

        .operation-checkbox {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
        }

        .operation-info { flex: 1; }

        .operation-name {
            font-weight: 500;
            color: var(--gray-800);
            font-size: 0.9rem;
        }

        .operation-desc {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .operation-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--gray-600);
            background: var(--gray-200);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* Series Selector */
        .series-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .series-item {
            padding: 12px 8px;
            text-align: center;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.15s;
        }

        .series-item:hover {
            background: white;
            border-color: var(--gray-300);
        }

        .series-item.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .series-qty {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .series-label {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* === MAIN CONTENT === */
        .editor-main {
            background: var(--gray-100);
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 60px);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: white;
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .tab {
            padding: 10px 20px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--gray-600);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tab:hover { background: var(--gray-100); }
        .tab.active { background: var(--primary); color: white; }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Result Cards */
        .result-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .result-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gray-900);
        }

        .result-card-body {
            padding: 24px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table th {
            background: var(--gray-50);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--gray-600);
        }

        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover { background: var(--gray-50); }

        .data-table .right { text-align: right; }
        .data-table .center { text-align: center; }
        .data-table .mono { font-family: 'JetBrains Mono', monospace; }

        .total-row {
            font-weight: 600;
            background: var(--gray-50) !important;
        }

        /* NC Code */
        .code-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .code-tab {
            padding: 6px 14px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-600);
            background: var(--gray-100);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .code-tab:hover { background: var(--gray-200); }
        .code-tab.active { background: var(--primary); color: white; }

        .code-block {
            background: var(--gray-900);
            color: #e2e8f0;
            padding: 20px;
            border-radius: var(--radius);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .code-comment { color: #6b7280; }
        .code-keyword { color: #60a5fa; }
        .code-number { color: #34d399; }

        /* === MODAL === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gray-500);
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* === SETTINGS === */
        .settings-layout {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
        }

        .settings-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .settings-card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .settings-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--gray-900);
        }

        .settings-card-desc {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .settings-card-body {
            padding: 24px;
        }

        /* === NOTIFICATION === */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--gray-900);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .notification.active { display: flex; }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* === PRINT === */
        @media print {
            .header, .editor-sidebar, .tabs, .btn, .no-print { display: none !important; }
            .editor-main { max-height: none; overflow: visible; padding: 0; }
            .result-card { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
        }

        /* === UTILITIES === */
        .hidden { display: none !important; }
        .text-success { color: var(--success); }
        .text-danger { color: var(--danger); }
        .text-warning { color: var(--warning); }
        .text-muted { color: var(--gray-500); }
        .fw-bold { font-weight: 600; }
        .mt-2 { margin-top: 16px; }
        .mb-2 { margin-bottom: 16px; }
    </style>
</head>
<body>

<!-- ==================== AUTH SCREEN ==================== -->
<div id="authScreen" class="auth-screen">
    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-logo">CNC</div>
            <h1>CNC Planner Pro</h1>
            <p>Fertigungsplanung & Kalkulation</p>
        </div>
        <div class="auth-body">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showAuthTab('login')">Anmelden</div>
                <div class="auth-tab" onclick="showAuthTab('register')">Registrieren</div>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="ihre@email.de" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block btn-lg">Anmelden</button>
                </div>
                <p class="text-muted" style="text-align: center; font-size: 0.85rem;">
                    Demo-Zugang: demo@cnc-planner.de / demo123
                </p>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="register(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Vorname</label>
                        <input type="text" class="form-input" id="regFirstName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nachname</label>
                        <input type="text" class="form-input" id="regLastName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Firma</label>
                    <input type="text" class="form-input" id="regCompany" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" class="form-input" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" class="form-input" id="regPassword" placeholder="Mind. 6 Zeichen" required minlength="6">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-block btn-lg">Konto erstellen</button>
                </div>
            </form>
        </div>
        <div class="auth-footer">
            <p>¬© 2026 CNC Planner Pro ¬∑ DIN 6584 konform ¬∑ ISO 2768</p>
        </div>
    </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="mainApp" class="hidden">
    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <a href="#" class="logo" onclick="showPage('dashboard')">
                <div class="logo-icon">CNC</div>
                <div class="logo-text">Planner <span>Pro</span></div>
            </a>
            
            <nav class="nav-menu">
                <a class="nav-item active" onclick="showPage('dashboard')" data-page="dashboard">Dashboard</a>
                <a class="nav-item" onclick="showPage('editor')" data-page="editor">Kalkulator</a>
                <a class="nav-item" onclick="showPage('settings')" data-page="settings">Einstellungen</a>
            </nav>
            
            <div class="header-right">
                <button class="btn btn-primary btn-sm" onclick="openNewProjectModal()">
                    + Neues Projekt
                </button>
                <div class="user-menu" onclick="logout()">
                    <div class="user-avatar" id="userAvatar">FZ</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Florian Z.</div>
                        <div class="user-role">Pro Account</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== DASHBOARD PAGE ==================== -->
    <div id="pageDashboard" class="page active">
        <div class="dashboard">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Dashboard</h1>
                    <p class="dashboard-subtitle" id="dashboardGreeting">Willkommen zur√ºck!</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="exportAllCSV()">
                        üìä Export CSV
                    </button>
                    <button class="btn btn-primary" onclick="openNewProjectModal()">
                        + Neues Projekt
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Projekte gesamt</div>
                    <div class="stat-value" id="statProjects">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Gesamtwert</div>
                    <div class="stat-value" id="statValue">‚Ç¨0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">√ò Projektpreis</div>
                    <div class="stat-value" id="statAvg">‚Ç¨0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fertigungszeit</div>
                    <div class="stat-value" id="statTime">0h</div>
                </div>
            </div>

            <!-- Projects Grid -->
            <h2 style="font-size: 1.2rem; margin-bottom: 20px; color: var(--gray-700);">Meine Projekte</h2>
            <div class="projects-grid" id="projectsGrid">
                <!-- Projects will be rendered here -->
            </div>
        </div>
    </div>

    <!-- ==================== EDITOR PAGE ==================== -->
    <div id="pageEditor" class="page">
        <div class="editor-layout">
            <!-- Sidebar -->
            <div class="editor-sidebar">
                <!-- File Upload -->
                <div class="editor-section">
                    <div class="editor-section-title">Zeichnung hochladen</div>
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Datei hier ablegen oder klicken</div>
                        <div class="upload-hint">PDF, DXF, STEP ¬∑ Max 50MB</div>
                        <input type="file" id="fileInput" hidden accept=".pdf,.dxf,.step,.stp" onchange="handleFileUpload(event)">
                    </div>
                    <div class="upload-preview" id="uploadPreview">
                        <div class="upload-file-info">
                            <div class="upload-file-icon" id="fileExt">PDF</div>
                            <div>
                                <div class="upload-file-name" id="fileName">-</div>
                                <div class="upload-file-size" id="fileSize">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Project Info -->
                <div class="editor-section">
                    <div class="editor-section-title">Projektdaten</div>
                    <div class="form-group">
                        <label class="form-label">Projektname</label>
                        <input type="text" class="form-input" id="projectName" value="Grundplatte CNC" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zeichnungsnummer</label>
                        <input type="text" class="form-input" id="drawingNo" placeholder="z.B. ZN-2026-001" onchange="calculate()">
                    </div>
                </div>

                <!-- Dimensions -->
                <div class="editor-section">
                    <div class="editor-section-title">Abmessungen (mm)</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">L√§nge</label>
                            <input type="number" class="form-input" id="dimLength" value="200" onchange="calculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Breite</label>
                            <input type="number" class="form-input" id="dimWidth" value="150" onchange="calculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">H√∂he</label>
                            <input type="number" class="form-input" id="dimHeight" value="40" onchange="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Material -->
                <div class="editor-section">
                    <div class="editor-section-title">Werkstoff</div>
                    <div class="form-group">
                        <select class="form-select" id="material" onchange="calculate()">
                            <optgroup label="Edelstahl">
                                <option value="1.4301">1.4301 (V2A)</option>
                                <option value="1.4404">1.4404 (V4A)</option>
                                <option value="1.4571">1.4571</option>
                            </optgroup>
                            <optgroup label="Baustahl">
                                <option value="S235JR" selected>S235JR</option>
                                <option value="S355J2">S355J2</option>
                                <option value="C45">C45</option>
                            </optgroup>
                            <optgroup label="Verg√ºtungsstahl">
                                <option value="42CrMo4">42CrMo4</option>
                                <option value="34CrNiMo6">34CrNiMo6</option>
                            </optgroup>
                            <optgroup label="Aluminium">
                                <option value="AlMg3">AlMg3</option>
                                <option value="AlMgSi1">AlMgSi1 (6082)</option>
                                <option value="Al7075">Al7075-T6</option>
                            </optgroup>
                            <optgroup label="Buntmetalle">
                                <option value="CuZn39Pb3">Messing CuZn39Pb3</option>
                                <option value="CuSn8">Bronze CuSn8</option>
                            </optgroup>
                            <optgroup label="Kunststoff">
                                <option value="POM">POM</option>
                                <option value="PA6">PA6 (Nylon)</option>
                                <option value="PEEK">PEEK</option>
                            </optgroup>
                            <optgroup label="Titan">
                                <option value="Ti6Al4V">Ti6Al4V (Grade 5)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <!-- Operations -->
                <div class="editor-section">
                    <div class="editor-section-title">Bearbeitungsschritte</div>
                    <div class="operations-list">
                        <label class="operation-item">
                            <input type="checkbox" class="operation-checkbox" data-op="planfraesen" checked onchange="calculate()">
                            <div class="operation-info">
                                <div class="operation-name">Planfr√§sen</div>
                                <div class="operation-desc">Oberseite planen</div>
                            </div>
                            <span class="operation-time" id="time-planfraesen">-</span>
                        </label>
                        <label class="operation-item">
                            <input type="checkbox" class="operation-checkbox" data-op="konturfraesen" checked onchange="calculate()">
                            <div class="operation-info">
                                <div class="operation-name">Konturfr√§sen</div>
                                <div class="operation-desc">Au√üenkontur fr√§sen</div>
                            </div>
                            <span class="operation-time" id="time-konturfraesen">-</span>
                        </label>
                        <label class="operation-item">
                            <input type="checkbox" class="operation-checkbox" data-op="taschen" checked onchange="calculate()">
                            <div class="operation-info">
                                <div class="operation-name">Taschenfr√§sen</div>
                                <div class="operation-desc">Innentaschen ausfr√§sen</div>
                            </div>
                            <span class="operation-time" id="time-taschen">-</span>
                        </label>
                        <label class="operation-item">
                            <input type="checkbox" class="operation-checkbox" data-op="bohren" onchange="calculate()">
                            <div class="operation-info">
                                <div class="operation-name">Bohren & Gewinde</div>
                                <div class="operation-desc">Bohrungen + Gewinde</div>
                            </div>
                            <span class="operation-time" id="time-bohren">-</span>
                        </label>
                        <label class="operation-item">
                            <input type="checkbox" class="operation-checkbox" data-op="schlichten" onchange="calculate()">
                            <div class="operation-info">
                                <div class="operation-name">Schlichten</div>
                                <div class="operation-desc">Oberfl√§che schlichten</div>
                            </div>
                            <span class="operation-time" id="time-schlichten">-</span>
                        </label>
                    </div>
                </div>

                <!-- Series -->
                <div class="editor-section">
                    <div class="editor-section-title">St√ºckzahl</div>
                    <div class="series-grid">
                        <div class="series-item active" onclick="setQuantity(1)">
                            <div class="series-qty">1</div>
                            <div class="series-label">Einzelst√ºck</div>
                        </div>
                        <div class="series-item" onclick="setQuantity(5)">
                            <div class="series-qty">5</div>
                            <div class="series-label">Kleinserie</div>
                        </div>
                        <div class="series-item" onclick="setQuantity(10)">
                            <div class="series-qty">10</div>
                            <div class="series-label">Serie</div>
                        </div>
                        <div class="series-item" onclick="setQuantity(25)">
                            <div class="series-qty">25</div>
                            <div class="series-label">Mittelserie</div>
                        </div>
                        <div class="series-item" onclick="setQuantity(50)">
                            <div class="series-qty">50</div>
                            <div class="series-label">Gro√üserie</div>
                        </div>
                    </div>
                    <div class="form-group mt-2">
                        <label class="form-label">Individuelle Menge</label>
                        <input type="number" class="form-input" id="quantity" value="1" min="1" onchange="calculate()">
                    </div>
                </div>

                <!-- Pricing -->
                <div class="editor-section">
                    <div class="editor-section-title">Kalkulation</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stundensatz (‚Ç¨)</label>
                            <input type="number" class="form-input" id="hourlyRate" value="85" onchange="calculate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marge (%)</label>
                            <input type="number" class="form-input" id="margin" value="15" onchange="calculate()">
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="editor-section">
                    <button class="btn btn-success btn-block" onclick="saveProject()">
                        üíæ Projekt speichern
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="editor-main">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab active" onclick="showTab('overview')">√úbersicht</div>
                    <div class="tab" onclick="showTab('costs')">Kostenkalkulation</div>
                    <div class="tab" onclick="showTab('tools')">Werkzeuge</div>
                    <div class="tab" onclick="showTab('nccode')">NC-Code</div>
                    <div class="tab" onclick="showTab('quote')">Angebot</div>
                </div>

                <!-- Overview Panel -->
                <div id="panel-overview" class="tab-panel active">
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-card-title">Projekt√ºbersicht</div>
                            <span class="text-muted" id="projectDate">-</span>
                        </div>
                        <div class="result-card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Projektname</div>
                                    <div class="fw-bold" id="overviewName">-</div>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Zeichnungsnummer</div>
                                    <div class="fw-bold" id="overviewDrawing">-</div>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Werkstoff</div>
                                    <div class="fw-bold" id="overviewMaterial">-</div>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Abmessungen</div>
                                    <div class="fw-bold" id="overviewDimensions">-</div>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Rohteilgewicht</div>
                                    <div class="fw-bold" id="overviewWeight">-</div>
                                </div>
                                <div>
                                    <div class="text-muted" style="font-size: 0.85rem;">Fertigungszeit</div>
                                    <div class="fw-bold" id="overviewTime">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="result-card">
                            <div class="result-card-header">
                                <div class="result-card-title">St√ºckpreis</div>
                            </div>
                            <div class="result-card-body" style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 700; color: var(--primary);" id="overviewPrice">‚Ç¨0.00</div>
                                <div class="text-muted">inkl. <span id="overviewMargin">15</span>% Marge</div>
                            </div>
                        </div>

                        <div class="result-card">
                            <div class="result-card-header">
                                <div class="result-card-title">Gesamtauftrag</div>
                            </div>
                            <div class="result-card-body" style="text-align: center;">
                                <div style="font-size: 3rem; font-weight: 700; color: var(--success);" id="overviewTotal">‚Ç¨0.00</div>
                                <div class="text-muted"><span id="overviewQty">1</span> St√ºck</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Costs Panel -->
                <div id="panel-costs" class="tab-panel">
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-card-title">Kostenkalkulation (DIN 6584)</div>
                            <button class="btn btn-sm btn-secondary no-print" onclick="exportCostsCSV()">CSV Export</button>
                        </div>
                        <div class="result-card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Position</th>
                                        <th>Berechnung</th>
                                        <th class="right">Betrag</th>
                                    </tr>
                                </thead>
                                <tbody id="costBreakdown">
                                    <!-- Costs will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tools Panel -->
                <div id="panel-tools" class="tab-panel">
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-card-title">Werkzeuge & Schnittdaten</div>
                        </div>
                        <div class="result-card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Werkzeug</th>
                                        <th>Operation</th>
                                        <th class="right">vc (m/min)</th>
                                        <th class="right">n (U/min)</th>
                                        <th class="right">fz (mm)</th>
                                        <th class="right">vf (mm/min)</th>
                                        <th class="right">Kosten</th>
                                    </tr>
                                </thead>
                                <tbody id="toolsTable">
                                    <!-- Tools will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- NC Code Panel -->
                <div id="panel-nccode" class="tab-panel">
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-card-title">NC-Programm</div>
                            <div style="display: flex; gap: 8px;" class="no-print">
                                <button class="btn btn-sm btn-secondary" onclick="copyCode()">üìã Kopieren</button>
                                <button class="btn btn-sm btn-primary" onclick="downloadCode()">üíæ Download</button>
                            </div>
                        </div>
                        <div class="result-card-body">
                            <div class="code-tabs no-print">
                                <button class="code-tab active" onclick="setCodeFormat('heidenhain')">Heidenhain</button>
                                <button class="code-tab" onclick="setCodeFormat('siemens')">Siemens 840D</button>
                                <button class="code-tab" onclick="setCodeFormat('fanuc')">Fanuc</button>
                            </div>
                            <pre class="code-block" id="ncCodeContent"></pre>
                        </div>
                    </div>
                </div>

                <!-- Quote Panel -->
                <div id="panel-quote" class="tab-panel">
                    <div class="result-card">
                        <div class="result-card-header">
                            <div class="result-card-title">Angebot</div>
                            <div style="display: flex; gap: 8px;" class="no-print">
                                <button class="btn btn-sm btn-secondary" onclick="window.print()">üñ®Ô∏è Drucken</button>
                                <button class="btn btn-sm btn-primary" onclick="downloadQuotePDF()">üìÑ PDF</button>
                            </div>
                        </div>
                        <div class="result-card-body">
                            <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--gray-200);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-weight: 700; font-size: 1.2rem;" id="quoteCompany">Musterfirma GmbH</div>
                                        <div class="text-muted" id="quoteAddress">Musterstra√üe 1, 12345 Musterstadt</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-weight: 600;">Angebot Nr. <span id="quoteNumber">AG-2026-001</span></div>
                                        <div class="text-muted" id="quoteDate">-</div>
                                    </div>
                                </div>
                            </div>
                            
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">Pos.</th>
                                        <th>Bezeichnung</th>
                                        <th class="center" style="width: 80px;">Menge</th>
                                        <th class="right" style="width: 120px;">Einzelpreis</th>
                                        <th class="right" style="width: 120px;">Gesamtpreis</th>
                                    </tr>
                                </thead>
                                <tbody id="quoteItems">
                                    <!-- Quote items will be rendered here -->
                                </tbody>
                            </table>
                            
                            <div style="margin-top: 30px; text-align: right;">
                                <table style="margin-left: auto; width: 300px;">
                                    <tr>
                                        <td class="text-muted">Nettobetrag:</td>
                                        <td class="right fw-bold mono" id="quoteNetto">‚Ç¨0.00</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted">MwSt. 19%:</td>
                                        <td class="right mono" id="quoteMwst">‚Ç¨0.00</td>
                                    </tr>
                                    <tr style="font-size: 1.2rem;">
                                        <td class="fw-bold">Gesamtbetrag:</td>
                                        <td class="right fw-bold mono" style="color: var(--primary);" id="quoteBrutto">‚Ç¨0.00</td>
                                    </tr>
                                </table>
                            </div>
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--gray-200); font-size: 0.85rem; color: var(--gray-500);">
                                <p><strong>Zahlungsbedingungen:</strong> 30 Tage netto</p>
                                <p><strong>Lieferzeit:</strong> ca. 2-3 Wochen nach Auftragserteilung</p>
                                <p><strong>G√ºltigkeit:</strong> 30 Tage</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SETTINGS PAGE ==================== -->
    <div id="pageSettings" class="page">
        <div class="settings-layout">
            <h1 style="font-size: 1.5rem; margin-bottom: 30px;">Einstellungen</h1>

            <div class="settings-card">
                <div class="settings-card-header">
                    <div class="settings-card-title">Unternehmensdaten</div>
                    <div class="settings-card-desc">Diese Daten erscheinen auf Angeboten und Dokumenten</div>
                </div>
                <div class="settings-card-body">
                    <div class="form-group">
                        <label class="form-label">Firmenname</label>
                        <input type="text" class="form-input" id="settingsCompany" placeholder="Ihre Firma GmbH">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Stra√üe & Hausnummer</label>
                            <input type="text" class="form-input" id="settingsStreet">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PLZ & Ort</label>
                            <input type="text" class="form-input" id="settingsCity">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Telefon</label>
                            <input type="tel" class="form-input" id="settingsPhone">
                        </div>
                        <div class="form-group">
                            <label class="form-label">E-Mail</label>
                            <input type="email" class="form-input" id="settingsEmail">
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <div class="settings-card-title">Standard-Kalkulationswerte</div>
                    <div class="settings-card-desc">Diese Werte werden f√ºr neue Projekte voreingestellt</div>
                </div>
                <div class="settings-card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Maschinenstundensatz (‚Ç¨)</label>
                            <input type="number" class="form-input" id="settingsHourlyRate" value="85">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Standard-Marge (%)</label>
                            <input type="number" class="form-input" id="settingsMargin" value="15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">R√ºstzeit pauschal (min)</label>
                            <input type="number" class="form-input" id="settingsSetupTime" value="15">
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <div class="settings-card-title">NC-Code Einstellungen</div>
                    <div class="settings-card-desc">Standard-Format f√ºr die Code-Generierung</div>
                </div>
                <div class="settings-card-body">
                    <div class="form-group">
                        <label class="form-label">Standard NC-Format</label>
                        <select class="form-select" id="settingsNCFormat">
                            <option value="heidenhain">Heidenhain TNC</option>
                            <option value="siemens">Siemens 840D</option>
                            <option value="fanuc">Fanuc</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Sicherheitsabstand Z (mm)</label>
                            <input type="number" class="form-input" id="settingsSafeZ" value="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Anfahrh√∂he Z (mm)</label>
                            <input type="number" class="form-input" id="settingsApproachZ" value="5">
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-card">
                <div class="settings-card-header">
                    <div class="settings-card-title">Daten & Export</div>
                </div>
                <div class="settings-card-body">
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="exportAllData()">üì¶ Alle Daten exportieren</button>
                        <button class="btn btn-secondary" onclick="importData()">üì• Daten importieren</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Alle Daten l√∂schen</button>
                    </div>
                    <input type="file" id="importFile" hidden accept=".json" onchange="handleImport(event)">
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="btn btn-primary btn-lg" onclick="saveSettings()">Einstellungen speichern</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== NEW PROJECT MODAL ==================== -->
<div class="modal-overlay" id="newProjectModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Neues Projekt erstellen</div>
            <button class="modal-close" onclick="closeModal('newProjectModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Projektname *</label>
                <input type="text" class="form-input" id="newProjectName" placeholder="z.B. Grundplatte Motor">
            </div>
            <div class="form-group">
                <label class="form-label">Zeichnungsnummer</label>
                <input type="text" class="form-input" id="newProjectDrawing" placeholder="z.B. ZN-2026-001">
            </div>
            <div class="form-group">
                <label class="form-label">Beschreibung</label>
                <textarea class="form-textarea" id="newProjectDesc" rows="3" placeholder="Optional"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('newProjectModal')">Abbrechen</button>
            <button class="btn btn-primary" onclick="createNewProject()">Projekt erstellen</button>
        </div>
    </div>
</div>

<!-- ==================== NOTIFICATION ==================== -->
<div class="notification" id="notification">
    <span id="notificationText"></span>
</div>

<script>
// ==================== DATA MODELS ====================
const MATERIALS = {
    // Edelstahl
    '1.4301': { name: '1.4301 (V2A)', density: 7.9, price: 8.50, factor: 0.6 },
    '1.4404': { name: '1.4404 (V4A)', density: 7.9, price: 12.00, factor: 0.55 },
    '1.4571': { name: '1.4571', density: 8.0, price: 14.00, factor: 0.5 },
    // Baustahl
    'S235JR': { name: 'S235JR', density: 7.85, price: 1.80, factor: 1.0 },
    'S355J2': { name: 'S355J2', density: 7.85, price: 2.20, factor: 0.95 },
    'C45': { name: 'C45', density: 7.85, price: 2.80, factor: 0.85 },
    // Verg√ºtungsstahl
    '42CrMo4': { name: '42CrMo4', density: 7.85, price: 4.50, factor: 0.7 },
    '34CrNiMo6': { name: '34CrNiMo6', density: 7.85, price: 6.00, factor: 0.65 },
    // Aluminium
    'AlMg3': { name: 'AlMg3', density: 2.66, price: 6.50, factor: 2.0 },
    'AlMgSi1': { name: 'AlMgSi1 (6082)', density: 2.70, price: 7.00, factor: 1.8 },
    'Al7075': { name: 'Al7075-T6', density: 2.81, price: 12.00, factor: 1.5 },
    // Buntmetalle
    'CuZn39Pb3': { name: 'Messing CuZn39Pb3', density: 8.47, price: 9.00, factor: 1.8 },
    'CuSn8': { name: 'Bronze CuSn8', density: 8.80, price: 15.00, factor: 1.5 },
    // Kunststoff
    'POM': { name: 'POM', density: 1.41, price: 5.00, factor: 3.0 },
    'PA6': { name: 'PA6 (Nylon)', density: 1.14, price: 6.00, factor: 2.8 },
    'PEEK': { name: 'PEEK', density: 1.32, price: 120.00, factor: 1.5 },
    // Titan
    'Ti6Al4V': { name: 'Ti6Al4V (Grade 5)', density: 4.43, price: 45.00, factor: 0.35 }
};

const TOOLS = {
    'planfraesen': { name: 'Planfr√§ser √ò63', vc: 180, price: 180, standzeit: 300 },
    'konturfraesen': { name: 'Schaftfr√§ser √ò20', vc: 150, price: 85, standzeit: 180 },
    'taschen': { name: 'Schaftfr√§ser √ò16', vc: 140, price: 65, standzeit: 150 },
    'bohren': { name: 'Spiralbohrer √ò10', vc: 80, price: 25, standzeit: 120 },
    'schlichten': { name: 'Schlichtfr√§ser √ò12', vc: 200, price: 95, standzeit: 200 }
};

// ==================== STATE ====================
let currentUser = null;
let currentProject = null;
let allProjects = [];
let settings = {
    company: 'Musterfirma GmbH',
    street: 'Musterstra√üe 1',
    city: '12345 Musterstadt',
    phone: '+49 123 456789',
    email: 'info@musterfirma.de',
    hourlyRate: 85,
    margin: 15,
    setupTime: 15,
    ncFormat: 'heidenhain',
    safeZ: 100,
    approachZ: 5
};

// ==================== AUTH ====================
function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    document.querySelector(`[onclick="showAuthTab('${tab}')"]`).classList.add('active');
    document.getElementById(tab === 'login' ? 'loginForm' : 'registerForm').classList.add('active');
}

function login(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    // Demo login or stored user
    const users = JSON.parse(localStorage.getItem('cncplanner_users') || '[]');
    const user = users.find(u => u.email === email && u.password === password);
    
    if (user || (email === 'demo@cnc-planner.de' && password === 'demo123')) {
        currentUser = user || { firstName: 'Demo', lastName: 'Nutzer', email: 'demo@cnc-planner.de', company: 'Demo GmbH' };
        localStorage.setItem('cncplanner_session', JSON.stringify(currentUser));
        enterApp();
    } else {
        notify('E-Mail oder Passwort falsch', 'error');
    }
}

function register(e) {
    e.preventDefault();
    const user = {
        firstName: document.getElementById('regFirstName').value,
        lastName: document.getElementById('regLastName').value,
        company: document.getElementById('regCompany').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPassword').value
    };
    
    const users = JSON.parse(localStorage.getItem('cncplanner_users') || '[]');
    if (users.find(u => u.email === user.email)) {
        notify('E-Mail bereits registriert', 'error');
        return;
    }
    
    users.push(user);
    localStorage.setItem('cncplanner_users', JSON.stringify(users));
    currentUser = user;
    localStorage.setItem('cncplanner_session', JSON.stringify(currentUser));
    notify('Konto erstellt!', 'success');
    enterApp();
}

function logout() {
    if (confirm('M√∂chten Sie sich abmelden?')) {
        localStorage.removeItem('cncplanner_session');
        currentUser = null;
        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('authScreen').classList.remove('hidden');
    }
}

function enterApp() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Update UI with user info
    document.getElementById('userAvatar').textContent = currentUser.firstName[0] + currentUser.lastName[0];
    document.getElementById('userName').textContent = currentUser.firstName + ' ' + currentUser.lastName[0] + '.';
    document.getElementById('dashboardGreeting').textContent = `Willkommen zur√ºck, ${currentUser.firstName}!`;
    
    loadSettings();
    loadProjects();
    renderDashboard();
}

// ==================== NAVIGATION ====================
function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
    document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
    
    if (page === 'dashboard') renderDashboard();
    if (page === 'settings') loadSettingsUI();
}

// ==================== PROJECTS ====================
function loadProjects() {
    const stored = localStorage.getItem('cncplanner_projects');
    allProjects = stored ? JSON.parse(stored) : [];
}

function saveProjects() {
    localStorage.setItem('cncplanner_projects', JSON.stringify(allProjects));
}

function renderDashboard() {
    // Stats
    const totalValue = allProjects.reduce((sum, p) => sum + (p.sellPrice || 0) * (p.quantity || 1), 0);
    const totalTime = allProjects.reduce((sum, p) => sum + (p.totalTime || 0), 0);
    const avgPrice = allProjects.length > 0 ? totalValue / allProjects.length : 0;
    
    document.getElementById('statProjects').textContent = allProjects.length;
    document.getElementById('statValue').textContent = '‚Ç¨' + totalValue.toLocaleString('de-DE', { minimumFractionDigits: 0 });
    document.getElementById('statAvg').textContent = '‚Ç¨' + avgPrice.toFixed(0);
    document.getElementById('statTime').textContent = (totalTime / 60).toFixed(1) + 'h';
    
    // Projects grid
    let html = `
        <div class="new-project-card" onclick="openNewProjectModal()">
            <div class="new-project-icon">+</div>
            <div class="new-project-text">Neues Projekt erstellen</div>
        </div>
    `;
    
    allProjects.forEach((project, idx) => {
        const mat = MATERIALS[project.material] || { name: project.material };
        html += `
            <div class="project-card" onclick="openProject(${idx})">
                <div class="project-card-header">
                    <div class="project-card-title">${project.name}</div>
                    <div class="project-card-subtitle">${project.drawingNo || 'Ohne Zeichnungsnummer'}</div>
                </div>
                <div class="project-card-body">
                    <div class="project-meta">
                        <div class="project-meta-item">
                            <div class="project-meta-label">Werkstoff</div>
                            <div class="project-meta-value">${mat.name}</div>
                        </div>
                        <div class="project-meta-item">
                            <div class="project-meta-label">Abmessungen</div>
                            <div class="project-meta-value">${project.dimensions?.l || 0}√ó${project.dimensions?.w || 0}√ó${project.dimensions?.h || 0} mm</div>
                        </div>
                        <div class="project-meta-item">
                            <div class="project-meta-label">St√ºckzahl</div>
                            <div class="project-meta-value">${project.quantity || 1} Stk.</div>
                        </div>
                        <div class="project-meta-item">
                            <div class="project-meta-label">Fertigungszeit</div>
                            <div class="project-meta-value">${(project.totalTime || 0).toFixed(0)} min</div>
                        </div>
                    </div>
                </div>
                <div class="project-card-footer">
                    <div class="project-price">‚Ç¨${(project.sellPrice || 0).toFixed(2)}</div>
                    <div class="project-actions">
                        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); duplicateProject(${idx})">üìã</button>
                        <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); deleteProject(${idx})">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('projectsGrid').innerHTML = html;
}

function openNewProjectModal() {
    document.getElementById('newProjectName').value = '';
    document.getElementById('newProjectDrawing').value = '';
    document.getElementById('newProjectDesc').value = '';
    document.getElementById('newProjectModal').classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function createNewProject() {
    const name = document.getElementById('newProjectName').value.trim();
    if (!name) {
        notify('Bitte Projektname eingeben', 'error');
        return;
    }
    
    currentProject = {
        id: Date.now(),
        name: name,
        drawingNo: document.getElementById('newProjectDrawing').value.trim(),
        description: document.getElementById('newProjectDesc').value.trim(),
        material: 'S235JR',
        dimensions: { l: 200, w: 150, h: 40 },
        operations: ['planfraesen', 'konturfraesen', 'taschen'],
        quantity: 1,
        hourlyRate: settings.hourlyRate,
        margin: settings.margin,
        created: new Date().toISOString()
    };
    
    closeModal('newProjectModal');
    showPage('editor');
    loadProjectToEditor();
    calculate();
    notify('Projekt erstellt', 'success');
}

function openProject(idx) {
    currentProject = { ...allProjects[idx], _index: idx };
    showPage('editor');
    loadProjectToEditor();
    calculate();
}

function loadProjectToEditor() {
    if (!currentProject) return;
    
    document.getElementById('projectName').value = currentProject.name || '';
    document.getElementById('drawingNo').value = currentProject.drawingNo || '';
    document.getElementById('dimLength').value = currentProject.dimensions?.l || 200;
    document.getElementById('dimWidth').value = currentProject.dimensions?.w || 150;
    document.getElementById('dimHeight').value = currentProject.dimensions?.h || 40;
    document.getElementById('material').value = currentProject.material || 'S235JR';
    document.getElementById('hourlyRate').value = currentProject.hourlyRate || settings.hourlyRate;
    document.getElementById('margin').value = currentProject.margin || settings.margin;
    document.getElementById('quantity').value = currentProject.quantity || 1;
    
    // Operations
    document.querySelectorAll('.operation-checkbox').forEach(cb => {
        cb.checked = (currentProject.operations || []).includes(cb.dataset.op);
    });
    
    // Series buttons
    document.querySelectorAll('.series-item').forEach(s => s.classList.remove('active'));
    const qty = currentProject.quantity || 1;
    const matchingBtn = [...document.querySelectorAll('.series-item')].find(s => 
        s.querySelector('.series-qty').textContent == qty
    );
    if (matchingBtn) matchingBtn.classList.add('active');
}

function saveProject() {
    if (!currentProject) {
        notify('Kein Projekt ge√∂ffnet', 'error');
        return;
    }
    
    // Update current project from form
    currentProject.name = document.getElementById('projectName').value;
    currentProject.drawingNo = document.getElementById('drawingNo').value;
    currentProject.dimensions = {
        l: parseFloat(document.getElementById('dimLength').value) || 0,
        w: parseFloat(document.getElementById('dimWidth').value) || 0,
        h: parseFloat(document.getElementById('dimHeight').value) || 0
    };
    currentProject.material = document.getElementById('material').value;
    currentProject.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 85;
    currentProject.margin = parseFloat(document.getElementById('margin').value) || 15;
    currentProject.quantity = parseInt(document.getElementById('quantity').value) || 1;
    currentProject.operations = [...document.querySelectorAll('.operation-checkbox:checked')].map(cb => cb.dataset.op);
    currentProject.updated = new Date().toISOString();
    
    // Save to list
    if (currentProject._index !== undefined) {
        allProjects[currentProject._index] = { ...currentProject };
        delete allProjects[currentProject._index]._index;
    } else {
        allProjects.push({ ...currentProject });
        currentProject._index = allProjects.length - 1;
    }
    
    saveProjects();
    notify('Projekt gespeichert', 'success');
}

function duplicateProject(idx) {
    const copy = { ...allProjects[idx], id: Date.now(), name: allProjects[idx].name + ' (Kopie)', created: new Date().toISOString() };
    allProjects.push(copy);
    saveProjects();
    renderDashboard();
    notify('Projekt dupliziert', 'success');
}

function deleteProject(idx) {
    if (confirm('Projekt wirklich l√∂schen?')) {
        allProjects.splice(idx, 1);
        saveProjects();
        renderDashboard();
        notify('Projekt gel√∂scht', 'success');
    }
}

// ==================== FILE UPLOAD ====================
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) handleFileUpload({ target: { files: e.dataTransfer.files } });
});

function handleFileUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const ext = file.name.split('.').pop().toUpperCase();
    document.getElementById('fileExt').textContent = ext;
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(1) + ' KB';
    document.getElementById('uploadPreview').classList.add('active');
    
    // Simulate file analysis
    notify('Datei wird analysiert...', 'success');
    setTimeout(() => {
        // Simulate extracted dimensions
        if (ext === 'STEP' || ext === 'STP') {
            document.getElementById('dimLength').value = Math.round(150 + Math.random() * 200);
            document.getElementById('dimWidth').value = Math.round(100 + Math.random() * 150);
            document.getElementById('dimHeight').value = Math.round(20 + Math.random() * 60);
            calculate();
            notify('Abmessungen aus STEP-Datei extrahiert', 'success');
        } else {
            notify('Datei hochgeladen', 'success');
        }
    }, 1500);
}

// ==================== CALCULATION ====================
function calculate() {
    if (!currentProject) {
        currentProject = {
            name: document.getElementById('projectName').value || 'Neues Projekt',
            drawingNo: document.getElementById('drawingNo').value,
            dimensions: { l: 200, w: 150, h: 40 },
            material: 'S235JR',
            operations: ['planfraesen', 'konturfraesen', 'taschen'],
            quantity: 1,
            hourlyRate: settings.hourlyRate,
            margin: settings.margin
        };
    }
    
    // Get values
    const p = currentProject;
    p.name = document.getElementById('projectName').value || 'Neues Projekt';
    p.drawingNo = document.getElementById('drawingNo').value;
    p.dimensions = {
        l: parseFloat(document.getElementById('dimLength').value) || 0,
        w: parseFloat(document.getElementById('dimWidth').value) || 0,
        h: parseFloat(document.getElementById('dimHeight').value) || 0
    };
    p.material = document.getElementById('material').value;
    p.hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 85;
    p.margin = parseFloat(document.getElementById('margin').value) || 15;
    p.quantity = parseInt(document.getElementById('quantity').value) || 1;
    p.operations = [...document.querySelectorAll('.operation-checkbox:checked')].map(cb => cb.dataset.op);
    
    const mat = MATERIALS[p.material];
    const volume = (p.dimensions.l * p.dimensions.w * p.dimensions.h) / 1000000; // m¬≥ -> dm¬≥
    const weight = volume * mat.density * 1000; // kg
    const materialCost = weight * mat.price;
    
    // Time calculation
    const area = (p.dimensions.l * p.dimensions.w) / 1000000; // m¬≤
    const perimeter = 2 * (p.dimensions.l + p.dimensions.w);
    
    const timeBreakdown = [];
    p.operations.forEach(op => {
        let time = 0;
        switch(op) {
            case 'planfraesen': time = (area * 60000 / (500 * 50)) * (1 / mat.factor) + 2; break;
            case 'konturfraesen': time = (perimeter / 400) * (1 / mat.factor) * p.dimensions.h / 10 + 3; break;
            case 'taschen': time = (area * 0.3 * 60000 / (300 * 30)) * (1 / mat.factor) + 5; break;
            case 'bohren': time = 8 * (1 / mat.factor); break;
            case 'schlichten': time = (area * 60000 / (800 * 40)) * (1 / mat.factor) + 2; break;
        }
        time = Math.max(time, 2);
        timeBreakdown.push({ op, time });
        document.getElementById(`time-${op}`).textContent = time.toFixed(1) + ' min';
    });
    
    // Hide times for unchecked operations
    document.querySelectorAll('.operation-checkbox:not(:checked)').forEach(cb => {
        document.getElementById(`time-${cb.dataset.op}`).textContent = '-';
    });
    
    const setupTime = settings.setupTime || 15;
    const machiningTime = timeBreakdown.reduce((sum, t) => sum + t.time, 0);
    const totalTime = setupTime + machiningTime;
    p.totalTime = totalTime;
    
    // Costs
    const machineCost = (totalTime / 60) * p.hourlyRate;
    const toolCost = timeBreakdown.reduce((sum, t) => {
        const tool = TOOLS[t.op];
        return sum + (tool ? (tool.price / tool.standzeit) * t.time : 0);
    }, 0);
    const selfCost = materialCost + machineCost + toolCost;
    const sellPrice = selfCost * (1 + p.margin / 100);
    p.sellPrice = sellPrice;
    
    // Update Overview
    document.getElementById('projectDate').textContent = new Date().toLocaleDateString('de-DE');
    document.getElementById('overviewName').textContent = p.name;
    document.getElementById('overviewDrawing').textContent = p.drawingNo || '-';
    document.getElementById('overviewMaterial').textContent = mat.name;
    document.getElementById('overviewDimensions').textContent = `${p.dimensions.l} √ó ${p.dimensions.w} √ó ${p.dimensions.h} mm`;
    document.getElementById('overviewWeight').textContent = weight.toFixed(2) + ' kg';
    document.getElementById('overviewTime').textContent = totalTime.toFixed(0) + ' min';
    document.getElementById('overviewPrice').textContent = '‚Ç¨' + sellPrice.toFixed(2);
    document.getElementById('overviewMargin').textContent = p.margin;
    document.getElementById('overviewTotal').textContent = '‚Ç¨' + (sellPrice * p.quantity).toFixed(2);
    document.getElementById('overviewQty').textContent = p.quantity;
    
    // Cost breakdown
    document.getElementById('costBreakdown').innerHTML = `
        <tr>
            <td>Rohmaterial</td>
            <td class="mono">${weight.toFixed(2)} kg √ó ‚Ç¨${mat.price}/kg</td>
            <td class="right mono">‚Ç¨${materialCost.toFixed(2)}</td>
        </tr>
        <tr>
            <td>R√ºstzeit</td>
            <td class="mono">${setupTime} min</td>
            <td class="right mono">‚Ç¨${((setupTime/60) * p.hourlyRate).toFixed(2)}</td>
        </tr>
        ${timeBreakdown.map(t => `
        <tr>
            <td>${getOpDescription(t.op)}</td>
            <td class="mono">${t.time.toFixed(1)} min</td>
            <td class="right mono">‚Ç¨${((t.time/60) * p.hourlyRate).toFixed(2)}</td>
        </tr>
        `).join('')}
        <tr>
            <td>Werkzeugverschlei√ü</td>
            <td class="mono">anteilig</td>
            <td class="right mono">‚Ç¨${toolCost.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
            <td><strong>Selbstkosten</strong></td>
            <td></td>
            <td class="right mono"><strong>‚Ç¨${selfCost.toFixed(2)}</strong></td>
        </tr>
        <tr>
            <td>Marge ${p.margin}%</td>
            <td></td>
            <td class="right mono">‚Ç¨${(sellPrice - selfCost).toFixed(2)}</td>
        </tr>
        <tr class="total-row" style="background: var(--primary); color: white;">
            <td><strong>Verkaufspreis</strong></td>
            <td></td>
            <td class="right mono"><strong>‚Ç¨${sellPrice.toFixed(2)}</strong></td>
        </tr>
    `;
    
    // Quote
    const totalPrice = sellPrice * p.quantity;
    const mwst = totalPrice * 0.19;
    document.getElementById('quoteNumber').textContent = 'AG-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 1000)).padStart(3, '0');
    document.getElementById('quoteDate').textContent = new Date().toLocaleDateString('de-DE');
    document.getElementById('quoteCompany').textContent = settings.company;
    document.getElementById('quoteAddress').textContent = settings.street + ', ' + settings.city;
    document.getElementById('quoteItems').innerHTML = `
        <tr>
            <td>1</td>
            <td>
                <strong>${p.name}</strong><br>
                <span class="text-muted" style="font-size: 0.85rem;">
                    ${p.drawingNo || '-'} ¬∑ ${mat.name} ¬∑ ${p.dimensions.l}√ó${p.dimensions.w}√ó${p.dimensions.h} mm
                </span>
            </td>
            <td class="center">${p.quantity}</td>
            <td class="right mono">‚Ç¨${sellPrice.toFixed(2)}</td>
            <td class="right mono">‚Ç¨${totalPrice.toFixed(2)}</td>
        </tr>
    `;
    document.getElementById('quoteNetto').textContent = '‚Ç¨' + totalPrice.toFixed(2);
    document.getElementById('quoteMwst').textContent = '‚Ç¨' + mwst.toFixed(2);
    document.getElementById('quoteBrutto').textContent = '‚Ç¨' + (totalPrice + mwst).toFixed(2);
    
    // Tools table
    document.getElementById('toolsTable').innerHTML = timeBreakdown.map(t => {
        const tool = TOOLS[t.op];
        if (!tool) return '';
        const n = Math.round((tool.vc * 1000) / (Math.PI * 20));
        const vf = Math.round(n * 0.1 * 4);
        const cost = (tool.price / tool.standzeit) * t.time;
        return `
            <tr>
                <td><strong>${tool.name}</strong></td>
                <td>${getOpDescription(t.op)}</td>
                <td class="right mono">${tool.vc}</td>
                <td class="right mono">${n}</td>
                <td class="right mono">0.10</td>
                <td class="right mono">${vf}</td>
                <td class="right mono">‚Ç¨${cost.toFixed(2)}</td>
            </tr>
        `;
    }).join('') + `
        <tr class="total-row">
            <td colspan="6"><strong>Gesamte Werkzeugkosten</strong></td>
            <td class="right mono"><strong>‚Ç¨${toolCost.toFixed(2)}</strong></td>
        </tr>
    `;
    
    generateNCCode();
}

function getOpDescription(op) {
    const desc = {
        'planfraesen': 'Planfr√§sen',
        'konturfraesen': 'Konturfr√§sen',
        'taschen': 'Taschenfr√§sen',
        'bohren': 'Bohren & Gewinde',
        'schlichten': 'Schlichten'
    };
    return desc[op] || op;
}

// ==================== TABS ====================
function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
    document.getElementById(`panel-${tabId}`).classList.add('active');
}

function setQuantity(qty) {
    document.getElementById('quantity').value = qty;
    document.querySelectorAll('.series-item').forEach(s => s.classList.remove('active'));
    event.target.closest('.series-item').classList.add('active');
    calculate();
}

// ==================== NC CODE ====================
let currentCodeFormat = 'heidenhain';

function setCodeFormat(format) {
    currentCodeFormat = format;
    document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[onclick="setCodeFormat('${format}')"]`).classList.add('active');
    generateNCCode();
}

function generateNCCode() {
    if (!currentProject) return;
    const p = currentProject;
    const mat = MATERIALS[p.material];
    let code = '';
    
    if (currentCodeFormat === 'heidenhain') {
        code = `<span class="code-comment">; ============================================</span>
<span class="code-comment">; CNC PLANNER PRO ‚Äî DIN 66025 / ISO 6983</span>
<span class="code-comment">; ============================================</span>
<span class="code-comment">; Werkst√ºck:  ${p.name}</span>
<span class="code-comment">; Zeichnung:  ${p.drawingNo || 'N/A'}</span>
<span class="code-comment">; Werkstoff:  ${p.material} (${mat?.name || p.material})</span>
<span class="code-comment">; Rohma√üe:    ${p.dimensions.l} √ó ${p.dimensions.w} √ó ${p.dimensions.h} mm</span>
<span class="code-comment">; Erstellt:   ${new Date().toLocaleString('de-DE')}</span>
<span class="code-comment">; ============================================</span>

<span class="code-keyword">BEGIN PGM</span> ${(p.name || 'PART').toUpperCase().replace(/[^A-Z0-9]/g, '_')} <span class="code-keyword">MM</span>

<span class="code-comment">; --- WERKZEUGLISTE ---</span>
${(p.operations || []).map((op, i) => `<span class="code-comment">; T${i+1} = ${TOOLS[op]?.name || op}</span>`).join('\n')}

<span class="code-comment">; --- NULLPUNKT ---</span>
<span class="code-keyword">CYCL DEF</span> <span class="code-number">7.0</span> NULLPUNKT
<span class="code-keyword">CYCL DEF</span> <span class="code-number">7.1</span> X+<span class="code-number">${p.dimensions.l/2}</span>
<span class="code-keyword">CYCL DEF</span> <span class="code-number">7.2</span> Y+<span class="code-number">${p.dimensions.w/2}</span>
<span class="code-keyword">CYCL DEF</span> <span class="code-number">7.3</span> Z+<span class="code-number">0</span>

${(p.operations || []).map((op, i) => generateHeidenhainOp(op, i+1, mat)).join('\n\n')}

<span class="code-comment">; --- ENDE ---</span>
<span class="code-keyword">L</span> Z+<span class="code-number">${settings.safeZ}</span> <span class="code-keyword">R0 FMAX M30</span>

<span class="code-keyword">END PGM</span> ${(p.name || 'PART').toUpperCase().replace(/[^A-Z0-9]/g, '_')} <span class="code-keyword">MM</span>`;
    } else if (currentCodeFormat === 'siemens') {
        code = generateSiemensCode(p, mat);
    } else {
        code = generateFanucCode(p, mat);
    }
    
    document.getElementById('ncCodeContent').innerHTML = code;
}

function generateHeidenhainOp(op, tNum, mat) {
    const tool = TOOLS[op];
    const vc = (tool?.vc || 100) * (mat?.factor || 1);
    const n = Math.round((vc * 1000) / (Math.PI * 20));
    const vf = Math.round(n * 0.1 * 4);
    
    return `<span class="code-comment">; --- OP${tNum*10}: ${getOpDescription(op)} ---</span>
<span class="code-keyword">TOOL CALL</span> ${tNum} <span class="code-keyword">Z S</span><span class="code-number">${n}</span>
<span class="code-keyword">L</span> Z+<span class="code-number">${settings.safeZ}</span> <span class="code-keyword">R0 FMAX M3</span>
<span class="code-keyword">L</span> X+<span class="code-number">0</span> Y+<span class="code-number">0</span> <span class="code-keyword">R0 FMAX</span>
<span class="code-keyword">L</span> Z+<span class="code-number">${settings.approachZ}</span> <span class="code-keyword">R0 FMAX</span>
<span class="code-keyword">L</span> Z-<span class="code-number">2</span> <span class="code-keyword">R0 F</span><span class="code-number">${vf}</span>
<span class="code-comment">; ... Bearbeitungszyklus ...</span>
<span class="code-keyword">L</span> Z+<span class="code-number">${settings.safeZ}</span> <span class="code-keyword">R0 FMAX M5</span>`;
}

function generateSiemensCode(p, mat) {
    return `<span class="code-comment">; ============================================</span>
<span class="code-comment">; CNC PLANNER PRO ‚Äî Siemens 840D</span>
<span class="code-comment">; Werkst√ºck: ${p.name}</span>
<span class="code-comment">; ============================================</span>

<span class="code-keyword">G90 G17 G54</span>
<span class="code-keyword">G0</span> Z<span class="code-number">${settings.safeZ}</span>

${(p.operations || []).map((op, i) => {
    const tool = TOOLS[op];
    const n = Math.round(((tool?.vc || 100) * (mat?.factor || 1) * 1000) / (Math.PI * 20));
    return `<span class="code-comment">; OP${(i+1)*10}: ${getOpDescription(op)}</span>
<span class="code-keyword">T${i+1} M6</span>
<span class="code-keyword">S</span><span class="code-number">${n}</span> <span class="code-keyword">M3</span>
<span class="code-keyword">G0</span> X<span class="code-number">0</span> Y<span class="code-number">0</span>
<span class="code-keyword">G0</span> Z<span class="code-number">${settings.approachZ}</span>
<span class="code-keyword">G1</span> Z<span class="code-number">-2</span> <span class="code-keyword">F</span><span class="code-number">200</span>
<span class="code-comment">; ... Bearbeitungszyklus ...</span>
<span class="code-keyword">G0</span> Z<span class="code-number">${settings.safeZ}</span>`;
}).join('\n\n')}

<span class="code-keyword">M30</span>`;
}

function generateFanucCode(p, mat) {
    return `<span class="code-comment">(CNC PLANNER PRO - Fanuc)</span>
<span class="code-comment">(Werkst√ºck: ${p.name})</span>

<span class="code-keyword">O0001</span>
<span class="code-keyword">G90 G17 G21 G54</span>
<span class="code-keyword">G0</span> Z<span class="code-number">${settings.safeZ}.</span>

${(p.operations || []).map((op, i) => {
    const tool = TOOLS[op];
    const n = Math.round(((tool?.vc || 100) * (mat?.factor || 1) * 1000) / (Math.PI * 20));
    return `<span class="code-comment">(OP${(i+1)*10}: ${getOpDescription(op)})</span>
<span class="code-keyword">T${i+1} M6</span>
<span class="code-keyword">S</span><span class="code-number">${n}</span> <span class="code-keyword">M3</span>
<span class="code-keyword">G0</span> X<span class="code-number">0.</span> Y<span class="code-number">0.</span>
<span class="code-keyword">G43</span> H${i+1} Z<span class="code-number">${settings.approachZ}.</span>
<span class="code-keyword">G1</span> Z<span class="code-number">-2.</span> <span class="code-keyword">F</span><span class="code-number">200</span>
<span class="code-comment">(Bearbeitungszyklus)</span>
<span class="code-keyword">G0</span> Z<span class="code-number">${settings.safeZ}.</span>`;
}).join('\n\n')}

<span class="code-keyword">M30</span>
<span class="code-keyword">%</span>`;
}

function copyCode() {
    const code = document.getElementById('ncCodeContent').innerText;
    navigator.clipboard.writeText(code);
    notify('NC-Code kopiert', 'success');
}

function downloadCode() {
    const code = document.getElementById('ncCodeContent').innerText;
    const ext = currentCodeFormat === 'heidenhain' ? 'h' : currentCodeFormat === 'siemens' ? 'mpf' : 'nc';
    const filename = (currentProject?.name || 'program').replace(/[^a-zA-Z0-9]/g, '_') + '.' + ext;
    downloadFile(code, filename, 'text/plain');
    notify('NC-Code heruntergeladen', 'success');
}

// ==================== SETTINGS ====================
function loadSettings() {
    const stored = localStorage.getItem('cncplanner_settings');
    if (stored) settings = { ...settings, ...JSON.parse(stored) };
}

function loadSettingsUI() {
    document.getElementById('settingsCompany').value = settings.company || '';
    document.getElementById('settingsStreet').value = settings.street || '';
    document.getElementById('settingsCity').value = settings.city || '';
    document.getElementById('settingsPhone').value = settings.phone || '';
    document.getElementById('settingsEmail').value = settings.email || '';
    document.getElementById('settingsHourlyRate').value = settings.hourlyRate || 85;
    document.getElementById('settingsMargin').value = settings.margin || 15;
    document.getElementById('settingsSetupTime').value = settings.setupTime || 15;
    document.getElementById('settingsNCFormat').value = settings.ncFormat || 'heidenhain';
    document.getElementById('settingsSafeZ').value = settings.safeZ || 100;
    document.getElementById('settingsApproachZ').value = settings.approachZ || 5;
}

function saveSettings() {
    settings = {
        company: document.getElementById('settingsCompany').value,
        street: document.getElementById('settingsStreet').value,
        city: document.getElementById('settingsCity').value,
        phone: document.getElementById('settingsPhone').value,
        email: document.getElementById('settingsEmail').value,
        hourlyRate: parseFloat(document.getElementById('settingsHourlyRate').value) || 85,
        margin: parseFloat(document.getElementById('settingsMargin').value) || 15,
        setupTime: parseFloat(document.getElementById('settingsSetupTime').value) || 15,
        ncFormat: document.getElementById('settingsNCFormat').value,
        safeZ: parseFloat(document.getElementById('settingsSafeZ').value) || 100,
        approachZ: parseFloat(document.getElementById('settingsApproachZ').value) || 5
    };
    localStorage.setItem('cncplanner_settings', JSON.stringify(settings));
    notify('Einstellungen gespeichert', 'success');
}

// ==================== EXPORT ====================
function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function exportCostsCSV() {
    if (!currentProject) return;
    const rows = [
        ['Position', 'Berechnung', 'Betrag'],
        ['Rohmaterial', '', currentProject.sellPrice ? '‚Ç¨' + (currentProject.sellPrice * 0.2).toFixed(2) : ''],
        ['Maschinenkosten', '', currentProject.sellPrice ? '‚Ç¨' + (currentProject.sellPrice * 0.5).toFixed(2) : ''],
        ['Werkzeugkosten', '', currentProject.sellPrice ? '‚Ç¨' + (currentProject.sellPrice * 0.1).toFixed(2) : ''],
        ['Gesamt', '', currentProject.sellPrice ? '‚Ç¨' + currentProject.sellPrice.toFixed(2) : '']
    ];
    const csv = rows.map(r => r.join(';')).join('\n');
    downloadFile(csv, 'kalkulation.csv', 'text/csv');
    notify('CSV exportiert', 'success');
}

function exportAllCSV() {
    if (allProjects.length === 0) {
        notify('Keine Projekte vorhanden', 'error');
        return;
    }
    const header = ['Name', 'Zeichnung', 'Werkstoff', 'L√óB√óH', 'Menge', 'Zeit (min)', 'Preis (‚Ç¨)'];
    const rows = allProjects.map(p => [
        p.name,
        p.drawingNo || '',
        p.material,
        `${p.dimensions?.l || 0}√ó${p.dimensions?.w || 0}√ó${p.dimensions?.h || 0}`,
        p.quantity || 1,
        (p.totalTime || 0).toFixed(0),
        (p.sellPrice || 0).toFixed(2)
    ]);
    const csv = [header, ...rows].map(r => r.join(';')).join('\n');
    downloadFile(csv, 'projekte.csv', 'text/csv');
    notify('CSV exportiert', 'success');
}

function exportAllData() {
    const data = {
        projects: allProjects,
        settings: settings,
        exportDate: new Date().toISOString()
    };
    downloadFile(JSON.stringify(data, null, 2), 'cncplanner-backup.json', 'application/json');
    notify('Daten exportiert', 'success');
}

function importData() {
    document.getElementById('importFile').click();
}

function handleImport(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            if (data.projects) {
                allProjects = data.projects;
                saveProjects();
            }
            if (data.settings) {
                settings = { ...settings, ...data.settings };
                localStorage.setItem('cncplanner_settings', JSON.stringify(settings));
            }
            renderDashboard();
            notify('Daten importiert', 'success');
        } catch (err) {
            notify('Importfehler: Ung√ºltige Datei', 'error');
        }
    };
    reader.readAsText(file);
}

function clearAllData() {
    if (confirm('Alle Projekte und Einstellungen wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        localStorage.removeItem('cncplanner_projects');
        localStorage.removeItem('cncplanner_settings');
        allProjects = [];
        loadSettings();
        renderDashboard();
        notify('Alle Daten gel√∂scht', 'success');
    }
}

function downloadQuotePDF() {
    window.print();
    notify('PDF wird erstellt...', 'success');
}

// ==================== NOTIFICATIONS ====================
function notify(text, type = '') {
    const el = document.getElementById('notification');
    el.textContent = text;
    el.className = 'notification active ' + type;
    setTimeout(() => el.classList.remove('active'), 3000);
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    // Check for existing session
    const session = localStorage.getItem('cncplanner_session');
    if (session) {
        currentUser = JSON.parse(session);
        enterApp();
    }
    
    // Setup drag & drop for upload
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => e.preventDefault());
});
</script>
</body>
</html>
