<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CNC Planer Pro</title>
<style>
 /* ================================================================
 CNC PLANER PRO v20 — INDUSTRIAL DESIGN
 Best-in-class Professional Maschinenbau Aesthetic
 Based on: Golden Standards + MBS Angebot Analysis
 ================================================================ */
 
 :root {
 /* Colors */
 --color-primary: #1F2937;
 --color-primary-hover: #111827;
 --color-primary-light: #374151;
 --color-text: #111827;
 --color-text-secondary: #374151;
 --color-text-muted: #6B7280;
 --color-text-hint: #9CA3AF;
 --color-bg: #F9FAFB;
 --color-surface: #FFFFFF;
 --color-bg-subtle: #F3F4F6;
 --color-bg-muted: #F3F4F6;
 --color-bg-emphasis: #E5E7EB;
 --color-bg-elevated: #FFFFFF;
 --color-border: #E5E7EB;
 --color-border-light: #F3F4F6;
 --color-success: #059669;
 --color-success-light: #ECFDF5;
 --color-warning: #D97706;
 --color-warning-light: #FFFBEB;
 --color-error: #DC2626;
 --color-danger: #DC2626;
 --color-error-light: #FEF2F2;
 --color-info: #2563EB;
 --color-info-light: #EFF6FF;
 /* Type */
 --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
 --font-mono: "SF Mono", Monaco, "Cascadia Code", Consolas, monospace;
 --text-xs: 0.6875rem;
 --text-sm: 0.8125rem;
 --text-base: 0.8125rem;
 --text-lg: 0.9375rem;
 --text-xl: 1.0625rem;
 --text-2xl: 1.25rem;
 --text-3xl: 1.375rem;
 --font-normal: 400;
 --font-medium: 500;
 --font-semibold: 600;
 --font-bold: 700;
 --leading-tight: 1.3;
 --leading-normal: 1.5;
 --leading-relaxed: 1.65;
 /* Spacing — tighter */
 --space-1: 0.25rem;
 --space-2: 0.375rem;
 --space-3: 0.5rem;
 --space-4: 0.75rem;
 --space-5: 1rem;
 --space-6: 1.25rem;
 --space-8: 1.5rem;
 --space-10: 2rem;
 --space-12: 2.5rem;
 /* Layout */
 --sidebar-width: 200px;
 --header-height: 44px;
 /* Borders */
 --radius: 6px;
 --radius-sm: 4px;
 --radius-md: 8px;
 /* Shadows */
 --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
 --shadow-card: 0 1px 3px rgba(0,0,0,0.08);
 }
 
 /* ================================================================
 RESET & BASE
 ================================================================ */
 
 *, *::before, *::after {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }
 
 html, body {
 height: 100%;
 }
 
 body {
 font-family: var(--font-sans);
 font-size: var(--text-base);
 line-height: var(--leading-normal);
 color: var(--color-text);
 background: var(--color-bg);
 -webkit-font-smoothing: antialiased;
 -moz-osx-font-smoothing: grayscale;
 }
 
 /* ================================================================
 LAYOUT
 ================================================================ */
 
 .app {
 display: flex;
 min-height: 100vh;
 }
 
 /* === SIDEBAR === */
 .sidebar {
 width: var(--sidebar-width);
 background: var(--color-primary);
 color: white;
 display: flex;
 flex-direction: column;
 border-right: 1px solid rgba(0, 0, 0, 0.1);
 }
 
 .sidebar-header {
 padding: var(--space-4) var(--space-4);
 border-bottom: 1px solid rgba(255, 255, 255, 0.08);
 }
 
 .sidebar-logo {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 }
 
 .sidebar-logo-icon {
 width: 28px;
 height: 28px;
 background: rgba(255, 255, 255, 0.15);
 border-radius: var(--radius-sm);
 display: flex;
 align-items: center;
 justify-content: center;
 font-weight: var(--font-bold);
 font-size: 11px;
 }
 
 .sidebar-logo-text {
 font-size: var(--text-base);
 font-weight: var(--font-semibold);
 letter-spacing: -0.01em;
 }
 
 .sidebar-logo-text span {
 font-weight: var(--font-normal);
 opacity: 0.8;
 }
 
 /* === NAVIGATION === */
 .sidebar-nav {
 flex: 1;
 padding: var(--space-4);
 overflow-y: auto;
 }
 
 .nav-item {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 padding: 6px 10px;
 margin-bottom: 1px;
 background: transparent;
 border: none;
 border-left: 2px solid transparent;
 border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
 color: rgba(255, 255, 255, 0.6);
 font-size: 13px;
 font-weight: var(--font-normal);
 cursor: pointer;
 transition: all 100ms ease;
 width: 100%;
 text-align: left;
 }
 
 .nav-item:hover {
 background: rgba(255, 255, 255, 0.06);
 color: rgba(255, 255, 255, 0.9);
 }
 
 .nav-item.active {
 background: rgba(255, 255, 255, 0.1);
 border-left-color: #D97706;
 color: white;
 font-weight: var(--font-medium);
 }
 
 /* === MAIN CONTENT === */
 .main-content {
 flex: 1;
 overflow-y: auto;
 padding: var(--space-5) var(--space-6);
 max-width: 880px;
 }
 
 /* === HEADER === */
 .main-header {
 height: var(--header-height);
 background: var(--color-surface);
 border-bottom: 1px solid var(--color-border);
 display: flex;
 align-items: center;
 justify-content: space-between;
 padding: 0 var(--space-6);
 flex-shrink: 0;
 }
 
 .main-title {
 font-size: 15px;
 font-weight: var(--font-semibold);
 color: var(--color-text);
 letter-spacing: -0.01em;
 }
 
 /* === CONTENT AREA === */
 .content-area {
 flex: 1;
 overflow-y: auto;
 padding: var(--space-5) var(--space-6);
 max-width: 880px;
 }
 
 .section {
 display: none;
 }
 
 .section.active {
 display: block;
 padding-bottom: 60px;
 }
 
 /* ================================================================
 CARDS
 ================================================================ */
 
 .card {
 background: var(--color-surface);
 border: 1px solid var(--color-border);
 border-radius: var(--radius);
 margin-bottom: var(--space-4);
 }
 
 .card-header {
 padding: 8px 12px;
 border-bottom: 1px solid var(--color-border);
 background: var(--color-bg-subtle);
 font-weight: var(--font-semibold);
 font-size: 12px;
 text-transform: uppercase;
 letter-spacing: 0.4px;
 color: var(--color-text-muted);
 display: flex;
 align-items: center;
 justify-content: space-between;
 }
 
 /* NO colored headers - all same gray */
 .card-header-primary,
 .card-header-info,
 .card-header-success,
 .card-header-warning {
 background: var(--color-bg-muted);
 border-bottom-color: var(--color-border-light);
 }
 
 .card-body {
 padding: 12px;
 }
 
 /* ================================================================
 TABLES (Main Component)
 ================================================================ */
 
 .table {
 width: 100%;
 border-collapse: collapse;
 font-size: var(--text-base);
 }
 
 /* === TABLE HEADER === */
 .table thead {
 background: var(--color-bg-muted); /* Hellgrau wie MBS #F0F0F0 */
 }
 
 .table th {
 padding: var(--space-2) var(--space-3);
 text-align: left;
 font-weight: var(--font-semibold);
 color: var(--color-text-secondary);
 border-bottom: 2px solid var(--color-border);
 font-size: var(--text-sm);
 text-transform: uppercase;
 letter-spacing: 0.05em;
 }
 
 .table th:last-child,
 .table th.right {
 text-align: right;
 }
 
 /* === TABLE BODY === */
 .table td {
 padding: var(--space-3);
 border-bottom: 1px solid var(--color-border-light);
 color: var(--color-text);
 }
 
 .table td:last-child,
 .table td.right {
 text-align: right;
 font-variant-numeric: tabular-nums;
 font-weight: var(--font-medium);
 }
 
 .table tr:last-child td {
 border-bottom: none;
 }
 
 .table tbody tr:hover {
 background: var(--color-bg-subtle);
 }
 
 /* === SPECIAL ROWS === */
 .table .subtotal-row {
 background: var(--color-bg-subtle);
 font-weight: var(--font-medium);
 }
 
 .table .total-row {
 background: var(--color-bg-muted);
 border-top: 2px solid var(--color-border);
 font-weight: var(--font-bold);
 font-size: var(--text-lg);
 }
 
 .table .grand-total-row {
 background: var(--color-primary);
 color: white;
 font-weight: var(--font-bold);
 font-size: var(--text-xl);
 }
 
 /* === POSITION NUMBER (10, 20, 30...) === */
 .table .position-nr {
 width: 50px;
 text-align: right;
 font-weight: normal;
 font-variant-numeric: tabular-nums;
 }
 
 /* Drawing Number (Zeichnungsnummer) */
 .drawing-number {
 font-size: 13px;
 color: #374151;
 font-family: var(--font-mono);
 margin-top: 2px;
 }
 
 /* === MONOSPACE === */
 .table .mono {
 font-family: var(--font-mono);
 font-size: var(--text-sm);
 }
 
 /* ================================================================
 GRID LAYOUTS
 ================================================================ */
 
 .grid-2 {
 display: grid;
 grid-template-columns: 1fr 1fr;
 gap: var(--space-4);
 }
 
 .grid-3 {
 display: grid;
 grid-template-columns: repeat(3, 1fr);
 gap: var(--space-4);
 }
 
 /* ================================================================
 TYPOGRAPHY
 ================================================================ */
 
 h1, h2, h3, h4, h5, h6 {
 font-weight: var(--font-semibold);
 line-height: var(--leading-tight);
 color: var(--color-text);
 margin-bottom: var(--space-4);
 }
 
 h1 { font-size: var(--text-3xl); }
 h2 { font-size: var(--text-2xl); }
 h3 { font-size: var(--text-xl); }
 h4 { font-size: var(--text-lg); }
 
 /* ================================================================
 BUTTONS
 ================================================================ */
 
 .btn {
 display: inline-flex;
 align-items: center;
 justify-content: center;
 gap: 6px;
 padding: 0 12px;
 height: 32px;
 border-radius: var(--radius-sm);
 font-size: 13px;
 font-weight: var(--font-medium);
 cursor: pointer;
 transition: all 100ms ease;
 border: 1px solid var(--color-border);
 background: white;
 color: var(--color-text);
 white-space: nowrap;
 }
 
 .btn:hover {
 background: var(--color-bg-subtle);
 border-color: var(--color-text-muted);
 }
 
 .btn-primary {
 background: var(--color-primary);
 color: white;
 border-color: var(--color-primary);
 }
 
 .btn-primary:hover {
 background: var(--color-primary-hover);
 }
 
 .btn-secondary {
 background: white;
 color: var(--color-text-secondary);
 }
 
 .btn-sm {
 height: 26px;
 padding: 0 8px;
 font-size: 12px;
 }
 
 /* ================================================================
 FORM INPUTS
 ================================================================ */
 
 input[type="text"],
 input[type="number"],
 input[type="email"],
 select,
 textarea {
 width: 100%;
 padding: 0 10px;
 height: 32px;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 font-size: 13px;
 font-family: var(--font-sans);
 color: var(--color-text);
 background: white;
 transition: border-color 100ms;
 }
 
 textarea { height: auto; padding: 8px 10px; }
 
 input:focus,
 select:focus,
 textarea:focus {
 outline: none;
 border-color: var(--color-primary);
 box-shadow: 0 0 0 1px var(--color-primary);
 }
 
 /* ================================================================
 INFO BOX
 ================================================================ */
 
 .info-box {
 background: var(--color-bg-subtle);
 border: 1px solid var(--color-border-light);
 border-left-width: 3px;
 border-left-color: var(--color-primary);
 padding: var(--space-3) var(--space-4);
 border-radius: var(--radius);
 font-size: var(--text-sm);
 line-height: var(--leading-relaxed);
 color: var(--color-text-secondary);
 }
 
 /* ================================================================
 ANGEBOT-SPECIFIC
 ================================================================ */
 
 /* === PART INFO === */
 .part-info {
 margin-bottom: var(--space-4);
 }
 
 .part-name {
 font-size: var(--text-lg);
 font-weight: var(--font-semibold);
 color: var(--color-text);
 }
 
 .drawing-nr {
 font-size: var(--text-sm);
 color: var(--color-text-muted);
 font-family: var(--font-mono);
 margin-top: var(--space-1);
 }
 
 .drawing-nr::before {
 content: "Zeichnung-Nr.: ";
 font-family: var(--font-sans);
 }
 
 /* === VALIDITY === */
 .validity {
 font-size: var(--text-sm);
 color: var(--color-text-muted);
 margin-top: var(--space-2);
 }
 
 .validity strong {
 color: var(--color-text);
 font-weight: var(--font-semibold);
 }
 
 /* === DISCLAIMER === */
 .disclaimer {
 padding: var(--space-4);
 background: var(--color-bg-subtle);
 border-left: 3px solid var(--color-border);
 font-size: var(--text-sm);
 color: var(--color-text-secondary);
 line-height: var(--leading-relaxed);
 margin-top: var(--space-6);
 }
 
 /* === LEGAL FOOTER === */
 .legal-footer {
 margin-top: var(--space-12);
 padding-top: var(--space-6);
 border-top: 1px solid var(--color-border-light);
 font-size: var(--text-xs);
 color: var(--color-text-muted);
 line-height: var(--leading-relaxed);
 }
 
 .contact-footer {
 margin-top: var(--space-6);
 font-size: var(--text-xs);
 color: var(--color-text-hint);
 line-height: var(--leading-tight);
 }
 
 /* ================================================================
 LOADING OVERLAY
 ================================================================ */
 
 .loading-overlay {
 position: fixed;
 top: 0;
 left: 0;
 right: 0;
 bottom: 0;
 background: rgba(255, 255, 255, 0.95);
 display: none;
 align-items: center;
 justify-content: center;
 z-index: 9999;
 }
 
 .loading-overlay.active {
 display: flex;
 }
 
 .loading-spinner {
 width: 48px;
 height: 48px;
 border: 4px solid var(--color-border-light);
 border-top-color: var(--color-primary);
 border-radius: 50%;
 animation: spin 0.8s linear infinite;
 }
 
 @keyframes spin {
 to { transform: rotate(360deg); }
 }
 
 /* ================================================================
 UTILITIES
 ================================================================ */
 
 .mb-4 { margin-bottom: var(--space-4); }
 .mb-6 { margin-bottom: var(--space-6); }
 .mb-8 { margin-bottom: var(--space-8); }
 .mt-4 { margin-top: var(--space-4); }
 .mt-6 { margin-top: var(--space-6); }
 
 /* ================================================================
 PRINT STYLES
 ================================================================ */
 
 /* Badges */
 .badge {
 display: inline-block;
 font-size: 10px;
 font-weight: 600;
 padding: 2px 8px;
 border-radius: 3px;
 margin-left: var(--space-2);
 }
 .badge-info { background: var(--color-info-light); color: var(--color-info); }
 .badge-error { background: var(--color-error-light); color: var(--color-error); }
 .badge-success { background: var(--color-success-light); color: var(--color-success); }
 .badge-warning { background: var(--color-warning-light); color: var(--color-warning); }
 
 /* Price Hero */
 .price-hero {
 text-align: center;
 padding: var(--space-5) 0;
 margin-bottom: var(--space-4);
 }
 .price-label { font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
 .price-value { font-size: 36px; font-weight: 700; color: var(--color-text); font-family: var(--font-mono); letter-spacing: -1px; }
 .price-detail { font-size: 12px; color: var(--color-text-hint); margin-top: 4px; }
 
 .confidence-badge {
 display: inline-flex;
 align-items: center;
 gap: var(--space-2);
 padding: var(--space-2) var(--space-3);
 border-radius: var(--radius-md);
 font-size: 12px;
 margin-top: var(--space-3);
 }
 .confidence-high { background: var(--color-success-light); color: var(--color-success); }
 .confidence-medium { background: var(--color-warning-light); color: var(--color-warning); }
 .confidence-low { background: var(--color-error-light); color: var(--color-error); }
 
 /* Cost Breakdown */
 .cost-breakdown { padding: var(--space-3); }
 .cost-row {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-2) 0;
 border-bottom: 1px solid var(--color-border-light);
 }
 .cost-row:last-child { border-bottom: none; }
 .cost-row.subtotal { background: var(--color-bg); padding: var(--space-2) var(--space-3); margin: var(--space-2) calc(-1 * var(--space-3)); border-bottom: none; }
 .cost-row.total { background: var(--color-primary); color: white; padding: var(--space-3); margin: var(--space-2) calc(-1 * var(--space-3)) calc(-1 * var(--space-3)); border-radius: 0 0 var(--radius-md) var(--radius-md); border-bottom: none; }
 .cost-label { font-size: 13px; }
 .cost-value { font-weight: 600; font-family: var(--font-mono); font-size: 14px; }
 .cost-formula { font-size: 11px; color: var(--color-text-muted); font-family: var(--font-mono); }
 
 /* Code Block */
 .code-block {
 background: #1a1a2e;
 color: #e2e8f0;
 padding: var(--space-4);
 border-radius: var(--radius-md);
 font-family: var(--font-mono);
 font-size: 12px;
 line-height: 1.6;
 overflow-x: auto;
 white-space: pre;
 }
 .code-comment { color: #6b7280; }
 .code-keyword { color: #60a5fa; }
 .code-number { color: #34d399; }
 
 /* Contact Footer */
 .contact-footer { font-size: 11px; color: var(--color-text-hint); }
 
 /* Instruction sections */
 .instruction-section { margin-bottom: var(--space-4); }
 .instruction-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-3) var(--space-4);
 background: var(--color-bg);
 border-bottom: 1px solid var(--color-border);
 }
 .instruction-content { padding: var(--space-4); }
 
 /* Dimension groups */
 .dimension-group {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 margin-bottom: var(--space-3);
 }
 .dimension-group .form-group { margin-bottom: 0; flex: 1; }
 .dimension-separator { color: var(--color-text-muted); font-size: 16px; }
 .input-with-unit {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 }
 .input-with-unit .input { flex: 1; }
 .input-unit { font-size: 12px; color: var(--color-text-muted); white-space: nowrap; }
 
 /* Tooltip */
 .tooltip { position: relative; }
 
 /* Main content */
 main.main { flex: 1; overflow-y: auto; }
 
 /* Nav sections */
 .nav-section { margin-bottom: var(--space-3); }
 .nav-section-title {
 font-size: 10px;
 font-weight: var(--font-semibold);
 text-transform: uppercase;
 letter-spacing: 0.8px;
 color: rgba(255, 255, 255, 0.35);
 padding: 8px 12px 4px;
 }
 
 /* Select */
 .select {
 width: 100%;
 padding: var(--space-2) var(--space-3);
 border: 1px solid var(--color-border);
 border-radius: var(--radius);
 background: white;
 font-size: var(--text-base);
 color: var(--color-text);
 font-family: var(--font-sans);
 appearance: auto;
 }
 .select:focus { outline: 2px solid var(--color-primary); outline-offset: -1px; }
 
 /* Form groups */
 .form-group { margin-bottom: 12px; }
 
 /* Form utilities */
 .form-label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: var(--color-text-secondary); }
 .form-label-caps { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--space-2); color: var(--color-text-muted); }
 .input-mono { font-family: var(--font-mono); }
 .input-sm { padding: var(--space-1) var(--space-2); font-size: 13px; }
 .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-4); }
 .warning-box { background: var(--color-warning-light); border-left: 3px solid var(--color-warning); padding: var(--space-3); border-radius: var(--radius-sm); font-size: 13px; margin-bottom: var(--space-4); }
 
 /* Main actions */
 .main-actions { display: flex; gap: var(--space-2); }
 
 /* Loading steps */
 .loading-steps { margin-top: var(--space-5); }
 .loading-step {
 display: flex;
 align-items: center;
 gap: var(--space-3);
 padding: var(--space-2) 0;
 color: var(--color-text-muted);
 font-size: 14px;
 }
 .loading-step.active { color: var(--color-primary); font-weight: 600; }
 .loading-step.done { color: var(--color-success); }
 .loading-step-icon {
 width: 24px;
 height: 24px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 12px;
 font-weight: 600;
 background: var(--color-bg);
 border: 1px solid var(--color-border);
 }
 .loading-step.active .loading-step-icon { background: var(--color-primary); color: white; border-color: var(--color-primary); }
 .loading-step.done .loading-step-icon { background: var(--color-success); color: white; border-color: var(--color-success); }
 
 /* Feedback */
 .feedback-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); margin-bottom: var(--space-4); }
 .feedback-option {
 display: flex;
 flex-direction: column;
 align-items: center;
 gap: var(--space-2);
 padding: var(--space-4);
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 cursor: pointer;
 transition: border-color 0.15s;
 }
 .feedback-option:hover { border-color: var(--color-primary); }
 .feedback-option.selected { border-color: var(--color-primary); background: var(--color-bg); }
 .feedback-option-icon { font-size: 24px; }
 .feedback-option-label { font-size: 12px; font-weight: 600; }
 .feedback-card { margin-bottom: var(--space-4); }
 
 /* Sticky Feedback FAB */
 .feedback-fab {
 position: fixed;
 bottom: 20px;
 right: 20px;
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background: var(--color-primary);
 color: white;
 border: none;
 font-size: 18px;
 font-weight: 700;
 cursor: pointer;
 box-shadow: 0 2px 8px rgba(0,0,0,0.2);
 z-index: 1000;
 transition: transform 0.15s;
 }
 .feedback-fab:hover { transform: scale(1.1); }
 
 .feedback-panel {
 position: fixed;
 bottom: 70px;
 right: 20px;
 width: 280px;
 background: white;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-lg);
 box-shadow: 0 4px 20px rgba(0,0,0,0.15);
 z-index: 1001;
 display: none;
 overflow: hidden;
 }
 .feedback-panel.open { display: block; }
 .feedback-panel-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: 10px 14px;
 border-bottom: 1px solid var(--color-border);
 font-size: 13px;
 }
 .feedback-panel-body { padding: 12px 14px; }
 .feedback-panel-success {
 padding: 24px 14px;
 text-align: center;
 color: var(--color-success);
 }
 
 .fb-type-btn {
 flex: 1;
 padding: 5px 0;
 font-size: 11px;
 border: 1px solid var(--color-border);
 border-radius: var(--radius-sm);
 background: var(--color-bg);
 cursor: pointer;
 transition: all 0.1s;
 }
 .fb-type-btn.active {
 background: var(--color-primary);
 color: white;
 border-color: var(--color-primary);
 }
 
 /* AI Chat */
 .ai-msg code { background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 3px; font-family: var(--font-mono); font-size: 11px; }

 @media print { .feedback-fab, .feedback-panel, #actionBar, #workerDialog, #feedbackDialog { display: none !important; } }
 
 /* Cost detail expandables */
 .cost-detail {
 padding: 8px 12px;
 background: var(--color-bg-subtle);
 border-top: 1px solid var(--color-border);
 font-size: 12px;
 }
 .cost-detail-table {
 width: 100%;
 border-collapse: collapse;
 }
 .cost-detail-table td {
 padding: 3px 0;
 color: var(--color-text-secondary);
 }
 .cost-detail-table td.right {
 text-align: right;
 }
 .cost-detail-table tr.subtotal td {
 border-top: 1px solid var(--color-border);
 padding-top: 4px;
 font-weight: 500;
 }
 .cost-detail-table tr.total td {
 border-top: 2px solid var(--color-primary);
 padding-top: 5px;
 color: var(--color-text);
 }
 .cost-detail-note {
 margin-top: 6px;
 font-size: 11px;
 color: var(--color-text-hint);
 font-style: italic;
 }
 
 .part-grid {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
 gap: var(--space-4);
 margin-bottom: var(--space-5);
 }
 
 .part-card {
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 overflow: hidden;
 cursor: pointer;
 transition: border-color 0.15s, box-shadow 0.15s;
 background: white;
 }
 
 .part-card:hover {
 border-color: var(--color-text-muted);
 box-shadow: var(--shadow-sm);
 }
 
 .part-card.selected {
 border-color: var(--color-primary);
 box-shadow: 0 0 0 1px var(--color-primary);
 }
 
 .part-thumb {
 height: 120px;
 background: #FAFAFA;
 display: flex;
 align-items: center;
 justify-content: center;
 overflow: hidden;
 border-bottom: 1px solid var(--color-border);
 }
 
 .part-thumb img {
 max-width: 100%;
 max-height: 100%;
 object-fit: contain;
 }
 
 .part-info {
 padding: 8px 10px;
 }
 
 .part-name {
 font-weight: 600;
 font-size: 13px;
 margin-bottom: 1px;
 }
 
 .part-number {
 font-family: var(--font-mono);
 font-size: 10px;
 color: var(--color-text-hint);
 margin-bottom: 4px;
 }
 
 .part-meta {
 display: flex;
 gap: var(--space-2);
 font-size: 11px;
 color: var(--color-text-muted);
 }
 
 .part-price {
 font-weight: 600;
 color: var(--color-primary);
 margin-left: auto;
 }
 
 .trust-badges {
 display: flex;
 gap: var(--space-4);
 margin-bottom: var(--space-5);
 }
 
 .trust-badge {
 display: flex;
 align-items: center;
 gap: var(--space-2);
 font-size: 13px;
 color: var(--color-text-muted);
 }
 
 .trust-badge svg {
 width: 18px;
 height: 18px;
 flex-shrink: 0;
 stroke: var(--color-text-muted);
 }
 
 .scope-notice {
 background: var(--color-bg);
 border: 1px solid var(--color-border);
 border-radius: var(--radius-md);
 margin-bottom: var(--space-5);
 overflow: hidden;
 }
 
 .scope-header {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: var(--space-3) var(--space-4);
 cursor: pointer;
 }
 
 .scope-content {
 display: none;
 padding: var(--space-4);
 border-top: 1px solid var(--color-border);
 font-size: 13px;
 }
 
 .scope-content.open,
 .scope-content.expanded {
 display: block;
 }
 
 .op-badge {
 display: inline-flex;
 align-items: center;
 justify-content: center;
 width: 28px;
 height: 28px;
 border-radius: var(--radius-sm);
 background: var(--color-bg-elevated);
 border: 1px solid var(--color-border);
 font-size: 12px;
 font-weight: 600;
 font-family: var(--font-mono);
 color: var(--color-text);
 }
 
 .op-badge.critical {
 background: var(--color-warning-light);
 border-color: var(--color-warning);
 color: var(--color-warning);
 }
 
 .op-params {
 display: flex;
 gap: var(--space-3);
 font-size: 11px;
 font-family: var(--font-mono);
 color: var(--color-text-muted);
 }
 
 .op-params span {
 white-space: nowrap;
 }
 
 @media print {
 /* Hide UI-only elements */
 .sidebar,
 .main-header,
 .loading-overlay,
 .nav-section-title,
 .sidebar-footer,
 .feedback-fab,
 .feedback-panel,
 .scope-notice,
 .trust-badges,
 .part-grid,
 .upload-area,
 #werkstuckConfig,
 #partWarningsContainer,
 #warningsContainer,
 .confidence-badge,
 #customOpsContainer,
 #mainActions {
 display: none !important;
 }
 
 /* Hide interactive elements but keep display values */
 button, .btn, select { display: none !important; }
 input[type="number"], input[type="text"], input[type="date"], textarea { display: none !important; }
 
 /* Show values in table cells */
 td input[type="number"], td input[type="text"], th input { 
 display: inline !important; 
 border: none !important; 
 background: none !important; 
 padding: 0 !important; 
 font-size: inherit !important;
 width: auto !important;
 }
 
 /* Show checkboxes as visual indicator */
 input[type="checkbox"] { display: inline !important; }
 
 /* Hide abgewählte OPs im Print */
 div[style*="opacity: 0.35"], div[style*="opacity:0.35"] { display: none !important; }
 tr[style*="opacity: 0.35"], tr[style*="opacity:0.35"] { display: none !important; }
 
 /* Info-Boxen im Print behalten */
 .info-box { 
 display: block !important;
 border: 1px solid #ccc !important;
 background: #f9f9f9 !important;
 -webkit-print-color-adjust: exact;
 print-color-adjust: exact;
 font-size: 9px !important;
 padding: 6px 10px !important;
 margin-bottom: 8px !important;
 }
 
 .app { display: block; }
 .main { margin: 0; padding: 0; padding-bottom: 60px; }
 .main-content { margin: 0; padding: 0; }
 .content-area { padding: 0; max-width: 100%; }
 
 /* Show only active section */
 .section { display: none !important; }
 .section.active { display: block !important; }
 
 /* Cards */
 .card {
 border: 1px solid #ccc;
 box-shadow: none;
 page-break-inside: avoid;
 margin-bottom: 10px;
 break-inside: avoid;
 }
 .card-header {
 background: #f0f0f0 !important;
 color: #111 !important;
 -webkit-print-color-adjust: exact;
 print-color-adjust: exact;
 padding: 6px 12px !important;
 font-size: 11px !important;
 }

 /* Tables */
 table { font-size: 10px; border-collapse: collapse; }
 .table th, .table td { padding: 3px 6px !important; }
 .table th { background: #f5f5f5 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
 
 /* Cost breakdown */
 .cost-row { padding: 4px 12px !important; }
 .cost-detail { padding: 4px 8px !important; font-size: 10px !important; }
 .cost-detail-table td { padding: 1px 0 !important; }
 
 /* DB Rechnung */
 #dbTable th, #dbTable td { padding: 3px 6px !important; }
 
 /* Quantity table */
 #quantityTable th, #quantityTable td { font-size: 10px !important; }
 
 /* OP details — show all expanded for print */
 .op-params { font-size: 9px; }
 div[id$="-detail"] { page-break-inside: avoid; break-inside: avoid; }
 
 /* OP rows */
 div[style*="border-bottom: 1px solid"] { page-break-inside: avoid; break-inside: avoid; }
 
 /* Price display */
 .price-main { font-size: 24px !important; }
 .price-value { font-size: 20px !important; }
 
 /* Angebot: eigenes Layout belassen */
 #section-quote .card-body { padding: 20px !important; }
 #section-quote .card-header { display: none !important; }
 
 /* Typography */
 body { font-size: 11px; color: #000; font-family: Arial, Helvetica, sans-serif; }
 
 /* Page header — dynamisch je nach Section */
 .main::before {
 content: "CNC Planer Pro";
 display: block;
 font-size: 14px;
 font-weight: 700;
 margin-bottom: 8px;
 padding-bottom: 6px;
 border-bottom: 2px solid #111;
 }
 
 /* Angebot: keinen extra Header */
 #section-quote.active ~ .main::before,
 .main:has(#section-quote.active)::before {
 display: none !important;
 }
 
 @page {
 margin: 12mm 15mm;
 size: A4;
 }
 
 @page :first { margin-top: 15mm; }
 }
/* Custom SVG Icons */
.icon { display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; vertical-align:middle; flex-shrink:0; }
.icon-sm { width:14px; height:14px; }
.icon-lg { width:24px; height:24px; }
.icon svg { width:100%; height:100%; }
</style>
<script>
// Icon library — custom SVG icons matching Ainary CI
const ICONS = {
 brain: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a6 6 0 0 0-6 6c0 1.5.5 2.8 1.4 3.8L12 18l4.6-6.2A6 6 0 0 0 12 2z"/><path d="M12 18v4"/><circle cx="9" cy="8" r="1" fill="#c8aa50"/><circle cx="15" cy="8" r="1" fill="#c8aa50"/></svg>',
 wrench: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
 refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>',
 check: '<svg viewBox="0 0 24 24" fill="none" stroke="#28a745" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>',
 checkGold: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>',
 clock: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
 lightbulb: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg>',
 doc: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>',
 clipboard: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>',
 chat: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
 send: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4z"/></svg>',
 factory: '<svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 20h20"/><path d="M5 20V8l5 4V8l5 4V4h3v16"/><rect x="17" y="8" width="4" height="12"/></svg>',
 alert: '<svg viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
 alertGold: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
 trendDown: '<svg viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 18l-9.5-9.5-5 5L1 6"/><path d="M17 18h6v-6"/></svg>',
 chart: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>',
 crane: '<svg viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4l12-2v4"/><path d="M6 12h12"/><path d="M18 12v6"/><path d="M15 18h6"/><circle cx="18" cy="20" r="2"/></svg>',
 printer: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>',
 upload: '<svg viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>',
 circle_red: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="#dc3545"/></svg>',
 circle_yellow: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="#ffc107"/></svg>',
 circle_green: '<svg viewBox="0 0 16 16"><circle cx="8" cy="8" r="6" fill="#28a745"/></svg>',
 question: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
 protocol: '<svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15l2 2 4-4"/></svg>',
};

function icon(name, cls) {
 return '<span class="icon ' + (cls||'') + '">' + (ICONS[name] || '') + '</span>';
}
</script>
</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
<div style="font-size: 16px; font-weight: 500; color: var(--color-text);">Generiere Unterlagen...</div>
<div class="loading-steps">
<div class="loading-step" id="loadStep1">
<span class="loading-step-icon">1</span>
<span>Geometrie analysieren</span>
</div>
<div class="loading-step" id="loadStep2">
<span class="loading-step-icon">2</span>
<span>Bearbeitungszeiten berechnen</span>
</div>
<div class="loading-step" id="loadStep3">
<span class="loading-step-icon">3</span>
<span>Werkzeugeinsatz</span>
</div>
<div class="loading-step" id="loadStep4">
<span class="loading-step-icon">4</span>
<span>Maschinencode generieren</span>
</div>
<div class="loading-step" id="loadStep5">
<span class="loading-step-icon">5</span>
<span>Fertigungsanweisung erstellen</span>
</div>
</div>
</div>
 
<div class="app">
<!-- SIDEBAR -->
<aside class="sidebar">
<div class="sidebar-header">
<div class="sidebar-logo">
<div class="sidebar-logo-icon">CP</div>
<div class="sidebar-logo-text">CNC Planer <span>Pro</span></div>
<span style="background: var(--color-warning); color: white; font-size: 9px; padding: 2px 6px; border-radius: 3px; margin-left: 8px; font-weight: 600;">BETA</span>
</div>
</div>
 
<nav class="sidebar-nav">
<div class="nav-section">
<div class="nav-section-title">Vorkalkulation</div>
<button class="nav-item active" data-section="part" onclick="showSection('part', this)">
<span>Werkstück</span>
</button>
<button class="nav-item" data-section="checklist" onclick="showSection('checklist', this)">
<span>Prüfprotokoll</span>
<span class="checklist-badge" id="checklistBadge" style="display:none; background:var(--color-primary); color:#fff; font-size:10px; border-radius:8px; padding:1px 6px; margin-left:6px;">0</span>
</button>
<button class="nav-item" data-section="result" onclick="showSection('result', this)">
<span>Kalkulation</span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Fertigung</div>
<button class="nav-item" data-section="instructions" onclick="showSection('instructions', this)">
<span>Fertigungsanweisung</span>
</button>
<button class="nav-item" data-section="tools" onclick="showSection('tools', this)">
<span>Werkzeuge</span>
</button>
<button class="nav-item" data-section="code" onclick="showSection('code', this)">
<span>NC-Code <span style="font-size:8px;opacity:0.6;">(Simulation)</span></span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Ausgabe</div>
<button class="nav-item" data-section="quote" onclick="showSection('quote', this)">
<span>Angebot</span>
</button>
</div>
 
<div class="nav-section">
<div class="nav-section-title">Auswertung</div>
<button class="nav-item" data-section="protocol" onclick="showSection('protocol', this)">
<span>Protokoll</span>
</button>
<button class="nav-item" data-section="feedback" onclick="showSection('feedback', this)">
<span>Nachkalkulation</span>
</button>
</div>

<div class="nav-section">
<div class="nav-section-title">Konfiguration</div>
<button class="nav-item" data-section="params" onclick="showSection('params', this)">
<span>Preise &amp; Sätze</span>
</button>
<button class="nav-item" data-section="settings" onclick="showSection('settings', this)">
<span>Einstellungen</span>
</button>
</div>
</nav>
 
<div class="sidebar-footer">
<div style="font-size:10px;color:var(--color-text-hint);text-align:center;padding:var(--space-2) 0;">CNC Planer Pro v0.20 beta</div>
</div>
</aside>
 
<!-- MAIN CONTENT -->
<main class="main">
<header class="main-header">
<h1 class="main-title" id="mainTitle">Werkstück</h1>
<div class="main-actions" id="mainActions" style="display:none;">
<button class="btn btn-secondary btn-sm" onclick="window.print()">Drucken / PDF</button>
</div>
</header>
 
<div class="main-content">
<!-- ========================================
 SECTION: TEIL AUSWÄHLEN
 ======================================== -->
<div class="section active" id="section-part">
<!-- Trust Badges -->
<div class="trust-badges">
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9,12 12,15 16,10"/></svg>
 Integrierte Nachkalkulation
</div>
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
 Vorkalkulation in unter 30 Sekunden
</div>
<div class="trust-badge">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>
 Fertigungsanweisung und NC-Code
</div>
</div>
 
<!-- Scope Notice -->
<div class="scope-notice">
<div class="scope-header" onclick="toggleScope()">
<div>
<div style="font-weight: 600; color: var(--color-text);">Einsatzbereich und Systemgrenzen</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Abgedeckte Fertigungsverfahren, Werkstoffe und Toleranzbereiche</div>
</div>
<svg id="scopeChevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="2" style="transition: transform 0.2s;"><polyline points="6 9 12 15 18 9"/></svg>
</div>
<div class="scope-content" id="scopeContent">
<div class="grid-2" style="margin-bottom: var(--space-4);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Abgedeckt</div>
<ul style="font-size: 13px; color: var(--color-text-secondary); padding-left: var(--space-4);">
<li>Prismatische Werkstücke (Platten, Adapter, Gehäuse)</li>
<li>Bohrungen, Senkungen, Gewinde (M3–M16)</li>
<li>Taschen, Nuten, Planflächen</li>
<li>3-Achs-Fräsbearbeitung</li>
<li>Bau-, Vergütungs-, Edelstahl, Aluminium, Kunststoff</li>
</ul>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Außerhalb des Einsatzbereichs</div>
<ul style="font-size: 13px; color: var(--color-text-secondary); padding-left: var(--space-4);">
<li>Freiformflächen / 5-Achs-Simultanbearbeitung</li>
<li>Hochwarmfeste Legierungen (Titan, Inconel)</li>
<li>Toleranzen enger als IT7</li>
<li>Drehteile, Erodieren, Schleifen</li>
</ul>
</div>
</div>
<!-- Info-Box entfernt (zu viel Rauschen im Werkstück-Tab) -->
</div>
</div>
 
<!-- Part Selection -->
<div style="font-weight: 600; margin-bottom: var(--space-3);">Letzte analysierte Bauteile</div>
<div class="part-grid" id="partGrid">
<!-- Filled by JS -->
</div>
 
<!-- File Upload -->
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-body" style="text-align: center; padding: var(--space-8);">
<div style="margin-bottom: var(--space-3); color: var(--color-text-muted);"><span class="icon-lg" style="width:48px;height:48px;display:inline-flex;"><svg viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span></div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Neues Bauteil analysieren</div>
<div style="font-size: 13px; color: var(--color-text-muted); margin-bottom: var(--space-4);">STEP-Datei hochladen oder hier ablegen • .step, .stp, .pdf</div>
<input type="file" id="fileInput" accept=".step,.stp,.pdf,.dxf" style="display: none;" onchange="handleFileUpload(this)">
<button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">Datei auswählen</button>
<div id="uploadProgress" style="display:none; margin-top: var(--space-4); text-align:left; max-width:400px; margin-left:auto; margin-right:auto;">
<div style="font-weight:600; margin-bottom: var(--space-2);" id="uploadStatus">Analysiere Zeichnung...</div>
<div style="background:var(--color-border); border-radius:4px; height:6px; overflow:hidden; margin-bottom: var(--space-3);">
<div id="uploadBar" style="background:var(--color-primary); height:100%; width:0%; transition: width 0.5s ease;"></div>
</div>
<div id="uploadSteps" style="font-size:12px; color:var(--color-text-muted);"></div>
</div>
</div>
</div>
 
<!-- Werkstück -->
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-header"><span>Werkstück</span></div>
<div class="card-body">
<div class="form-group">
<label class="form-label">Werkstoff</label>
<select class="select" id="materialSelect" onchange="trackInputChange(this,'Werkstück','Werkstoff','')">
<optgroup label="Edelstahl">
<option value="1.4301">1.4301 (V2A)</option>
<option value="1.4404">1.4404 (V4A)</option>
<option value="1.4571">1.4571</option>
</optgroup>
<optgroup label="Baustahl">
<option value="S235JR" selected>S235JR</option>
<option value="S355J2">S355J2</option>
<option value="C45">C45</option>
</optgroup>
<optgroup label="Vergütungsstahl">
<option value="42CrMo4">42CrMo4</option>
<option value="34CrNiMo6">34CrNiMo6</option>
</optgroup>
<optgroup label="Aluminium">
<option value="AlMg3">AlMg3</option>
<option value="AlMgSi1">AlMgSi1 (6082)</option>
<option value="Al7075">Al7075-T6</option>
</optgroup>
<optgroup label="Buntmetalle">
<option value="CuZn39Pb3">Messing CuZn39Pb3</option>
<option value="CuSn8">Bronze CuSn8</option>
</optgroup>
<optgroup label="Guss">
<option value="GJS-700">GJS-700-2 (Sphäroguss)</option>
<option value="GJS-400">GJS-400-15 (Sphäroguss)</option>
<option value="GJL-250">GJL-250 (Grauguss)</option>
</optgroup>
<optgroup label="Kunststoff">
<option value="POM">POM</option>
<option value="PA6">PA6 (Nylon)</option>
<option value="PEEK">PEEK</option>
</optgroup>
</select>
</div>
 
<div class="form-group">
<label class="form-label">Rohmaße</label>
<div class="dimension-group">
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimX" value="440" onchange="trackInputChange(this,'Werkstück','Länge','mm')">
<span class="input-unit">mm</span>
</div>
</div>
<span class="dimension-separator">×</span>
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimY" value="50" onchange="trackInputChange(this,'Werkstück','Breite','mm')">
<span class="input-unit">mm</span>
</div>
</div>
<span class="dimension-separator">×</span>
<div class="form-group">
<div class="input-with-unit">
<input type="number" class="input input-mono" id="dimZ" value="20" onchange="trackInputChange(this,'Werkstück','Höhe','mm')">
<span class="input-unit">mm</span>
</div>
</div>
</div>
</div>
 
<div class="grid-3" style="gap: var(--space-4);">
<div class="form-group">
<label class="form-label">Stückzahl</label>
<div class="input-with-unit">
<input type="number" class="input input-mono" id="quantity" value="1" min="1" onchange="trackInputChange(this,'Werkstück','Stückzahl','Stk')">
<span class="input-unit">Stk</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Toleranzklasse</label>
<select class="select" id="toleranzKlasse">
<option value="IT11">IT11 (Grob)</option>
<option value="IT9" selected>IT9 (Standard)</option>
<option value="IT8">IT8 (Genau)</option>
<option value="IT7">IT7 (Fein)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Oberfläche (Ra)</label>
<select class="select" id="oberflaeche">
<option value="12.5">Ra 12,5 (Schruppen)</option>
<option value="6.3" selected>Ra 6,3 (Standard)</option>
<option value="3.2">Ra 3,2 (Schlichten)</option>
<option value="1.6">Ra 1,6 (Feinschlichten)</option>
<option value="0.8">Ra 0,8 (Poliert)</option>
</select>
</div>
</div>
 
<!-- Spannungen — editierbare Liste -->
<div class="card" id="werkstuckConfig" style="margin-top: var(--space-4);">
<div class="card-header">
<span>Aufspannungen</span>
<button class="btn btn-sm btn-secondary" onclick="addClamping()">+ Hinzufügen</button>
</div>
<div class="card-body" style="padding:0;">
<table class="table" id="clampingTable">
<thead>
<tr>
<th style="width:40px;">Nr.</th>
<th>Spannmittel</th>
<th class="right" style="width:100px;">Rüstzeit</th>
<th style="min-width:220px;">Herleitung / Feedback</th>
<th style="width:40px;"></th>
</tr>
</thead>
<tbody id="clampingRows">
<tr>
<td class="mono">1</td>
<td>
<select class="select" onchange="updateClampingTotal()">
<option value="schraubstock" selected>Schraubstock</option>
<option value="schraubstock2">2× Schraubstock (Langteil)</option>
<option value="tischspannung">Tischspannung / Pratzen</option>
<option value="nullpunkt">Nullpunktspannsystem</option>
<option value="spezial">Sondervorrichtung</option>
</select>
</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="15" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
<td style="min-width:220px;"><div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">REFA Richtwert Schraubstock</div></td>
<td></td>
</tr>
<tr>
<td class="mono">2</td>
<td>
<select class="select" onchange="updateClampingTotal()">
<option value="schraubstock" selected>Schraubstock</option>
<option value="schraubstock2">2× Schraubstock (Langteil)</option>
<option value="tischspannung">Tischspannung / Pratzen</option>
<option value="nullpunkt">Nullpunktspannsystem</option>
<option value="spezial">Sondervorrichtung</option>
</select>
</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="10" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
<td style="min-width:220px;"><div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">Folgeaufspannung (reduziert)</div></td>
<td style="text-align:center;"><button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">×</button></td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:600;background:var(--color-bg-subtle);">
<td colspan="2">Gesamte Rüstzeit</td>
<td class="right mono" id="totalSetupTimeDisplay">25 min</td>
<td></td>
<td></td>
</tr>
</tfoot>
</table>
</div>
</div>

</div>
</div>

<!-- Plausibilitätshinweise (Werkstück/Aufspannung) -->
<div id="partWarningsContainer" style="margin-top: var(--space-3);"></div>

<!-- PRÜFPROTOKOLL Button -->
<div style="margin-top: var(--space-4);">
<button class="btn btn-primary" onclick="runCalculation()" style="width:100%; height:44px; font-size:15px; font-weight:600;">
Prüfprotokoll →
</button>
</div>

</div>
 
<!-- ========================================
 SECTION: PRÜFPROTOKOLL
 ======================================== -->
<div class="section" id="section-checklist">
<div class="card">
<div class="card-header"><span><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a6 6 0 0 0-6 6c0 1.5.5 2.8 1.4 3.8L12 18l4.6-6.2A6 6 0 0 0 12 2z"/><path d="M12 18v4"/><circle cx="9" cy="8" r="1" fill="#c8aa50"/><circle cx="15" cy="8" r="1" fill="#c8aa50"/></svg></span> Prüfprotokoll — Fehlende Angaben klären</span></div>
<div class="card-body">
<p style="color: var(--color-text-muted); margin-bottom: var(--space-4);">
Der CNC Planer Pro prüft automatisch, ob alle kalkulationsrelevanten Informationen vorliegen. 
<strong style="color: var(--color-danger);">Rote Fragen</strong> müssen beantwortet werden, bevor die Kalkulation freigegeben wird.
<span style="color: var(--color-warning);">Gelbe Fragen</span> verbessern die Genauigkeit.
</p>

<div id="checklistQuestions" style="display:flex; flex-direction:column; gap: var(--space-3);">
<!-- Questions injected by generateChecklist() -->
</div>

<div id="checklistSummary" style="margin-top: var(--space-5); padding: var(--space-4); border-radius: var(--radius); background: var(--color-surface-alt); display:none;">
<div style="font-weight:600; margin-bottom: var(--space-2);">Protokoll-Zusammenfassung</div>
<div id="checklistSummaryContent"></div>
</div>

<div style="margin-top: var(--space-4); display:flex; gap: var(--space-3); flex-wrap: wrap;">
<button class="btn btn-primary" onclick="submitChecklist()">Prüfung abschließen → Kalkulation</button>
<button class="btn btn-secondary" onclick="exportChecklistPDF()">Protokoll exportieren</button>
</div>
</div>
</div>

<!-- Dev feedback removed — covered by global Action Bar -->
</div>

<!-- ========================================
 SECTION: PARAMETER
 ======================================== -->
<div class="section" id="section-params">
<div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-5); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-3);">
<button class="btn btn-sm btn-primary" id="tabParamPreis" onclick="showParamTab('preis')">Stundensätze</button>
<button class="btn btn-sm btn-secondary" id="tabParamMaterial" onclick="showParamTab('material')">Materialpreise</button>
<button class="btn btn-sm btn-secondary" id="tabParamZuschlag" onclick="showParamTab('zuschlag')">Zuschläge</button>
</div>
 
<!-- Hidden elements for backward compatibility -->
<span id="setupTimeDisplay" style="display:none;">25 min</span>
<span id="setupCostDisplay" style="display:none;">EUR 37,92</span>
<span id="clampingDescription" style="display:none;"></span>
<select id="clampingSelect" style="display:none;"><option value="schraubstock" selected></option></select>
<select id="setupCount" style="display:none;"><option value="2" selected></option></select>
 
<div id="param-preis" style="display: block;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Maschinenstundensätze (EUR/h)</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Arbeitsgang</th>
<th class="right">Lohn (EUR/h)</th>
<th class="right">Maschine (EUR/h)</th>
<th class="right">Gesamt (EUR/h)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CNC-Fräsen (3-Achs)</strong></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="38" id="rateCncLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="32" id="rateCncMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" style="font-weight: 600;" id="rateCncTotal">EUR 70</td>
</tr>
<tr>
<td>CNC-Fräsen (5-Achs)</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="52" id="rate5AxLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="68" id="rate5AxMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rate5AxTotal">EUR 120</td>
</tr>
<tr>
<td>CNC-Drehen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="45" id="rateDrehenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="38" id="rateDrehenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateDrehenTotal">EUR 83</td>
</tr>
<tr>
<td>Sägen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="35" id="rateSaegenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="10" id="rateSaegenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateSaegenTotal">EUR 45</td>
</tr>
<tr>
<td>Entgraten / Schleifen</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="28" id="rateEntgratenLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="3" id="rateEntgratenMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="rateEntgratenTotal">EUR 31</td>
</tr>
<tr>
<td>Qualitätsprüfung</td>
<td class="right"><input type="number" class="input input-sm input-mono" value="45" id="ratePruefLabor" style="width: 80px;" onchange="updateRates()"></td>
<td class="right"><input type="number" class="input input-sm input-mono" value="15" id="ratePruefMachine" style="width: 80px;" onchange="updateRates()"></td>
<td class="right mono" id="ratePruefTotal">EUR 60</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Hinweis:</strong> Maschinenstundensatz = Lohnkosten + Maschinenkosten (Abschreibung, Energie, Wartung, Raumkosten). Branchenüblich: EUR 65-95/h für 3-Achs, EUR 90-140/h für 5-Achs.
</div>
</div>
 
<!-- TAB: Materialpreise -->
<div id="param-material" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Materialpreise (EUR/kg)</span></div>
<div class="card-body">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-4);">
 Tagesaktuelle Preise vom Stahlhandel übernehmen. Verschnitt wird separat berechnet.
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Baustahl</div>
<div class="grid-4" style="gap: var(--space-3); margin-bottom: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">S235JR</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="1.40" step="0.01" id="matS235JR" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">S355J2</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="3.00" step="0.01" id="matS355J2" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">C45</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="1.80" step="0.01" id="matC45" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">42CrMo4</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.20" step="0.01" id="mat42CrMo4" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Edelstahl</div>
<div class="grid-4" style="gap: var(--space-3); margin-bottom: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4301 (V2A)</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.80" step="0.01" id="mat14301" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4404 (V4A)</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="5.50" step="0.01" id="mat14404" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">1.4571</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="5.20" step="0.01" id="mat14571" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">Duplex</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="18.00" step="0.01" id="matDuplex" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-secondary);">Aluminium</div>
<div class="grid-4" style="gap: var(--space-3);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">AlMg3</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.50" step="0.01" id="matAlMg3" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">AlMgSi1</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="4.80" step="0.01" id="matAlMgSi1" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label form-label-caps">Al7075-T6</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="12.00" step="0.01" id="matAl7075" onchange="updateMaterials()">
<span class="input-unit">EUR/kg</span>
</div>
</div>
</div>
</div>
</div>
</div>
 
<!-- TAB: Zuschläge -->
<div id="param-zuschlag" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Zuschlagskalkulation (Industriestandard)</span></div>
<div class="card-body">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-4);">
 Zuschlagssätze nach betriebswirtschaftlicher Kalkulationsmethode. Basis: Herstellkosten.
</div>
 
<table class="table">
<thead>
<tr>
<th>Zuschlagsart</th>
<th style="width: 120px;">Satz (%)</th>
<th>Basis</th>
<th>Branchenüblich</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<strong>Verschnitt / Aufmaß</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Materialverlust beim Zuschnitt</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="10" id="settingScrap" onchange="onZuschlagChange('settingScrap', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Materialgewicht</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr>
<td>
<strong>Materialgemeinkosten (MGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Einkauf, Lager, Handling</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="5" id="zuschlagMGK" onchange="onZuschlagChange('zuschlagMGK', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Materialkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr>
<td>
<strong>Fertigungsgemeinkosten (FGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Meister, Instandhaltung, Energie</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="0" id="zuschlagFGK" onchange="onZuschlagChange('zuschlagFGK', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Fertigungskosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">100-200% (oft in MSS)</td>
</tr>
<tr style="background: var(--color-info-light);">
<td>
<strong>AV-Aufschlag</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Arbeitsvorbereitung, Programmierung, CAM</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="12" id="zuschlagAV" onchange="onZuschlagChange('zuschlagAV', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Fertigungskosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr style="background: var(--color-bg);">
<td colspan="4" style="font-weight: 600; color: var(--color-text-secondary);">= Herstellkosten (HK)</td>
</tr>
<tr>
<td>
<strong>Verwaltungsgemeinkosten (VwGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Buchhaltung, IT, Geschäftsführung</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="10" id="zuschlagVwGK" onchange="onZuschlagChange('zuschlagVwGK', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Herstellkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">8-15%</td>
</tr>
<tr>
<td>
<strong>Vertriebsgemeinkosten (VtGK)</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Angebote, Kundenbetreuung, Versand</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="5" id="zuschlagVtGK" onchange="onZuschlagChange('zuschlagVtGK', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Herstellkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">3-8%</td>
</tr>
<tr style="background: var(--color-bg);">
<td colspan="4" style="font-weight: 600; color: var(--color-text-secondary);">= Selbstkosten (SK)</td>
</tr>
<tr style="background: var(--color-success-light);">
<td>
<strong>Gewinnzuschlag / Marge</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Unternehmensgewinn</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="8" id="zuschlagGewinn" onchange="onZuschlagChange('zuschlagGewinn', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Selbstkosten</td>
<td style="font-size: 12px; color: var(--color-text-muted);">5-15%</td>
</tr>
<tr style="background: var(--color-bg);">
<td colspan="4" style="font-weight: 700; color: var(--color-text);">= Angebotspreis (netto)</td>
</tr>
<tr>
<td>
<strong>Mehrwertsteuer</strong><br>
<span style="font-size: 11px; color: var(--color-text-muted);">Gesetzliche MwSt</span>
</td>
<td><input type="number" class="input input-sm input-mono" value="19" id="settingVat" onchange="onZuschlagChange('settingVat', this)" style="width: 80px;"></td>
<td class="mono" style="font-size: 12px;">auf Angebotspreis</td>
<td style="font-size: 12px; color: var(--color-text-muted);">19% (DE)</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Sondervereinbarungen / MEK -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Sondervereinbarungen</span></div>
<div class="card-body">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-4);">
Zusätzliche Vereinbarungen und Einzelkosten, die separat in der Kalkulation ausgewiesen werden.
</div>

<div class="grid-2" style="gap: var(--space-4); margin-bottom: var(--space-4);">
<div class="form-group">
<label class="form-label">MEK (Materialeinzelkosten)</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="0" step="0.01" id="sonderMEK" onchange="onZuschlagChange('sonderMEK', this)">
<span class="input-unit">EUR</span>
</div>
<div style="font-size: 11px; color: var(--color-text-muted); margin-top: 4px;">
Z.B. Normteile, Kleinmaterial, Verbrauchswerkzeuge (separat kalkuliert)
</div>
</div>

<div class="form-group">
<label class="form-label">Transportkosten</label>
<div class="input-with-unit">
<input type="number" class="input input-sm input-mono" value="0" step="0.01" id="sonderTransport" onchange="onZuschlagChange('sonderTransport', this)">
<span class="input-unit">EUR</span>
</div>
<div style="font-size: 11px; color: var(--color-text-muted); margin-top: 4px;">
Spezialversand, Gefahrgut, Übermaß etc.
</div>
</div>
</div>

<div class="form-group" style="margin-bottom: var(--space-3);">
<label class="form-label">Beistellmaterial</label>
<div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2);">
<input type="checkbox" id="sonderBeistellung" onchange="onZuschlagChange('sonderBeistellung', this.checked ? 'ja' : 'nein')">
<span style="font-size: 13px;">Material wird vom Auftraggeber beigestellt</span>
</div>
<div style="font-size: 11px; color: var(--color-text-muted);">
Wenn aktiviert, werden Materialkosten in der Kalkulation mit EUR 0 angesetzt.
</div>
</div>

<div class="form-group">
<label class="form-label">Sonstige Vereinbarungen</label>
<textarea class="input input-sm" id="sonderSonstiges" rows="3" placeholder="Freitext: z.B. Abnahmeprüfung, Sonderlackierung, beschleunigte Lieferung, Vertraulichkeitsvereinbarung..." onchange="onZuschlagChange('sonderSonstiges', this.value)" style="font-size: 12px;"></textarea>
</div>

<div class="info-box" style="margin-top: var(--space-3);">
<strong>Hinweis:</strong> Sondervereinbarungen werden in der Kostenaufschlüsselung als separate Zeile nach Materialkosten aufgeführt (wenn > 0). Im Angebot können diese als eigene Positionen ausgewiesen werden.
</div>
</div>
</div>

</div><!-- /param-zuschlag -->
 
<div id="param-maschine" style="display: none;">
<div class="card" style="margin-bottom: var(--space-6);">
<div class="card-header"><span>Maschine</span></div>
<div class="card-body">
<div class="form-group">
<label class="form-label">CNC-Typ</label>
<select class="select" id="cncType">
<option value="3-achs" selected>3-Achs</option>
<option value="5-achs">5-Achs</option>
</select>
</div>
</div>
</div>
</div>
 
<!-- Plausibility Warnings -->
<div id="warningsContainer"></div>
 
<button class="btn btn-primary" onclick="runCalculation()" style="width:100%;">Prüfprotokoll und Kalkulation starten →</button>
</div>
 
<!-- ========================================
 SECTION: ERGEBNIS
 ======================================== -->
<div class="section" id="section-result">
<!-- Prüfprotokoll Hinweis (diskret) -->
<div id="checklistHint" style="display:none;padding:10px 16px;background:#fffbeb;border:1px solid #f59e0b;border-radius:var(--radius);margin-bottom:var(--space-4);font-size:13px;color:#92400e;display:flex;align-items:center;gap:8px;">
<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
<span>Prüfprotokoll noch nicht abgeschlossen — <a href="#" onclick="showSection('checklist', document.querySelector('[data-section=checklist]'));return false;" style="color:#92400e;font-weight:600;">jetzt ausfüllen</a> für eine genauere Kalkulation.</span>
</div>
<!-- Price Hero with Confidence -->
<div class="price-hero">
<div class="price-label">Stückpreis</div>
<div class="price-value" id="priceDisplay">EUR 64,89</div>
<div class="price-detail">inkl. Material, Bearbeitung, Einrichtung</div>
<div class="confidence-badge confidence-medium" id="confidenceBadge">
<span></span>Richtwert — Abgleich mit Nachkalkulation empfohlen
</div>
</div>
 
<!-- Pricing Insights Panel -->
<div class="card" id="pricingInsightsCard" style="margin-bottom: var(--space-4); border-left: 3px solid var(--color-primary);">
<div class="card-header"><span><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg></span> Preisempfehlungen</span><span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;">KI-gestützte Insights</span></div>
<div class="card-body" id="pricingInsights" style="padding: var(--space-3);">
<!-- Filled by generatePricingInsights() -->
</div>
</div>

<!-- Navigation zu Einstellungen -->
<div style="display:flex;gap:var(--space-3);margin-bottom:var(--space-4);font-size:12px;">
<a href="#" onclick="showSection('params', document.querySelector('[data-section=params]'));showParamTab('stunden');return false;" style="color:var(--color-text-muted);text-decoration:underline;">Stundensätze anpassen</a>
<span style="color:var(--color-border);">|</span>
<a href="#" onclick="showSection('params', document.querySelector('[data-section=params]'));showParamTab('zuschlag');return false;" style="color:var(--color-text-muted);text-decoration:underline;">Zuschläge anpassen</a>
<span style="color:var(--color-border);">|</span>
<a href="#" onclick="showSection('params', document.querySelector('[data-section=params]'));showParamTab('material');return false;" style="color:var(--color-text-muted);text-decoration:underline;">Materialpreise anpassen</a>
</div>

<!-- Download/Druck -->
<div style="margin-bottom: var(--space-4);">
<div style="display:flex; gap: var(--space-3); flex-wrap:wrap; margin-bottom: var(--space-2);">
<button class="btn btn-primary" onclick="printFullReport()">Vollständigen Bericht drucken</button>
<button class="btn btn-secondary" onclick="window.print()">Nur Kalkulation drucken</button>
</div>
<div style="font-size:11px; color:var(--color-text-muted);">
Vollständiger Bericht enthält: Projektdaten, Arbeitsgänge, Kalkulation, Zuschläge, Stückpreis, Änderungsprotokoll
</div>
</div>

<div>
<!-- Kostenaufschlüsselung (volle Breite) -->
<div class="card">
<div class="card-header"><span>Kostenaufschlüsselung</span><span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;">Klick für Details</span></div>
<div class="cost-breakdown" style="border: none; border-radius: 0;">

<!-- Material -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('mat')">
<div style="flex:1;">
<div class="cost-label">Material + MGK <span style="color:var(--color-text-hint);font-size:11px;">▾</span></div>
<div class="cost-formula" id="matFormula">2,2 kg × EUR 6,79/kg + <span id="matFormulaMGK">10</span>% MGK</div>
</div>
<div class="cost-value" id="matCost">EUR 16,42</div>
</div>
<div id="costDetail-mat" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Rohmaße</td><td class="right mono" id="cdMatDims">440 × 50 × 20 mm</td></tr>
<tr><td>Volumen</td><td class="right mono" id="cdMatVol">440 cm³</td></tr>
<tr><td>Werkstoff / Dichte</td><td class="right mono" id="cdMatDensity">S235JR / 7,85 g/cm³</td></tr>
<tr><td>Gewicht (Rohteil)</td><td class="right mono" id="cdMatWeight">2,20 kg</td></tr>
<tr><td>Materialpreis <span class="info-ref" onclick="event.stopPropagation(); this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer; color:var(--color-info); margin-left:4px; font-size:10px; border:1px solid var(--color-info); border-radius:50%; width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center;">ⓘ</span><span style="display:none;font-size:11px;color:var(--color-text-muted);padding:4px 8px;background:var(--color-bg-subtle);border-radius:4px;margin-top:4px;">Quelle: Stahlhandel Deutschland, Stand Q1/2026</span></td><td class="right mono" id="cdMatPrice">EUR 6,79/kg</td></tr>
<tr><td>Materialkosten (netto)</td><td class="right mono" id="cdMatNet">EUR 14,93</td></tr>
<tr><td>+ Verschnitt/Aufmaß (10%)</td><td class="right mono" id="cdMatScrap">EUR 1,49</td></tr>
<tr class="subtotal"><td>Materialeinzelkosten (MEK)</td><td class="right mono" id="cdMatMEK">EUR 16,42</td></tr>
<tr><td>+ MGK (<span id="cdMatMGKpct">10</span>%)</td><td class="right mono" id="cdMatMGK">EUR 1,64</td></tr>
<tr class="total"><td><strong>Materialkosten gesamt</strong></td><td class="right mono" id="cdMatTotal"><strong>EUR 18,07</strong></td></tr>
</table>
<div class="cost-detail-note">MGK = Materialgemeinkosten (Lager, Beschaffung, Qualitätsprüfung Wareneingang)</div>
</div>

<!-- Fertigung -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('mach')">
<div style="flex:1;">
<div class="cost-label">Fertigung + AV <span style="color:var(--color-text-hint);font-size:11px;">▾</span></div>
<div class="cost-formula" id="machFormula">12,5 min × EUR 91/h + 8% AV</div>
</div>
<div class="cost-value" id="machCost">EUR 18,96</div>
</div>
<div id="costDetail-mach" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Bearbeitungszeit (t<sub>h</sub> + t<sub>n</sub>)</td><td class="right mono" id="cdMachTime">12,5 min</td></tr>
<tr><td>Lohnkosten</td><td class="right mono" id="cdMachLabor">EUR 49/h</td></tr>
<tr><td>Maschinenstundensatz</td><td class="right mono" id="cdMachRate">EUR 42/h</td></tr>
<tr><td>Gesamtstundensatz <span class="info-ref" onclick="event.stopPropagation(); this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer; color:var(--color-info); margin-left:4px; font-size:10px; border:1px solid var(--color-info); border-radius:50%; width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center;">ⓘ</span><span style="display:none;font-size:11px;color:var(--color-text-muted);padding:4px 8px;background:var(--color-bg-subtle);border-radius:4px;margin-top:4px;">Quelle: Betriebliche Kalkulation, aufgeteilt in Lohn- und Maschinenkosten nach REFA</span></td><td class="right mono" id="cdMachTotal">EUR 91/h</td></tr>
<tr><td>Fertigungskosten (netto)</td><td class="right mono" id="cdMachNet">EUR 18,96</td></tr>
<tr class="subtotal"><td>Fertigungseinzelkosten (FEK)</td><td class="right mono" id="cdMachFEK">EUR 18,96</td></tr>
<tr><td>+ AV-Aufschlag (<span id="cdMachAVpct">8</span>%)</td><td class="right mono" id="cdMachAV">EUR 1,52</td></tr>
<tr class="total"><td><strong>Fertigungskosten gesamt</strong></td><td class="right mono" id="cdMachGesamt"><strong>EUR 20,48</strong></td></tr>
</table>
<div class="cost-detail-note">AV = Arbeitsvorbereitung (Programmierung, Prüfplanung, Werkzeugvoreinstellung)</div>
</div>

<!-- Einrichtung -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('setup')">
<div style="flex:1;">
<div class="cost-label">Rüsten <span style="color:var(--color-text-hint);font-size:11px;">▾</span></div>
<div class="cost-formula" id="setupFormula">25 min × EUR 91/h ÷ 1</div>
</div>
<div class="cost-value" id="setupCost">EUR 37,92</div>
</div>
<div id="costDetail-setup" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Spannmittel</td><td class="right mono" id="cdSetupClamping">Schraubstock</td></tr>
<tr><td>Rüstzeit (Grundzeit)</td><td class="right mono" id="cdSetupBase">15 min</td></tr>
<tr><td>Aufspannungen</td><td class="right mono" id="cdSetupCount">2</td></tr>
<tr><td>Rüstzeit (gesamt)</td><td class="right mono" id="cdSetupTime">25,0 min</td></tr>
<tr><td>Stundensatz</td><td class="right mono">EUR 91/h</td></tr>
<tr><td>Rüstkosten (gesamt)</td><td class="right mono" id="cdSetupTotal">EUR 37,92</td></tr>
<tr><td>Stückzahl</td><td class="right mono" id="cdSetupQty">1</td></tr>
<tr class="total"><td><strong>Rüstkosten / Stück</strong></td><td class="right mono" id="cdSetupPerPiece"><strong>EUR 37,92</strong></td></tr>
</table>
<div class="cost-detail-note">Bei Stückzahl 10: EUR 3,79/Stück · Bei 100: EUR 0,38/Stück</div>
</div>

<!-- Werkzeugverschleiß entfällt — im Maschinenstundensatz enthalten -->

<!-- VwGK + VtGK -->
<div class="cost-row" style="cursor:pointer;" onclick="toggleCostDetail('overhead')">
<div style="flex:1;">
<div class="cost-label">VwGK + VtGK <span style="color:var(--color-text-hint);font-size:11px;">▾</span></div>
<div class="cost-formula" id="additionalFormula">Verwaltung + Vertrieb</div>
</div>
<div class="cost-value" id="additionalCost">EUR 15,17</div>
</div>
<div id="costDetail-overhead" class="cost-detail" style="display:none;">
<table class="cost-detail-table">
<tr><td>Herstellkosten (HK)</td><td class="right mono" id="cdOhHK">EUR 89,38</td></tr>
<tr><td>+ Verwaltungsgemeinkosten (<span id="cdOhVwGKpct">12</span>%) <span class="info-ref" onclick="event.stopPropagation(); this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer; color:var(--color-info); margin-left:4px; font-size:10px; border:1px solid var(--color-info); border-radius:50%; width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center;">ⓘ</span><span style="display:none;font-size:11px;color:var(--color-text-muted);padding:4px 8px;background:var(--color-bg-subtle);border-radius:4px;margin-top:4px;">Quelle: Branchenübliche Kalkulationssätze für Lohnfertiger (&lt;50 MA)</span></td><td class="right mono" id="cdOhVwGK">EUR 10,73</td></tr>
<tr><td>+ Vertriebsgemeinkosten (<span id="cdOhVtGKpct">5</span>%)</td><td class="right mono" id="cdOhVtGK">EUR 4,47</td></tr>
<tr class="total"><td><strong>Gemeinkosten gesamt</strong></td><td class="right mono" id="cdOhTotal"><strong>EUR 15,20</strong></td></tr>
</table>
<div class="cost-detail-note">VwGK = Verwaltung, Buchhaltung, IT, Geschäftsführung · VtGK = Vertrieb, Angebotserstellung, Kundenpflege</div>
</div>

<div class="cost-row subtotal">
<div class="cost-label">Selbstkosten</div>
<div class="cost-value" id="totalCost">EUR 109,21</div>
</div>
<div class="cost-row">
<div class="cost-label">+ Gewinn (<span id="marginDisplay">10</span>%)</div>
<div class="cost-value" id="marginCost">EUR 10,92</div>
</div>
<div class="cost-row total">
<div class="cost-label">Angebotspreis</div>
<div class="cost-value" id="sellPrice">EUR 120,13</div>
</div>
</div>
</div>
 
<!-- Mengenstaffel entfernt -->
</div>
 
<!-- Deckungsbeitragsrechnung -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Deckungsbeitragsrechnung</span></div>
<div class="card-body" style="padding: 0;">
<table class="table" id="dbTable">
<thead>
<tr>
<th></th>
<th class="right" style="width:120px;">pro Stück</th>
<th class="right" style="width:120px;">Auftrag (<span id="dbQtyHead">1</span> Stk)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Angebotspreis (netto)</td>
<td class="right mono" id="dbAngebotspreis">EUR 120,13</td>
<td class="right mono" id="dbAngebotspreis_t">EUR 120,13</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– Materialeinzelkosten (MEK)</td>
<td class="right mono" id="dbMEK">EUR 14,93</td>
<td class="right mono" id="dbMEK_t">EUR 14,93</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– Fertigungseinzelkosten (FEK)</td>
<td class="right mono" id="dbFEK">EUR 18,96</td>
<td class="right mono" id="dbFEK_t">EUR 18,96</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– Sondereinzelkosten (Rüsten)</td>
<td class="right mono" id="dbSetup">EUR 37,92</td>
<td class="right mono" id="dbSetup_t">EUR 37,92</td>
</tr>
<tr style="font-weight: 600; background: var(--color-bg-subtle);">
<td>= Deckungsbeitrag I</td>
<td class="right mono" id="dbDB1">EUR 48,32</td>
<td class="right mono" id="dbDB1_t">EUR 48,32</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– MGK (<span id="dbMGKpct">10</span>%)</td>
<td class="right mono" id="dbMGK">EUR 1,49</td>
<td class="right mono" id="dbMGK_t">EUR 1,49</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– AV (<span id="dbAVpct">8</span>%)</td>
<td class="right mono" id="dbAV">EUR 1,52</td>
<td class="right mono" id="dbAV_t">EUR 1,52</td>
</tr>
<!-- Werkzeugverschleiß entfällt — im Maschinenstundensatz -->
<tr style="font-weight: 600; background: var(--color-bg-subtle);">
<td>= Deckungsbeitrag II</td>
<td class="right mono" id="dbDB2">EUR 24,57</td>
<td class="right mono" id="dbDB2_t">EUR 24,57</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– VwGK (<span id="dbVwGKpct">12</span>%)</td>
<td class="right mono" id="dbVwGK">EUR 10,73</td>
<td class="right mono" id="dbVwGK_t">EUR 10,73</td>
</tr>
<tr>
<td style="padding-left: 24px; color: var(--color-text-secondary);">– VtGK (<span id="dbVtGKpct">5</span>%)</td>
<td class="right mono" id="dbVtGK">EUR 4,47</td>
<td class="right mono" id="dbVtGK_t">EUR 4,47</td>
</tr>
<tr style="font-weight: 700; border-top: 2px solid var(--color-primary);">
<td>= Betriebsergebnis</td>
<td class="right mono" id="dbGewinn">EUR 10,92</td>
<td class="right mono" id="dbGewinn_t">EUR 10,92</td>
</tr>
<tr>
<td>Gewinnmarge</td>
<td class="right mono" id="dbMarge">9,1%</td>
<td class="right mono" id="dbMarge_t">9,1%</td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Gesamtauftragswert -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-body" style="display: flex; align-items: center; justify-content: space-between;">
<span style="color: var(--color-text-secondary);">Gesamtauftragswert (netto):</span>
<strong style="font-size: 18px; font-family: var(--font-mono);" id="orderTotal">EUR 120,13</strong>
</div>
</div>
<!-- Hidden for backward compat -->
<input type="hidden" id="marginInput" value="10">

<!-- Kalkulationsgrundlage -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Kalkulationsverfahren</span></div>
<div class="card-body">
<div class="grid-2" style="font-size: 13px; margin-bottom: var(--space-4);">
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Kalkulationsart</div>
<div>Zuschlagskalkulation (differenzierend)</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Stundensätze</div>
<div>Aus Nachkalkulation, betriebsspezifisch anpassbar</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Zeitermittlung</div>
<div>Formelbasiert nach REFA / VDI 3321</div>
</div>
<div>
<div style="color: var(--color-text-muted); margin-bottom: 4px;">Materialkosten</div>
<div>Tagespreise Stahlhandel + Verschnitt + MGK</div>
</div>
</div>
 
<!-- Normen & Methodik -->
<div style="background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-md); border-left: 3px solid var(--color-primary);">
<div style="font-weight: 600; margin-bottom: var(--space-2);">Normengrundlage</div>
<div style="font-size: 13px; color: var(--color-text-secondary); line-height: 1.7;">
<strong>REFA — Zeitgliederung</strong><br>
 • Auftragszeit T = Rüstzeit t<sub>r</sub> + Ausführungszeit t<sub>a</sub><br>
 • Grundzeit t<sub>g</sub> = Hauptzeit t<sub>h</sub> + Nebenzeit t<sub>n</sub><br>
 • Stückzeit t<sub>e</sub> = Grundzeit + Verteilzeit (t<sub>v</sub>) + Erholzeit (t<sub>er</sub>)<br><br>
 
<strong>VDI 3321 — Schnittdaten</strong><br>
 • v<sub>c</sub> = π × d × n / 1000 [m/min]<br>
 • v<sub>f</sub> = f<sub>z</sub> × z × n [mm/min]<br>
 • t<sub>h</sub> = L / v<sub>f</sub> [min]<br><br>
 
<strong>DIN 8580 — Fertigungsverfahren</strong><br>
 Hauptgruppe 3: Trennen — Spanen mit geometrisch bestimmter Schneide<br><br>
 
<strong>DIN EN 10027 — Werkstoffbezeichnungen</strong><br>
 Kurzname, Werkstoffnummer, mechanische Kennwerte, Zerspanbarkeitsgruppe
</div>
</div>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: ANGEBOT
 ======================================== -->
<div class="section" id="section-quote">
    <div class="card">
        <div class="card-header">
            <span id="quoteHeaderTitle" contenteditable="true" style="outline: none; cursor: text; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'" title="Klicken zum Bearbeiten">MUSTER-ANGEBOT</span>
            <div style="display: flex; gap: var(--space-2);">
                <button class="btn btn-secondary btn-sm" onclick="copyQuote()">Kopieren</button>
                <button class="btn btn-primary btn-sm" onclick="window.print()">Drucken / PDF</button>
            </div>
        </div>
        <div class="card-body" style="max-width: 800px; margin: 0 auto;">
            
            <!-- Header mit Firmendaten -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-8); margin-bottom: var(--space-8); padding-bottom: var(--space-6); border-bottom: 1px solid var(--color-border-light);">
                
                <!-- Linke Spalte: Absender + Empfänger -->
                <div>
                    <div style="font-size: var(--text-xs); color: var(--color-text-hint); margin-bottom: var(--space-4);" id="quoteSenderLine" contenteditable="true" style="outline: none; cursor: text;" title="Klicken zum Bearbeiten">
                        CNC Planer Pro • Musterstraße 1 • 12345 Musterstadt
                    </div>
                    
                    <div style="font-size: var(--text-base); color: var(--color-text); line-height: var(--leading-relaxed); cursor: text;" title="Doppelklick zum Bearbeiten">
                        <strong id="quoteCustomerName" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">Müller Industrie GmbH</strong><br>
                        <span id="quoteCustomerStreet" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">Hauptstraße 26</span><br>
                        <span id="quoteCustomerCity" contenteditable="true" style="outline: none; border-bottom: 1px dashed transparent;" onfocus="this.style.borderBottomColor='var(--color-primary)'" onblur="this.style.borderBottomColor='transparent'">09619 Mulda</span>
                    </div>
                </div>
                
                <!-- Rechte Spalte: Angebotsdaten -->
                <div style="font-size: var(--text-sm);">
                    <table style="width: 100%;">
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Angebot</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteNumber">20260072</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Datum</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteDate">06.02.2026</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Kunden-Nr.</td>
                            <td style="text-align: right; padding: var(--space-1) 0;" id="quoteCustomerId">—</td>
                        </tr>
                        <tr>
                            <td style="color: var(--color-text-muted); padding: var(--space-1) 0; font-weight: var(--font-semibold);">Bearbeiter</td>
                            <td style="text-align: right; padding: var(--space-1) 0;">KI-Assistent</td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <!-- Betreff -->
            <p style="font-weight: 700; font-size: var(--text-lg); margin-bottom: var(--space-5);" id="quoteDesc">Angebot — CNC-Fertigung Verbindungsplatte</p>
            
            <!-- Anrede -->
            <div style="margin-bottom: var(--space-6); font-size: var(--text-base); line-height: var(--leading-relaxed);">
                <p style="margin-bottom: var(--space-4);"><strong>Sehr geehrte Damen und Herren,</strong></p>
                <p>wir bedanken uns für Ihre Anfrage und bieten Ihnen gerne, wie folgt an:</p>
            </div>
            
            <!-- Haupt-Tabelle (wie MBS) -->
            <table class="table" style="margin-bottom: var(--space-8);">
                <thead>
                    <tr>
                        <th style="width: 50px;">Pos</th>
                        <th style="width: 100px;">Artikelnr.</th>
                        <th>Bezeichnung</th>
                        <th class="right" style="width: 80px;">Menge</th>
                        <th class="right" style="width: 100px;">Einzelpreis</th>
                        <th class="right" style="width: 100px;">Gesamtpreis</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Position 1 (klassisch) -->
                    <tr>
                        <td class="position-nr">1</td>
                        <td class="mono">E-CNC-0001</td>
                        <td>
                            <div style="font-weight: var(--font-semibold);" id="quotePart1Name">Verbindungsplatte</div>
                            <div class="drawing-number" style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1); font-family: var(--font-mono);" id="quotePart1Drawing">2500473.01.11.02.00.001</div>
                            <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">Werkstoff S235JR</div>
                        </td>
                        <td class="right mono" id="quotePart1Qty">1 Stck.</td>
                        <td class="right mono" id="quotePart1EP">EUR 170,76</td>
                        <td class="right mono" id="quotePart1GP">EUR 170,76</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- Summen -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: var(--space-8);">
                <div style="width: 300px;">
                    <div style="display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-base);">
                        <span style="color: var(--color-text-secondary);">Zwischensumme</span>
                        <span class="mono" id="quoteSubtotal">EUR 170,76</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: var(--space-2) 0; font-size: var(--text-base); border-top: 1px solid var(--color-border-light);">
                        <span style="color: var(--color-text-secondary);">+ MwSt. 19%</span>
                        <span class="mono" id="quoteTax">EUR 32,44</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: var(--space-4) 0; font-size: var(--text-xl); font-weight: var(--font-bold); border-top: 2px solid var(--color-primary);">
                        <span>GESAMTBETRAG</span>
                        <span class="mono" id="quoteTotal">EUR 203,20</span>
                    </div>
                </div>
            </div>
            
            <!-- Gültigkeit prominent -->
            <div class="info-box" style="margin-bottom: var(--space-8);">
                <strong>Angebotsgültigkeit:</strong> Freibleibend mit einer Gültigkeit von 4 Wochen 
                (bis <strong id="quoteValidUntil">06.03.2026</strong>)
            </div>
            
            <!-- Bedingungen -->
            <div style="font-size: var(--text-sm); color: var(--color-text-secondary); line-height: var(--leading-relaxed); margin-bottom: var(--space-8); padding: var(--space-4); background: var(--color-bg-subtle); border-radius: var(--radius);">
                <p style="margin-bottom: var(--space-3);">
                    <strong>Preiskalkulation:</strong> 
                    Die Preiskalkulation basiert auf derzeit gültigen Materialaufschlagspreisen und Standard-Fertigungsparametern. 
                    Änderungen innerhalb der Angebotsgültigkeit behalten sich eventuelle Nachkalkulationen und Anpassungen vor 
                    bei stark schwankenden Marktpreisen.
                </p>
                
                <p style="margin-bottom: var(--space-3);">
                    <strong>Genauigkeit:</strong> 
                    Vorkalkulation auf Basis von REFA-Zeitermittlung und VDI 3321 Schnittdaten. Richtwerte — Abgleich mit betrieblicher Nachkalkulation empfohlen.
                    Für Präzisionsangebote bei Serienproduktion empfehlen wir eine manuelle Nachkalkulation.
                </p>
                
                <p style="margin-bottom: var(--space-3);">
                    <strong>Zahlungsbedingungen:</strong> 
                    <span id="quoteZahlungsziel">14</span> Tage netto nach Rechnungsdatum. 
                    Für Bestellungen unter EUR 100,00 Warenwert berechnen wir einen Mindermengenzuschlag von pauschal EUR 35,00.
                </p>
                
                <p>
                    <strong>Lieferzeit:</strong> 
                    Ca. <span id="quoteLieferzeit">3-4 Wochen</span> nach Auftragseingang (abhängig von Materialverfügbarkeit und aktueller Auslastung).
                </p>
            </div>
            
            <!-- Footer mit Kontaktdaten -->
            <div class="contact-footer" style="padding-top: var(--space-6); border-top: 1px solid var(--color-border-light);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4); font-size: var(--text-xs); color: var(--color-text-hint); line-height: var(--leading-relaxed);">
                    <div id="quoteFooterContact">
                        <strong style="color: var(--color-text-muted);">CNC Planer Pro</strong><br>
                        Musterstraße 1<br>
                        12345 Musterstadt<br>
                        <br>
                        Telefon: +49 123 456789<br>
                        E-Mail: info@cnc-planer-pro.de
                    </div>
                    <div>
                        <strong style="color: var(--color-text-muted);">Rechtliches</strong><br>
                        Geschäftsführer: [Name]<br>
                        Handelsregister: [Nummer]<br>
                        Registergericht: [Ort]<br>
                        USt-ID: [Nummer]<br>
                        <br>
                        IBAN: [IBAN] | BIC: [BIC]
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>
<div class="section" id="section-instructions">
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Vorschlag — keine verbindliche Fertigungsplanung.</strong> Der Operationsplan zeigt mögliche Arbeitsgänge für dieses Bauteilprofil. Nicht alle OPs sind für jedes Bauteil erforderlich. Die Kalkulation rechnet mit einer bauteilproportionalen Gesamtzeit — nicht mit der Summe aller hier gelisteten OPs.<br><br>
<strong>Bitte prüfen und anpassen:</strong> OPs per Checkbox abwählen, die für Ihr konkretes Bauteil nicht zutreffen. Über „+ Arbeitsgang" können fehlende Arbeitsgänge ergänzt werden.
</div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3); flex-wrap: wrap; gap: var(--space-3);">
<div>
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-primary btn-sm" onclick="printFertigungsanweisung()">Fertigungsanweisung drucken</button>
</div>
<div style="font-size:11px; color:var(--color-text-muted); margin-top:4px;">
Enthält: Arbeitsgänge, Werkzeuge, Schnittdaten, Aufspannplan
</div>
</div>
</div>

<!-- Änderungsprotokoll (wie Prüfprotokoll — dokumentiert manuelle Anpassungen) -->
<div id="faChangeLog" style="margin-bottom: var(--space-4);">
<details>
<summary style="cursor:pointer; font-size:12px; color:var(--color-text-muted); font-weight:600;">Änderungsprotokoll (<span id="faChangeCount">0</span> Änderungen)</summary>
<div id="faChangeLogContent" style="margin-top: var(--space-2); font-size:12px;"></div>
</details>
</div>

<!-- Document Header -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-body">
<div style="display: flex; justify-content: space-between; margin-bottom: var(--space-5); padding-bottom: var(--space-4); border-bottom: 3px solid var(--color-primary);">
<div>
<h3 style="color: var(--color-primary); font-size: 18px; font-weight: 700;">FERTIGUNGSANWEISUNG</h3>
<p id="faPartName" style="color: var(--color-text-muted); font-size: 13px;">Verbindungsplatte — 2500473.01.11.02.00.001</p>
</div>
<div style="text-align: right; font-size: 13px; color: var(--color-text-muted);">
<div>Freigabe: 05.02.2026</div>
<div>Version: 1.0</div>
</div>
</div>
 
<div class="grid-3" style="margin-bottom: var(--space-4);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Werkstück</div>
<table style="font-size: 13px; width: 100%;">
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Werkstoff:</td><td id="faMaterial" style="padding: 2px 0;"><strong>S235JR</strong></td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Rohteil:</td><td id="faRawDims" style="padding: 2px 0;">440 × 50 × 20 mm</td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Gewicht:</td><td id="faWeight" style="padding: 2px 0;">2,2 kg</td></tr>
</table>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2);">Maschine</div>
<table style="font-size: 13px; width: 100%;">
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Maschine:</td><td style="padding: 2px 0;"><strong>Hermle C 400</strong></td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Steuerung:</td><td style="padding: 2px 0;">Heidenhain TNC 640</td></tr>
<tr><td style="color: var(--color-text-muted); padding: 2px 0;">Zeit:</td><td id="faMachiningTime" style="padding: 2px 0;"><strong>—</strong></td></tr>
</table>
</div>
<!-- Zeichnung Upload entfernt -->
</div>
 
<div class="info-box">
<strong>Toleranzen:</strong> Allgemein DIN ISO 2768-mK • Oberfläche Rz 25
</div>
</div>
</div>

<!-- Zeichnungs-Vorschau -->
<div class="card" style="margin-bottom: var(--space-5);" id="drawingCard">
<div class="card-header" style="cursor: pointer;" onclick="toggleDrawing()">
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span id="drawingChevron" style="transition: transform 0.2s;">▶</span>
<span>Zeichnung anzeigen</span>
<span id="drawingPartNumber" style="font-size: 12px; color: var(--color-text-muted); font-family: var(--font-mono);">2500473.01.11.02.00.001</span>
</div>
<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openDrawingFullscreen()">Vollbild</button>
</div>
<div class="card-body" id="drawingContent" style="display: none; text-align: center; background: var(--color-bg);">
<img id="drawingImage" src="demo-parts/2500473.01.11.02.00.001.pdf.png" alt="Zeichnung" 
 style="max-width: 100%; max-height: 400px; object-fit: contain; border: 1px solid var(--color-border); border-radius: var(--radius-md); background: white;"
 onerror="this.parentElement.innerHTML='<div style=\'padding:40px;color:var(--color-text-muted);\'>Keine Zeichnung verfügbar</div>'">
</div>
</div>
 
<!-- Operationen-Tabelle mit Berechnungsdetails -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header">
<span>Operationen und Bearbeitungszeiten</span>
<div style="display:flex;align-items:center;gap:var(--space-2);">
<span style="font-size: 11px; font-weight: 400; color: var(--color-text-muted);">n [U/min] · vf [mm/min] · ap [mm]</span>
<button class="btn btn-secondary btn-sm" onclick="exportFertigungsCSV()" style="margin-left:var(--space-3);">CSV</button>
</div>
</div>
<div class="card-body" style="padding: 0;">
 
<!-- OP10 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op10')">
<span class="op-badge" style="margin-right: var(--space-3);">10</span>
<span style="flex: 1;"><strong>Planfräsen Oberseite</strong>
<div class="op-params"><span>n 800</span><span>vf 300</span><span>ap 2,0</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T1 Ø63</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>2,7 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op10-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkstück -->
<rect x="20" y="40" width="120" height="60" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Fräser -->
<circle cx="50" cy="30" r="20" fill="#1E3A5F" opacity="0.8"/>
<line x1="50" y1="30" x2="50" y2="45" stroke="#1E3A5F" stroke-width="3"/>
<!-- Bahnen -->
<line x1="30" y1="55" x2="130" y2="55" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<line x1="130" y1="70" x2="30" y2="70" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<line x1="30" y1="85" x2="130" y2="85" stroke="#059669" stroke-width="2" stroke-dasharray="4"/>
<!-- Pfeil -->
<polygon points="130,55 125,52 125,58" fill="#059669"/>
<!-- Maße -->
<text x="75" y="115" font-size="10" fill="#64748B" text-anchor="middle">130 mm</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Bahnstrategie: Zeilenweise</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 1,9 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Fläche: 130 × 130 mm = 16.900 mm²<br>
 Bahnabstand: a<sub>e</sub>= 45 mm (70% von Ø63)<br>
 Anzahl Bahnen: 130 / 45 = 3 Bahnen<br>
 Verfahrweg: L = 3 × 130 = 390 mm<br>
 Vorschub: v<sub>f</sub>= 485 mm/min<br>
 Zustellungen: 2 (bei a<sub>p</sub>= 2 mm)<br>
<strong>t<sub>h</sub>= (390 × 2) / 485 = 1,61 min</strong><br>
 + Sicherheit 20% =<strong>1,9 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel: 0,3 min<br>
 Anfahren Z+100 → Z+2: 0,2 min<br>
 Positionieren X/Y: 0,2 min<br>
 Spindel Start/Stop: 0,1 min<br>
<strong>t<sub>n</sub>= 0,8 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP20 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op20')">
<span class="op-badge" style="margin-right: var(--space-3);">20</span>
<span style="flex: 1;"><strong>Schruppen Außenkontur Ø120</strong>
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 Ø20</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>8,0 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op20-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkstück (Querschnitt) -->
<rect x="30" y="20" width="100" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Kontur (Kreis) -->
<circle cx="80" cy="60" r="40" fill="none" stroke="#DC2626" stroke-width="2" stroke-dasharray="4"/>
<!-- Fräser -->
<circle cx="120" cy="60" r="10" fill="#1E3A5F" opacity="0.8"/>
<!-- Pfeil Bewegung -->
<path d="M 120 50 A 40 40 0 0 0 80 20" fill="none" stroke="#059669" stroke-width="2"/>
<polygon points="82,22 78,18 84,18" fill="#059669"/>
<!-- Maße -->
<text x="80" y="65" font-size="10" fill="#64748B" text-anchor="middle">Ø120</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Konturparallel, 6 Ebenen</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 6,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Konturlänge: U = π × 120 = 377 mm<br>
 Tiefe: 42 mm, a<sub>p</sub>= 8 mm<br>
 Zustellungen: 42 / 8 = 6 Ebenen<br>
 Aufmaß abtragen: 5 mm radial<br>
 Bahnen pro Ebene: 5 / 10 = 1<br>
 Verfahrweg: L = 377 × 6 = 2.262 mm<br>
 Vorschub: v<sub>f</sub>= 960 mm/min<br>
<strong>t<sub>h</sub>= 2.262 / 960 = 2,4 min</strong><br>
 × 1,5 (Komplexität + Positionierung) =<strong>6,2 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 1,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel: 0,3 min<br>
 6× Zustellung Z: 6 × 0,15 = 0,9 min<br>
 Positionieren: 0,4 min<br>
 Späne blasen: 0,2 min<br>
<strong>t<sub>n</sub>= 1,8 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP30 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op30')">
<span class="op-badge" style="margin-right: var(--space-3);">30</span>
<span style="flex: 1;"><strong>Taschenfräsen</strong>
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 Ø20</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>5,7 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op30-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkstück -->
<rect x="20" y="20" width="120" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Tasche -->
<rect x="50" y="40" width="60" height="40" fill="#94A3B8" stroke="#475569" stroke-width="1"/>
<!-- Fräsbahnen -->
<line x1="55" y1="50" x2="105" y2="50" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="105" y1="55" x2="55" y2="55" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="55" y1="60" x2="105" y2="60" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="105" y1="65" x2="55" y2="65" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<line x1="55" y1="70" x2="105" y2="70" stroke="#059669" stroke-width="1.5" stroke-dasharray="3"/>
<!-- Fräser -->
<circle cx="75" cy="55" r="8" fill="#1E3A5F" opacity="0.8"/>
<!-- Maße -->
<text x="80" y="95" font-size="9" fill="#64748B" text-anchor="middle">60×40 mm</text>
</svg>
<div style="font-size: 10px; color: var(--color-text-muted); margin-top: 4px;">Tasche: Zeilenräumen</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-primary);">Hauptzeit t<sub>h</sub>= 4,5 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Taschengröße: 60 × 40 mm<br>
 Tiefe: 15 mm, a<sub>p</sub>= 8 mm<br>
 Zustellungen: 2 Ebenen<br>
 Zeilenabstand: a<sub>e</sub>= 10 mm<br>
 Bahnen: 60 / 10 = 6 pro Ebene<br>
 Verfahrweg: L = 6 × 40 × 2 = 480 mm<br>
 + Räumen Mitte: 200 mm<br>
 Vorschub: v<sub>f</sub>= 960 mm/min<br>
<strong>t<sub>h</sub>= 680 / 960 = 0,7 min × 4 Passes = 2,8 min (+Sicherheit = 4,5 min)</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 1,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Kein WZ-Wechsel (T2 bereits)<br>
 Positionieren zur Tasche: 0,3 min<br>
 2× Zustellung Z: 0,3 min<br>
 Rückzug + Späne: 0,6 min<br>
<strong>t<sub>n</sub>= 1,2 min</strong>
</div>
</div>
</div>
</div>
</div>
 
<!-- OP40 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op40')">
<span class="op-badge" style="margin-right: var(--space-3);">40</span>
<span style="flex: 1;">Konturfräsen
<div class="op-params"><span>n 2400</span><span>vf 960</span><span>ap 1,5</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T2 Ø20</span>
<span class="mono" style="width: 80px; text-align: right;">4,4 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op40-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 3,5 min</strong><br><br>
Konturlänge: ca. 520 mm<br>
Zustelltiefe: a<sub>p</sub>= 1,5 mm (2 Zustellungen)<br>
Verfahrweg: L = 520 × 2 = 1040 mm<br>
v<sub>f</sub>= 480 mm/min<br>
t<sub>h</sub>= 1040 / 480 = 2,17<br>
+ Sicherheit 20% × 1,6 Passes ≈3,5 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,9 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
Positionieren: 0,3 min<br>
Zustellung + Anfahren: 0,3 min
</div>
</div>
</div>
</div>

<!-- OP50 KRITISCH -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op50')">
<span class="op-badge critical" style="margin-right: var(--space-3);">50</span>
<span style="flex: 1;"><strong>Schlichten Ø120 h5</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 2400</span><span>vf 768</span><span>ap 0,3</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T3 Ø16</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>5,1 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op50-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 2px solid var(--color-error); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkstück -->
<circle cx="80" cy="60" r="50" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Fertigmaß -->
<circle cx="80" cy="60" r="40" fill="none" stroke="#DC2626" stroke-width="2"/>
<!-- Aufmaß (Spirale angedeutet) -->
<path d="M 120 60 A 40 40 0 1 1 80 20" fill="none" stroke="#059669" stroke-width="1.5"/>
<path d="M 118 60 A 38 38 0 1 1 80 22" fill="none" stroke="#059669" stroke-width="1" opacity="0.6"/>
<!-- Fräser -->
<circle cx="120" cy="60" r="8" fill="#1E3A5F" opacity="0.8"/>
<!-- Toleranz-Box -->
<rect x="55" y="85" width="50" height="18" fill="#FEE2E2" stroke="#DC2626" stroke-width="1" rx="2"/>
<text x="80" y="97" font-size="9" fill="#DC2626" text-anchor="middle" font-weight="bold">h5: ±0,018</text>
<!-- Maß -->
<text x="80" y="65" font-size="11" fill="#DC2626" text-anchor="middle" font-weight="bold">Ø120</text>
</svg>
<div style="font-size: 10px; color: var(--color-error); margin-top: 4px; font-weight: 600;">KRITISCH: Spiralbahn</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-error);">Hauptzeit t<sub>h</sub>= 4,2 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Kontur: U = π × 120 = 377 mm<br>
 Schlichttiefe: 42 mm<br>
 Zustellung: a<sub>p</sub>= 0,3 mm<br>
 Durchgänge: 42 / 0,3 = 140<br>
 → Spiralbahn: 1 Durchgang<br>
 Verfahrweg: L = 377 + (42 × π) = 509 mm<br>
<span style="color: var(--color-error);">Reduzierter Vorschub wg. h5!</span><br>
 v<sub>f</sub>= 280 mm/min (statt 557)<br>
<strong>t<sub>h</sub>= 509 / 280 × 2 = 3,6 min</strong><br>
 + Mess-Stopp 20% =<strong>4,2 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,9 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel T3: 0,3 min<br>
 Anfahren vorsichtig: 0,3 min<br>
 Zwischenmessung: 0,2 min<br>
 Positionieren: 0,1 min<br>
<strong>t<sub>n</sub>= 0,9 min</strong>
</div>
<div style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-error-light); border-radius: var(--radius-sm); color: var(--color-error); font-size: 11px;">
 Toleranz h5 = 0/-0,018 mm<br>
 Nur 18 µm Spielraum!
</div>
</div>
</div>
</div>
</div>
 
<!-- OP60 KRITISCH -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op60')">
<span class="op-badge critical" style="margin-right: var(--space-3);">60</span>
<span style="flex: 1;"><strong>Feinbohren Ø26 H7</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 1100</span><span>vf 98</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T11</span>
<span class="mono" style="width: 80px; text-align: right;"><strong>4,1 min</strong></span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op60-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 200px 1fr 1fr; gap: var(--space-4);">
<!-- Bild/Skizze -->
<div style="background: white; border: 2px solid var(--color-error); border-radius: var(--radius-md); padding: var(--space-3); text-align: center;">
<svg width="160" height="120" viewBox="0 0 160 120">
<!-- Werkstück Schnitt -->
<rect x="30" y="20" width="100" height="80" fill="#E2E8F0" stroke="#64748B" stroke-width="1"/>
<!-- Bohrung -->
<rect x="70" y="20" width="20" height="60" fill="#94A3B8" stroke="#475569" stroke-width="1"/>
<!-- Feinbohrkopf -->
<rect x="72" y="5" width="16" height="25" fill="#1E3A5F" rx="2"/>
<circle cx="80" cy="35" r="10" fill="none" stroke="#DC2626" stroke-width="2"/>
<!-- Pfeil runter -->
<line x1="80" y1="40" x2="80" y2="70" stroke="#059669" stroke-width="2"/>
<polygon points="80,70 76,62 84,62" fill="#059669"/>
<!-- Maße -->
<text x="80" y="95" font-size="9" fill="#DC2626" text-anchor="middle" font-weight="bold">Ø26 H7</text>
<text x="130" y="55" font-size="8" fill="#64748B">35mm</text>
<!-- Toleranz -->
<rect x="100" y="70" width="45" height="16" fill="#FEE2E2" stroke="#DC2626" stroke-width="1" rx="2"/>
<text x="122" y="81" font-size="8" fill="#DC2626" text-anchor="middle">+0,021/0</text>
</svg>
<div style="font-size: 10px; color: var(--color-error); margin-top: 4px; font-weight: 600;">Feinbohrkopf 3×</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-error);">Hauptzeit t<sub>h</sub>= 3,3 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Bohrtiefe: 35 mm<br>
 Vorschub: v<sub>f</sub>= 98 mm/min<br>
 Einfahren: L = 35 mm<br>
 Ausfahren: L = 35 mm (langsam)<br>
 Ausfahren v<sub>f</sub>= 50 mm/min<br>
 t<sub>ein</sub>= 35 / 98 = 0,36 min<br>
 t<sub>aus</sub>= 35 / 50 = 0,70 min<br>
 × 3 Bohrungen = 3,18 min<br>
<strong>t<sub>h</sub>= 3,3 min</strong>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-2); color: var(--color-text-muted);">Nebenzeit t<sub>n</sub>= 0,8 min</div>
<div style="font-family: var(--font-mono); font-size: 12px; color: var(--color-text-secondary); line-height: 1.8;">
 Werkzeugwechsel T11: 0,3 min<br>
 3× Positionieren: 0,3 min<br>
 Feinbohrkopf einstellen: 0,2 min<br>
<strong>t<sub>n</sub>= 0,8 min</strong>
</div>
<div style="margin-top: var(--space-3); padding: var(--space-2); background: var(--color-error-light); border-radius: var(--radius-sm); color: var(--color-error); font-size: 11px;">
 Toleranz H7 = +0,021/0 mm<br>
 Feinbohrkopf-Einstellung dokumentieren!
</div>
</div>
</div>
</div>
</div>
 
<!-- OP70 -->
<div style="border-bottom: 1px solid var(--color-border); background: var(--color-error-light);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op70')">
<span class="op-badge critical" style="margin-right: var(--space-3);">70</span>
<span style="flex: 1;"><strong>Feinbohren Ø44 H7</strong><span class="badge badge-error">KRITISCH</span>
<div class="op-params"><span>n 900</span><span>vf 75</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T12</span>
<span class="mono" style="width: 80px; text-align: right;">4,7 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op70-detail" style="display: none; padding: var(--space-4); background: rgba(254,226,226,0.5); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 3,8 min</strong><br><br>
Bohrtiefe: 50 mm<br>
Bearbeitungszugabe: 0,15 mm auf Radius<br>
v<sub>f</sub>= 75 mm/min (langsam für IT7)<br>
Vorbohren: Ø43,7 → Feinbohren: Ø44 H7<br>
3 Durchgänge à 0,05 mm = 3 × 50/75<br>
+ Messunterbrechung: 1,8 min<br>
t<sub>h</sub>≈ 3,8 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,9 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
Innenmessschraube einsetzen: 0,3 min<br>
Positionieren + Spanblasluft: 0,3 min<br><br>
<strong style="color: var(--color-error);">Toleranz H7: +0,000 / +0,025 mm</strong><br>
Nachmessen nach jedem Durchgang!
</div>
</div>
</div>
</div>

<!-- OP80 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op80')">
<span class="op-badge" style="margin-right: var(--space-3);">80</span>
<span style="flex: 1;">Bohren M8 Gewinde (4×)
<div class="op-params"><span>n 1800</span><span>vf 320</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T5 Ø6,8</span>
<span class="mono" style="width: 80px; text-align: right;">1,9 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op80-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 1,2 min</strong><br><br>
4× Kernlochbohrung Ø6,8 mm<br>
Bohrtiefe: 20 mm (durchgehend)<br>
v<sub>f</sub>= 320 mm/min<br>
t<sub>h</sub>= 4 × 20 / 320 = 0,25 min<br>
+ Anbohrzyklen + Spänebrechen<br>
≈ 1,2 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,7 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
4× Positionieren: 0,2 min<br>
Späne ausblasen: 0,2 min
</div>
</div>
</div>
</div>

<!-- OP90 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op90')">
<span class="op-badge" style="margin-right: var(--space-3);">90</span>
<span style="flex: 1;">Gewindefräsen M8 (4×)
<div class="op-params"><span>n 1500</span><span>vf 250</span></div></span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">T13</span>
<span class="mono" style="width: 80px; text-align: right;">2,6 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op90-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Hauptzeit t<sub>h</sub>= 2,0 min</strong><br><br>
4× M8 Gewinde, Steigung 1,25 mm<br>
Gewindetiefe: 15 mm<br>
Helixinterpolation: 12 Umdrehungen/Gewinde<br>
v<sub>f</sub>= 250 mm/min<br>
t<sub>h</sub>= 4 × (12 × π × 4) / 250 ≈ 2,0 min
</div>
<div>
<strong>Nebenzeit t<sub>n</sub>= 0,6 min</strong><br><br>
Werkzeugwechsel: 0,3 min<br>
4× Positionieren: 0,2 min<br>
Gewindelehre prüfen: 0,1 min
</div>
</div>
</div>
</div>

<!-- OP100 -->
<div style="border-bottom: 1px solid var(--color-border);">
<div style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); cursor: pointer;" onclick="toggleOpDetail('op100')">
<span class="op-badge" style="margin-right: var(--space-3);">100</span>
<span style="flex: 1;">Entgraten, Prüfen</span>
<span class="mono" style="color: var(--color-text-muted); margin-right: var(--space-4);">—</span>
<span class="mono" style="width: 80px; text-align: right;">5,0 min</span>
<span style="margin-left: var(--space-2); color: var(--color-text-muted);">▼</span>
</div>
<div id="op100-detail" style="display: none; padding: var(--space-4); background: var(--color-bg); border-top: 1px solid var(--color-border-light); font-size: 13px;">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
<div>
<strong>Entgraten: 3,0 min</strong><br><br>
Alle Kanten entgraten (manuell)<br>
Gratfreiheit prüfen (Fingerprobe)<br>
Bohrungseingänge senken
</div>
<div>
<strong>Prüfen: 2,0 min</strong><br><br>
Sichtkontrolle Oberfläche<br>
Maßkontrolle Hauptmaße (Messschieber)<br>
Gewindepaarung M8 prüfen (Lehre)<br>
Freigabe / Dokumentation
</div>
</div>
</div>
</div>
 
<!-- SUMME -->
<div id="opSumRow" style="display: flex; align-items: center; padding: var(--space-3) var(--space-4); background: var(--color-primary); color: white; font-weight: 600;">
<span style="flex: 1;">SUMME</span>
<span class="mono" id="opSumDetail" style="margin-right: var(--space-4);">10 Arbeitsgänge</span>
<span class="mono" id="opSumTotal" style="width: 80px; text-align: right;">44,2 min</span>
</div>
</div>

<!-- Arbeitsgang hinzufügen -->
<div style="display:flex;gap:var(--space-3);margin-bottom:var(--space-3);">
<button class="btn btn-secondary btn-sm" onclick="addCustomOP()">+ Arbeitsgang hinzufügen</button>
</div>

<!-- Container für manuell hinzugefügte OPs -->
<div id="customOpsContainer"></div>

<!-- Bestätigung und Neuberechnung -->
<div style="display:flex;gap:var(--space-3);margin-top:var(--space-3);margin-bottom:var(--space-5);padding-top:var(--space-3);border-top:1px solid var(--color-border-light);">
<button class="btn btn-primary btn-sm" onclick="syncCustomOpsToProject(); runCalculation();" style="display:flex;align-items:center;gap:6px;">
<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
Änderungen übernehmen und neu berechnen
</button>
</div>

<!-- Qualitätsprüfung -->
<div class="instruction-section">
<div class="instruction-header">
<h4>Qualitätsprüfung</h4>
<div style="display:flex;align-items:center;gap:var(--space-2);">
<span class="badge badge-info">QS</span>
<button class="btn btn-secondary btn-sm" onclick="exportPruefCSV()">CSV</button>
</div>
</div>
<div class="instruction-content">
<table class="table" id="pruefTable">
<thead>
<tr>
<th style="width:30px;"></th>
<th>Prüfmerkmal</th>
<th>Soll</th>
<th>Prüfmittel</th>
<th class="right">Zeit</th>
<th style="width:30px;"></th>
</tr>
</thead>
<tbody id="pruefBody">
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>Ø26 H7</td>
<td class="mono">26,000 / 26,021</td>
<td>Innenmessschraube</td>
<td class="right mono">0,8 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">×</button></td>
</tr>
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>Höhe</td>
<td class="mono">20,0 ±0,1</td>
<td>Messschieber</td>
<td class="right mono">0,3 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">×</button></td>
</tr>
<tr>
<td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
<td>Oberfläche</td>
<td class="mono">Rz ≤ 25</td>
<td>Vergleichsmuster</td>
<td class="right mono">0,5 min</td>
<td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">×</button></td>
</tr>
</tbody>
</table>
<button class="btn btn-secondary btn-sm" onclick="addPruefRow()" style="margin-top:var(--space-3);">+ Prüfmerkmal hinzufügen</button>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: KALKULATION (Detailliert)
 ======================================== -->
<div class="section" id="section-calculation">
 
<!-- Legende -->
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Berechnungsformel:</strong>t<sub>h</sub>= Verfahrweg L [mm] ÷ Vorschub v<sub>f</sub>[mm/min] &nbsp;|&nbsp; 
<strong>Nebenzeit:</strong> Werkzeugwechsel + Positionieren + Zustellung + Späne entfernen
</div>
 
<!-- 2-Spalten Layout: Maschine + Material -->
<div class="grid-2" style="margin-bottom: var(--space-5);">
<!-- Maschinenzeitkalkulation -->
<div class="card">
<div class="card-header"><span>Maschinenzeitkalkulation</span></div>
<div class="card-body">
<table class="table">
<tbody>
<tr>
<td>Hauptzeit (th)</td>
<td class="right mono" id="calcTh">31,2 min</td>
</tr>
<tr>
<td>Nebenzeit (tn)</td>
<td class="right mono" id="calcTn">8,0 min</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gesamtzeit</td>
<td class="right mono" id="calcTimeTotal">39,2 min</td>
</tr>
<tr>
<td>× Stundensatz</td>
<td class="right mono">EUR 91/h</td>
</tr>
<tr style="background: var(--color-info-light); font-weight: 600;">
<td>= Maschinenkosten</td>
<td class="right mono" id="calcMachCost">EUR 59,47</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<!-- Materialkalkulation -->
<div class="card">
<div class="card-header"><span>Materialkalkulation</span></div>
<div class="card-body">
<table class="table">
<tbody>
<tr>
<td>Rohmaße</td>
<td class="right mono" id="calcRawDims">130 × 130 × 47 mm</td>
</tr>
<tr>
<td>Volumen</td>
<td class="right mono" id="calcVolume">794.170 mm³</td>
</tr>
<tr>
<td>Werkstoff / Dichte</td>
<td class="right mono" id="calcDensity">S235JR / 7,85 g/cm³</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gewicht</td>
<td class="right mono" id="calcWeight">6,23 kg</td>
</tr>
<tr>
<td>× Preis + 10% Verschnitt</td>
<td class="right mono" id="calcMatFormula">EUR 6,79/kg × 1,1</td>
</tr>
<tr style="background: var(--color-success-light); font-weight: 600;">
<td>= Materialkosten</td>
<td class="right mono" id="calcMatCost">EUR 46,57</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
 
<!-- Einrichtkosten -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Einrichtkosten (Rüstzeit)</span></div>
<div class="card-body">
<div class="grid-2">
<table class="table">
<tbody>
<tr>
<td>Spannmethode</td>
<td class="right" id="calcClamping">Schraubstock</td>
</tr>
<tr>
<td>Basis-Einrichtzeit</td>
<td class="right mono">15 min</td>
</tr>
<tr>
<td>Aufspannungen</td>
<td class="right mono" id="calcSetups">2×</td>
</tr>
<tr style="background: var(--color-bg); font-weight: 600;">
<td>Gesamt-Einrichtzeit</td>
<td class="right mono" id="calcSetupTime">24 min</td>
</tr>
</tbody>
</table>
<table class="table">
<tbody>
<tr>
<td>× Stundensatz</td>
<td class="right mono">EUR 91/h</td>
</tr>
<tr style="background: var(--color-warning-light); font-weight: 600;">
<td>= Einrichtkosten</td>
<td class="right mono" id="calcSetupCostDetail">EUR 36,40</td>
</tr>
<tr>
<td>÷ Stückzahl</td>
<td class="right mono" id="calcQtyDetail">1</td>
</tr>
<tr style="font-weight: 600;">
<td>= Pro Stück</td>
<td class="right mono" id="calcSetupPerPiece">EUR 36,40</td>
</tr>
</tbody>
</table>
</div>
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Tipp:</strong> Bei Serienproduktion werden Einrichtkosten auf alle Teile verteilt — der Stückpreis sinkt erheblich.
</div>
</div>
</div>
 
<!-- Berechnungsmethodik -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Normengrundlage</span></div>
<div class="card-body" style="font-size: 13px; line-height: 1.7;">
<div class="grid-2">
<div>
<strong style="color: var(--color-primary);">REFA</strong><br>
<span style="color: var(--color-text-secondary);">
 T = t<sub>r</sub> + t<sub>a</sub><br>
 t<sub>g</sub> = t<sub>h</sub> + t<sub>n</sub>
</span>
</div>
<div>
<strong style="color: var(--color-primary);">VDI 3321</strong><br>
<span style="color: var(--color-text-secondary);">
 v<sub>c</sub> = π×d×n / 1000<br>
 t<sub>h</sub> = L / v<sub>f</sub>
</span>
</div>
<div>
<strong style="color: var(--color-primary);">DIN 8580</strong><br>
<span style="color: var(--color-text-secondary);">Hauptgruppe 3 — Spanen</span>
</div>
<div>
<strong style="color: var(--color-primary);">DIN EN 10027</strong><br>
<span style="color: var(--color-text-secondary);">Werkstoffbezeichnungen und Kennwerte</span>
</div>
</div>
</div>
</div>
 
<!-- Gesamtkalkulation -->
<div class="card">
<div class="card-header card-header-primary"><span>Gesamtkalkulation</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Kostenart</th>
<th class="right">Berechnung</th>
<th class="right">Pro Stück</th>
<th class="right">Gesamt</th>
</tr>
</thead>
<tbody id="calcSummaryBody">
<tr><td colspan="4" style="text-align:center; color: var(--color-text-muted);">Bitte zuerst Berechnung durchführen</td></tr>
</tbody>
</table>
</div>
</div>
</div>
 
<!-- ========================================
 SECTION: WERKZEUGE
 ======================================== -->
</div>
<div class="section" id="section-tools">
<div class="info-box" style="margin-bottom: var(--space-5);">
<strong>Automatisch generiert</strong> auf Grundlage des Operationsplans und der VDI 3321 Schnittdatenrichtwerte. Werkzeugkosten sind im Maschinenstundensatz enthalten und werden nicht separat kalkuliert. Standzeiten dienen der Werkzeugplanung.
</div>
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Schnittparameter</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table" id="cuttingParamsTable">
<thead>
<tr>
<th>Werkzeug</th>
<th>Operation</th>
<th class="right">Parameter</th>
<th class="right">Zeit [min]</th>
</tr>
</thead>
<tbody id="cuttingParamsBody">
<!-- Dynamically filled by renderToolsFromProject() -->
</tbody>
</table>
</div>
</div>
 
<div class="card">
<div class="card-header"><span>Werkzeugeinsatz & Kosten</span></div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Werkzeug</th>
<th class="right">Preis [EUR]</th>
<th class="right">Standzeit [min]</th>
<th class="right">Einsatzzeit [min]</th>
<th class="right">Verschleiß [EUR]</th>
</tr>
</thead>
<tbody id="toolUsageBody">
<!-- Dynamically filled by renderToolsFromProject() -->
</tbody>
</table>
</div>
</div>
 
<div class="warning-box" style="margin-top: var(--space-5);">
<strong>Hinweis:</strong> Werkzeugkosten sind im Maschinenstundensatz enthalten. Die Übersicht dient der Werkzeugplanung und Standzeit-Dokumentation. Standzeiten sind werkstoffabhängig und können bei schwerzerspanbaren Materialien um 30-50 % reduziert sein.
</div>
 
</div>
 
<!-- ========================================
 SECTION: NC-CODE
 ======================================== -->
<div class="section" id="section-code">
<div style="background:repeating-linear-gradient(45deg,#fff8e1,#fff8e1 10px,#fff3cd 10px,#fff3cd 20px);border:2px solid #c8aa50;border-radius:var(--radius-lg);padding:var(--space-5);margin-bottom:var(--space-5);text-align:center;">
<!-- MOCK-UP label removed -->
<div style="font-size:13px;color:var(--color-text-secondary);max-width:500px;margin:0 auto;">
NC-Code-Generierung ist in Entwicklung. Diese Ansicht zeigt eine <strong>Vorschau des geplanten Funktionsumfangs</strong> — keine produktionsfähige Ausgabe. Feedback willkommen!
</div>
</div>
<!-- Entwurf-Hinweis entfernt (redundant mit Banner oben + Disclaimer unten) -->

<div>
<!-- NC Code (volle Breite) -->
<div>
<div class="card">
<div class="card-header">
<span>NC-Code Generator <span style="font-size:10px; font-weight:400; background:var(--color-warning); color:#333; padding:1px 6px; border-radius:4px; margin-left:6px;">Nur Simulation</span></span>
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-primary btn-sm" id="btnHeidenhain" onclick="setCodeFormat('heidenhain')">Heidenhain</button>
<button class="btn btn-secondary btn-sm" id="btnSiemens" onclick="setCodeFormat('siemens')">Siemens</button>
<button class="btn btn-secondary btn-sm" id="btnFanuc" onclick="setCodeFormat('fanuc')">Fanuc</button>
</div>
<div style="display: flex; gap: var(--space-2);">
<button class="btn btn-secondary btn-sm" onclick="copyCode()">Kopieren</button>
<button class="btn btn-primary btn-sm" onclick="downloadCode()">Download</button>
</div>
</div>
<div class="card-body" style="padding: 0;">
<div class="code-block" id="codeBlock" style="max-height: 600px; overflow-y: auto;">
<pre id="codeContent"><span class="code-comment">; ========================================</span>
<span class="code-comment">; CNC PLANNER PRO — Automatisch generiert</span>
<span class="code-comment">; ========================================</span>
<span class="code-comment">; Werkstück: Verbindungsplatte</span>
<span class="code-comment">; Werkstoff: S235JR</span>
<span class="code-comment">; Maschine: Hermle C 400</span>
<span class="code-comment">; Steuerung: Heidenhain TNC 640</span>
<span class="code-comment">; ========================================</span>

<span class="code-keyword">BEGIN PGM</span>VERBINDUNGSPLATTE<span class="code-keyword">MM</span>

<span class="code-comment">; --- WERKZEUGLISTE ---</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">1</span>L+<span class="code-number">0</span>R+<span class="code-number">31.5</span><span class="code-comment">; Planfräser Ø63</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">2</span>L+<span class="code-number">0</span>R+<span class="code-number">10</span><span class="code-comment">; VHM-Fräser Ø20</span>
<span class="code-keyword">TOOL DEF</span><span class="code-number">11</span>L+<span class="code-number">0</span>R+<span class="code-number">13</span><span class="code-comment">; Feinbohrkopf Ø26</span>

<span class="code-comment">; OP10: PLANFRÄSEN</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">1</span>Z S<span class="code-number">800</span>
L Z+<span class="code-number">100</span>R0 FMAX M3
L X+<span class="code-number">0</span>Y+<span class="code-number">0</span>FMAX

<span class="code-keyword">CYCL DEF</span><span class="code-number">230</span><span class="code-keyword">FACE MILLING</span>
 Q<span class="code-number">225</span>=+<span class="code-number">0</span>
 Q<span class="code-number">218</span>=<span class="code-number">450</span>
 Q<span class="code-number">219</span>=<span class="code-number">60</span>
 Q<span class="code-number">202</span>=<span class="code-number">2</span>
 Q<span class="code-number">207</span>=<span class="code-number">300</span>

<span class="code-keyword">CYCL CALL</span>
L Z+<span class="code-number">100</span>FMAX
M5

<span class="code-comment">; OP20: KONTUR</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">2</span>Z S<span class="code-number">2500</span>
M3
<span class="code-comment">; ... weitere Bearbeitung</span>

<span class="code-comment">; OP30: FEINBOHREN Ø26 H7</span>
<span class="code-keyword">TOOL CALL</span><span class="code-number">11</span>Z S<span class="code-number">1200</span>
M3
L X+<span class="code-number">220</span>Y+<span class="code-number">25</span>FMAX

<span class="code-keyword">CYCL DEF</span><span class="code-number">201</span><span class="code-keyword">BORING</span>
 Q<span class="code-number">200</span>=<span class="code-number">2</span>
 Q<span class="code-number">201</span>=-<span class="code-number">25</span>
 Q<span class="code-number">206</span>=<span class="code-number">100</span>

<span class="code-keyword">CYCL CALL</span>
L Z+<span class="code-number">100</span>FMAX
M5
M30

<span class="code-keyword">END PGM</span>VERBINDUNGSPLATTE<span class="code-keyword">MM</span></pre>
</div>
</div>
</div>
 
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Programm-Info:</strong> <span id="codeLineCount">85</span> Zeilen | Geschätzte Laufzeit: <span id="codeRuntime">—</span> | Maschine: Hermle C 400<br>
<strong><span class="icon icon-sm" style="vertical-align:middle;"><svg viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> Nur zur Simulation!</strong> Dieser NC-Code ist eine <strong>Vorlage</strong> — kein produktionsfertiger Maschinencode. Vor dem Einsatz an der Maschine: (1) Im Simulator verifizieren, (2) Verfahrwege und Kollisionen prüfen, (3) Erste Zustellung im Einzelsatz fahren. <strong>Keine Haftung für Maschinenschäden.</strong>
</div>
</div>

<!-- AI Assistant Panel removed — NC-Code nutzt volle Breite -->
</div>
</div>
 
<!-- ========================================
 SECTION: FEEDBACK & CROSS-LEARNINGS
 ======================================== -->
<!-- ========================================
 SECTION: PROTOKOLL
 ======================================== -->
<div class="section" id="section-protocol">
<div class="card">
<div class="card-header"><span>Eingabe- & Entscheidungsprotokoll</span><span style="font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;">Vollständige Dokumentation</span></div>
<div class="card-body">
<p style="color: var(--color-text-muted); margin-bottom: var(--space-4); font-size:13px;">
Alle Eingaben, KI-Empfehlungen, Abweichungen und Entscheidungen — chronologisch dokumentiert. 
Dieses Protokoll wird automatisch erstellt und kann als Nachweis für die Angebotsgrundlage dienen.
</p>
<div id="masterProtocolContent">
<div style="padding:var(--space-5);text-align:center;">
<div style="font-size:48px;margin-bottom:var(--space-3);opacity:0.3;">
<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#c8aa50" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 15l2 2 4-4"/></svg>
</div>
<div style="font-weight:600;color:var(--color-text-secondary);margin-bottom:var(--space-2);">Noch keine Eingaben dokumentiert</div>
<div style="font-size:12px;color:var(--color-text-muted);max-width:400px;margin:0 auto;">
1. Bauteil auswählen<br>
2. Prüfprotokoll ausfüllen<br>
3. Kalkulation durchführen<br>
Alle Eingaben und Entscheidungen werden hier automatisch dokumentiert.
</div>
</div>
</div>
<div style="margin-top: var(--space-4); display:flex; gap: var(--space-3);">
<button class="btn btn-primary btn-sm" onclick="exportMasterProtocol()">Protokoll als PDF exportieren</button>
<button class="btn btn-secondary btn-sm" onclick="copyProtocolToClipboard()">In Zwischenablage kopieren</button>
</div>
</div>
</div>
</div>

<div class="section" id="section-feedback">

<!-- Entwicklungshinweis -->
<div style="background:repeating-linear-gradient(45deg,#fff8e1,#fff8e1 10px,#fff3cd 10px,#fff3cd 20px);border:2px solid #c8aa50;border-radius:var(--radius-lg);padding:var(--space-4);margin-bottom:var(--space-5);text-align:center;">
<div style="font-size:13px;color:var(--color-text-secondary);max-width:500px;margin:0 auto;">
Die Nachkalkulation ist in Entwicklung. Diese Ansicht zeigt eine <strong>Vorschau des geplanten Funktionsumfangs</strong> — keine produktionsfähige Ausgabe. Feedback willkommen!
</div>
</div>
 
<!-- Tabs -->
<div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-5); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-3);">
<button class="btn btn-sm btn-primary" id="tabFeedbackDashboard" onclick="showFeedbackTab('dashboard')">Dashboard</button>
<button class="btn btn-sm btn-secondary" id="tabFeedbackLearnings" onclick="showFeedbackTab('learnings')">Erkenntnisse</button>
<button class="btn btn-sm btn-secondary" id="tabFeedbackHistorie" onclick="showFeedbackTab('historie')">Historie</button>
</div>

<!-- TAB: Dashboard -->
<div id="feedback-dashboard">

<div class="info-box" style="margin-bottom:var(--space-4);">
<strong>Demo-Daten.</strong> Diese Kennzahlen werden automatisch befüllt sobald Aufträge nachkalkuliert werden. Die Werte zeigen exemplarisch, wie das Dashboard mit echten Daten aussehen wird.
</div>

<!-- KPI Karten -->
<div class="grid-4" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiAuftraege">47</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Angebote</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--color-success);" id="kpiAnnahme">68 %</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Annahmequote</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiVolumen">EUR 124.500</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Auftragsvolumen</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiDurchschnitt">EUR 2.649</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Ø Auftragswert</div>
</div>
</div>
</div>

<!-- Zweite Reihe -->
<div class="grid-3" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--color-warning);" id="kpiAbweichung">+18 %</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Ø Abweichung Soll/Ist</div>
<div style="font-size:10px;color:var(--color-text-muted);margin-top:2px;">Ziel: &lt;±10 %</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);" id="kpiNachkalk">12 / 47</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Nachkalkuliert</div>
<div style="margin-top:6px;">
<div style="height:6px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:26%;height:100%;background:var(--color-primary);border-radius:3px;" id="kpiNachkalkBar"></div>
</div>
<div style="font-size:10px;color:var(--color-text-muted);margin-top:2px;" id="kpiNachkalkPct">26 %</div>
</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-4);">
<div style="font-size:28px;font-weight:700;font-family:var(--font-mono);color:var(--color-success);" id="kpiZeitersparnis">142 h</div>
<div style="font-size:11px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;">Zeitersparnis (vs. manuell)</div>
<div style="font-size:10px;color:var(--color-text-muted);margin-top:2px;" id="kpiGeldersparnis">≈ EUR 8.520 gespart</div>
</div>
</div>
</div>

<!-- Verlustgründe -->
<div class="grid-2" style="gap: var(--space-5); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-header"><span>Verlustgründe (abgelehnte Angebote)</span></div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:var(--space-3);" id="kpiVerlustgruende">
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Preis zu hoch</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:43%;height:100%;background:var(--color-error);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">43 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Lieferzeit</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:27%;height:100%;background:var(--color-warning);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">27 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Kapazität</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:20%;height:100%;background:var(--color-info);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">20 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Sonstiges</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:10%;height:100%;background:var(--color-text-muted);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">10 %</span>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header"><span>Werkstoff-Verteilung (Aufträge)</span></div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:var(--space-3);" id="kpiWerkstoffe">
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">S235JR</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:52%;height:100%;background:var(--color-primary);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">52 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">AlMg3</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:23%;height:100%;background:#6366f1;border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">23 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">1.4301</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:15%;height:100%;background:#f59e0b;border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">15 %</span>
</div>
<div style="display:flex;align-items:center;gap:var(--space-3);">
<span style="width:120px;font-size:12px;">Andere</span>
<div style="flex:1;height:16px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
<div style="width:10%;height:100%;background:var(--color-text-muted);border-radius:3px;"></div>
</div>
<span class="mono" style="width:40px;text-align:right;font-size:12px;">10 %</span>
</div>
</div>
</div>
</div>
</div>

<!-- Monatsübersicht -->
<div class="card">
<div class="card-header"><span>Monatliche Entwicklung</span></div>
<div class="card-body" style="padding:0;overflow-x:auto;">
<table class="table">
<thead>
<tr>
<th>Monat</th>
<th class="right">Angebote</th>
<th class="right">Aufträge</th>
<th class="right">Quote</th>
<th class="right">Volumen</th>
<th class="right">Ø Abweichung</th>
</tr>
</thead>
<tbody>
<tr>
<td>Feb 2026</td>
<td class="right mono">8</td>
<td class="right mono">5</td>
<td class="right mono" style="color:var(--color-success);">63 %</td>
<td class="right mono">EUR 18.400</td>
<td class="right mono" style="color:var(--color-warning);">+22 %</td>
</tr>
<tr>
<td>Jan 2026</td>
<td class="right mono">12</td>
<td class="right mono">9</td>
<td class="right mono" style="color:var(--color-success);">75 %</td>
<td class="right mono">EUR 31.200</td>
<td class="right mono" style="color:var(--color-warning);">+16 %</td>
</tr>
<tr>
<td>Dez 2025</td>
<td class="right mono">10</td>
<td class="right mono">6</td>
<td class="right mono">60 %</td>
<td class="right mono">EUR 24.800</td>
<td class="right mono" style="color:var(--color-warning);">+19 %</td>
</tr>
<tr>
<td>Nov 2025</td>
<td class="right mono">9</td>
<td class="right mono">7</td>
<td class="right mono" style="color:var(--color-success);">78 %</td>
<td class="right mono">EUR 28.300</td>
<td class="right mono" style="color:var(--color-success);">+12 %</td>
</tr>
<tr>
<td>Okt 2025</td>
<td class="right mono">8</td>
<td class="right mono">5</td>
<td class="right mono">63 %</td>
<td class="right mono">EUR 21.800</td>
<td class="right mono" style="color:var(--color-warning);">+21 %</td>
</tr>
</tbody>
<tfoot style="font-weight:600;background:var(--color-bg-subtle);">
<tr>
<td>Gesamt</td>
<td class="right mono">47</td>
<td class="right mono">32</td>
<td class="right mono">68 %</td>
<td class="right mono">EUR 124.500</td>
<td class="right mono">+18 %</td>
</tr>
</tfoot>
</table>
</div>
</div>

</div>
 
<!-- TAB: Soll-Ist-Vergleich (Erfassung) -->
<div id="feedback-eingabe" style="display: none;">
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Soll-Ist-Vergleich erfassen</span></div>
<div class="card-body">

<!-- Auftragsstatus -->
<div class="grid-4" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Projekt-Nr.</label>
<input type="text" class="input input-mono" id="fbProjektNr" value="2500473.01" readonly style="background: var(--color-bg);">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Datum</label>
<input type="date" class="input" id="fbDatum" value="2026-02-05">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Erfasser</label>
<input type="text" class="input" id="fbErfasser" placeholder="Kürzel">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Auftragsstatus</label>
<select class="select" id="fbAuftragsstatus" onchange="toggleAblehnungsgrund()">
<option value="angenommen">Angenommen</option>
<option value="abgelehnt">Abgelehnt</option>
<option value="offen">Offen</option>
</select>
</div>
</div>

<!-- Ablehnungsgrund (nur bei abgelehnt) -->
<div id="fbAblehnungBox" style="display:none;margin-bottom:var(--space-5);">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom:0;">
<label class="form-label">Ablehnungsgrund</label>
<select class="select" id="fbAblehnungsgrund">
<option value="">—</option>
<option value="preis">Preis zu hoch</option>
<option value="lieferzeit">Lieferzeit zu lang</option>
<option value="kapazitaet">Keine Kapazität</option>
<option value="technik">Technisch nicht machbar</option>
<option value="wettbewerb">Wettbewerber günstiger</option>
<option value="sonstiges">Sonstiges</option>
</select>
</div>
<div class="form-group" style="margin-bottom:0;">
<label class="form-label">Wettbewerbspreis (falls bekannt)</label>
<div class="input-with-unit">
<input type="number" class="input input-mono" id="fbWettbewerbspreis" placeholder="—" step="0.01">
<span class="input-unit">EUR</span>
</div>
</div>
</div>
</div>
 
<div style="font-weight: 600; margin-bottom: var(--space-3); color: var(--color-text-muted); font-size: 12px; text-transform: uppercase;">Zeitabweichungen pro Operation</div>
 
<table class="table" style="margin-bottom: var(--space-5);">
<thead>
<tr>
<th style="width: 80px;">OP</th>
<th>Beschreibung</th>
<th style="width: 100px;">Kalk.</th>
<th style="width: 100px;">Ist</th>
<th style="width: 80px;">Delta</th>
<th style="width: 150px;">Grund</th>
<th>Notiz</th>
</tr>
</thead>
<tbody id="feedbackOpsTable">
<!-- Dynamically filled by renderFeedbackOps() -->
</tbody>
<tfoot style="background: var(--color-bg); font-weight: 600;" id="feedbackOpsFoot">
<!-- Dynamically filled by renderFeedbackOps() -->
</tfoot>
</table>
 
<!-- Visuelle Zusammenfassung -->
<div class="grid-3" style="gap: var(--space-4); margin-bottom: var(--space-5);">
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryDelta">—</div>
<div style="font-size:11px;color:var(--color-text-muted);">Zeitabweichung gesamt</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryCost">—</div>
<div style="font-size:11px;color:var(--color-text-muted);">Kostenabweichung</div>
</div>
</div>
<div class="card">
<div class="card-body" style="text-align:center;padding:var(--space-3);">
<div style="font-size:24px;font-weight:700;font-family:var(--font-mono);" id="fbSummaryOps">0 / 4</div>
<div style="font-size:11px;color:var(--color-text-muted);">OPs erfasst</div>
</div>
</div>
</div>

<div class="grid-2" style="gap: var(--space-5);">
<div>
<div style="font-weight: 600; margin-bottom: var(--space-3);">Fertigungsergebnis</div>
<div style="display: flex; flex-direction: column; gap: var(--space-2);">
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="io_erst" checked>i.O. — Erstfertigung
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="io_korrektur">i.O. — nach Korrektur
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="nacharbeit">Nacharbeit erforderlich
</label>
<label style="display: flex; align-items: center; gap: var(--space-2); cursor: pointer;">
<input type="radio" name="fbErgebnis" value="ausschuss">Ausschuss
</label>
</div>
</div>
<div>
<div style="font-weight: 600; margin-bottom: var(--space-3);">Korrekturvorschlag</div>
<textarea class="input" id="fbEmpfehlung" rows="4" placeholder="Was beim nächsten Mal anders machen? z.B. Vorschub -20% bei h5, Messzeit einplanen"></textarea>
</div>
</div>
</div>
</div>
 
<div style="display: flex; gap: var(--space-3);">
<button class="btn btn-primary" onclick="saveFeedback()">Nachkalkulation speichern</button>
<button class="btn btn-secondary" onclick="clearFeedbackForm()">Formular leeren</button>
</div>
</div>
 
<!-- TAB: Cross-Learnings -->
<div id="feedback-learnings" style="display: none;">
 
<!-- Kalkulations-Genauigkeit -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Kalkulationsgenauigkeit</span></div>
<div class="card-body">
<div class="grid-3" style="gap: var(--space-5); text-align: center;">
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-warning);" id="avgDeviation">+18%</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Ø Abweichung</div>
<div style="font-size: 11px; color: var(--color-text-muted);">(Richtwert)</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-primary);" id="feedbackCount">12</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Feedbacks</div>
<div style="font-size: 11px; color: var(--color-text-muted);">erfasst</div>
</div>
<div>
<div style="font-size: 32px; font-weight: 700; color: var(--color-success);" id="patternsFound">3</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Muster</div>
<div style="font-size: 11px; color: var(--color-text-muted);">erkannt</div>
</div>
</div>
 
<div style="margin-top: var(--space-5);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-2);">Häufigste Zeitfresser</div>
<div style="display: flex; flex-direction: column; gap: var(--space-2);">
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Einrichtung</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 72%; height: 100%; background: var(--color-error);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-error);">+18%</span>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Toleranz</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 60%; height: 100%; background: var(--color-warning);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-warning);">+15%</span>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="width: 100px; font-size: 13px;">Bearbeitung</span>
<div style="flex: 1; height: 20px; background: var(--color-bg); border-radius: var(--radius-sm); overflow: hidden;">
<div style="width: 12%; height: 100%; background: var(--color-success);"></div>
</div>
<span class="mono" style="width: 50px; text-align: right; color: var(--color-success);">+3%</span>
</div>
</div>
</div>
</div>
</div>
 
<!-- Erkannte Muster -->
<div class="card" style="margin-bottom: var(--space-5);">
<div class="card-header"><span>Erkannte Abweichungsmuster</span></div>
<div class="card-body" style="padding: 0;">
<div id="patternsContainer">
 
<!-- Muster 1 -->
<div style="padding: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Einrichtzeit bei Parallelspanner</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Häufigkeit: 8/12 Aufträge (67%) • Ø Mehraufwand: +12 min</div>
</div>
<span style="background: var(--color-error-light); color: var(--color-error); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">HOCH</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">Fräskanten für Parallelspanner fehlen in der Kalkulation. Werker müssen zusätzlich Flächen anfräsen.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Setup-Zeit +15 min bei Spannart "Parallelspanner"</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('setup_parallel', 15)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('setup_parallel')">Ignorieren</button>
</div>
</div>
 
<!-- Muster 2 -->
<div style="padding: var(--space-4); border-bottom: 1px solid var(--color-border-light);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Toleranz h5/H7 unterschätzt</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Häufigkeit: 5/7 Passungen (71%) • Ø Mehraufwand: +4 min pro Passung</div>
</div>
<span style="background: var(--color-warning-light); color: var(--color-warning); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">MITTEL</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">Messzeit und reduzierter Vorschub bei engen Toleranzen nicht ausreichend einkalkuliert.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Toleranz-Faktor 1.3× für h5/H7</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('tolerance_factor', 1.3)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('tolerance_factor')">Ignorieren</button>
</div>
</div>
 
<!-- Muster 3 -->
<div style="padding: var(--space-4);">
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3);">
<div>
<div style="font-weight: 600; color: var(--color-text);">Material S235: Rohteil-Übermaß</div>
<div style="font-size: 12px; color: var(--color-text-muted);">Häufigkeit: 4/10 Aufträge (40%) • Ø Mehraufwand: +3 min</div>
</div>
<span style="background: var(--color-info-light); color: var(--color-info); padding: 2px 8px; border-radius: var(--radius-sm); font-size: 11px; font-weight: 600;">NIEDRIG</span>
</div>
<div style="background: var(--color-bg); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-3);">
<div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: var(--space-1);">Ursache</div>
<div style="font-size: 13px;">S235 Rohteile haben oft 0.3-0.5mm Übermaß. Zusätzlicher Planfräs-Durchgang nötig.</div>
</div>
<div style="display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 13px;"><strong>Vorschlag:</strong> Rohteil-Aufmaß auf 1.0mm bei S235</span>
<button class="btn btn-sm btn-primary" onclick="applyPattern('s235_aufmass', 1.0)">Anwenden</button>
<button class="btn btn-sm btn-secondary" onclick="ignorePattern('s235_aufmass')">Ignorieren</button>
</div>
</div>
 
</div>
</div>
</div>
 
<!-- Empfehlungen aus Feedback -->
<div class="card">
<div class="card-header"><span>Korrekturvorschläge</span></div>
<div class="card-body" style="padding: 0;">
<div id="recommendationsContainer">
<div style="padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-light); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"Bei Parallelspanner Fräskanten einplanen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">3× gemeldet • Zuletzt: 05.02.2026</div>
</div>
</div>
<div style="padding: var(--space-3) var(--space-4); border-bottom: 1px solid var(--color-border-light); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"h5-Toleranz: Vorschub -20%, Messzeit einplanen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">2× gemeldet • Zuletzt: 04.02.2026</div>
</div>
</div>
<div style="padding: var(--space-3) var(--space-4); display: flex; align-items: center; gap: var(--space-3);">
<span style="font-size: 18px;"></span>
<div style="flex: 1;">
<div style="font-size: 13px;">"S235 Rohteil oft mit Übermaß — erst planfräsen"</div>
<div style="font-size: 11px; color: var(--color-text-muted);">1× gemeldet • Zuletzt: 03.02.2026</div>
</div>
</div>
</div>
</div>
</div>
 
</div>
 
<!-- TAB: Historie -->
<div id="feedback-historie" style="display:none;">
<div class="info-box" style="margin-bottom:var(--space-4);">
<strong>Demo-Daten.</strong> Gespeicherte Nachkalkulationen erscheinen hier automatisch nach dem Erfassen im Soll-Ist-Vergleich.
</div>
<div class="card">
<div class="card-header">
<span>Nachkalkulationen</span>
<div>
<button class="btn btn-sm btn-secondary" onclick="exportFeedbackCSV()">CSV Export</button>
</div>
</div>
<div class="card-body" style="padding: 0; overflow-x: auto;">
<table class="table">
<thead>
<tr>
<th>Datum</th>
<th>Projekt</th>
<th>Erfasser</th>
<th class="right">Kalk.</th>
<th class="right">Ist</th>
<th class="right">Delta</th>
<th>Hauptgrund</th>
<th>Ergebnis</th>
</tr>
</thead>
<tbody id="feedbackHistoryTable">
<tr>
<td class="mono">05.02.2026</td>
<td class="mono">2500473.01</td>
<td>M. Schmidt</td>
<td class="mono right">42 min</td>
<td class="mono right">48 min</td>
<td class="mono right" style="color: var(--color-error);">+14%</td>
<td>Einrichtung</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">04.02.2026</td>
<td class="mono">2500112.03</td>
<td>K. Weber</td>
<td class="mono right">28 min</td>
<td class="mono right">26 min</td>
<td class="mono right" style="color: var(--color-success);">-7%</td>
<td>—</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">03.02.2026</td>
<td class="mono">2500098.01</td>
<td>M. Schmidt</td>
<td class="mono right">35 min</td>
<td class="mono right">43 min</td>
<td class="mono right" style="color: var(--color-error);">+23%</td>
<td>Toleranz</td>
<td>Nacharbeit</td>
</tr>
<tr>
<td class="mono">02.02.2026</td>
<td class="mono">2500087.02</td>
<td>T. Müller</td>
<td class="mono right">52 min</td>
<td class="mono right">55 min</td>
<td class="mono right" style="color: var(--color-warning);">+6%</td>
<td>Material</td>
<td>i.O.</td>
</tr>
<tr>
<td class="mono">01.02.2026</td>
<td class="mono">2500076.01</td>
<td>K. Weber</td>
<td class="mono right">18 min</td>
<td class="mono right">17 min</td>
<td class="mono right" style="color: var(--color-success);">-6%</td>
<td>—</td>
<td>i.O.</td>
</tr>
</tbody>
</table>
</div>
</div>
 
<div class="info-box" style="margin-top: var(--space-4);">
<strong>Stand:</strong> 12 Nachkalkulationen • Ø Abweichung Soll/Ist: +18 % • 
<span style="color: var(--color-success);">83% i.O.</span>• 
<span style="color: var(--color-warning);">17% Nacharbeit</span>
</div>
</div>
 
</div>
 
<!-- ========================================
 SECTION: EINSTELLUNGEN
 ======================================== -->
<div class="section" id="section-settings">
<!-- TAB: Firmendaten -->
<div id="settings-firma">
<div class="card">
<div class="card-header"><span>Firmendaten</span></div>
<div class="card-body">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group">
<label class="form-label">Firmenname</label>
<input type="text" class="input" value="Muster CNC GmbH" id="firmaName">
</div>
<div class="form-group">
<label class="form-label">Ansprechpartner</label>
<input type="text" class="input" value="Max Mustermann" id="firmaAnsprech">
</div>
<div class="form-group">
<label class="form-label">Bearbeiter / Kürzel</label>
<input type="text" class="input" value="" id="firmaBearbeiter" placeholder="z.B. MS, KW">
</div>
<div class="form-group">
<label class="form-label">Abteilung</label>
<input type="text" class="input" value="" id="firmaAbteilung" placeholder="z.B. Arbeitsvorbereitung">
</div>
<div class="form-group">
<label class="form-label">Straße</label>
<input type="text" class="input" value="Industriestraße 42" id="firmaStrasse">
</div>
<div class="form-group">
<label class="form-label">PLZ / Ort</label>
<input type="text" class="input" value="01234 Musterstadt" id="firmaOrt">
</div>
<div class="form-group">
<label class="form-label">Telefon</label>
<input type="text" class="input" value="+49 123 456789" id="firmaTel">
</div>
<div class="form-group">
<label class="form-label">E-Mail</label>
<input type="email" class="input" value="info@muster-cnc.de" id="firmaEmail">
</div>
<div class="form-group">
<label class="form-label">Steuernummer</label>
<input type="text" class="input" value="DE123456789" id="firmaSteuer">
</div>
<div class="form-group">
<label class="form-label">Bankverbindung</label>
<input type="text" class="input" value="DE89 3704 0044 0532 0130 00" id="firmaIBAN">
</div>
</div>
</div>
</div>
 
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Angebots- und Dokumenteneinstellungen</span></div>
<div class="card-body">
<div class="grid-3" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Gültigkeit (Tage)</label>
<input type="number" class="input input-mono" value="30" id="angebotsGueltigkeit">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Standard-Lieferzeit</label>
<input type="text" class="input" value="3-4 Wochen" id="standardLieferzeit">
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Zahlungsziel (Tage)</label>
<input type="number" class="input input-mono" value="14" id="zahlungsziel">
</div>
</div>
</div>
</div>
</div>
 
<!-- Firmenlogo -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Firmenlogo</span></div>
<div class="card-body">
<div style="display:flex;align-items:center;gap:var(--space-4);">
<div id="logoPreview" style="width:120px;height:60px;border:1px dashed var(--color-border);border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--color-text-muted);overflow:hidden;">
Kein Logo
</div>
<div>
<input type="file" id="logoUpload" accept="image/png,image/jpeg,image/svg+xml" style="display:none;">
<button class="btn btn-secondary btn-sm" onclick="var inp=document.getElementById('logoUpload'); inp.value=''; inp.onchange=function(){previewLogo(this);}; inp.click();">Logo hochladen</button>
<div style="font-size:11px;color:var(--color-text-muted);margin-top:4px;">PNG oder JPG, max. 200×100 px empfohlen</div>
</div>
</div>
</div>
</div>

<!-- Sprache & Darstellung -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Darstellung</span></div>
<div class="card-body">
<div class="grid-2" style="gap: var(--space-4);">
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Sprache</label>
<select class="select" id="settingLanguage">
<option value="de" selected>Deutsch</option>
<option value="en" disabled>English (in Vorbereitung)</option>
</select>
</div>
<div class="form-group" style="margin-bottom: 0;">
<label class="form-label">Währung</label>
<select class="select" id="settingCurrency">
<option value="EUR" selected>EUR</option>
<option value="CHF">CHF</option>
<option value="USD" disabled>USD (in Vorbereitung)</option>
</select>
</div>
</div>
</div>
</div>

<!-- Buttons -->
<div style="margin-top: var(--space-5); display: flex; gap: var(--space-3); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
<button class="btn btn-primary" onclick="saveSettings()">Einstellungen speichern</button>
<button class="btn btn-secondary" onclick="resetSettings()">Zurücksetzen</button>
<button class="btn btn-secondary" style="margin-left: auto;" onclick="exportSettings()">Export JSON</button>
<button class="btn btn-secondary" onclick="importSettings()">Import</button>
</div>
 
<p style="margin-top: var(--space-4); font-size: 12px; color: var(--color-text-muted);">
 Einstellungen werden lokal im Browser gespeichert (localStorage). Export erstellt eine JSON-Datei für Backup oder Übertragung auf andere Geräte.
</p>

<!-- Kalkulationslogik -->
<div class="card" style="margin-top: var(--space-6);">
<div class="card-header" style="cursor:pointer;" onclick="document.getElementById('calcLogicContent').style.display = document.getElementById('calcLogicContent').style.display === 'none' ? 'block' : 'none'">
<span>Kalkulationslogik und Nachkalkulation</span>
<span style="float:right; font-size: 12px; color: var(--color-text-muted);">▼ Auf-/Zuklappen</span>
</div>
<div class="card-body" id="calcLogicContent" style="display:none; font-size: 13px; line-height: 1.7;">

<div style="font-weight: 600; margin-bottom: var(--space-3);">Kalkulationsprinzip</div>
<p>CNC Planer Pro verwendet die <strong>differenzierende Zuschlagskalkulation</strong> nach industriellem Standard (REFA). Die Berechnung erfolgt in drei Stufen:</p>
<ol style="margin:var(--space-2) 0 var(--space-3) var(--space-5);">
<li><strong>Zeitermittlung:</strong> Hauptzeit (t_h) + Nebenzeit (t_n) + Rüstzeit (t_r) pro Arbeitsgang, basierend auf VDI 3321 Schnittdaten und REFA-Richtwerten</li>
<li><strong>Kostenzuordnung:</strong> Zeit × Stundensatz (Lohn + Maschine) pro Kostenstelle (CNC, Sägen, Entgraten, QS)</li>
<li><strong>Zuschlagskalkulation:</strong> Material → +MGK → Fertigungskosten → +FGK → +AV → Herstellkosten → +VwGK → +VtGK → Selbstkosten → +Gewinn → Angebotspreis</li>
</ol>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Nachkalkulation</div>
<p>Die Nachkalkulation vergleicht <strong>Soll-Zeiten</strong> (Vorkalkulation) mit <strong>Ist-Zeiten</strong> (tatsächliche Fertigung). Ziel: Kalkulationsgenauigkeit über Zeit verbessern.</p>
<p><strong>Ablauf:</strong> Vorkalkulation erstellen → Fertigung → Ist-Zeiten erfassen → Abweichungen analysieren → Kalkulationsparameter anpassen.</p>
<p>Die Nachkalkulation ist aktuell in Entwicklung. In der Vollversion werden Ist-Zeiten automatisch mit den Soll-Werten verglichen und Korrekturvorschläge generiert.</p>

<div style="font-weight: 600; margin: var(--space-3) 0;">Für Betriebe mit eigener Kalkulationslogik</div>
<p>Alle Parameter (Stundensätze, Zuschläge, Materialpreise) sind unter <a href="#" onclick="showParamTab('stunden');return false;" style="color:var(--color-text-secondary);text-decoration:underline;">Preise &amp; Sätze</a> anpassbar. Wenn Ihr Betrieb eine andere Zuschlagsstruktur verwendet (z.B. abweichende VwGK-Basis oder pauschale Gemeinkostenzuschläge), passen Sie die Sätze entsprechend an. Die Kalkulationsformel selbst ist transparent und nachvollziehbar — jeder Wert ist in der Kalkulation aufschlüsselbar.</p>
</div>
</div>

<!-- Nutzerdokumentation -->
<div class="card" style="margin-top: var(--space-6);">
<div class="card-header" style="cursor:pointer;" onclick="document.getElementById('userDocContent').style.display = document.getElementById('userDocContent').style.display === 'none' ? 'block' : 'none'">
<span>Nutzerdokumentation</span>
<span style="float:right; font-size: 12px; color: var(--color-text-muted);">▼ Auf-/Zuklappen</span>
</div>
<div class="card-body" id="userDocContent" style="display:none; font-size: 13px; line-height: 1.7; max-height: 70vh; overflow-y: auto;">

<div style="font-weight: 700; font-size: 16px; margin-bottom: var(--space-4); padding-bottom: var(--space-3); border-bottom: 2px solid var(--color-border);">CNC Planer Pro — Nutzerdokumentation</div>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">1. Überblick</div>
<p>CNC Planer Pro ist ein Vorkalkulations-Werkzeug für CNC-Lohnfertiger. Es ersetzt den Taschenrechner und die Excel-Tabelle — nicht das ERP-System.</p>
<p><strong>Was das Tool macht:</strong> Automatische Zeitermittlung, Zuschlagskalkulation, Fertigungsanweisung, Angebotsvorlage, NC-Code-Entwurf.</p>
<p><strong>Was das Tool NICHT macht:</strong> Kein ERP-Ersatz, keine verbindlichen Preise ohne Kalibrierung, kein produktionsfertiger NC-Code.</p>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">2. Schnellstart</div>
<ol style="padding-left: var(--space-5); color: var(--color-text-secondary);">
<li><strong>Einstellungen → Preise &amp; Sätze anpassen:</strong> Ihre Stundensätze, Materialpreise, Zuschlagssätze</li>
<li><strong>Firmendaten eintragen</strong> (für Angebotsvorlage)</li>
<li><strong>Bauteil wählen oder Abmessungen eingeben</strong></li>
<li><strong>„Prüfprotokoll und Kalkulation starten" klicken</strong></li>
</ol>
<div class="info-box" style="margin: var(--space-3) 0;">Die voreingestellten Werte basieren auf Erfahrungswerten eines sächsischen Lohnfertigers. Ohne Anpassung an Ihren Betrieb sind die Ergebnisse nur Richtwerte.</div>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">3. Kalkulationsschema</div>
<p>Differenzierende Zuschlagskalkulation (Industriestandard):</p>
<div style="font-family: var(--font-mono); font-size: 12px; background: var(--color-bg); padding: var(--space-4); border-radius: var(--radius-sm); margin-bottom: var(--space-3); border: 1px solid var(--color-border-light);">
MEK (Material) + MGK% → Materialkosten<br>
FEK (Fertigung) + AV% → Fertigungskosten<br>
= HERSTELLKOSTEN<br>
+ VwGK% + VtGK% = SELBSTKOSTEN<br>
+ Gewinn% = <strong>ANGEBOTSPREIS</strong>
</div>

<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Zuschlag</th><th class="right">Voreinstellung</th><th>Bezugsgröße</th><th class="right">Typisch</th></tr></thead>
<tbody>
<tr><td>MGK</td><td class="right mono">5 %</td><td>Materialeinzelkosten</td><td class="right">3–15 %</td></tr>
<tr><td>AV</td><td class="right mono">12 %</td><td>Fertigungseinzelkosten</td><td class="right">8–15 %</td></tr>
<tr><td>VwGK</td><td class="right mono">10 %</td><td>Herstellkosten</td><td class="right">8–15 %</td></tr>
<tr><td>VtGK</td><td class="right mono">5 %</td><td>Herstellkosten</td><td class="right">3–8 %</td></tr>
<tr><td>Gewinn</td><td class="right mono">8 %</td><td>Selbstkosten</td><td class="right">5–15 %</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">4. Stundensätze</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Arbeitsgang</th><th class="right">Lohn</th><th class="right">Maschine</th><th class="right">Gesamt</th></tr></thead>
<tbody>
<tr><td>CNC-Fräsen</td><td class="right mono">38 EUR/h</td><td class="right mono">32 EUR/h</td><td class="right mono"><strong>70 EUR/h</strong></td></tr>
<tr><td>Sägen</td><td class="right mono">35 EUR/h</td><td class="right mono">10 EUR/h</td><td class="right mono"><strong>45 EUR/h</strong></td></tr>
<tr><td>Entgraten</td><td class="right mono">28 EUR/h</td><td class="right mono">3 EUR/h</td><td class="right mono"><strong>31 EUR/h</strong></td></tr>
</tbody>
</table>
<p style="color: var(--color-text-muted); font-size: 12px;">Werkzeugkosten sind im Maschinenstundensatz enthalten.</p>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">5. Werkstoffdatenbank</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Werkstoff</th><th>Bezeichnung</th><th class="right">Dichte</th><th class="right">Preis/kg</th><th class="right">Zeitfaktor</th></tr></thead>
<tbody>
<tr><td>S235JR</td><td>Baustahl</td><td class="right mono">7,85</td><td class="right mono">1,40</td><td class="right mono">1,00</td></tr>
<tr><td>S355J2</td><td>Feinkornbaustahl</td><td class="right mono">7,85</td><td class="right mono">1,65</td><td class="right mono">1,02</td></tr>
<tr><td>C45</td><td>Vergütungsstahl</td><td class="right mono">7,85</td><td class="right mono">1,80</td><td class="right mono">1,10</td></tr>
<tr><td>1.4301</td><td>V2A</td><td class="right mono">7,90</td><td class="right mono">4,80</td><td class="right mono">1,25</td></tr>
<tr><td>1.4404</td><td>V4A</td><td class="right mono">7,95</td><td class="right mono">5,50</td><td class="right mono">1,30</td></tr>
<tr><td>1.4571</td><td>Edelstahl</td><td class="right mono">8,00</td><td class="right mono">5,20</td><td class="right mono">1,35</td></tr>
<tr><td>AlMg3</td><td>Aluminium</td><td class="right mono">2,66</td><td class="right mono">4,50</td><td class="right mono">0,70</td></tr>
<tr><td>AlMgSi1</td><td>Aluminium</td><td class="right mono">2,70</td><td class="right mono">4,80</td><td class="right mono">0,72</td></tr>
<tr><td>Al7075</td><td>Alu hochfest</td><td class="right mono">2,81</td><td class="right mono">8,50</td><td class="right mono">0,85</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">6. Bereiche im Überblick</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Bereich</th><th>Funktion</th><th>Export</th></tr></thead>
<tbody>
<tr><td><strong>Kalkulation</strong></td><td>Zuschlagskalkulation, Kostenübersicht, DB-Rechnung, Staffelpreise</td><td>PDF</td></tr>
<tr><td><strong>Fertigungsanweisung</strong></td><td>Operationsplan, Schnittdaten, Prüfmerkmale. OPs an-/abwählbar.</td><td>PDF, CSV</td></tr>
<tr><td><strong>Angebot</strong></td><td>Professionelle Angebotsvorlage mit Firmenkopf</td><td>PDF</td></tr>
<tr><td><strong>Werkzeuge</strong></td><td>Schnittparameter, Werkzeugeinsatz, Standzeiten</td><td>PDF</td></tr>
<tr><td><strong>NC-Code</strong></td><td>Entwurf für Heidenhain, Siemens, Fanuc</td><td>Kopieren</td></tr>
<tr><td><strong>Nachkalkulation</strong></td><td>Soll-Ist-Vergleich, Historie, Erkenntnisse, Dashboard</td><td>CSV</td></tr>
<tr><td><strong>Einstellungen</strong></td><td>Stundensätze, Materialpreise, Zuschläge, Firmendaten</td><td>JSON</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">7. Normen &amp; Standards</div>
<table class="table" style="margin-bottom: var(--space-4); font-size: 12px;">
<thead><tr><th>Norm</th><th>Anwendung</th></tr></thead>
<tbody>
<tr><td>REFA</td><td>Zeitgliederung (Haupt-, Neben-, Rüstzeit)</td></tr>
<tr><td>VDI 3321</td><td>Schnittdatenrichtwerte</td></tr>
<tr><td>DIN 8580</td><td>Fertigungsverfahren</td></tr>
<tr><td>DIN EN 10027</td><td>Werkstoffbezeichnungen</td></tr>
<tr><td>DIN ISO 2768-mK</td><td>Allgemeintoleranzen</td></tr>
</tbody>
</table>

<div style="font-weight: 600; font-size: 14px; margin: var(--space-5) 0 var(--space-3);">8. Datenschutz</div>
<p>Alle Daten verbleiben lokal im Browser. Es werden keine Daten an externe Server übertragen. Einstellungen werden im lokalen Browserspeicher (localStorage) gespeichert.</p>

</div>
</div>

<!-- Kurzreferenz -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Kurzreferenz</span></div>
<div class="card-body" style="font-size: 13px; line-height: 1.7;">
<div style="font-weight: 600; margin-bottom: var(--space-3);">Workflow</div>
<ol style="padding-left: var(--space-5); margin-bottom: var(--space-4); color: var(--color-text-secondary);">
<li><strong>Teil auswählen</strong> — Bauteil aus Bibliothek oder manuell anlegen</li>
<li><strong>Werkstück konfigurieren</strong> — Material, Rohmaße, Stückzahl, Aufspannungen</li>
<li><strong>Prüfprotokoll</strong> — Vorkalkulation auf Basis der hinterlegten Parameter</li>
<li><strong>Ergebnis prüfen</strong> — Kostenaufschlüsselung, Deckungsbeitragsrechnung</li>
<li><strong>Fertigungsanweisung</strong> — Operationsplan mit Schnittdaten und Skizzen</li>
<li><strong>Angebot erstellen</strong> — Automatisch aus Kalkulation generiert</li>
<li><strong>NC-Code</strong> — Maschinencode für Heidenhain, Siemens oder Fanuc</li>
<li><strong>Nachkalkulation</strong> — Ist-Zeiten erfassen, Abweichungen analysieren</li>
</ol>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Kalkulationsmethodik</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
Die Vorkalkulation basiert auf der differenzierenden Zuschlagskalkulation nach industriellem Standard.
Zeitermittlung erfolgt formelbasiert nach REFA-Methodik, Schnittdaten nach VDI 3321.
Zuschlagssätze (MGK, AV, VwGK, VtGK, Gewinn) sind betriebsspezifisch unter "Preise &amp; Sätze" anpassbar.
Die Ergebnisse sind formelbasierte Richtwerte. Ein Abgleich mit der betrieblichen Nachkalkulation wird empfohlen.
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Tastenkombinationen</div>
<table class="table" style="margin-bottom: var(--space-4);">
<tbody>
<tr><td style="width: 180px;"><kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">Strg</kbd> + <kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">P</kbd></td><td style="color:var(--color-text-secondary);">PDF-Druck</td></tr>
<tr><td><kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">Strg</kbd> + <kbd style="background:var(--color-bg-subtle);padding:1px 6px;border-radius:3px;font-size:12px;">S</kbd></td><td style="color:var(--color-text-secondary);">Einstellungen speichern</td></tr>
</tbody>
</table>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Datenformat</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-5);">
Alle Kalkulationsdaten werden lokal im Browser verarbeitet. Es werden keine Daten an externe Server übertragen.
Exportformate: CSV (Nachkalkulation), JSON (Einstellungen), PDF (Angebot/Fertigungsanweisung).
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Bekannte Einschränkungen</div>
<div style="color: var(--color-text-secondary); margin-bottom: var(--space-5); line-height: 1.7;">
<table class="table" style="font-size: 13px;">
<thead>
<tr><th style="width:30%;">Bereich</th><th>Einschränkung</th></tr>
</thead>
<tbody>
<tr><td><strong>Geometrie-Erkennung</strong></td><td>Keine CAD-Analyse. Operationsplan wird aus Abmessungen und Werkstoff abgeleitet — nicht aus der tatsächlichen Bauteilgeometrie. Fehlende oder überflüssige Arbeitsgänge sind möglich.</td></tr>
<tr><td><strong>Aufspannungen</strong></td><td>Vereinfachte Darstellung (1–2 Aufspannungen). Bei mehrseitiger Bearbeitung, Hinterschnitten oder komplexen Spannlagen sind zusätzliche Umspannungen nötig, die manuell ergänzt werden müssen.</td></tr>
<tr><td><strong>Rüstzeiten</strong></td><td>Pauschale Schätzung. Tatsächliche Rüstzeiten hängen stark von Vorrichtungen, Spannmitteln, Erfahrung des Einrichters und Maschinenzustand ab.</td></tr>
<tr><td><strong>Sonderprozesse</strong></td><td>Nicht abgedeckt: Wärmebehandlung, Oberflächenbeschichtung, Schleifen (außer als vereinfachte OP), Erodieren, Montage, externe Bearbeitung.</td></tr>
<tr><td><strong>Bearbeitungszeiten</strong></td><td>Richtwerte nach VDI 3321. Abweichungen von ±30 % zur Realität sind ohne betriebsspezifische Kalibrierung möglich — insbesondere bei engen Toleranzen und schwerzerspanbaren Werkstoffen.</td></tr>
<tr><td><strong>NC-Code</strong></td><td>Entwurf, kein Produktionscode. Simulation vor erstem Einsatz zwingend erforderlich.</td></tr>
<tr><td><strong>Bauteilkomplexität</strong></td><td>Optimiert für prismatische Frästeile (Platten, Blöcke, einfache 3D-Konturen). Nicht ausgelegt für Freiformflächen, 5-Achs-Simultanbearbeitung oder Drehteile.</td></tr>
</tbody>
</table>
</div>

<div style="font-weight: 600; margin-bottom: var(--space-3);">Häufige Fragen (FAQ)</div>
<div style="font-size:13px;color:var(--color-text-secondary);line-height:1.7;">

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich eigene Werkzeuge eintragen?</div>
Derzeit nicht. Die Werkzeugliste wird automatisch aus dem Operationsplan abgeleitet. Eigene Werkzeugdatenbanken (T-Nummern, Geometrien, Standzeiten) sind für eine zukünftige Version geplant.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Was passiert, wenn eine Operation fehlt?</div>
Der Operationsplan wird auf Basis der Bauteilgeometrie und Toleranzen erstellt. Prozesse außerhalb der spanenden Bearbeitung (Wärmebehandlung, Beschichtung, Oberflächenveredelung, Montage) werden nicht erfasst und müssen separat kalkuliert werden. Über die Nachkalkulation können Sie Abweichungen dokumentieren und bei zukünftigen Aufträgen manuell berücksichtigen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Wie verlässlich ist die Vorkalkulation?</div>
Die Kalkulation basiert auf Schnittdatenrichtwerten (VDI 3321), REFA-Zeitbausteinen und hinterlegten Maschinenstundensätzen. Die Ergebnisse sind eine qualifizierte Schätzung — nicht gleichzusetzen mit einer Nachkalkulation auf Basis realer Fertigungsdaten. Die Hauptunsicherheiten liegen bei Rüstzeiten (stark auftrags- und mitarbeiterabhängig), engen Toleranzen und schwerzerspanbaren Werkstoffen. Je mehr Nachkalkulationen erfasst werden, desto besser können Sie die hinterlegten Werte an Ihren Betrieb anpassen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich die Zuschlagssätze ändern?</div>
Ja. Unter Konfiguration → Preise &amp; Sätze → Tab "Zuschläge". Die hinterlegten Werte (MGK, AV, VwGK, VtGK, Gewinn) sind branchenübliche Richtwerte und sollten an Ihre betriebliche Kostenrechnung angepasst werden.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Kann ich Materialpreise aktualisieren?</div>
Ja. Unter Konfiguration → Preise &amp; Sätze → Tab "Materialpreise". Die voreingestellten Preise dienen als Orientierung. Empfehlung: Mit aktuellen Einkaufspreisen Ihres Stahlhandels abgleichen.
</div>

<div style="margin-bottom:var(--space-4);">
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Ist der NC-Code direkt an der Maschine verwendbar?</div>
Nein. Der generierte NC-Code ist ein Entwurf, der als Ausgangsbasis dient. Vor dem Einsatz müssen Werkzeugdaten, Nullpunkt, Sicherheitsebene und Verfahrwege geprüft und an die jeweilige Maschine angepasst werden. Eine Simulation vor dem ersten Durchlauf ist zwingend erforderlich.
</div>

<div>
<div style="font-weight:500;color:var(--color-text);margin-bottom:2px;">Wo werden meine Daten gespeichert?</div>
Alle Daten verbleiben lokal in Ihrem Browser (localStorage). Es werden keine Daten an Server übertragen. Über "Export JSON" in den Einstellungen können Sie Ihre Konfiguration sichern.
</div>

</div>
</div>
</div>

<!-- App-Info -->
<div class="card" style="margin-top: var(--space-5);">
<div class="card-header"><span>Systeminformationen</span></div>
<div class="card-body" style="padding: 0;">
<table class="table">
<tbody>
<tr>
<td style="width:200px; color: var(--color-text-muted);">Anwendung</td>
<td>CNC Planer Pro</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Version</td>
<td class="mono">v0.18.0-beta</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Build</td>
<td class="mono">2026-02-06</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Referenzmaschine</td>
<td>Hermle C 400 (3-Achs-BAZ)</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Steuerungen</td>
<td>Heidenhain TNC 640, Siemens 840D, Fanuc 0i-MF</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Normen</td>
<td>REFA, VDI 3321, DIN 8580, DIN EN 10027</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Datenspeicherung</td>
<td>Lokal (localStorage), keine Cloud-Anbindung</td>
</tr>
<tr>
<td style="color: var(--color-text-muted);">Lizenz</td>
<td>Proprietär — Alle Rechte vorbehalten</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

</div>
</main>

<!-- Sticky Feedback Button -->
<!-- Sticky Action Bar (replaces FAB) -->
<div id="actionBar" style="position:fixed;bottom:0;left:var(--sidebar-width);right:0;height:44px;background:#fff;border-top:1px solid var(--color-border);display:flex;align-items:center;padding:0 var(--space-5);gap:var(--space-3);z-index:100;box-shadow:0 -2px 8px rgba(0,0,0,0.05);">
<button class="btn btn-sm" style="color:var(--color-success);border-color:var(--color-success);" onclick="openWorkerDialog()"><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg></span> Werker befragen</button>
<button class="btn btn-sm" style="color:#0d6efd;border-color:#0d6efd;" onclick="openKiDialog()"><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> Frage die KI</button>
<button class="btn btn-sm" onclick="openFeedbackDialog()"><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span> Feedback geben</button>
<span style="margin-left:auto;font-size:11px;color:var(--color-text-muted);" id="actionBarContext">—</span>
</div>

<!-- Worker Dialog -->
<div id="workerDialog" style="display:none;position:fixed;bottom:48px;left:50%;transform:translateX(-50%);width:420px;background:#fff;border-radius:var(--radius-lg);box-shadow:0 4px 24px rgba(0,0,0,0.15);z-index:200;border:1px solid var(--color-border);">
<div style="padding:var(--space-4);border-bottom:1px solid var(--color-border);font-weight:600;display:flex;justify-content:space-between;align-items:center;">
<span>Werker befragen</span>
<button onclick="document.getElementById('workerDialog').style.display='none'" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--color-text-muted);">×</button>
</div>
<div style="padding:var(--space-4);">
<div style="font-size:12px;color:var(--color-text-muted);margin-bottom:var(--space-3);" id="workerDialogContext"></div>
<div style="font-weight:600;font-size:12px;margin-bottom:var(--space-2);">Frage auswählen:</div>
<div id="workerQuestionList" style="display:flex;flex-direction:column;gap:var(--space-2);margin-bottom:var(--space-3);"></div>
<div style="font-size:12px;font-weight:600;margin-bottom:var(--space-2);">Oder eigene Frage:</div>
<textarea class="input" id="workerCustomQ" rows="2" placeholder="z.B. Wie lange braucht ihr für das Ausrichten?" style="font-size:12px;margin-bottom:var(--space-3);"></textarea>
<button class="btn btn-primary btn-sm" onclick="sendWorkerQuestion()" style="width:100%;">Via WhatsApp senden</button>
</div>
</div>

<!-- Feedback Dialog -->
<div id="feedbackDialog" style="display:none;position:fixed;bottom:48px;left:50%;transform:translateX(-50%);width:420px;background:#fff;border-radius:var(--radius-lg);box-shadow:0 4px 24px rgba(0,0,0,0.15);z-index:200;border:1px solid var(--color-border);">
<div style="padding:var(--space-4);border-bottom:1px solid var(--color-border);font-weight:600;display:flex;justify-content:space-between;align-items:center;">
<span>Feedback</span>
<button onclick="document.getElementById('feedbackDialog').style.display='none'" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--color-text-muted);">×</button>
</div>
<div style="padding:var(--space-4);">
<div style="font-size:12px;color:var(--color-text-muted);margin-bottom:var(--space-3);" id="feedbackDialogContext"></div>
<select class="select" id="feedbackCategory" style="margin-bottom:var(--space-3);">
<option value="funktion" selected>Funktion anfragen</option>
<option value="fehler">Fehler / Falscher Wert</option>
<option value="verbesserung">Verbesserungsvorschlag</option>
<option value="frage">Frage / Unklar</option>
<option value="lob">Passt gut / Bestätigung</option>
</select>
<textarea class="input" id="feedbackText" rows="3" placeholder="Was ist aufgefallen?" style="font-size:12px;margin-bottom:var(--space-3);"></textarea>
<button class="btn btn-primary btn-sm" onclick="submitFeedback()" style="width:100%;">Feedback senden</button>
</div>
</div>

<!-- KI Dialog -->
<div id="kiDialog" style="display:none;position:fixed;bottom:48px;left:50%;transform:translateX(-50%);width:480px;background:#fff;border-radius:var(--radius-lg);box-shadow:0 4px 24px rgba(0,0,0,0.15);z-index:200;border:1px solid var(--color-border);">
<div style="padding:var(--space-4);border-bottom:1px solid var(--color-border);font-weight:600;display:flex;justify-content:space-between;align-items:center;">
<span style="color:#0d6efd;"><span class="icon icon-sm" style="vertical-align:middle;"><svg viewBox="0 0 24 24" fill="none" stroke="#0d6efd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg></span> Frage die KI</span>
<button onclick="document.getElementById('kiDialog').style.display='none'" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--color-text-muted);">×</button>
</div>
<div style="padding:var(--space-4);">
<div style="font-size:12px;color:var(--color-text-muted);margin-bottom:var(--space-3);" id="kiDialogContext"></div>
<div style="font-weight:600;font-size:12px;margin-bottom:var(--space-2);">Häufige Fragen:</div>
<div id="kiQuestionList" style="display:flex;flex-direction:column;gap:var(--space-2);margin-bottom:var(--space-3);">
<button class="btn btn-sm btn-secondary" style="text-align:left;font-size:12px;justify-content:flex-start;" onclick="askKi('Woher kommen die Schnittwerte?')">Woher kommen die Schnittwerte?</button>
<button class="btn btn-sm btn-secondary" style="text-align:left;font-size:12px;justify-content:flex-start;" onclick="askKi('Warum dieser Stundensatz?')">Warum dieser Stundensatz?</button>
<button class="btn btn-sm btn-secondary" style="text-align:left;font-size:12px;justify-content:flex-start;" onclick="askKi('Wie wurde die Rüstzeit berechnet?')">Wie wurde die Rüstzeit berechnet?</button>
</div>
<div style="font-size:12px;font-weight:600;margin-bottom:var(--space-2);">Oder eigene Frage:</div>
<textarea class="input" id="kiCustomQ" rows="2" placeholder="z.B. Wie genau ist die Kalkulation?" style="font-size:12px;margin-bottom:var(--space-3);"></textarea>
<button class="btn btn-primary btn-sm" onclick="submitKiQuestion()" style="width:100%;">Frage stellen</button>
<div id="kiAnswer" style="display:none;margin-top:var(--space-4);padding:var(--space-3);background:var(--color-info-light);border-radius:var(--radius);font-size:12px;line-height:1.6;"></div>
</div>
</div>
<!-- FAB removed — replaced by sticky Action Bar -->

<!-- Feedback Flyout -->
<div class="feedback-panel" id="feedbackPanel">
<div class="feedback-panel-header">
<span style="font-weight:600;">Feedback</span>
<button onclick="toggleFeedbackPanel()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--color-text-muted);padding:0;line-height:1;">&times;</button>
</div>
<div class="feedback-panel-body">
<div style="font-size:12px;color:var(--color-text-muted);margin-bottom:8px;">Seite: <span id="fbCurrentPage" style="font-weight:500;color:var(--color-text);">Teil</span></div>
<div style="display:flex;gap:6px;margin-bottom:10px;">
<button class="fb-type-btn" data-type="bug" onclick="selectFbType(this)">Fehler</button>
<button class="fb-type-btn" data-type="idea" onclick="selectFbType(this)">Verbesserung</button>
<button class="fb-type-btn" data-type="question" onclick="selectFbType(this)">Frage</button>
</div>
<textarea id="fbQuickText" class="input" rows="3" placeholder="Was ist aufgefallen?" style="font-size:13px;resize:vertical;"></textarea>
<button class="btn btn-primary btn-sm" onclick="sendQuickFeedback()" style="width:100%;margin-top:8px;">Absenden</button>
</div>
<div class="feedback-panel-success" id="fbSuccess" style="display:none;">
<div style="font-size:24px;margin-bottom:4px;">&#10003;</div>
<div style="font-size:13px;font-weight:500;">Danke für das Feedback</div>
<div style="font-size:12px;color:var(--color-text-muted);">Wird in der Nachkalkulation gespeichert.</div>
</div>
</div>
</div>
 
<!-- ================================================================
 JAVASCRIPT
 ================================================================ -->
<script>
 // ================================================================
 // DATA
 // ================================================================
 
 // ================================================================
 // DB — SINGLE SOURCE OF TRUTH (v20)
 // ================================================================
 // Alle Stammdaten zentral. Änderungen hier propagieren automatisch.
 
 const DB = {
 // Materialpreise (Single Source)
 materials: {
 // Edelstahl (Einkaufspreise Halbzeug, nicht Stahlhandel-Liste)
 '1.4301': { name: '1.4301 (V2A)', price: 4.80, density: 7.90, timeFactor: 1.25 },
 '1.4404': { name: '1.4404 (V4A)', price: 5.50, density: 7.95, timeFactor: 1.30 },
 '1.4571': { name: '1.4571', price: 5.20, density: 8.00, timeFactor: 1.35 },
 // Baustahl
 'S235JR': { name: 'S235JR', price: 1.40, density: 7.85, timeFactor: 1.00 },
 'S355J2': { name: 'S355J2', price: 3.00, density: 7.85, timeFactor: 1.02 },
 'C45': { name: 'C45', price: 1.80, density: 7.85, timeFactor: 1.05 },
 // Vergütungsstahl
 '42CrMo4': { name: '42CrMo4', price: 2.20, density: 7.85, timeFactor: 1.15 },
 '34CrNiMo6': { name: '34CrNiMo6', price: 3.00, density: 7.85, timeFactor: 1.20 },
 // Aluminium
 'AlMg3': { name: 'AlMg3', price: 4.50, density: 2.66, timeFactor: 0.65 },
 'AlMgSi1': { name: 'AlMgSi1', price: 4.80, density: 2.70, timeFactor: 0.68 },
 'Al7075': { name: 'Al7075-T6', price: 8.50, density: 2.81, timeFactor: 0.75 },
 // Buntmetalle
 'CuZn39Pb3': { name: 'Messing', price: 7.00, density: 8.47, timeFactor: 0.70 },
 'CuSn8': { name: 'Bronze', price: 12.00, density: 8.80, timeFactor: 0.75 },
 // Kunststoff
 'POM': { name: 'POM', price: 3.50, density: 1.41, timeFactor: 0.45 },
 'PA6': { name: 'PA6 (Nylon)', price: 4.00, density: 1.14, timeFactor: 0.50 },
 'PEEK': { name: 'PEEK', price: 75.00, density: 1.32, timeFactor: 0.55 },
 // Guss
 'GJS-700': { name: 'GJS-700-2 (Sphäroguss)', price: 3.80, density: 7.10, timeFactor: 1.18 },
 'GJS-400': { name: 'GJS-400-15 (Sphäroguss)', price: 3.20, density: 7.10, timeFactor: 1.05 },
 'GJL-250': { name: 'GJL-250 (Grauguss)', price: 2.50, density: 7.20, timeFactor: 0.90 }
 },
 
 // Stundensätze (Single Source)
 rates: {
 cnc: { labor: 38, machine: 32 },
 saegen: { labor: 35, machine: 10 },
 entgraten: { labor: 28, machine: 3 },
 drehen: { labor: 45, machine: 38 },
 axis5: { labor: 52, machine: 68 },
 pruef: { labor: 45, machine: 15 }
 },
 
 // Zuschläge (Single Source)
 zuschlaege: {
 verschnitt: 10, // % auf Materialgewicht
 mgk: 5, // % auf Materialkosten (Materialgemeinkosten)
 fgk: 0, // % auf Fertigungskosten (oft schon im MSS)
 av: 12, // % auf Fertigungskosten (Arbeitsvorbereitung)
 vwgk: 10, // % auf Herstellkosten (Verwaltung)
 vtgk: 5, // % auf Herstellkosten (Vertrieb)
 gewinn: 8, // % auf Selbstkosten
 vat: 19 // % Mehrwertsteuer
 },
 
 // Spannmittel (Single Source)
 clamping: {
 'schraubstock': { time: 15, desc: 'Teil in Maschinenschraubstock spannen, Parallelität prüfen, Nullpunkt antasten.' },
 'schraubstock2': { time: 25, desc: 'Zwei Schraubstöcke für Langteile. Beide auf gleiche Höhe ausrichten.' },
 'tischspannung': { time: 35, desc: 'Tischspannung mit Pratzen. Für große oder unregelmäßige Werkstücke.' },
 'nullpunkt': { time: 5, desc: 'Nullpunktspannsystem. Schnellstes Wechseln, höchste Wiederholgenauigkeit.' },
 'spezial': { time: 45, desc: 'Sondervorrichtung. Aufwändiger Aufbau, für Serienteile rentabel.' }
 },
 
 // Werkzeug-Stammdaten (NEU in v20)
 tools: {
 'WSP-R390-25': { name: 'Sandvik R390-025', type: 'Planfräser', diameter: 63, teeth: 4, material: 'HM', standzeit: 180, price: 245.00 },
 'WSP-CNMG-12': { name: 'CNMG 120408', type: 'Wendeschneidplatte', standzeit: 45, price: 8.50 },
 'VHM-D20': { name: 'VHM Schaftfräser Ø20', type: 'Schaftfräser', diameter: 20, teeth: 3, material: 'VHM', standzeit: 120, price: 89.00 },
 'VHM-D16': { name: 'VHM Schaftfräser Ø16', type: 'Schaftfräser', diameter: 16, teeth: 3, material: 'VHM', standzeit: 120, price: 75.00 },
 'VHM-D10': { name: 'VHM Schaftfräser Ø10', type: 'Schaftfräser', diameter: 10, teeth: 3, material: 'VHM', standzeit: 90, price: 52.00 },
 'BOHRER-D12': { name: 'VHM Spiralbohrer Ø12', type: 'Bohrer', diameter: 12, material: 'VHM', standzeit: 60, price: 38.00 },
 'BOHRER-D6.8': { name: 'VHM Spiralbohrer Ø6.8', type: 'Bohrer', diameter: 6.8, material: 'VHM', standzeit: 45, price: 28.00 },
 'FEINBOHRER-26': { name: 'Feinbohrkopf Ø26 H7', type: 'Feinbohrer', diameter: 26, standzeit: 30, price: 320.00 },
 'FEINBOHRER-44': { name: 'Feinbohrkopf Ø44 H7', type: 'Feinbohrer', diameter: 44, standzeit: 25, price: 480.00 },
 'GEWINDEFRAES-M8': { name: 'Gewindefräser M8', type: 'Gewindefräser', standzeit: 80, price: 95.00 }
 },
 
 // Sondervereinbarungen (NEU in v20)
 sondervereinbarungen: {
 mek: 0, // Materialeinzelkosten (separat)
 transport: 0, // Transportkosten
 beistellung: false, // Material beigestellt?
 sonstiges: '' // Freitext
 }
 };
 
 // Backward compatibility — alte Konstanten zeigen auf DB
 const MATERIALS = DB.materials;
 const CLAMPING = DB.clamping;
 
 const PROJECTS = {
 verbindungsplatte: {
 id: 'verbindungsplatte',
 name: 'Verbindungsplatte',
 partNumber: '2500473.01.11.02.00.001',
 material: 'S235JR',
 dims: { x: 440, y: 50, z: 20 },
 baseTime: 12.5,
 unitPrice: 28.40,
 thumbnail: 'demo-parts/2500473.01.11.02.00.001.pdf.png'
 },
 adapterplatte: {
 id: 'adapterplatte',
 name: 'Adapterplatte',
 partNumber: '2500473.01.01.02.01.001',
 material: 'AlMg3',
 dims: { x: 85, y: 70, z: 55 },
 baseTime: 24.8,
 unitPrice: 52.15,
 thumbnail: 'demo-parts/2500473.01.01.02.01.001.pdf.png'
 },
 block: {
 id: 'block',
 name: 'Block',
 partNumber: '2500473.01.01.01.01.001',
 material: 'AlMg3',
 dims: { x: 120, y: 105, z: 40 },
 baseTime: 35.2,
 unitPrice: 89.50,
 thumbnail: 'demo-parts/2500473.01.01.01.01.001.pdf.png'
 },
 lagerungstraverse: {
 id: 'lagerungstraverse',
 name: 'Lagerungstraverse',
 partNumber: '10028104.79',
 material: 'GJS-700',
 materialCostFixed: 1200,
 dims: { x: 2095, y: 500, z: 190 },
 baseTime: 475,
 unitPrice: 19730,
 quantity: 4,
 thumbnail: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 120"%3E%3Crect fill="%23f3f4f6" width="240" height="120"/%3E%3Crect x="20" y="35" width="200" height="50" fill="%23e5e7eb" stroke="%2364748b" stroke-width="2"/%3E%3Ctext x="120" y="50" text-anchor="middle" font-family="monospace" font-size="10" fill="%23374151"%3E2095mm%3C/text%3E%3Ctext x="120" y="65" text-anchor="middle" font-family="monospace" font-size="10" fill="%23374151"%3E×500mm%3C/text%3E%3Ctext x="120" y="80" text-anchor="middle" font-family="monospace" font-size="10" fill="%23374151"%3E×190mm%3C/text%3E%3C/svg%3E',
 source: 'Anfrage 6000063225 — KBA Koenig & Bauer',
 clampings: [
 { type: 'tischspannung', time: 50, desc: 'Unterseite — Pratzen auf Maschinentisch, WZ einwechseln, Nullpunkt' },
 { type: 'tischspannung', time: 38, desc: 'Oberseite — Wenden, Planfräsen, Taschen, Langlöcher' },
 { type: 'tischspannung', time: 39, desc: 'Stirnseite 1 — Kontrollmaß 1508±0.1' },
 { type: 'tischspannung', time: 37, desc: 'Stirnseite 2 — Kontrollmaß 1400±0.1, Gesamtlänge 2095' }
 ],
 operations: [
 { nr: 10, name: 'Sägen & Vorbereitung', tool: 'Bandsäge', time: 28, rate: 'saegen',
 detail: 'Gussteil GJS-700-2, Rohteil-Beistellung KBA, Materialkosten €1.200. Eingangsprüfung, Aufmaße kontrollieren, Schnittkanten grob entgraten. Rohgewicht ~1.415kg.' },
 { nr: 20, name: 'Planfräsen Unterseite', tool: 'T1 Ø80 Planfräser', time: 55, rate: 'cnc',
 params: 'n 600 · vf 750 · ap 2,0',
 detail: 'Referenzfläche 2095×500mm herstellen. ae=64mm (80% Ø80), 8 Bahnen, 2mm Zustellung. Schlichtzugabe 0,2mm.' },
 { nr: 30, name: 'Bohrungen Unterseite', tool: 'T2 Ø16 VHM + T3 Ø10 VHM', time: 44, rate: 'cnc',
 params: '8× Ø16 H7 + 4× Ø10 H7',
 detail: '8× Ø16 H7 (Befestigung, t=190mm): Zentrierung + Bohren + Senken = 4min/Bohrung. 4× Ø10 H7 (Messreferenz): 3min/Bohrung.' },
 { nr: 40, name: 'Planfräsen Oberseite', tool: 'T1 Ø80 Planfräser', time: 52, rate: 'cnc',
 params: 'n 600 · vf 750 · ap 2,0',
 detail: 'Parallelfläche zu Unterseite, Sollmaß 190mm ±0.05. Schlichtzugabe 0,2mm für Ra 3,2.' },
 { nr: 50, name: 'Taschen fräsen (4×)', tool: 'T4 Ø20 VHM', time: 46, rate: 'cnc',
 params: 'n 2400 · vf 960 · ap 4,0',
 detail: 'Tasche 1: 400×280mm t=50mm (18min). Tasche 2: 275×180mm t=35mm (12min). Taschen 3-4: 150×100mm t=25mm (2×8min).' },
 { nr: 60, name: 'Langlöcher (3×)', tool: 'T4 Ø20 VHM', time: 24, rate: 'cnc',
 params: '3× ca. 120×40mm durchgehend',
 detail: 'Pro Langloch: Vorbohren Ø16 + Ausfräsen Kontur = 8min. Durchgangsbearbeitung.' },
 { nr: 70, name: 'Konturfräsen Außen', tool: 'T5 Ø16 VHM', time: 28, rate: 'cnc',
 params: 'n 3000 · vf 600 · ap 4,0',
 detail: 'Gusshaut-Zugabe 2mm abtragen. Umfangslänge ~6m, 2 Zustellungen (Schrupp + Schlicht). vf=600mm/min für GJS-700.' },
 { nr: 80, name: 'Stirnseite 1 (Planfräsen + Bohrungen)', tool: 'T1 Ø80 + T6 Ø12 VHM', time: 40, rate: 'cnc',
 params: 'Kontrollmaß 1508 ±0.1',
 detail: 'Planfräsen 500×190mm auf Sollmaß 1508±0.1 von Referenz (22min). 6× Ø12 H8 t=80mm (18min).' },
 { nr: 90, name: 'Stirnseite 2 (Planfräsen + Bohrungen + Kontrollmaß)', tool: 'T1 Ø80 + T6 Ø12 VHM', time: 57, rate: 'cnc',
 params: 'Kontrollmaß 1400±0.1, 335±0.1, Gesamt 2095',
 detail: 'Planfräsen Gegenseite 500×190mm (24min). 6× Ø12 H8 (18min). Kontrollmaß 335±0.1 (15min).' },
 { nr: 100, name: 'Entgraten', tool: 'Manuell (Schleifer/Feile)', time: 68, rate: 'entgraten',
 detail: 'Außenkonturen ~6m (22min). Taschenkanten 4× ~2m (18min). Langlochkanten 3× (12min). Bohrungskanten 24× beidseitig (16min).' },
 { nr: 110, name: 'Qualitätsprüfung & Messprotokoll', tool: '3D-Messarm / KMG', time: 55, rate: 'cnc',
 params: '±0.1mm Kontrollmaße',
 detail: 'Messaufbau & Kalibrierung (8min). 4× kritische Maße mit 3D-Messarm (18min). 8× Bohrungen mit Lehre (12min). Oberfläche visuell (5min). Protokoll (12min).' }
 ]
 }
 };
 
 // Backward compatibility
 let RATES = DB.rates;
 
 let currentProject = null;
 
 // ================================================================
 // DEUTSCHE FORMATIERUNG LIBRARY
 // ================================================================
 
 const DEFormatter = {
     date(date) {
         return date.toLocaleDateString('de-DE', {
             day: '2-digit',
             month: '2-digit',
             year: 'numeric'
         });
     },
     
     price(amount) {
         const formatted = amount.toLocaleString('de-DE', {
             minimumFractionDigits: 2,
             maximumFractionDigits: 2
         });
         return `EUR ${formatted}`;
     },
     
     length(value, unit = 'mm') {
         return `${Math.round(value)} ${unit}`;
     },
     
     weight(value) {
         return `${value.toFixed(2).replace('.', ',')} kg`;
     },
     
     time(minutes) {
         if (minutes < 60) return `${minutes.toFixed(1).replace('.', ',')} min`;
         return `${(minutes/60).toFixed(1).replace('.', ',')} h`;
     },
     
     quantity(num, unit = 'Stck.') {
         return `${Math.round(num)} ${unit}`;
     }
 };
 
 // ================================================================
 // QUOTE / ANGEBOT FUNCTIONS
 // ================================================================
 
 function calculateValidity() {
     const gueltigkeit = parseInt(document.getElementById('angebotsGueltigkeit')?.value) || 28;
     const today = new Date();
     const validUntil = new Date(today);
     validUntil.setDate(today.getDate() + gueltigkeit);
     
     document.getElementById('quoteDate').textContent = DEFormatter.date(today);
     document.getElementById('quoteValidUntil').textContent = DEFormatter.date(validUntil);
     
     // Sync settings to quote conditions
     const zahlungsziel = document.getElementById('zahlungsziel')?.value || '14';
     const lieferzeit = document.getElementById('standardLieferzeit')?.value || '3-4 Wochen';
     const zielEl = document.getElementById('quoteZahlungsziel');
     const lieferEl = document.getElementById('quoteLieferzeit');
     if (zielEl) zielEl.textContent = zahlungsziel;
     if (lieferEl) lieferEl.textContent = lieferzeit;
 }
 
 function generatePositions(parts) {
     return parts.map((part, index) => ({
         ...part,
         position: index + 1  // 1, 2, 3... (klassisch)
     }));
 }
 
 function renderQuote(data) {
     if (!data || !data.parts) {
         console.warn('renderQuote: No data provided');
         return;
     }
     
     const parts = generatePositions(data.parts);
     
     let html = '';
     parts.forEach(part => {
         html += `
             <tr>
                 <td class="position-nr">${part.position}</td>
                 <td class="mono">${part.articleNumber || 'E-CNC-' + String(part.position).padStart(4, '0')}</td>
                 <td>
                     <div style="font-weight: var(--font-semibold);">${part.name}</div>
                     <div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1); font-family: var(--font-mono);">
                         ${part.drawingNumber || part.partNumber || ''}
                     </div>
                     ${part.material ? `<div style="font-size: var(--text-sm); color: var(--color-text-muted); margin-top: var(--space-1);">Werkstoff ${part.material}</div>` : ''}
                 </td>
                 <td class="right mono">${DEFormatter.quantity(part.quantity || 1)}</td>
                 <td class="right mono">${DEFormatter.price(part.price || 0)}</td>
                 <td class="right mono">${DEFormatter.price((part.price || 0) * (part.quantity || 1))}</td>
             </tr>
         `;
     });
     
     const tbody = document.querySelector('#section-quote .table tbody');
     if (tbody) {
         tbody.innerHTML = html;
     }
     
     // Summen berechnen
     const subtotal = parts.reduce((sum, p) => sum + (p.price || 0) * (p.quantity || 1), 0);
     const tax = subtotal * 0.19;
     const total = subtotal + tax;
     
     const subtotalEl = document.getElementById('quoteSubtotal');
     const taxEl = document.getElementById('quoteTax');
     const totalEl = document.getElementById('quoteTotal');
     
     if (subtotalEl) subtotalEl.textContent = DEFormatter.price(subtotal);
     if (taxEl) taxEl.textContent = DEFormatter.price(tax);
     if (totalEl) totalEl.textContent = DEFormatter.price(total);
     
     // Gültigkeit berechnen
     calculateValidity();
 }
 
 function syncSettingsToQuote() {
     const name = document.getElementById('firmaName')?.value || 'CNC Planer Pro';
     const strasse = document.getElementById('firmaStrasse')?.value || '';
     const ort = document.getElementById('firmaOrt')?.value || '';
     const tel = document.getElementById('firmaTel')?.value || '';
     const email = document.getElementById('firmaEmail')?.value || '';
     
     const senderEl = document.getElementById('quoteSenderLine');
     if (senderEl) senderEl.textContent = `${name} • ${strasse} • ${ort}`;
     
     const footerEl = document.getElementById('quoteFooterContact');
     if (footerEl) {
         footerEl.innerHTML = `
             <strong style="color: var(--color-text-muted);">${name}</strong><br>
             ${strasse}<br>
             ${ort}<br>
             <br>
             Telefon: ${tel}<br>
             E-Mail: ${email}`;
     }
     
     calculateValidity();
 }
 
 function copyQuote() {
 const quoteEl = document.querySelector('#section-quote .card-body');
 if (!quoteEl) return;
 
 // Copy as plain text
 const text = quoteEl.innerText;
 navigator.clipboard.writeText(text).then(() => {
 const btn = document.querySelector('#section-quote .btn-secondary');
 if (btn) {
 const orig = btn.textContent;
 btn.textContent = 'Kopiert';
 setTimeout(() => { btn.textContent = orig; }, 1500);
 }
 }).catch(() => {
 // Fallback: select + copy
 const range = document.createRange();
 range.selectNodeContents(quoteEl);
 const sel = window.getSelection();
 sel.removeAllRanges();
 sel.addRange(range);
 document.execCommand('copy');
 sel.removeAllRanges();
 });
 }
 
 // ================================================================
 // NAVIGATION
 // ================================================================
 
 const SECTION_TITLES = {
 'part': 'Werkstück',
 'checklist': 'Prüfprotokoll',
 'protocol': 'Eingabe- & Entscheidungsprotokoll',
 'params': 'Preise & Sätze',
 'result': 'Kalkulation',
 'calculation': 'Detailkalkulation',
 'tools': 'Werkzeuge',
 'quote': 'Angebot',
 'instructions': 'Fertigungsanweisung',
 'code': 'NC-Code',
 'feedback': 'Nachkalkulation',
 'settings': 'Einstellungen'
 };
 
 // confirmAndGoToParams removed — workflow now uses runCalculation()
 
 function showSection(name, btn) {
 try {
 // 1. Update nav
 document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
 if (btn) btn.classList.add('active');

 // 2. Hide ALL sections
 document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));

 // 3. Show target section
 const targetId = 'section-' + name;
 const target = document.getElementById(targetId);
 if (target) {
 target.classList.add('active');
 } else {
 console.error('Section not found:', targetId);
 return;
 }

 // 4. Update title
 document.getElementById('mainTitle').textContent = SECTION_TITLES[name] || name;

 // 5. Show main actions
 const actions = document.getElementById('mainActions');
 if (actions) actions.style.display = 'flex';

 // 6. Section-specific hooks
 if (name === 'result') {
 calculate();
 const calcSection = document.getElementById('section-calculation');
 if (calcSection) calcSection.classList.add('active');
 }
 if (name === 'instructions') calculate();
 if (name === 'checklist') generateChecklist();
 if (name === 'tools') renderToolsFromProject();
 if (name === 'protocol') updateMasterProtocol();
 if (name === 'feedback') showFeedbackTab('dashboard');

 // 7. Update action bar context
 try { updateActionBarContext(); } catch(e) {}

 } catch(err) {
 console.error('showSection error:', name, err);
 }
 }
 
 function showParamTab(tab) {
 // Hide all param tabs
 ['preis', 'material', 'zuschlag', 'maschine'].forEach(t => {
 const el = document.getElementById('param-' + t);
 if (el) el.style.display = 'none';
 });
 // Reset all tab buttons
 ['tabParamPreis', 'tabParamMaterial', 'tabParamZuschlag', 'tabParamMaschine'].forEach(id => {
 const el = document.getElementById(id);
 if (el) el.className = 'btn btn-sm btn-secondary';
 });
 // Show selected
 const panel = document.getElementById('param-' + tab);
 if (panel) panel.style.display = 'block';
 const btn = document.getElementById('tabParam' + tab.charAt(0).toUpperCase() + tab.slice(1));
 if (btn) btn.className = 'btn btn-sm btn-primary';
 }
 
 function toggleScope() {
 const content = document.getElementById('scopeContent');
 const chevron = document.getElementById('scopeChevron');
 content.classList.toggle('expanded');
 chevron.style.transform = content.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0)';
 }
 
 function toggleDrawing(contentId = 'drawingContent', chevronId = 'drawingChevron') {
 const content = document.getElementById(contentId);
 const chevron = document.getElementById(chevronId);
 if (content.style.display === 'none') {
 content.style.display = 'block';
 chevron.textContent = '▼';
 } else {
 content.style.display = 'none';
 chevron.textContent = '▶';
 }
 }
 
 function openDrawingFullscreen(imageId = 'drawingImage') {
 const img = document.getElementById(imageId);
 if (img && img.src) {
 window.open(img.src, '_blank');
 }
 }
 
 // ================================================================
 // FERTIGUNGSANWEISUNG: OP Management
 // ================================================================
 
 let customOpCounter = 110;
 
 function initOpControls() {
 // Add checkbox + disable toggle to each existing OP row
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const header = opDiv.querySelector('[onclick*="toggleOpDetail"]');
 if (!header) return;
 
 // Insert checkbox before op-badge
 const badge = header.querySelector('.op-badge');
 if (badge && !header.querySelector('input[type="checkbox"]')) {
 const cb = document.createElement('input');
 cb.type = 'checkbox';
 cb.checked = true;
 cb.style.cssText = 'margin-right:var(--space-2);cursor:pointer;';
 cb.onchange = function() {
 const row = this.closest('div[style*="border-bottom"]');
 if (row) {
 row.style.opacity = this.checked ? '1' : '0.35';
 const detail = row.querySelector('[id$="-detail"]');
 if (detail && !this.checked) detail.style.display = 'none';
 }
 updateOpSum();
 };
 header.insertBefore(cb, badge);
 }
 });
 }
 
 function updateOpSum() {
 let total = 0;
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const cb = opDiv.querySelector('input[type="checkbox"]');
 if (cb && !cb.checked) return;
 const timeSpan = opDiv.querySelector('.mono[style*="text-align: right"] strong, .mono[style*="text-align: right"]');
 if (timeSpan) {
 const t = parseFloat(timeSpan.textContent.replace(',','.').replace(' min','')) || 0;
 total += t;
 }
 });
 // Custom OPs
 document.querySelectorAll('#customOpsContainer .custom-op-row').forEach(row => {
 const cb = row.querySelector('input[type="checkbox"]');
 if (cb && !cb.checked) return;
 const timeInput = row.querySelector('.custom-op-time');
 total += parseFloat(timeInput?.value) || 0;
 });
 const el = document.getElementById('opSumTotal');
 if (el) el.textContent = total.toFixed(1).replace('.',',') + ' min';
 }
 
 function addCustomOP() {
 const container = document.getElementById('customOpsContainer');
 if (!container) return;
 const opNum = customOpCounter;
 customOpCounter += 10;

 const rateOptions = `
 <option value="cnc">CNC (${document.getElementById('rateCNC')?.value||70} €/h)</option>
 <option value="saegen">Sägen (${document.getElementById('rateSaegen')?.value||45} €/h)</option>
 <option value="entgraten">Entgraten (${document.getElementById('rateEntgraten')?.value||31} €/h)</option>
 <option value="montage">Montage (40 €/h)</option>
 <option value="extern">Extern (0 €/h — separat)</option>
 `;

 const div = document.createElement('div');
 div.className = 'custom-op-row card';
 div.style.marginBottom = 'var(--space-3)';
 div.dataset.opNr = opNum;
 div.innerHTML = `
 <div class="card-body" style="padding:var(--space-3) var(--space-4);">
 <div style="display:flex;align-items:center;gap:var(--space-3);flex-wrap:wrap;">
 <input type="checkbox" checked onchange="syncCustomOpsToProject()" style="cursor:pointer;">
 <span class="op-badge">${opNum}</span>
 <input type="text" class="input input-sm" data-field="name" placeholder="Beschreibung (z.B. Wärmebehandlung)" style="flex:1;min-width:150px;" onchange="syncCustomOpsToProject()">
 <input type="text" class="input input-sm" data-field="tool" placeholder="Werkzeug" style="width:100px;" onchange="syncCustomOpsToProject()">
 <select class="select input-sm" data-field="rate" style="width:130px;" onchange="syncCustomOpsToProject()">${rateOptions}</select>
 <input type="number" class="input input-sm input-mono custom-op-time" data-field="time" placeholder="min" style="width:70px;" step="0.1" onchange="syncCustomOpsToProject()">
 <button class="btn btn-sm" onclick="this.closest('.custom-op-row').remove();syncCustomOpsToProject();" style="padding:0 6px;color:var(--color-error);border:none;" title="Entfernen">×</button>
 </div>
 </div>`;
 container.appendChild(div);
 }

 // Sync custom OPs into currentProject.operations + recalculate
 function syncCustomOpsToProject() {
 if (!currentProject) return;

 // Rebuild operations: start with original (non-custom) ops
 const baseOps = (currentProject._baseOperations || currentProject.operations || []).filter(o => !o._custom);
 if (!currentProject._baseOperations) currentProject._baseOperations = [...baseOps];

 const customOps = [];
 document.querySelectorAll('#customOpsContainer .custom-op-row').forEach(row => {
 const cb = row.querySelector('input[type=checkbox]');
 if (!cb?.checked) return;
 const name = row.querySelector('[data-field=name]')?.value || 'Zusatz-AG';
 const tool = row.querySelector('[data-field=tool]')?.value || '—';
 const rate = row.querySelector('[data-field=rate]')?.value || 'cnc';
 const time = parseFloat(row.querySelector('[data-field=time]')?.value) || 0;
 if (time <= 0) return;
 const nr = parseInt(row.dataset.opNr) || 99;

 const rateMap = {
 cnc: parseFloat(document.getElementById('rateCNC')?.value) || 70,
 saegen: parseFloat(document.getElementById('rateSaegen')?.value) || 45,
 entgraten: parseFloat(document.getElementById('rateEntgraten')?.value) || 31,
 montage: 40,
 extern: 0
 };

 customOps.push({
 nr, name, tool, time, setup: 0, rate: rateMap[rate] || 70, _custom: true
 });
 });

 currentProject.operations = [...baseOps, ...customOps];
 updateOpSum();
 calculate();
 }
 
 function exportFertigungsCSV() {
 let csv = 'OP;Beschreibung;Werkzeug;Zeit [min];Status\\n';
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const cb = opDiv.querySelector('input[type="checkbox"]');
 const badge = opDiv.querySelector('.op-badge');
 const header = opDiv.querySelector('[onclick*="toggleOpDetail"]');
 if (!header || !badge) return;
 const strong = header.querySelector('strong');
 const desc = strong ? strong.textContent.trim() : '';
 const tool = header.querySelector('.mono')?.textContent.trim() || '';
 const timeEl = header.querySelectorAll('.mono');
 const time = timeEl.length >= 2 ? timeEl[timeEl.length-1].textContent.trim().replace(' min','') : '';
 const status = (cb && !cb.checked) ? 'Abgewählt' : 'Aktiv';
 csv += `${badge.textContent};${desc};${tool};${time};${status}\\n`;
 });
 // Custom OPs
 document.querySelectorAll('#customOpsContainer .custom-op-row').forEach(row => {
 const inputs = row.querySelectorAll('input');
 const cb = inputs[0];
 const badge = row.querySelector('.op-badge');
 csv += `${badge?.textContent || ''};${inputs[1]?.value || ''};${inputs[2]?.value || ''};${inputs[3]?.value || ''};${cb.checked ? 'Aktiv' : 'Abgewählt'}\\n`;
 });
 
 const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv;charset=utf-8;' });
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'fertigungsanweisung.csv';
 a.click();
 }
 
 // Print Fertigungsanweisung (full)
 function printFertigungsanweisung() {
 const proj = currentProject;
 if (!proj) { alert('Kein Bauteil ausgewählt.'); return; }
 const ops = proj.operations || [];
 const mat = MATERIALS[document.getElementById('materialSelect')?.value] || {};
 const totalMach = ops.reduce((s,o) => s+o.time, 0);
 const totalSetup = (proj.clampings || []).reduce((s,c) => s+c.time, 0);
 const firma = document.getElementById('firmaName')?.value || '';
 const bearbeiter = document.getElementById('firmaBearbeiter')?.value || '—';
 const w = window.open('', '_blank');
 w.document.write(`<!DOCTYPE html><html><head><title>Fertigungsanweisung — ${proj.name}</title>
 <style>
 @page { size: A4; margin: 15mm 18mm; }
 body { font-family: Helvetica Neue, Arial, sans-serif; font-size: 11px; color: #1a1a1a; line-height: 1.5; }
 h1 { font-size: 18px; border-bottom: 3px solid #c8aa50; padding-bottom: 6px; margin: 0 0 12px; }
 h2 { font-size: 13px; color: #c8aa50; margin: 16px 0 6px; border-bottom: 1px solid #e5e5e0; padding-bottom: 3px; }
 table { width: 100%; border-collapse: collapse; margin: 4px 0 12px; }
 th, td { padding: 3px 6px; border: 1px solid #e5e5e0; text-align: left; font-size: 10px; }
 th { background: #f5f5f5; font-size: 9px; text-transform: uppercase; }
 .right { text-align: right; } .mono { font-family: Consolas, monospace; }
 .meta { font-size: 10px; color: #666; margin-bottom: 12px; }
 .stamp { margin-top: 24px; display: flex; justify-content: space-between; }
 .stamp-box { width: 30%; border-top: 1px solid #333; padding-top: 4px; font-size: 9px; }
 .footer { margin-top: 16px; font-size: 9px; color: #999; border-top: 1px solid #e5e5e0; padding-top: 4px; }
 </style></head><body>
 <h1>FERTIGUNGSANWEISUNG</h1>
 <div class="meta">${firma} · Bearbeiter: ${bearbeiter} · ${new Date().toLocaleDateString('de-DE')} · INTERN</div>
 <table>
 <tr><td style="width:25%;font-weight:600;">Bauteil</td><td>${proj.name}</td><td style="width:25%;font-weight:600;">Zeichnungs-Nr.</td><td class="mono">${proj.partNumber}</td></tr>
 <tr><td style="font-weight:600;">Werkstoff</td><td>${mat.name || proj.material}</td><td style="font-weight:600;">Stückzahl</td><td class="mono">${document.getElementById('quantity')?.value || proj.quantity}</td></tr>
 <tr><td style="font-weight:600;">Abmessungen</td><td class="mono">${proj.dims.x} × ${proj.dims.y} × ${proj.dims.z} mm</td><td style="font-weight:600;">Anfrage</td><td>${proj.source || '—'}</td></tr>
 </table>
 ${proj.clampings ? `<h2>Aufspannungen</h2><table>
 <tr><th>#</th><th>Typ</th><th>Beschreibung</th><th class="right">Rüstzeit</th></tr>
 ${proj.clampings.map((c,i) => `<tr><td>${i+1}</td><td>${c.type}</td><td>${c.desc||'—'}</td><td class="right mono">${c.time} min</td></tr>`).join('')}
 <tr style="font-weight:600;background:#f5f5f5;"><td colspan="3">Σ Rüstzeit</td><td class="right mono">${totalSetup} min</td></tr>
 </table>` : ''}
 <h2>Operationsplan</h2><table>
 <tr><th>AG</th><th>Beschreibung</th><th>Werkzeug</th><th>Kostenstelle</th><th class="right">Zeit</th><th class="right">Kosten</th></tr>
 ${ops.map(op => { const rk=op.rate||'cnc'; const ro=RATES[rk]||RATES.cnc; const cost=(op.time/60)*(ro.labor+ro.machine);
 return `<tr${op._custom?' style="background:#fffde7;"':''}><td class="mono">${op.nr}</td><td>${op.name}${op._custom?' *':''}</td><td class="mono">${op.tool||'—'}</td><td>${rk==='saegen'?'Sägen':rk==='entgraten'?'Entgraten':'CNC'}</td><td class="right mono">${op.time} min</td><td class="right mono">EUR ${cost.toFixed(2)}</td></tr>`;
 }).join('')}
 <tr style="font-weight:600;background:#f5f5f5;"><td colspan="4">Σ Bearbeitungszeit</td><td class="right mono">${totalMach} min</td><td class="right mono">EUR ${ops.reduce((s,o)=>{const r=RATES[o.rate||'cnc']||RATES.cnc;return s+(o.time/60)*(r.labor+r.machine);},0).toFixed(2)}</td></tr>
 <tr style="font-weight:700;background:#e8f5e9;"><td colspan="4">Gesamtzeit (Bearbeitung + Rüsten)</td><td class="right mono">${totalMach+totalSetup} min</td><td class="right mono">${((totalMach+totalSetup)/60).toFixed(1)} h</td></tr>
 </table>
 ${faChanges.length>0?`<h2>Änderungen</h2><table><tr><th>Zeit</th><th>AG</th><th>Feld</th><th>Vorher → Nachher</th></tr>${faChanges.filter(c=>c.ag!=='—').map(c=>`<tr><td>${c.timestamp}</td><td>${c.ag}</td><td>${c.field}</td><td><span style="text-decoration:line-through;color:#999;">${c.oldVal}</span> → <strong>${c.newVal}</strong></td></tr>`).join('')}</table>`:''}
 <div class="stamp"><div class="stamp-box">Erstellt (AV)</div><div class="stamp-box">Geprüft (Meister)</div><div class="stamp-box">Freigabe</div></div>
 <div class="footer">CNC Planer Pro · ${new Date().toLocaleString('de-DE')} · INTERN</div>
 </body></html>`);
 w.document.close();
 setTimeout(() => w.print(), 300);
 }

 function printOperationsOnly() {
 const opsCard = document.querySelector('#section-instructions .card:has(.card-header span:contains("Operationen"))');
 if (!opsCard) {
 alert('Keine Operationen-Tabelle gefunden');
 return;
 }
 
 const printWindow = window.open('', '_blank');
 const partName = document.getElementById('faPartName')?.textContent || 'Bauteil';
 const material = document.getElementById('faMaterial')?.textContent || '';
 
 printWindow.document.write(`
 <!DOCTYPE html>
 <html><head>
 <meta charset="UTF-8">
 <title>Operationen - ${partName}</title>
 <style>
 body { font-family: Arial, sans-serif; margin: 20px; }
 h1 { font-size: 18px; margin-bottom: 5px; }
 .info { font-size: 13px; color: #666; margin-bottom: 20px; }
 .op-row { display: flex; padding: 10px; border-bottom: 1px solid #ddd; align-items: center; }
 .op-badge { width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;
 border: 1px solid #ddd; border-radius: 4px; font-weight: 600; margin-right: 12px; }
 .op-name { flex: 1; font-weight: 600; }
 .op-tool { color: #666; margin-right: 12px; font-family: monospace; }
 .op-time { font-weight: 600; font-family: monospace; }
 .op-params { font-size: 11px; color: #888; font-family: monospace; margin-top: 4px; }
 .op-detail { padding: 10px 20px; background: #f9f9f9; font-size: 12px; line-height: 1.5; }
 @media print { body { margin: 10mm; } }
 </style>
 </head><body>
 <h1>Operationen — ${partName}</h1>
 <div class="info">Werkstoff: ${material} | Fertigungsanweisung (Operationen-Übersicht)</div>
 `);
 
 document.querySelectorAll('#section-instructions .card-body > div[style*="border-bottom"]').forEach(opDiv => {
 const cb = opDiv.querySelector('input[type="checkbox"]');
 if (cb && !cb.checked) return; // Skip deselected ops
 
 const badge = opDiv.querySelector('.op-badge')?.textContent || '';
 const header = opDiv.querySelector('[onclick*="toggleOpDetail"]');
 if (!header) return;
 
 const strong = header.querySelector('strong');
 const desc = strong ? strong.textContent.trim() : '';
 const params = header.querySelector('.op-params')?.textContent.trim() || '';
 const monos = header.querySelectorAll('.mono');
 const tool = monos[0]?.textContent.trim() || '';
 const time = monos[1]?.textContent.trim() || '';
 
 const detailId = header.getAttribute('onclick').match(/toggleOpDetail\\('([^']+)'\\)/)?.[1];
 const detailDiv = detailId ? document.getElementById(detailId + '-detail') : null;
 const detailText = detailDiv ? detailDiv.textContent.trim().replace(/\\s+/g, ' ').substring(0, 200) : '';
 
 printWindow.document.write(`
 <div class="op-row">
 <span class="op-badge">${badge}</span>
 <div style="flex:1;">
 <div class="op-name">${desc}</div>
 ${params ? '<div class="op-params">' + params + '</div>' : ''}
 </div>
 <span class="op-tool">${tool}</span>
 <span class="op-time">${time}</span>
 </div>
 ${detailText ? '<div class="op-detail">' + detailText + '...</div>' : ''}
 `);
 });
 
 printWindow.document.write('</body></html>');
 printWindow.document.close();
 printWindow.focus();
 setTimeout(() => printWindow.print(), 250);
 }
 
 // Prüfmerkmale
 function togglePruefRow(cb) {
 const row = cb.closest('tr');
 if (row) row.style.opacity = cb.checked ? '1' : '0.35';
 }
 
 function removePruefRow(btn) {
 const row = btn.closest('tr');
 if (row && confirm('Prüfmerkmal entfernen?')) row.remove();
 }
 
 function addPruefRow() {
 const tbody = document.getElementById('pruefBody');
 if (!tbody) return;
 const tr = document.createElement('tr');
 tr.innerHTML = `
 <td><input type="checkbox" checked onchange="togglePruefRow(this)"></td>
 <td><input type="text" class="input input-sm" placeholder="Merkmal" style="width:120px;"></td>
 <td><input type="text" class="input input-sm input-mono" placeholder="Soll-Wert" style="width:140px;"></td>
 <td><input type="text" class="input input-sm" placeholder="Prüfmittel" style="width:130px;"></td>
 <td class="right"><input type="text" class="input input-sm input-mono" placeholder="min" style="width:60px;"></td>
 <td><button class="btn btn-sm" onclick="removePruefRow(this)" style="padding:0 4px;color:var(--color-text-muted);border:none;" title="Entfernen">×</button></td>`;
 tbody.appendChild(tr);
 }
 
 function exportPruefCSV() {
 let csv = 'Prüfmerkmal;Soll;Prüfmittel;Zeit [min];Status\\n';
 document.querySelectorAll('#pruefBody tr').forEach(tr => {
 const cb = tr.querySelector('input[type="checkbox"]');
 const cells = tr.querySelectorAll('td');
 if (cells.length < 5) return;
 const merkmal = cells[1].querySelector('input')?.value || cells[1].textContent.trim();
 const soll = cells[2].querySelector('input')?.value || cells[2].textContent.trim();
 const mittel = cells[3].querySelector('input')?.value || cells[3].textContent.trim();
 const zeit = cells[4].querySelector('input')?.value || cells[4].textContent.trim().replace(' min','');
 const status = (cb && !cb.checked) ? 'Abgewählt' : 'Aktiv';
 csv += `${merkmal};${soll};${mittel};${zeit};${status}\\n`;
 });
 const blob = new Blob([csv.replace(/\\\\n/g, '\\n')], { type: 'text/csv;charset=utf-8;' });
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'pruefplan.csv';
 a.click();
 }
 
 // toggleOpDetail defined later with chevron support
 
 // === STICKY FEEDBACK ===
 let fbSelectedType = '';
 
 function toggleFeedbackPanel() {
 const panel = document.getElementById('feedbackPanel');
 const success = document.getElementById('fbSuccess');
 panel.classList.toggle('open');
 if (panel.classList.contains('open')) {
 // Detect current page
 const active = document.querySelector('.section.active');
 const pageNames = {
 'section-part': 'Teil',
 'section-params': 'Preise & Sätze',
 'section-result': 'Kalkulation',
 'section-instructions': 'Fertigungsanweisung',
 'section-quote': 'Angebot',
 'section-code': 'NC-Code',
 'section-tools': 'Werkzeuge',
 'section-feedback': 'Nachkalkulation',
 'section-settings': 'Einstellungen'
 };
 document.getElementById('fbCurrentPage').textContent = pageNames[active?.id] || '—';
 success.style.display = 'none';
 document.querySelector('.feedback-panel-body').style.display = 'block';
 }
 }
 
 function selectFbType(btn) {
 document.querySelectorAll('.fb-type-btn').forEach(b => b.classList.remove('active'));
 btn.classList.add('active');
 fbSelectedType = btn.dataset.type;
 }
 
 function sendQuickFeedback() {
 const text = document.getElementById('fbQuickText').value.trim();
 if (!text) { document.getElementById('fbQuickText').focus(); return; }
 
 const entry = {
 ts: new Date().toISOString(),
 page: document.getElementById('fbCurrentPage').textContent,
 type: fbSelectedType || 'general',
 text: text
 };
 
 // Save to localStorage
 const stored = JSON.parse(localStorage.getItem('cncplanner_feedback') || '[]');
 stored.push(entry);
 localStorage.setItem('cncplanner_feedback', JSON.stringify(stored));
 
 // Show success
 document.querySelector('.feedback-panel-body').style.display = 'none';
 document.getElementById('fbSuccess').style.display = 'block';
 document.getElementById('fbQuickText').value = '';
 document.querySelectorAll('.fb-type-btn').forEach(b => b.classList.remove('active'));
 fbSelectedType = '';
 
 setTimeout(() => toggleFeedbackPanel(), 1500);
 }
 
 // ================================================================
 // AI ASSISTANT (Demo — simulated LLM responses)
 // ================================================================

 const AI_SCOPES = {
 'code': {
 label: 'NC-Code',
 allowed: ['Steuerungscode', 'Werkzeuge', 'Schnittparameter', 'Drehzahl', 'Vorschub', 'Zyklen', 'Format'],
 hint: 'Änderungen nur an Steuerungscode, Werkzeugen und Schnittparametern möglich.'
 },
 'result': {
 label: 'Kalkulation',
 allowed: ['Zuschläge', 'Marge', 'Stückzahl', 'Verschnitt'],
 hint: 'Änderungen an Zuschlägen, Marge und Kalkulationsparametern möglich.'
 },
 'instructions': {
 label: 'Fertigungsanweisung',
 allowed: ['Operationen', 'Reihenfolge', 'Zeiten', 'Werkzeuge', 'Schnittdaten'],
 hint: 'Änderungen an Operationen, Zeiten und Schnittdaten möglich.'
 },
 'part': {
 label: 'Werkstück',
 allowed: ['Material', 'Maße', 'Stückzahl', 'Spannung', 'Toleranz'],
 hint: 'Änderungen an Werkstückdaten, Material und Aufspannungen möglich.'
 }
 };

 let chatHistories = { code: [], result: [], instructions: [], part: [] };

 function sendAiMessage(scope) {
 const input = document.getElementById('aiChatInput');
 if (!input) return;
 const msg = input.value.trim();
 if (!msg) return;
 input.value = '';

 addChatMessage(scope, 'user', msg);

 // Check if request is in scope
 const scopeInfo = AI_SCOPES[scope];
 const outOfScope = isOutOfScope(msg, scope);

 if (outOfScope) {
 setTimeout(() => {
 addChatMessage(scope, 'system',
 `[!] Diese Änderung betrifft den Bereich "${outOfScope}" — bitte dort vornehmen. ` +
 `Hier können nur Werte im Bereich "${scopeInfo.label}" geändert werden.`
 );
 }, 300);
 return;
 }

 // Simulated AI response (demo)
 setTimeout(() => {
 const response = generateDemoResponse(msg, scope);
 addChatMessage(scope, 'ai', response);
 }, 500 + Math.random() * 1000);
 }

 function aiQuickAction(scope, msg) {
 const input = document.getElementById('aiChatInput');
 if (input) input.value = msg;
 sendAiMessage(scope);
 }

 function addChatMessage(scope, role, text) {
 const container = document.getElementById('aiChatHistory');
 if (!container) return;

 const colors = {
 user: 'background: var(--color-primary); color: white; margin-left: 40px;',
 ai: 'background: var(--color-bg-subtle); border: 1px solid var(--color-border); margin-right: 40px;',
 system: 'background: var(--color-warning-light); border: 1px solid var(--color-warning); color: var(--color-warning); margin-right: 20px;'
 };
 const labels = { user: '', ai: '[KI] ', system: '[!] ' };

 const div = document.createElement('div');
 div.style.cssText = `padding: 8px 10px; border-radius: 8px; font-size: 12px; line-height: 1.5; ${colors[role]}`;
 div.innerHTML = `${labels[role]}${text}`;
 container.appendChild(div);
 container.scrollTop = container.scrollHeight;

 chatHistories[scope] = chatHistories[scope] || [];
 chatHistories[scope].push({ role, text, time: Date.now() });
 }

 function isOutOfScope(msg, currentScope) {
 const lower = msg.toLowerCase();
 const crossRefs = {
 'code': { triggers: ['material ändern', 'werkstoff', 'stückzahl', 'marge', 'zuschlag', 'preis ändern'], target: 'Werkstück / Kalkulation' },
 'result': { triggers: ['nc-code', 'heidenhain', 'drehzahl', 'vorschub', 'g-code', 'operation hinzufügen'], target: 'NC-Code / Fertigungsanweisung' },
 'instructions': { triggers: ['marge', 'zuschlag', 'material ändern', 'preis', 'stückzahl ändern'], target: 'Werkstück / Kalkulation' },
 'part': { triggers: ['nc-code', 'heidenhain', 'g-code', 'marge ändern', 'zuschlag ändern'], target: 'NC-Code / Kalkulation' }
 };

 const check = crossRefs[currentScope];
 if (!check) return null;
 for (const trigger of check.triggers) {
 if (lower.includes(trigger)) return check.target;
 }
 return null;
 }

 function generateDemoResponse(msg, scope) {
 const lower = msg.toLowerCase();
 const partName = currentProject?.name || 'Bauteil';

 // NC-Code scope
 if (scope === 'code') {
 if (lower.includes('vollständig') || lower.includes('generier')) {
 return `NC-Code für "${partName}" wird generiert...<br><br>` +
 `<strong>In Produktion:</strong> LLM generiert vollständigen Heidenhain-Code basierend auf den ${currentProject?.operations?.length || '?'} Arbeitsgängen.<br><br>` +
 `<em>Demo-Modus: Der Code links zeigt einen Auszug. In der Vollversion wird der komplette Code mit allen OPs, Werkzeugwechseln und Zyklen erzeugt.</em>`;
 }
 if (lower.includes('drehzahl') || lower.includes('speed')) {
 return `Drehzahl-Anpassung erkannt.<br><br>` +
 `Aktuelle Empfehlung für S355:<br>` +
 `• Planfräser Ø80: n=600 U/min (v<sub>c</sub>=150 m/min)<br>` +
 `• VHM Ø20: n=2400 U/min (v<sub>c</sub>=150 m/min)<br>` +
 `• VHM Ø16: n=3000 U/min (v<sub>c</sub>=150 m/min)<br><br>` +
 `Soll ich die Werte im Code aktualisieren?`;
 }
 if (lower.includes('sicherheit')) {
 return `Sicherheitsabfragen hinzugefügt:<br>` +
 `• <code>CYCL DEF 32.0 TOLERANZ</code> vor jedem Bearbeitungsschritt<br>` +
 `• Werkzeuglängenprüfung nach jedem Wechsel<br>` +
 `• Spindelstrom-Überwachung für Werkzeugbruch<br>` +
 `• M0 (optionaler Halt) vor erster Zustellung`;
 }
 if (lower.includes('siemens') || lower.includes('konvertier')) {
 return `Konvertierung Heidenhain → Siemens 840D:<br><br>` +
 `• <code>CYCL DEF 230</code> → <code>CYCLE71</code><br>` +
 `• <code>TOOL CALL</code> → <code>T="..." M6</code><br>` +
 `• <code>L X... Y... FMAX</code> → <code>G0 X... Y...</code><br>` +
 `• <code>CYCL CALL</code> → <code>MCALL</code><br><br>` +
 `<em>In Produktion: Vollständige Konvertierung mit Syntax-Validierung.</em>`;
 }
 if (lower.includes('schnittdaten') || lower.includes('optimier')) {
 return `Schnittdaten-Optimierung für ${currentProject?.material || 'S355'}:<br><br>` +
 `<strong>Empfehlung (konservativ):</strong><br>` +
 `• Planfräsen: v<sub>c</sub>=150, f<sub>z</sub>=0.15, a<sub>p</sub>=2.0<br>` +
 `• Konturfräsen: v<sub>c</sub>=140, f<sub>z</sub>=0.08, a<sub>p</sub>=4.0<br>` +
 `• Bohren: v<sub>c</sub>=80, f=0.15 mm/U<br><br>` +
 `Quelle: Sandvik CoroPlus, Walter GPS — angepasst an Maschinensteifigkeit C 400.`;
 }
 return `Verstanden. Ich passe den NC-Code entsprechend an.<br><br><em>Demo-Modus: In der Vollversion wird der Code links live aktualisiert.</em>`;
 }

 return `Eingabe erkannt: "${msg}"<br><br><em>Demo-Modus: In der Vollversion werden die Werte auf dieser Seite direkt angepasst.</em>`;
 }

 function toggleCostDetail(id) {
 const detail = document.getElementById('costDetail-' + id);
 if (detail) {
 detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
 }
 }
 
 // === CLAMPING LIST (editable) ===
 function addClamping() {
 const tbody = document.getElementById('clampingRows');
 const count = tbody.rows.length + 1;
 const tr = document.createElement('tr');
 tr.innerHTML = `
 <td class="mono">${count}</td>
 <td>
 <select class="select" onchange="updateClampingTotal()">
 <option value="schraubstock">Schraubstock</option>
 <option value="schraubstock2">2× Schraubstock (Langteil)</option>
 <option value="tischspannung">Tischspannung / Pratzen</option>
 <option value="nullpunkt">Nullpunktspannsystem</option>
 <option value="spezial">Sondervorrichtung</option>
 </select>
 </td>
 <td class="right"><input type="number" class="input input-sm input-mono" value="10" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
 <td style="min-width:220px;">
 <div style="font-size:11px;color:var(--color-text-hint);padding:4px 8px;">Manuelle Eingabe</div>
 </td>
 <td style="text-align:center;"><button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">×</button></td>
 `;
 tbody.appendChild(tr);
 updateClampingTotal();
 }
 
 function removeClamping(btn) {
 const tbody = document.getElementById('clampingRows');
 if (tbody.rows.length <= 1) return; // keep at least 1
 btn.closest('tr').remove();
 // Renumber
 Array.from(tbody.rows).forEach((r, i) => { r.cells[0].textContent = i + 1; });
 updateClampingTotal();
 }
 
 function updateClampingTotal() {
 const tbody = document.getElementById('clampingRows');
 let total = 0;
 Array.from(tbody.rows).forEach(r => {
 const input = r.querySelector('input[type="number"]');
 if (input) total += parseFloat(input.value) || 0;
 });
 document.getElementById('totalSetupTimeDisplay').textContent = total + ' min';
 // Update hidden legacy fields
 { const _e = document.getElementById('setupTimeDisplay'); if(_e) _e.textContent = total + ' min'; }
 { const _e = document.getElementById('setupCount'); if(_e) _e.value = tbody.rows.length; }
 }
 
 function getClampingTotalTime() {
 const tbody = document.getElementById('clampingRows');
 if (!tbody) return 25;
 let total = 0;
 Array.from(tbody.rows).forEach(r => {
 const input = r.querySelector('input[type="number"]');
 if (input) total += parseFloat(input.value) || 0;
 });
 return total;
 }
 
 // ================================================================
 // PART SELECTION
 // ================================================================
 
 function renderPartGrid() {
 const grid = document.getElementById('partGrid');
 grid.innerHTML = Object.values(PROJECTS).map(p =>`
<div class="part-card ${currentProject?.id === p.id ? 'selected' : ''}" onclick="selectProject('${p.id}')">
<div class="part-thumb">
<img src="${p.thumbnail}" alt="${p.name}" onerror="this.parentElement.innerHTML='<span style=\\'color:var(--color-text-muted);font-size:11px;\\'>Keine Vorschau</span>'">
</div>
<div class="part-info">
<div class="part-name">${p.name}</div>
<div class="part-number">${p.partNumber}</div>
<div class="part-meta">
<span>${p.baseTime} min</span>
<span>${p.material}</span>
<span class="part-price">${DEFormatter.price(p.unitPrice)}</span>
</div>
</div>
</div>
 `).join('');
 }
 
 function selectProject(id) {
 try {
 console.log('selectProject:', id, PROJECTS[id]?.name);
 currentProject = PROJECTS[id];
 
 // Fill form fields — NO auto-calculate, NO loading animation
 document.getElementById('materialSelect').value = currentProject.material;
 document.getElementById('dimX').value = currentProject.dims.x;
 document.getElementById('dimY').value = currentProject.dims.y;
 document.getElementById('dimZ').value = currentProject.dims.z;
 if (currentProject.quantity) {
 document.getElementById('quantity').value = currentProject.quantity;
 }
 
 // Load custom clampings if defined
 if (currentProject.clampings) {
 const tbody = document.getElementById('clampingRows');
 tbody.innerHTML = '';
 currentProject.clampings.forEach((c, i) => {
 const row = tbody.insertRow();
 const explanation = getClampingExplanation(c.type, c.time, currentProject, i);
 row.innerHTML = `
 <td class="mono">${i + 1}</td>
 <td>
 <select class="select" onchange="updateClampingTotal()">
 <option value="schraubstock" ${c.type === 'schraubstock' ? 'selected' : ''}>Schraubstock</option>
 <option value="schraubstock2" ${c.type === 'schraubstock2' ? 'selected' : ''}>2× Schraubstock (Langteil)</option>
 <option value="tischspannung" ${c.type === 'tischspannung' ? 'selected' : ''}>Tischspannung / Pratzen</option>
 <option value="nullpunkt" ${c.type === 'nullpunkt' ? 'selected' : ''}>Nullpunktspannsystem</option>
 <option value="spezial" ${c.type === 'spezial' ? 'selected' : ''}>Sondervorrichtung</option>
 </select>
 <div style="font-size:11px;color:var(--color-text-muted);margin-top:2px;">${c.desc || ''}</div>
 </td>
 <td class="right"><input type="number" class="input input-sm input-mono" value="${c.time}" style="width:70px;text-align:right;" onchange="updateClampingTotal()"> min</td>
 <td style="min-width:220px;">
 <div style="font-size:11px;color:var(--color-text-secondary);line-height:1.5;padding:4px 8px;background:var(--color-bg-subtle);border-radius:var(--radius-sm);border-left:2px solid var(--color-info);">
 ${explanation}
 </div>
 </td>
 <td style="text-align:center;">${i > 0 ? '<button class="btn btn-sm" onclick="removeClamping(this)" style="padding:0 4px;color:var(--color-error);border:none;">×</button>' : ''}</td>
 `;
 });
 updateClampingTotal();
 }
 
 // Load operations into Fertigungsanweisung if defined
 if (currentProject.operations) {
 renderOperations(currentProject.operations);
 }
 
 renderPartGrid();

 // Snapshot baselines for change tracking
 ['dimX','dimY','dimZ','quantity','materialSelect'].forEach(id => {
 const el = document.getElementById(id);
 if (el) inputBaselines[id] = el.value;
 });

 // Update drawing preview
 const drawingImg = document.getElementById('drawingImage');
 const drawingPN = document.getElementById('drawingPartNumber');
 if (drawingImg && currentProject.thumbnail) {
 drawingImg.src = currentProject.thumbnail;
 drawingImg.alt = currentProject.name;
 }
 if (drawingPN) drawingPN.textContent = currentProject.partNumber || '';
 
 // Generate checklist for this project
 checklistAnswers = {};
 checklistCompleted = false;
 checklistDismissed = {};
 generateChecklist();
 
 // Scroll to config section below
 const configCard = document.getElementById('werkstuckConfig');
 if (configCard) configCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
 } catch(e) { console.error('selectProject ERROR:', e); alert('Fehler bei Bauteilwahl: ' + e.message); }
 }
 
 // ================================================================
 // PRÜFPROTOKOLL — Intelligenter Fragebogen
 // ================================================================

 const CHECKLIST_QUESTIONS = [
 // =================================================================
 // v20: NUR 5 FRAGEN (Reduziert von 8)
 // Entfernt: Materialpreis, Oberflächengüte (korreliert mit Toleranz), Prüfanforderungen
 // =================================================================
 
 // PFLICHT-FRAGEN (3)
 {
 id: 'cl_werkstoff',
 priority: 'critical',
 label: 'Werkstoff bestätigen',
 aiDefault: (proj) => proj?.material || 'S355J2',
 question: 'Welcher Werkstoff wird tatsächlich gefertigt?',
 reason: 'Werkstoff bestimmt Schnittdaten, Bearbeitungszeit und Materialkosten. Falsche Angabe = ±300% Preisunterschied.',
 type: 'select',
 options: [], // filled dynamically from DB.materials
 condition: (proj) => true,
 effect: (val) => `Werkstoff → ${val}, Schnittdaten und Preise angepasst`,
 intel: (val, proj) => {
 const m = DB.materials[val];
 if (!m) return '';
 const weight = proj ? (proj.dims.x * proj.dims.y * proj.dims.z / 1000 * m.density) / 1000 : 0;
 const matCost = weight * m.price;
 if (val === 'GJS-700') return `GJS-700 ist ~3× teurer als S355, aber Bearbeitungszeit steigt nur um ~20% (Guss = besser zerspanbar). Bei ${weight.toFixed(0)} kg Gewicht: Materialkosten ca. EUR ${matCost.toFixed(0)}. <strong>Wenn beides möglich: S355 ist wirtschaftlicher, GJS-700 hat bessere Dämpfungseigenschaften.</strong>`;
 if (val === 'S355J2') return `S355 = Standard-Baustahl, gute Zerspanbarkeit. Bei ${weight.toFixed(0)} kg: Materialkosten ca. EUR ${matCost.toFixed(0)}. Wirtschaftlichste Wahl für Konstruktionsteile.`;
 if (m.timeFactor > 1.3) return `Schwerzerspanbarer Werkstoff (Zeitfaktor ${m.timeFactor}×). Werkzeugverschleiß deutlich höher — Werkzeugkosten separat kalkulieren.`;
 return `Zeitfaktor ${m.timeFactor}×. Standardwerkzeuge ausreichend.`;
 }
 },
 {
 id: 'cl_rohteil',
 priority: 'critical',
 label: 'Rohteil-Herkunft',
 aiDefault: 'eigenbeschaffung',
 question: 'Wird das Rohteil beigestellt oder selbst beschafft?',
 reason: 'Bei Beistellung entfallen Materialkosten komplett — oft 20-40% des Angebotspreises.',
 type: 'select',
 options: [
 { value: '', label: '— Bitte wählen —' },
 { value: 'eigenbeschaffung', label: 'Eigenbeschaffung (wir kaufen Material)' },
 { value: 'beistellung', label: 'Beistellung durch Auftraggeber' },
 { value: 'unklar', label: 'Noch unklar — Rückfrage nötig' }
 ],
 condition: (proj) => true,
 effect: (val) => val === 'beistellung' ? 'Material = €0 (Beistellung)' : val === 'eigenbeschaffung' ? 'Materialeinkauf + MGK wird kalkuliert' : 'Klärung nötig',
 intel: (val, proj) => {
 const m = proj?.material ? DB.materials[proj.material] : null;
 const weight = proj && m ? (proj.dims.x * proj.dims.y * proj.dims.z / 1000 * m.density) / 1000 : 0;
 const matCost = weight * (m?.price || 3) * 1.1;
 if (val === 'beistellung') return `Materialkosten (EUR ${matCost.toFixed(0)}) entfallen komplett → Angebotspreis sinkt um ca. ${weight > 100 ? '20-40%' : '10-20%'}. <strong>Aber:</strong> Risiko bei Beistellung — Rohteil-Qualität nicht in Ihrer Hand. Reklamationen schwieriger.`;
 if (val === 'eigenbeschaffung') return `Sie tragen Materialeinkauf (ca. EUR ${matCost.toFixed(0)} inkl. Verschnitt). <strong>Vorteil:</strong> Qualitätskontrolle liegt bei Ihnen, Zertifikate direkt verfügbar. Bei S355: Lieferzeit aktuell 2-4 Wochen für Dickblech.`;
 if (val === 'unklar') return `<strong>Dringend klären vor Angebotsabgabe!</strong> Unterschied Beistellung vs. Eigenbeschaffung = EUR ${matCost.toFixed(0)}. Empfehlung: Angebot mit beiden Optionen stellen (Material separat ausweisen).`;
 return '';
 }
 },
 {
 id: 'cl_brennschnitt',
 priority: 'critical',
 label: 'Brennschnitt / Rohkontur',
 aiDefault: 'brennschnitt_3mm',
 question: 'Wie wird das Rohteil angeliefert?',
 reason: 'Brennschnitt-Aufmaß bestimmt, wie viel Material abgetragen werden muss → Bearbeitungszeit ±30%.',
 type: 'select',
 options: [
 { value: '', label: '— Bitte wählen —' },
 { value: 'brennschnitt_3mm', label: 'Brennschnitt, ca. 3mm Aufmaß' },
 { value: 'brennschnitt_5mm', label: 'Brennschnitt, ca. 5mm Aufmaß' },
 { value: 'gesaegt', label: 'Gesägt (Rechteck-Rohling)' },
 { value: 'geschmiedet', label: 'Schmiedeteil' },
 { value: 'unklar', label: 'Noch unklar' }
 ],
 condition: (proj) => proj && (proj.dims.x > 500 || proj.dims.y > 500),
 effect: (val) => {
 const map = { brennschnitt_3mm: '3mm → weniger Schruppzeit', brennschnitt_5mm: '5mm → mehr Schruppzeit', gesaegt: 'Rechteck → volle Konturbearbeitung', geschmiedet: 'Schmiedeteil → individuelle Aufmaße' };
 return map[val] || 'Klärung nötig';
 },
 intel: (val, proj) => {
 if (val === 'brennschnitt_3mm') return 'Optimaler Zustand. 3mm Aufmaß = 1-2 Schruppzustellungen zum Planfräsen. <strong>Brennschnitthärte beachten:</strong> Erste 0,5mm Randschicht ist aufgehärtet → Vorschub in erster Zustellung um 30% reduzieren.';
 if (val === 'brennschnitt_5mm') return '5mm Aufmaß = 2-3 Schruppzustellungen nötig. Bearbeitungszeit steigt um ca. 15-20% gegenüber 3mm. <strong>Tipp:</strong> Beim Brennbetrieb 3mm Aufmaß anfragen — spart EUR pro Stück.';
 if (val === 'gesaegt') return 'Rechteck-Rohling = maximaler Materialabtrag bei der Konturbearbeitung. Deutlich teurer als Brennschnitt-Kontur. <strong>Nur sinnvoll bei einfachen Rechteckteilen.</strong> Für konturierte Teile wie diese Traverse: Brennschnitt empfehlen.';
 if (val === 'geschmiedet') return 'Schmiedeteile haben unregelmäßige Aufmaße (3-8mm). Aufmaß an jeder Stelle prüfen. <strong>Risiko:</strong> Lunker und Einschlüsse können Werkzeugbruch verursachen. Schallprüfung vor Bearbeitung empfohlen.';
 return '<strong>Unbedingt klären!</strong> Brennschnitt-Kontur vs. Rechteck-Rohling = 20-30% Zeitunterschied bei der Konturbearbeitung.';
 }
 },
 
 // EMPFOHLENE FRAGEN (2) — MIT KOSTENEFFEKT IM LABEL
 {
 id: 'cl_toleranz',
 priority: 'recommended',
 label: 'Engste Toleranz',
 aiDefault: '0.1',
 question: 'Engste geforderte Maßtoleranz?',
 reason: 'Enge Toleranzen erfordern Schlichtbearbeitung, Temperierung und mehr Messaufwand.',
 type: 'select',
 options: [
 { value: '', label: '— Bitte wählen —' },
 { value: '0.01', label: '±0.01 mm → Schleifen nötig, +60-120 min, +EUR 200-500/Stk' },
 { value: '0.02', label: '±0.02 mm → Fein-Schlichten, +15-25 min/Fläche' },
 { value: '0.05', label: '±0.05 mm → Standard Schlichten, kein Aufschlag' },
 { value: '0.1', label: '±0.1 mm → Normal, kein Aufschlag' },
 { value: '0.5', label: '±0.5 mm → Grob, ggf. schnellerer Vorschub möglich, -5-10%' }
 ],
 condition: (proj) => true,
 effect: (val) => {
 const t = parseFloat(val);
 if (t <= 0.01) return 'Schleifen eingeplant: +60-120 min/Stück, +EUR 200-500';
 if (t <= 0.02) return 'Fein-Schlichten: +15-25 min/Fläche';
 if (t <= 0.05) return 'Standard-Schlichten: kein Aufschlag';
 if (t <= 0.1) return 'Normal: kein Aufschlag';
 return 'Grob: schnellerer Vorschub möglich, -5-10%';
 },
 intel: (val) => {
 const t = parseFloat(val);
 if (t <= 0.01) return '<strong>Höchste Präzision.</strong> CNC-Fräsen reicht nicht — Koordinatenschleifen nötig. Zusätzlich: Temperierung der Maschine (min. 2h Vorlauf), 3D-Messung Pflicht. Zeitaufschlag: +60-120 min/Stück.';
 if (t <= 0.02) return 'Feinbearbeitung erforderlich. Schlichtvorschub halbieren, Werkzeugwechsel nach 2 Teilen. <strong>Messprotokoll pro Stück empfohlen.</strong> Zeitaufschlag: +30-60 min.';
 if (t <= 0.05) return 'Standard-Schlichtbearbeitung. Guter Kompromiss zwischen Genauigkeit und Kosten. Normales Schlichtaufmaß 0,2mm reicht. Kein Sonderwerkzeug nötig.';
 if (t <= 0.1) return 'Normale Toleranz — Standardbearbeitung reicht. Kein zusätzlicher Schlichtgang nötig. <strong>Wirtschaftlichste Option.</strong>';
 return 'Grobe Toleranz. Schruppen reicht aus, kein Schlichten nötig. Maximale Wirtschaftlichkeit.';
 }
 },
 {
 id: 'cl_losgroesse',
 priority: 'recommended',
 label: 'Wiederholauftrag?',
 aiDefault: 'einmal',
 question: 'Ist dies ein Einzelauftrag oder Wiederholauftrag?',
 reason: 'Bei Wiederholaufträgen lohnt sich Vorrichtungsbau → Rüstzeit sinkt ab 2. Los um 40-60%.',
 type: 'select',
 options: [
 { value: '', label: '— Bitte wählen —' },
 { value: 'einmal', label: 'Einmalauftrag' },
 { value: 'serie_klein', label: 'Kleinserie (5-20 Stk/Jahr)' },
 { value: 'serie_mittel', label: 'Mittelserie (20-100 Stk/Jahr)' },
 { value: 'serie_gross', label: 'Großserie (>100 Stk/Jahr)' }
 ],
 condition: (proj) => true,
 effect: (val) => val === 'einmal' ? 'Keine Vorrichtung' : val === 'serie_klein' ? 'Einfache Vorrichtung empfohlen' : 'Vorrichtungsbau kalkulieren',
 intel: (val, proj) => {
 const setupTime = proj?.clampings ? proj.clampings.reduce((s,c) => s + c.time, 0) : 120;
 if (val === 'einmal') return `Einmalauftrag mit ${setupTime} min Rüstzeit. Keine Vorrichtung wirtschaftlich. <strong>Tipp:</strong> Staffelpreis für mögliche Nachbestellung anbieten — zeigt Kompetenz und bindet den Kunden.`;
 if (val === 'serie_klein') return `Bei 5-20 Stk/Jahr: Einfache Anschlag-Vorrichtung amortisiert sich ab ca. 3 Stück. Rüstzeit sinkt um 40-60% (von ${setupTime} auf ca. ${Math.round(setupTime*0.5)} min). <strong>Vorrichtungskosten: EUR 500-1.500 einmalig → als separate Position anbieten.</strong>`;
 if (val === 'serie_mittel') return `20-100 Stk/Jahr: Professionelle Spannvorrichtung mit Nullpunktspannsystem empfohlen. Investition EUR 2.000-5.000, aber Rüstzeit sinkt auf ${Math.round(setupTime*0.25)} min. <strong>ROI nach ca. 8 Teilen.</strong>`;
 if (val === 'serie_gross') return `>100 Stk/Jahr: Hydraulik-Spannvorrichtung mit automatischer Zentrierung. Rüstzeit unter ${Math.round(setupTime*0.15)} min möglich. <strong>Investition EUR 5.000-15.000 — bei >100 Stk amortisiert in 2-3 Monaten. Unbedingt Vorrichtungskosten separat anbieten.</strong>`;
 return '';
 }
 }
 ];

 let checklistAnswers = {};
 let checklistCompleted = false;
 let checklistDismissed = {}; // Tracks questions dismissed as "Nicht relevant"
 let checklistDeviations = []; // Tracks where user deviates from AI recommendation

 function generateChecklist() {
 const container = document.getElementById('checklistQuestions');
 if (!container) return;
 container.innerHTML = '';

 // Dynamically fill material options (from DB)
 const matQ = CHECKLIST_QUESTIONS.find(q => q.id === 'cl_werkstoff');
 if (matQ) {
 matQ.options = [{ value: '', label: '— Bitte wählen —' }];
 Object.keys(DB.materials).forEach(k => {
 matQ.options.push({ value: k, label: `${DB.materials[k].name} (€${DB.materials[k].price.toFixed(2)}/kg, ρ ${DB.materials[k].density} g/cm³)` });
 });
 // Pre-select current material
 if (currentProject?.material) {
 checklistAnswers['cl_werkstoff'] = checklistAnswers['cl_werkstoff'] || currentProject.material;
 }
 }

 let criticalCount = 0;
 let openCount = 0;

 CHECKLIST_QUESTIONS.forEach(q => {
 if (!q.condition(currentProject)) return;

 const answered = checklistAnswers[q.id] !== undefined && checklistAnswers[q.id] !== '';
 if (!answered && q.priority === 'critical') criticalCount++;
 if (!answered) openCount++;

 const borderColor = q.priority === 'critical' ? 'var(--color-danger)' : 'var(--color-warning)';
 const bgColor = answered ? 'var(--color-bg-subtle)' : (q.priority === 'critical' ? 'rgba(220,53,69,0.05)' : 'rgba(255,193,7,0.05)');
 const icon = answered ? '✓' : (q.priority === 'critical' ? '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e53935;"></span>' : '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#f9a825;"></span>');

 let inputHtml = '';
 if (q.type === 'select') {
 inputHtml = `<select class="select" style="max-width:400px;" onchange="answerChecklist('${q.id}', this.value)">
 ${q.options.map(o => `<option value="${o.value}" ${checklistAnswers[q.id] === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
 </select>`;
 } else if (q.type === 'number') {
 inputHtml = `<div style="display:flex;align-items:center;gap:8px;">
 <input type="number" step="0.01" class="input input-sm" style="width:120px;" 
 value="${checklistAnswers[q.id] || ''}" placeholder="${q.placeholder || ''}"
 onchange="answerChecklist('${q.id}', this.value)">
 <span style="color:var(--color-text-muted);font-size:13px;">${q.unit || ''}</span>
 </div>`;
 }

 const effectText = answered && q.effect ? q.effect(checklistAnswers[q.id]) : '';
 const intelText = answered && q.intel ? q.intel(checklistAnswers[q.id], currentProject) : '';

 container.innerHTML += `
 <div class="checklist-item" style="padding: var(--space-3); border-left: 3px solid ${borderColor}; background: ${bgColor}; border-radius: var(--radius);">
 <div style="display:flex; align-items:center; gap: 8px; margin-bottom: 4px;">
 <span>${icon}</span>
 <strong style="font-size: 14px;">${q.label}</strong>
 <span style="font-size:11px; padding:1px 6px; border-radius:8px; background:${q.priority === 'critical' ? 'var(--color-danger)' : 'var(--color-warning)'}; color:#fff;">
 ${checklistDismissed[q.id] ? 'Nicht relevant' : (q.priority === 'critical' ? 'Pflicht' : 'Empfohlen')}
 </span>
 <button onclick="dismissChecklistQuestion('${q.id}')" style="margin-left:auto;background:none;border:1px solid var(--color-border);color:var(--color-text-muted);padding:2px 8px;border-radius:4px;font-size:11px;cursor:pointer;" title="Als nicht relevant markieren">✕ Nicht relevant</button>
 </div>
 <div style="font-size:14px; margin-bottom: 8px; font-weight: 500;">${q.question}</div>
 <div style="font-size:12px; color:var(--color-text-muted); margin-bottom: 8px;">
 → <em>${q.reason}</em>
 </div>
 ${inputHtml}
 ${effectText ? `<div style="margin-top:8px; padding:6px 10px; background:rgba(40,167,69,0.08); border-radius:var(--radius-sm); border-left:2px solid var(--color-success);">
 <div style="font-size:12px; font-weight:600; color:var(--color-success);">→ Auswirkung: ${effectText}</div>
 </div>` : ''}
 ${intelText ? `<div style="margin-top:6px; padding:8px 10px; background:rgba(13,110,253,0.06); border-radius:var(--radius-sm); border-left:2px solid #0d6efd;">
 <div style="font-size:11px; font-weight:600; color:#0d6efd; margin-bottom:2px;display:flex;align-items:center;gap:4px;"><span class="icon icon-sm"><svg viewBox="0 0 24 24" fill="none" stroke="#0d6efd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg></span> Empfehlung</div>
 <div style="font-size:12px; color:var(--color-text-secondary); line-height:1.5;">${intelText}</div>
 </div>` : ''}
 </div>`;
 });

 // Update badge - only show when a project is selected
 const badge = document.getElementById('checklistBadge');
 if (badge) {
 if (!currentProject) {
 badge.style.display = 'none';
 } else if (openCount > 0) {
 badge.style.display = 'inline';
 badge.textContent = openCount;
 badge.style.background = criticalCount > 0 ? 'var(--color-danger)' : 'var(--color-warning)';
 } else {
 badge.style.display = 'inline';
 badge.textContent = '✓';
 badge.style.background = 'var(--color-success)';
 }
 }

 // Update summary
 updateChecklistSummary();
 }

 function answerChecklist(id, value) {
 checklistAnswers[id] = value;

 // Track deviations from AI defaults/recommendations
 const q = CHECKLIST_QUESTIONS.find(qq => qq.id === id);
 if (q && q.aiDefault) {
 const aiVal = typeof q.aiDefault === 'function' ? q.aiDefault(currentProject) : q.aiDefault;
 const devIdx = checklistDeviations.findIndex(d => d.id === id);
 if (value !== aiVal && value !== '') {
 const deviation = {
 id, label: q.label,
 aiRecommendation: aiVal,
 userChoice: value,
 reason: '' // user can fill in later
 };
 if (devIdx >= 0) checklistDeviations[devIdx] = deviation;
 else checklistDeviations.push(deviation);
 } else if (devIdx >= 0) {
 checklistDeviations.splice(devIdx, 1);
 }
 }

 // Apply material change immediately
 if (id === 'cl_werkstoff' && value && MATERIALS[value]) {
 document.getElementById('materialSelect').value = value;
 }

 // Apply material price
 if (id === 'cl_materialpreis' && parseFloat(value) > 0) {
 const matKey = document.getElementById('materialSelect').value;
 if (MATERIALS[matKey]) {
 MATERIALS[matKey].price = parseFloat(value);
 }
 }

 // Recalculate to show price impact immediately
 if (['cl_materialpreis', 'cl_werkstoff', 'cl_brennschnitt', 'cl_rohteil'].includes(id)) {
 calculate();
 }

 // Re-check conditional visibility
 generateChecklist();
 }

 function updateChecklistSummary() {
 const container = document.getElementById('checklistSummaryContent');
 const wrapper = document.getElementById('checklistSummary');
 if (!container || !wrapper) return;

 const answered = Object.entries(checklistAnswers).filter(([k, v]) => v !== '' && v !== undefined);
 if (answered.length === 0) { wrapper.style.display = 'none'; return; }

 wrapper.style.display = 'block';
 let html = '<table style="width:100%;font-size:13px;border-collapse:collapse;">';
 html += '<tr style="border-bottom:1px solid var(--color-border);"><th style="text-align:left;padding:4px 8px;">Prüfpunkt</th><th style="text-align:left;padding:4px 8px;">Antwort</th><th style="text-align:left;padding:4px 8px;">Auswirkung</th></tr>';

 CHECKLIST_QUESTIONS.forEach(q => {
 if (!q.condition(currentProject)) return;
 const val = checklistAnswers[q.id];
 if (val === undefined || val === '') return;

 let displayVal = val;
 if (q.type === 'select') {
 const opt = q.options.find(o => o.value === val);
 displayVal = opt ? opt.label : val;
 } else if (q.unit) {
 displayVal = val + ' ' + q.unit;
 }

 const effect = q.effect ? q.effect(val) : '';
 html += `<tr style="border-bottom:1px solid var(--color-border);">
 <td style="padding:4px 8px;">${q.label}</td>
 <td style="padding:4px 8px;"><strong>${displayVal}</strong></td>
 <td style="padding:4px 8px; color:var(--color-text-muted);">${effect}</td>
 </tr>`;
 });
 html += '</table>';

 // Show deviations
 if (checklistDeviations.length > 0) {
 html += '<div style="margin-top:12px;padding:10px;background:rgba(253,126,20,0.08);border-left:3px solid #fd7e14;border-radius:var(--radius);">';
 html += '<div style="font-weight:600;font-size:12px;color:#fd7e14;margin-bottom:6px;">Abweichungen von KI-Empfehlung (' + checklistDeviations.length + ')</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += '<tr style="border-bottom:1px solid var(--color-border);"><th style="text-align:left;padding:3px 6px;">Prüfpunkt</th><th style="text-align:left;padding:3px 6px;">KI empfahl</th><th style="text-align:left;padding:3px 6px;">Ihre Eingabe</th></tr>';
 checklistDeviations.forEach(d => {
 const q = CHECKLIST_QUESTIONS.find(qq => qq.id === d.id);
 let aiLabel = d.aiRecommendation, userLabel = d.userChoice;
 if (q?.type === 'select') {
 const aiOpt = q.options.find(o => o.value === d.aiRecommendation);
 const usrOpt = q.options.find(o => o.value === d.userChoice);
 aiLabel = aiOpt?.label || d.aiRecommendation;
 userLabel = usrOpt?.label || d.userChoice;
 } else if (q?.unit) {
 aiLabel += ' ' + q.unit;
 userLabel += ' ' + q.unit;
 }
 html += `<tr style="border-bottom:1px solid var(--color-border);"><td style="padding:3px 6px;">${d.label}</td><td style="padding:3px 6px;color:var(--color-text-muted);">${aiLabel}</td><td style="padding:3px 6px;font-weight:600;">${userLabel}</td></tr>`;
 });
 html += '</table></div>';
 }

 container.innerHTML = html;
 }

 function dismissChecklistQuestion(id) {
 checklistDismissed[id] = {
 timestamp: new Date().toLocaleString('de-DE'),
 user: 'AV',
 reason: 'Als nicht relevant markiert'
 };
 // Track change
 if (typeof trackChange === 'function') trackChange('Prüfprotokoll', `Frage ${id}`, 'Offen', 'Nicht relevant (übersprungen)');
 // Re-render checklist to update badge
 generateChecklist();
 }

 function submitChecklist() {
 // Check critical questions (excluding dismissed ones)
 const unanswered = CHECKLIST_QUESTIONS.filter(q => 
 q.priority === 'critical' && q.condition(currentProject) && 
 (!checklistAnswers[q.id] || checklistAnswers[q.id] === '') &&
 !checklistDismissed[q.id]
 );

 if (unanswered.length > 0) {
 alert('[!] Bitte alle Pflichtfragen (rot) beantworten oder als "Nicht relevant" markieren:\n\n' + unanswered.map(q => '• ' + q.label).join('\n'));
 return;
 }

 checklistCompleted = true;

 // Apply answers to calculation
 if (checklistAnswers['cl_rohteil'] === 'beistellung') {
 // Material cost = 0 — set price to 0 temporarily
 const matKey = document.getElementById('materialSelect').value;
 if (MATERIALS[matKey]) MATERIALS[matKey].price = 0;
 }

 // Switch to Kalkulation
 const btn = document.querySelector('[data-section="result"]');
 showSection('result', btn);
 }

 function exportChecklistPDF() {
 // Simple print-based export
 const content = document.getElementById('checklistSummaryContent')?.innerHTML;
 if (!content) { alert('Keine Antworten zum Exportieren.'); return; }

 const w = window.open('', '_blank');
 w.document.write(`<html><head><title>Prüfprotokoll — ${currentProject?.name || 'Bauteil'}</title>
 <style>body{font-family:Helvetica Neue,Arial,sans-serif;padding:40px;font-size:13px;}
 table{width:100%;border-collapse:collapse;}th,td{padding:6px 10px;border:1px solid #ddd;text-align:left;}
 th{background:#f5f5f5;}h1{font-size:18px;margin-bottom:4px;}h2{font-size:14px;color:#666;margin-bottom:20px;}</style></head>
 <body><h1>Prüfprotokoll</h1><h2>${currentProject?.name || 'Bauteil'} — ${currentProject?.partNumber || ''} — ${new Date().toLocaleDateString('de-DE')}</h2>
 ${content}
 <p style="margin-top:30px;font-size:11px;color:#999;">Erstellt mit CNC Planer Pro — ${new Date().toLocaleString('de-DE')}</p>
 </body></html>`);
 w.document.close();
 w.print();
 }

 function sendDevFeedback() {
 const text = document.getElementById('devFeedbackText')?.value?.trim();
 if (!text) { alert('Bitte Feedback eingeben.'); return; }

 const status = document.getElementById('devFeedbackStatus');
 const payload = {
 type: 'cnc-planner-feedback',
 project: currentProject?.name || 'Unbekannt',
 partNumber: currentProject?.partNumber || '',
 feedback: text,
 timestamp: new Date().toISOString(),
 checklistState: { ...checklistAnswers }
 };

 // Store locally
 const feedbackLog = JSON.parse(localStorage.getItem('cncPlannerFeedback') || '[]');
 feedbackLog.push(payload);
 localStorage.setItem('cncPlannerFeedback', JSON.stringify(feedbackLog));

 // Show WhatsApp link to developer
 const msg = encodeURIComponent(`[CNC Planer Feedback] ${currentProject?.name || 'Bauteil'}: ${text}`);
 
 if (status) {
 status.innerHTML = `<span style="color:#4caf50;font-weight:700">✓</span> Feedback gespeichert! <a href="https://wa.me/4915123039208?text=${msg}" target="_blank" style="color:var(--color-primary);">Per WhatsApp an Entwickler senden</a>`;
 }
 const devText = document.getElementById('devFeedbackText');
 if (devText) devText.value = '';
 }

 // ================================================================
 // CLAMPING EXPLANATION & WORKER FEEDBACK
 // ================================================================

 function getClampingExplanation(type, time, project, index) {
 const dims = project?.dims || { x: 100, y: 100, z: 20 };
 const weight = (dims.x * dims.y * dims.z / 1000 * (MATERIALS[project?.material]?.density || 7.85)) / 1000;
 const isFirst = index === 0;

 const explanations = {
 'tischspannung': {
 base: 20,
 items: [
 { label: 'Pratzen setzen (4-6×)', time: isFirst ? 15 : 10, note: weight > 500 ? 'Kran erforderlich' : '' },
 { label: 'Ausrichten / Parallelität', time: isFirst ? 8 : 5, note: '' },
 { label: 'WZ einwechseln', time: isFirst ? 8 : 6, note: isFirst ? '3-5 Werkzeuge' : '2-3 Werkzeuge' },
 { label: 'Nullpunkt antasten', time: isFirst ? 7 : 5, note: '' },
 { label: 'Programm laden/prüfen', time: isFirst ? 5 : 3, note: '' },
 ...(weight > 200 ? [{ label: 'Kranhandling (>' + Math.round(weight) + 'kg)', time: 7, note: '[!] Schwerlast' }] : [])
 ]
 },
 'schraubstock': {
 base: 8,
 items: [
 { label: 'Einlegen & Spannen', time: 3, note: '' },
 { label: 'Parallelität prüfen', time: 4, note: '' },
 { label: 'Nullpunkt antasten', time: 5, note: '' },
 { label: 'WZ + Programm', time: isFirst ? 5 : 3, note: '' }
 ]
 },
 'schraubstock2': {
 base: 12,
 items: [
 { label: '2× Schraubstock ausrichten', time: 8, note: '' },
 { label: 'Teil einlegen', time: 5, note: '' },
 { label: 'Nullpunkt + Programm', time: 8, note: '' }
 ]
 },
 'nullpunkt': {
 base: 3,
 items: [
 { label: 'Palette einsetzen', time: 2, note: 'Schnellwechsel' },
 { label: 'Verriegeln + Programm', time: 3, note: '' }
 ]
 },
 'spezial': {
 base: 25,
 items: [
 { label: 'Vorrichtung montieren', time: 20, note: '' },
 { label: 'Teil einlegen & sichern', time: 10, note: '' },
 { label: 'Nullpunkt + Programm', time: 10, note: '' }
 ]
 }
 };

 const exp = explanations[type] || explanations['schraubstock'];
 let html = '<table style="width:100%;font-size:10px;font-family:var(--font-mono);">';
 let calcTotal = 0;
 exp.items.forEach(item => {
 calcTotal += item.time;
 html += `<tr>
 <td style="padding:1px 0;color:var(--color-text-muted);">${item.label}</td>
 <td style="text-align:right;padding:1px 0;">${item.time} min</td>
 ${item.note ? `<td style="padding:1px 4px;color:var(--color-warning);font-size:9px;">${item.note}</td>` : '<td></td>'}
 </tr>`;
 });
 const diff = time - calcTotal;
 if (Math.abs(diff) > 1) {
 html += `<tr><td style="padding:1px 0;color:var(--color-text-hint);">Rundung/Puffer</td><td style="text-align:right;padding:1px 0;">${diff > 0 ? '+' : ''}${diff} min</td><td></td></tr>`;
 }
 html += `<tr style="border-top:1px solid var(--color-border);font-weight:600;"><td style="padding:2px 0;">Gesamt</td><td style="text-align:right;padding:2px 0;">${time} min</td><td></td></tr>`;
 html += '</table>';
 return html;
 }

 // ================================================================
 // ACTION BAR — Werker & Feedback (kontextbezogen)
 // ================================================================

 const userFeedback = []; // All feedback entries

 const WORKER_QUESTIONS = {
 workpiece: [
 'Ist das Rohteil so lieferbar?',
 'Wie schwer ist das Rohteil ungefähr?',
 'Brauchen wir Fräskanten für die Aufspannung?'
 ],
 checklist: [
 'Welchen Werkstoff habt ihr zuletzt bei KBA-Teilen verarbeitet?',
 'Woher kommt das Rohteil normalerweise?',
 'Gibt es besondere Prüfanforderungen?'
 ],
 calc: [
 'Passt der kalkulierte Stundensatz für diese Maschine?',
 'Ist der Materialpreis noch aktuell?',
 'Stimmt der Gewinnaufschlag für diesen Kunden?'
 ],
 instructions: [
 'Wie lange braucht ihr für das Ausrichten?',
 'Stimmt die Reihenfolge der Aufspannungen?',
 'Welches Werkzeug nehmt ihr für die Taschen?',
 'Ist die Bearbeitungszeit realistisch?'
 ],
 tools: [
 'Haben wir dieses Werkzeug auf Lager?',
 'Welchen Fräser nehmt ihr für GJS-700?',
 'Wie ist die Standzeit bei diesem Werkstoff?'
 ],
 code: [
 'Passt die Schnittgeschwindigkeit?',
 'Gibt es Kollisionsgefahr bei dieser Aufspannung?'
 ],
 feedback: [
 'Wie lange hat das Bauteil tatsächlich gedauert?',
 'Was war anders als geplant?',
 'Was würdet ihr beim nächsten Mal anders machen?'
 ]
 };

 function getCurrentSectionName() {
 const active = document.querySelector('.section.active');
 if (!active) return 'workpiece';
 const id = active.id.replace('section-', '');
 return id;
 }

 function updateActionBarContext() {
 const section = getCurrentSectionName();
 const names = { workpiece:'Werkstück', checklist:'Prüfprotokoll', calc:'Kalkulation', instructions:'Fertigungsanweisung', tools:'Werkzeuge', code:'NC-Code', protocol:'Protokoll', feedback:'Nachkalkulation', params:'Preise & Sätze', settings:'Einstellungen', quote:'Angebot' };
 const el = document.getElementById('actionBarContext');
 if (el) el.textContent = 'Sektion: ' + (names[section] || section) + (currentProject ? ' · ' + currentProject.name : '');
 }

 // Hook into showSection to update context
 const _origShowSection = showSection;
 // Will be called after showSection via a wrapper

 function openWorkerDialog() {
 const section = getCurrentSectionName();
 const proj = currentProject;
 const dialog = document.getElementById('workerDialog');
 document.getElementById('feedbackDialog').style.display = 'none';

 // Context info
 const ctx = document.getElementById('workerDialogContext');
 ctx.textContent = (proj ? proj.name + ' — ' : '') + 'Bereich: ' + (document.getElementById('actionBarContext')?.textContent || section);

 // Predefined questions for this section
 const questions = WORKER_QUESTIONS[section] || WORKER_QUESTIONS.instructions;
 const list = document.getElementById('workerQuestionList');
 list.innerHTML = questions.map(q =>
 `<button class="btn btn-sm btn-secondary" style="text-align:left;font-size:12px;justify-content:flex-start;" onclick="document.getElementById('workerCustomQ').value='${q}'">${q}</button>`
 ).join('');

 document.getElementById('workerCustomQ').value = '';
 dialog.style.display = 'block';
 }

 function sendWorkerQuestion() {
 const q = document.getElementById('workerCustomQ')?.value?.trim();
 if (!q) { alert('Bitte eine Frage eingeben.'); return; }
 const proj = currentProject;
 const phone = localStorage.getItem('workerPhone') || prompt('WhatsApp-Nummer des Werkers (z.B. +49151...)');
 if (!phone) return;
 localStorage.setItem('workerPhone', phone);

 const section = getCurrentSectionName();
 const msg = `CNC Planer Pro — Frage an Werker\n\nBauteil: ${proj?.name || '—'}\nBereich: ${section}\n\n${q}`;
 window.open('https://wa.me/' + phone.replace(/[^0-9]/g,'') + '?text=' + encodeURIComponent(msg), '_blank');
 document.getElementById('workerDialog').style.display = 'none';

 // Log to feedback
 userFeedback.push({
 timestamp: new Date().toLocaleString('de-DE'),
 section, type: 'werker-frage', text: q
 });
 }

 function openFeedbackDialog() {
 const section = getCurrentSectionName();
 const dialog = document.getElementById('feedbackDialog');
 document.getElementById('workerDialog').style.display = 'none';

 const ctx = document.getElementById('feedbackDialogContext');
 ctx.textContent = (currentProject ? currentProject.name + ' — ' : '') + 'Bereich: ' + (document.getElementById('actionBarContext')?.textContent || section);

 document.getElementById('feedbackText').value = '';
 dialog.style.display = 'block';
 }

 function submitFeedback() {
 const text = document.getElementById('feedbackText')?.value?.trim();
 const cat = document.getElementById('feedbackCategory')?.value || 'frage';
 if (!text) { alert('Bitte Feedback eingeben.'); return; }

 const section = getCurrentSectionName();
 userFeedback.push({
 timestamp: new Date().toLocaleString('de-DE'),
 section, type: cat, text
 });

 // Also add to faChanges for protocol visibility
 faChanges.push({
 timestamp: new Date().toLocaleString('de-DE'),
 ag: '—', field: 'Feedback (' + {fehler:'Fehler',verbesserung:'Verbesserung',frage:'Frage',lob:'Bestätigung'}[cat] + ')',
 oldVal: section, newVal: text
 });
 const countEl = document.getElementById('faChangeCount');
 if (countEl) countEl.textContent = faChanges.length;

 document.getElementById('feedbackDialog').style.display = 'none';
 alert('Vielen Dank! Wir melden uns innerhalb von 24 Stunden (werktags) bei Ihnen.');
 }

 function openKiDialog() {
 const section = getCurrentSectionName();
 const dialog = document.getElementById('kiDialog');
 document.getElementById('workerDialog').style.display = 'none';
 document.getElementById('feedbackDialog').style.display = 'none';

 const ctx = document.getElementById('kiDialogContext');
 ctx.textContent = (currentProject ? currentProject.name + ' — ' : '') + 'Bereich: ' + (document.getElementById('actionBarContext')?.textContent || section);

 document.getElementById('kiCustomQ').value = '';
 document.getElementById('kiAnswer').style.display = 'none';
 dialog.style.display = 'block';
 }

 function askKi(question) {
 document.getElementById('kiCustomQ').value = question;
 submitKiQuestion();
 }

 function submitKiQuestion() {
 const q = document.getElementById('kiCustomQ')?.value?.trim();
 if (!q) { alert('Bitte eine Frage eingeben.'); return; }

 // Store question in localStorage for analysis
 const kiLog = JSON.parse(localStorage.getItem('cncKiQuestions') || '[]');
 kiLog.push({
 timestamp: new Date().toISOString(),
 question: q,
 section: getCurrentSectionName(),
 project: currentProject?.name || '—'
 });
 localStorage.setItem('cncKiQuestions', JSON.stringify(kiLog));

 // Knowledge base answers
 const answers = {
 'woher kommen die schnittwerte': 'Die Schnittwerte basieren auf <strong>VDI 3321</strong> — der DIN-Norm für Schnittdaten beim Fräsen und Bohren. Die Formeln berücksichtigen Werkstoff, Werkzeugdurchmesser und Spanungsquerschnitt. Zusätzlich fließen <strong>Herstellerempfehlungen</strong> (Sandvik, Walter, Iscar) ein. Für Sonderfälle können Sie die Werte manuell überschreiben.',
 'warum dieser stundensatz': 'Der Stundensatz setzt sich zusammen aus <strong>Lohnkosten</strong> (Facharbeiterlohn + Arbeitgeberanteil) und <strong>Maschinenkosten</strong> (Abschreibung, Energie, Wartung, Raumkosten). Die Standardwerte basieren auf <strong>REFA-Richtwerten 2024</strong> für Lohnfertiger. Sie können die Sätze unter <strong>Preise & Sätze</strong> anpassen.',
 'wie wurde die rüstzeit berechnet': 'Die Rüstzeit basiert auf <strong>REFA-Zeitgliederung</strong>: Spannmittel vorbereiten + Teil einlegen + Nullpunkt antasten + Programm laden. Je nach Aufspannung (Schraubstock, Pratzen, Nullpunktsystem) variiert die Zeit. Bei <strong>Folgeaufspannungen</strong> (2., 3., ...) wird die Rüstzeit automatisch um ~30% reduziert.',
 'wie genau ist die kalkulation': 'Die Kalkulation ist eine <strong>Vorkalkulation</strong> auf Basis von Normen (REFA, VDI) und Erfahrungswerten. Genauigkeit: <strong>±15-25%</strong> je nach Bauteilkomplexität. Empfehlung: <strong>Nachkalkulation</strong> nach Fertigung durchführen und Abweichungen im Protokoll dokumentieren → System lernt daraus.'
 };

 // Find matching answer (case-insensitive, partial match)
 const qLower = q.toLowerCase();
 let answer = 'Diese Frage kann ich noch nicht beantworten. Die KI-Wissensbasis wird kontinuierlich erweitert. <strong>Tipp:</strong> Nutzen Sie "Werker befragen" für spezifische Fragen zu Ihrem Betrieb.';

 for (const [key, val] of Object.entries(answers)) {
 if (qLower.includes(key.substring(0, 10))) {
 answer = val;
 break;
 }
 }

 // Show answer
 const answerEl = document.getElementById('kiAnswer');
 answerEl.innerHTML = answer;
 answerEl.style.display = 'block';
 }

 // Update context on section switch
 setInterval(updateActionBarContext, 1000);

 function askWorkerFeedbackGeneric() {
 // Detect current section
 const activeSection = document.querySelector('.section.active');
 const sectionId = activeSection?.id?.replace('section-', '') || 'unbekannt';
 const sectionNames = {
 'part': 'Werkstück',
 'result': 'Kalkulation',
 'instructions': 'Fertigungsanweisung',
 'tools': 'Werkzeuge',
 'code': 'NC-Code',
 'quote': 'Angebot',
 'feedback': 'Nachkalkulation',
 'params': 'Preise & Sätze',
 'settings': 'Einstellungen'
 };
 const sectionName = sectionNames[sectionId] || sectionId;
 const partName = currentProject?.name || 'Bauteil';
 const partNr = currentProject?.partNumber || '';

 const question = prompt(
 `Werker-Feedback anfordern\n\nAktueller Bereich: ${sectionName}\nBauteil: ${partName}\n\nWas möchten Sie den Werker fragen?`,
 ''
 );
 if (!question) return;

 askWorkerFeedback(
 sectionName,
 question,
 0
 );
 }

 function askWorkerFeedback(step, description, estimatedTime) {
 const partName = currentProject?.name || 'Bauteil';
 const partNr = currentProject?.partNumber || '';
 const timeInfo = estimatedTime > 0
 ? `\nZeit: ${estimatedTime} min\n\nBitte antworten Sie:\n✓ Passt so\nKorrektur: ___ min (mit Begründung)\n✗ Nicht realistisch, weil: ___`
 : `\nBitte antworten Sie mit Ihrer Einschätzung:`;

 const message = encodeURIComponent(
 `[CNC Planer Pro] — Feedback gefragt\n\n` +
 `Bauteil: ${partName} (${partNr})\n` +
 `Bereich: ${step}\n` +
 `Frage: ${description}` +
 timeInfo
 );
 
 // Show modal to enter phone number or use stored
 const stored = localStorage.getItem('cncplanner_worker_phone') || '';
 const phone = prompt(
 'WhatsApp-Nummer des Werkers/Meisters eingeben:\n(Format: +49151...)\n\nGespeicherte Nr: ' + (stored || 'keine'),
 stored
 );
 if (!phone) return;
 localStorage.setItem('cncplanner_worker_phone', phone);
 const cleanPhone = phone.replace(/[^0-9]/g, '');
 window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
 }

 const faChanges = []; // Tracks all manual changes in Fertigungsanweisung

 function logFaChange(ag, field, oldVal, newVal) {
 faChanges.push({
 timestamp: new Date().toLocaleString('de-DE'),
 ag, field, oldVal: String(oldVal), newVal: String(newVal)
 });
 const countEl = document.getElementById('faChangeCount');
 if (countEl) countEl.textContent = faChanges.length;
 const logEl = document.getElementById('faChangeLogContent');
 if (logEl) {
 logEl.innerHTML = faChanges.map(c =>
 `<div style="padding:4px 0;border-bottom:1px solid var(--color-border-light);display:flex;gap:8px;">
 <span style="color:var(--color-text-muted);width:120px;flex-shrink:0;">${c.timestamp}</span>
 <span><strong>AG ${c.ag}</strong> ${c.field}: <span style="text-decoration:line-through;color:var(--color-text-muted);">${c.oldVal}</span> → <strong>${c.newVal}</strong></span>
 </div>`
 ).reverse().join('');
 }
 }

 function onOpFieldChange(input, opNr, field) {
 if (!currentProject?.operations) return;
 const op = currentProject.operations.find(o => o.nr === opNr);
 if (!op) return;
 const oldVal = op[field];
 const newVal = field === 'time' ? (parseFloat(input.value) || 0) : input.value;
 if (String(oldVal) === String(newVal)) return;
 logFaChange(opNr, field === 'time' ? 'Zeit' : field === 'tool' ? 'Werkzeug' : field === 'name' ? 'Beschreibung' : field, oldVal, newVal);
 op[field] = newVal;
 // Visual feedback: mark changed field yellow
 input.style.background = '#fffde7';
 input.style.borderColor = '#f9a825';
 input.title = `Geändert: ${oldVal} → ${newVal}`;
 if (field === 'time') {
 // Update sum row
 const total = currentProject.operations.reduce((s, o) => s + o.time, 0);
 const sumEl = document.getElementById('opsSumRow');
 if (sumEl) sumEl.textContent = total + ' min = ' + (total/60).toFixed(1) + ' h';
 calculate();
 }
 }

 function removeOperation(opNr) {
 if (!currentProject?.operations) return;
 const op = currentProject.operations.find(o => o.nr === opNr);
 if (!op) return;
 logFaChange(opNr, 'Entfernt', op.name + ' (' + op.time + ' min)', '—');
 currentProject.operations = currentProject.operations.filter(o => o.nr !== opNr);
 renderOperations(currentProject.operations);
 calculate();
 }

 function renderOperations(ops) {
 const opsCards = document.querySelectorAll('#section-instructions .card');
 let opsCard = null;
 opsCards.forEach(c => {
 const hdr = c.querySelector('.card-header');
 if (hdr && hdr.textContent.includes('Operationen')) opsCard = c;
 });
 if (!opsCard) return;
 const body = opsCard.querySelector('.card-body');
 if (!body) return;
 
 let totalTime = 0;

 let html = `<table class="table" style="margin:0;">
 <thead><tr>
 <th style="width:40px;"></th>
 <th style="width:50px;">AG</th>
 <th>Beschreibung</th>
 <th style="width:140px;">Werkzeug <span style="font-size:9px;font-weight:400;opacity:0.6;">(readonly)</span></th>
 <th style="width:100px;">Kostenstelle <span style="font-size:9px;font-weight:400;opacity:0.6;">(readonly)</span></th>
 <th class="right" style="width:100px;">Zeit <span style="font-size:9px;font-weight:400;opacity:0.6;">(editierbar ✎)</span></th>
 <th class="right" style="width:80px;">Kosten</th>
 <th style="width:30px;"></th>
 </tr></thead><tbody>`;
 
 ops.forEach(op => {
 totalTime += op.time;
 const rateKey = op.rate || 'cnc';
 const rateObj = RATES[rateKey] || RATES.cnc;
 const rate = rateObj.labor + rateObj.machine;
 const cost = (op.time / 60) * rate;
 const detailId = `opDetail${op.nr}`;
 
 // Calculate detail breakdown (example values - adapt to actual data)
 const t_h = op.time * 0.7; // Hauptzeit ~70%
 const t_n = op.time * 0.3; // Nebenzeit ~30%
 const t_r = op.setup || 0; // Rüstzeit
 const laborCost = (op.time / 60) * rateObj.labor;
 const machineCost = (op.time / 60) * rateObj.machine;
 
 html += `<tr style="cursor:pointer;background:var(--color-surface);" onclick="toggleOpDetail('${detailId}')">
 <td style="text-align:center;padding:4px;"><span style="font-size:12px;color:var(--color-text-hint);" id="chevron${detailId}">▶</span></td>
 <td><span class="op-badge">${op.nr}</span></td>
 <td>${op.name}</td>
 <td style="background:var(--color-bg-muted);padding:4px 8px;"><span class="mono" style="font-size:12px;color:var(--color-text-muted);">${op.tool || '—'}</span></td>
 <td style="background:var(--color-bg-muted);padding:4px 8px;"><span style="font-size:12px;color:var(--color-text-muted);">${rateKey === 'saegen' ? 'Sägen' : rateKey === 'entgraten' ? 'Entgraten' : 'CNC'}</span></td>
 <td class="right" style="background:white;padding:4px;"><input type="number" class="input input-sm input-mono" value="${op.time}" style="width:70px;text-align:right;border:1px solid var(--color-border);" step="0.1" onchange="event.stopPropagation(); onOpFieldChange(this,${op.nr},'time')" onclick="event.stopPropagation()"> <span style="font-size:11px;color:var(--color-text-muted);">min</span></td>
 <td class="right mono" style="font-size:12px;color:var(--color-text-muted);">${DEFormatter.price(cost)}</td>
 <td style="text-align:center;"><button class="btn btn-sm" onclick="event.stopPropagation(); removeOperation(${op.nr})" style="padding:0 4px;color:var(--color-error);border:none;font-size:14px;" title="Entfernen">×</button></td>
 </tr>
 <tr id="${detailId}" style="display:none;">
 <td colspan="8" style="padding:0;background:var(--color-bg-subtle);border-top:1px solid var(--color-border-light);">
 <div style="padding:var(--space-3) var(--space-4);font-size:12px;">
 <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--space-4);margin-bottom:var(--space-3);">
 <div>
 <div style="font-weight:600;margin-bottom:4px;color:var(--color-text-secondary);">Zeitaufschlüsselung</div>
 <div style="font-family:var(--font-mono);line-height:1.7;">
 Hauptzeit (t<sub>h</sub>): <strong>${t_h.toFixed(1)} min</strong><br>
 Nebenzeit (t<sub>n</sub>): <strong>${t_n.toFixed(1)} min</strong><br>
 Rüstzeit (t<sub>r</sub>): <strong>${t_r.toFixed(1)} min</strong>
 </div>
 </div>
 <div>
 <div style="font-weight:600;margin-bottom:4px;color:var(--color-text-secondary);">Stundensätze</div>
 <div style="font-family:var(--font-mono);line-height:1.7;">
 Lohnkosten: <strong>EUR ${rateObj.labor.toFixed(0)}/h</strong><br>
 Maschinenkosten: <strong>EUR ${rateObj.machine.toFixed(0)}/h</strong><br>
 Gesamt: <strong>EUR ${rate.toFixed(0)}/h</strong>
 </div>
 </div>
 <div>
 <div style="font-weight:600;margin-bottom:4px;color:var(--color-text-secondary);">Kostenberechnung</div>
 <div style="font-family:var(--font-mono);line-height:1.7;">
 ${op.time} min × EUR ${rate.toFixed(0)}/h<br>
 = ${op.time} ÷ 60 × ${rate.toFixed(0)}<br>
 = <strong>${DEFormatter.price(cost)}</strong>
 </div>
 </div>
 </div>
 <div style="font-size:11px;color:var(--color-text-hint);font-style:italic;">
 Klicken Sie auf die Zeile, um die Details ein-/auszublenden.
 </div>
 </div>
 </td>
 </tr>`;
 });
 
 html += `</tbody><tfoot><tr style="font-weight:600;background:var(--color-bg-subtle);">
 <td colspan="5">Σ Bearbeitungszeit</td>
 <td class="right mono" id="opsSumRow">${totalTime} min = ${(totalTime/60).toFixed(1)} h</td>
 <td class="right mono">${DEFormatter.price(ops.reduce((s,o) => { const r=RATES[o.rate||'cnc']||RATES.cnc; return s+(o.time/60)*(r.labor+r.machine); },0))}</td>
 <td></td>
 </tr></tfoot></table>`;
 
 body.innerHTML = html;
 }
 
 function toggleOpDetail(detailId) {
 const row = document.getElementById(detailId);
 const chevron = document.getElementById('chevron' + detailId);
 if (!row) return;
 
 if (row.style.display === 'none') {
 row.style.display = '';
 if (chevron) chevron.textContent = '▼';
 } else {
 row.style.display = 'none';
 if (chevron) chevron.textContent = '▶';
 }
 }
 
 function runCalculation() {
 // Gate: Prüfprotokoll muss abgeschlossen sein
 if (!checklistCompleted) {
 // Count unanswered critical questions (excluding dismissed)
 const unanswered = CHECKLIST_QUESTIONS.filter(q => 
 q.priority === 'critical' && q.condition(currentProject) && 
 (!checklistAnswers[q.id] || checklistAnswers[q.id] === '') &&
 !checklistDismissed[q.id]
 );
 const dismissed = Object.keys(checklistDismissed).length;
 
 if (unanswered.length > 0 || (!Object.keys(checklistAnswers).length && !dismissed)) {
 // Show banner and redirect to checklist
 const banner = document.createElement('div');
 banner.id = 'checklistBanner';
 banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;background:#dc2626;color:white;padding:16px 24px;font-weight:600;font-size:15px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;justify-content:center;gap:12px;';
 banner.innerHTML = `<span style="font-size:20px;">!</span> Prüfprotokoll noch offen — ${unanswered.length} Pflichtfrage${unanswered.length !== 1 ? 'n' : ''} unbeantwortet. Bitte zuerst ausfüllen.`;
 
 // Remove old banner if exists
 const old = document.getElementById('checklistBanner');
 if (old) old.remove();
 document.body.appendChild(banner);
 setTimeout(() => { const b = document.getElementById('checklistBanner'); if(b) b.remove(); }, 5000);
 
 // Redirect to checklist
 showSection('checklist', document.querySelector('.nav-item[data-section="checklist"]'));
 return;
 }
 // All critical answered or dismissed → allow calculation
 checklistCompleted = true;
 }
 
 calculate();
 
 // Update instruction header
 if (currentProject) {
 document.getElementById('faPartName').textContent = `${currentProject.name} — ${currentProject.partNumber}`;
 const descEl = document.getElementById('quoteDesc');
 if (descEl) descEl.textContent = `Angebot — CNC-Fertigung ${currentProject.name}`;
 }
 
 { const _e = document.getElementById('mainActions'); if(_e) _e.style.display = 'flex'; }
 showSection('result', document.querySelector('.nav-item[data-section="result"]'));
 }
 
 // ================================================================
 // AI ACTIONS — Vordefinierte KI-Optimierungen
 // ================================================================

 let aiChangeHistory = [];
 let pendingSuggestion = null;

 function aiAction(type) {
 const proj = currentProject;
 if (!proj?.operations) {
 alert('Bitte zuerst ein Bauteil mit Operationen auswählen.');
 return;
 }

 const mat = MATERIALS[document.getElementById('materialSelect').value];
 let suggestion = null;

 switch(type) {
 case 'optimize_cutting':
 suggestion = generateCuttingOptimization(proj, mat);
 break;
 case 'alt_tools':
 suggestion = generateAlternativeTools(proj, mat);
 break;
 case 'check_strategy':
 suggestion = generateStrategyCheck(proj, mat);
 break;
 case 'reduce_time':
 suggestion = generateTimeReduction(proj, mat);
 break;
 }

 if (suggestion) {
 pendingSuggestion = suggestion;
 showAiSuggestion(suggestion);
 }
 }

 function generateCuttingOptimization(proj, mat) {
 const changes = [];
 const isSteel = mat.name.includes('S355') || mat.name.includes('S235');
 const isGuss = mat.name.includes('GJS');

 proj.operations.forEach(op => {
 if (!op.params) return;

 if (op.name.includes('Planfräsen') && isSteel) {
 const currentVf = parseInt(op.params.match(/vf\s*(\d+)/)?.[1] || 0);
 if (currentVf > 0 && currentVf < 900) {
 changes.push({
 ag: op.nr, field: 'params', label: op.name,
 before: op.params,
 after: op.params.replace(/vf\s*\d+/, 'vf 900'),
 reason: `Sandvik-Empfehlung für Ø80 Planfräser in S355: vf bis 900 mm/min bei ap 2,0. Aktuell ${currentVf} mm/min = konservativ. Zeitersparnis: ~${Math.round(op.time * 0.15)} min.`,
 timeSaving: Math.round(op.time * 0.15)
 });
 }
 }

 if (op.name.includes('Taschen') && isSteel) {
 const currentAp = parseFloat(op.params.match(/ap\s*([\d,.]+)/)?.[1] || 0);
 if (currentAp > 0 && currentAp <= 4) {
 changes.push({
 ag: op.nr, field: 'params', label: op.name,
 before: op.params,
 after: op.params.replace(/ap\s*[\d,.]+/, 'ap 5,0'),
 reason: `Ø20 VHM in S355 verträgt ap 5,0mm (Walter GPS). Bei ap 4,0→5,0: 20% weniger Zustellungen. Zeitersparnis: ~${Math.round(op.time * 0.18)} min. Voraussetzung: stabile Aufspannung, Kühlmittel direkt.`,
 timeSaving: Math.round(op.time * 0.18)
 });
 }
 }

 if (op.name.includes('Konturfräsen') && isSteel) {
 changes.push({
 ag: op.nr, field: 'params', label: op.name,
 before: op.params,
 after: op.params.replace(/vf\s*\d+/, 'vf 720'),
 reason: `Gleichlauffräsen + HPC-Strategie: vf 720 statt 600 möglich bei stabilem Werkzeug (Ø16 VHM >4xD). Zeitersparnis: ~${Math.round(op.time * 0.16)} min.`,
 timeSaving: Math.round(op.time * 0.16)
 });
 }
 });

 if (changes.length === 0) {
 changes.push({
 ag: '-', field: 'info', label: 'Gesamtbewertung',
 before: '-', after: '-',
 reason: 'Schnittdaten sind bereits im optimalen Bereich für ' + mat.name + '. Keine Änderung empfohlen.',
 timeSaving: 0
 });
 }

 const totalSaving = changes.reduce((s, c) => s + (c.timeSaving || 0), 0);
 return { type: 'optimize_cutting', title: 'Schnittdaten-Optimierung', changes, totalSaving };
 }

 function generateAlternativeTools(proj, mat) {
 const changes = [];

 proj.operations.forEach(op => {
 if (op.tool?.includes('Ø80 Planfräser')) {
 changes.push({
 ag: op.nr, field: 'tool', label: op.name,
 before: op.tool,
 after: 'T1 Ø63 Planfräser (5-schneidig)',
 reason: 'Ø63 statt Ø80: Höhere Drehzahl möglich (n 760 statt 600). Weniger Bahnen bei 500mm Breite (9 statt 8), aber höherer vf. Netto: ~gleiche Zeit, aber bessere Oberfläche (mehr Schneiden = weniger Vorschub pro Zahn).',
 timeSaving: 0
 });
 }

 if (op.tool?.includes('Ø20 VHM') && op.name.includes('Taschen')) {
 changes.push({
 ag: op.nr, field: 'tool', label: op.name,
 before: op.tool,
 after: 'T4 Ø25 VHM (4-schneidig, HPC)',
 reason: 'Ø25 statt Ø20: 25% mehr ae pro Bahn. Bei 4 Taschen spart das ~2 Bahnen pro Tasche. Zeitersparnis: ~8 min. Voraussetzung: Maschinenspindel ≥15 kW.',
 timeSaving: 8
 });
 }

 if (op.tool?.includes('Ø16 VHM') && op.name.includes('Kontur')) {
 changes.push({
 ag: op.nr, field: 'tool', label: op.name,
 before: op.tool,
 after: 'T5 Ø16 VHM (Schruppgeometrie, 3-schneidig)',
 reason: 'Schruppfräser mit ungleicher Teilung: weniger Vibration bei 6m Umfangslänge. Gleiche Zeit, aber weniger Werkzeugverschleiß → Standzeit +50%.',
 timeSaving: 0
 });
 }
 });

 const totalSaving = changes.reduce((s, c) => s + (c.timeSaving || 0), 0);
 return { type: 'alt_tools', title: 'Alternative Werkzeuge', changes, totalSaving };
 }

 function generateStrategyCheck(proj, mat) {
 const changes = [];

 // Check clamping order
 if (proj.clampings?.length >= 4) {
 changes.push({
 ag: '-', field: 'strategy', label: 'Aufspannreihenfolge',
 before: proj.clampings.length + ' Aufspannungen',
 after: 'Reihenfolge bestätigt',
 reason: '4 Aufspannungen für 2095×500×190mm ist Standard. Unterseite → Oberseite → Stirnseiten = richtige Reihenfolge. Referenzfläche (US) wird zuerst hergestellt → alle weiteren Maße beziehen sich darauf. ✓ Korrekt.',
 timeSaving: 0
 });
 }

 // Check tolerance strategy
 const hasH7 = proj.operations.some(op => op.detail?.includes('H7'));
 if (hasH7) {
 changes.push({
 ag: 30, field: 'strategy', label: 'H7-Bohrungen Strategie',
 before: 'Zentrierung + Bohren + Senken',
 after: 'Zentrierung + Bohren + Reiben (H7)',
 reason: 'Für H7-Passungen: Aufbohren allein erreicht IT8-IT9. Für H7 (IT7) ist Reiben Pflicht. Prüfen ob Reibahlen Ø16 H7 und Ø10 H7 verfügbar sind. Zeitaufschlag: +1 min pro Bohrung = +12 min gesamt.',
 timeSaving: -12
 });
 }

 // Check tool changes
 const toolChanges = new Set(proj.operations.map(o => o.tool)).size;
 changes.push({
 ag: '-', field: 'strategy', label: 'Werkzeugwechsel',
 before: toolChanges + ' verschiedene Werkzeuge',
 after: toolChanges + ' Werkzeuge (optimal: ≤8)',
 reason: toolChanges <= 8
 ? `${toolChanges} Werkzeuge im Magazin = kein Problem für Standard-CNC (20-40 Plätze). Werkzeugwechselzeit ca. ${toolChanges * 0.3} min gesamt — vernachlässigbar. ✓`
 : `${toolChanges} Werkzeuge = hohes Wechselaufkommen. Werkzeuge nach Verwendungsreihenfolge im Magazin anordnen.`,
 timeSaving: 0
 });

 // Overall assessment
 const totalTime = proj.operations.reduce((s, o) => s + o.time, 0);
 const setupTime = proj.clampings?.reduce((s, c) => s + c.time, 0) || 0;
 changes.push({
 ag: '-', field: 'strategy', label: 'Gesamtbewertung',
 before: `${totalTime} min Bearbeitung + ${setupTime} min Rüsten`,
 after: 'Strategie plausibel',
 reason: `Verhältnis Rüsten/Bearbeitung: ${(setupTime/totalTime*100).toFixed(0)}% — ${setupTime/totalTime < 0.4 ? 'akzeptabel' : 'hoch, Vorrichtung prüfen'}. Gesamtzeit ${((totalTime+setupTime)/60).toFixed(1)}h/Stück liegt im erwarteten Bereich für ein Bauteil dieser Größe (1.562 kg). ✓ Bearbeitungsstrategie ist plausibel.`,
 timeSaving: 0
 });

 const totalSaving = changes.reduce((s, c) => s + (c.timeSaving || 0), 0);
 return { type: 'check_strategy', title: 'Strategie-Prüfung', changes, totalSaving };
 }

 function generateTimeReduction(proj, mat) {
 const changes = [];

 // Combine operations
 if (proj.operations.some(o => o.nr === 80) && proj.operations.some(o => o.nr === 90)) {
 changes.push({
 ag: '80+90', field: 'strategy', label: 'Stirnseiten zusammenlegen',
 before: 'AG 80 (40 min) + AG 90 (57 min) = separate Aufspannungen',
 after: 'Drehvorrichtung: beide Stirnseiten in 1 Aufspannung',
 reason: 'Mit Drehvorrichtung (180°-Wende auf Maschinentisch) können beide Stirnseiten ohne Umspannen bearbeitet werden. Spart Aufspannung 4 komplett (37 min Rüsten). Investition: EUR 800-1.500 für Vorrichtung. Bei 4 Stück: ROI nach 2 Stück.',
 timeSaving: 37
 });
 }

 // Parallel operations
 if (proj.operations.some(o => o.name.includes('Entgraten'))) {
 changes.push({
 ag: 100, field: 'strategy', label: 'Entgraten parallel',
 before: '68 min Entgraten (Handarbeit, blockiert CNC)',
 after: 'Entgraten parallel zur nächsten CNC-Bearbeitung',
 reason: 'Entgraten ist Handarbeit — kann parallel laufen während die CNC das nächste Teil bearbeitet. Bei 4 Stück: ab Teil 2 läuft Entgraten parallel. Effektive Einsparung: 3 × 68 min = 204 min Durchlaufzeit.',
 timeSaving: 0 // per piece same, but throughput better
 });
 }

 // Reduce quality time
 const qualOp = proj.operations.find(o => o.name.includes('Qualität'));
 if (qualOp && qualOp.time > 40) {
 changes.push({
 ag: qualOp.nr, field: 'time', label: 'Qualitätsprüfung optimieren',
 before: qualOp.time + ' min (Vollmessung)',
 after: '35 min (Stichprobe ab Teil 2)',
 reason: `Teil 1: Vollmessung (${qualOp.time} min). Ab Teil 2: Nur Schlüsselmaße prüfen (H7-Bohrungen, Kontrollmaße 1508/1400, Parallelität). Stichproben-Messung: 35 min. Einsparung: ${qualOp.time - 35} min × 3 Teile = ${(qualOp.time-35)*3} min.`,
 timeSaving: Math.round((qualOp.time - 35) * 3 / 4) // averaged per piece
 });
 }

 // Tool path optimization
 changes.push({
 ag: '-', field: 'strategy', label: 'Verfahrweg-Optimierung',
 before: 'Standard-Bahnen (linear)',
 after: 'Trochoidal / HPC-Strategie für Taschen',
 reason: 'Trochoidales Fräsen bei Taschen: Höherer vf bei geringerem ae. Besonders effektiv bei tiefen Taschen (t=50mm). Geschätzte Zeitersparnis: 10-15% bei AG 50. Ca. 5-7 min.',
 timeSaving: 6
 });

 const totalSaving = changes.reduce((s, c) => s + (c.timeSaving || 0), 0);
 return { type: 'reduce_time', title: 'Zeitoptimierung', changes, totalSaving };
 }

 function showAiSuggestion(suggestion) {
 const panel = document.getElementById('aiSuggestionPanel');
 const content = document.getElementById('aiSuggestionContent');
 if (!panel || !content) return;

 let html = `<div style="font-weight:600; font-size:15px; margin-bottom:8px;">${suggestion.title}</div>`;

 if (suggestion.totalSaving > 0) {
 html += `<div style="background:rgba(40,167,69,0.1); padding:8px 12px; border-radius:var(--radius); margin-bottom:12px; font-size:13px;">
 Zeit: <strong>Geschätzte Gesamteinsparung: ${suggestion.totalSaving} min/Stück</strong>
 (= EUR ${((suggestion.totalSaving/60) * 70).toFixed(0)}/Stück bei €70/h CNC)
 </div>`;
 } else if (suggestion.totalSaving < 0) {
 html += `<div style="background:rgba(220,53,69,0.1); padding:8px 12px; border-radius:var(--radius); margin-bottom:12px; font-size:13px;">
 <span style="color:#f9a825;font-weight:700">!</span> <strong>Zusätzliche Zeit: ${Math.abs(suggestion.totalSaving)} min/Stück</strong> — aber nötig für Qualität
 </div>`;
 }

 html += '<div style="display:flex; flex-direction:column; gap:10px;">';
 suggestion.changes.forEach((c, i) => {
 const savingBadge = c.timeSaving > 0
 ? `<span style="background:#28a745;color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:6px;">-${c.timeSaving} min</span>`
 : c.timeSaving < 0
 ? `<span style="background:#dc3545;color:#fff;padding:1px 6px;border-radius:8px;font-size:10px;margin-left:6px;">+${Math.abs(c.timeSaving)} min</span>`
 : '';

 html += `<div style="padding:10px; background:var(--color-bg-subtle); border-radius:var(--radius); border-left:2px solid var(--color-primary);">
 <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;">
 <strong style="font-size:13px;">AG ${c.ag} — ${c.label}</strong>${savingBadge}
 </div>
 ${c.before !== '-' ? `<div style="font-size:12px; margin-bottom:4px;">
 <span style="color:var(--color-text-muted);">Vorher:</span> <code style="background:rgba(220,53,69,0.1);padding:1px 4px;border-radius:2px;font-size:11px;">${c.before}</code>
 </div>
 <div style="font-size:12px; margin-bottom:4px;">
 <span style="color:var(--color-text-muted);">Nachher:</span> <code style="background:rgba(40,167,69,0.1);padding:1px 4px;border-radius:2px;font-size:11px;">${c.after}</code>
 </div>` : ''}
 <div style="font-size:12px; color:var(--color-text-secondary); line-height:1.5;">${c.reason}</div>
 </div>`;
 });
 html += '</div>';

 content.innerHTML = html;
 panel.style.display = 'block';
 panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
 }

 function acceptAiSuggestion() {
 if (!pendingSuggestion) return;

 // Log all changes
 pendingSuggestion.changes.forEach(c => {
 if (c.field === 'info') return;
 aiChangeHistory.push({
 timestamp: new Date().toLocaleString('de-DE'),
 type: pendingSuggestion.type,
 ag: c.ag,
 label: c.label,
 before: c.before,
 after: c.after,
 reason: c.reason,
 status: 'übernommen'
 });
 });

 updateAiChangeLog();
 document.getElementById('aiSuggestionPanel').style.display = 'none';
 pendingSuggestion = null;

 // Show confirmation
 const panel = document.getElementById('aiSuggestionPanel');
 panel.style.display = 'block';
 document.getElementById('aiSuggestionContent').innerHTML = `
 <div style="text-align:center; padding: var(--space-4);">
 <div style="font-size:32px; margin-bottom:8px;"><span style="color:#4caf50;font-weight:700">✓</span></div>
 <div style="font-weight:600;">Änderungen übernommen und protokolliert</div>
 <div style="font-size:12px; color:var(--color-text-muted); margin-top:4px;">${aiChangeHistory.length} Änderung(en) im Protokoll</div>
 </div>`;
 setTimeout(() => { panel.style.display = 'none'; }, 2000);
 }

 function rejectAiSuggestion() {
 if (!pendingSuggestion) return;

 // Log rejection
 aiChangeHistory.push({
 timestamp: new Date().toLocaleString('de-DE'),
 type: pendingSuggestion.type,
 ag: '-',
 label: pendingSuggestion.title,
 before: '-',
 after: '-',
 reason: 'Vom AV verworfen',
 status: 'verworfen'
 });

 updateAiChangeLog();
 document.getElementById('aiSuggestionPanel').style.display = 'none';
 pendingSuggestion = null;
 }

 function updateAiChangeLog() {
 const log = document.getElementById('aiChangeLog');
 const content = document.getElementById('aiChangeLogContent');
 const count = document.getElementById('aiChangeCount');
 if (!log || !content) return;

 if (aiChangeHistory.length === 0) { log.style.display = 'none'; return; }
 log.style.display = 'block';
 count.textContent = aiChangeHistory.length;

 let html = '<table style="width:100%;border-collapse:collapse;">';
 html += '<tr style="border-bottom:1px solid var(--color-border);"><th style="text-align:left;padding:3px 6px;font-size:11px;">Zeit</th><th style="text-align:left;padding:3px 6px;font-size:11px;">AG</th><th style="text-align:left;padding:3px 6px;font-size:11px;">Änderung</th><th style="text-align:left;padding:3px 6px;font-size:11px;">Status</th></tr>';
 aiChangeHistory.forEach(c => {
 const statusColor = c.status === 'übernommen' ? '#28a745' : '#dc3545';
 html += `<tr style="border-bottom:1px solid var(--color-border);">
 <td style="padding:3px 6px;font-size:11px;color:var(--color-text-muted);">${c.timestamp}</td>
 <td style="padding:3px 6px;font-size:11px;">${c.ag}</td>
 <td style="padding:3px 6px;font-size:11px;">${c.label}</td>
 <td style="padding:3px 6px;font-size:11px;color:${statusColor};font-weight:600;">${c.status}</td>
 </tr>`;
 });
 html += '</table>';
 content.innerHTML = html;
 }

 // ================================================================
 // NACHKALKULATION — Dynamische Soll-Ist-Tabelle
 // ================================================================

 function renderFeedbackOps() {
 const proj = currentProject;
 const tbody = document.getElementById('feedbackOpsTable');
 const tfoot = document.getElementById('feedbackOpsFoot');
 if (!tbody) return;

 if (!proj?.operations) {
 tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--color-text-muted);padding:16px;">Kein Bauteil mit Operationen ausgewählt</td></tr>';
 tfoot.innerHTML = '';
 return;
 }

 const selectOpts = `<option value="">—</option><option value="einrichtung">Einrichtung</option><option value="werkzeug">Werkzeug</option><option value="material">Material</option><option value="toleranz">Toleranz</option><option value="nc">NC-Programm</option><option value="sonstiges">Sonstiges</option>`;

 let html = '';
 let totalSoll = 0;
 proj.operations.forEach(op => {
 totalSoll += op.time;
 html += `<tr>
 <td class="mono">AG ${op.nr}</td>
 <td>${op.name}</td>
 <td class="mono right">${op.time} min</td>
 <td><input type="number" class="input input-sm input-mono" style="width:70px;" step="0.1" data-soll="${op.time}" onchange="updateFeedbackDelta(this)"></td>
 <td class="mono right" data-delta>—</td>
 <td><select class="input input-sm" style="width:130px;">${selectOpts}</select></td>
 <td><input type="text" class="input input-sm" placeholder=""></td>
 </tr>`;
 });
 tbody.innerHTML = html;

 // Setup row + total
 const setupTime = proj.operations.reduce((s, o) => s + (o.setup || 0), 0) || Math.round(totalSoll * 0.33);
 const totalKalk = totalSoll + setupTime;

 tfoot.innerHTML = `<tr>
 <td colspan="2">Rüsten gesamt</td>
 <td class="mono right" id="fbSetupSoll">${setupTime} min</td>
 <td><input type="number" class="input input-sm input-mono" style="width:70px;" id="fbSetupIst" step="1" data-soll="${setupTime}" onchange="updateFeedbackTotals()"></td>
 <td class="mono right" id="fbSetupDelta">—</td>
 <td><select class="input input-sm" style="width:130px;" id="fbSetupGrund">
 <option value="">—</option><option value="fraeskanten">Fräskanten</option><option value="ausrichten">Ausrichten</option><option value="nullpunkt">Nullpunkt</option><option value="spannung">Spannung</option><option value="sonstiges">Sonstiges</option>
 </select></td>
 <td><input type="text" class="input input-sm" id="fbSetupNotiz" placeholder=""></td>
 </tr>
 <tr style="background:var(--color-primary);color:white;">
 <td colspan="2">GESAMT</td>
 <td class="mono right">${totalKalk} min</td>
 <td class="mono right" id="fbGesamtIst">— min</td>
 <td class="mono right" id="fbGesamtDelta">—</td>
 <td colspan="2"></td>
 </tr>`;

 // Update summary card
 const opsCount = proj.operations.length;
 const el = document.getElementById('fbSummaryOps');
 if (el) el.textContent = '0 / ' + opsCount;
 }

 function updateFeedbackTotals() {
 const rows = document.querySelectorAll('#feedbackOpsTable tr');
 let totalSoll = 0, totalIst = 0, filled = 0;
 rows.forEach(row => {
 const input = row.querySelector('input[type=number]');
 if (!input) return;
 const soll = parseFloat(input.dataset.soll) || 0;
 totalSoll += soll;
 if (input.value) { totalIst += parseFloat(input.value); filled++; }
 });
 // Add setup
 const setupIst = parseFloat(document.getElementById('fbSetupIst')?.value) || 0;
 const setupSoll = parseFloat(document.getElementById('fbSetupIst')?.dataset?.soll) || 0;
 if (setupIst) { totalIst += setupIst; totalSoll += setupSoll; }
 else { totalSoll += setupSoll; }

 // Update setup delta
 if (setupIst) {
 const d = setupIst - setupSoll;
 const el = document.getElementById('fbSetupDelta');
 if (el) { el.textContent = (d >= 0 ? '+' : '') + d.toFixed(0) + ' min'; el.style.color = d > 0 ? 'var(--color-error)' : 'var(--color-success)'; }
 }

 // Update totals
 const gesamtIst = document.getElementById('fbGesamtIst');
 const gesamtDelta = document.getElementById('fbGesamtDelta');
 if (totalIst > 0 && gesamtIst) {
 gesamtIst.textContent = totalIst.toFixed(0) + ' min';
 const d = totalIst - totalSoll;
 if (gesamtDelta) { gesamtDelta.textContent = (d >= 0 ? '+' : '') + d.toFixed(0) + ' min'; gesamtDelta.style.color = d > 0 ? 'var(--color-error)' : 'var(--color-success)'; }
 }

 // Summary cards
 const opsCount = rows.length;
 const elOps = document.getElementById('fbSummaryOps');
 if (elOps) elOps.textContent = filled + ' / ' + opsCount;

 const elDelta = document.getElementById('fbSummaryDelta');
 if (elDelta && totalIst > 0) {
 const d = totalIst - totalSoll;
 const pct = ((d / totalSoll) * 100).toFixed(0);
 elDelta.textContent = (d >= 0 ? '+' : '') + d.toFixed(0) + ' min (' + (d >= 0 ? '+' : '') + pct + '%)';
 elDelta.style.color = d > 0 ? 'var(--color-error)' : 'var(--color-success)';
 }

 const rate = parseFloat(document.getElementById('rateCNC')?.value) || 70;
 const elCost = document.getElementById('fbSummaryCost');
 if (elCost && totalIst > 0) {
 const d = (totalIst - totalSoll) / 60 * rate;
 elCost.textContent = (d >= 0 ? '+' : '') + 'EUR ' + d.toFixed(2);
 elCost.style.color = d > 0 ? 'var(--color-error)' : 'var(--color-success)';
 }
 }

 // ================================================================
 // WERKZEUGE — Dynamische Tabelle aus Operationsplan
 // ================================================================

 function renderToolsFromProject() {
 const proj = currentProject;
 const paramsBody = document.getElementById('cuttingParamsBody');
 const usageBody = document.getElementById('toolUsageBody');

 if (!proj?.operations) {
 if (paramsBody) paramsBody.innerHTML = '<tr><td colspan="4" style="color:var(--color-text-muted);text-align:center;padding:16px;">Kein Bauteil mit Operationen ausgewählt</td></tr>';
 if (usageBody) usageBody.innerHTML = '<tr><td colspan="5" style="color:var(--color-text-muted);text-align:center;padding:16px;">—</td></tr>';
 return;
 }

 // Schnittparameter table
 if (paramsBody) {
 let html = '';
 proj.operations.forEach(op => {
 html += `<tr>
 <td><strong>${op.tool || '—'}</strong></td>
 <td>AG ${op.nr}: ${op.name}</td>
 <td class="right mono">${op.params || '—'}</td>
 <td class="right mono">${op.time} min</td>
 </tr>`;
 });
 // Summary row
 const totalTime = proj.operations.reduce((s, o) => s + o.time, 0);
 html += `<tr style="background:var(--color-bg-subtle);font-weight:600;">
 <td colspan="3">Σ Bearbeitungszeit</td>
 <td class="right mono">${totalTime} min</td>
 </tr>`;
 paramsBody.innerHTML = html;
 }

 // Werkzeugeinsatz table — extract unique tools
 if (usageBody) {
 const tools = {};
 proj.operations.forEach(op => {
 if (!op.tool) return;
 const key = op.tool.split(' ')[0]; // T1, T2, etc.
 if (!tools[key]) tools[key] = { name: op.tool, time: 0, ops: [] };
 tools[key].time += op.time;
 tools[key].ops.push(op.name);
 });

 let html = '';
 let totalTime = 0;
 Object.values(tools).forEach(t => {
 totalTime += t.time;
 html += `<tr>
 <td>${t.name}</td>
 <td class="right mono">—</td>
 <td class="right mono">—</td>
 <td class="right mono">${t.time} min</td>
 <td class="right mono">—</td>
 </tr>`;
 });
 html += `<tr style="background:var(--color-bg-subtle);font-weight:600;">
 <td>Gesamt</td><td class="right mono">—</td><td class="right mono">—</td>
 <td class="right mono">${totalTime} min</td><td class="right mono">—</td>
 </tr>`;
 usageBody.innerHTML = html;
 }
 }

 // ================================================================
 // MASTER PROTOCOL — Gesamtprotokoll
 // ================================================================

 function updateMasterProtocol() {
 const container = document.getElementById('masterProtocolContent');
 if (!container) return;

 const proj = currentProject;
 const mat = MATERIALS[document.getElementById('materialSelect')?.value];
 const now = new Date().toLocaleString('de-DE');
 let html = '';

 // Section 1: Bauteil-Grunddaten
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid var(--color-primary); margin-bottom:8px;">1. Bauteil-Grunddaten</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += `<tr><td style="padding:3px 8px;width:35%;color:var(--color-text-muted);">Bauteil</td><td style="padding:3px 8px;font-weight:600;">${proj?.name || '—'} (${proj?.partNumber || '—'})</td></tr>`;
 html += `<tr><td style="padding:3px 8px;color:var(--color-text-muted);">Quelle</td><td style="padding:3px 8px;">${proj?.source || '—'}</td></tr>`;
 html += `<tr><td style="padding:3px 8px;color:var(--color-text-muted);">Abmessungen</td><td style="padding:3px 8px;">${document.getElementById('dimX')?.value || '—'} × ${document.getElementById('dimY')?.value || '—'} × ${document.getElementById('dimZ')?.value || '—'} mm</td></tr>`;
 html += `<tr><td style="padding:3px 8px;color:var(--color-text-muted);">Werkstoff</td><td style="padding:3px 8px;">${mat?.name || '—'}</td></tr>`;
 html += `<tr><td style="padding:3px 8px;color:var(--color-text-muted);">Stückzahl</td><td style="padding:3px 8px;">${document.getElementById('quantity')?.value || '—'}</td></tr>`;
 html += '</table></div>';

 // Section 2: Prüfprotokoll-Antworten
 const answered = CHECKLIST_QUESTIONS.filter(q => q.condition(proj) && checklistAnswers[q.id] && checklistAnswers[q.id] !== '');
 if (answered.length > 0) {
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid var(--color-primary); margin-bottom:8px;">2. Prüfprotokoll — Eingaben</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += '<tr style="background:var(--color-bg-subtle);"><th style="padding:4px 8px;text-align:left;">Prüfpunkt</th><th style="padding:4px 8px;text-align:left;">Eingabe</th><th style="padding:4px 8px;text-align:left;">Auswirkung</th></tr>';
 answered.forEach(q => {
 const val = checklistAnswers[q.id];
 let displayVal = val;
 if (q.type === 'select') { const opt = q.options.find(o => o.value === val); displayVal = opt?.label || val; }
 else if (q.unit) displayVal = val + ' ' + q.unit;
 const effect = q.effect ? q.effect(val) : '';
 html += `<tr style="border-bottom:1px solid var(--color-border);"><td style="padding:4px 8px;">${q.label}</td><td style="padding:4px 8px;font-weight:600;">${displayVal}</td><td style="padding:4px 8px;color:var(--color-text-muted);font-size:11px;">${effect}</td></tr>`;
 });
 html += '</table></div>';
 }

 // Section 3: Abweichungen von KI-Empfehlung
 if (checklistDeviations.length > 0) {
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid #fd7e14; margin-bottom:8px; color:#fd7e14;">3. Abweichungen von KI-Empfehlung</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += '<tr style="background:#fff3e0;"><th style="padding:4px 8px;text-align:left;">Prüfpunkt</th><th style="padding:4px 8px;text-align:left;">KI empfahl</th><th style="padding:4px 8px;text-align:left;">Nutzereingabe</th></tr>';
 checklistDeviations.forEach(d => {
 const q = CHECKLIST_QUESTIONS.find(qq => qq.id === d.id);
 let aiLabel = d.aiRecommendation, userLabel = d.userChoice;
 if (q?.type === 'select') { aiLabel = q.options.find(o => o.value === d.aiRecommendation)?.label || aiLabel; userLabel = q.options.find(o => o.value === d.userChoice)?.label || userLabel; }
 html += `<tr style="border-bottom:1px solid var(--color-border);"><td style="padding:4px 8px;">${d.label}</td><td style="padding:4px 8px;color:var(--color-text-muted);">${aiLabel}</td><td style="padding:4px 8px;font-weight:600;">${userLabel}</td></tr>`;
 });
 html += '</table></div>';
 }

 // Section 4: Preisempfehlungen & Entscheidungen
 if (pricingDecisions.length > 0) {
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid var(--color-primary); margin-bottom:8px;">4. Preisanpassungen</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += '<tr style="background:var(--color-bg-subtle);"><th style="padding:4px 8px;text-align:left;">Zeit</th><th style="padding:4px 8px;text-align:left;">Anpassung</th><th style="padding:4px 8px;text-align:left;">Begründung</th><th style="padding:4px 8px;text-align:left;">Status</th></tr>';
 pricingDecisions.forEach(d => {
 html += `<tr style="border-bottom:1px solid var(--color-border);"><td style="padding:4px 8px;color:var(--color-text-muted);font-size:11px;">${d.timestamp}</td><td style="padding:4px 8px;font-weight:600;">${d.type} ${d.adjustment}</td><td style="padding:4px 8px;font-size:11px;">${d.reason}</td><td style="padding:4px 8px;color:#28a745;font-weight:600;">${d.status}</td></tr>`;
 });
 html += '</table></div>';
 }

 // Section 5: KI-Änderungen (Fertigungsanweisung)
 if (aiChangeHistory.length > 0) {
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid var(--color-primary); margin-bottom:8px;">5. KI-Änderungen (Fertigungsoptimierung)</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += '<tr style="background:var(--color-bg-subtle);"><th style="padding:4px 8px;text-align:left;">Zeit</th><th style="padding:4px 8px;text-align:left;">AG</th><th style="padding:4px 8px;text-align:left;">Änderung</th><th style="padding:4px 8px;text-align:left;">Status</th></tr>';
 aiChangeHistory.forEach(c => {
 const col = c.status === 'übernommen' ? '#28a745' : '#dc3545';
 html += `<tr style="border-bottom:1px solid var(--color-border);"><td style="padding:4px 8px;color:var(--color-text-muted);font-size:11px;">${c.timestamp}</td><td style="padding:4px 8px;">AG ${c.ag}</td><td style="padding:4px 8px;">${c.label}</td><td style="padding:4px 8px;color:${col};font-weight:600;">${c.status}</td></tr>`;
 });
 html += '</table></div>';
 }

 // Section 6: Kalkulations-Zusammenfassung
 const priceEl = document.getElementById('sellPrice');
 const totalEl = document.getElementById('orderTotal');
 if (priceEl) {
 html += '<div style="margin-bottom:16px;"><div style="font-weight:700; font-size:14px; padding:6px 0; border-bottom:2px solid var(--color-primary); margin-bottom:8px;">6. Kalkulations-Ergebnis</div>';
 html += '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
 html += `<tr><td style="padding:4px 8px;color:var(--color-text-muted);">Angebotspreis/Stück</td><td style="padding:4px 8px;font-weight:700;font-size:14px;">${priceEl.textContent}</td></tr>`;
 if (totalEl) html += `<tr><td style="padding:4px 8px;color:var(--color-text-muted);">Auftragswert</td><td style="padding:4px 8px;font-weight:700;font-size:14px;">${totalEl.textContent}</td></tr>`;
 html += `<tr><td style="padding:4px 8px;color:var(--color-text-muted);">Erstellt</td><td style="padding:4px 8px;">${now}</td></tr>`;
 html += `<tr><td style="padding:4px 8px;color:var(--color-text-muted);">Klassifizierung</td><td style="padding:4px 8px;color:#dc3545;font-weight:600;">INTERN — Nicht an Kunden weitergeben</td></tr>`;
 html += '</table></div>';
 }

 if (!answered.length && !pricingDecisions.length && !aiChangeHistory.length && !proj) {
 html = '<div style="color:var(--color-text-muted); font-style:italic;">Noch keine Eingaben dokumentiert. Wählen Sie ein Bauteil und füllen Sie das Prüfprotokoll aus.</div>';
 }

 container.innerHTML = html;
 }

 function exportMasterProtocol() {
 updateMasterProtocol();
 const content = document.getElementById('masterProtocolContent')?.innerHTML;
 if (!content) return;
 const proj = currentProject;
 const w = window.open('', '_blank');
 w.document.write(`<html><head><title>Protokoll — ${proj?.name || 'Bauteil'}</title>
 <style>body{font-family:Helvetica Neue,Arial,sans-serif;padding:30px;font-size:12px;color:#1a1a1a;}
 table{width:100%;border-collapse:collapse;margin:8px 0 16px;}th,td{padding:5px 8px;border:1px solid #e5e5e0;text-align:left;}
 th{background:#f5f5f5;font-size:11px;text-transform:uppercase;}
 h1{font-size:18px;border-bottom:3px solid #c8aa50;padding-bottom:6px;}
 .meta{font-size:11px;color:#666;margin-bottom:16px;}
 @media print{body{padding:15mm;}}</style></head>
 <body><h1>Eingabe- & Entscheidungsprotokoll</h1>
 <div class="meta">${proj?.name || '—'} — ${proj?.partNumber || ''} — ${new Date().toLocaleDateString('de-DE')} — INTERN</div>
 ${content}
 <div style="margin-top:30px;font-size:10px;color:#999;border-top:1px solid #e5e5e0;padding-top:8px;">
 CNC Planer Pro · ${new Date().toLocaleString('de-DE')} · Automatisch generiert
 </div></body></html>`);
 w.document.close();
 w.print();
 }

 function copyProtocolToClipboard() {
 const el = document.getElementById('masterProtocolContent');
 if (!el) return;
 const text = el.innerText;
 navigator.clipboard.writeText(text).then(() => {
 alert('Protokoll in Zwischenablage kopiert.');
 });
 }

 // ================================================================
 // FILE UPLOAD & ANALYSIS
 // ================================================================

 function handleFileUpload(input) {
 if (!input.files || !input.files[0]) return;
 const file = input.files[0];
 const name = file.name;
 const ext = name.split('.').pop().toLowerCase();

 const progress = document.getElementById('uploadProgress');
 const bar = document.getElementById('uploadBar');
 const status = document.getElementById('uploadStatus');
 const steps = document.getElementById('uploadSteps');
 progress.style.display = 'block';

 const analysisSteps = [
 { pct: 10, text: 'Datei einlesen...', delay: 300 },
 { pct: 25, text: 'Zeichnung erkennen — Maße, Toleranzen, Werkstoff...', delay: 1200 },
 { pct: 45, text: 'Geometrie analysieren — Konturen, Bohrungen, Taschen...', delay: 1500 },
 { pct: 65, text: 'Bearbeitungsstrategie vorschlagen...', delay: 1200 },
 { pct: 80, text: 'Zeiten ermitteln (REFA-basiert)...', delay: 1000 },
 { pct: 95, text: 'Vorkalkulation erstellen...', delay: 800 },
 { pct: 100, text: '✓ Analyse abgeschlossen!', delay: 500 }
 ];

 let stepIdx = 0;
 function nextStep() {
 if (stepIdx >= analysisSteps.length) {
 // Analysis complete — show result
 setTimeout(() => {
 progress.style.display = 'none';
 bar.style.width = '0%';
 input.value = '';
 showUploadResult(name, ext);
 }, 600);
 return;
 }
 const s = analysisSteps[stepIdx];
 bar.style.width = s.pct + '%';
 status.textContent = s.text;
 steps.innerHTML += `<div>${s.text}</div>`;
 stepIdx++;
 setTimeout(nextStep, s.delay);
 }
 nextStep();
 }

 function showUploadResult(filename, ext) {
 // For now: show info that AI analysis would happen here
 // In production: this would call an API to analyze the PDF/STEP
 const isPdf = ext === 'pdf';
 const isStep = ['step', 'stp'].includes(ext);

 let msg = `Datei "${filename}" wurde analysiert.\n\n`;
 if (isPdf) {
 msg += 'PDF-Zeichnung erkannt.\n';
 msg += '→ In der Vollversion: Automatische Extraktion von Maßen, Toleranzen, Werkstoff und Stückliste.\n';
 msg += '→ Demo: Bitte Werte manuell eingeben oder ein Beispiel-Bauteil wählen.';
 } else if (isStep) {
 msg += 'STEP-Datei erkannt.\n';
 msg += '→ In der Vollversion: Exakte Volumenberechnung, Feature-Erkennung (Taschen, Bohrungen, Konturen).\n';
 msg += '→ Demo: Bitte Werte manuell eingeben oder ein Beispiel-Bauteil wählen.';
 } else {
 msg += 'Dateiformat wird in der Vollversion unterstützt.\n';
 msg += '→ Demo: Bitte Werte manuell eingeben.';
 }

 alert(msg);

 // Scroll to manual input
 const config = document.getElementById('werkstuckConfig');
 if (config) config.scrollIntoView({ behavior: 'smooth', block: 'start' });
 }

 // ================================================================
 // CALCULATION
 // ================================================================
 
 function calculate() {
 // Update Prüfprotokoll hint
 const hint = document.getElementById('checklistHint');
 if (hint) hint.style.display = checklistCompleted ? 'none' : 'flex';
 
 const mat = DB.materials[document.getElementById('materialSelect').value];
 const x = parseFloat(document.getElementById('dimX').value) || 100;
 const y = parseFloat(document.getElementById('dimY').value) || 100;
 const z = parseFloat(document.getElementById('dimZ').value) || 20;
 const qty = parseInt(document.getElementById('quantity').value) || 1;
 // marginInput is now hidden, synced from zuschlagGewinn
 const margin = DB.zuschlaege.gewinn;
 { const _e = document.getElementById('marginInput'); if(_e) _e.value = margin; }
 const scrap = DB.zuschlaege.verschnitt;
 // Werkzeugkosten entfallen — bei KMU im Maschinenstundensatz enthalten
 const toolWear = 0;
 const vat = DB.zuschlaege.vat;
 
 // Clamping — from editable table
 const totalSetupTime = getClampingTotalTime();
 const clampingType = document.getElementById('clampingSelect')?.value || 'schraubstock';
 const clampingData = DB.clamping[clampingType] || DB.clamping.schraubstock;
 const setupCount = document.getElementById('clampingRows')?.rows.length || 2;
 
 // Rates (from DB)
 const cncRate = DB.rates.cnc.labor + DB.rates.cnc.machine;
 const entgratenRate = DB.rates.entgraten.labor + DB.rates.entgraten.machine;
 const saegenRate = DB.rates.saegen.labor + DB.rates.saegen.machine;
 
 // Setup cost
 const setupCost = (totalSetupTime / 60) * cncRate;
 const setupCostPerPiece = setupCost / qty;
 
 // Volume & Weight
 const volumeMm3 = x * y * z;
 const volumeCm3 = volumeMm3 / 1000;
 const weightKg = (volumeCm3 * mat.density) / 1000;
 
 // Material cost
 const materialCost = currentProject?.materialCostFixed ? currentProject.materialCostFixed : weightKg * mat.price * (1 + scrap / 100);
 
 // Machining time & cost — use operations if defined, else formula
 let machiningTime, machineCost;
 let additionalCost = 0;
 let additionalDesc = [];

 if (currentProject?.operations && currentProject.operations.length > 0) {
 // Operations-based: sum up all ops with their respective rates (from DB)
 machiningTime = 0;
 machineCost = 0;
 currentProject.operations.forEach(op => {
 const opRates = DB.rates[op.rate] || DB.rates.cnc;
 const opRate = opRates.labor + opRates.machine;
 machiningTime += op.time;
 machineCost += (op.time / 60) * opRate;
 });
 // Additional ops are INCLUDED in operations — don't double-count
 } else {
 // Formula-based (legacy)
 const refVolume = currentProject ? (currentProject.dims.x * currentProject.dims.y * currentProject.dims.z) / 1000 : 440;
 const baseTime = currentProject ? currentProject.baseTime : 12.5;
 const sizeFactor = volumeCm3 / refVolume;
 machiningTime = baseTime * Math.pow(sizeFactor, 0.7) * mat.timeFactor;
 machineCost = (machiningTime / 60) * cncRate;

 // Additional operations (only for formula-based, not ops-based)
 if (document.getElementById('opEntgraten')?.checked) {
 const t = parseFloat(document.getElementById('opEntgratenTime')?.value) || 5;
 additionalCost += (t / 60) * entgratenRate;
 additionalDesc.push('Entgraten ' + t + ' min');
 }
 if (document.getElementById('opSaegen')?.checked) {
 const t = parseFloat(document.getElementById('opSaegenTime')?.value) || 3;
 additionalCost += (t / 60) * saegenRate;
 additionalDesc.push('Sägen ' + t + ' min');
 }
 if (document.getElementById('opPruefung')?.checked) {
 const t = parseFloat(document.getElementById('opPruefungTime')?.value) || 5;
 additionalCost += (t / 60) * cncRate;
 additionalDesc.push('Prüfung ' + t + ' min');
 }
 }
 
 // Tool cost
 const toolCost = toolWear * mat.timeFactor;
 
 // ================================================================
 // ZUSCHLAGSKALKULATION (Industriestandard)
 // ================================================================
 
 // Zuschlagssätze aus DB (Single Source of Truth)
 const zuschlagMGK = DB.zuschlaege.mgk;
 const zuschlagAV = DB.zuschlaege.av;
 const zuschlagVwGK = DB.zuschlaege.vwgk;
 const zuschlagVtGK = DB.zuschlaege.vtgk;
 const zuschlagGewinn = DB.zuschlaege.gewinn;
 
 // 1. Materialkosten + MGK
 const materialMitGK = materialCost * (1 + zuschlagMGK / 100);
 
 // 2. Fertigungskosten (Maschine + Rüsten + Nebenzeiten)
 const fertigungskosten = machineCost + setupCostPerPiece + additionalCost;
 
 // 3. Fertigungskosten + AV-Aufschlag
 const fertigungMitAV = fertigungskosten * (1 + zuschlagAV / 100);
 
 // 4. HERSTELLKOSTEN (HK)
 const herstellkosten = materialMitGK + fertigungMitAV + toolCost;
 
 // 5. + Verwaltungs-GK + Vertriebs-GK = SELBSTKOSTEN (SK)
 const vwGKBetrag = herstellkosten * (zuschlagVwGK / 100);
 const vtGKBetrag = herstellkosten * (zuschlagVtGK / 100);
 const selbstkosten = herstellkosten + vwGKBetrag + vtGKBetrag;
 
 // 6. + Gewinn = ANGEBOTSPREIS
 const gewinnBetrag = selbstkosten * (zuschlagGewinn / 100);
 const angebotspreis = selbstkosten + gewinnBetrag;
 
 // Für Kompatibilität: alte Variablen updaten
 const totalCost = herstellkosten; // Herstellkosten als "Kosten"
 const marginAmount = gewinnBetrag;
 const sellPrice = angebotspreis;
 const orderTotal = sellPrice * qty;
 const mwstAmount = orderTotal * (vat / 100);
 const totalWithVat = orderTotal + mwstAmount;
 
 // Deckungsbeitrag
 const deckungsbeitrag = angebotspreis - (materialCost + fertigungskosten + toolCost);
 const dbProzent = (deckungsbeitrag / angebotspreis) * 100;
 
 // Reference volume for confidence (always defined)
 const refVolume = currentProject ? (currentProject.dims.x * currentProject.dims.y * currentProject.dims.z) / 1000 : 440;

 // Confidence
 let confidenceClass = 'confidence-medium';
 let confidenceText = ' Richtwert — Nachkalkulation empfohlen';
 if (currentProject?.operations) {
 confidenceClass = 'confidence-high';
 confidenceText = '±10% — Operationsbasierte Kalkulation';
 } else if (mat.timeFactor >1.2) {
 confidenceClass = 'confidence-low';
 confidenceText = '±25% — Schwerzerspanbarer Werkstoff';
 } else if (currentProject && Math.abs(volumeCm3 - refVolume)< refVolume * 0.2) {
 confidenceClass = 'confidence-high';
 confidenceText = '±10% — Ähnlich wie Referenzteil';
 }
 
 // Update UI — using DEFormatter for consistent EUR formatting
 document.getElementById('setupTimeDisplay').textContent = DEFormatter.time(totalSetupTime);
 document.getElementById('setupCostDisplay').textContent = DEFormatter.price(setupCost);
 
 { const _e = document.getElementById('liveWeight'); if(_e) _e.textContent = DEFormatter.weight(weightKg); }
 { const _e = document.getElementById('liveMaterial'); if(_e) _e.textContent = DEFormatter.price(materialCost); }
 { const _e = document.getElementById('liveTime'); if(_e) _e.textContent = DEFormatter.time(machiningTime); }
 { const _e = document.getElementById('liveMachine'); if(_e) _e.textContent = DEFormatter.price(machineCost); }
 
 document.getElementById('priceDisplay').textContent = DEFormatter.price(sellPrice);
 document.getElementById('confidenceBadge').className = 'confidence-badge ' + confidenceClass;
 document.getElementById('confidenceBadge').textContent = confidenceText;
 
 document.getElementById('matCost').textContent = DEFormatter.price(materialMitGK);
 document.getElementById('matFormula').textContent = DEFormatter.weight(weightKg) + ' × ' + DEFormatter.price(mat.price) + '/kg + ' + zuschlagMGK + '% MGK';
 document.getElementById('machCost').textContent = DEFormatter.price(fertigungMitAV);
 if (currentProject?.operations) {
 document.getElementById('machFormula').textContent = DEFormatter.time(machiningTime) + ' (' + currentProject.operations.length + ' AGs, gemischte Sätze) + ' + zuschlagAV + '% AV';
 } else {
 document.getElementById('machFormula').textContent = DEFormatter.time(machiningTime) + ' × EUR ' + cncRate + '/h + ' + zuschlagAV + '% AV';
 }
 const _set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
 _set('setupCost', DEFormatter.price(setupCostPerPiece));
 // Use the rate of the primary operation type for setup formula display
 const setupRateForDisplay = (currentProject?.operations && currentProject.operations.length > 0)
 ? (RATES[currentProject.operations[0].rate] || RATES.cnc).labor + (RATES[currentProject.operations[0].rate] || RATES.cnc).machine
 : cncRate;
 _set('setupFormula', DEFormatter.time(totalSetupTime) + ' × EUR ' + setupRateForDisplay + '/h ÷ ' + qty);
 _set('toolCost', DEFormatter.price(toolCost));
 _set('additionalCost', DEFormatter.price(vwGKBetrag + vtGKBetrag));
 _set('additionalFormula', zuschlagVwGK + '% VwGK + ' + zuschlagVtGK + '% VtGK');
 _set('totalCost', DEFormatter.price(selbstkosten));
 _set('marginDisplay', zuschlagGewinn);
 _set('marginCost', DEFormatter.price(gewinnBetrag));
 _set('sellPrice', DEFormatter.price(angebotspreis));
 _set('orderTotal', DEFormatter.price(orderTotal));
 
 // === COST DETAIL PANELS (transparency) ===
 const cd = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
 const cdB = (id, val) => { const el = document.getElementById(id); if(el) el.innerHTML = '<strong>' + val + '</strong>'; };
 
 // Material detail
 cd('cdMatDims', x + ' × ' + y + ' × ' + z + ' mm');
 cd('cdMatVol', Math.round(volumeCm3 * 1000).toLocaleString('de-DE') + ' mm³');
 cd('cdMatDensity', mat.name + ' / ' + mat.density.toFixed(2).replace('.',',') + ' g/cm³');
 cd('cdMatWeight', DEFormatter.weight(weightKg));
 cd('cdMatPrice', DEFormatter.price(mat.price) + '/kg');
 cd('cdMatNet', DEFormatter.price(weightKg * mat.price));
 cd('cdMatScrap', DEFormatter.price(weightKg * mat.price * scrap / 100));
 cd('cdMatMEK', DEFormatter.price(materialCost));
 cd('cdMatMGK', DEFormatter.price(materialCost * zuschlagMGK / 100));
 cdB('cdMatTotal', DEFormatter.price(materialMitGK));
 
 // Fertigung detail
 cd('cdMachTime', DEFormatter.time(machiningTime));
 if (currentProject?.operations) {
 cd('cdMachLabor', currentProject.operations.length + ' Arbeitsgänge');
 cd('cdMachRate', 'gemischte Sätze');
 cd('cdMachTotal', '→ Fertigungsanweisung');
 } else {
 cd('cdMachLabor', 'EUR ' + RATES.cnc.labor + '/h');
 cd('cdMachRate', 'EUR ' + RATES.cnc.machine + '/h');
 cd('cdMachTotal', 'EUR ' + cncRate + '/h');
 }
 cd('cdMachNet', DEFormatter.price(machineCost));
 cd('cdMachFEK', DEFormatter.price(machineCost));
 cd('cdMachAV', DEFormatter.price(machineCost * zuschlagAV / 100));
 cdB('cdMachGesamt', DEFormatter.price(fertigungMitAV));
 
 // Setup detail
 cd('cdSetupClamping', document.getElementById('clampingSelect')?.selectedOptions[0]?.text || 'Schraubstock');
 cd('cdSetupBase', DEFormatter.time(CLAMPING[document.getElementById('clampingSelect')?.value || 'schraubstock'].time));
 cd('cdSetupCount', setupCount);
 cd('cdSetupTime', DEFormatter.time(totalSetupTime));
 cd('cdSetupTotal', DEFormatter.price(setupCost));
 cd('cdSetupQty', qty);
 cdB('cdSetupPerPiece', DEFormatter.price(setupCostPerPiece));
 
 // Tool detail
 cd('cdToolFactor', mat.timeFactor.toFixed(1).replace('.',',') + '×');
 cd('cdToolTime', DEFormatter.time(machiningTime));
 cdB('cdToolTotal', DEFormatter.price(toolCost));
 cd('toolFormula', mat.timeFactor > 1 ? 'EUR 20,74 × ' + mat.timeFactor.toFixed(1).replace('.',',') + ' (Werkstoff-Faktor)' : 'Pauschale, werkstoffabhängig');
 
 // Overhead detail
 cd('cdOhHK', DEFormatter.price(herstellkosten));
 cd('cdMatMGKpct', zuschlagMGK);
 cd('cdMachAVpct', zuschlagAV);
 cd('cdOhVwGKpct', zuschlagVwGK);
 cd('cdOhVtGKpct', zuschlagVtGK);
 cd('cdOhVwGK', DEFormatter.price(vwGKBetrag));
 cd('cdOhVtGK', DEFormatter.price(vtGKBetrag));
 cdB('cdOhTotal', DEFormatter.price(vwGKBetrag + vtGKBetrag));
 
 // === DECKUNGSBEITRAGSRECHNUNG ===
 const dbMEK = materialCost; // Materialeinzelkosten (vor MGK)
 const dbFEK = machineCost; // Fertigungseinzelkosten (vor AV)
 const dbSetup = setupCostPerPiece;
 const dbDB1 = angebotspreis - dbMEK - dbFEK - dbSetup;
 const dbMGKval = materialCost * zuschlagMGK / 100;
 const dbAVval = machineCost * zuschlagAV / 100;
 const dbDB2 = dbDB1 - dbMGKval - dbAVval - toolCost;
 const dbGewinn = angebotspreis - selbstkosten;
 const dbMargePercent = angebotspreis > 0 ? (dbGewinn / angebotspreis * 100) : 0;
 
 // Per-piece column
 cd('dbAngebotspreis', DEFormatter.price(angebotspreis));
 cd('dbMEK', DEFormatter.price(dbMEK));
 cd('dbFEK', DEFormatter.price(dbFEK));
 cd('dbSetup', DEFormatter.price(dbSetup));
 cd('dbDB1', DEFormatter.price(dbDB1));
 cd('dbMGKpct', zuschlagMGK);
 cd('dbMGK', DEFormatter.price(dbMGKval));
 cd('dbAVpct', zuschlagAV);
 cd('dbAV', DEFormatter.price(dbAVval));
 cd('dbTool', DEFormatter.price(toolCost));
 cd('dbDB2', DEFormatter.price(dbDB2));
 cd('dbVwGKpct', zuschlagVwGK);
 cd('dbVwGK', DEFormatter.price(vwGKBetrag));
 cd('dbVtGKpct', zuschlagVtGK);
 cd('dbVtGK', DEFormatter.price(vtGKBetrag));
 cd('dbGewinn', DEFormatter.price(dbGewinn));
 cd('dbMarge', dbMargePercent.toFixed(1).replace('.',',') + ' %');
 
 // Order column (× qty)
 cd('dbQtyHead', qty);
 cd('dbAngebotspreis_t', DEFormatter.price(angebotspreis * qty));
 cd('dbMEK_t', DEFormatter.price(dbMEK * qty));
 cd('dbFEK_t', DEFormatter.price(dbFEK * qty));
 cd('dbSetup_t', DEFormatter.price(setupCost)); // Rüstkosten sind fix, nicht × qty
 cd('dbDB1_t', DEFormatter.price((angebotspreis - dbMEK - dbFEK) * qty - setupCost));
 cd('dbMGK_t', DEFormatter.price(dbMGKval * qty));
 cd('dbAV_t', DEFormatter.price(dbAVval * qty));
 cd('dbTool_t', DEFormatter.price(toolCost * qty));
 cd('dbDB2_t', DEFormatter.price(((angebotspreis - dbMEK - dbFEK) * qty - setupCost) - (dbMGKval + dbAVval + toolCost) * qty));
 cd('dbVwGK_t', DEFormatter.price(vwGKBetrag * qty));
 cd('dbVtGK_t', DEFormatter.price(vtGKBetrag * qty));
 const totalGewinn = dbGewinn * qty;
 cd('dbGewinn_t', DEFormatter.price(totalGewinn));
 const totalUmsatz = angebotspreis * qty;
 cd('dbMarge_t', totalUmsatz > 0 ? (totalGewinn / totalUmsatz * 100).toFixed(1).replace('.',',') + ' %' : '—');
 
 // Quantity table with full Zuschlagskalkulation
 const qtys = [1, 5, 10, 25, 50];
 const qtyEl = document.getElementById('quantityTable');
 if (qtyEl) qtyEl.innerHTML = qtys.map(q =>{
 const setupPerPiece = setupCost / q;
 const fert = machineCost + setupPerPiece + additionalCost;
 const fertMitAV = fert * (1 + zuschlagAV / 100);
 const hk = materialMitGK + fertMitAV + toolCost;
 const sk = hk * (1 + (zuschlagVwGK + zuschlagVtGK) / 100);
 const ap = sk * (1 + zuschlagGewinn / 100);
 const totalSell = ap * q;
 return `<tr>
<td class="mono">${q}</td>
<td class="right mono">${DEFormatter.price(ap)}</td>
<td class="right mono">${DEFormatter.price(totalSell)}</td>
</tr>`;
 }).join('');
 
 // Quote — handled by renderQuote() in QUOTE SECTION UPDATE below
 // Old manual quote updates removed to prevent format conflicts with DEFormatter
 
 // Detail Kalkulation Tab (section-calculation)
 const calcThEl = document.getElementById('calcTh');
 if (calcThEl) {
     document.getElementById('calcTh').textContent = DEFormatter.time(machiningTime * 0.8);
     document.getElementById('calcTn').textContent = DEFormatter.time(machiningTime * 0.2);
     document.getElementById('calcTimeTotal').textContent = DEFormatter.time(machiningTime);
     document.getElementById('calcMachCost').textContent = DEFormatter.price(machineCost);
     document.getElementById('calcRawDims').textContent = x + ' × ' + y + ' × ' + z + ' mm';
     document.getElementById('calcVolume').textContent = Math.round(volumeCm3 * 1000).toLocaleString('de-DE') + ' mm³';
     document.getElementById('calcDensity').textContent = mat.name + ' / ' + mat.density.toFixed(2).replace('.', ',') + ' g/cm³';
     document.getElementById('calcWeight').textContent = DEFormatter.weight(weightKg);
     document.getElementById('calcMatFormula').textContent = DEFormatter.price(mat.price) + '/kg × 1,1';
     document.getElementById('calcMatCost').textContent = DEFormatter.price(materialCost);
     document.getElementById('calcSetupTime').textContent = DEFormatter.time(totalSetupTime);
     document.getElementById('calcSetupCostDetail').textContent = DEFormatter.price(setupCost);
     document.getElementById('calcSetups').textContent = (document.getElementById('secondSetup')?.checked ? '2' : '1') + '×';
     document.getElementById('calcQtyDetail').textContent = qty;
     document.getElementById('calcSetupPerPiece').textContent = DEFormatter.price(setupCostPerPiece);
     
     // Gesamtkalkulation Summary Table
     const summaryBody = document.getElementById('calcSummaryBody');
     if (summaryBody) {
         const nebenzeitKosten = machineCost * 0.12; // ~12% der Maschinenkosten
         const herstellkosten = materialMitGK + fertigungMitAV + toolCost + setupCostPerPiece + nebenzeitKosten;
         summaryBody.innerHTML = `
         <tr>
             <td>Material</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">${DEFormatter.weight(weightKg)} × ${DEFormatter.price(mat.price)}/kg + ${zuschlagMGK}% MGK</td>
             <td class="right mono">${DEFormatter.price(materialMitGK)}</td>
             <td class="right mono">${DEFormatter.price(materialMitGK * qty)}</td>
         </tr>
         <tr>
             <td>Fertigung${currentProject?.operations ? ' ('+currentProject.operations.length+' AGs)' : ''}</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">${currentProject?.operations ? DEFormatter.time(machiningTime) + ' (ops-basiert)' : DEFormatter.time(machiningTime) + ' × EUR ' + cncRate + '/h'} + ${zuschlagAV}% AV</td>
             <td class="right mono">${DEFormatter.price(fertigungMitAV)}</td>
             <td class="right mono">${DEFormatter.price(fertigungMitAV * qty)}</td>
         </tr>
         <tr>
             <td>Werkzeugverschleiß</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">pauschal (werkstoffabh.)</td>
             <td class="right mono">${DEFormatter.price(toolCost)}</td>
             <td class="right mono">${DEFormatter.price(toolCost * qty)}</td>
         </tr>
         <tr style="background: var(--color-warning-light);">
             <td>Einrichtung</td>
             <td class="right mono" style="color: var(--color-warning); font-size: 12px;">${DEFormatter.time(totalSetupTime)} × EUR ${cncRate}/h ÷ ${qty}</td>
             <td class="right mono" style="color: var(--color-warning);">${DEFormatter.price(setupCostPerPiece)}</td>
             <td class="right mono">${DEFormatter.price(setupCost)}</td>
         </tr>
         <tr style="background: var(--color-bg);">
             <td>Nebenzeiten</td>
             <td class="right mono" style="color: var(--color-text-muted); font-size: 12px;">Entgraten + Prüfung</td>
             <td class="right mono">${DEFormatter.price(nebenzeitKosten)}</td>
             <td class="right mono">${DEFormatter.price(nebenzeitKosten * qty)}</td>
         </tr>
         <tr style="background: var(--color-bg); font-weight: 600;">
             <td>HERSTELLKOSTEN</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(selbstkosten)}</td>
             <td class="right mono">${DEFormatter.price(selbstkosten * qty)}</td>
         </tr>
         <tr>
             <td>+ Marge ${zuschlagGewinn}%</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(gewinnBetrag)}</td>
             <td class="right mono">${DEFormatter.price(gewinnBetrag * qty)}</td>
         </tr>
         <tr style="background: var(--color-primary); color: white; font-weight: 600;">
             <td>VERKAUFSPREIS</td>
             <td></td>
             <td class="right mono">${DEFormatter.price(angebotspreis)}</td>
             <td class="right mono">${DEFormatter.price(orderTotal)}</td>
         </tr>`;
     }
 }
 
 // Instructions
 document.getElementById('faMaterial').innerHTML = '<strong>' + mat.name + '</strong>';
 document.getElementById('faRawDims').textContent = x + ' × ' + y + ' × ' + z + ' mm';
 document.getElementById('faWeight').textContent = DEFormatter.weight(weightKg);
 document.getElementById('faMachiningTime').innerHTML = '<strong>' + DEFormatter.time(machiningTime) + '</strong>';
 { const _cr = document.getElementById('codeRuntime'); if(_cr) _cr.textContent = DEFormatter.time(machiningTime); }
 
 // ================================================================
 // QUOTE SECTION UPDATE (renderQuote with calculated data)
 // ================================================================
 const partName = currentProject ? currentProject.name : document.getElementById('partName')?.value || 'Bauteil';
 const drawingNumber = currentProject ? currentProject.partNumber : document.getElementById('partNumber')?.value || '';
 const materialName = mat.name || document.getElementById('materialSelect').value;
 
 const quoteData = {
     parts: [{
         name: partName,
         drawingNumber: drawingNumber,
         material: materialName,
         quantity: qty,
         price: angebotspreis,
         articleNumber: 'E-CNC-0001'
     }]
 };
 
 renderQuote(quoteData);
 
 // Plausibility warnings
 checkPlausibility(x, y, z, mat, clampingType);

 // Pricing insights
 generatePricingInsights({
 angebotspreis, selbstkosten, herstellkosten, materialCost, fertigungskosten,
 machiningTime, totalSetupTime, weightKg, qty, mat, dbProzent, deckungsbeitrag,
 zuschlagGewinn, setupCostPerPiece
 });
 }

 // ================================================================
 // PRICING INSIGHTS — Intelligente Preisempfehlungen
 // ================================================================

 function generatePricingInsights(data) {
 const container = document.getElementById('pricingInsights');
 if (!container) return;

 const insights = [];
 const proj = currentProject;

 // 1. Kundentyp-Analyse
 if (proj?.source && (proj.source.includes('KBA') || proj.source.includes('Koenig'))) {
 insights.push({
 icon: '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;"><path d="M3 21h18"/><path d="M5 21V7l8-4v18"/><path d="M19 21V11l-6-4"/><path d="M9 9h1"/><path d="M9 13h1"/><path d="M9 17h1"/></svg>',
 type: 'opportunity',
 title: 'Großkunde — höherer Stundensatz möglich',
 text: `KBA (Koenig & Bauer) ist börsennotiert mit >€1 Mrd. Umsatz. Solche Kunden sind Stundensätze von €85–95/h gewohnt (vs. €70/h kalkuliert). <strong>Empfehlung: +15–20% auf Fertigungskosten.</strong><br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: Marktdaten Sachsen Q4/2025</span>`,
 action: { label: '+15% anwenden', fn: 'applyPricingAdjustment("rate_premium", 15)' },
 impact: `+EUR ${(data.fertigungskosten * 0.15).toFixed(0)}/Stück`
 });
 }

 // 2. Risiko-Zuschlag bei unklarem Werkstoff
 const clWerkstoff = checklistAnswers?.['cl_werkstoff'];
 const clRohteil = checklistAnswers?.['cl_rohteil'];
 if (!clWerkstoff || clWerkstoff === '' || clRohteil === 'unklar') {
 insights.push({
 icon: '<span style="color:#f9a825;font-weight:700">!</span>',
 type: 'risk',
 title: 'Hohes Risiko — offene Klärungspunkte',
 text: `Werkstoff und/oder Rohteil-Herkunft sind nicht geklärt. Bei diesem Bauteilgewicht (${data.weightKg.toFixed(0)} kg) kann der Materialpreis um ±EUR ${(data.weightKg * 2).toFixed(0)} schwanken. <strong>Empfehlung: Risikozuschlag +10–15%.</strong><br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: Erfahrungswerte Lohnfertigung</span>`,
 action: { label: '+10% Risiko', fn: 'applyPricingAdjustment("risk", 10)' },
 impact: `+EUR ${(data.angebotspreis * 0.10).toFixed(0)}/Stück`
 });
 }

 // 3. Deckungsbeitrag-Warnung
 if (data.dbProzent < 20) {
 insights.push({
 icon: '↓',
 type: 'warning',
 title: 'Niedriger Deckungsbeitrag',
 text: `DB I bei nur ${data.dbProzent.toFixed(1)}%. Unter 25% bleibt wenig Spielraum für unvorhergesehene Kosten. <strong>Gewinnaufschlag prüfen oder Fertigungsoptimierung.</strong><br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: REFA-Richtwerte 2024</span>`,
 action: null,
 impact: null
 });
 } else if (data.dbProzent > 45) {
 insights.push({
 icon: '✓',
 type: 'positive',
 title: 'Gesunder Deckungsbeitrag',
 text: `DB I bei ${data.dbProzent.toFixed(1)}% — guter Spielraum. Bei Preisverhandlungen können Sie bis zu ${(data.dbProzent - 25).toFixed(0)}% nachgeben.<br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: REFA-Richtwerte 2024</span>`,
 action: null,
 impact: null
 });
 }

 // 4. Losgröße / Rüstkosten
 if (data.qty <= 2 && data.setupCostPerPiece > data.angebotspreis * 0.15) {
 insights.push({
 icon: '⚙',
 type: 'info',
 title: 'Hoher Rüstkostenanteil',
 text: `Rüstkosten = EUR ${data.setupCostPerPiece.toFixed(0)}/Stück (${(data.setupCostPerPiece / data.angebotspreis * 100).toFixed(0)}% des Preises). Bei Einzelstücken empfiehlt sich eine separate Rüstpauschale im Angebot.<br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: VDI 3321</span>`,
 action: null,
 impact: null
 });
 }

 // 5. Großes/schweres Bauteil
 if (data.weightKg > 500) {
 insights.push({
 icon: '▲',
 type: 'info',
 title: 'Schwerlast — Handling-Zuschlag prüfen',
 text: `Bauteil wiegt ${data.weightKg.toFixed(0)} kg. Kran-/Staplernutzung für jede Aufspannung nötig. Transport, Verpackung und Versicherung als separate Positionen anbieten.<br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: Erfahrungswerte Lohnfertigung</span>`,
 action: { label: '+5% Handling', fn: 'applyPricingAdjustment("handling", 5)' },
 impact: `+EUR ${(data.angebotspreis * 0.05).toFixed(0)}/Stück`
 });
 }

 // 6. Bearbeitungszeit > 8h
 if (data.machiningTime > 480) {
 insights.push({
 icon: '⏲',
 type: 'info',
 title: 'Lange Bearbeitungszeit — Maschinenbelegung beachten',
 text: `${(data.machiningTime / 60).toFixed(1)}h Bearbeitung pro Stück = mehr als eine Schicht. Prüfen: Maschinenauslastung, ggf. Nachtschicht-Zuschlag kalkulieren.<br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: REFA-Richtwerte 2024</span>`,
 action: null,
 impact: null
 });
 }

 // 7. Wiederholauftrag-Potenzial
 const clLos = checklistAnswers?.['cl_losgroesse'];
 if (clLos && clLos !== 'einmal') {
 insights.push({
 icon: '↻',
 type: 'opportunity',
 title: 'Wiederholauftrag — Staffelpreis anbieten',
 text: `Kunde könnte nachbestellen. Rüstzeit sinkt ab Los 2 um ca. 40%. Staffelpreis für Folgeaufträge anbieten → Kundenbindung + bessere Auslastung.<br><span style="color:var(--color-text-muted);font-size:11px;">Quelle: KI-Schätzung (Konfidenz: mittel)</span>`,
 action: null,
 impact: null
 });
 }

 // Render
 if (insights.length === 0) {
 container.innerHTML = '<div style="color:var(--color-text-muted);font-size:13px;">Keine besonderen Hinweise — Kalkulation im Normalbereich.</div>';
 return;
 }

 const typeColors = {
 opportunity: { border: '#28a745', bg: '#e8f5e9' },
 risk: { border: '#dc3545', bg: '#fde8ea' },
 warning: { border: '#fd7e14', bg: '#fff3e0' },
 info: { border: '#0d6efd', bg: '#e7f1ff' },
 positive: { border: '#28a745', bg: '#e8f5e9' }
 };

 container.innerHTML = insights.map(ins => {
 const c = typeColors[ins.type] || typeColors.info;
 // Show where to adjust manually instead of auto-apply buttons
 const whereToAdjust = ins.action ? 
 `<div style="margin-top:6px;font-size:11px;padding:4px 8px;background:rgba(255,255,255,0.5);border-radius:var(--radius-sm);color:var(--color-text-secondary);">
 → Manuell anpassen unter: <strong>Preise & Sätze → Zuschläge</strong>${ins.impact ? ' (geschätzte Auswirkung: ' + ins.impact + ')' : ''}
 </div>` : '';
 return `
 <div style="display:flex; gap:10px; padding:10px; border-left:3px solid ${c.border}; background:${c.bg}; border-radius:var(--radius); margin-bottom:8px;">
 <div style="font-size:20px;">${ins.icon}</div>
 <div style="flex:1;">
 <div style="font-weight:600; font-size:13px; margin-bottom:2px;">${ins.title}</div>
 <div style="font-size:12px; color:var(--color-text-secondary); line-height:1.5;">${ins.text}</div>
 ${whereToAdjust}
 </div>
 </div>`;
 }).join('');
 }

 // Pricing decisions tracked for protocol (manual changes only)
 const pricingDecisions = [];
 const zuschlagDefaults = { zuschlagMGK:5, zuschlagFGK:0, zuschlagAV:12, zuschlagVwGK:10, zuschlagVtGK:5, zuschlagGewinn:8, settingScrap:10, settingVat:19 };
 const zuschlagLabels = { zuschlagMGK:'MGK', zuschlagFGK:'FGK', zuschlagAV:'AV-Aufschlag', zuschlagVwGK:'VwGK', zuschlagVtGK:'VtGK', zuschlagGewinn:'Gewinn', settingScrap:'Verschnitt', settingVat:'MwSt' };

 function onZuschlagChange(id, value) {
 // id = 'settingScrap', 'zuschlagMGK', 'zuschlagAV', etc.
 // value can be: number, boolean, string, or HTML element (extract .value or .checked)
 // Map HTML id to DB.zuschlaege key
 const dbKeyMap = {
 'settingScrap': 'verschnitt',
 'zuschlagMGK': 'mgk',
 'zuschlagFGK': 'fgk',
 'zuschlagAV': 'av',
 'zuschlagVwGK': 'vwgk',
 'zuschlagVtGK': 'vtgk',
 'zuschlagGewinn': 'gewinn',
 'settingVat': 'vat',
 'sonderMEK': 'mek',
 'sonderTransport': 'transport',
 'sonderBeistellung': 'beistellung',
 'sonderSonstiges': 'sonstiges'
 };
 
 const dbKey = dbKeyMap[id];
 if (!dbKey) return; // Unknown id
 
 // Extract value from HTML element if passed
 let rawValue = value;
 if (value && typeof value === 'object' && 'type' in value) {
 // It's an HTML input element
 rawValue = value.type === 'checkbox' ? value.checked : value.value;
 }
 
 const newVal = typeof rawValue === 'number' ? rawValue : (rawValue === true || rawValue === false ? rawValue : parseFloat(rawValue) || 0);
 const oldVal = dbKey === 'beistellung' ? DB.sondervereinbarungen.beistellung : 
 (dbKey === 'sonstiges' ? DB.sondervereinbarungen.sonstiges :
 (dbKey === 'mek' || dbKey === 'transport' ? DB.sondervereinbarungen[dbKey] : DB.zuschlaege[dbKey]));
 
 if (newVal !== oldVal) {
 // Update DB (Single Source of Truth)
 if (dbKey === 'mek' || dbKey === 'transport' || dbKey === 'beistellung' || dbKey === 'sonstiges') {
 DB.sondervereinbarungen[dbKey] = newVal;
 } else {
 DB.zuschlaege[dbKey] = newVal;
 }
 
 // Propagate change
 const label = zuschlagLabels[id] || id;
 propagateChange('Zuschlag', label, oldVal + (typeof oldVal === 'boolean' ? '' : '%'), newVal + (typeof newVal === 'boolean' ? '' : '%'));
 }
 }

 // ================================================================
 // VOLLSTÄNDIGER BERICHT (Print)
 // ================================================================

 function printFullReport() {
 const proj = currentProject;
 if (!proj) { alert('Bitte zuerst ein Bauteil auswählen.'); return; }
 const mat = MATERIALS[document.getElementById('materialSelect')?.value] || {};
 const qty = parseInt(document.getElementById('quantity')?.value) || 1;
 const now = new Date();
 const firma = document.getElementById('firmaName')?.value || 'Muster CNC GmbH';
 const bearbeiter = document.getElementById('firmaBearbeiter')?.value || '—';

 // Collect all data
 const ops = proj.operations || [];
 const totalMach = ops.reduce((s,o) => s+o.time, 0);
 const totalSetup = (proj.clampings || []).reduce((s,c) => s+c.time, 0);

 // Collect checklist answers
 const clRows = CHECKLIST_QUESTIONS.filter(q => q.condition(proj) && checklistAnswers[q.id]).map(q => {
 const val = checklistAnswers[q.id];
 let display = val;
 if (q.type === 'select') { const opt = q.options?.find(o => o.value === val); display = opt?.label || val; }
 else if (q.unit) display = val + ' ' + q.unit;
 const effect = q.effect ? q.effect(val) : '';
 const aiDef = typeof q.aiDefault === 'function' ? q.aiDefault(proj) : q.aiDefault;
 let aiDisplay = aiDef || '—';
 if (q.type === 'select' && aiDef) { const opt = q.options?.find(o => o.value === aiDef); aiDisplay = opt?.label || aiDef; }
 const deviated = aiDef && String(val) !== String(aiDef);
 return { label: q.label, priority: q.priority, value: display, aiDefault: aiDisplay, deviated, effect };
 });

 // Prices from DOM
 const sellPrice = document.getElementById('sellPrice')?.textContent || '—';
 const orderTotal = document.getElementById('orderTotal')?.textContent || '—';
 const dbPct = document.getElementById('dbPercent')?.textContent || '—';
 const matCost = document.getElementById('cdMatTotal')?.textContent || '—';
 const machCost = document.getElementById('cdMachTotal')?.textContent || '—';

 // Zuschläge
 const zuschl = [
 { name: 'Verschnitt', val: document.getElementById('settingScrap')?.value + '%' },
 { name: 'MGK', val: document.getElementById('zuschlagMGK')?.value + '%' },
 { name: 'FGK', val: document.getElementById('zuschlagFGK')?.value + '%' },
 { name: 'AV-Aufschlag', val: document.getElementById('zuschlagAV')?.value + '%' },
 { name: 'VwGK', val: document.getElementById('zuschlagVwGK')?.value + '%' },
 { name: 'VtGK', val: document.getElementById('zuschlagVtGK')?.value + '%' },
 { name: 'Gewinn', val: document.getElementById('zuschlagGewinn')?.value + '%' },
 { name: 'MwSt', val: document.getElementById('settingVat')?.value + '%' },
 ];

 const w = window.open('', '_blank');
 w.document.write(`<!DOCTYPE html><html><head><title>Kalkulationsbericht — ${proj.name}</title>
 <style>
 @page { size: A4; margin: 15mm 18mm; }
 body { font-family: Helvetica Neue, Arial, sans-serif; font-size: 11px; color: #1a1a1a; line-height: 1.5; }
 h1 { font-size: 18px; border-bottom: 3px solid #c8aa50; padding-bottom: 6px; margin: 0 0 12px; }
 h2 { font-size: 14px; color: #c8aa50; margin: 20px 0 8px; border-bottom: 1px solid #e5e5e0; padding-bottom: 4px; }
 table { width: 100%; border-collapse: collapse; margin: 6px 0 14px; }
 th, td { padding: 4px 8px; border: 1px solid #e5e5e0; text-align: left; font-size: 11px; }
 th { background: #f5f5f5; font-size: 10px; text-transform: uppercase; letter-spacing: 0.3px; }
 .right { text-align: right; }
 .mono { font-family: 'SF Mono', Consolas, monospace; }
 .deviated { background: #fff3e0; }
 .accepted { color: #28a745; }
 .meta { font-size: 10px; color: #666; margin-bottom: 16px; }
 .stamp { margin-top: 30px; display: flex; justify-content: space-between; }
 .stamp-box { width: 45%; border-top: 1px solid #333; padding-top: 4px; font-size: 10px; }
 .footer { margin-top: 20px; font-size: 9px; color: #999; border-top: 1px solid #e5e5e0; padding-top: 6px; }
 .section-break { page-break-before: always; }
 .highlight { background: #f0f7e8; padding: 8px; border-left: 3px solid #28a745; margin: 8px 0; }
 .warning { background: #fff3e0; padding: 8px; border-left: 3px solid #fd7e14; margin: 8px 0; }
 </style></head><body>

 <!-- SEITE 1: Deckblatt + Zusammenfassung -->
 <h1>Kalkulationsbericht</h1>
 <div class="meta">${firma} · Bearbeiter: ${bearbeiter} · ${now.toLocaleDateString('de-DE')} · INTERN — Nicht an Kunden weitergeben</div>

 <table>
 <tr><td style="width:30%;font-weight:600;">Bauteil</td><td>${proj.name}</td></tr>
 <tr><td style="font-weight:600;">Zeichnungs-Nr.</td><td class="mono">${proj.partNumber}</td></tr>
 <tr><td style="font-weight:600;">Kunde / Anfrage</td><td>${proj.source || '—'}</td></tr>
 <tr><td style="font-weight:600;">Werkstoff</td><td>${mat.name || '—'}</td></tr>
 <tr><td style="font-weight:600;">Abmessungen</td><td class="mono">${proj.dims.x} × ${proj.dims.y} × ${proj.dims.z} mm</td></tr>
 <tr><td style="font-weight:600;">Stückzahl</td><td class="mono">${qty}</td></tr>
 </table>

 <div class="highlight">
 <table style="border:none;margin:0;">
 <tr style="border:none;"><td style="border:none;font-weight:700;font-size:14px;">Angebotspreis/Stück</td><td style="border:none;font-weight:700;font-size:14px;" class="right mono">${sellPrice}</td></tr>
 <tr style="border:none;"><td style="border:none;font-weight:700;font-size:14px;">Auftragswert gesamt</td><td style="border:none;font-weight:700;font-size:14px;" class="right mono">${orderTotal}</td></tr>
 <tr style="border:none;"><td style="border:none;">Deckungsbeitrag I</td><td style="border:none;" class="right mono">${dbPct}</td></tr>
 </table>
 </div>

 <!-- SEITE 2: Prüfprotokoll -->
 <h2 class="section-break">Prüfprotokoll — Eingaben des Arbeitsvorbereiters</h2>
 ${clRows.length > 0 ? `
 <table>
 <tr><th>Prüfpunkt</th><th>Prio</th><th>Eingabe</th><th>KI-Empfehlung</th><th>Abweichung</th><th>Auswirkung</th></tr>
 ${clRows.map(r => `<tr class="${r.deviated ? 'deviated' : ''}">
 <td>${r.label}</td>
 <td>${r.priority === 'critical' ? '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#e53935;"></span> Pflicht' : '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#f9a825;"></span> Empfohlen'}</td>
 <td style="font-weight:600;">${r.value}</td>
 <td>${r.aiDefault}</td>
 <td>${r.deviated ? '<strong style="color:#fd7e14;">Abweichung</strong>' : '<span class="accepted">Übernommen</span>'}</td>
 <td style="font-size:10px;">${r.effect}</td>
 </tr>`).join('')}
 </table>
 ${checklistDeviations.length > 0 ? `<div class="warning"><strong>${checklistDeviations.length} Abweichung(en) von KI-Empfehlung.</strong> AV hat bewusst andere Werte gewählt — Begründung ggf. im Protokoll-Tab dokumentiert.</div>` : ''}
 ` : '<p style="color:#666;">Kein Prüfprotokoll ausgefüllt.</p>'}

 <!-- Operationsplan -->
 <h2 class="section-break">Fertigungsanweisung — Operationsplan</h2>
 <table>
 <tr><th>AG</th><th>Beschreibung</th><th>Werkzeug</th><th>Kostenstelle</th><th class="right">Zeit</th><th class="right">Kosten</th></tr>
 ${ops.map(op => {
 const rk = op.rate || 'cnc';
 const ro = RATES[rk] || RATES.cnc;
 const rate = ro.labor + ro.machine;
 const cost = (op.time / 60) * rate;
 return `<tr>
 <td class="mono">${op.nr}</td>
 <td>${op.name}${op._custom ? ' <em>(manuell hinzugefügt)</em>' : ''}</td>
 <td class="mono">${op.tool || '—'}</td>
 <td>${rk === 'saegen' ? 'Sägen' : rk === 'entgraten' ? 'Entgraten' : 'CNC'}</td>
 <td class="right mono">${op.time} min</td>
 <td class="right mono">EUR ${cost.toFixed(2)}</td>
 </tr>`;
 }).join('')}
 <tr style="font-weight:600;background:#f5f5f5;">
 <td colspan="4">Σ Bearbeitungszeit</td>
 <td class="right mono">${totalMach} min</td>
 <td class="right mono">EUR ${ops.reduce((s,o) => { const r=RATES[o.rate||'cnc']||RATES.cnc; return s+(o.time/60)*(r.labor+r.machine); },0).toFixed(2)}</td>
 </tr>
 </table>

 <!-- Aufspannungen -->
 ${proj.clampings ? `
 <h2>Aufspannungen & Rüstzeiten</h2>
 <table>
 <tr><th>#</th><th>Typ</th><th>Beschreibung</th><th class="right">Zeit</th></tr>
 ${proj.clampings.map((c,i) => `<tr><td>${i+1}</td><td>${c.type}</td><td>${c.desc || '—'}</td><td class="right mono">${c.time} min</td></tr>`).join('')}
 <tr style="font-weight:600;background:#f5f5f5;"><td colspan="3">Σ Rüstzeit</td><td class="right mono">${totalSetup} min</td></tr>
 </table>` : ''}

 <!-- Zuschlagskalkulation -->
 <h2 class="section-break">Zuschlagskalkulation</h2>
 <table>
 <tr><th>Position</th><th class="right">Satz</th></tr>
 ${zuschl.map(z => `<tr><td>${z.name}</td><td class="right mono">${z.val}</td></tr>`).join('')}
 </table>

 <!-- Änderungsprotokoll -->
 ${(faChanges.length > 0 || pricingDecisions.length > 0) ? `
 <h2>Änderungsprotokoll</h2>
 <table>
 <tr><th>Zeitpunkt</th><th>Bereich</th><th>Änderung</th></tr>
 ${faChanges.map(c => `<tr><td>${c.timestamp}</td><td>AG ${c.ag} — ${c.field}</td><td><span style="text-decoration:line-through;">${c.oldVal}</span> → <strong>${c.newVal}</strong></td></tr>`).join('')}
 ${pricingDecisions.map(d => `<tr><td>${d.timestamp}</td><td>Zuschlag: ${d.type}</td><td>${d.adjustment} — ${d.reason}</td></tr>`).join('')}
 </table>
 ` : ''}

 <!-- Unterschrift -->
 <div class="stamp">
 <div class="stamp-box">Datum, Unterschrift Arbeitsvorbereiter</div>
 <div class="stamp-box">Datum, Unterschrift Freigabe</div>
 </div>

 <div class="footer">
 CNC Planer Pro · Erstellt: ${now.toLocaleString('de-DE')} · Bearbeiter: ${bearbeiter} · INTERN<br>
 Alle Berechnungen auf Basis REFA/VDI 3321 — Abgleich mit betrieblicher Nachkalkulation empfohlen.
 </div>

 </body></html>`);
 w.document.close();
 setTimeout(() => w.print(), 300);
 }

 // ================================================================
 // RISIKOANALYSE PDF GENERATOR
 // ================================================================

 function generateRiskReport() {
 const proj = currentProject;
 const mat = MATERIALS[document.getElementById('materialSelect').value];
 const x = parseFloat(document.getElementById('dimX').value) || 100;
 const y = parseFloat(document.getElementById('dimY').value) || 100;
 const z = parseFloat(document.getElementById('dimZ').value) || 20;
 const qty = parseInt(document.getElementById('quantity').value) || 1;
 const volCm3 = (x * y * z) / 1000;
 const weightKg = (volCm3 * mat.density) / 1000;
 const scrap = parseFloat(document.getElementById('settingScrap')?.value) || 10;

 // Recalculate key values
 const cncRate = RATES.cnc.labor + RATES.cnc.machine;
 const materialCost = currentProject?.materialCostFixed ? currentProject.materialCostFixed : weightKg * mat.price * (1 + scrap / 100);
 const totalSetupTime = getClampingTotalTime();
 const setupCost = (totalSetupTime / 60) * cncRate;
 const setupPerPiece = setupCost / qty;

 let machiningTime = 0, machineCost = 0;
 if (proj?.operations) {
 proj.operations.forEach(op => {
 const r = RATES[op.rate] || RATES.cnc;
 machiningTime += op.time;
 machineCost += (op.time / 60) * (r.labor + r.machine);
 });
 }

 const zuschlagMGK = parseFloat(document.getElementById('zuschlagMGK')?.value) || 10;
 const zuschlagAV = parseFloat(document.getElementById('zuschlagAV')?.value) || 8;
 const zuschlagVwGK = parseFloat(document.getElementById('zuschlagVwGK')?.value) || 12;
 const zuschlagVtGK = parseFloat(document.getElementById('zuschlagVtGK')?.value) || 5;
 const zuschlagGewinn = parseFloat(document.getElementById('zuschlagGewinn')?.value) || 10;

 const matMitGK = materialCost * (1 + zuschlagMGK / 100);
 const fertigung = machineCost + setupPerPiece;
 const fertigungMitAV = fertigung * (1 + zuschlagAV / 100);
 const herstellkosten = matMitGK + fertigungMitAV;
 const vwGK = herstellkosten * zuschlagVwGK / 100;
 const vtGK = herstellkosten * zuschlagVtGK / 100;
 const selbstkosten = herstellkosten + vwGK + vtGK;
 const gewinn = selbstkosten * zuschlagGewinn / 100;
 const angebotspreis = selbstkosten + gewinn;

 // Bandbreiten
 const bestFactor = 0.8, worstFactor = 1.35;
 const bestPrice = angebotspreis * bestFactor;
 const worstPrice = angebotspreis * worstFactor;

 // Prüfprotokoll answers
 let checklistHtml = '';
 const answeredQuestions = CHECKLIST_QUESTIONS.filter(q => q.condition(proj) && checklistAnswers[q.id] && checklistAnswers[q.id] !== '');
 if (answeredQuestions.length > 0) {
 checklistHtml = `<h2>2. Prüfprotokoll — Klärungsergebnisse</h2>
 <table><tr><th>Prüfpunkt</th><th>Antwort</th><th>Auswirkung</th><th>Empfehlung</th></tr>`;
 answeredQuestions.forEach(q => {
 const val = checklistAnswers[q.id];
 let displayVal = val;
 if (q.type === 'select') { const opt = q.options.find(o => o.value === val); displayVal = opt ? opt.label : val; }
 else if (q.unit) displayVal = val + ' ' + q.unit;
 const effect = q.effect ? q.effect(val) : '';
 const intel = q.intel ? q.intel(val, proj) : '';
 checklistHtml += `<tr><td><strong>${q.label}</strong></td><td>${displayVal}</td><td>${effect}</td><td class="intel">${intel}</td></tr>`;
 });
 checklistHtml += '</table>';
 }

 // Unresolved questions
 const unresolvedQuestions = CHECKLIST_QUESTIONS.filter(q => q.condition(proj) && (!checklistAnswers[q.id] || checklistAnswers[q.id] === ''));
 let unresolvedHtml = '';
 if (unresolvedQuestions.length > 0) {
 unresolvedHtml = `<div class="risk-box"><h3><span style="color:#f9a825;font-weight:700">!</span> Offene Klärungspunkte</h3><ul>`;
 unresolvedQuestions.forEach(q => {
 unresolvedHtml += `<li><strong>${q.label}:</strong> ${q.question} — <em>${q.reason}</em></li>`;
 });
 unresolvedHtml += '</ul><p><strong>Empfehlung:</strong> Vor Angebotsabgabe klären. Jeder offene Punkt erhöht das Kalkulationsrisiko.</p></div>';
 }

 // Operations table
 let opsHtml = '';
 if (proj?.operations) {
 opsHtml = `<h2>3. Fertigungsanweisung — Operationsplan</h2>`;
 if (proj.clampings) {
 let opIdx = 0;
 const opsPerClamping = [
 proj.operations.filter(o => o.nr <= 30),
 proj.operations.filter(o => o.nr >= 40 && o.nr <= 70),
 proj.operations.filter(o => o.nr === 80),
 proj.operations.filter(o => o.nr === 90),
 proj.operations.filter(o => o.nr >= 100)
 ];
 opsHtml += '<table><tr><th>AG</th><th>Arbeitsgang</th><th>Werkzeug</th><th>Parameter</th><th>min</th></tr>';
 proj.clampings.forEach((c, i) => {
 opsHtml += `<tr class="clamping-row"><td colspan="5"><strong>Aufspannung ${i+1}</strong> — ${c.desc} (Rüsten: ${c.time} min)</td></tr>`;
 });
 // Simplified: just list all ops
 opsHtml = `<h2>3. Fertigungsanweisung — Operationsplan</h2>
 <table><tr><th>AG</th><th>Arbeitsgang</th><th>Werkzeug</th><th>Parameter</th><th style="text-align:right;">min</th></tr>`;
 proj.operations.forEach(op => {
 const r = RATES[op.rate] || RATES.cnc;
 opsHtml += `<tr><td>${op.nr}</td><td>${op.name}</td><td>${op.tool || '—'}</td><td class="mono">${op.params || '—'}</td><td style="text-align:right;">${op.time}</td></tr>`;
 });
 opsHtml += `<tr class="total-row"><td colspan="4"><strong>Σ Bearbeitung</strong></td><td style="text-align:right;"><strong>${machiningTime} min</strong></td></tr>`;
 opsHtml += `<tr><td colspan="4"><strong>Σ Rüsten (${proj.clampings.length} Aufspannungen)</strong></td><td style="text-align:right;"><strong>${totalSetupTime} min</strong></td></tr>`;
 opsHtml += `<tr class="total-row"><td colspan="4"><strong>Σ Gesamt pro Stück</strong></td><td style="text-align:right;"><strong>${machiningTime + totalSetupTime} min (${((machiningTime + totalSetupTime)/60).toFixed(1)}h)</strong></td></tr>`;
 opsHtml += '</table>';
 }
 }

 // Risk matrix
 const risks = [];
 if (!checklistAnswers['cl_werkstoff'] || checklistAnswers['cl_werkstoff'] === '') {
 risks.push({ risk: 'Werkstoff ungeklärt', impact: 'Hoch (±300%)', prob: 'Mittel', action: 'Vor Angebot klären', color: '#dc3545' });
 }
 if (!checklistAnswers['cl_rohteil'] || checklistAnswers['cl_rohteil'] === 'unklar') {
 risks.push({ risk: 'Rohteil-Herkunft unklar', impact: `Hoch (±EUR ${(weightKg * 2).toFixed(0)})`, prob: 'Mittel', action: 'Beistellung vs. Eigen klären', color: '#dc3545' });
 }
 if (weightKg > 500) {
 risks.push({ risk: 'Schwerlast-Handling', impact: 'Mittel (+5-10%)', prob: 'Hoch', action: 'Kran-Zuschlag einplanen', color: '#fd7e14' });
 }
 if (machiningTime > 480) {
 risks.push({ risk: 'Lange Bearbeitungszeit', impact: 'Mittel', prob: 'Mittel', action: 'Maschinenbelegung prüfen', color: '#ffc107' });
 }
 risks.push({ risk: 'Werkzeugbruch bei Guss', impact: 'Mittel (+2-4h)', prob: 'Niedrig', action: 'Ersatzwerkzeug bereithalten', color: '#ffc107' });
 risks.push({ risk: 'Maßabweichung Rohteil', impact: 'Niedrig', prob: 'Mittel', action: 'Aufmaß vor Bearbeitung prüfen', color: '#28a745' });

 let riskHtml = `<h2>4. Risikoanalyse</h2>
 <table><tr><th>Risiko</th><th>Auswirkung</th><th>Wahrscheinlichkeit</th><th>Maßnahme</th></tr>`;
 risks.forEach(r => {
 riskHtml += `<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${r.color};margin-right:6px;"></span>${r.risk}</td><td>${r.impact}</td><td>${r.prob}</td><td>${r.action}</td></tr>`;
 });
 riskHtml += '</table>';

 // Pricing insights
 let insightsHtml = '<h2>5. Preisempfehlungen</h2><div class="insights">';
 const insightsContainer = document.getElementById('pricingInsights');
 if (insightsContainer) {
 insightsHtml += insightsContainer.innerHTML;
 }
 insightsHtml += '</div>';

 // Build full report
 const reportDate = new Date().toLocaleDateString('de-DE');
 const reportTime = new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});

 const html = `<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8">
 <title>Risikoanalyse — ${proj?.name || 'Bauteil'}</title>
 <style>
 @page { margin: 20mm; size: A4; }
 * { box-sizing: border-box; margin: 0; padding: 0; }
 body { font-family: 'Helvetica Neue', Arial, sans-serif; font-size: 12px; color: #1a1a1a; line-height: 1.6; padding: 0; }
 .header { text-align: center; padding: 30px 0; border-bottom: 3px solid #c8aa50; margin-bottom: 24px; }
 .header h1 { font-size: 24px; color: #1a1a1a; margin-bottom: 4px; }
 .header .subtitle { font-size: 14px; color: #666; }
 .header .meta { font-size: 11px; color: #999; margin-top: 12px; }
 h2 { font-size: 16px; color: #1a1a1a; margin: 28px 0 8px 0; padding-bottom: 4px; border-bottom: 2px solid #c8aa50; }
 h3 { font-size: 13px; margin: 12px 0 6px 0; }
 table { width: 100%; border-collapse: collapse; margin: 10px 0 16px 0; font-size: 11px; }
 th { background: #f8f8f6; border: 1px solid #e5e5e0; padding: 6px 8px; text-align: left; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; color: #666; }
 td { border: 1px solid #e5e5e0; padding: 5px 8px; vertical-align: top; }
 td.intel { font-size: 10px; color: #555; max-width: 200px; }
 td.mono { font-family: Menlo, monospace; font-size: 10px; }
 tr.total-row { background: #f5f0e0; font-weight: 600; }
 tr.clamping-row { background: #f8f8f6; }
 .summary-box { background: #f8f8f6; border: 1px solid #e5e5e0; border-left: 3px solid #c8aa50; padding: 16px; margin: 16px 0; border-radius: 4px; }
 .summary-box .price { font-size: 22px; font-weight: 700; color: #1a1a1a; }
 .summary-box .range { font-size: 13px; color: #666; }
 .risk-box { background: #fde8ea; border: 1px solid #f5c6cb; border-left: 3px solid #dc3545; padding: 12px 16px; margin: 12px 0; border-radius: 4px; }
 .risk-box h3 { color: #dc3545; margin: 0 0 6px 0; }
 ul { padding-left: 20px; margin: 6px 0; }
 li { margin: 4px 0; }
 .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 12px 0; }
 .kpi { text-align: center; padding: 12px; background: #f8f8f6; border-radius: 4px; }
 .kpi .value { font-size: 20px; font-weight: 700; color: #1a1a1a; }
 .kpi .label { font-size: 10px; color: #666; text-transform: uppercase; }
 .footer { margin-top: 40px; padding-top: 16px; border-top: 1px solid #e5e5e0; text-align: center; font-size: 10px; color: #999; }
 .insights > div { margin-bottom: 8px; }
 @media print { body { padding: 0; } .no-print { display: none; } }
 </style></head><body>

 <div class="header">
 <h1>RISIKOANALYSE</h1>
 <div class="subtitle">${proj?.name || 'Bauteil'} — ${proj?.partNumber || ''}</div>
 <div class="meta">${proj?.source || ''} · ${reportDate} ${reportTime} · INTERN</div>
 </div>

 <button class="no-print" onclick="window.print()" style="position:fixed;top:10px;right:10px;padding:8px 16px;background:#c8aa50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Als PDF drucken</button>

 <h2>1. Zusammenfassung</h2>

 <div class="summary-box">
 <div class="price">EUR ${DEFormatter.price(angebotspreis)} / Stück</div>
 <div class="range">Bandbreite: EUR ${DEFormatter.price(bestPrice)} – ${DEFormatter.price(worstPrice)} · Auftragswert (${qty} Stk): EUR ${DEFormatter.price(angebotspreis * qty)}</div>
 </div>

 <div class="grid-2">
 <div class="kpi"><div class="value">${machiningTime} min</div><div class="label">Bearbeitungszeit</div></div>
 <div class="kpi"><div class="value">${totalSetupTime} min</div><div class="label">Rüstzeit (${proj?.clampings?.length || '?'} Aufsp.)</div></div>
 <div class="kpi"><div class="value">${DEFormatter.weight(weightKg)}</div><div class="label">Gewicht</div></div>
 <div class="kpi"><div class="value">${mat.name}</div><div class="label">Werkstoff</div></div>
 </div>

 <table>
 <tr><th>Position</th><th style="text-align:right;">Pro Stück</th><th style="text-align:right;">Auftrag (${qty} Stk)</th></tr>
 <tr><td>Material + MGK (${zuschlagMGK}%)</td><td style="text-align:right;">${DEFormatter.price(matMitGK)}</td><td style="text-align:right;">${DEFormatter.price(matMitGK * qty)}</td></tr>
 <tr><td>Fertigung + AV (${zuschlagAV}%)</td><td style="text-align:right;">${DEFormatter.price(fertigungMitAV)}</td><td style="text-align:right;">${DEFormatter.price(fertigungMitAV * qty)}</td></tr>
 <tr><td>= Herstellkosten</td><td style="text-align:right;font-weight:600;">${DEFormatter.price(herstellkosten)}</td><td style="text-align:right;font-weight:600;">${DEFormatter.price(herstellkosten * qty)}</td></tr>
 <tr><td>+ VwGK (${zuschlagVwGK}%) + VtGK (${zuschlagVtGK}%)</td><td style="text-align:right;">${DEFormatter.price(vwGK + vtGK)}</td><td style="text-align:right;">${DEFormatter.price((vwGK + vtGK) * qty)}</td></tr>
 <tr><td>= Selbstkosten</td><td style="text-align:right;font-weight:600;">${DEFormatter.price(selbstkosten)}</td><td style="text-align:right;font-weight:600;">${DEFormatter.price(selbstkosten * qty)}</td></tr>
 <tr><td>+ Gewinn (${zuschlagGewinn}%)</td><td style="text-align:right;">${DEFormatter.price(gewinn)}</td><td style="text-align:right;">${DEFormatter.price(gewinn * qty)}</td></tr>
 <tr class="total-row"><td><strong>= Angebotspreis</strong></td><td style="text-align:right;"><strong>${DEFormatter.price(angebotspreis)}</strong></td><td style="text-align:right;"><strong>${DEFormatter.price(angebotspreis * qty)}</strong></td></tr>
 </table>

 ${checklistHtml}
 ${checklistDeviations.length > 0 ? `
 <div style="margin:12px 0;padding:12px 16px;background:#fff3e0;border:1px solid #ffe0b2;border-left:3px solid #fd7e14;border-radius:4px;">
 <h3 style="color:#fd7e14;margin:0 0 8px 0;">Abweichungen von KI-Empfehlung (${checklistDeviations.length})</h3>
 <table><tr><th>Prüfpunkt</th><th>KI empfahl</th><th>Nutzereingabe</th></tr>
 ${checklistDeviations.map(d => {
 const q = CHECKLIST_QUESTIONS.find(qq => qq.id === d.id);
 let aiLabel = d.aiRecommendation, userLabel = d.userChoice;
 if (q?.type === 'select') { aiLabel = q.options.find(o => o.value === d.aiRecommendation)?.label || aiLabel; userLabel = q.options.find(o => o.value === d.userChoice)?.label || userLabel; }
 else if (q?.unit) { aiLabel += ' ' + q.unit; userLabel += ' ' + q.unit; }
 return '<tr><td>' + d.label + '</td><td>' + aiLabel + '</td><td><strong>' + userLabel + '</strong></td></tr>';
 }).join('')}
 </table>
 <p style="font-size:10px;color:#666;margin-top:6px;">Diese Abweichungen sind dokumentiert. KI-Empfehlungen basieren auf REFA/VDI-Richtwerten und Marktdaten.</p>
 </div>` : ''}
 ${unresolvedHtml}
 ${opsHtml}
 ${riskHtml}
 ${insightsHtml}

 <div class="footer">
 Erstellt: ${reportDate} ${reportTime} · CNC Planer Pro (AI-Assisted) · Gültigkeit: Bis Klärung offener Fragen · Materialpreise tagesaktuell prüfen<br>
 ⚠ INTERN — Basis für Angebotserstellung · Keine Weitergabe an Kunden
 </div>

 </body></html>`;

 const w = window.open('', '_blank');
 w.document.write(html);
 w.document.close();
 }

 function checkPlausibility(x, y, z, mat, clamping) {
 const partWarnings = [];
 const calcWarnings = [];
 
 // Werkstück/Aufspannung → Teil-Bereich
 if (x > 400 && clamping === 'schraubstock') {
 partWarnings.push({ type: 'warning', text: `Länge ${x} mm: Prüfen ob Schraubstock-Kapazität ausreicht. 2× Schraubstock oder Tischspannung empfohlen.` });
 }
 if (z > 100) {
 partWarnings.push({ type: 'warning', text: `Höhe ${z} mm: Werkzeugüberhang beachten. Vibrationsgefahr bei tiefen Taschen.` });
 }
 if (Math.max(x,y) / Math.min(x,y,z) > 10) {
 partWarnings.push({ type: 'info', text: `Ungünstiges Seitenverhältnis: Durchbiegung/Vibration prüfen.` });
 }
 
 // Fertigung/Material → Kalkulations-Bereich
 if (mat.timeFactor > 1.3) {
 calcWarnings.push({ type: 'info', text: `Schwerzerspanbarer Werkstoff (${mat.name}): Reduzierte Schnittdaten, erhöhter Werkzeugverschleiß.` });
 }
 
 const renderWarnings = (container, warnings) => {
 if (!container) return;
 container.innerHTML = warnings.length > 0 ? warnings.map(w => `
<div class="${w.type === 'warning' ? 'warning-box' : 'info-box'}" style="margin-bottom: var(--space-3);">
<strong>${w.type === 'warning' ? 'Warnung' : 'Hinweis'}:</strong> ${w.text}
</div>`).join('') : '';
 };
 
 renderWarnings(document.getElementById('partWarningsContainer'), partWarnings);
 renderWarnings(document.getElementById('warningsContainer'), calcWarnings);
 }
 
 // ================================================================
 // SETTINGS
 // ================================================================
 
 // Baselines for change tracking
 const rateBaselines = { cncL:38, cncM:32, saegenL:35, saegenM:10, entgratenL:28, entgratenM:3 };
 const matBaselines = { S235JR:1.40, S355J2:3.00, C45:1.80, '1.4301':4.80, '1.4404':5.50, '1.4571':5.20, AlMg3:4.50, AlMgSi1:4.80, '42CrMo4':2.20 };

 const inputBaselines = {};

 function trackInputChange(el, bereich, feld, unit) {
 const id = el.id;
 const newVal = el.value;
 const oldVal = inputBaselines[id];
 if (oldVal !== undefined && oldVal !== newVal) {
 trackChange(bereich, feld, oldVal + (unit?' '+unit:''), newVal + (unit?' '+unit:''));
 }
 inputBaselines[id] = newVal;
 }

 function trackChange(bereich, feld, oldVal, newVal) {
 if (String(oldVal) === String(newVal)) return;
 pricingDecisions.push({
 timestamp: new Date().toLocaleString('de-DE'),
 type: bereich + ': ' + feld,
 adjustment: oldVal + ' → ' + newVal,
 reason: 'Manuelle Anpassung',
 status: 'angewendet'
 });
 }

 function showParamChangeToast(what) {
 // Remove existing toast
 const old = document.getElementById('paramChangeToast');
 if (old) old.remove();
 const toast = document.createElement('div');
 toast.id = 'paramChangeToast';
 toast.style.cssText = 'position:fixed;top:16px;right:16px;z-index:9999;background:#065f46;color:white;padding:12px 20px;border-radius:8px;font-size:13px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:flex;align-items:center;gap:8px;animation:fadeIn 0.3s;';
 toast.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="white" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ' + what + ' geändert — Kalkulation aktualisiert';
 document.body.appendChild(toast);
 setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; setTimeout(() => toast.remove(), 500); }, 3000);
 // Re-render FA if visible
 if (currentProject?.operations) renderOperations(currentProject.operations);
 }

 // =================================================================
 // CHANGE PROPAGATION SYSTEM (v20)
 // =================================================================
 function propagateChange(source, field, oldVal, newVal) {
 // Log change
 console.log(`[DB Change] ${source}.${field}: ${oldVal} → ${newVal}`);
 trackChange(source, field, oldVal, newVal);
 
 // Recalculate all dependent views
 calculate();
 
 // Toast notification
 showParamChangeToast(source);
 
 // Update protocol
 updateMasterProtocol();
 }
 
 function updateRates() {
 const fields = [
 { id:'rateCncLabor', key:'cncL', label:'CNC Lohn', def:38, dbKey:'cnc', dbProp:'labor' },
 { id:'rateCncMachine', key:'cncM', label:'CNC Maschine', def:32, dbKey:'cnc', dbProp:'machine' },
 { id:'rateSaegenLabor', key:'saegenL', label:'Sägen Lohn', def:35, dbKey:'saegen', dbProp:'labor' },
 { id:'rateSaegenMachine', key:'saegenM', label:'Sägen Maschine', def:10, dbKey:'saegen', dbProp:'machine' },
 { id:'rateEntgratenLabor', key:'entgratenL', label:'Entgraten Lohn', def:28, dbKey:'entgraten', dbProp:'labor' },
 { id:'rateEntgratenMachine', key:'entgratenM', label:'Entgraten Maschine', def:3, dbKey:'entgraten', dbProp:'machine' },
 ];
 fields.forEach(f => {
 const newVal = parseFloat(document.getElementById(f.id)?.value) || f.def;
 const oldVal = DB.rates[f.dbKey][f.dbProp];
 if (newVal !== oldVal) {
 // Update DB (Single Source of Truth)
 DB.rates[f.dbKey][f.dbProp] = newVal;
 // Propagate change
 propagateChange('Stundensatz', f.label, oldVal + ' €/h', newVal + ' €/h');
 }
 });

 // Update UI totals
 document.getElementById('rateCncTotal').textContent = 'EUR ' + (DB.rates.cnc.labor + DB.rates.cnc.machine);
 document.getElementById('rateSaegenTotal').textContent = 'EUR ' + (DB.rates.saegen.labor + DB.rates.saegen.machine);
 document.getElementById('rateEntgratenTotal').textContent = 'EUR ' + (DB.rates.entgraten.labor + DB.rates.entgraten.machine);
 }
 
 function updateMaterials() {
 const matFields = [
 { id:'matS235JR', key:'S235JR', def:1.40 },
 { id:'matS355J2', key:'S355J2', def:3.00 },
 { id:'matC45', key:'C45', def:1.80 },
 { id:'mat14301', key:'1.4301', def:4.80 },
 { id:'mat14404', key:'1.4404', def:5.50 },
 { id:'mat14571', key:'1.4571', def:5.20 },
 { id:'matAlMg3', key:'AlMg3', def:4.50 },
 { id:'matAlMgSi1', key:'AlMgSi1', def:4.80 },
 { id:'mat42CrMo4', key:'42CrMo4', def:2.20 },
 ];
 matFields.forEach(f => {
 const newVal = parseFloat(document.getElementById(f.id)?.value) || f.def;
 const oldVal = DB.materials[f.key]?.price || f.def;
 if (newVal !== oldVal) {
 // Update DB (Single Source of Truth)
 DB.materials[f.key].price = newVal;
 // Propagate change
 propagateChange('Materialpreis', f.key, oldVal + ' €/kg', newVal + ' €/kg');
 }
 });
 }
 
 function syncZuschlagFieldsFromDB() {
 // Sync all Zuschlag input fields from DB (Single Source of Truth)
 const _s = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
 _s('settingScrap', DB.zuschlaege.verschnitt);
 _s('zuschlagMGK', DB.zuschlaege.mgk);
 _s('zuschlagFGK', DB.zuschlaege.fgk);
 _s('zuschlagAV', DB.zuschlaege.av);
 _s('zuschlagVwGK', DB.zuschlaege.vwgk);
 _s('zuschlagVtGK', DB.zuschlaege.vtgk);
 _s('zuschlagGewinn', DB.zuschlaege.gewinn);
 _s('settingVat', DB.zuschlaege.vat || 19);
 // Sondervereinbarungen
 _s('sonderMEK', DB.sondervereinbarungen.mek);
 _s('sonderTransport', DB.sondervereinbarungen.transport);
 const beiEl = document.getElementById('sonderBeistellung');
 if (beiEl) beiEl.checked = DB.sondervereinbarungen.beistellung || false;
 const sonstEl = document.getElementById('sonderSonstiges');
 if (sonstEl) sonstEl.value = DB.sondervereinbarungen.sonstiges || '';
 }
 
 function saveSettings() {
 const settings = { 
     RATES, 
     MATERIALS,
     zuschlaege: DB.zuschlaege,
     sondervereinbarungen: DB.sondervereinbarungen,
     firma: {
         name: document.getElementById('firmaName')?.value,
         ansprech: document.getElementById('firmaAnsprech')?.value,
         strasse: document.getElementById('firmaStrasse')?.value,
         ort: document.getElementById('firmaOrt')?.value,
         tel: document.getElementById('firmaTel')?.value,
         email: document.getElementById('firmaEmail')?.value,
         steuer: document.getElementById('firmaSteuer')?.value,
         iban: document.getElementById('firmaIBAN')?.value
     },
     angebot: {
         gueltigkeit: document.getElementById('angebotsGueltigkeit')?.value,
         lieferzeit: document.getElementById('standardLieferzeit')?.value,
         zahlungsziel: document.getElementById('zahlungsziel')?.value
     }
 };
 localStorage.setItem('cncplanner_settings_v19', JSON.stringify(settings));
 syncSettingsToQuote();
 alert('Einstellungen gespeichert und auf Angebot übertragen.');
 }
 
 function loadSettings() {
 const saved = localStorage.getItem('cncplanner_settings_v19') || localStorage.getItem('cncplanner_settings_v16');
 if (saved) {
 try {
     const settings = JSON.parse(saved);
     if (settings.RATES) Object.assign(RATES, settings.RATES);
     if (settings.MATERIALS) Object.assign(MATERIALS, settings.MATERIALS);
     if (settings.zuschlaege) Object.assign(DB.zuschlaege, settings.zuschlaege);
     if (settings.sondervereinbarungen) Object.assign(DB.sondervereinbarungen, settings.sondervereinbarungen);
     if (settings.firma) {
         if (settings.firma.name) document.getElementById('firmaName').value = settings.firma.name;
         if (settings.firma.ansprech) document.getElementById('firmaAnsprech').value = settings.firma.ansprech;
         if (settings.firma.strasse) document.getElementById('firmaStrasse').value = settings.firma.strasse;
         if (settings.firma.ort) document.getElementById('firmaOrt').value = settings.firma.ort;
         if (settings.firma.tel) document.getElementById('firmaTel').value = settings.firma.tel;
         if (settings.firma.email) document.getElementById('firmaEmail').value = settings.firma.email;
         if (settings.firma.steuer) document.getElementById('firmaSteuer').value = settings.firma.steuer;
         if (settings.firma.iban) document.getElementById('firmaIBAN').value = settings.firma.iban;
     }
     if (settings.angebot) {
         if (settings.angebot.gueltigkeit) document.getElementById('angebotsGueltigkeit').value = settings.angebot.gueltigkeit;
         if (settings.angebot.lieferzeit) document.getElementById('standardLieferzeit').value = settings.angebot.lieferzeit;
         if (settings.angebot.zahlungsziel) document.getElementById('zahlungsziel').value = settings.angebot.zahlungsziel;
     }
     syncSettingsToQuote();
 } catch(e) { console.warn('Settings load error:', e); }
 }
 // Always sync zuschlag fields from DB (whether settings were loaded or using defaults)
 syncZuschlagFieldsFromDB();
 }
 
 function resetSettings() {
 localStorage.removeItem('cncplanner_settings_v16');
 location.reload();
 }
 
 // ================================================================
 // FEEDBACK SYSTEM
 // ================================================================
 
 // Initialize feedback storage
 let feedbackHistory = JSON.parse(localStorage.getItem('cncplanner_feedback') || '[]');
 
 function showFeedbackTab(tab) {
 // Hide all tabs
 ['dashboard', 'eingabe', 'learnings', 'historie'].forEach(t => {
 const el = document.getElementById('feedback-' + t);
 if (el) el.style.display = 'none';
 });
 
 // Reset all buttons
 ['Dashboard', 'Eingabe', 'Learnings', 'Historie'].forEach(t => {
 const el = document.getElementById('tabFeedback' + t);
 if (el) el.className = 'btn btn-sm btn-secondary';
 });
 
 // Show selected tab
 document.getElementById('feedback-' + tab).style.display = 'block';
 document.getElementById('tabFeedback' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 'btn btn-sm btn-primary';
 
 // Update displays
 if (tab === 'learnings') updateCrossLearnings();
 if (tab === 'historie') updateFeedbackHistory();
 if (tab === 'eingabe') renderFeedbackOps();
 }
 
 function toggleAblehnungsgrund() {
 const status = document.getElementById('fbAuftragsstatus')?.value;
 const box = document.getElementById('fbAblehnungBox');
 if (box) box.style.display = status === 'abgelehnt' ? 'block' : 'none';
 }
 
 function updateFeedbackSummary() {
 const rows = document.querySelectorAll('#feedbackOpsTable tr');
 let filled = 0, totalSoll = 0, totalIst = 0;
 rows.forEach(r => {
 const sollCell = r.cells[2];
 const istInput = r.querySelector('input[type="number"]');
 if (sollCell && istInput && istInput.value) {
 filled++;
 const soll = parseFloat(sollCell.textContent.replace(',','.')) || 0;
 const ist = parseFloat(istInput.value) || 0;
 totalSoll += soll;
 totalIst += ist;
 }
 });
 // Setup row
 const setupIst = parseFloat(document.getElementById('fbSetupIst')?.value) || 0;
 const setupSoll = 25;
 if (setupIst > 0) { totalSoll += setupSoll; totalIst += setupIst; filled++; }
 
 const totalOps = rows.length + 1; // +1 for setup
 const el = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
 
 el('fbSummaryOps', filled + ' / ' + totalOps);
 
 if (filled > 0 && totalSoll > 0) {
 const deltaPct = ((totalIst - totalSoll) / totalSoll * 100);
 const sign = deltaPct > 0 ? '+' : '';
 const color = Math.abs(deltaPct) <= 10 ? 'var(--color-success)' : deltaPct > 20 ? 'var(--color-error)' : 'var(--color-warning)';
 const deltaEl = document.getElementById('fbSummaryDelta');
 if (deltaEl) { deltaEl.textContent = sign + deltaPct.toFixed(0).replace('.',',') + ' %'; deltaEl.style.color = color; }
 
 const costDiff = (totalIst - totalSoll) / 60 * 91; // EUR 91/h
 const costEl = document.getElementById('fbSummaryCost');
 if (costEl) { costEl.textContent = (costDiff > 0 ? '+' : '') + DEFormatter.price(costDiff); costEl.style.color = color; }
 }
 }
 
 function updateFeedbackDelta(input) {
 const row = input.closest('tr');
 const kalkCell = row.cells[2].textContent;
 const kalkMin = parseFloat(kalkCell.replace(',', '.').replace(' min', ''));
 const istMin = parseFloat(input.value) || 0;
 const deltaCell = row.querySelector('[data-delta]');
 
 if (istMin >0) {
 const delta = istMin - kalkMin;
 const sign = delta >= 0 ? '+' : '';
 deltaCell.textContent = sign + delta.toFixed(1).replace('.', ',') + ' min';
 deltaCell.style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 } else {
 deltaCell.textContent = '—';
 deltaCell.style.color = '';
 }
 
 updateGesamtzeit();
 updateFeedbackSummary();
 try { updateFeedbackTotals(); } catch(e) {}
 }
 
 function updateSetupDelta() {
 const kalk = 25; // Kalkulierte Setup-Zeit
 const ist = parseFloat(document.getElementById('fbSetupIst').value) || 0;
 const deltaEl = document.getElementById('fbSetupDelta');
 
 if (ist >0) {
 const delta = ist - kalk;
 const sign = delta >= 0 ? '+' : '';
 deltaEl.textContent = sign + delta + ' min';
 deltaEl.style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 } else {
 deltaEl.textContent = '—';
 deltaEl.style.color = '';
 }
 
 updateGesamtzeit();
 updateFeedbackSummary();
 }
 
 function updateGesamtzeit() {
 let gesamtIst = 0;
 let gesamtKalk = 42; // Demo value
 
 // Sum all OP times
 document.querySelectorAll('#feedbackOpsTable input[type="number"]').forEach(input =>{
 gesamtIst += parseFloat(input.value) || 0;
 });
 
 // Add setup
 gesamtIst += parseFloat(document.getElementById('fbSetupIst').value) || 0;
 
 if (gesamtIst >0) {
 document.getElementById('fbGesamtIst').textContent = gesamtIst.toFixed(1).replace('.', ',') + ' min';
 const delta = ((gesamtIst - gesamtKalk) / gesamtKalk * 100);
 const sign = delta >= 0 ? '+' : '';
 document.getElementById('fbGesamtDelta').textContent = sign + delta.toFixed(0) + '%';
 document.getElementById('fbGesamtDelta').style.color = delta >0 ? 'var(--color-error)' : 'var(--color-success)';
 }
 }
 
 function saveFeedback() {
 const feedback = {
 id: Date.now(),
 projektNr: document.getElementById('fbProjektNr').value,
 datum: document.getElementById('fbDatum').value,
 erfasser: document.getElementById('fbErfasser').value || 'Anonym',
 zeitKalk: 42, // Demo
 zeitIst: parseFloat(document.getElementById('fbGesamtIst').textContent) || 42,
 setupKalk: 25,
 setupIst: parseFloat(document.getElementById('fbSetupIst').value) || 25,
 setupGrund: document.getElementById('fbSetupGrund').value,
 setupNotiz: document.getElementById('fbSetupNotiz').value,
 ergebnis: document.querySelector('input[name="fbErgebnis"]:checked')?.value || 'io_erst',
 empfehlung: document.getElementById('fbEmpfehlung').value,
 ops: []
 };
 
 // Collect OP data
 document.querySelectorAll('#feedbackOpsTable tr').forEach(row =>{
 const opCell = row.cells[0];
 if (opCell && opCell.textContent.startsWith('OP')) {
 const istInput = row.querySelector('input[type="number"]');
 const grundSelect = row.querySelector('select');
 const notizInput = row.querySelectorAll('input[type="text"]')[0];
 
 if (istInput && istInput.value) {
 feedback.ops.push({
 op: opCell.textContent,
 kalk: parseFloat(row.cells[2].textContent.replace(',', '.')) || 0,
 ist: parseFloat(istInput.value) || 0,
 grund: grundSelect?.value || '',
 notiz: notizInput?.value || ''
 });
 }
 }
 });
 
 // Save
 feedbackHistory.push(feedback);
 localStorage.setItem('cncplanner_feedback', JSON.stringify(feedbackHistory));
 
 alert('Vielen Dank für Ihre Rückmeldung! Wir melden uns innerhalb von 24 Stunden (werktags) bei Ihnen.');
 clearFeedbackForm();
 }
 
 function clearFeedbackForm() {
 document.querySelectorAll('#feedbackOpsTable input').forEach(i =>i.value = '');
 document.querySelectorAll('#feedbackOpsTable select').forEach(s =>s.selectedIndex = 0);
 document.querySelectorAll('[data-delta]').forEach(d =>{ d.textContent = '—'; d.style.color = ''; });
 document.getElementById('fbSetupIst').value = '';
 document.getElementById('fbSetupDelta').textContent = '—';
 document.getElementById('fbSetupGrund').selectedIndex = 0;
 document.getElementById('fbSetupNotiz').value = '';
 document.getElementById('fbGesamtIst').textContent = '— min';
 document.getElementById('fbGesamtDelta').textContent = '—';
 document.getElementById('fbEmpfehlung').value = '';
 }
 
 function updateCrossLearnings() {
 const count = feedbackHistory.length;
 document.getElementById('feedbackCount').textContent = count;
 
 if (count >0) {
 // Calculate average deviation
 let totalDev = 0;
 feedbackHistory.forEach(f =>{
 totalDev += ((f.zeitIst - f.zeitKalk) / f.zeitKalk) * 100;
 });
 const avgDev = totalDev / count;
 document.getElementById('avgDeviation').textContent = (avgDev >= 0 ? '+' : '') + avgDev.toFixed(0) + '%';
 document.getElementById('avgDeviation').style.color = avgDev >15 ? 'var(--color-error)' : avgDev >0 ? 'var(--color-warning)' : 'var(--color-success)';
 }
 }
 
 function updateFeedbackHistory() {
 const tbody = document.getElementById('feedbackHistoryTable');
 if (feedbackHistory.length === 0) return;
 
 // Add real feedback to table (prepend to demo data)
 const realRows = feedbackHistory.slice(-5).reverse().map(f =>{
 const delta = ((f.zeitIst - f.zeitKalk) / f.zeitKalk * 100);
 const deltaColor = delta >10 ? 'var(--color-error)' : delta< -5 ? 'var(--color-success)' : 'var(--color-warning)';
 const ergebnis = f.ergebnis === 'io_erst' || f.ergebnis === 'io_korrektur' ? ' i.O.' : f.ergebnis === 'nacharbeit' ? ' Nacharbeit' : ' Ausschuss';
 
 return `<tr>
<td class="mono">${f.datum.split('-').reverse().join('.')}</td>
<td class="mono">${f.projektNr}</td>
<td>${f.erfasser}</td>
<td class="mono right">${f.zeitKalk} min</td>
<td class="mono right">${f.zeitIst.toFixed(0)} min</td>
<td class="mono right" style="color: ${deltaColor};">${delta >= 0 ? '+' : ''}${delta.toFixed(0)}%</td>
<td>${f.setupGrund || '—'}</td>
<td>${ergebnis}</td>
</tr>`;
 }).join('');
 }
 
 function applyPattern(patternId, value) {
 // Apply pattern to calculation
 if (patternId === 'setup_parallel') {
 alert(' Muster angewendet!\n\nSetup-Zeit bei Parallelspanner wird um +' + value + ' min erhöht.');
 localStorage.setItem('pattern_setup_parallel', value);
 } else if (patternId === 'tolerance_factor') {
 alert(' Muster angewendet!\n\nToleranz-Faktor für h5/H7 auf ' + value + '× gesetzt.');
 localStorage.setItem('pattern_tolerance_factor', value);
 } else if (patternId === 's235_aufmass') {
 alert(' Muster angewendet!\n\nRohteil-Aufmaß für S235 auf ' + value + ' mm gesetzt.');
 localStorage.setItem('pattern_s235_aufmass', value);
 }
 }
 
 function ignorePattern(patternId) {
 alert('Muster ignoriert. Wird bei genügend neuen Feedbacks erneut geprüft.');
 }
 
 function exportFeedbackCSV() {
 if (feedbackHistory.length === 0) {
 alert('Keine Feedback-Daten vorhanden.');
 return;
 }
 
 let csv = 'Datum;Projekt;Erfasser;Kalk (min);Ist (min);Delta %;Grund;Ergebnis;Empfehlung\n';
 feedbackHistory.forEach(f =>{
 const delta = ((f.zeitIst - f.zeitKalk) / f.zeitKalk * 100).toFixed(0);
 csv += `${f.datum};${f.projektNr};${f.erfasser};${f.zeitKalk};${f.zeitIst};${delta};${f.setupGrund};${f.ergebnis};${f.empfehlung}\n`;
 });
 
 const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
 const link = document.createElement('a');
 link.href = URL.createObjectURL(blob);
 link.download = 'cnc_feedback_export.csv';
 link.click();
 }
 
 function showSettingsTab(tab) {
 // Hide all tabs
 { const _e = document.getElementById('settings-stunden'); if(_e) _e.style.display = 'none'; }
 { const _e = document.getElementById('settings-material'); if(_e) _e.style.display = 'none'; }
 { const _e = document.getElementById('settings-zuschlag'); if(_e) _e.style.display = 'none'; }
 document.getElementById('settings-firma').style.display = 'none';
 
 // Reset all buttons
 { const _e = document.getElementById('tabStunden'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabMaterial'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabZuschlag'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 { const _e = document.getElementById('tabFirma'); if(_e) _e.className = 'btn btn-sm btn-secondary'; }
 
 // Show selected tab
 document.getElementById('settings-' + tab).style.display = 'block';
 document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 'btn btn-sm btn-primary';
 }
 
 function exportSettings() {
 const settings = { RATES, MATERIALS };
 const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'cncplanner-settings.json';
 a.click();
 }
 
 function importSettings() {
 alert('Import-Funktion: Datei auswählen (Coming soon)');
 }
 
 // ================================================================
 // EXPORT
 // ================================================================
 
 function previewLogo(input) {
 const preview = document.getElementById('logoPreview');
 if (input.files && input.files[0]) {
 const reader = new FileReader();
 reader.onload = function(e) {
 preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
 localStorage.setItem('cncplanner_logo', e.target.result);
 };
 reader.readAsDataURL(input.files[0]);
 }
 }
 
 function updatePriceCompare() {
 const compareEl = document.getElementById('comparePrice');
 const resultEl = document.getElementById('priceCompareResult');
 const barEl = document.getElementById('priceCompareBar');
 if (!compareEl || !resultEl) return;
 
 const compare = parseFloat(compareEl.value);
 const sellEl = document.getElementById('sellPrice');
 const ownText = sellEl ? sellEl.textContent.replace(/[^0-9,.-]/g,'').replace('.','').replace(',','.') : '0';
 const own = parseFloat(ownText) || 0;
 
 if (!compare || compare <= 0 || own <= 0) {
 resultEl.innerHTML = '<span style="color:var(--color-text-muted);">Vergleichspreis eingeben</span>';
 barEl.innerHTML = '';
 return;
 }
 
 const diff = own - compare;
 const pct = ((diff / compare) * 100);
 const isHigher = diff > 0;
 const color = isHigher ? 'var(--color-error)' : 'var(--color-success)';
 const sign = isHigher ? '+' : '';
 
 resultEl.innerHTML = `
 <span style="font-weight:600;color:${color};">${sign}${pct.toFixed(1).replace('.',',')} %</span>
 <span style="color:var(--color-text-muted);"> (${sign}${DEFormatter.price(diff)})</span><br>
 <span style="font-size:12px;color:var(--color-text-muted);">Eigene Kalkulation vs. Vergleich</span>
 `;
 
 const maxVal = Math.max(own, compare);
 const ownW = (own / maxVal * 100);
 const compW = (compare / maxVal * 100);
 barEl.innerHTML = `
 <div style="font-size:11px;color:var(--color-text-muted);margin-bottom:2px;">Eigene</div>
 <div style="height:12px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;margin-bottom:4px;">
 <div style="width:${ownW}%;height:100%;background:${color};border-radius:3px;"></div>
 </div>
 <div style="font-size:11px;color:var(--color-text-muted);margin-bottom:2px;">Vergleich</div>
 <div style="height:12px;background:var(--color-bg-subtle);border-radius:3px;overflow:hidden;">
 <div style="width:${compW}%;height:100%;background:var(--color-primary);border-radius:3px;"></div>
 </div>
 `;
 }
 
 function exportCSV() {
 alert('CSV Export — Coming soon');
 }
 
 function copyCode() {
 const code = document.querySelector('#codeBlock pre').textContent;
 navigator.clipboard.writeText(code);
 alert('Code kopiert!');
 }
 
 function downloadCode() {
 const code = document.querySelector('#codeBlock pre').textContent;
 const blob = new Blob([code], { type: 'text/plain' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = 'programm.h';
 a.click();
 }
 
 function setCodeFormat(format) {
 document.querySelectorAll('[id^="btn"]').forEach(btn =>{
 btn.classList.remove('btn-primary');
 btn.classList.add('btn-secondary');
 });
 document.getElementById('btn' + format.charAt(0).toUpperCase() + format.slice(1)).classList.remove('btn-secondary');
 document.getElementById('btn' + format.charAt(0).toUpperCase() + format.slice(1)).classList.add('btn-primary');
 // TODO: Switch code templates
 }
 
 // ================================================================
 // LOADING ANIMATION
 // ================================================================
 
 function showLoading() {
 document.getElementById('loadingOverlay').classList.add('active');
 animateLoadingSteps();
 }
 
 function hideLoading() {
 document.getElementById('loadingOverlay').classList.remove('active');
 document.querySelectorAll('.loading-step').forEach(step =>{
 step.classList.remove('active', 'done');
 });
 }
 
 function animateLoadingSteps() {
 const steps = ['loadStep1', 'loadStep2', 'loadStep3', 'loadStep4', 'loadStep5'];
 let i = 0;
 
 function nextStep() {
 if (i >0) {
 document.getElementById(steps[i - 1]).classList.remove('active');
 document.getElementById(steps[i - 1]).classList.add('done');
 document.getElementById(steps[i - 1]).querySelector('.loading-step-icon').textContent = '✓';
 }
 if (i< steps.length) {
 document.getElementById(steps[i]).classList.add('active');
 i++;
 setTimeout(nextStep, 400 + Math.random() * 200);
 } else {
 setTimeout(hideLoading, 300);
 }
 }
 
 nextStep();
 }
 
 // ================================================================
 // FEEDBACK
 // ================================================================
 
 let selectedFeedback = null;
 
 function selectFeedback(el, type) {
 document.querySelectorAll('.feedback-option').forEach(opt =>opt.classList.remove('selected'));
 el.classList.add('selected');
 selectedFeedback = type;
 }
 
 // submitFeedback defined earlier (with protocol logging)
 
 // ================================================================
 // INIT
 // ================================================================
 
 document.addEventListener('DOMContentLoaded', function() {
 loadSettings();
 renderPartGrid();
 calculate();
 initOpControls();
 
 // Restore saved logo
 const savedLogo = localStorage.getItem('cncplanner_logo');
 if (savedLogo) {
 const lp = document.getElementById('logoPreview');
 if (lp) lp.innerHTML = `<img src="${savedLogo}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
 }
 
 // Initialize quote section
 calculateValidity();
 
 // Optional: Render quote with example data
 // Uncomment to auto-populate quote table:
 /*
 const exampleQuoteData = {
     parts: [{
         name: 'Verbindungsplatte',
         drawingNumber: '2500473.01.11.02.00.001',
         material: 'S235JR',
         quantity: 1,
         price: 170.76,
         articleNumber: 'E-CNC-0001'
     }]
 };
 renderQuote(exampleQuoteData);
 */
 });
</script>
</body>
</html>
