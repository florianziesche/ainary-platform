<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Planner Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #000000;
            --white: #ffffff;
            --green: #00C853;
            --green-dark: #00A844;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-500: #737373;
            --gray-600: #525252;
            --gray-700: #404040;
            --gray-800: #262626;
            --gray-900: #171717;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Header */
        .header {
            background: var(--black);
            color: var(--white);
            padding: 0 32px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.02em;
        }
        
        .logo-mark {
            width: 36px;
            height: 36px;
            background: var(--green);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.9rem;
            color: var(--black);
        }
        
        .header-badge {
            background: var(--green);
            color: var(--black);
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        /* Main Layout */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 32px;
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--gray-200);
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: -0.01em;
        }
        
        .project-list {
            padding: 16px;
        }
        
        .project-item {
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            border: 2px solid transparent;
            position: relative;
        }
        
        .project-item:last-child { margin-bottom: 0; }
        
        .project-item:hover {
            background: var(--gray-50);
        }
        
        .project-item.active {
            background: var(--black);
            color: var(--white);
        }
        
        .project-item.active .project-meta { color: var(--gray-400); }
        .project-item.active .project-price { color: var(--green); }
        
        .project-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
            letter-spacing: -0.01em;
        }
        
        .project-meta {
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .project-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--green-dark);
            margin-top: 12px;
            letter-spacing: -0.02em;
        }
        
        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }
        
        .stat-card {
            background: var(--white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .stat-value.green { color: var(--green-dark); }
        
        /* Tabs */
        .tabs-wrap {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .tabs-nav {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 24px;
        }
        
        .tab-btn {
            padding: 20px 24px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--gray-400);
            cursor: pointer;
            border: none;
            background: none;
            position: relative;
            transition: color 0.2s;
        }
        
        .tab-btn:hover { color: var(--gray-600); }
        
        .tab-btn.active {
            color: var(--black);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 24px;
            right: 24px;
            height: 2px;
            background: var(--black);
        }
        
        .tab-panel {
            display: none;
            padding: 32px;
        }
        
        .tab-panel.active { display: block; }
        
        /* Operations Table */
        .ops-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .ops-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--gray-500);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .ops-table td {
            padding: 16px;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }
        
        .ops-table tr:last-child td { border-bottom: none; }
        
        .ops-table tr:hover td { background: var(--gray-50); }
        
        .op-num {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--gray-400);
        }
        
        .op-name { font-weight: 600; }
        
        .op-tool { color: var(--gray-500); }
        
        .time-bar {
            width: 80px;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .time-bar-fill {
            height: 100%;
            background: var(--black);
            border-radius: 2px;
        }
        
        /* NC Code */
        .nc-formats {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .format-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
            background: var(--white);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .format-btn:hover {
            border-color: var(--black);
        }
        
        .format-btn.active {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }
        
        .nc-code {
            background: var(--gray-900);
            color: var(--gray-300);
            padding: 24px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .nc-code .comment { color: var(--green); }
        .nc-code .keyword { color: #60a5fa; }
        .nc-code .number { color: #fbbf24; }
        
        .nc-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        /* Series Grid */
        .series-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .series-card {
            background: var(--gray-50);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .series-card:hover {
            border-color: var(--gray-300);
        }
        
        .series-card.active {
            background: var(--black);
            color: var(--white);
            border-color: var(--black);
        }
        
        .series-qty {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }
        
        .series-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }
        
        .series-card.active .series-label { color: var(--gray-400); }
        
        .series-price {
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 16px;
            color: var(--green-dark);
        }
        
        .series-card.active .series-price { color: var(--green); }
        
        .series-discount {
            font-size: 0.75rem;
            color: var(--green-dark);
            margin-top: 4px;
            font-weight: 600;
        }
        
        .series-card.active .series-discount { color: var(--green); }
        
        .series-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: var(--black);
            color: var(--white);
            border-radius: 12px;
        }
        
        .series-total-label {
            font-size: 0.9rem;
        }
        
        .series-total-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--green);
            letter-spacing: -0.02em;
        }
        
        /* Costs */
        .costs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }
        
        .cost-section h3 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -0.01em;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9rem;
        }
        
        .cost-row:last-child { border-bottom: none; }
        
        .cost-label { color: var(--gray-600); }
        
        .cost-value {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .cost-total {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--black);
        }
        
        .cost-total .cost-row {
            border-bottom: none;
            padding: 0;
        }
        
        .cost-total .cost-label { font-weight: 700; }
        
        .cost-total .cost-value {
            font-size: 1.25rem;
            font-weight: 800;
        }
        
        .cost-total .cost-value.green { color: var(--green-dark); }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--black);
            color: var(--white);
        }
        
        .btn-primary:hover { background: var(--gray-800); }
        
        .btn-success {
            background: var(--green);
            color: var(--black);
        }
        
        .btn-success:hover { background: var(--green-dark); }
        
        .btn-outline {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--gray-300);
        }
        
        .btn-outline:hover { border-color: var(--black); }
        
        .btn-full { width: 100%; justify-content: center; }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-row { grid-template-columns: repeat(3, 1fr); }
            .series-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 900px) {
            .main { grid-template-columns: 1fr; }
            .costs-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 600px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .series-grid { grid-template-columns: repeat(2, 1fr); }
            .main { padding: 16px; }
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 500;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success { background: var(--green-dark); color: var(--white); }
    </style>
</head>
<body>

<header class="header">
    <div class="header-inner">
        <div class="logo">
            <div class="logo-mark">CP</div>
            CNC Planner Pro
        </div>
        <div class="header-badge">Live Demo</div>
    </div>
</header>

<main class="main">
    <aside class="sidebar">
        <div class="card">
            <div class="card-header">Projekte</div>
            <div class="project-list" id="projectList"></div>
        </div>
    </aside>
    
    <div class="content">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">Werkstoff</div>
                <div class="stat-value" id="statMaterial">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Abmessungen</div>
                <div class="stat-value" id="statDims">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Gewicht</div>
                <div class="stat-value" id="statWeight">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Fertigungszeit</div>
                <div class="stat-value" id="statTime">—</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Verkaufspreis</div>
                <div class="stat-value green" id="statPrice">—</div>
            </div>
        </div>
        
        <div class="tabs-wrap">
            <nav class="tabs-nav">
                <button class="tab-btn active" onclick="showTab('ops')">Operationen</button>
                <button class="tab-btn" onclick="showTab('nc')">NC-Code</button>
                <button class="tab-btn" onclick="showTab('series')">Serienkalkulation</button>
                <button class="tab-btn" onclick="showTab('costs')">Kostenaufstellung</button>
            </nav>
            
            <div class="tab-panel active" id="panel-ops">
                <table class="ops-table">
                    <thead>
                        <tr>
                            <th style="width:60px">Nr.</th>
                            <th>Operation</th>
                            <th>Werkzeug</th>
                            <th style="width:100px">Zeit</th>
                            <th style="width:100px"></th>
                        </tr>
                    </thead>
                    <tbody id="opsBody"></tbody>
                </table>
            </div>
            
            <div class="tab-panel" id="panel-nc">
                <div class="nc-formats">
                    <button class="format-btn active" onclick="setFormat('heidenhain')">Heidenhain</button>
                    <button class="format-btn" onclick="setFormat('siemens')">Siemens</button>
                    <button class="format-btn" onclick="setFormat('fanuc')">Fanuc</button>
                </div>
                <div class="nc-code" id="ncCode"></div>
                <div class="nc-actions">
                    <button class="btn btn-primary" onclick="copyCode()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="10" height="10" rx="2"/><path d="M2 10V3a1 1 0 0 1 1-1h7"/></svg>
                        Kopieren
                    </button>
                    <button class="btn btn-outline" onclick="downloadCode()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 2v10m0 0-3-3m3 3 3-3M2 14h12"/></svg>
                        Herunterladen
                    </button>
                </div>
            </div>
            
            <div class="tab-panel" id="panel-series">
                <div class="series-grid" id="seriesGrid"></div>
                <div class="series-total">
                    <div class="series-total-label">Gesamtpreis bei <strong id="seriesQtyLabel">1</strong> Stück</div>
                    <div class="series-total-value" id="seriesTotalPrice">—</div>
                </div>
            </div>
            
            <div class="tab-panel" id="panel-costs">
                <div class="costs-grid">
                    <div class="cost-section">
                        <h3>Kostenaufstellung</h3>
                        <div class="cost-row">
                            <span class="cost-label">Rohmaterial</span>
                            <span class="cost-value" id="costMaterial">—</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Maschinenkosten</span>
                            <span class="cost-value" id="costMachine">—</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Werkzeugverschleiß</span>
                            <span class="cost-value" id="costTool">—</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Rüstzeit (15 min)</span>
                            <span class="cost-value" id="costSetup">—</span>
                        </div>
                        <div class="cost-total">
                            <div class="cost-row">
                                <span class="cost-label">Selbstkosten</span>
                                <span class="cost-value" id="costTotal">—</span>
                            </div>
                        </div>
                    </div>
                    <div class="cost-section">
                        <h3>Preiskalkulation</h3>
                        <div class="cost-row">
                            <span class="cost-label">Selbstkosten</span>
                            <span class="cost-value" id="priceBase">—</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">+ Marge <span id="marginPct">20</span>%</span>
                            <span class="cost-value" id="priceMargin">—</span>
                        </div>
                        <div class="cost-total">
                            <div class="cost-row">
                                <span class="cost-label">Verkaufspreis</span>
                                <span class="cost-value green" id="priceSell">—</span>
                            </div>
                        </div>
                        <button class="btn btn-success btn-full" style="margin-top:24px" onclick="generateQuote()">
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8l-6-6z"/><path d="M6 2v6h6M10 13H6m4-3H6"/></svg>
                            Angebot erstellen (PDF)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="toast" id="toast"></div>

<script>
const projects = [
    {
        id: "GP-2026-001",
        name: "Grundplatte Antriebseinheit",
        material: "1.4571",
        materialFull: "1.4571 (V4A Edelstahl)",
        dims: { l: 160, w: 160, h: 30 },
        weight: 6.1,
        operations: [
            { name: "Planfräsen", time: 2.7, tool: "Schaftfräser ∅63" },
            { name: "Schruppen Außenkontur ∅120", time: 8.0, tool: "Schaftfräser ∅20" },
            { name: "Schruppen Innenkontur ∅44", time: 4.8, tool: "Schaftfräser ∅16" },
            { name: "Bohren 8× ∅9", time: 4.4, tool: "Spiralbohrer ∅9" },
            { name: "Schlichten ∅120 h5", time: 5.1, tool: "Schaftfräser ∅20" },
            { name: "Feinbohren ∅26 H7", time: 4.1, tool: "Feinbohrwerkzeug" },
            { name: "Feinbohren ∅44 H7", time: 3.1, tool: "Feinbohrwerkzeug" },
            { name: "Stufen fräsen", time: 3.9, tool: "Schaftfräser ∅10" },
            { name: "Gewinde 4× M10", time: 3.4, tool: "Gewindefräser M10" },
            { name: "Anfasen", time: 2.3, tool: "Fasenfräser 45°" }
        ],
        totalTime: 41.8,
        costs: { material: 52.80, machine: 59.20, tool: 8.50, setup: 21.25 },
        margin: 20
    },
    {
        id: "FL-2026-042",
        name: "Flansch Hydraulikzylinder",
        material: "42CrMo4",
        materialFull: "42CrMo4 (Vergütungsstahl)",
        dims: { l: 200, w: 200, h: 45 },
        weight: 14.1,
        operations: [
            { name: "Planfräsen beidseitig", time: 4.2, tool: "Planfräser ∅80" },
            { name: "Außenkontur ∅180", time: 12.5, tool: "Schaftfräser ∅25" },
            { name: "Zentrierbohrung", time: 0.8, tool: "Zentrierbohrer" },
            { name: "Kernloch ∅52", time: 3.2, tool: "Spiralbohrer ∅52" },
            { name: "Aufbohren ∅68 H7", time: 6.4, tool: "Aufbohrwerkzeug" },
            { name: "Dichtungsnut ∅72×3", time: 4.8, tool: "Nutfräser 3mm" },
            { name: "Lochkreis 6× ∅13", time: 5.6, tool: "Spiralbohrer ∅13" },
            { name: "Senkungen 6× ∅24", time: 3.2, tool: "Flachsenker ∅24" },
            { name: "O-Ring Nut", time: 3.8, tool: "Nutstecher" },
            { name: "Schlichten + Anfasen", time: 4.5, tool: "Diverse" }
        ],
        totalTime: 49.0,
        costs: { material: 89.60, machine: 69.40, tool: 12.80, setup: 21.25 },
        margin: 20
    },
    {
        id: "LB-2026-017",
        name: "Lagerbock Getriebe",
        material: "GJS-500-7",
        materialFull: "EN-GJS-500-7 (Sphäroguss)",
        dims: { l: 280, w: 120, h: 85 },
        weight: 20.0,
        operations: [
            { name: "Aufspannen + Ausrichten", time: 8.0, tool: "—" },
            { name: "Planfräsen Grundfläche", time: 5.2, tool: "Planfräser ∅63" },
            { name: "Bohrung ∅85 H7", time: 12.4, tool: "Bohrstange" },
            { name: "Bohrung ∅52 H7", time: 8.6, tool: "Bohrstange" },
            { name: "Befestigung 4× ∅18", time: 4.8, tool: "Spiralbohrer ∅18" },
            { name: "Gewinde 4× M16", time: 5.2, tool: "Gewindebohrer M16" },
            { name: "Schmiernippel M8", time: 1.8, tool: "Gewindebohrer M8" },
            { name: "Freistiche + Fasen", time: 3.5, tool: "Diverse" },
            { name: "Schlichten Lagersitze", time: 8.2, tool: "Feinbohrstange" },
            { name: "Entgraten + Reinigen", time: 4.0, tool: "—" }
        ],
        totalTime: 61.7,
        costs: { material: 78.40, machine: 87.40, tool: 15.20, setup: 21.25 },
        margin: 20
    }
];

let current = projects[0];
let format = 'heidenhain';
let qty = 1;

const calc = p => {
    const total = p.costs.material + p.costs.machine + p.costs.tool + p.costs.setup;
    return { total, sell: total * (1 + p.margin / 100) };
};

function init() {
    renderList();
    select(current);
}

function renderList() {
    document.getElementById('projectList').innerHTML = projects.map(p => {
        const { sell } = calc(p);
        return `<div class="project-item ${current.id === p.id ? 'active' : ''}" onclick="select(projects.find(x => x.id === '${p.id}'))">
            <div class="project-name">${p.name}</div>
            <div class="project-meta">${p.id} · ${p.material}</div>
            <div class="project-price">€${sell.toFixed(2)}</div>
        </div>`;
    }).join('');
}

function select(p) {
    current = p;
    qty = 1;
    renderList();
    update();
}

function update() {
    const p = current;
    const { total, sell } = calc(p);
    
    document.getElementById('statMaterial').textContent = p.material;
    document.getElementById('statDims').textContent = `${p.dims.l}×${p.dims.w}×${p.dims.h}`;
    document.getElementById('statWeight').textContent = p.weight + ' kg';
    document.getElementById('statTime').textContent = p.totalTime + ' min';
    document.getElementById('statPrice').textContent = '€' + sell.toFixed(2);
    
    const maxT = Math.max(...p.operations.map(o => o.time));
    document.getElementById('opsBody').innerHTML = p.operations.map((op, i) => `<tr>
        <td class="op-num">${String(i + 1).padStart(2, '0')}</td>
        <td class="op-name">${op.name}</td>
        <td class="op-tool">${op.tool}</td>
        <td>${op.time.toFixed(1)} min</td>
        <td><div class="time-bar"><div class="time-bar-fill" style="width:${op.time/maxT*100}%"></div></div></td>
    </tr>`).join('');
    
    updateNC();
    updateSeries();
    
    document.getElementById('costMaterial').textContent = '€' + p.costs.material.toFixed(2);
    document.getElementById('costMachine').textContent = '€' + p.costs.machine.toFixed(2);
    document.getElementById('costTool').textContent = '€' + p.costs.tool.toFixed(2);
    document.getElementById('costSetup').textContent = '€' + p.costs.setup.toFixed(2);
    document.getElementById('costTotal').textContent = '€' + total.toFixed(2);
    document.getElementById('priceBase').textContent = '€' + total.toFixed(2);
    document.getElementById('marginPct').textContent = p.margin;
    document.getElementById('priceMargin').textContent = '€' + (total * p.margin / 100).toFixed(2);
    document.getElementById('priceSell').textContent = '€' + sell.toFixed(2);
}

function updateSeries() {
    const p = current;
    const qtys = [1, 5, 10, 25, 50];
    const { sell } = calc(p);
    
    document.getElementById('seriesGrid').innerHTML = qtys.map(q => {
        const unitCost = (p.costs.material + p.costs.machine + p.costs.tool) + (p.costs.setup / q);
        const unitPrice = unitCost * (1 + p.margin / 100);
        const disc = q > 1 ? Math.round((1 - unitPrice / sell) * 100) : 0;
        return `<div class="series-card ${qty === q ? 'active' : ''}" onclick="setQty(${q})">
            <div class="series-qty">${q}</div>
            <div class="series-label">Stück</div>
            <div class="series-price">€${unitPrice.toFixed(2)}</div>
            ${disc ? `<div class="series-discount">-${disc}% Rabatt</div>` : ''}
        </div>`;
    }).join('');
    
    const unitCost = (p.costs.material + p.costs.machine + p.costs.tool) + (p.costs.setup / qty);
    const unitPrice = unitCost * (1 + p.margin / 100);
    document.getElementById('seriesQtyLabel').textContent = qty;
    document.getElementById('seriesTotalPrice').textContent = '€' + (unitPrice * qty).toFixed(2);
}

function setQty(q) { qty = q; updateSeries(); }

function showTab(id) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');
    document.getElementById('panel-' + id).classList.add('active');
}

function setFormat(f) {
    format = f;
    document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[onclick="setFormat('${f}')"]`).classList.add('active');
    updateNC();
}

function updateNC() {
    const p = current;
    const date = new Date().toLocaleDateString('de-DE');
    let code = '';
    
    if (format === 'heidenhain') {
        code = `<span class="comment">; ${p.name}</span>
<span class="comment">; Zeichnung: ${p.id}</span>
<span class="comment">; Werkstoff: ${p.materialFull}</span>
<span class="comment">; Erstellt: ${date}</span>

<span class="keyword">BEGIN PGM</span> ${p.id.replace(/-/g, '_')} <span class="keyword">MM</span>

<span class="comment">; Werkzeugdefinitionen</span>
<span class="keyword">TOOL DEF</span> <span class="number">1</span> L+0 R+31.5
<span class="keyword">TOOL DEF</span> <span class="number">2</span> L+0 R+10
<span class="keyword">TOOL DEF</span> <span class="number">3</span> L+0 R+8

<span class="comment">; Nullpunkt setzen</span>
<span class="keyword">TOOL CALL</span> <span class="number">1</span> Z S<span class="number">800</span> F<span class="number">250</span>
L Z+<span class="number">100</span> R0 FMAX M3

${p.operations.map((op, i) => `<span class="comment">; OP${(i+1)*10} - ${op.name}</span>
<span class="comment">; Werkzeug: ${op.tool}</span>
<span class="comment">; Zeit: ${op.time.toFixed(1)} min</span>
`).join('')}
<span class="keyword">L</span> Z+<span class="number">100</span> FMAX M5
<span class="keyword">M30</span>

<span class="keyword">END PGM</span> ${p.id.replace(/-/g, '_')} <span class="keyword">MM</span>`;
    } else if (format === 'siemens') {
        code = `<span class="comment">; ${p.name}</span>
<span class="comment">; Zeichnung: ${p.id}</span>
<span class="comment">; Werkstoff: ${p.materialFull}</span>

<span class="keyword">%_N_</span>${p.id.replace(/-/g, '_')}<span class="keyword">_MPF</span>

N<span class="number">10</span> <span class="keyword">G90 G17 G54</span>
N<span class="number">20</span> T<span class="number">1</span> D<span class="number">1</span>
N<span class="number">30</span> <span class="keyword">M6</span>
N<span class="number">40</span> S<span class="number">800</span> <span class="keyword">M3</span> F<span class="number">250</span>
N<span class="number">50</span> <span class="keyword">G0</span> X<span class="number">-100</span> Y<span class="number">-100</span> Z<span class="number">100</span>

${p.operations.map((op, i) => `<span class="comment">; OP${(i+1)*10} - ${op.name}</span>
N<span class="number">${100 + i*10}</span> <span class="comment">; ${op.tool}</span>
`).join('')}
N<span class="number">990</span> <span class="keyword">G0</span> Z<span class="number">100</span> <span class="keyword">M5</span>
N<span class="number">999</span> <span class="keyword">M30</span>`;
    } else {
        code = `<span class="comment">( ${p.name} )</span>
<span class="comment">( Zeichnung: ${p.id} )</span>
<span class="comment">( Werkstoff: ${p.materialFull} )</span>

<span class="keyword">O</span>${p.id.replace(/[^0-9]/g, '').slice(0, 4)}
N<span class="number">10</span> <span class="keyword">G90 G17 G21 G54</span>
N<span class="number">20</span> T<span class="number">01</span> <span class="keyword">M06</span>
N<span class="number">30</span> S<span class="number">800</span> <span class="keyword">M03</span>
N<span class="number">40</span> <span class="keyword">G00</span> X<span class="number">-100.</span> Y<span class="number">-100.</span> Z<span class="number">100.</span>

${p.operations.map((op, i) => `<span class="comment">( OP${(i+1)*10} - ${op.name} )</span>
N<span class="number">${100 + i*10}</span> <span class="comment">( ${op.tool} )</span>
`).join('')}
N<span class="number">990</span> <span class="keyword">G00</span> Z<span class="number">100.</span> <span class="keyword">M05</span>
N<span class="number">999</span> <span class="keyword">M30</span>
<span class="keyword">%</span>`;
    }
    
    document.getElementById('ncCode').innerHTML = code;
}

function copyCode() {
    const code = document.getElementById('ncCode').textContent;
    navigator.clipboard.writeText(code);
    toast('NC-Code kopiert!', 'success');
}

function downloadCode() {
    const code = document.getElementById('ncCode').textContent;
    const ext = format === 'heidenhain' ? 'h' : format === 'siemens' ? 'mpf' : 'nc';
    const blob = new Blob([code], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = current.id + '.' + ext;
    a.click();
    toast('NC-Code heruntergeladen', 'success');
}

function generateQuote() {
    const p = current;
    const { total, sell } = calc(p);
    const angNr = 'ANG-' + Date.now().toString().slice(-6);
    const date = new Date().toLocaleDateString('de-DE');
    
    const w = window.open('', '_blank');
    w.document.write(`<!DOCTYPE html>
<html>
<head>
<title>Angebot ${angNr}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; padding: 48px; max-width: 800px; margin: 0 auto; color: #171717; line-height: 1.6; }
.header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 48px; padding-bottom: 24px; border-bottom: 2px solid #000; }
.logo { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em; }
.logo-sub { font-size: 0.9rem; font-weight: 400; color: #737373; }
.doc-info { text-align: right; }
.doc-title { font-size: 0.8rem; color: #737373; text-transform: uppercase; letter-spacing: 0.1em; }
.doc-value { font-size: 1.1rem; font-weight: 700; }
h2 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; color: #737373; margin-bottom: 16px; margin-top: 32px; }
.details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.detail { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
.detail-label { color: #525252; }
.detail-value { font-weight: 600; font-family: monospace; }
.costs-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
.costs-table th { text-align: left; padding: 12px 16px; background: #f5f5f5; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.08em; color: #525252; }
.costs-table td { padding: 16px; border-bottom: 1px solid #e5e5e5; }
.costs-table td:last-child { text-align: right; font-family: monospace; font-weight: 600; }
.total-row { background: #000; color: #fff; }
.total-row td { font-weight: 700; font-size: 1.1rem; }
.total-row td:last-child { color: #00C853; }
.footer { margin-top: 48px; padding-top: 24px; border-top: 1px solid #e5e5e5; font-size: 0.85rem; color: #737373; }
.footer p { margin-bottom: 8px; }
@media print { body { padding: 24px; } }
</style>
</head>
<body>
<div class="header">
<div>
<div class="logo">CNC Planner Pro</div>
<div class="logo-sub">Fertigungskalkulation</div>
</div>
<div class="doc-info">
<div class="doc-title">Angebot</div>
<div class="doc-value">${angNr}</div>
<div style="margin-top:8px;font-size:0.9rem;color:#737373">${date}</div>
</div>
</div>

<h2>Projektdetails</h2>
<div class="details-grid">
<div class="detail"><span class="detail-label">Benennung</span><span class="detail-value">${p.name}</span></div>
<div class="detail"><span class="detail-label">Zeichnung</span><span class="detail-value">${p.id}</span></div>
<div class="detail"><span class="detail-label">Werkstoff</span><span class="detail-value">${p.materialFull}</span></div>
<div class="detail"><span class="detail-label">Abmessungen</span><span class="detail-value">${p.dims.l} × ${p.dims.w} × ${p.dims.h} mm</span></div>
<div class="detail"><span class="detail-label">Gewicht</span><span class="detail-value">${p.weight.toFixed(1)} kg</span></div>
<div class="detail"><span class="detail-label">Fertigungszeit</span><span class="detail-value">${p.totalTime.toFixed(1)} min</span></div>
</div>

<h2>Preiskalkulation</h2>
<table class="costs-table">
<thead><tr><th>Position</th><th style="text-align:right">Betrag</th></tr></thead>
<tbody>
<tr><td>Rohmaterial (${p.weight.toFixed(1)} kg ${p.material})</td><td>€${p.costs.material.toFixed(2)}</td></tr>
<tr><td>Maschinenkosten (${p.totalTime.toFixed(0)} min × €1,42/min)</td><td>€${p.costs.machine.toFixed(2)}</td></tr>
<tr><td>Werkzeugverschleiß</td><td>€${p.costs.tool.toFixed(2)}</td></tr>
<tr><td>Rüstzeit (15 min × €1,42/min)</td><td>€${p.costs.setup.toFixed(2)}</td></tr>
<tr style="background:#f5f5f5"><td><strong>Selbstkosten</strong></td><td><strong>€${total.toFixed(2)}</strong></td></tr>
<tr><td>Aufschlag ${p.margin}%</td><td>€${(sell - total).toFixed(2)}</td></tr>
<tr class="total-row"><td>Verkaufspreis (netto)</td><td>€${sell.toFixed(2)}</td></tr>
</tbody>
</table>

<div class="footer">
<p><strong>Gültigkeit:</strong> 14 Tage ab Angebotsdatum</p>
<p><strong>Lieferzeit:</strong> ca. 2-3 Wochen nach Auftragserteilung</p>
<p><strong>Zahlung:</strong> 14 Tage netto</p>
<p style="margin-top:16px">Alle Preise verstehen sich zuzüglich der gesetzlichen Mehrwertsteuer.</p>
</div>

<script>window.onload = () => { setTimeout(() => window.print(), 500); }<\/script>
</body>
</html>`);
    w.document.close();
}

function toast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show ' + type;
    setTimeout(() => t.classList.remove('show'), 3000);
}

init();
</script>
</body>
</html>
