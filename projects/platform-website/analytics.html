<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex">
<title>Ainary · Analytics</title>
<style>
:root{--bg:#0a0a0e;--surface:#111418;--border:rgba(255,255,255,0.08);--text:#ededf0;--muted:#8b8b95;--dim:#55555e;--gold:#e8c84a;--blue:#2D72D2;--green:#238551;--red:#CD4246;--f:Inter,system-ui,sans-serif;--m:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font:400 14px/1.6 var(--f);min-height:100vh}
.header{padding:20px 32px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.header h1{font:600 16px var(--f);display:flex;align-items:center;gap:8px}
.header h1::before{content:'';width:8px;height:8px;border-radius:50%;background:var(--gold)}
.live{font:400 10px var(--m);color:var(--green);display:flex;align-items:center;gap:6px}
.live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;padding:24px 32px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px}
.card-label{font:400 11px var(--m);color:var(--dim);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px}
.card-value{font:600 28px var(--f);color:var(--text)}
.card-sub{font:400 11px var(--f);color:var(--muted);margin-top:4px}
.section{padding:0 32px 24px}
.section-title{font:600 13px var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:16px}
table{width:100%;border-collapse:collapse;background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
th{font:500 11px var(--m);color:var(--dim);text-transform:uppercase;letter-spacing:.06em;padding:12px 16px;text-align:left;border-bottom:1px solid var(--border)}
td{font:400 13px var(--f);color:var(--text);padding:10px 16px;border-bottom:1px solid var(--border)}
tr:last-child td{border-bottom:none}
.bar{height:4px;border-radius:2px;background:var(--blue);display:inline-block;vertical-align:middle;margin-left:8px}
.tag{font:400 10px var(--m);padding:2px 6px;border-radius:3px;background:rgba(45,114,210,.15);color:var(--blue)}
.tag-green{background:rgba(35,133,81,.15);color:var(--green)}
.tag-gold{background:rgba(232,200,74,.15);color:var(--gold)}
.tag-red{background:rgba(205,66,70,.15);color:var(--red)}
.empty{text-align:center;padding:40px;color:var(--dim);font:400 13px var(--f)}
.refresh{font:400 11px var(--m);color:var(--dim);cursor:pointer;padding:4px 10px;border:1px solid var(--border);border-radius:4px;background:none}
.refresh:hover{border-color:var(--muted);color:var(--muted)}
#auth-gate{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999}
#auth-box{text-align:center}
#auth-box input{width:240px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text);font:400 13px var(--m);text-align:center;outline:none}
#auth-box button{margin-top:12px;padding:8px 24px;background:var(--gold);color:#111;border:none;border-radius:6px;font:600 12px var(--m);cursor:pointer}
@media(max-width:768px){.grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>

<div id="auth-gate">
<div id="auth-box">
<div style="font:600 14px var(--f);margin-bottom:16px">Ainary Analytics</div>
<input id="pw" type="password" placeholder="Admin-Passwort" onkeydown="if(event.key==='Enter')authCheck()">
<br><button onclick="authCheck()">ZUGANG</button>
</div>
</div>

<div id="app" style="display:none">
<div class="header">
  <h1>Ainary Analytics</h1>
  <div style="display:flex;gap:16px;align-items:center">
    <span class="live">LIVE</span>
    <button class="refresh" onclick="loadData()">↻ Refresh</button>
    <span id="last-update" style="font:400 10px var(--m);color:var(--dim)"></span>
  </div>
</div>

<div class="grid" id="kpis"></div>

<div class="section">
  <div class="section-title">Besucher-Sessions (Dossier Tracking)</div>
  <table>
    <thead><tr><th>IP</th><th>Browser</th><th>Erster Besuch</th><th>Letzter Besuch</th><th>Dauer</th><th>Events</th><th>Tabs</th></tr></thead>
    <tbody id="sessions"></tbody>
  </table>
</div>

<div class="section" style="margin-top:24px">
  <div class="section-title">Event-Log (letzte 50)</div>
  <table>
    <thead><tr><th>Zeit</th><th>IP</th><th>Event</th><th>Details</th></tr></thead>
    <tbody id="events"></tbody>
  </table>
</div>

<div class="section" style="margin-top:24px">
  <div class="section-title">Newsletter Subscribers</div>
  <table>
    <thead><tr><th>Email</th><th>Quelle</th><th>Datum</th></tr></thead>
    <tbody id="subs"></tbody>
  </table>
</div>
</div>

<script>
var MY_IP = '91.2.110.113';

function authCheck(){
  if(document.getElementById('pw').value==='ainary2026'){
    document.getElementById('auth-gate').style.display='none';
    document.getElementById('app').style.display='block';
    loadData();
  }
}
// Auto-auth via URL param
if(new URLSearchParams(location.search).get('key')==='ainary2026'){
  document.getElementById('auth-gate').style.display='none';
  document.getElementById('app').style.display='block';
  setTimeout(loadData,100);
}

function loadData(){
  document.getElementById('last-update').textContent='Loading...';
  Promise.all([
    fetch('/api/track?admin=ainary2026').then(r=>r.json()).catch(()=>({events:[],count:0})),
    fetch('/api/subscribe?admin=ainary2026').then(r=>r.text()).catch(()=>'')
  ]).then(function(results){
    var track = results[0];
    var subsRaw = results[1];
    renderKPIs(track);
    renderSessions(track);
    renderEvents(track);
    renderSubs(subsRaw);
    document.getElementById('last-update').textContent='Updated: '+new Date().toLocaleTimeString('de-DE');
  });
}

function renderKPIs(data){
  var events = data.events||[];
  var ips = {};
  events.forEach(function(e){ ips[e.ip]=1; });
  var uniqueIPs = Object.keys(ips).filter(function(ip){ return ip!==MY_IP; }).length;
  var totalEvents = events.filter(function(e){ return e.ip!==MY_IP; }).length;
  var sessionEnds = events.filter(function(e){ return e.e==='session_end'&&e.ip!==MY_IP; });
  var avgDuration = 0;
  if(sessionEnds.length){
    var total=0;
    sessionEnds.forEach(function(e){total+=(e.d&&e.d.duration_ms)||0;});
    avgDuration=Math.round(total/sessionEnds.length/60000);
  }
  var tabVisits={};
  sessionEnds.forEach(function(e){
    if(e.d&&e.d.tabs){
      Object.keys(e.d.tabs).forEach(function(t){
        tabVisits[t]=(tabVisits[t]||0)+e.d.tabs[t].visits;
      });
    }
  });
  var topTab=Object.keys(tabVisits).sort(function(a,b){return tabVisits[b]-tabVisits[a];})[0]||'—';

  document.getElementById('kpis').innerHTML=
    kpiCard('Externe Besucher',uniqueIPs,'Ohne eigene IP')+
    kpiCard('Events',totalEvents,'Externe Events')+
    kpiCard('Ø Session-Dauer',avgDuration+' min',sessionEnds.length+' Sessions')+
    kpiCard('Top Tab',topTab,tabVisits[topTab]?tabVisits[topTab]+' Besuche':'—');
}

function kpiCard(label,value,sub){
  return '<div class="card"><div class="card-label">'+label+'</div><div class="card-value">'+value+'</div><div class="card-sub">'+sub+'</div></div>';
}

function renderSessions(data){
  var events = data.events||[];
  var byIP={};
  events.forEach(function(e){
    if(e.ip===MY_IP)return;
    if(!byIP[e.ip])byIP[e.ip]={events:0,first:e.ts,last:e.ts,ua:e.ua,tabs:{},sessions:{}};
    byIP[e.ip].events++;
    byIP[e.ip].sessions[e.s]=1;
    if(e.ts<byIP[e.ip].first)byIP[e.ip].first=e.ts;
    if(e.ts>byIP[e.ip].last)byIP[e.ip].last=e.ts;
    if(e.e==='session_end'&&e.d&&e.d.tabs){
      Object.keys(e.d.tabs).forEach(function(t){
        byIP[e.ip].tabs[t]=(byIP[e.ip].tabs[t]||0)+e.d.tabs[t].visits;
      });
    }
  });
  var html='';
  var entries=Object.entries(byIP).sort(function(a,b){return b[1].last-a[1].last;});
  if(!entries.length){html='<tr><td colspan="7" class="empty">Keine externen Besucher seit letztem Cold Start</td></tr>';}
  entries.forEach(function(pair){
    var ip=pair[0],v=pair[1];
    var browser=v.ua.includes('Chrome')?'Chrome':v.ua.includes('Safari')?'Safari':v.ua.includes('Firefox')?'Firefox':'Other';
    var os=v.ua.includes('Mac')?'Mac':v.ua.includes('Windows')?'Windows':v.ua.includes('Linux')?'Linux':'Other';
    var dur=Math.round((v.last-v.first)/60000);
    var tabs=Object.keys(v.tabs).map(function(t){return '<span class="tag">'+t+' ('+v.tabs[t]+')</span>';}).join(' ')||'<span style="color:var(--dim)">—</span>';
    html+='<tr><td style="font-family:var(--m);font-size:11px">'+ip+'</td><td>'+browser+'/'+os+'</td><td>'+new Date(v.first).toLocaleString('de-DE',{timeZone:'Europe/Berlin'})+'</td><td>'+new Date(v.last).toLocaleString('de-DE',{timeZone:'Europe/Berlin'})+'</td><td>'+dur+' min</td><td>'+v.events+'</td><td>'+tabs+'</td></tr>';
  });
  document.getElementById('sessions').innerHTML=html;
}

function renderEvents(data){
  var events=(data.events||[]).filter(function(e){return e.ip!==MY_IP;}).slice(-50).reverse();
  var html='';
  if(!events.length){html='<tr><td colspan="4" class="empty">Keine Events</td></tr>';}
  events.forEach(function(e){
    var time=new Date(e.ts).toLocaleString('de-DE',{timeZone:'Europe/Berlin'});
    var tag=e.e==='session_end'?'tag-green':e.e==='auth'?'tag-gold':'tag';
    var details='';
    if(e.e==='session_end'&&e.d){
      var dur=Math.round((e.d.duration_ms||0)/60000);
      details=dur+'min, '+e.d.total_events+' events';
      if(e.d.tabs){details+=', Tabs: '+Object.keys(e.d.tabs).join(', ');}
    }else if(e.e==='visibility'&&e.d){
      details=e.d.state;
    }else if(e.d){
      details=JSON.stringify(e.d).substring(0,80);
    }
    html+='<tr><td style="font-family:var(--m);font-size:11px;white-space:nowrap">'+time+'</td><td style="font-family:var(--m);font-size:11px">'+e.ip+'</td><td><span class="tag '+tag+'">'+e.e+'</span></td><td style="font-size:12px;color:var(--muted)">'+details+'</td></tr>';
  });
  document.getElementById('events').innerHTML=html;
}

function renderSubs(raw){
  var html='';
  if(!raw||!raw.trim()){html='<tr><td colspan="3" class="empty">Keine Subscribers</td></tr>';}
  else{
    var lines=raw.trim().split('\n').reverse();
    lines.forEach(function(line){
      try{
        var s=JSON.parse(line);
        html+='<tr><td style="font-family:var(--m);font-size:12px">'+s.email+'</td><td><span class="tag">'+s.source+'</span></td><td style="font-size:12px;color:var(--muted)">'+new Date(s.ts).toLocaleString('de-DE',{timeZone:'Europe/Berlin'})+'</td></tr>';
      }catch(e){}
    });
  }
  document.getElementById('subs').innerHTML=html;
}

// Auto-refresh every 30s
setInterval(function(){if(document.getElementById('app').style.display!=='none')loadData();},30000);
</script>
</body>
</html>