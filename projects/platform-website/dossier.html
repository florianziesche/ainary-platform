<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kampagnen-Intelligence</title>
<meta name="robots" content="noindex, nofollow">
<meta property="og:title" content="Kampagnen-Intelligence">
<meta property="og:description" content="Datenbasierte Wahlkampf-Analyse. Dossiers, Stimmung, Szenarien.">
<meta property="og:type" content="website">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>◆</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
:root{
--bg:#fafafa;--surface:#fff;--surface2:#f5f5f3;
--border:#d0d0d0;--border-hover:#bbb;--border2:#e8e8e8;
--text:#1a1a1a;--text2:#444;--muted:#777;--light:#bbb;
--gold:#9d7f3b;--gold-hover:#b8972e;
--red:#c0392b;--amber:#b45309;--green:#2d8a4e;--blue:#2563eb;--purple:#7c3aed;
--red-bg:rgba(192,57,43,0.08);--amber-bg:rgba(180,83,9,0.08);--green-bg:rgba(45,138,78,0.08);--blue-bg:rgba(37,99,235,0.08);--purple-bg:rgba(124,58,237,0.08);--gold-bg:rgba(157,127,59,0.08);
--accent:var(--gold);--yellow:var(--amber);--orange:var(--amber);--cyan:var(--blue);
--f:'Inter',-apple-system,sans-serif;--m:'JetBrains Mono',monospace
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--f);color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased;height:100vh;overflow:hidden;display:flex;flex-direction:column}
::selection{background:var(--accent);color:var(--bg)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.topbar{height:36px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0}
.topbar-left{display:flex;align-items:center;gap:10px}
.topbar-logo{font-family:var(--m);font-size:8pt;font-weight:700;letter-spacing:.15em;color:var(--accent)}
.topbar-sep{color:var(--border2)}
.topbar-env{font-family:var(--m);font-size:6pt;color:var(--muted);letter-spacing:.1em}
.topbar-right{display:flex;align-items:center;gap:14px;font-family:var(--m);font-size:6.5pt;color:var(--muted)}
.topbar-live{display:flex;align-items:center;gap:4px;color:var(--green)}
.live-pulse{width:5px;height:5px;border-radius:50%;background:var(--green);animation:pulse 2s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.topbar-class{color:var(--red);font-weight:600;letter-spacing:.1em}
.topbar-chat{background:var(--accent);color:#fff;border:none;padding:4px 10px;border-radius:3px;font-family:var(--m);font-size:6.5pt;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px}
.topbar-chat:hover{background:#b8972e}
.search-wrap{position:relative;flex:1;max-width:360px;margin:0 16px}
.search-input{width:100%;font:400 8pt var(--m);padding:5px 10px 5px 24px;border:1px solid var(--border);border-radius:4px;background:var(--surface2);color:var(--text);outline:none}
.search-input:focus{border-color:var(--accent);background:var(--surface)}
.search-input::placeholder{color:var(--muted)}
.search-icon{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:8pt;color:var(--muted);pointer-events:none}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:0 0 6px 6px;max-height:340px;overflow-y:auto;z-index:300;display:none;box-shadow:0 8px 24px rgba(0,0,0,0.12)}
.search-results.open{display:block}
.sr-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(0,0,0,0.03)}
.sr-item:hover{background:var(--surface2)}
.sr-item-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sr-item-title{font-size:8pt;font-weight:500;color:var(--text)}
.sr-item-sub{font:400 6.5pt var(--m);color:var(--muted)}
.main{flex:1;display:grid;grid-template-columns:220px 1fr 300px;grid-template-rows:1fr;overflow:hidden}
.panel{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto}
.panel-header{font-family:var(--m);font-size:6pt;font-weight:600;text-transform:uppercase;letter-spacing:.15em;color:var(--muted);padding:12px 14px 8px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:2}
.ont-group{border-bottom:1px solid var(--border)}
.ont-group-title{font-family:var(--m);font-size:5.5pt;font-weight:600;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);padding:8px 14px 4px;display:flex;align-items:center;gap:6px}
.ont-count{font-family:var(--m);font-size:5pt;color:var(--border2);background:var(--surface2);padding:1px 5px;border-radius:2px}
.ont-item{display:flex;align-items:center;gap:8px;padding:5px 14px;cursor:pointer;transition:background .08s;font-size:7.5pt;color:var(--text2)}
.ont-item:hover{background:var(--surface2)}
.ont-item.active{background:rgba(196,162,77,0.06);color:var(--accent)}
.ont-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.ont-label{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ont-badge{font-family:var(--m);font-size:5pt;padding:1px 4px;border-radius:2px;flex-shrink:0}
.canvas-wrap{display:flex;flex-direction:column;overflow:hidden}
.tab-bar{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto}
.tab{font-family:var(--m);font-size:6.5pt;font-weight:500;padding:10px 14px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .12s;text-transform:uppercase;letter-spacing:.08em;white-space:nowrap;flex-shrink:0}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.canvas{flex:1;overflow-y:auto;padding:20px 24px}
.canvas-title{font-family:var(--m);font-size:7pt;font-weight:600;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.canvas-title .ct-badge{font-size:5pt;padding:2px 6px;border-radius:2px;color:var(--bg);font-weight:700}
.entity-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-bottom:16px;overflow:hidden}
.entity-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.entity-name{font-size:11pt;font-weight:600}
.entity-meta{font-family:var(--m);font-size:6pt;color:var(--muted);display:flex;gap:10px}
.entity-body{padding:14px 16px}
.prop-grid{display:grid;grid-template-columns:120px 1fr;gap:0;font-size:7.5pt}
.prop-key{font-family:var(--m);font-size:6pt;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;padding:4px 0;border-bottom:1px solid var(--border)}
.prop-val{padding:4px 0;border-bottom:1px solid var(--border);color:var(--text2)}
.prop-val strong{color:var(--text)}
.conn-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:7pt}
.conn-row:last-child{border-bottom:none}
.conn-type{font-family:var(--m);font-size:5pt;padding:2px 6px;border-radius:2px;width:52px;text-align:center;flex-shrink:0;font-weight:600}
.conn-target{flex:1;color:var(--text2)}
.vtl{position:relative;padding-left:24px}
.vtl::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--border)}
.vtl-item{position:relative;padding:8px 12px;margin-bottom:2px;cursor:pointer;border-radius:4px;transition:background .15s}
.vtl-item:hover{background:var(--surface2)}
.vtl-dot{position:absolute;left:-20px;top:12px;width:10px;height:10px;border-radius:50%;border:2px solid var(--surface)}
.vtl-year{font:600 7pt var(--m);color:var(--text2);margin-bottom:2px}
.vtl-label{font:400 8pt var(--f);color:var(--text);line-height:1.4}
#graph-view{display:none;width:100%;height:100%;position:relative}
#graph-view svg{width:100%;height:100%}
#graph-view .tooltip{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:10px 14px;font-size:7pt;max-width:280px;pointer-events:none;opacity:0;transition:opacity 0.15s;z-index:10}
#graph-view .tooltip h4{font-size:8pt;margin-bottom:3px}
.link{stroke-opacity:0.5;fill:none}
.link-label{font-family:var(--m);font-size:4.5pt;fill:var(--muted);pointer-events:none}
.node-circle{cursor:pointer;transition:r 0.15s}
.node-circle:hover{filter:brightness(1.2)}
.node-label{font-family:var(--f);font-weight:600;pointer-events:none;text-anchor:middle}
.node-sublabel{font-family:var(--m);pointer-events:none;text-anchor:middle;fill:var(--muted)}
#matrix-view{display:none;overflow:auto;padding:20px 24px}
.matrix-table{width:100%;border-collapse:collapse;font-size:7pt}
.matrix-table th,.matrix-table td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
.matrix-table th{font-family:var(--m);font-size:5.5pt;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;background:var(--surface);position:sticky;top:0;z-index:2}
.matrix-table td{color:var(--text2)}
.matrix-col-head{text-align:center!important;min-width:140px}
.matrix-col-head .name{font-family:var(--f);font-size:8pt;font-weight:600;text-transform:none;letter-spacing:0}
.matrix-col-head .role{font-family:var(--m);font-size:5pt;color:var(--border2);text-transform:none;margin-top:2px}
.cell-score{font-family:var(--m);font-size:12pt;font-weight:700}
.cell-bar{height:5px;border-radius:2px;margin-top:3px}
.cell-badge{display:inline-block;font-family:var(--m);font-size:4.5pt;padding:1px 5px;border-radius:2px;font-weight:600}
.badge-red{background:rgba(192,57,43,0.15);color:var(--red)}
.badge-green{background:rgba(45,138,78,0.15);color:var(--green)}
.badge-yellow{background:rgba(180,83,9,0.15);color:var(--amber)}
/* E/I/J/A Evidence Tags — USP */
.ev{display:inline-block;font-family:var(--m);font-size:5.5pt;font-weight:600;width:13px;height:13px;line-height:13px;text-align:center;border-radius:2px;margin-right:2px;vertical-align:middle}
.ev-e{background:var(--green);color:#fff}
.ev-i{background:var(--blue);color:#fff}
.ev-j{background:var(--gold);color:#fff}
.ev-a{background:var(--red);color:#fff}
.ev-legend{display:flex;gap:10px;flex-wrap:wrap;font:400 6pt var(--m);color:var(--muted);padding:6px 0;border-bottom:1px solid var(--border2);margin-bottom:12px}
.ev-legend span{display:flex;align-items:center;gap:3px}
.hypo-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:10px}
.hypo-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.hypo-card-title{font:600 9pt var(--f);color:var(--text)}
.hypo-card-status{font:500 6pt var(--m);padding:3px 6px;border-radius:3px}
.hypo-body{font:400 8pt var(--f);color:var(--text2);line-height:1.5;margin-bottom:10px}
.hypo-ev-row{display:flex;align-items:flex-start;gap:8px;padding:4px 0;font-size:7.5pt;color:var(--text2)}
.hypo-ev-icon{font:500 7pt var(--m);flex-shrink:0;width:16px;text-align:center}
.hypo-ev-for{color:var(--green)}
.hypo-ev-against{color:var(--red)}
.hypo-conf-bar{height:6px;background:var(--surface2);border-radius:3px;margin:8px 0;overflow:hidden}
.hypo-conf-fill{height:100%;border-radius:3px;transition:width .5s}
.hypo-conf-label{display:flex;justify-content:space-between;font:400 6pt var(--m);color:var(--muted)}
.nf-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px;margin-bottom:8px;transition:border-color .15s}
.nf-card:hover{border-color:var(--accent)}
.nf-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.nf-card-title{font:600 9pt var(--f);color:var(--text);line-height:1.4;flex:1}
.nf-card-source{font:400 6pt var(--m);color:var(--muted);flex-shrink:0;margin-left:8px}
.nf-card-body{font:400 7.5pt var(--f);color:var(--text2);line-height:1.5;margin-bottom:8px}
.nf-card-footer{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.nf-entity-tag{font:500 5.5pt var(--m);padding:2px 6px;border-radius:3px;cursor:pointer}
.nf-sentiment{font:500 5.5pt var(--m);padding:2px 6px;border-radius:3px}
.nf-filter-bar{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.nf-filter{font:500 6.5pt var(--m);padding:5px 10px;border:1px solid var(--border);border-radius:4px;cursor:pointer;background:var(--surface);color:var(--muted)}
.nf-filter.active{border-color:var(--accent);color:var(--accent);background:rgba(157,127,59,0.04)}
.sent-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.sent-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px;cursor:pointer;transition:border-color .15s}
.sent-card:hover{border-color:var(--accent)}
.sent-card-title{font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:8px}
.sent-value{font:700 16pt var(--m);color:var(--text)}
.sent-delta{font:500 7pt var(--m);margin-left:6px}
.sent-bar-wrap{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:6px 0}
.sent-bar{height:100%;border-radius:4px;transition:width .8s ease}
.sent-topic{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.03)}
.sent-topic-name{font:500 8pt var(--f);color:var(--text);flex:1}
.sent-topic-bar{width:120px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;flex-shrink:0}
.sent-topic-fill{height:100%;border-radius:3px}
.sent-topic-pct{font:500 7pt var(--m);width:36px;text-align:right;flex-shrink:0}
.act-card{background:var(--surface);border-left:3px solid var(--accent);border-radius:0 6px 6px 0;padding:14px 16px;margin-bottom:10px;border-top:1px solid var(--border);border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.act-card-priority{font:600 5.5pt var(--m);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
.act-card-title{font:600 10pt var(--f);color:var(--text);margin-bottom:6px}
.act-card-body{font:400 8pt var(--f);color:var(--text2);line-height:1.5;margin-bottom:10px}
.act-card-metrics{display:flex;gap:12px;flex-wrap:wrap}
.act-metric{text-align:center}
.act-metric-val{font:700 12pt var(--m);color:var(--text)}
.act-metric-label{font:400 5.5pt var(--m);color:var(--muted);text-transform:uppercase}
.insight-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;margin-bottom:12px}
.insight-card:hover{border-color:var(--accent)}
.insight-card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.insight-card-title{font-size:9pt;font-weight:600}
.insight-conf{font-family:var(--m);font-size:6pt;padding:3px 8px;border-radius:10px;font-weight:600}
.insight-body{font-size:7.5pt;color:var(--text2);line-height:1.6;margin-bottom:8px}
.alerts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.alert-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px}
.alert-card-title{font-family:var(--m);font-size:6pt;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px}
.risk-row{display:flex;gap:8px;margin-bottom:8px;align-items:center;cursor:pointer;padding:4px;border-radius:4px;transition:background .15s}
.risk-row:hover{background:var(--surface2)}
.risk-name{font-size:7.5pt;font-weight:500;width:100px;flex-shrink:0}
.risk-bar-bg{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.risk-bar{height:100%;border-radius:3px;transition:width .8s ease}
.risk-val{font-family:var(--m);font-size:7pt;width:30px;text-align:right;flex-shrink:0;font-weight:600}
.briefing-hero{background:linear-gradient(135deg,var(--surface) 0%,rgba(196,162,77,0.06) 100%);border:1px solid var(--accent);border-radius:4px;padding:20px 24px;margin-bottom:20px}
.briefing-greeting{font-size:14pt;font-weight:300;color:var(--text);margin-bottom:4px}
.briefing-greeting strong{color:var(--accent);font-weight:600}
.briefing-subtitle{font-family:var(--m);font-size:7pt;color:var(--muted)}
.briefing-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.briefing-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;cursor:pointer;transition:all .15s}
.briefing-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.briefing-card-title{font-size:9pt;font-weight:600;margin-bottom:4px}
.briefing-card-body{font-size:7pt;color:var(--text2);line-height:1.5}
.briefing-card-tag{font-family:var(--m);font-size:5pt;display:inline-block;padding:2px 6px;border-radius:2px;margin-top:8px;font-weight:600}
.pattern{background:var(--surface2);border:1px solid var(--border);border-radius:4px;margin:10px 14px;padding:12px}
.pattern-title{font-family:var(--m);font-size:5.5pt;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--text2);margin-bottom:6px}
.pattern-body{font-size:7pt;color:var(--text2);line-height:1.5}
.pattern-conf{font-family:var(--m);font-size:5pt;color:var(--muted);margin-top:6px}
.pattern-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.pattern-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:14px}
.pattern-card-title{font-size:8pt;font-weight:600;margin-bottom:5px}
.pattern-card-body{font-size:6.5pt;color:var(--text2);line-height:1.5}
.pattern-card-conf{font-family:var(--m);font-size:5pt;color:var(--muted);margin-top:6px}
.feed-item{padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .08s}
.feed-item:hover{background:var(--surface2)}
.feed-source{font-family:var(--m);font-size:5pt;color:var(--muted);margin-bottom:3px}
.feed-title{font-size:7.5pt;font-weight:500;margin-bottom:2px;color:var(--text)}
.feed-body{font-size:6.5pt;color:var(--text2);line-height:1.5}
.feed-alert .feed-title{color:var(--red)}
.chat-overlay{position:fixed;top:0;right:0;bottom:0;width:380px;background:var(--surface);border-left:1px solid var(--border);z-index:100;transform:translateX(100%);transition:transform .25s ease;display:flex;flex-direction:column}
.chat-overlay.open{transform:translateX(0)}
.chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.chat-header-title{font-family:var(--m);font-size:7pt;font-weight:600;color:var(--accent);display:flex;align-items:center;gap:6px}
.chat-close{background:none;border:none;color:var(--muted);font-size:14pt;cursor:pointer}
.chat-close:hover{color:var(--text)}
.chat-messages{flex:1;overflow-y:auto;padding:14px}
.chat-msg{margin-bottom:14px}
.chat-msg-header{display:flex;align-items:center;gap:5px;margin-bottom:3px}
.chat-avatar{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--m);font-size:5.5pt;font-weight:600;color:var(--bg)}
.chat-avatar.mia{background:var(--accent)}
.chat-avatar.user{background:var(--border2)}
.chat-name{font-family:var(--m);font-size:6pt;color:var(--muted)}
.chat-body{font-size:7.5pt;color:var(--text2);line-height:1.55;padding-left:23px}
.chat-body strong{color:var(--text)}
.chat-chips{display:flex;flex-wrap:wrap;gap:5px;padding:0 14px 10px;flex-shrink:0}
.chat-chip{font-family:var(--m);font-size:5.5pt;color:var(--muted);padding:4px 8px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
.chat-chip:hover{color:var(--accent);border-color:var(--accent)}
.chat-input-area{display:flex;gap:6px;padding:10px 14px;border-top:1px solid var(--border);flex-shrink:0}
.chat-input{flex:1;font:400 7.5pt var(--f);background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:8px 10px;color:var(--text);outline:none}
.chat-input:focus{border-color:var(--accent)}
.chat-send{background:var(--accent);color:var(--bg);border:none;border-radius:4px;padding:8px 14px;font:600 6pt var(--m);cursor:pointer}
.statusbar{height:24px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;font-family:var(--m);font-size:5.5pt;color:var(--muted);flex-shrink:0}
.clickable{cursor:pointer;transition:all .15s}
.clickable:hover{border-color:var(--gold) !important}
.entity-link{color:var(--accent);cursor:pointer;text-decoration:none;border-bottom:1px dotted var(--accent)}
.entity-link:hover{color:#b8972e;border-bottom-style:solid}
.detail-overlay{display:none;position:fixed;inset:0;background:rgba(8,8,12,0.85);backdrop-filter:blur(8px);z-index:500;justify-content:center;align-items:center}
.detail-overlay.open{display:flex}
.detail-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;padding:24px}
.detail-close{position:absolute;top:16px;right:16px;font:400 8pt var(--m);color:var(--muted);cursor:pointer;padding:4px 8px;border:1px solid var(--border);border-radius:4px}
.detail-close:hover{color:var(--text)}
.detail-title{font:700 10pt var(--m);margin-bottom:8px}
.detail-body{font-size:7.5pt;color:var(--text2);line-height:1.6;margin-bottom:12px}
.detail-source{font:400 5.5pt var(--m);color:var(--muted);padding-top:8px;border-top:1px solid var(--border)}
@media(max-width:1000px){
.main{grid-template-columns:1fr;padding-bottom:28px}
.panel,.panel-r{display:none}
.topbar{padding:0 12px}
.topbar-tabs{gap:4px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.topbar-tabs button{font-size:6pt;padding:4px 8px;white-space:nowrap}
.content{padding:14px}
.kpi-row{grid-template-columns:repeat(2,1fr)}
}
/* Timeline Slider */
.tl-wrap{margin:12px 0;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px 16px}
.tl-title{font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px}
.tl-track{position:relative;height:40px;margin:0 4px}
.tl-line{position:absolute;top:18px;left:0;right:0;height:2px;background:var(--border)}
.tl-events{position:absolute;inset:0;display:flex;align-items:center}
.tl-ev{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:transform .15s}
.tl-ev:hover{transform:scale(1.2)}
.tl-dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--surface);z-index:1}
.tl-year{font:500 5.5pt var(--m);color:var(--text2);position:absolute;top:-12px}
.tl-label{font:400 5pt var(--m);color:var(--muted);white-space:nowrap;margin-top:2px;max-width:60px;overflow:hidden;text-overflow:ellipsis}
.tl-range{display:flex;justify-content:space-between;font:400 6pt var(--m);color:var(--muted);margin-top:4px}
.tl-detail{margin-top:8px;padding:8px 10px;background:var(--surface2);border-radius:4px;font:400 7.5pt var(--f);color:var(--text2);line-height:1.5;display:none}
.tl-detail.open{display:block}
/* Related Pills */
.related-wrap{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.related-pill{font:400 6pt var(--m);padding:3px 8px;border-radius:12px;cursor:pointer;border:1px solid var(--border);color:var(--text2);transition:all .15s;text-decoration:none}
.related-pill:hover{border-color:var(--accent);color:var(--accent);background:rgba(157,127,59,0.04)}
/* Action Card enhanced */
.act-card-evidence{font:400 6.5pt var(--f);color:var(--text2);line-height:1.5;margin:8px 0;padding:8px;background:var(--surface2);border-radius:3px}
.act-card-actions{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}
.act-btn{font:500 6pt var(--m);padding:4px 10px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2);transition:all .15s}
.act-btn:hover{border-color:var(--accent);color:var(--accent)}
.act-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
/* Insight enhanced */
.insight-evidence{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.insight-invalidate{font:400 6pt var(--f);color:var(--muted);padding:6px 8px;background:rgba(192,57,43,0.04);border-radius:3px;margin-top:6px;border-left:2px solid var(--red)}
.insight-so-what{font:500 6.5pt var(--f);color:var(--accent);padding:6px 8px;background:rgba(157,127,59,0.04);border-radius:3px;margin-top:4px;border-left:2px solid var(--accent)}
/* News Feed proper */
.nf-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px;margin-bottom:8px;transition:border-color .15s}
.nf-card:hover{border-color:var(--accent)}
.nf-meta{display:flex;gap:8px;align-items:center;margin-top:6px;font:400 5.5pt var(--m);color:var(--muted)}
.nf-sentiment{font-weight:600;padding:1px 5px;border-radius:2px}
.nf-impact{font-weight:500}
/* Datenbasis box */
.data-basis{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:12px;margin-top:16px}
.data-basis-title{font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.data-basis-body{font:400 7pt var(--f);color:var(--text2);line-height:1.5}
</style>
</head>
<body>

<!-- AUTH GATE -->
<div id="auth-gate" style="position:fixed;inset:0;background:var(--bg);z-index:10000;display:flex;align-items:center;justify-content:center">
<div style="text-align:center;max-width:340px">
<a href="https://ainaryventures.com" target="_blank" style="font:400 6pt var(--m);letter-spacing:.12em;color:var(--muted);text-decoration:none;margin-bottom:4px">AINARY</a>
<div style="font:400 7pt var(--f);color:var(--muted);margin-bottom:24px">Ihre Kampagnen-Analyse</div>
<input id="auth-input" type="password" placeholder="Passwort eingeben" onkeydown="if(event.key==='Enter')checkAuth()" style="width:100%;font:400 8pt var(--f);padding:10px 14px;border:1px solid var(--border);border-radius:4px;background:var(--surface);color:var(--text);text-align:center;outline:none;letter-spacing:.1em">
<div id="auth-error" style="font:400 6pt var(--f);color:var(--red);margin-top:6px;opacity:0">Falsches Passwort</div>
<button onclick="checkAuth()" style="margin-top:12px;font:600 7pt var(--m);padding:8px 24px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer;letter-spacing:.06em">ZUGANG</button>
<div style="font:400 5pt var(--f);color:var(--muted);margin-top:20px">Alle Daten aus öffentlich zugänglichen Quellen</div>
</div>
</div>
<script>
function checkAuth(){
var pw=document.getElementById('auth-input').value.toLowerCase().trim();
var hash=0;for(var i=0;i<pw.length;i++){hash=((hash<<5)-hash)+pw.charCodeAt(i);hash|=0;}
if(hash===467107016||hash===-684972188){
document.getElementById('auth-gate').style.display='none';
try{sessionStorage.setItem('ai-auth','1')}catch(e){}
}else{
document.getElementById('auth-error').style.opacity='1';
document.getElementById('auth-input').style.borderColor='var(--red)';
setTimeout(function(){document.getElementById('auth-error').style.opacity='0';document.getElementById('auth-input').style.borderColor='var(--border)'},2000);
}
}
// Token-based auth: ?u=TOKEN skips login, identifies user
// Admin mode: ?admin skips login, shows analytics tab
(function(){
  var p = new URLSearchParams(location.search);
  var token = p.get('u');
  var isAdmin = p.has('admin');
  
  // Token → user mapping (Palantir-style: link = identity)
  var TOKEN_MAP = {
    'bamberg': { name: 'Bamberg-Analyse', role: 'demo' },
    'demo': { name: 'Demo-User', role: 'demo' }
  };
  
  if (token && TOKEN_MAP[token]) {
    document.getElementById('auth-gate').style.display = 'none';
    try { sessionStorage.setItem('ai-auth', '1'); sessionStorage.setItem('ai-token', token); } catch(e) {}
  } else if (isAdmin) {
    document.getElementById('auth-gate').style.display = 'none';
    try { sessionStorage.setItem('ai-auth', '1'); sessionStorage.setItem('ai-token', 'admin'); } catch(e) {}
  } else {
    // Auto-login if already authenticated this session
    try { if (sessionStorage.getItem('ai-auth') === '1') document.getElementById('auth-gate').style.display = 'none'; } catch(e) {}
  }
})();
// Auto-focus
setTimeout(function(){document.getElementById('auth-input').focus()},100);
</script>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <a href="https://ainaryventures.com" target="_blank" class="topbar-logo" style="text-decoration:none;color:inherit">AINARY</a>
    <span class="topbar-sep">|</span>
    <span class="topbar-env" id="topbar-tenant"></span>
  </div>
  <div class="search-wrap">
    <span class="search-icon">&#9906;</span>
    <input class="search-input" id="search-input" placeholder="Suche: Person, Thema, Kontroverse..." autocomplete="off">
    <div class="search-results" id="search-results"></div>
  </div>
  <div class="topbar-right">
    <span class="topbar-live"><span class="live-pulse"></span> LIVE</span>
    <button class="topbar-chat" onclick="toggleChat()">Support</button>
  </div>
</div>

<!-- MAIN 3-COLUMN LAYOUT -->
<div style="padding:4px 16px;font:400 7pt var(--m);color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0"><a href="radar.html" style="color:var(--accent);text-decoration:none">← Radar</a> <span style="margin:0 4px;color:var(--border)">›</span> <a href="digi-dashboard.html" style="color:var(--text2);text-decoration:none">Briefing</a> <span style="margin:0 4px;color:var(--border)">›</span> <span id="bc-city">Dossier</span></div>
<div class="main">

  <!-- LEFT SIDEBAR: Ontology (generated from KB) -->
  <div class="panel" id="ontology-panel">
    <div class="panel-header">Ontology Explorer</div>
    <div id="ontology-content"></div>
  </div>

  <!-- CENTER: Tab Bar + Canvas -->
  <div class="canvas-wrap">
    <div class="tab-bar" id="tab-bar">
      <div class="tab active" data-view="briefing" onclick="switchView('briefing')">Briefing</div>
      <div class="tab" data-view="entity" onclick="switchView('entity')">Dossier</div>
      <div class="tab" data-view="graph" onclick="switchView('graph')">Netzwerk</div>
      <div class="tab" data-view="compare" onclick="switchView('compare')">Vergleich</div>
      <div class="tab" data-view="strategy" onclick="switchView('strategy')">Strategie</div>
      <div class="tab" data-view="analytics" onclick="switchView('analytics')" id="analytics-tab" style="display:none">Analytics</div>
    </div>

    <div id="briefing-view" class="canvas"></div>
    <div id="entity-view" class="canvas" style="display:none"></div>
    <div id="graph-view"><div class="tooltip" id="graph-tooltip"></div></div>
    <div id="analytics-view" class="canvas" style="display:none"></div>
    <div id="compare-view" class="canvas" style="display:none"></div>
    <div id="strategy-view" class="canvas" style="display:none"></div>
  </div>

  <!-- RIGHT SIDEBAR: Intel Feed + Patterns -->
  <div class="panel panel-r" id="right-panel">
    <div class="panel-header">Intel Feed <span style="float:right;color:var(--green)">&#9679; LIVE</span></div>
    <div id="intel-feed"></div>
    <div class="panel-header" style="margin-top:0">Detected Patterns</div>
    <div id="detected-patterns"></div>
  </div>
</div>

<!-- CHAT OVERLAY -->
<div class="chat-overlay" id="chat-overlay">
  <div class="chat-header">
    <div class="chat-header-title"><span style="width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block"></span> Support</div>
    <button class="chat-close" onclick="toggleChat()">&times;</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-chips" id="chat-chips"></div>
  <div class="chat-input-area">
    <input class="chat-input" id="chat-input" placeholder="Ihre Nachricht..." onkeydown="if(event.key==='Enter')sendChat()">
    <button class="chat-send" onclick="sendChat()">ABSENDEN</button>
  </div>
</div>

<!-- DETAIL OVERLAY -->
<div class="detail-overlay" id="detail-overlay" onclick="if(event.target===this)closeDetail()">
  <div class="detail-card" id="detail-card"></div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div id="status-left"></div>
  <div id="status-right"></div>
</div>

<script>
// =====================================================
// DATA LAYER — All data as JSON constants
// Generator replaces __PLACEHOLDER__ with JSON.stringify(data)
// =====================================================
// Dynamic data loading — reads city from URL param
const urlParams = new URLSearchParams(window.location.search);
const CITY_ID = urlParams.get('city') || 'bamberg';
let TENANT = {}, KB = {}, GRAPH = {nodes:[],links:[]};
let NEWS = [], HYPOTHESES = [], SENTIMENT = {}, PATTERNS = [], ACTIONS = [], FORECAST = {}, THEMEN = {}, SOCIAL = {}, STICHWAHL = {};

(async function loadCityData() {
  try {
    const resp = await fetch('data/cities/' + CITY_ID + '.json?t=' + Date.now());
    if (!resp.ok) throw new Error('City not found: ' + CITY_ID);
    const data = await resp.json();
    TENANT = data.tenant || {};
    KB = data.kb || {};
    GRAPH = data.graph || {nodes:[],links:[]};
    // Update page title
    document.title = 'Dossier: ' + (TENANT.gemeinde || CITY_ID);
    // Update breadcrumb
    var bc = document.getElementById('bc-city');
    if (bc) bc.textContent = TENANT.gemeinde || CITY_ID;
    // Load additional data
    NEWS = data.news || [];
    HYPOTHESES = data.hypotheses || [];
    SENTIMENT = data.sentiment || {};
    PATTERNS = data.patterns || [];
    ACTIONS = data.actions || [];
    FORECAST = data.forecast || {};
    THEMEN = data.themen || {};
    SOCIAL = data.social || {};
    STICHWAHL = data.stichwahl_prediction || {};
    // Init the app
    if (typeof initApp === 'function') initApp();
  } catch(e) {
    console.error('Failed to load city data:', e);
    document.body.innerHTML = '<div style="padding:40px;text-align:center;font-family:var(--f)"><h2>Stadt nicht gefunden</h2><p>' + CITY_ID + '</p><a href="radar.html">← Zurück zum Radar</a></div>';
  }
})();

const TALKINGPOINTS = [{"topic":"Masken-Affäre als Vertrauensfrage","target":"","weakness":"Melanie Humls Rolle im Emix-Maskendeal — dokumentiert durch Spiegel, BR und SZ — wirft Fragen auf: Kann eine Politikerin","points":[{"text":"Melanie Humls Rolle im Emix-Maskendeal — dokumentiert durch Spiegel, BR und SZ — wirft Fragen auf: Kann eine Politikerin, die als Ministerin fragwürdige Maskendeals weiterleitete und sich bei Spahn für ägyptische Masken ohne EU-Zertifizierung einsetzte, das Vertrauen der Bamberger Bürger gewinnen?","ev":"E","src":"Spiegel 13.12.2022, inFranken 11.02.2025"}],"context":"Quelle: Spiegel 13.12.2022, inFranken 11.02.2025. Evidence: E."},{"topic":"Glüsenkamps Aufräumer-Narrativ","target":"","weakness":"Nach Starkes Boni-Affäre wurde Glüsenkamp mit dem Personalreferat betraut und hat die Aufarbeitung geleitet. Das ist sei","points":[{"text":"Nach Starkes Boni-Affäre wurde Glüsenkamp mit dem Personalreferat betraut und hat die Aufarbeitung geleitet. Das ist sein stärkstes Argument: 'Ich habe aufgeräumt, jetzt lasst mich führen.' 2020 holte er bereits 40,7% in der Stichwahl.","ev":"E","src":"FT 27.08.2024, stadt.bamberg.de"}],"context":"Quelle: FT 27.08.2024, stadt.bamberg.de. Evidence: E."},{"topic":"Smart City Bamberg: €15,75M für den nächsten OB","target":"","weakness":"Der nächste Oberbürgermeister verwaltet €15,75 Millionen Smart City Bundesförderung. Bamberg hat eine eigene Smart City ","points":[{"text":"Der nächste Oberbürgermeister verwaltet €15,75 Millionen Smart City Bundesförderung. Bamberg hat eine eigene Smart City Abteilung und die Uni forscht an KI. Welcher Kandidat kann Digitalisierung?","ev":"E","src":"welterbe.bamberg.de, smart-city-dialog.de"}],"context":"Quelle: welterbe.bamberg.de, smart-city-dialog.de. Evidence: E."},{"topic":"Progressives Splitting als CSU-Chance","target":"","weakness":"SPD (Niedermaier) und Grüne (Glüsenkamp) fischen im selben Elektorat. 2020 holten SPD+Grüne zusammen über 60% in der Sti","points":[{"text":"SPD (Niedermaier) und Grüne (Glüsenkamp) fischen im selben Elektorat. 2020 holten SPD+Grüne zusammen über 60% in der Stichwahl. Wenn sich beide kannibalisieren, zieht Huml als lachende Dritte in die Stichwahl.","ev":"J","src":"Analyse basierend auf Wahlergebnis 2020"}],"context":"Quelle: Analyse basierend auf Wahlergebnis 2020. Evidence: J."},{"topic":"Bamberger Gärtnertradition","target":"","weakness":"Niedermaier ist Biogärtner in 11. Generation — Teil des UNESCO-geschützten Bamberger Gärtnererbes. Ein Narrativ, das kei","points":[{"text":"Niedermaier ist Biogärtner in 11. Generation — Teil des UNESCO-geschützten Bamberger Gärtnererbes. Ein Narrativ, das kein Gegner kopieren kann: Bamberger durch und durch, verwurzelt, bodenständig.","ev":"E","src":"niedermaier2026.de"}],"context":"Quelle: niedermaier2026.de. Evidence: E."}];
const SCENARIOS = [{"name":"Stichwahl Huml vs. Glüsenkamp (55%)","desc":"CSU-Basis trägt Huml auf Platz 1, Glüsenkamp holt progressives Elektorat. In der Stichwahl wird Masken-Affäre zum Kernthema. Glüsenkamp gewinnt mit ~55% (Aufräumer + SPD-Leihstimmen).","label":"possible","results":{}},{"name":"Glüsenkamp vs. Niedermaier (25%)","desc":"Masken-Affäre eskaliert, Huml fällt auf Platz 3. Grüne vs. SPD — reines progressives Duell. Glüsenkamp gewinnt knapp (Amtsbonus).","label":"possible","results":{}},{"name":"Huml gewinnt (15%)","desc":"CSU mobilisiert stark, Masken-Affäre wird als 'alter Hut' abgetan. Huml profitiert vom Splitting und gewinnt Stichwahl gegen geschwächten Gegner.","label":"possible","results":{}},{"name":"Überraschung Niedermaier (5%)","desc":"SPD-Stammwähler in Bamberg stark (20 Jahre OB). Niedermaier schafft Erneuerungsprofil, gewinnt Stichwahl gegen Huml.","label":"possible","results":{}}];
const WEEKLYBRIEF = {"title":"Lage-Briefing Bamberg — KW 9/2026","date":"24.02.2026","daysToElection":12,"summary":"13 Tage vor der Wahl: Dreikampf Huml/Glüsenkamp/Niedermaier. Stichwahl praktisch sicher. Masken-Affäre als Damoklesschwert über Huml.","priorities":[{"nr":1,"action":"Masken-Affäre Eskalation beobachten — Spiegel/BR könnten vor der Wahl nachlegen","why":"WATCH","deadline":"08.03","ev":"J"},{"nr":2,"action":"Progressives Splitting quantifizieren — SPD vs. Grüne Wählerüberlappung","why":"ANALYSE","deadline":"01.03","ev":"J"},{"nr":3,"action":"CSU-Konsolidierung prüfen — kann Huml die 21,8% von 2020 (Lange) deutlich übertreffen?","why":"OFFEN","deadline":"08.03","ev":"J"},{"nr":4,"action":"Smart City Beauftragten identifizieren — Kontaktaufnahme für Post-Wahl","why":"GEPLANT","deadline":"25.02","ev":"J"},{"nr":5,"action":"Wahlbeteiligung 2020 (55,6%) als Baseline — höhere Beteiligung hilft Grünen","why":"ANALYSE","deadline":"08.03","ev":"J"}],"keychanges":["SZ-Bericht (21.02): Alle drei Favoriten sehen sich bei >50% in der Stichwahl — mathematisch unmöglich","BR24 (23.02): Rekord-Kandidatenzahl in ganz Oberfranken, Bamberg = Fokus-Story","Masken-Affäre: Neue Dokumente im Untersuchungsausschuss (Feb 2025) — könnte jederzeit hochkochen","Podiumsdiskussion (19.01): Top 3 gesondert diskutiert — Huml, Glüsenkamp, Niedermaier als klares Favoritenfeld"],"recommendation":"Bamberg ist der komplexeste Dreikampf Bayerns 2026. Zwei Skandale (Masken + Boni), ein Generationenwechsel, progressives Splitting, und €15,75M Smart City Budget. Stichwahl-Analyse am 08.03 abends vorbereiten.","week":"24.02.2026 – 01.03.2026","headline":"13 Tage vor der Wahl: Dreikampf Huml/Glüsenkamp/Niedermaier. Stichwahl praktisch sicher. Masken-Affäre als Damoklesschwert über Huml.","watchItems":["SZ-Bericht (21.02): Alle drei Favoriten sehen sich bei >50% in der Stichwahl — mathematisch unmöglich","BR24 (23.02): Rekord-Kandidatenzahl in ganz Oberfranken, Bamberg = Fokus-Story","Masken-Affäre: Neue Dokumente im Untersuchungsausschuss (Feb 2025) — könnte jederzeit hochkochen"]};

// =====================================================
// STATE
// =====================================================
let currentView = 'briefing';
let currentEntity = Object.keys(KB)[0];
let graphInitialized = false;

// =====================================================
// INITIALIZATION
// =====================================================
function initApp() {
  document.getElementById('topbar-tenant').textContent = TENANT.name || CITY_ID;
  document.title = 'Dossier: ' + (TENANT.gemeinde || CITY_ID);
  var bc = document.getElementById('bc-city');
  if (bc) bc.textContent = TENANT.gemeinde || CITY_ID;
  buildOntology();
  buildIntelFeed();
  buildPatterns();
  buildChat();
  buildStatusBar();
  renderBriefing();
}

// =====================================================
// TAB SWITCHING
// =====================================================
function showOrgDetail(partyName) {
  // Find all entities in this party and show first one, or show a detail overlay
  var members = [];
  for (var k in KB) { if ((KB[k].party||'') === partyName) members.push(k); }
  if (members.length === 1) { showEntity(members[0]); return; }
  // Multiple members: show detail with list
  var h = '<div style="position:relative;max-width:500px">';
  h += '<div class="detail-close" onclick="closeDetail()">✕</div>';
  h += '<div class="detail-title" style="margin-top:8px">'+partyName+'</div>';
  h += '<div style="font:400 7pt var(--f);color:var(--muted);margin-bottom:12px">'+members.length+' Akteure in dieser Organisation</div>';
  for (var i=0;i<members.length;i++) {
    var e = KB[members[i]];
    var rc = e.risk>40?'var(--red)':e.risk>25?'var(--amber)':'var(--green)';
    h += '<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="closeDetail();showEntity(\''+members[i]+'\')">';
    h += '<div style="width:8px;height:8px;border-radius:50%;background:'+e.color+'"></div>';
    h += '<div style="flex:1"><div style="font:600 8pt var(--f);color:var(--text)">'+e.name+'</div>';
    h += '<div style="font:400 6pt var(--f);color:var(--muted)">'+e.role+'</div></div>';
    h += '<div style="font:600 7pt var(--m);color:'+rc+'">Risk: '+e.risk+'</div>';
    h += '</div>';
  }
  h += '</div>';
  var overlay = document.getElementById('detail-overlay');
  overlay.querySelector('.detail-card').innerHTML = h;
  overlay.classList.add('open');
}

function showNewsDetail(idx) {
  var n = NEWS[idx]; if(!n) return;
  var nSentColor = n.sentiment==='NEG'?'var(--red)':n.sentiment==='POS'?'var(--green)':n.sentiment==='MIX'?'var(--amber)':'var(--muted)';
  var h = '<div style="position:relative;max-width:560px">';
  h += '<div class="detail-close" onclick="closeDetail()">✕</div>';
  h += '<div style="font:500 6pt var(--m);color:var(--muted);margin-bottom:4px">'+n.source+' · '+n.date+'</div>';
  h += '<div class="detail-title">'+n.title+'</div>';
  if (n.sentiment) h += '<span style="font:600 6pt var(--m);padding:2px 6px;border-radius:2px;background:'+nSentColor+'15;color:'+nSentColor+'">'+n.sentiment+'</span> ';
  if (n.impact) h += '<span style="font:500 6pt var(--m);color:var(--muted)">Impact: '+n.impact+'</span>';
  h += '<div class="detail-body" style="margin-top:10px"><span class="ev ev-e">E</span> '+n.body+'</div>';
  // Related entities
  if (n.entities && n.entities.length) {
    h += '<div style="margin-top:10px;display:flex;gap:4px;flex-wrap:wrap">';
    for (var i=0;i<n.entities.length;i++) {
      var ne = KB[n.entities[i]];
      if (ne) h += '<span class="related-pill" onclick="closeDetail();showEntity(\''+n.entities[i]+'\')">'+ne.name+'</span>';
    }
    h += '</div>';
  }
  if (n.url) h += '<div style="margin-top:10px"><a href="'+n.url+'" target="_blank" style="font:500 6.5pt var(--m);color:var(--accent);text-decoration:underline">Quelle öffnen →</a></div>';
  h += '</div>';
  var overlay = document.getElementById('detail-overlay');
  overlay.querySelector('.detail-card').innerHTML = h;
  overlay.classList.add('open');
}

function renderTimelineSlider(entityId, events) {
  if (!events || !events.length) return '';
  var years = events.map(function(ev){return parseInt(ev.year||ev.zeitraum)||2026});
  var minY = Math.min.apply(null,years);
  var maxY = Math.max.apply(null,years.concat([2026]));
  var range = maxY - minY || 1;
  var h = '<div class="tl-wrap">';
  h += '<div class="tl-title">Timeline · ' + minY + '–' + maxY + '</div>';
  h += '<div class="tl-track"><div class="tl-line"></div><div class="tl-events">';
  for (var i=0;i<events.length;i++) {
    var ev = events[i];
    var yr = parseInt(ev.year||ev.zeitraum)||2026;
    var pct = ((yr-minY)/range*92+4);
    var ec = ev.color==='red'?'var(--red)':ev.color==='blue'?'var(--blue)':ev.color==='orange'?'var(--amber)':ev.color==='green'?'var(--green)':'var(--muted)';
    h += '<div class="tl-ev" style="left:'+pct+'%" onclick="showTlDetail(\''+entityId+'\','+i+')">';
    h += '<div class="tl-year">'+yr+'</div>';
    h += '<div class="tl-dot" style="background:'+ec+'"></div>';
    h += '<div class="tl-label">'+(ev.label||ev.titel||'').split(' ')[0]+'</div>';
    h += '</div>';
  }
  h += '</div></div>';
  h += '<div class="tl-range"><span>'+minY+'</span><span>'+maxY+'</span></div>';
  h += '<div class="tl-detail" id="tl-detail-'+entityId+'"></div>';
  h += '</div>';
  return h;
}
function showTlDetail(entityId, idx) {
  var e = KB[entityId]; if(!e) return;
  var tl = e.timeline || e.karriere || [];
  var ev = tl[idx]; if(!ev) return;
  var el = document.getElementById('tl-detail-'+entityId); if(!el) return;
  var ec = (ev.color==='red')?'var(--red)':(ev.color==='orange')?'var(--amber)':'var(--text2)';
  el.innerHTML = '<strong style="color:'+ec+'">'+(ev.year||ev.zeitraum||'')+': '+(ev.label||ev.titel||'')+'</strong>'+(ev.beschreibung?'<br><span style="color:var(--muted)">'+ev.beschreibung+'</span>':'');
  el.className = 'tl-detail open';
}
var _watchlist = [];
var _annotations = {};
function exportEntity(id) {
  var e = KB[id]; if (!e) return;
  toast('Export wird vorbereitet: ' + e.name + ' — ' + (e.quellen||[]).length + ' Quellen, ' + (e.controversies||[]).length + ' Kontroversen');
  setTimeout(function(){ toast('PDF-Export: In der Vollversion verfügbar. Kontaktieren Sie uns.'); }, 1500);
}
function watchEntity(id) {
  var idx = _watchlist.indexOf(id);
  if (idx >= 0) { _watchlist.splice(idx,1); toast(KB[id].name + ' von Watchlist entfernt'); }
  else { _watchlist.push(id); toast(KB[id].name + ' auf Watchlist — Sie werden bei Änderungen benachrichtigt'); }
  var btn = document.getElementById('watch-btn-'+id);
  if (btn) btn.textContent = _watchlist.indexOf(id)>=0 ? '★ Watchlist' : '☆ Watchlist';
}
function annotateEntity(id) {
  var note = prompt('Notiz zu ' + KB[id].name + ':', _annotations[id] || '');
  if (note !== null) { _annotations[id] = note; toast('Notiz gespeichert: "' + note.substring(0,40) + (note.length>40?'...':'') + '"'); }
}
function shareEntity(id) {
  var url = window.location.href.split('#')[0] + '#entity-' + id;
  if (navigator.clipboard) { navigator.clipboard.writeText(url); toast('Link kopiert: ' + KB[id].name); }
  else toast('Link: ' + url);
}
function bookmarkAction(idx, btn) {
  if (!btn) return;
  if (btn.classList.contains('active')) { btn.classList.remove('active'); btn.textContent='○ Vormerken'; toast('Aktion entfernt'); }
  else { btn.classList.add('active'); btn.textContent='● Vorgemerkt'; toast('Aktion vorgemerkt — erscheint in Ihrem Wochenbericht'); }
}
function exportAction(idx) {
  var a = ACTIONS[idx]; if(!a) return;
  toast('Export: "'+a.title+'" — In Vollversion als PDF/Email verfügbar');
}
function shareAction(idx) {
  var a = ACTIONS[idx]; if(!a) return;
  if (navigator.clipboard) { navigator.clipboard.writeText(a.title+': '+a.body); toast('Aktion in Zwischenablage kopiert'); }
  else toast('Teilen: '+a.title);
}
function toast(msg) {
  var t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);padding:8px 16px;border-radius:4px;font:500 7pt var(--f);z-index:9999;opacity:0;transition:opacity .3s';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(function(){t.style.opacity='1'},10);
  setTimeout(function(){t.style.opacity='0';setTimeout(function(){t.remove()},300)},3000);
}
function toggleTP(idx) {
  var el = document.getElementById('tp-detail-'+idx);
  var arrow = document.getElementById('tp-arrow-'+idx);
  if (!el) return;
  if (el.style.display==='none') {el.style.display='block';if(arrow)arrow.style.transform='rotate(180deg)';}
  else {el.style.display='none';if(arrow)arrow.style.transform='rotate(0deg)';}
}
function copyTP(btn) {
  var text = btn.getAttribute('data-text');
  if (navigator.clipboard) {navigator.clipboard.writeText(text);toast('Talking Point kopiert');}
  else toast('Kopieren nicht verfügbar');
}
function toggleTopic(idx) {
  var el = document.getElementById('topic-detail-'+idx);
  var arrow = document.getElementById('topic-arrow-'+idx);
  if (!el) return;
  if (el.style.display === 'none') { el.style.display='block'; if(arrow) arrow.style.transform='rotate(180deg)'; }
  else { el.style.display='none'; if(arrow) arrow.style.transform='rotate(0deg)'; }
}
function sortTopic(idx, by) {
  var t = SENTIMENT.topics[idx];
  if (!t || !t.posts) return;
  var posts = t.posts.slice();
  if (by==='date') posts.sort(function(a,b){return (b.date||'').localeCompare(a.date||'')});
  if (by==='sentiment') posts.sort(function(a,b){return (a.sent||0)-(b.sent||0)});
  if (by==='source') posts.sort(function(a,b){return (a.src||'').localeCompare(b.src||'')});
  var h = '';
  for (var pi=0;pi<posts.length;pi++) {
    var p=posts[pi];
    var pc=(p.sent||0)>0.3?'var(--green)':(p.sent||0)<-0.5?'var(--red)':(p.sent||0)<-0.2?'var(--amber)':'var(--muted)';
    var pl=(p.sent||0)>0.3?'POS':(p.sent||0)<-0.5?'NEG':(p.sent||0)<-0.2?'MIX':'NEU';
    h+='<div style="padding:6px 0;border-bottom:1px solid var(--border)">';
    h+='<div style="display:flex;align-items:flex-start;gap:6px">';
    h+='<span style="font:400 5.5pt var(--m);color:var(--muted);min-width:16px">'+(pi+1)+'.</span>';
    h+='<div style="flex:1">';
    h+='<div style="font:400 7pt var(--f);color:var(--text);line-height:1.4">"'+p.text+'"</div>';
    h+='<div style="display:flex;gap:8px;margin-top:3px;font:400 5.5pt var(--m);color:var(--muted)">';
    h+='<span style="color:'+pc+';font-weight:600">'+pl+'</span>';
    h+='<span>'+p.src+'</span><span>'+(p.date||'')+'</span>';
    if(p.cat)h+='<span style="padding:1px 4px;background:var(--surface2);border-radius:2px">'+p.cat+'</span>';
    h+='</div></div></div></div>';
  }
  document.getElementById('topic-posts-'+idx).innerHTML=h;
}
function switchView(view) {
  currentView = view;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.view === view));
  var views = ['briefing','entity','graph','compare','strategy','analytics'];
  views.forEach(function(v) {
    var el = document.getElementById(v + '-view');
    if (el) el.style.display = (v === view) ? (v === 'graph' ? 'block' : '') : 'none';
  });
  if (view === 'briefing') renderBriefing();
  if (view === 'entity') showEntity(currentEntity);
  if (view === 'graph' && !graphInitialized) { renderGraph(); graphInitialized = true; }
  if (view === 'compare') renderCompare();
  if (view === 'strategy') renderStrategy();
  if (view === 'analytics') renderAnalytics();
}

// =====================================================
// LEFT SIDEBAR: Ontology (100% from KB)
// =====================================================
function buildOntology() {
  const el = document.getElementById('ontology-content');
  const keys = Object.keys(KB);
  let html = '<div class="ont-group">';
  html += '<div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> PERSONEN <span class="ont-count">' + keys.length + '</span></div>';
  for (const k of keys) {
    const e = KB[k];
    html += '<div class="ont-item' + (k === currentEntity ? ' active' : '') + '" data-entity="' + k + '" onclick="showEntity(\'' + k + '\',this)">';
    html += '<div class="ont-dot" style="background:' + e.color + '"></div>';
    html += '<span class="ont-label">' + e.name + '</span>';
    html += '<span class="ont-badge" style="background:' + e.color + '15;color:' + e.color + '">' + (e.party || '') + '</span>';
    html += '</div>';
  }
  html += '</div>';

  // Organizations — click filters to entities of that party
  var parties = {};
  for (var pk in KB) { var pp = KB[pk].party||''; if (pp && !parties[pp]) parties[pp] = []; if (pp) parties[pp].push(pk); }
  var partyKeys = Object.keys(parties);
  html += '<div class="ont-group"><div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> ORGANISATIONEN <span class="ont-count">' + partyKeys.length + '</span></div>';
  for (var oi2=0; oi2<partyKeys.length; oi2++) {
    var pname = partyKeys[oi2];
    var pMembers = parties[pname];
    var pColor = pMembers.length > 0 ? KB[pMembers[0]].color : 'var(--muted)';
    html += '<div class="ont-item" style="cursor:pointer" onclick="showOrgDetail(\''+pname.replace(/'/g,"\\'")+'\')">';
    html += '<div class="ont-dot" style="background:'+pColor+'"></div>';
    html += '<span class="ont-label">'+pname+'</span>';
    html += '<span class="ont-badge" style="background:var(--surface2);color:var(--muted)">'+pMembers.length+'</span>';
    html += '</div>';
  }
  html += '</div>';

  // Events from NEWS — click opens detail overlay
  html += '<div class="ont-group"><div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> EVENTS <span class="ont-count">' + NEWS.length + '</span></div>';
  for (var ni2=0; ni2<NEWS.length; ni2++) {
    var n = NEWS[ni2];
    var nColor = n.sentiment==='NEG'?'var(--red)':n.sentiment==='POS'?'var(--green)':n.sentiment==='MIX'?'var(--amber)':'var(--muted)';
    html += '<div class="ont-item" style="cursor:pointer" onclick="showNewsDetail('+ni2+')">';
    html += '<div class="ont-dot" style="background:'+nColor+'"></div>';
    html += '<span class="ont-label">' + n.title.substring(0, 35) + '...</span></div>';
  }
  html += '</div>';

  // Themes from SENTIMENT topics — click opens topic drill-down
  if (SENTIMENT.topics && SENTIMENT.topics.length) {
    html += '<div class="ont-group"><div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> THEMEN <span class="ont-count">' + SENTIMENT.topics.length + '</span></div>';
    for (var sti=0; sti<SENTIMENT.topics.length; sti++) {
      var st = SENTIMENT.topics[sti];
      var stColor = (st.pct||0) < -50 ? 'var(--red)' : (st.pct||0) < 0 ? 'var(--amber)' : 'var(--green)';
      html += '<div class="ont-item" style="cursor:pointer" onclick="switchView(\'strategy\');setTimeout(function(){toggleTopic('+sti+')},100)">';
      html += '<div class="ont-dot" style="background:'+stColor+'"></div>';
      html += '<span class="ont-label">'+st.name+'</span>';
      html += '<span class="ont-badge" style="background:'+stColor+'15;color:'+stColor+'">'+(st.pct||0)+'%</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Hypotheses — click goes to compare tab
  if (HYPOTHESES.length) {
    html += '<div class="ont-group"><div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> HYPOTHESEN <span class="ont-count">' + HYPOTHESES.length + '</span></div>';
    for (var hi=0; hi<HYPOTHESES.length; hi++) {
      var hyp = HYPOTHESES[hi];
      var hConf = hyp.confidence || 50;
      var hColor = hConf > 70 ? 'var(--green)' : hConf > 40 ? 'var(--amber)' : 'var(--red)';
      html += '<div class="ont-item" style="cursor:pointer" onclick="switchView(\'compare\')">';
      html += '<div class="ont-dot" style="background:'+hColor+'"></div>';
      html += '<span class="ont-label">'+(hyp.title||hyp.label||'').substring(0,35)+'</span>';
      html += '<span class="ont-badge" style="background:'+hColor+'15;color:'+hColor+'">'+hConf+'%</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Jurisdiction — click goes to briefing
  html += '<div class="ont-group"><div class="ont-group-title"><span style="color:var(--text2)">&#9679;</span> JURISDIKTIONEN <span class="ont-count">1</span></div>';
  html += '<div class="ont-item" style="cursor:pointer" onclick="switchView(\'briefing\')">';
  html += '<div class="ont-dot" style="background:var(--blue)"></div>';
  html += '<span class="ont-label">' + TENANT.landkreis + '</span>';
  html += '<span class="ont-badge" style="background:var(--blue-bg);color:var(--blue)">'+Object.keys(KB).length+' Entities</span>';
  html += '</div></div>';

  el.innerHTML = html;
}

// =====================================================
// RIGHT SIDEBAR: Intel Feed + Patterns
// =====================================================
function buildIntelFeed() {
  const el = document.getElementById('intel-feed');
  let html = '';
  for (var fi=0; fi<NEWS.length; fi++) {
    var n = NEWS[fi];
    var cls = n.sentiment==='NEG' ? 'feed-alert' : '';
    html += '<div class="feed-item ' + cls + '" onclick="showNewsDetail('+fi+')" style="cursor:pointer">';
    html += '<div class="feed-source">' + n.source + ' · ' + n.date + '</div>';
    html += '<div class="feed-title">' + n.title + '</div>';
    html += '<div class="feed-body">' + (n.body || '').substring(0, 100) + '...</div>';
    html += '</div>';
  }
  el.innerHTML = html;
}

function buildPatterns() {
  const el = document.getElementById('detected-patterns');
  let html = '';
  for (const p of PATTERNS) {
    html += '<div class="pattern clickable" onclick="switchView(\'strategy\')">';
    html += '<div class="pattern-title">' + p.label + '</div>';
    html += '<div class="pattern-body">' + p.meaning.substring(0, 150) + (p.meaning.length > 150 ? '...' : '') + '</div>';
    html += '<div class="pattern-conf">' + (p.confidence || 50) + '%</div>';
    html += '</div>';
  }
  el.innerHTML = html;
}

// =====================================================
// TAB: BRIEFING
// =====================================================
function renderBriefing() {
  const el = document.getElementById('briefing-view');
  const keys = Object.keys(KB);
  const topRisk = keys.sort((a, b) => KB[b].risk - KB[a].risk).slice(0, 3);
  const lastName = USER.name.split(' ').pop();

  let h = '';
  // E/I/J/A Legend
  h += '<div class="ev-legend"><span><span class="ev ev-e">E</span> Belegt</span><span><span class="ev ev-i">I</span> Abgeleitet</span><span><span class="ev ev-j">J</span> Einschätzung</span><span><span class="ev ev-a">A</span> Annahme</span></div>';
  h += '<div class="briefing-hero">';
  h += '<div class="briefing-greeting">Guten Tag, <strong>Herr ' + lastName + '</strong></div>';
  h += '<div class="briefing-subtitle"><span class="ev ev-e">E</span> ' + keys.length + ' Dossiers analysiert · ' + NEWS.length + ' aktuelle Meldungen · ' + HYPOTHESES.length + ' aktive Hypothesen</div>';
  h += '</div>';

  // KPI Row
  var totalQuellen = 0, totalKontroversen = 0, totalConnections = 0;
  for (var kk in KB) {
    totalQuellen += (KB[kk].quellen || []).length;
    totalKontroversen += (KB[kk].controversies || []).length + (KB[kk].contradictions || []).length;
    totalConnections += (KB[kk].connections || []).length;
  }
  totalConnections += (GRAPH.links || []).length;
  h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:16px">';
  var kpis = [
    {val:keys.length, label:'Dossiers', delta:'Aktuell', color:'var(--text)', click:"switchView('entity')"},
    {val:totalQuellen, label:'Quellen', delta:'verifiziert', color:'var(--text)', click:""},
    {val:(GRAPH.nodes||[]).length, label:'Akteure', delta:(GRAPH.links||[]).length+' Verbindungen', color:'var(--text)', click:"switchView('graph')"},
    {val:totalKontroversen, label:'Kontroversen', delta:(function(){var s=0;for(var x in KB)s+=(KB[x].contradictions||[]).length;return s})() + ' Widersprüche', color:'var(--red)', click:"switchView('compare')"},
    {val:HYPOTHESES.length, label:'Hypothesen', delta:'aktiv', color:'var(--accent)', click:"switchView('compare')"},
    {val:ACTIONS.length, label:'Aktionen', delta:'empfohlen', color:'var(--green)', click:"switchView('strategy')"}
  ];
  for (var ki=0; ki<kpis.length; ki++) {
    var kp = kpis[ki];
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:10px 12px;cursor:pointer;transition:border-color .15s" onclick="' + kp.click + '" onmouseover="this.style.borderColor=\'var(--accent)\'" onmouseout="this.style.borderColor=\'var(--border)\'">';
    h += '<div style="font:700 18pt var(--m);color:' + kp.color + '">' + kp.val + '</div>';
    h += '<div style="font:500 6.5pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.06em">' + kp.label + '</div>';
    h += '<div style="font:400 5.5pt var(--m);color:var(--muted);margin-top:2px">' + kp.delta + '</div>';
    h += '</div>';
  }
  h += '</div>';

  // Active Alerts
  if (TENANT.alerts && TENANT.alerts.length) {
    h += '<div class="canvas-title">Aktive Alerts <span class="ct-badge" style="background:var(--red)">' + TENANT.alerts.length + '</span></div>';
    for (var ai=0; ai<TENANT.alerts.length; ai++) {
      var al = TENANT.alerts[ai];
      var alColor = al.priority === 'KRITISCH' ? 'var(--red)' : al.priority === 'HOCH' ? 'var(--amber)' : 'var(--muted)';
      h += '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-left:3px solid ' + alColor + ';border-radius:4px;margin-bottom:6px;cursor:pointer;transition:border-color .15s" onmouseover="this.style.borderColor=\'' + alColor + '\'" onmouseout="this.style.borderColor=\'var(--border)\'"';
      if (al.entity) h += ' onclick="showEntity(\'' + al.entity + '\')"';
      h += '>';
      h += '<div style="font:700 8pt var(--f);color:' + alColor + ';flex-shrink:0">●</div>';
      h += '<div style="flex:1"><div style="font:600 7.5pt var(--f);color:var(--text)">' + al.title + '</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted)">' + al.meta + '</div></div>';
      h += '<div style="font:400 8pt var(--f);color:var(--accent)">→</div>';
      h += '</div>';
    }
  }

  // Weekly Brief mini (in Briefing)
  if (WEEKLYBRIEF) {
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:6px;padding:12px;margin-bottom:12px">';
    h += '<div style="display:flex;justify-content:space-between;align-items:center">';
    h += '<div style="font:600 8pt var(--f);color:var(--text)">Diese Woche: '+WEEKLYBRIEF.priorities.length+' Priorit\u00e4ten</div>';
    h += '<div style="font:700 9pt var(--m);color:var(--red)">'+WEEKLYBRIEF.daysToElection+' Tage bis Wahl</div>';
    h += '</div>';
    for (var bwi=0;bwi<WEEKLYBRIEF.priorities.length;bwi++) {
      var bwp = WEEKLYBRIEF.priorities[bwi];
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);margin-top:4px"><strong style="color:var(--accent)">'+bwp.nr+'.</strong> '+bwp.action+' <span style="color:var(--red);font-weight:500">('+bwp.deadline+')</span></div>';
    }
    h += '<div style="text-align:right;margin-top:6px"><span style="font:500 5.5pt var(--m);color:var(--accent);cursor:pointer;text-decoration:underline" onclick="switchView(\'strategy\')">Vollst\u00e4ndiges Briefing \u2192</span></div>';
    h += '</div>';
  }

  // Top risk cards
  h += '<div class="canvas-title">Jetzt relevant</div>';
  h += '<div class="briefing-grid">';
  for (const k of topRisk) {
    const e = KB[k];
    const riskColor = e.risk > 40 ? 'var(--red)' : e.risk > 25 ? 'var(--amber)' : 'var(--green)';
    h += '<div class="briefing-card clickable" onclick="showEntity(\'' + k + '\')">';
    h += '<div class="briefing-card-title" style="color:' + riskColor + '">' + e.name + '</div>';
    h += '<div class="briefing-card-body"><span class="ev ev-j">J</span> ' + (e.summary || '').substring(0, 120) + '...</div>';
    h += '<div class="briefing-card-tag" style="background:' + riskColor + '20;color:' + riskColor + '"><span class="ev ev-j">J</span> RISK ' + e.risk + '</div>';
    h += '</div>';
  }
  h += '</div>';

  // Forecast / Stichwahl card
  if (FORECAST) {
    h += '<div class="canvas-title">Wahlprognose ' + FORECAST.wahltermin + '</div>';
    h += '<div class="entity-card"><div class="entity-body">';
    // Stichwahl range indicator
    var swR = FORECAST.stichwahlRange || {min:30,max:55};
    h += '<div style="margin-bottom:14px">';
    h += '<div style="font:600 9pt var(--f);margin-bottom:8px"><span class="ev ev-j">J</span> Stichwahl-Wahrscheinlichkeit</div>';
    // Band visualization
    h += '<div style="position:relative;height:28px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-bottom:6px">';
    // Color bands (0-10 green, 10-20 green light, 20-30 amber light, 30-50 amber, 50-70 red light, 70-100 red)
    h += '<div style="position:absolute;left:0;width:10%;height:100%;background:rgba(45,138,78,0.12)"></div>';
    h += '<div style="position:absolute;left:10%;width:10%;height:100%;background:rgba(45,138,78,0.08)"></div>';
    h += '<div style="position:absolute;left:20%;width:10%;height:100%;background:rgba(180,83,9,0.08)"></div>';
    h += '<div style="position:absolute;left:30%;width:20%;height:100%;background:rgba(180,83,9,0.15)"></div>';
    h += '<div style="position:absolute;left:50%;width:20%;height:100%;background:rgba(192,57,43,0.08)"></div>';
    h += '<div style="position:absolute;left:70%;width:30%;height:100%;background:rgba(192,57,43,0.15)"></div>';
    // Active range highlight
    h += '<div style="position:absolute;left:' + swR.min + '%;width:' + (swR.max - swR.min) + '%;height:100%;background:var(--amber);opacity:0.35;border-radius:3px;border:2px solid var(--amber)"></div>';
    // Labels
    h += '<div style="position:absolute;left:2%;top:50%;transform:translateY(-50%);font:400 5pt var(--m);color:var(--green)">unwahrsch.</div>';
    h += '<div style="position:absolute;left:' + (swR.min + (swR.max - swR.min)/2) + '%;top:50%;transform:translate(-50%,-50%);font:700 9pt var(--m);color:var(--amber)">' + swR.min + '-' + swR.max + '%</div>';
    h += '<div style="position:absolute;right:2%;top:50%;transform:translateY(-50%);font:400 5pt var(--m);color:var(--red)">wahrsch.</div>';
    h += '</div>';
    // Legend
    h += '<div style="display:flex;justify-content:space-between;font:400 5pt var(--m);color:var(--muted)">';
    h += '<span>0%</span><span>10</span><span>20</span><span>30</span><span>40</span><span>50</span><span>60</span><span>70</span><span>80</span><span>90</span><span>100%</span>';
    h += '</div>';
    h += '<div style="font:400 6.5pt var(--m);color:var(--muted);margin-top:6px">Stichwahl am ' + FORECAST.stichwahl + ' falls kein Kandidat >50% · Spanne: ' + swR.min + '-' + swR.max + '% · Confidence: ' + FORECAST.stichwahlConf + '%</div>';
    h += '</div>';
    // Candidate bars
    for (const k of FORECAST.kandidaten) {
      const barColor = k.partei === 'CSU' ? '#0a4d8c' : k.partei === 'SPD' ? '#c0392b' : k.partei === 'Grüne' ? '#4a8c3f' : k.partei === 'AfD' ? '#2a5298' : 'var(--muted)';
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
      h += '<div style="width:90px;font:500 7pt var(--f);color:var(--text)">' + k.name.split(' ').pop() + '</div>';
      h += '<div style="flex:1;height:16px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative">';
      // Range bar (min-max)
      h += '<div style="position:absolute;left:' + k.min + '%;width:' + (k.max - k.min) + '%;height:100%;background:' + barColor + '30;border-radius:3px"></div>';
      // Central estimate
      h += '<div style="position:absolute;left:' + k.zentral + '%;width:2px;height:100%;background:' + barColor + '"></div>';
      h += '</div>';
      h += '<div style="width:70px;font:500 6.5pt var(--m);color:var(--text2);text-align:right"><span class="ev ev-' + k.tag.toLowerCase() + '">' + k.tag + '</span> ' + k.min + '-' + k.max + '%</div>';
      h += '</div>';
    }
    // 50% threshold line label
    h += '<div style="display:flex;align-items:center;gap:8px;margin-top:4px">';
    h += '<div style="width:90px"></div>';
    h += '<div style="flex:1;position:relative;height:12px"><div style="position:absolute;left:50%;transform:translateX(-50%);font:400 5pt var(--m);color:var(--red)">50% (Stichwahl-Schwelle)</div></div>';
    h += '<div style="width:70px"></div></div>';
    // Historic trend
    h += '<div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)">';
    h += '<div style="font:600 6pt var(--m);color:var(--muted);margin-bottom:6px">LODERER-TREND (BM-WAHLEN)</div>';
    h += '<div style="display:flex;gap:12px;align-items:flex-end">';
    for (const w of FORECAST.historie.filter(h => h.wg === 1)) {
      const barH = Math.round(w.loderer * 0.8);
      const c = w.stichwahl ? 'var(--amber)' : 'var(--green)';
      h += '<div style="text-align:center"><div style="font:500 7pt var(--m);color:var(--text)">' + w.loderer + '%</div>';
      h += '<div style="width:36px;height:' + barH + 'px;background:' + c + ';border-radius:2px 2px 0 0;margin:2px auto"></div>';
      h += '<div style="font:400 5pt var(--m);color:var(--muted)">' + w.jahr + (w.stichwahl ? '*' : '') + '</div></div>';
    }
    // 2026 forecast
    h += '<div style="text-align:center"><div style="font:500 7pt var(--m);color:var(--amber)">~47%?</div>';
    h += '<div style="width:36px;height:38px;background:var(--amber);border-radius:2px 2px 0 0;margin:2px auto;opacity:0.5;border:1px dashed var(--amber)"></div>';
    h += '<div style="font:400 5pt var(--m);color:var(--amber)">2026</div></div>';
    h += '</div></div>';
    h += '</div></div>';
  }

  // Latest news
  h += '<div class="canvas-title">Aktuelle Lage <span class="ct-badge" style="background:var(--accent)">' + NEWS.length + ' MELDUNGEN</span></div>';
  for (var ni=0; ni<NEWS.length; ni++) {
    var n = NEWS[ni];
    var nSentColor = n.sentiment==='NEG'?'var(--red)':n.sentiment==='POS'?'var(--green)':n.sentiment==='MIX'?'var(--amber)':'var(--muted)';
    var nImpactColor = n.impact==='HOCH'?'var(--red)':n.impact==='MITTEL'?'var(--amber)':'var(--muted)';
    h += '<div class="nf-card">';
    h += '<div style="font:600 8pt var(--f);color:var(--text);line-height:1.3">' + n.title + '</div>';
    h += '<div style="font:400 7pt var(--f);color:var(--text2);line-height:1.5;margin:4px 0"><span class="ev ev-e">E</span> ' + (n.body || '') + '</div>';
    h += '<div class="nf-meta">';
    h += '<span>' + n.source + '</span><span>' + n.date + '</span>';
    if (n.sentiment) h += '<span class="nf-sentiment" style="background:'+nSentColor+'15;color:'+nSentColor+'">'+n.sentiment+'</span>';
    if (n.impact) h += '<span class="nf-impact" style="color:'+nImpactColor+'">Impact: '+n.impact+'</span>';
    if (n.entities && n.entities.length) {
      for (var nei=0;nei<n.entities.length;nei++) {
        var ne = KB[n.entities[nei]];
        if (ne) h += '<span class="related-pill" style="padding:1px 5px;font-size:5pt" onclick="showEntity(\''+n.entities[nei]+'\')">'+ne.name.split(' ').pop()+'</span>';
      }
    }
    h += '</div></div>';
  }

  // Risk Ranking (absorbed from Alerts)
  h += '<div class="canvas-title">Risiko-Ranking</div>';
  h += '<div class="entity-card"><div class="entity-body">';
  const ranked = Object.keys(KB).sort((a, b) => KB[b].risk - KB[a].risk);
  for (const k of ranked) {
    const e = KB[k];
    const rc = e.risk > 40 ? 'var(--red)' : e.risk > 25 ? 'var(--amber)' : 'var(--green)';
    h += '<div class="risk-row" onclick="showEntity(\'' + k + '\')">';
    h += '<div class="risk-name" style="color:' + e.color + '">' + e.name + '</div>';
    h += '<div class="risk-bar-bg"><div class="risk-bar" style="width:' + e.risk + '%;background:' + rc + '"></div></div>';
    h += '<div class="risk-val" style="color:' + rc + '"><span class="ev ev-j">J</span> ' + e.risk + '</div>';
    h += '</div>';
  }
  h += '</div></div>';

  // NEW: Rich Themen-Radar (from themen section)
  if (THEMEN.radar && THEMEN.radar.length) {
    h += '<div class="canvas-title">Themen-Radar <span class="ct-badge" style="background:var(--blue)">' + THEMEN.radar.length + ' THEMEN</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<div style="font:400 6pt var(--m);color:var(--muted);margin-bottom:8px">Quelle: ' + (THEMEN.source || '') + ' · Stand: ' + (THEMEN.lastUpdated || '') + '</div>';
    var sortedThemen = THEMEN.radar.slice().sort(function(a,b){return b.relevanz - a.relevanz});
    for (var ti=0; ti<sortedThemen.length; ti++) {
      var th = sortedThemen[ti];
      var thColor = th.relevanz >= 85 ? 'var(--red)' : th.relevanz >= 70 ? 'var(--amber)' : 'var(--green)';
      var trendIcon = th.trend === 'steigend' ? '↑' : th.trend === 'fallend' ? '↓' : '→';
      h += '<div style="margin-bottom:10px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-left:3px solid ' + thColor + ';border-radius:4px">';
      h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
      h += '<div style="font:600 7.5pt var(--f);color:var(--text)">' + th.label + '</div>';
      h += '<div style="display:flex;align-items:center;gap:6px">';
      h += '<span style="font:500 6pt var(--m);color:' + thColor + '">' + trendIcon + ' ' + th.trend + '</span>';
      h += '<span style="font:700 8pt var(--m);color:' + thColor + '">' + th.relevanz + '</span>';
      h += '</div></div>';
      h += '<div style="height:4px;background:var(--surface2);border-radius:2px;margin-bottom:4px"><div style="height:100%;width:' + th.relevanz + '%;background:' + thColor + ';border-radius:2px"></div></div>';
      h += '<div style="font:400 6pt var(--f);color:var(--text2);line-height:1.4">' + th.beschreibung + '</div>';
      // Candidate positions
      if (th.positionen && Object.keys(th.positionen).length > 0) {
        h += '<div style="margin-top:6px;padding-top:5px;border-top:1px solid var(--border)">';
        for (var pid in th.positionen) {
          var pName = KB[pid] ? KB[pid].name.split(' ').pop() : pid;
          var pParty = KB[pid] ? KB[pid].party : '';
          h += '<div style="font:400 5.5pt var(--f);color:var(--muted);margin-top:2px"><strong style="color:var(--text)">' + pName + '</strong> (' + pParty + '): ' + th.positionen[pid] + '</div>';
        }
        h += '</div>';
      }
      h += '</div>';
    }
    h += '</div></div>';
  }

  // NEW: Social Media Intelligence
  if (SOCIAL.kandidaten && SOCIAL.kandidaten.length) {
    h += '<div class="canvas-title">Social Media Intelligence <span class="ct-badge" style="background:var(--blue)">' + SOCIAL.kandidaten.length + ' PROFILE</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<div style="font:400 6pt var(--m);color:var(--muted);margin-bottom:8px">Stand: ' + (SOCIAL.lastUpdated || '') + ' · Plattformen: ' + (SOCIAL.platforms || []).join(', ') + '</div>';
    // Bar chart of followers
    var maxFollowers = 0;
    for (var si=0; si<SOCIAL.kandidaten.length; si++) {
      var sf = (SOCIAL.kandidaten[si].instagram || {}).followers || 0;
      if (sf > maxFollowers) maxFollowers = sf;
    }
    for (var si=0; si<SOCIAL.kandidaten.length; si++) {
      var sk = SOCIAL.kandidaten[si];
      var ig = sk.instagram || {};
      var followers = ig.followers || 0;
      var barPct = maxFollowers > 0 ? Math.round((followers / maxFollowers) * 100) : 0;
      var skPartyColor = sk.partei === 'CSU' ? '#0a4d8c' : sk.partei === 'SPD' ? '#c0392b' : sk.partei === 'Grüne' ? '#4a8c3f' : 'var(--muted)';
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">';
      h += '<div style="width:90px;font:500 7pt var(--f);color:var(--text);cursor:pointer" onclick="showEntity(\'' + sk.id + '\')">' + sk.name.split(' ').pop() + '</div>';
      h += '<div style="flex:1;height:20px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative">';
      if (followers > 0) {
        h += '<div style="width:' + barPct + '%;height:100%;background:' + skPartyColor + '40;border-radius:3px"></div>';
        h += '<div style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font:600 6.5pt var(--m);color:var(--text)">' + followers.toLocaleString() + ' Follower</div>';
      } else {
        h += '<div style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font:400 6pt var(--m);color:var(--muted)">Keine Daten</div>';
      }
      h += '</div>';
      h += '<div style="width:18px;text-align:center">';
      if (ig.handle) h += '<span style="font:400 7pt var(--f);cursor:pointer;color:var(--accent)" title="@' + ig.handle + '">📷</span>';
      h += '</div></div>';
    }
    // Insights
    if (SOCIAL.insights && SOCIAL.insights.length) {
      h += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">';
      h += '<div style="font:600 6.5pt var(--m);color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.06em">Key Insights</div>';
      for (var ii=0; ii<SOCIAL.insights.length; ii++) {
        var ins = SOCIAL.insights[ii];
        var insColor = ins.severity === 'HOCH' ? 'var(--red)' : ins.severity === 'MITTEL' ? 'var(--amber)' : 'var(--muted)';
        h += '<div style="padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-left:2px solid ' + insColor + ';border-radius:3px;margin-bottom:4px">';
        h += '<div style="font:600 6.5pt var(--f);color:var(--text)">' + ins.title + '</div>';
        h += '<div style="font:400 5.5pt var(--f);color:var(--text2);margin-top:2px">' + ins.body + '</div>';
        if (ins.soWhat) h += '<div style="font:500 5.5pt var(--f);color:var(--accent);margin-top:2px">→ ' + ins.soWhat + '</div>';
        h += '</div>';
      }
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Google Trends Intelligence
  if (SOCIAL.google_trends && SOCIAL.google_trends.comparison) {
    var gt = SOCIAL.google_trends;
    var gtCands = Object.keys(gt.comparison);
    h += '<div class="canvas-title">Google Trends Intelligence <span class="ct-badge" style="background:var(--accent)">LIVE</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<div style="font:400 6pt var(--m);color:var(--muted);margin-bottom:8px">' + gt.source + ' · Stand: ' + gt.updated + '</div>';
    var maxGT = 0;
    for (var gi=0; gi<gtCands.length; gi++) { var gv = gt.comparison[gtCands[gi]].recent || 0; if (gv > maxGT) maxGT = gv; }
    for (var gi=0; gi<gtCands.length; gi++) {
      var gName = gtCands[gi];
      var gData = gt.comparison[gName];
      var gPct = maxGT > 0 ? Math.round((gData.recent / maxGT) * 100) : 0;
      var gTrend = gData.trend_pct || 0;
      var gTrendColor = gTrend > 50 ? 'var(--green)' : gTrend < -10 ? 'var(--red)' : 'var(--muted)';
      var gTrendArrow = gTrend > 50 ? '📈' : gTrend < -10 ? '📉' : '➡️';
      h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
      h += '<div style="width:120px;font:500 7pt var(--f);color:var(--text)">' + gName.split(' ').pop() + '</div>';
      h += '<div style="flex:1;height:18px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative">';
      h += '<div style="width:' + gPct + '%;height:100%;background:var(--accent)30;border-radius:3px;transition:width .5s"></div>';
      h += '<div style="position:absolute;right:6px;top:50%;transform:translateY(-50%);font:600 6.5pt var(--m);color:var(--text)">Suchinteresse: ' + gData.recent + '</div>';
      h += '</div>';
      h += '<div style="width:60px;text-align:right;font:600 6.5pt var(--m);color:' + gTrendColor + '">' + (gTrend > 0 ? '+' : '') + gTrend + '% ' + gTrendArrow + '</div>';
      h += '</div>';
    }
    if (gt.insight) {
      h += '<div style="margin-top:8px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-left:2px solid var(--accent);border-radius:3px">';
      h += '<div style="font:600 6pt var(--m);color:var(--accent);margin-bottom:3px;text-transform:uppercase;letter-spacing:.06em">💎 Red Diamond Insight</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);line-height:1.5">' + gt.insight + '</div>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Momentum Index
  if (SOCIAL.momentum_index && SOCIAL.momentum_index.candidates) {
    var mi = SOCIAL.momentum_index;
    var miCands = Object.keys(mi.candidates);
    h += '<div class="canvas-title">Momentum Index <span class="ct-badge" style="background:var(--red)">COMPOSITE</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<div style="font:400 6pt var(--m);color:var(--muted);margin-bottom:8px">' + mi.source + '</div>';
    for (var mii=0; mii<miCands.length; mii++) {
      var miName = miCands[mii];
      var miData = mi.candidates[miName];
      var miScore = miData.score || 0;
      var miComps = miData.components || {};
      h += '<div style="margin-bottom:10px">';
      h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">';
      h += '<div style="font:600 7.5pt var(--f);color:var(--text)">' + miName + '</div>';
      h += '<div style="font:700 9pt var(--m);color:var(--accent)">' + miScore + '/100</div>';
      h += '</div>';
      h += '<div style="height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-bottom:4px">';
      h += '<div style="width:' + miScore + '%;height:100%;background:linear-gradient(90deg,var(--accent),var(--blue));border-radius:4px;transition:width .5s"></div>';
      h += '</div>';
      // Component bars
      var compNames = {'engagement':'Engagement','growth':'Wachstum','search_interest':'Suchinteresse','activity':'Aktivität','cross_platform':'Cross-Platform'};
      h += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
      for (var ck in miComps) {
        var cv = miComps[ck];
        var cl = compNames[ck] || ck;
        var cc = cv >= 80 ? 'var(--green)' : cv >= 50 ? 'var(--amber)' : 'var(--red)';
        h += '<div style="font:400 5.5pt var(--m);color:' + cc + ';padding:2px 5px;background:var(--surface);border-radius:2px;border:1px solid var(--border)">' + cl + ' ' + cv + '</div>';
      }
      h += '</div></div>';
    }
    if (mi.verdict) {
      h += '<div style="margin-top:6px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-left:2px solid var(--red);border-radius:3px">';
      h += '<div style="font:600 6pt var(--m);color:var(--red);margin-bottom:3px;text-transform:uppercase;letter-spacing:.06em">⚔️ Verdict</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);line-height:1.5">' + mi.verdict + '</div>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Themen-Radar (absorbed from Stimmung) — fallback for cities without rich themen section
  if ((!THEMEN.radar || !THEMEN.radar.length) && SENTIMENT.topics && SENTIMENT.topics.length) {
    h += '<div class="canvas-title">Themen-Radar <span class="ct-badge" style="background:var(--blue)">' + SENTIMENT.topics.length + ' TOPICS</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    for (var bti=0; bti<SENTIMENT.topics.length; bti++) {
      var t = SENTIMENT.topics[bti];
      var tpctB = t.pct || t.sentiment || 0;
      var tColorB = tpctB < -50 ? 'var(--red)' : tpctB < 0 ? 'var(--amber)' : 'var(--green)';
      var tPostsN = (t.posts||[]).length;
      h += '<div class="sent-topic" style="cursor:pointer" onclick="switchView(\'strategy\');setTimeout(function(){toggleTopic('+bti+')},100)">';
      h += '<div class="sent-topic-name">' + t.name + ' <span style="font:400 5.5pt var(--m);color:var(--accent);text-decoration:underline">('+tPostsN+' Beiträge →)</span></div>';
      h += '<div class="sent-topic-bar"><div class="sent-topic-fill" style="width:' + Math.min(100, Math.abs(tpctB) + 10) + '%;background:' + tColorB + '"></div></div>';
      h += '<div class="sent-topic-pct" style="color:' + tColorB + '"><span class="ev ev-i">I</span> ' + (tpctB > 0 ? '+' : '') + tpctB + '%</div>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Cross-patterns summary
  if (PATTERNS.length > 0) {
    h += '<div class="canvas-title">Erkannte Muster</div>';
    h += '<div class="pattern-grid">';
    for (const p of PATTERNS) {
      h += '<div class="pattern-card clickable" onclick="switchView(\'strategy\')">';
      h += '<div class="pattern-card-title">' + p.label + '</div>';
      h += '<div class="pattern-card-body">' + p.meaning.substring(0, 120) + '...</div>';
      h += '<div class="pattern-card-conf"><span class="ev ev-i">I</span> ' + (p.confidence || 50) + '%</div>';
      h += '</div>';
    }
    h += '</div>';
  }

  // Key Hypothesis (absorbed from Hypothesen — show top 1)
  if (HYPOTHESES.length > 0) {
    const topH = HYPOTHESES[0];
    const conf = topH.confidence || topH.conf || 50;
    h += '<div class="canvas-title">Top-Hypothese</div>';
    h += '<div class="hypo-card clickable" onclick="switchView(\'compare\')">';
    h += '<div class="hypo-card-header"><div class="hypo-card-title">' + topH.title + '</div>';
    h += '<div class="hypo-card-status" style="background:var(--accent)15;color:var(--accent)">' + conf + '%</div></div>';
    h += '<div class="hypo-body"><span class="ev ev-a">A</span> ' + (topH.summary || topH.body || '') + '</div>';
    h += '<div class="hypo-conf-bar"><div class="hypo-conf-fill" style="width:' + conf + '%;background:var(--accent)"></div></div>';
    h += '</div>';
  }

  el.innerHTML = h;
}

// =====================================================
// TAB: ENTITY (Deep Dossier)
// =====================================================
function showEntity(id, el) {
  currentEntity = id;
  if (el) {
    document.querySelectorAll('.ont-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
  }
  if (currentView !== 'entity') switchView('entity');

  const p = KB[id];
  if (!p) return;

  const canvas = document.getElementById('entity-view');
  let h = '';

  // Entity card header
  h += '<div class="canvas-title">Entity: ' + p.name + ' <span class="ct-badge" style="background:' + p.color + '">DOSSIER</span></div>';
  h += '<div class="entity-card"><div class="entity-header"><div>';
  h += '<div class="entity-name" style="color:' + p.color + '">' + p.name + '</div>';
  h += '<div class="entity-meta"><span><span class="ev ev-e">E</span> TYPE: Person</span><span><span class="ev ev-j">J</span> RISK: ' + p.risk + '</span><span><span class="ev ev-e">E</span> PARTEI: ' + (p.party || '—') + '</span></div>';
  h += '</div></div>';
  // Dossier link button
  if (p.dossierUrl) {
    h += '<div style="margin-top:8px"><a href="' + p.dossierUrl + '" target="_blank" style="display:inline-flex;align-items:center;gap:6px;font:600 7pt var(--m);color:var(--accent);background:var(--gold-bg);padding:6px 14px;border-radius:3px;text-decoration:none;border:1px solid var(--accent)">Vollständiges Dossier öffnen <span style="font-size:9pt">→</span></a></div>';
  }
  // Entity Actions Bar
  h += '<div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">';
  h += '<button onclick="exportEntity(\''+id+'\')" style="font:500 6pt var(--m);padding:4px 10px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2)">↓ Export PDF</button>';
  h += '<button onclick="watchEntity(\''+id+'\')" style="font:500 6pt var(--m);padding:4px 10px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2)" id="watch-btn-'+id+'">' + (_watchlist.indexOf(id)>=0?'★ Watchlist':'☆ Watchlist') + '</button>';
  h += '<button onclick="annotateEntity(\''+id+'\')" style="font:500 6pt var(--m);padding:4px 10px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2)">✎ Notiz</button>';
  h += '<button onclick="shareEntity(\''+id+'\')" style="font:500 6pt var(--m);padding:4px 10px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--text2)">↗ Teilen</button>';
  h += '</div>';
  h += '</div>';

  // Steckbrief
  if (p.steckbrief) {
    h += '<div class="canvas-title">Steckbrief</div>';
    h += '<div class="entity-card"><div class="entity-body"><div class="prop-grid">';
    for (const [key, val] of Object.entries(p.steckbrief)) {
      h += '<div class="prop-key">' + key + '</div><div class="prop-val"><span class="ev ev-e">E</span> ' + val + '</div>';
    }
    h += '</div></div></div>';
  }

  // Properties
  if (p.properties && p.properties.length) {
    h += '<div class="canvas-title">Profil <span class="ct-badge" style="background:var(--gold)">' + p.properties.length + ' ATTRIBUTE</span></div>';
    h += '<div class="entity-card"><div class="entity-body"><div class="prop-grid">';
    for (const prop of p.properties) {
      var prov = '';
      if (prop.src) {
        var freshColor = prop.fresh === 'CURRENT' ? 'var(--green)' : prop.fresh === 'VERIFIED' ? 'var(--blue)' : 'var(--muted)';
        var typeLabel = prop.type === 'official' ? 'OFFIZIELL' : prop.type === 'inference' ? 'ABGELEITET' : prop.type === 'estimate' ? 'SCHÄTZUNG' : prop.type || '';
        prov = '<div style="font:400 5pt var(--m);color:var(--muted);margin-top:1px">' + prop.src + ' · <span style="color:' + freshColor + '">' + (prop.fresh || '') + '</span>' + (typeLabel ? ' · ' + typeLabel : '') + '</div>';
      }
      h += '<div class="prop-key">' + prop.key + '</div><div class="prop-val"><span class="ev ev-' + (prop.ev || 'e') + '">' + (prop.ev || 'E').toUpperCase() + '</span> ' + prop.val + prov + '</div>';
    }
    h += '</div></div></div>';
  }

  // Timeline Slider (visual)
  if (p.timeline && p.timeline.length) {
    h += renderTimelineSlider(id, p.timeline);
  }

  // Karriere Timeline
  if (p.karriere && p.karriere.length) {
    h += '<div class="canvas-title">Karriere <span class="ct-badge" style="background:var(--blue)">' + p.karriere.length + ' STATIONEN</span></div>';
    h += '<div class="entity-card"><div class="entity-body"><div class="vtl">';
    for (const k of p.karriere) {
      h += '<div class="vtl-item"><div class="vtl-dot" style="background:' + (k.color || 'var(--blue)') + '"></div>';
      h += '<div class="vtl-year">' + (k.year || k.zeit || k.zeitraum || '') + '</div>';
      h += '<div class="vtl-label"><span class="ev ev-e">E</span> ' + (k.label || k.position || k.titel || '') + (k.org ? ' — ' + k.org : (k.beschreibung ? ' — ' + k.beschreibung : '')) + '</div>';
      h += '</div>';
    }
    h += '</div></div></div>';
  }

  // Wahlergebnisse
  if (p.wahlergebnisse && p.wahlergebnisse.length) {
    h += '<div class="canvas-title">Wahlergebnisse</div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<table class="matrix-table"><tr><th>Wahl</th><th>Ergebnis</th><th>Details</th><th>WB</th></tr>';
    for (const w of p.wahlergebnisse) {
      h += '<tr><td>' + (w.wahl || '') + '</td>';
      h += '<td><strong><span class="ev ev-e">E</span> ' + (w.ergebnis || '') + '</strong></td>';
      h += '<td>' + (w.details || w.kontext || '') + '</td>';
      h += '<td>' + (w.wahlbeteiligung || '') + '</td></tr>';
    }
    h += '</table></div></div>';
  }

  // Controversies
  if (p.controversies && p.controversies.length) {
    h += '<div class="canvas-title">Kontroversen <span class="ct-badge" style="background:var(--red)">' + p.controversies.length + '</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    for (const c of p.controversies) {
      const sev = c.severity === 'SCHWERWIEGEND' ? 'var(--red)' : c.severity === 'MITTEL' ? 'var(--amber)' : 'var(--muted)';
      h += '<div style="margin-bottom:10px"><span class="ev ev-' + (c.ev_tag || 'e') + '">' + (c.ev_tag || 'E').toUpperCase() + '</span> <strong style="color:' + sev + '">' + c.title + '</strong>';
      h += ' <span style="font:500 5.5pt var(--m);color:var(--green)">' + (c.conf || '') + '</span>';
      h += '<div style="font-size:7pt;color:var(--text2);margin-top:2px">' + c.text + '</div></div>';
    }
    h += '</div></div>';
  }

  // Contradictions (Widersprüche)
  if (p.contradictions && p.contradictions.length) {
    h += '<div class="canvas-title">Widersprüche <span class="ct-badge" style="background:var(--amber)">' + p.contradictions.length + ' VERIFIZIERT</span></div>';
    for (const w of p.contradictions) {
      const typeColors = {sagen_vs_tun:'var(--red)',frueher_vs_jetzt:'var(--amber)',selbstbild_vs_verhalten:'var(--purple)',selbstbild_vs_fremdbild:'var(--blue)'};
      const tc = typeColors[w.type] || 'var(--muted)';
      h += '<div class="entity-card" style="margin-bottom:8px;border-left:3px solid ' + tc + '">';
      h += '<div class="entity-body">';
      h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">';
      h += '<div style="font:600 8pt var(--f);color:var(--text)">' + w.title + '</div>';
      h += '<div style="font:600 5.5pt var(--m);color:' + tc + ';background:' + tc + '15;padding:2px 6px;border-radius:2px">' + w.typeLabel + '</div>';
      h += '</div>';
      // SAID
      h += '<div style="background:var(--surface2);border-radius:3px;padding:8px;margin-bottom:6px">';
      h += '<div style="font:600 5.5pt var(--m);color:var(--muted);text-transform:uppercase"><span class="ev ev-e">E</span> Gesagt</div>';
      h += '<div style="font:italic 7pt var(--f);color:var(--text);line-height:1.5">"' + w.said.text + '"</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted);margin-top:4px">' + w.said.source + ' · ' + w.said.date + '</div>';
      h += '</div>';
      // REALITY
      h += '<div style="background:rgba(192,57,43,0.04);border-radius:3px;padding:8px;margin-bottom:6px">';
      h += '<div style="font:600 5.5pt var(--m);color:var(--red);text-transform:uppercase"><span class="ev ev-e">E</span> Realität</div>';
      h += '<div style="font:400 7pt var(--f);color:var(--text);line-height:1.5">' + w.reality.text + '</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted);margin-top:4px">' + w.reality.source + ' · ' + w.reality.date + '</div>';
      h += '</div>';
      // Analysis + Confidence
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);line-height:1.5;border-top:1px solid var(--border);padding-top:6px"><span class="ev ev-j">J</span> ' + w.analysis + '</div>';
      h += '<div style="display:flex;justify-content:space-between;margin-top:6px">';
      h += '<div style="font:500 5.5pt var(--m);color:var(--muted)">Schärfe: ' + '\u2B1B'.repeat(w.severity) + '\u2B1C'.repeat(5 - w.severity) + '</div>';
      h += '<div style="font:500 5.5pt var(--m);color:var(--green)">Confidence: ' + w.conf + '%</div>';
      h += '</div></div></div>';
    }
  }

  // Zitate
  if (p.zitate && p.zitate.length) {
    h += '<div class="canvas-title">Zitate <span class="ct-badge" style="background:var(--blue)">' + p.zitate.length + '</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    for (const z of p.zitate) {
      h += '<div style="border-left:2px solid var(--accent);padding-left:10px;margin-bottom:10px">';
      h += '<div style="font:italic 7.5pt var(--f);color:var(--text);line-height:1.5"><span class="ev ev-e">E</span> "' + z.text + '"</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted);margin-top:2px">' + (z.quelle || z.source || '') + (z.datum ? ' · ' + z.datum : '') + '</div>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Connections
  if (p.connections && p.connections.length) {
    h += '<div class="canvas-title">Connections</div>';
    h += '<div class="entity-card"><div class="entity-body">';
    for (const c of p.connections) {
      const typeColor = c.type === 'opponent' ? 'var(--red)' : c.type === 'ally' ? 'var(--green)' : 'var(--blue)';
      h += '<div class="conn-row">';
      h += '<span class="conn-type" style="background:' + typeColor + '15;color:' + typeColor + '">' + (c.type || '').toUpperCase() + '</span>';
      h += '<span class="conn-target"><strong>' + c.target + '</strong> — ' + (c.label || '') + '</span>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Entity-level News
  const entityNews = NEWS.filter(n => n.entities && n.entities.includes(id));
  if (entityNews.length) {
    h += '<div class="canvas-title">Aktuelle Nachrichten <span class="ct-badge" style="background:var(--accent)">' + entityNews.length + '</span></div>';
    for (const n of entityNews) {
      const nSent = n.sentiment || 0;
      const sentColor = nSent < -0.5 ? 'var(--red)' : nSent < -0.2 ? 'var(--amber)' : nSent > 0.3 ? 'var(--green)' : 'var(--muted)';
      const sentLabel = nSent < -0.5 ? 'NEG' : nSent < -0.2 ? 'MIX' : nSent > 0.3 ? 'POS' : 'NEU';
      h += '<div class="nf-card"><div class="nf-card-header"><div class="nf-card-title">' + n.title + '</div>';
      h += '<span style="font:400 5.5pt var(--m);color:' + sentColor + ';background:' + sentColor + '15;padding:2px 5px;border-radius:2px;flex-shrink:0;margin-left:6px">' + sentLabel + '</span>';
      h += '<div class="nf-card-source">' + n.source + ' · ' + n.date + '</div></div>';
      h += '<div class="nf-card-body"><span class="ev ev-e">E</span> ' + (n.body || '') + '</div>';
      if (n.impact) h += '<div style="font:400 6pt var(--m);color:var(--red);margin-top:3px">▸ ' + n.impact + '</div>';
      h += '</div>';
    }
  }

  // Entity-level Sentiment
  if (SENTIMENT.entities && SENTIMENT.entities[id]) {
    const s = SENTIMENT.entities[id];
    h += '<div class="canvas-title">Stimmung</div>';
    h += '<div class="entity-card"><div class="entity-body">';
    h += '<div style="display:flex;gap:20px;align-items:center">';
    const sColor = s.sent > 0 ? 'var(--green)' : s.sent < 0 ? 'var(--red)' : 'var(--muted)';
    h += '<div><div style="font:700 20pt var(--m);color:' + sColor + '"><span class="ev ev-i">I</span> ' + (s.sent > 0 ? '+' : '') + s.sent + '</div>';
    h += '<div style="font:400 6pt var(--m);color:var(--muted)">SENTIMENT (30d)</div></div>';
    h += '<div><div style="font:700 14pt var(--m);color:var(--text)"><span class="ev ev-e">E</span> ' + (s.mentions || 0) + '</div>';
    h += '<div style="font:400 6pt var(--m);color:var(--muted)">ERWÄHNUNGEN</div></div>';
    h += '<div><div style="font:500 10pt var(--m);color:' + (s.trend === 'steigend' ? 'var(--green)' : 'var(--red)') + '"><span class="ev ev-i">I</span> ' + ((s.delta || 0) > 0 ? '+' : '') + (s.delta || 0) + '</div>';
    h += '<div style="font:400 6pt var(--m);color:var(--muted)">TREND: ' + (s.trend || '') + '</div></div>';
    h += '</div>';
    // Sentiment bar
    h += '<div style="height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin:8px 0"><div style="height:100%;width:' + Math.min(100, Math.abs(s.sent) + 20) + '%;background:' + sColor + ';border-radius:3px"></div></div>';
    // Top themes
    if (s.topThemes && s.topThemes.length) {
      h += '<div style="font:400 6.5pt var(--m);color:var(--muted)">Top-Themen: ';
      for (const t of s.topThemes) h += '<span style="background:var(--surface2);padding:1px 5px;border-radius:2px;margin-right:3px">' + t + '</span>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Quellen
  if (p.quellen && p.quellen.length) {
    h += '<div class="canvas-title">Quellenverzeichnis <span class="ct-badge" style="background:var(--green)">' + p.quellen.length + ' VERIFIZIERT</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    for (const q of p.quellen) {
      h += '<div style="margin-bottom:6px;font-size:7pt">';
      if (q.url) h += '<a href="' + q.url + '" target="_blank" class="entity-link">' + q.name + '</a>';
      else h += q.name;
      if (q.typ) h += ' <span style="font:400 5pt var(--m);color:var(--muted)">' + q.typ + '</span>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Cross-Patterns for this entity
  if (PATTERNS.length > 0) {
    const entityPatterns = PATTERNS.filter(cp => cp.entities && cp.entities.includes(id));
    if (entityPatterns.length > 0) {
      h += '<div class="canvas-title">Cross-Merkmale <span class="ct-badge" style="background:var(--accent)">' + entityPatterns.length + ' PATTERNS</span></div>';
      h += '<div class="entity-card"><div class="entity-body">';
      for (const cp of entityPatterns) {
        const others = (cp.entities || []).filter(e => e !== id);
        h += '<div style="padding:8px 0;border-bottom:1px solid var(--border)">';
        h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">';
        h += '<span style="font:600 8pt var(--f);color:var(--text)"><span class="ev ev-i">I</span> ' + cp.label + '</span>';
        h += '<span class="insight-conf" style="background:var(--accent)15;color:var(--accent)">' + (cp.confidence || 50) + '%</span>';
        h += '</div>';
        h += '<div style="font:400 7pt var(--f);color:var(--text2);line-height:1.4;margin-bottom:4px">' + cp.meaning + '</div>';
        if (others.length > 0) {
          h += '<div style="display:flex;gap:4px;flex-wrap:wrap"><span style="font:400 5.5pt var(--m);color:var(--muted)">Auch bei:</span>';
          for (const oid of others) {
            const oe = KB[oid];
            if (oe) h += '<span style="font:500 5.5pt var(--m);padding:1px 5px;border-radius:2px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer" onclick="showEntity(\'' + oid + '\')">● ' + oe.name + '</span>';
          }
          h += '</div>';
        }
        h += '</div>';
      }
      h += '</div></div>';
    }
  }

  // Forecast for this entity
  if (FORECAST && FORECAST.kandidaten) {
    const fk = FORECAST.kandidaten.find(k => k.id === id);
    if (fk) {
      h += '<div class="canvas-title">Wahlprognose ' + FORECAST.wahltermin + '</div>';
      h += '<div class="entity-card"><div class="entity-body">';
      const barColor = fk.partei === 'CSU' ? '#0a4d8c' : fk.partei === 'SPD' ? '#c0392b' : fk.partei === 'Grüne' ? '#4a8c3f' : fk.partei === 'AfD' ? '#2a5298' : 'var(--muted)';
      h += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:10px">';
      h += '<div style="font:700 24pt var(--m);color:' + barColor + '"><span class="ev ev-' + fk.tag.toLowerCase() + '">' + fk.tag + '</span> ' + fk.zentral + '%</div>';
      h += '<div><div style="font:600 8pt var(--f)">Prognose ' + fk.name + '</div>';
      h += '<div style="font:400 6pt var(--m);color:var(--muted)">Spanne: ' + fk.min + '-' + fk.max + '% · Confidence: ' + fk.conf + '%</div></div>';
      h += '</div>';
      // Bar
      h += '<div style="height:20px;background:var(--surface2);border-radius:3px;overflow:hidden;position:relative;margin-bottom:8px">';
      h += '<div style="position:absolute;left:' + fk.min + '%;width:' + (fk.max - fk.min) + '%;height:100%;background:' + barColor + '30"></div>';
      h += '<div style="position:absolute;left:' + fk.zentral + '%;width:2px;height:100%;background:' + barColor + '"></div>';
      h += '<div style="position:absolute;left:50%;width:1px;height:100%;background:var(--red);opacity:0.5"></div>';
      h += '</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted);text-align:center">Rote Linie = 50% (Stichwahl-Schwelle)</div>';
      // Historical if loderer
      if (id === 'loderer' && FORECAST.historie) {
        h += '<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">';
        h += '<div style="font:600 6pt var(--m);color:var(--muted);margin-bottom:6px">HISTORISCHER TREND</div>';
        h += '<div style="display:flex;gap:10px;align-items:flex-end">';
        for (const w of FORECAST.historie.filter(h => h.wg === 1)) {
          const bH = Math.round(w.loderer * 0.6);
          h += '<div style="text-align:center"><div style="font:500 6pt var(--m);color:var(--text)"><span class="ev ev-e">E</span> ' + w.loderer + '%</div>';
          h += '<div style="width:28px;height:' + bH + 'px;background:' + (w.stichwahl ? 'var(--amber)' : '#0a4d8c') + ';border-radius:2px 2px 0 0;margin:2px auto"></div>';
          h += '<div style="font:400 5pt var(--m);color:var(--muted)">' + w.jahr + '</div></div>';
        }
        h += '</div></div>';
      }
      h += '</div></div>';
    }
  }

  // Bottom dossier link
  if (p.dossierUrl) {
    h += '<div style="text-align:center;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">';
    h += '<a href="' + p.dossierUrl + '" target="_blank" style="display:inline-flex;align-items:center;gap:6px;font:600 8pt var(--m);color:#fff;background:var(--accent);padding:8px 20px;border-radius:4px;text-decoration:none">Vollständiges Dossier: ' + p.name + ' →</a>';
    h += '</div>';
  }

  // Related navigation (keine Sackgassen)
  h += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">';
  h += '<div style="font:600 6pt var(--m);color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.08em">Weiter navigieren</div>';
  h += '<div style="display:flex;gap:6px;flex-wrap:wrap">';
  // Other entities
  for (var oid in KB) {
    if (oid !== id) {
      h += '<span style="font:500 6.5pt var(--m);padding:3px 8px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);cursor:pointer" onclick="showEntity(\'' + oid + '\')">' + KB[oid].name + '</span>';
    }
  }
  // Views
  h += '<span style="font:500 6.5pt var(--m);padding:3px 8px;border-radius:3px;background:var(--gold-bg);border:1px solid var(--accent);color:var(--accent);cursor:pointer" onclick="switchView(\'briefing\')">Briefing</span>';
  h += '<span style="font:500 6.5pt var(--m);padding:3px 8px;border-radius:3px;background:var(--blue-bg);border:1px solid var(--blue);color:var(--blue);cursor:pointer" onclick="switchView(\'graph\')">Netzwerk</span>';
  h += '<span style="font:500 6.5pt var(--m);padding:3px 8px;border-radius:3px;background:var(--green-bg);border:1px solid var(--green);color:var(--green);cursor:pointer" onclick="switchView(\'compare\')">Vergleich</span>';
  h += '<span style="font:500 6.5pt var(--m);padding:3px 8px;border-radius:3px;background:var(--purple-bg);border:1px solid var(--purple);color:var(--purple);cursor:pointer" onclick="switchView(\'strategy\')">Strategie</span>';
  h += '</div></div>';

  canvas.innerHTML = h;
}

// =====================================================
// TAB: GRAPH (d3 Force Simulation)
// =====================================================
function renderGraph() {
  const container = document.getElementById('graph-view');
  const width = container.clientWidth;
  const height = container.clientHeight;

  const colorMap = {"ally":"#2d8a4e","threat":"#c0392b","neutral":"#b45309","org_ally":"#2d8a4e","org_threat":"#c0392b","org_neutral":"#9d7f3b","institution":"#555e70","theme_hot":"#c0392b","theme":"#777"};
  const linkColorMap = {"party":"#9d7f3b","opponent":"#c0392b","ally":"#2d8a4e","network":"#2563eb","conflict":"#b45309","threat":"#c0392b"};

  const nodes = JSON.parse(JSON.stringify(GRAPH.nodes));
  nodes.forEach(n => { n.r = n.r || n.size || 12; n.group = n.group || n.type || "neutral"; n.info = n.info || n.sub || ""; });
  const links = JSON.parse(JSON.stringify(GRAPH.links));
  links.forEach(l => { l.type = l.type || "network"; l.label = l.label || ""; });

  const svg = d3.select('#graph-view').append('svg').attr('viewBox', [0, 0, width, height]);

  const simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(100))
    .force('charge', d3.forceManyBody().strength(-300))
    .force('center', d3.forceCenter(width / 2, height / 2))
    .force('collision', d3.forceCollide().radius(d => d.r + 6));

  const link = svg.append('g').selectAll('line').data(links).join('line')
    .attr('class', 'link')
    .attr('stroke', d => linkColorMap[d.type] || '#555')
    .attr('stroke-width', 1.5);

  const linkLabel = svg.append('g').selectAll('text').data(links).join('text')
    .attr('class', 'link-label')
    .text(d => d.label);

  const node = svg.append('g').selectAll('g').data(nodes).join('g')
    .call(d3.drag()
      .on('start', (e, d) => { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = e.x; d.fy = e.y; })
      .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
      .on('end', (e, d) => { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
    );

  node.append('circle')
    .attr('class', 'node-circle')
    .attr('r', d => d.r)
    .attr('fill', d => colorMap[d.group] || '#777')
    .attr('stroke', d => ['ally','threat','neutral'].includes(d.group) ? '#fff' : 'none')
    .attr('stroke-width', 2)
    .on('click', (e, d) => { if (KB[d.id]) showEntity(d.id); });

  node.append('text').attr('class', 'node-label').attr('dy', d => -d.r - 6)
    .attr('font-size', d => ['ally','threat','neutral'].includes(d.group) ? '7pt' : '6pt')
    .attr('fill', d => colorMap[d.group] || '#777').text(d => d.label);

  node.append('text').attr('class', 'node-sublabel').attr('dy', d => -d.r + 3)
    .attr('font-size', '4.5pt').text(d => d.sub);

  const tooltip = document.getElementById('graph-tooltip');
  node.on('mouseover', (e, d) => {
    tooltip.innerHTML = '<h4>' + d.label + '</h4><div style="font:400 6pt var(--m);color:var(--text2)">' + d.sub + '</div><div style="font-size:6.5pt;color:var(--text2);margin-top:4px">' + d.info + '</div>';
    tooltip.style.opacity = 1;
  }).on('mousemove', e => {
    tooltip.style.left = (e.offsetX + 14) + 'px';
    tooltip.style.top = (e.offsetY - 8) + 'px';
  }).on('mouseout', () => { tooltip.style.opacity = 0; });

  simulation.on('tick', () => {
    nodes.forEach(d => {
      d.x = Math.max(d.r + 8, Math.min(width - d.r - 8, d.x));
      d.y = Math.max(d.r + 8, Math.min(height - d.r - 8, d.y));
    });
    link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
    linkLabel.attr('x', d => (d.source.x + d.target.x) / 2).attr('y', d => (d.source.y + d.target.y) / 2 - 3);
    node.attr('transform', d => 'translate(' + d.x + ',' + d.y + ')');
  });
}

// =====================================================
// TAB: VERGLEICH (Matrix + Hypothesen)
// =====================================================
function renderCompare() {
  const el = document.getElementById('compare-view');
  let h = '';
  // Matrix section
  h += renderMatrixHTML();
  // Kontroversen-Heatmap
  h += renderHeatmapHTML();
  // Hypotheses section
  h += renderHypothesesHTML();
  el.innerHTML = h;
}

function renderHeatmapHTML() {
  var keys = Object.keys(KB);
  var h = '<div style="margin-top:24px"></div>';
  h += '<div class="canvas-title">Kontroversen-Heatmap <span class="ct-badge" style="background:var(--red)">MUSTER</span></div>';
  h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:14px">';
  for (var ki=0; ki<keys.length; ki++) {
    var k = keys[ki], e = KB[k];
    var controvs = (e.controversies || []);
    var contras = (e.contradictions || []);
    h += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">';
    h += '<div style="width:80px;font:500 7pt var(--f);color:var(--text);cursor:pointer;text-decoration:underline;text-decoration-color:var(--border)" onclick="showEntity(\'' + k + '\')">' + e.name.split(' ').pop() + '</div>';
    h += '<div style="display:flex;gap:3px;flex-wrap:wrap">';
    for (var ci=0; ci<controvs.length; ci++) {
      var c = controvs[ci];
      var bc = c.severity === 'SCHWERWIEGEND' ? 'var(--red)' : c.severity === 'MITTEL' ? 'var(--amber)' : 'var(--muted)';
      h += '<div style="width:18px;height:18px;border-radius:2px;background:' + bc + ';cursor:pointer;opacity:0.8;transition:opacity .15s" title="' + (c.title||'').replace(/"/g,'&quot;') + ' — ' + (c.severity||'') + '" onclick="showEntity(\'' + k + '\')" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.8"></div>';
    }
    for (var wi=0; wi<contras.length; wi++) {
      var w = contras[wi];
      h += '<div style="width:18px;height:18px;border-radius:2px;background:var(--purple);cursor:pointer;opacity:0.8;transition:opacity .15s" title="Widerspruch: ' + (w.title||'').replace(/"/g,'&quot;') + '" onclick="showEntity(\'' + k + '\')" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.8"></div>';
    }
    if (controvs.length === 0 && contras.length === 0) {
      h += '<div style="width:18px;height:18px;border-radius:2px;background:var(--border);opacity:0.4"></div>';
    }
    h += '</div>';
    h += '<div style="font:400 5.5pt var(--m);color:var(--muted)">' + (controvs.length + contras.length) + '</div>';
    h += '</div>';
  }
  h += '<div style="display:flex;gap:12px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font:400 5.5pt var(--m);color:var(--muted)">';
  h += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:1px;background:var(--red);vertical-align:middle;margin-right:3px"></span>Schwerwiegend</span>';
  h += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:1px;background:var(--amber);vertical-align:middle;margin-right:3px"></span>Mittel</span>';
  h += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:1px;background:var(--purple);vertical-align:middle;margin-right:3px"></span>Widerspruch</span>';
  h += '<span><span style="display:inline-block;width:8px;height:8px;border-radius:1px;background:var(--border);vertical-align:middle;margin-right:3px"></span>Keine</span>';
  h += '</div></div>';
  return h;
}

function renderMatrixHTML() {
  const el = document.getElementById('matrix-view');
  const keys = Object.keys(KB);
  let h = '<div class="canvas-title">Vergleichs-Matrix <span class="ct-badge" style="background:var(--gold)">' + keys.length + ' ENTITIES</span></div>';

  h += '<table class="matrix-table"><tr><th></th>';
  for (const k of keys) h += '<th class="matrix-col-head"><div class="name">' + KB[k].name.split(' ').pop() + '</div><div class="role">' + KB[k].party + '</div></th>';
  h += '</tr>';

  // Rows
  const rows = [
    {label: 'Risk Score', fn: k => '<div class="cell-score" style="color:' + (KB[k].risk > 40 ? 'var(--red)' : KB[k].risk > 25 ? 'var(--amber)' : 'var(--green)') + '"><span class="ev ev-j">J</span> ' + KB[k].risk + '</div>'},
    {label: 'Partei', fn: k => '<span class="ev ev-e">E</span> ' + (KB[k].party || '—')},
    {label: 'Rolle', fn: k => '<span class="ev ev-e">E</span> ' + (KB[k].role || '—')},
    {label: 'Kontroversen', fn: k => '<span class="ev ev-e">E</span> ' + ((KB[k].controversies || []).length + (KB[k].contradictions || []).length)},
    {label: 'Quellen', fn: k => '<span class="ev ev-e">E</span> ' + (KB[k].quellen || []).length},
    {label: 'Karriere', fn: k => '<span class="ev ev-e">E</span> ' + (KB[k].karriere || []).length + ' Stationen'},
    {label: 'Sentiment', fn: k => { const s = SENTIMENT.entities[k]; return s ? '<span class="ev ev-i">I</span> ' + (s.sent > 0 ? '+' : '') + s.sent : '—'; }},
    {label: 'Trend', fn: k => { const s = SENTIMENT.entities[k]; return s ? '<span class="ev ev-i">I</span> ' + s.trend : '—'; }},
    {label: 'Prognose 1.WG', fn: k => { if (!FORECAST || !FORECAST.kandidaten) return '—'; const f = FORECAST.kandidaten.find(c => c.id === k); return f ? '<span class="ev ev-' + f.tag.toLowerCase() + '">' + f.tag + '</span> ' + f.min + '-' + f.max + '%' : '—'; }},
  ];

  for (const row of rows) {
    h += '<tr><td>' + row.label + '</td>';
    for (const k of keys) h += '<td style="text-align:center">' + row.fn(k) + '</td>';
    h += '</tr>';
  }
  h += '</table>';
  return h;
}

function renderHypothesesHTML() {
  let h = '<div style="margin-top:24px"></div>';
  h += '<div class="canvas-title">Hypothesen <span class="ct-badge" style="background:var(--accent)">' + HYPOTHESES.length + ' AKTIV</span></div>';

  for (const hyp of HYPOTHESES) {
    const conf = hyp.confidence || hyp.conf || 50;
    const confColor = conf > 70 ? 'var(--green)' : conf > 40 ? 'var(--amber)' : 'var(--red)';
    const statusClass = (hyp.status || '').toLowerCase();
    const statusColor = statusClass === 'confirmed' ? 'var(--green)' : statusClass === 'testing' ? 'var(--accent)' : 'var(--red)';

    h += '<div class="hypo-card">';
    h += '<div class="hypo-card-header"><div class="hypo-card-title">' + hyp.title + '</div>';
    h += '<div class="hypo-card-status" style="background:' + statusColor + '15;color:' + statusColor + '">' + (hyp.status || 'OPEN') + '</div></div>';
    h += '<div class="hypo-body"><span class="ev ev-a">A</span> ' + (hyp.summary || hyp.body || '') + '</div>';

    // Confidence bar
    h += '<div class="hypo-conf-bar"><div class="hypo-conf-fill" style="width:' + conf + '%;background:' + confColor + '"></div></div>';
    h += '<div class="hypo-conf-label"><span>0%</span><span><span class="ev ev-j">J</span> ' + conf + '% Wahrscheinlichkeit</span><span>100%</span></div>';

    // For evidence
    if (hyp.forEvidence && hyp.forEvidence.length) {
      h += '<div style="margin-top:10px"><div style="font:600 6pt var(--m);color:var(--green);margin-bottom:4px">DAFÜR SPRICHT</div>';
      for (const ev of hyp.forEvidence) {
        h += '<div class="hypo-ev-row"><span class="hypo-ev-icon hypo-ev-for">+</span><span class="hypo-ev-text"><span class="ev ev-e">E</span> ' + ev + '</span></div>';
      }
      h += '</div>';
    }

    // Against evidence
    if (hyp.againstEvidence && hyp.againstEvidence.length) {
      h += '<div style="margin-top:8px"><div style="font:600 6pt var(--m);color:var(--red);margin-bottom:4px">DAGEGEN SPRICHT</div>';
      for (const ev of hyp.againstEvidence) {
        h += '<div class="hypo-ev-row"><span class="hypo-ev-icon hypo-ev-against">−</span><span class="hypo-ev-text"><span class="ev ev-e">E</span> ' + ev + '</span></div>';
      }
      h += '</div>';
    }

    h += '</div>';
  }

  return h;
}

// =====================================================
// TAB: STRATEGIE (Insights + Actions + Sentiment Detail)
// =====================================================
function renderStrategy() {
  const el = document.getElementById('strategy-view');
  let h = '';

  // Cross-Patterns (from Insights)
  h += '<div class="canvas-title">Cross-Learning Intelligence <span class="ct-badge" style="background:var(--accent)">META-ANALYSE</span></div>';
  for (var pi2=0; pi2<PATTERNS.length; pi2++) {
    var pat = PATTERNS[pi2];
    var conf = pat.confidence || 50;
    var confColor = conf > 70 ? 'var(--green)' : conf > 40 ? 'var(--amber)' : 'var(--red)';
    var confLabel = conf >= 90 ? 'BEWIESEN' : conf >= 70 ? 'STARK' : conf >= 50 ? 'MESSBAR' : 'SCHWACH';
    h += '<div class="insight-card">';
    h += '<div class="insight-card-head"><div class="insight-card-title">' + pat.label + '</div>';
    h += '<span class="insight-conf" style="background:' + confColor + '15;color:' + confColor + '">' + conf + '% · ' + confLabel + '</span></div>';
    h += '<div class="insight-body"><span class="ev ev-i">I</span> ' + pat.meaning + '</div>';
    // Evidence tags
    if (pat.evidenceTags) {
      h += '<div class="insight-evidence">';
      for (var ei=0;ei<pat.evidenceTags.length;ei++) {
        var et = pat.evidenceTags[ei];
        h += '<span class="ev ev-'+et.type.toLowerCase()+'">'+et.type+'</span>';
      }
      h += '</div>';
    }
    // Entkräftet wenn
    if (pat.invalidateIf) {
      h += '<div class="insight-invalidate"><strong>Entkräftet wenn:</strong> '+pat.invalidateIf+'</div>';
    }
    // So what
    if (pat.soWhat) {
      h += '<div class="insight-so-what">→ <strong>Für Sie:</strong> '+pat.soWhat+'</div>';
    }
    // Entity pills
    if (pat.entities && pat.entities.length) {
      h += '<div class="related-wrap">';
      for (var ri=0;ri<pat.entities.length;ri++) {
        var eid = pat.entities[ri];
        var re = KB[eid];
        if (re) h += '<span class="related-pill" onclick="showEntity(\''+eid+'\')">'+re.name.split(' ').pop()+'</span>';
      }
      // Related views
      if (pat.relatedViews) {
        for (var rvi=0;rvi<pat.relatedViews.length;rvi++) {
          var rv = pat.relatedViews[rvi];
          h += '<span class="related-pill" onclick="switchView(\''+rv.view+'\')">'+rv.label+'</span>';
        }
      }
      h += '</div>';
    }
    h += '</div>';
  }

  // Actions (v21-level: evidence, linked metrics, action buttons, datenbasis)
  h += '<div style="margin-top:24px"></div>';
  h += '<div class="canvas-title">Handlungsempfehlungen <span class="ct-badge" style="background:var(--accent)">' + ACTIONS.length + ' AKTIONEN · DATENBASIERT</span></div>';
  h += '<div style="font:400 7pt var(--f);color:var(--text2);margin-bottom:12px;line-height:1.5">Empfehlungen basierend auf Dossier-Analyse, Stimmungsdaten und Wahlmuster. Priorisiert nach Impact und Dringlichkeit.</div>';
  for (var ai2=0; ai2<ACTIONS.length; ai2++) {
    var a = ACTIONS[ai2];
    var prioColor = a.priority === 'KRITISCH' ? 'var(--red)' : a.priority === 'HOCH' ? 'var(--amber)' : a.priority === 'MITTEL' ? 'var(--blue)' : 'var(--green)';
    h += '<div class="act-card" style="border-left-color:' + prioColor + '">';
    h += '<div class="act-card-priority" style="color:' + prioColor + '">' + a.priority + (a.urgency ? ' · ' + a.urgency : '') + '</div>';
    h += '<div class="act-card-title"><span class="ev ev-j">J</span> ' + a.title + '</div>';
    h += '<div class="act-card-body">' + a.body + '</div>';
    // Evidence section
    if (a.evidence) {
      h += '<div class="act-card-evidence"><span class="ev ev-e">E</span> ' + a.evidence + '</div>';
    }
    // Metrics with links
    if (a.metrics) {
      h += '<div class="act-card-metrics">';
      for (var mi=0; mi<a.metrics.length; mi++) {
        var m = a.metrics[mi];
        var mClick = '';
        if (m.link) {
          if (m.link.type==='topic') mClick = 'toggleTopic('+m.link.id+')';
          else if (m.link.type==='entity') mClick = "showEntity('"+m.link.id+"')";
          else if (m.link.type==='hypothesis') mClick = "switchView('compare')";
        }
        if (mClick) {
          h += '<div class="act-metric" style="cursor:pointer;border-radius:4px;padding:4px 6px;transition:background .15s" onmouseover="this.style.background=\'rgba(157,127,59,0.06)\'" onmouseout="this.style.background=\'\'" onclick="'+mClick+'"><div class="act-metric-val" style="color:var(--accent)">'+m.val+'</div><div class="act-metric-label" style="text-decoration:underline;color:var(--accent)">'+m.label+' →</div></div>';
        } else {
          h += '<div class="act-metric"><div class="act-metric-val">' + m.val + '</div><div class="act-metric-label">' + m.label + '</div></div>';
        }
      }
      h += '</div>';
    }
    // Action buttons
    h += '<div class="act-card-actions">';
    h += '<button class="act-btn" id="bookmark-'+ai2+'" onclick="bookmarkAction('+ai2+',this)">○ Vormerken</button>';
    h += '<button class="act-btn" onclick="exportAction('+ai2+')">↓ Export</button>';
    h += '<button class="act-btn" onclick="shareAction('+ai2+')">◈ Teilen</button>';
    h += '</div>';
    h += '</div>';
  }
  // Datenbasis
  var totalQ = 0; for (var dq in KB) totalQ += (KB[dq].quellen||[]).length;
  var totalK = 0; for (var dk in KB) totalK += (KB[dk].controversies||[]).length;
  var totalP = SENTIMENT.topics ? SENTIMENT.topics.reduce(function(s,t){return s+(t.posts||[]).length},0) : 0;
  h += '<div class="data-basis"><div class="data-basis-title">Datenbasis dieser Empfehlungen</div>';
  h += '<div class="data-basis-body">';
  h += Object.keys(KB).length+' Dossiers · '+totalK+' Kontroversen · '+totalQ+' Quellen · '+HYPOTHESES.length+' Hypothesen · '+totalP+' Stimmungsanalysen · '+NEWS.length+' News<br>';
  h += 'Quellen: SZ München, Merkur, tz München, Abgeordnetenwatch, Wikipedia, Partei-Websites<br>';
  h += 'Zeitraum: 30 Tage · Aktualisiert: '+new Date().toLocaleDateString('de-DE');
  h += '</div></div>';

  // ═══ WEEKLY BRIEF ═══
  if (WEEKLYBRIEF) {
    h += '<div style="margin-top:24px"></div>';
    h += '<div class="canvas-title">Wochenbriefing <span class="ct-badge" style="background:var(--red)">'+WEEKLYBRIEF.daysToElection+' TAGE</span></div>';
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--red);border-radius:6px;padding:14px;margin-bottom:12px">';
    h += '<div style="font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.1em">'+WEEKLYBRIEF.week+'</div>';
    h += '<div style="font:700 10pt var(--f);color:var(--text);margin:4px 0">'+WEEKLYBRIEF.headline+'</div>';
    for (var wi=0;wi<WEEKLYBRIEF.priorities.length;wi++) {
      var wp = WEEKLYBRIEF.priorities[wi];
      h += '<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">';
      h += '<div style="font:700 14pt var(--m);color:var(--accent);min-width:24px">'+wp.nr+'</div>';
      h += '<div style="flex:1"><div style="font:600 7.5pt var(--f);color:var(--text)"><span class="ev ev-'+wp.ev.toLowerCase()+'">'+wp.ev+'</span> '+wp.action+'</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);margin-top:2px">'+wp.why+'</div>';
      h += '<div style="font:500 5.5pt var(--m);color:var(--red);margin-top:2px">Deadline: '+wp.deadline+'</div>';
      h += '</div></div>';
    }
    if (WEEKLYBRIEF.watchItems && WEEKLYBRIEF.watchItems.length) {
      h += '<div style="margin-top:8px;font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.08em">Beobachten:</div>';
      for (var wii=0;wii<WEEKLYBRIEF.watchItems.length;wii++) {
        h += '<div style="font:400 6.5pt var(--f);color:var(--text2);padding:2px 0">• '+WEEKLYBRIEF.watchItems[wii]+'</div>';
      }
    }
    h += '</div>';
  }

  // ═══ TALKING POINTS ═══
  if (TALKINGPOINTS && TALKINGPOINTS.length) {
    h += '<div style="margin-top:24px"></div>';
    h += '<div class="canvas-title">Talking Points <span class="ct-badge" style="background:var(--accent)">EINSATZBEREIT</span></div>';
    h += '<div style="font:400 7pt var(--f);color:var(--text2);margin-bottom:12px;line-height:1.5">Fertige S\u00e4tze mit Quellennachweis. Kopieren, anpassen, nutzen.</div>';
    for (var ti2=0;ti2<TALKINGPOINTS.length;ti2++) {
      var tp = TALKINGPOINTS[ti2];
      h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:10px;overflow:hidden">';
      h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border)" onclick="toggleTP('+ti2+')">';
      h += '<div style="flex:1"><div style="font:600 8pt var(--f);color:var(--text)">'+tp.topic+'</div>';
      h += '<div style="font:400 6pt var(--f);color:var(--muted)">'+tp.weakness+' \u00b7 '+tp.points.length+' Talking Points</div></div>';
      h += '<div id="tp-arrow-'+ti2+'" style="font:400 8pt var(--f);color:var(--muted);transition:transform .2s">\u25bc</div>';
      h += '</div>';
      h += '<div id="tp-detail-'+ti2+'" style="display:none;padding:0 14px 12px">';
      for (var tpi=0;tpi<tp.points.length;tpi++) {
        var pt = tp.points[tpi];
        h += '<div style="padding:10px 0;border-bottom:1px solid var(--border)">';
        h += '<div style="font:400 7.5pt var(--f);color:var(--text);line-height:1.5;font-style:italic">\u201e'+pt.text+'\u201c</div>';
        h += '<div style="display:flex;gap:8px;margin-top:4px;font:400 5.5pt var(--m);color:var(--muted)">';
        h += '<span class="ev ev-'+pt.ev.toLowerCase().charAt(0)+'">'+pt.ev+'</span>';
        h += '<span>Quelle: '+pt.source+'</span>';
        h += '<span class="related-pill" style="padding:1px 5px;font-size:5pt;cursor:pointer" onclick="copyTP(this)" data-text="'+pt.text.replace(/"/g,"&quot;")+'">Kopieren</span>';
        h += '</div></div>';
      }
      h += '<div style="font:400 6pt var(--f);color:var(--muted);padding-top:6px">\ud83c\udfaf '+tp.context+'</div>';
      h += '</div></div>';
    }
  }

  // ═══ SCENARIOS ═══
  if (SCENARIOS && SCENARIOS.length) {
    h += '<div style="margin-top:24px"></div>';
    h += '<div class="canvas-title">Stichwahl-Szenarien <span class="ct-badge" style="background:var(--amber)">WAS-WENN</span></div>';
    h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">';
    for (var si2=0;si2<SCENARIOS.length;si2++) {
      var sc = SCENARIOS[si2];
      var scBorder = sc.label==='best'||sc.label==='stichwahl_win'?'var(--green)':sc.label==='worst'?'var(--red)':'var(--amber)';
      var scLabel = sc.label==='best'?'BESTES SZENARIO':sc.label==='worst'?'SCHLECHTESTES':sc.label==='stichwahl_win'?'STICHWAHL-SIEG':'WAHRSCHEINLICH';
      h += '<div style="background:var(--surface);border:1px solid var(--border);border-top:3px solid '+scBorder+';border-radius:6px;padding:12px">';
      h += '<div style="font:600 5.5pt var(--m);color:'+scBorder+';text-transform:uppercase;letter-spacing:.08em">'+scLabel+'</div>';
      h += '<div style="font:600 8pt var(--f);color:var(--text);margin:4px 0">'+sc.name+'</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2);margin-bottom:8px">'+sc.desc+'</div>';
      // Result bars
      var rKeys = Object.keys(sc.results);
      for (var ri2=0;ri2<rKeys.length;ri2++) {
        var rk = rKeys[ri2];
        if (rk==='stichwahl') continue;
        var rv = sc.results[rk];
        var rColor = rk==='schardt'?'var(--red)':rk==='loderer'?'var(--blue)':rk==='matella'?'var(--green)':rk==='afd'?'var(--red)':'var(--muted)';
        h += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px">';
        h += '<div style="width:50px;font:400 6pt var(--m);color:var(--muted);text-transform:capitalize">'+rk+'</div>';
        h += '<div style="flex:1;height:6px;background:var(--border);border-radius:3px"><div style="height:100%;border-radius:3px;background:'+rColor+';width:'+rv+'%"></div></div>';
        h += '<div style="font:600 6.5pt var(--m);color:var(--text);min-width:24px;text-align:right">'+rv+'%</div>';
        h += '</div>';
      }
      if (sc.results.stichwahl !== undefined) {
        var stColor = sc.results.stichwahl > 50 ? 'var(--red)' : sc.results.stichwahl > 30 ? 'var(--amber)' : 'var(--green)';
        h += '<div style="margin-top:6px;padding-top:6px;border-top:1px solid var(--border);font:600 7pt var(--m);color:'+stColor+'">Stichwahl: '+sc.results.stichwahl+'%</div>';
      }
      if (sc.note) h += '<div style="font:400 5.5pt var(--f);color:var(--muted);margin-top:4px">'+sc.note+'</div>';
      h += '</div>';
    }
    h += '</div>';
  }

  // Stichwahl Prediction (Red Diamond)
  if (STICHWAHL.probability) {
    var swProb = STICHWAHL.probability;
    var swColor = swProb >= 80 ? 'var(--red)' : swProb >= 50 ? 'var(--amber)' : 'var(--green)';
    var swEmoji = swProb >= 80 ? '🔴' : swProb >= 50 ? '🟡' : '🟢';
    h += '<div style="margin-top:24px"></div>';
    h += '<div class="canvas-title">Stichwahl-Prognose <span class="ct-badge" style="background:' + swColor + '">💎 PREDICTION</span></div>';
    h += '<div class="entity-card"><div class="entity-body">';
    // Big probability number
    h += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:12px">';
    h += '<div style="font:800 32pt var(--m);color:' + swColor + '">' + swProb + '%</div>';
    h += '<div><div style="font:600 9pt var(--f);color:var(--text)">Stichwahl-Wahrscheinlichkeit</div>';
    h += '<div style="font:400 7pt var(--f);color:var(--text2);margin-top:2px">' + STICHWAHL.reason + '</div></div>';
    h += '</div>';
    // Progress bar
    h += '<div style="height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:12px">';
    h += '<div style="width:' + swProb + '%;height:100%;background:' + swColor + ';border-radius:5px;transition:width 1s"></div>';
    h += '</div>';
    // Details grid
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">';
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:8px 10px">';
    h += '<div style="font:600 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.06em">Voraussichtliches Duell</div>';
    h += '<div style="font:500 7.5pt var(--f);color:var(--text);margin-top:3px">' + STICHWAHL.likely_matchup + '</div>';
    h += '</div>';
    h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:8px 10px">';
    h += '<div style="font:600 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.06em">Digitaler Vorteil</div>';
    h += '<div style="font:500 7.5pt var(--f);color:var(--accent);margin-top:3px">' + STICHWAHL.digital_advantage + '</div>';
    h += '</div>';
    h += '</div>';
    if (STICHWAHL.wildcard) {
      h += '<div style="margin-top:8px;padding:8px 10px;background:var(--surface);border:1px solid var(--border);border-left:2px solid var(--amber);border-radius:3px">';
      h += '<div style="font:600 6pt var(--m);color:var(--amber);margin-bottom:3px">⚡ WILDCARD</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--text2)">' + STICHWAHL.wildcard + '</div>';
      h += '</div>';
    }
    h += '</div></div>';
  }

  // Overview Cards (v21-style)
  if (SENTIMENT.overview) {
    h += '<div style="margin-top:24px"></div>';
    h += '<div class="canvas-title">Stimmungsbild <span class="ct-badge" style="background:var(--blue)">ÜBERSICHT</span></div>';
    h += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:16px">';
    var ovKeys = Object.keys(SENTIMENT.overview);
    for (var oi=0;oi<ovKeys.length;oi++) {
      var ov = SENTIMENT.overview[ovKeys[oi]];
      var ovc = (ov.pct||0) < 0 ? 'var(--red)' : 'var(--green)';
      h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:10px 12px">';
      h += '<div style="font:700 16pt var(--m);color:'+ovc+'">'+((ov.pct||0)>0?'+':'')+(ov.pct||0)+'%</div>';
      h += '<div style="font:500 6.5pt var(--m);color:var(--text);margin-top:2px">'+ov.label+'</div>';
      h += '<div style="font:400 5.5pt var(--m);color:var(--muted)">'+ov.n+' Beiträge · '+ov.trend+'</div>';
      h += '</div>';
    }
    h += '</div>';
  }

  // Topic Sentiment with Drill-Down
  if (SENTIMENT.topics && SENTIMENT.topics.length) {
    h += '<div class="canvas-title">Themen-Sentiment <span class="ct-badge" style="background:var(--blue)">' + SENTIMENT.topics.length + ' TOPICS · ' + SENTIMENT.topics.reduce(function(s,t){return s+(t.posts||[]).length},0) + ' POSTS</span></div>';
    for (var ti=0; ti<SENTIMENT.topics.length; ti++) {
      var t = SENTIMENT.topics[ti];
      var tpct = t.pct || t.sentiment || 0;
      var tColor = tpct < -50 ? 'var(--red)' : tpct < 0 ? 'var(--amber)' : 'var(--green)';
      var tPosts = t.posts || [];
      h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;margin-bottom:10px;overflow:hidden">';
      // Header — always visible, clickable
      h += '<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer" onclick="toggleTopic('+ti+')">';
      h += '<div style="flex:1">';
      h += '<div style="font:600 8pt var(--f);color:var(--text)">'+t.name+' <span style="font:400 6pt var(--m);color:var(--accent);text-decoration:underline">('+tPosts.length+' Beiträge →)</span></div>';
      // Bar
      h += '<div style="height:4px;background:var(--border);border-radius:2px;margin-top:4px;width:100%"><div style="height:100%;border-radius:2px;background:'+tColor+';width:'+Math.min(Math.abs(tpct),100)+'%;transition:width .4s"></div></div>';
      h += '</div>';
      h += '<div style="font:700 10pt var(--m);color:'+tColor+';min-width:40px;text-align:right"><span class="ev ev-i">I</span> '+(tpct>0?'+':'')+tpct+'%</div>';
      h += '<div id="topic-arrow-'+ti+'" style="font:400 8pt var(--f);color:var(--muted);transition:transform .2s">▼</div>';
      h += '</div>';
      // Theme chips
      if (t.topThemes && t.topThemes.length) {
        h += '<div style="display:flex;gap:3px;flex-wrap:wrap;padding:0 14px 6px">';
        for (var ci=0;ci<t.topThemes.length;ci++) h += '<span style="font:400 5.5pt var(--m);padding:2px 5px;background:var(--surface2);border-radius:2px;color:var(--text2)">'+t.topThemes[ci]+'</span>';
        h += '</div>';
      }
      // Drill-Down — hidden by default
      h += '<div id="topic-detail-'+ti+'" style="display:none;border-top:1px solid var(--border)">';
      // Sort controls
      h += '<div style="display:flex;gap:6px;padding:8px 14px;flex-wrap:wrap;align-items:center">';
      h += '<span style="font:500 6pt var(--m);color:var(--muted);text-transform:uppercase;letter-spacing:.08em">Sortieren:</span>';
      var sorts = [["date","Datum"],["sentiment","Sentiment"],["source","Quelle"]];
      for (var si=0;si<sorts.length;si++) {
        h += '<button onclick="sortTopic('+ti+',\''+sorts[si][0]+'\')" style="font:500 6pt var(--m);padding:3px 8px;border-radius:3px;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted)">'+sorts[si][1]+'</button>';
      }
      h += '</div>';
      // Posts
      h += '<div id="topic-posts-'+ti+'" style="padding:0 14px 10px">';
      for (var pi=0;pi<tPosts.length;pi++) {
        var p = tPosts[pi];
        var pc = (p.sent||0) > 0.3 ? 'var(--green)' : (p.sent||0) < -0.5 ? 'var(--red)' : (p.sent||0) < -0.2 ? 'var(--amber)' : 'var(--muted)';
        var pl = (p.sent||0) > 0.3 ? 'POS' : (p.sent||0) < -0.5 ? 'NEG' : (p.sent||0) < -0.2 ? 'MIX' : 'NEU';
        h += '<div style="padding:6px 0;border-bottom:1px solid var(--border)">';
        h += '<div style="display:flex;align-items:flex-start;gap:6px">';
        h += '<span style="font:400 5.5pt var(--m);color:var(--muted);min-width:16px">'+(pi+1)+'.</span>';
        h += '<div style="flex:1">';
        h += '<div style="font:400 7pt var(--f);color:var(--text);line-height:1.4">"'+p.text+'"</div>';
        h += '<div style="display:flex;gap:8px;margin-top:3px;font:400 5.5pt var(--m);color:var(--muted)">';
        h += '<span style="color:'+pc+';font-weight:600">'+pl+'</span>';
        h += '<span>'+p.src+'</span>';
        h += '<span>'+(p.date||'')+'</span>';
        if (p.cat) h += '<span style="padding:1px 4px;background:var(--surface2);border-radius:2px">'+p.cat+'</span>';
        h += '</div></div></div></div>';
      }
      h += '</div></div></div>';
    }
  }

  el.innerHTML = h;
}

// =====================================================
// REMOVED TABS (absorbed into Briefing/Vergleich/Strategie)
// renderNewsFeed, renderSentiment, renderInsights, renderActions, renderAlerts
// =====================================================
// CHAT
// =====================================================
function buildChat() {
  var msgs = document.getElementById('chat-messages');
  msgs.innerHTML = '<div class="chat-msg"><div class="chat-msg-header"><div class="chat-avatar mia" style="background:var(--green)">✓</div><div class="chat-name">Ainary Support</div></div>' +
    '<div class="chat-body">Haben Sie Fragen zu den Daten, wünschen ein Update oder benötigen eine Anpassung? Schreiben Sie uns direkt — wir antworten innerhalb von 24h.</div></div>';

  var chips = document.getElementById('chat-chips');
  chips.innerHTML = '<span class="chat-chip" onclick="askChat(\'Daten aktualisieren\')">Daten aktualisieren</span>' +
    '<span class="chat-chip" onclick="askChat(\'Neuen Akteur hinzufügen\')">Neuen Akteur hinzufügen</span>' +
    '<span class="chat-chip" onclick="askChat(\'Frage zu einer Quelle\')">Frage zu einer Quelle</span>' +
    '<span class="chat-chip" onclick="askChat(\'Sonstiges\')">Sonstiges</span>';
}

function toggleChat() {
  document.getElementById('chat-overlay').classList.toggle('open');
}

function askChat(q) {
  document.getElementById('chat-input').value = q + ': ';
  document.getElementById('chat-input').focus();
}

function sendChat() {
  var input = document.getElementById('chat-input');
  var q = input.value.trim();
  if (!q) return;

  // Open contact page with pre-filled message
  var msg = encodeURIComponent(q);
  var name = encodeURIComponent(USER.name || '');
  var topic = encodeURIComponent('Kampagnen-Intelligence: ' + (TENANT.name || ''));
  var url = 'https://ainaryventures.com/contact.html?topic=' + topic + '&name=' + name + '&message=' + msg;
  
  var msgs = document.getElementById('chat-messages');
  msgs.innerHTML += '<div class="chat-msg user"><div class="chat-msg-header"><div class="chat-avatar user">U</div><div class="chat-name">' + USER.name.split(' ')[0] + '</div></div><div class="chat-body">' + q.replace(/</g,'&lt;') + '</div></div>';
  msgs.innerHTML += '<div class="chat-msg"><div class="chat-msg-header"><div class="chat-avatar mia" style="background:var(--green)">✓</div><div class="chat-name">Ainary Support</div></div><div class="chat-body">Ich leite Sie zum Kontaktformular weiter. Ihre Nachricht ist schon eingetragen.<br><br><a href="' + url + '" target="_blank" style="display:inline-block;margin-top:6px;font:600 6.5pt var(--m);padding:6px 14px;background:var(--accent);color:#fff;border-radius:3px;text-decoration:none">Kontaktformular öffnen →</a><br><br><span style="font:400 5.5pt var(--f);color:var(--muted)">Oder direkt: florian@ainaryventures.com</span></div></div>';
  msgs.scrollTop = msgs.scrollHeight;
  input.value = '';
  
  // Track
  if (typeof _aiTrack === 'function') _aiTrack('support_contact_form', { message: q.substring(0,200) });
}

// =====================================================
// SEARCH
// =====================================================
document.getElementById('search-input').addEventListener('input', function() {
  const q = this.value.toLowerCase().trim();
  const results = document.getElementById('search-results');
  if (q.length < 2) { results.classList.remove('open'); return; }

  let html = '';
  for (const k of Object.keys(KB)) {
    const e = KB[k];
    if (e.name.toLowerCase().includes(q) || (e.summary || '').toLowerCase().includes(q)) {
      html += '<div class="sr-item" onclick="showEntity(\'' + k + '\');document.getElementById(\'search-results\').classList.remove(\'open\');document.getElementById(\'search-input\').value=\'\';">';
      html += '<div class="sr-item-dot" style="background:' + e.color + '"></div>';
      html += '<div><div class="sr-item-title">' + e.name + '</div><div class="sr-item-sub">' + e.role + '</div></div></div>';
    }
  }
  results.innerHTML = html || '<div style="padding:12px;font-size:7pt;color:var(--muted)">Keine Ergebnisse</div>';
  results.classList.add('open');
});

// =====================================================
// STATUS BAR
// =====================================================
function buildStatusBar() {
  document.getElementById('status-left').innerHTML = Object.keys(KB).length + ' Entities · ' + NEWS.length + ' News · ' + HYPOTHESES.length + ' Hypothesen · ' + PATTERNS.length + ' Patterns';
  document.getElementById('status-right').innerHTML = TENANT.name + ' · v22';

// =====================================================
// ANALYTICS TAB (admin only: ?admin in URL)
// =====================================================
if (location.search.includes('admin')) {
  document.getElementById('analytics-tab').style.display = '';
}

function renderAnalytics() {
  var el = document.getElementById('analytics-view');
  el.innerHTML = '<div style="padding:20px;font:400 7pt var(--f);color:var(--muted)">Lade Analytics...</div>';
  
  var endpoint = _aiEndpoint ? _aiEndpoint.replace('/track','/track') : 'https://ainaryventures.com/api/track';
  fetch(endpoint + '?key=ainary2026&format=raw')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var events = data.events || [];
      // Group by session
      var sessions = {};
      for (var i=0; i<events.length; i++) {
        var ev = events[i];
        var sid = ev.s || 'unknown';
        if (!sessions[sid]) sessions[sid] = { events: [], user: ev.u, start: ev.ts, ip: ev.ip, ua: ev.ua };
        sessions[sid].events.push(ev);
      }
      
      var h = '<div style="max-width:900px;margin:0 auto;padding:20px 0">';
      h += '<div style="font:600 10pt var(--m);color:var(--text);margin-bottom:4px">ANALYTICS</div>';
      h += '<div style="font:400 6.5pt var(--f);color:var(--muted);margin-bottom:20px">'+events.length+' Events · '+Object.keys(sessions).length+' Sessions · Live-Daten</div>';
      
      // Session cards
      var sKeys = Object.keys(sessions).sort(function(a,b) { return sessions[b].start - sessions[a].start; });
      for (var si=0; si<sKeys.length; si++) {
        var s = sessions[sKeys[si]];
        var evts = s.events;
        if (evts.length <= 1 && evts[0] && evts[0].e === 'test') continue; // skip test
        
        // Compute stats
        var tabs = {};
        var entities = [];
        var copies = 0;
        var newsClicks = [];
        var supportMsgs = [];
        var duration = 0;
        var authEvt = null;
        var scrollMax = {};
        
        for (var j=0; j<evts.length; j++) {
          var e = evts[j];
          if (e.e === 'auth') authEvt = e;
          if (e.e === 'tab_enter') tabs[e.d.tab] = (tabs[e.d.tab]||0) + 1;
          if (e.e === 'tab_leave') {
            if (!scrollMax[e.d.tab] || e.d.scroll_max > scrollMax[e.d.tab]) scrollMax[e.d.tab] = e.d.scroll_max;
          }
          if (e.e === 'entity_view') entities.push(e.d.name || e.d.entity);
          if (e.e === 'copy_talking_point') copies++;
          if (e.e === 'news_detail') newsClicks.push(e.d.title);
          if (e.e === 'support_message') supportMsgs.push(e.d.text);
          if (e.e === 'session_end') duration = e.d.duration_ms;
        }
        
        if (!duration && evts.length > 1) duration = evts[evts.length-1].ts - evts[0].ts;
        var durStr = duration > 0 ? (duration > 60000 ? Math.round(duration/60000)+'m '+Math.round((duration%60000)/1000)+'s' : Math.round(duration/1000)+'s') : 'aktiv';
        
        // Device from UA
        var device = 'Unbekannt';
        if (s.ua) {
          if (s.ua.includes('iPhone')) device = '📱 iPhone';
          else if (s.ua.includes('iPad')) device = '📱 iPad';
          else if (s.ua.includes('Android')) device = '📱 Android';
          else if (s.ua.includes('Macintosh')) device = '💻 Mac';
          else if (s.ua.includes('Windows')) device = '💻 Windows';
          else if (s.ua.includes('Linux')) device = '💻 Linux';
        }
        
        // Screen from auth event
        var screen = authEvt && authEvt.d.screen ? authEvt.d.screen : '';
        
        h += '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:16px;margin-bottom:12px">';
        
        // Header
        h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
        h += '<div><div style="font:600 8pt var(--m);color:var(--text)">'+(s.user||'Unbekannt')+'</div>';
        h += '<div style="font:400 6pt var(--m);color:var(--muted)">'+device+(screen?' · '+screen:'')+' · IP: '+(s.ip||'?')+'</div></div>';
        h += '<div style="text-align:right"><div style="font:600 8pt var(--m);color:var(--accent)">'+durStr+'</div>';
        h += '<div style="font:400 6pt var(--m);color:var(--muted)">'+new Date(s.start).toLocaleString('de-DE')+'</div></div>';
        h += '</div>';
        
        // KPI row
        h += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px">';
        var kpis = [
          ['Events', evts.length, 'var(--text)'],
          ['Tabs', Object.keys(tabs).length+'/5', 'var(--blue)'],
          ['Entities', entities.length, 'var(--accent)'],
          ['TP kopiert', copies, copies>0?'var(--green)':'var(--muted)'],
          ['News', newsClicks.length, 'var(--text)']
        ];
        for (var ki=0; ki<kpis.length; ki++) {
          h += '<div style="text-align:center;padding:8px;background:var(--bg);border-radius:4px">';
          h += '<div style="font:700 10pt var(--m);color:'+kpis[ki][2]+'">'+kpis[ki][1]+'</div>';
          h += '<div style="font:400 5pt var(--m);color:var(--muted);margin-top:2px">'+kpis[ki][0]+'</div></div>';
        }
        h += '</div>';
        
        // Tab journey (visual)
        h += '<div style="margin-bottom:12px"><div style="font:600 6pt var(--m);color:var(--text2);margin-bottom:6px;letter-spacing:.08em">TAB-JOURNEY</div>';
        h += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
        var tabNames = {briefing:'Briefing',entity:'Dossier',graph:'Netzwerk',compare:'Vergleich',strategy:'Strategie'};
        for (var j2=0; j2<evts.length; j2++) {
          if (evts[j2].e === 'tab_enter') {
            var tn = tabNames[evts[j2].d.tab] || evts[j2].d.tab;
            var tc = evts[j2].d.tab === 'strategy' ? 'var(--accent)' : 'var(--muted)';
            h += '<span style="font:500 5.5pt var(--m);padding:2px 6px;border-radius:2px;background:'+tc+'15;color:'+tc+'">'+tn+'</span>';
            h += '<span style="color:var(--muted);font-size:5pt">→</span>';
          }
          if (evts[j2].e === 'entity_view') {
            h += '<span style="font:500 5.5pt var(--m);padding:2px 6px;border-radius:2px;background:var(--accent)15;color:var(--accent)">'+(evts[j2].d.name||evts[j2].d.entity)+'</span>';
            h += '<span style="color:var(--muted);font-size:5pt">→</span>';
          }
        }
        h += '</div></div>';
        
        // Scroll depth per tab
        if (Object.keys(scrollMax).length > 0) {
          h += '<div style="margin-bottom:12px"><div style="font:600 6pt var(--m);color:var(--text2);margin-bottom:6px;letter-spacing:.08em">SCROLL-TIEFE</div>';
          h += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
          for (var st in scrollMax) {
            var sp = scrollMax[st] || 0;
            var sc = sp > 75 ? 'var(--green)' : sp > 40 ? 'var(--amber)' : 'var(--red)';
            h += '<div style="text-align:center"><div style="width:40px;height:40px;border-radius:50%;border:3px solid '+sc+';display:flex;align-items:center;justify-content:center;font:700 7pt var(--m);color:'+sc+'">'+sp+'%</div>';
            h += '<div style="font:400 5pt var(--m);color:var(--muted);margin-top:2px">'+(tabNames[st]||st)+'</div></div>';
          }
          h += '</div></div>';
        }
        
        // Entities viewed
        if (entities.length > 0) {
          h += '<div style="margin-bottom:12px"><div style="font:600 6pt var(--m);color:var(--text2);margin-bottom:4px;letter-spacing:.08em">ENTITIES ANGESEHEN</div>';
          h += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
          var uniqEnt = entities.filter(function(v,i,a){return a.indexOf(v)===i;});
          for (var ei=0; ei<uniqEnt.length; ei++) {
            var cnt = entities.filter(function(x){return x===uniqEnt[ei]}).length;
            h += '<span style="font:500 6pt var(--m);padding:2px 8px;border-radius:2px;background:var(--accent)15;color:var(--accent)">'+uniqEnt[ei]+' ×'+cnt+'</span>';
          }
          h += '</div></div>';
        }
        
        // Talking points copied
        if (copies > 0) {
          h += '<div style="margin-bottom:12px"><div style="font:600 6pt var(--m);color:var(--green);letter-spacing:.08em">✓ '+copies+' TALKING POINTS KOPIERT</div>';
          for (var j3=0; j3<evts.length; j3++) {
            if (evts[j3].e === 'copy_talking_point') {
              h += '<div style="font:400 6pt var(--f);color:var(--text2);padding:4px 0;border-bottom:1px solid var(--border)">"'+(evts[j3].d.text||'').substring(0,80)+'..."</div>';
            }
          }
          h += '</div>';
        }
        
        // Support messages
        if (supportMsgs.length > 0) {
          h += '<div style="margin-bottom:12px"><div style="font:600 6pt var(--m);color:var(--blue);letter-spacing:.08em">SUPPORT-NACHRICHTEN</div>';
          for (var sm=0; sm<supportMsgs.length; sm++) {
            h += '<div style="font:400 6pt var(--f);color:var(--text);padding:6px;background:var(--bg);border-radius:4px;margin-top:4px">"'+supportMsgs[sm]+'"</div>';
          }
          h += '</div>';
        }
        
        // Event timeline (collapsed by default)
        h += '<details style="margin-top:8px"><summary style="font:500 6pt var(--m);color:var(--muted);cursor:pointer;letter-spacing:.06em">ALLE '+evts.length+' EVENTS</summary>';
        h += '<div style="margin-top:6px;max-height:300px;overflow-y:auto">';
        for (var j4=0; j4<evts.length; j4++) {
          var ev2 = evts[j4];
          var time = new Date(ev2.ts).toLocaleTimeString('de-DE');
          h += '<div style="font:400 5.5pt var(--m);color:var(--text2);padding:3px 0;border-bottom:1px solid var(--border);display:flex;gap:8px">';
          h += '<span style="color:var(--muted);min-width:50px">'+time+'</span>';
          h += '<span style="font-weight:600;min-width:80px">'+ev2.e+'</span>';
          h += '<span style="color:var(--muted)">'+JSON.stringify(ev2.d||{}).substring(0,100)+'</span>';
          h += '</div>';
        }
        h += '</div></details>';
        
        h += '</div>'; // session card end
      }
      
      if (sKeys.length === 0 || (sKeys.length === 1 && sessions[sKeys[0]].events.length <= 1)) {
        h += '<div style="text-align:center;padding:40px;color:var(--muted);font:400 7pt var(--f)">Noch keine Besucher-Events. Warte auf den ersten Login.</div>';
      }
      
      h += '<div style="text-align:center;margin-top:16px"><button onclick="renderAnalytics()" style="font:500 6pt var(--m);padding:6px 16px;background:var(--surface);border:1px solid var(--border);border-radius:4px;cursor:pointer;color:var(--text)">↻ Aktualisieren</button></div>';
      h += '</div>';
      el.innerHTML = h;
    })
    .catch(function(err) {
      el.innerHTML = '<div style="padding:20px;color:var(--red);font:400 7pt var(--f)">Fehler: '+err.message+'</div>';
    });
}

// =====================================================
// ANALYTICS — Deep Event Tracking
// =====================================================
var _aiq = []; // analytics queue
var _ais = Date.now(); // session start
var _ait = null; // current tab timer
var _aiTabStart = 0;
var _aiCurrentTab = 'briefing';
var _aiScrollMax = {};
var _aiEndpoint = null; // set via TENANT.analyticsEndpoint or fallback

// Detect endpoint
try { _aiEndpoint = TENANT.analyticsEndpoint || 'https://ainaryventures.com/api/track'; } catch(e){}

function _aiTrack(evt, data) {
  // Resolve identity: token > USER.name > unknown
  var token = '';
  try { token = sessionStorage.getItem('ai-token') || ''; } catch(e){}
  var identity = token === 'admin' ? 'Admin (Florian Z.)' : (USER||{}).name || 'unknown';
  
  var payload = {
    e: evt,
    t: Date.now(),
    s: _ais,
    u: identity,
    tk: token, // token for reliable identification
    tn: (TENANT||{}).name || 'unknown',
    d: data || {}
  };
  _aiq.push(payload);
  try { localStorage.setItem('_ai_events', JSON.stringify(_aiq)); } catch(e){}
  // Send to endpoint if available
  if (_aiEndpoint) {
    try { navigator.sendBeacon(_aiEndpoint, JSON.stringify(payload)); } catch(e){}
  }
}

// Track auth (password or token)
(function(){
  var token = '';
  try { token = sessionStorage.getItem('ai-token') || ''; } catch(e){}
  if (token) {
    // Token-based login — track immediately
    _aiTrack('auth', { method: token === 'admin' ? 'admin' : 'token', token: token, ua: navigator.userAgent, screen: screen.width+'x'+screen.height, lang: navigator.language, ref: document.referrer });
  }
})();

var _origCheckAuth = checkAuth;
checkAuth = function() {
  var pw = document.getElementById('auth-input').value.toLowerCase().trim();
  _origCheckAuth();
  setTimeout(function(){
    if (document.getElementById('auth-gate').style.display === 'none') {
      _aiTrack('auth', { method: 'password', ua: navigator.userAgent, screen: screen.width+'x'+screen.height, lang: navigator.language, ref: document.referrer });
    }
  }, 100);
};

// Track tab switches
var _origSwitchView = switchView;
switchView = function(view) {
  // End timer on previous tab
  if (_aiCurrentTab && _aiTabStart) {
    _aiTrack('tab_leave', { tab: _aiCurrentTab, duration_ms: Date.now() - _aiTabStart, scroll_max: _aiScrollMax[_aiCurrentTab] || 0 });
  }
  _aiCurrentTab = view;
  _aiTabStart = Date.now();
  _origSwitchView(view);
  _aiTrack('tab_enter', { tab: view });
};

// Track entity views
var _origShowEntity = showEntity;
showEntity = function(id, el) {
  _aiTrack('entity_view', { entity: id, name: (KB[id]||{}).name, from_tab: _aiCurrentTab });
  _origShowEntity(id, el);
};

// Track news detail
var _origShowNewsDetail = showNewsDetail;
showNewsDetail = function(idx) {
  var n = NEWS[idx] || {};
  _aiTrack('news_detail', { idx: idx, title: (n.title||'').substring(0,60), source: n.source });
  _origShowNewsDetail(idx);
};

// Track org detail
var _origShowOrgDetail = showOrgDetail;
showOrgDetail = function(party) {
  _aiTrack('org_detail', { party: party });
  _origShowOrgDetail(party);
};

// Track talking point copies
var _origCopyTP = copyTP;
copyTP = function(btn) {
  var section = btn.closest('.tp-section');
  var topic = section ? section.querySelector('.tp-topic') : null;
  var text = btn.previousElementSibling ? btn.previousElementSibling.textContent.substring(0,80) : '';
  _aiTrack('copy_talking_point', { topic: topic ? topic.textContent : '', text: text });
  _origCopyTP(btn);
};

// Track topic drilldowns
var _origToggleTopic = toggleTopic;
toggleTopic = function(idx) {
  var topic = (SENTIMENT.topics && SENTIMENT.topics[idx]) ? SENTIMENT.topics[idx].name : idx;
  _aiTrack('topic_drilldown', { idx: idx, topic: topic });
  _origToggleTopic(idx);
};

// Track support/chat
var _origToggleChat = toggleChat;
toggleChat = function() {
  _aiTrack('support_toggle', { action: document.getElementById('chat-overlay').classList.contains('open') ? 'close' : 'open' });
  _origToggleChat();
};

// Track support message send
var _origSendChat = sendChat;
sendChat = function() {
  var q = document.getElementById('chat-input').value.trim();
  if (q) _aiTrack('support_message', { text: q.substring(0,200) });
  _origSendChat();
};

// Track entity actions
var _origExportEntity = exportEntity;
exportEntity = function(id) { _aiTrack('entity_action', { action: 'export', entity: id }); _origExportEntity(id); };
var _origShareEntity = shareEntity;
shareEntity = function(id) { _aiTrack('entity_action', { action: 'share', entity: id }); _origShareEntity(id); };

// Track bookmark action
var _origBookmarkAction = bookmarkAction;
bookmarkAction = function(idx, btn) { _aiTrack('action_bookmark', { idx: idx }); _origBookmarkAction(idx, btn); };

// Track scroll depth per tab
window.addEventListener('scroll', function() {
  var pct = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
  if (!_aiScrollMax[_aiCurrentTab] || pct > _aiScrollMax[_aiCurrentTab]) {
    _aiScrollMax[_aiCurrentTab] = pct;
  }
}, { passive: true });

// Track session end
window.addEventListener('beforeunload', function() {
  var duration = Date.now() - _ais;
  var tabSummary = {};
  // Count tab visits from queue
  for (var i=0; i<_aiq.length; i++) {
    if (_aiq[i].e === 'tab_leave') {
      var tab = _aiq[i].d.tab;
      if (!tabSummary[tab]) tabSummary[tab] = { visits: 0, total_ms: 0, max_scroll: 0 };
      tabSummary[tab].visits++;
      tabSummary[tab].total_ms += _aiq[i].d.duration_ms || 0;
      tabSummary[tab].max_scroll = Math.max(tabSummary[tab].max_scroll, _aiq[i].d.scroll_max || 0);
    }
  }
  _aiTrack('session_end', {
    duration_ms: duration,
    total_events: _aiq.length,
    tabs: tabSummary,
    scroll_max: _aiScrollMax
  });
});

// Track visibility changes (tab hidden/visible)
document.addEventListener('visibilitychange', function() {
  _aiTrack('visibility', { state: document.visibilityState });
});

// Track link clicks on external URLs
document.addEventListener('click', function(e) {
  var a = e.target.closest('a[href^="http"]');
  if (a && a.hostname !== location.hostname) {
    _aiTrack('external_link', { url: a.href, text: (a.textContent||'').substring(0,60) });
  }
}, true);

// Console helper: type _aiReport() in browser console to see all events
window._aiReport = function() {
  var events;
  try { events = JSON.parse(localStorage.getItem('_ai_events') || '[]'); } catch(e) { events = _aiq; }
  console.table(events.map(function(e) {
    return { event: e.e, time: new Date(e.t).toLocaleTimeString(), data: JSON.stringify(e.d).substring(0,100) };
  }));
  // Summary
  var tabs = {};
  var entities = {};
  var copies = 0;
  for (var i=0; i<events.length; i++) {
    if (events[i].e === 'tab_enter') tabs[events[i].d.tab] = (tabs[events[i].d.tab]||0) + 1;
    if (events[i].e === 'entity_view') entities[events[i].d.name] = (entities[events[i].d.name]||0) + 1;
    if (events[i].e === 'copy_talking_point') copies++;
  }
  console.log('\n📊 SUMMARY:');
  console.log('Total events:', events.length);
  console.log('Session duration:', events.length > 1 ? Math.round((events[events.length-1].t - events[0].t)/1000) + 's' : 'n/a');
  console.log('Tab visits:', tabs);
  console.log('Entity views:', entities);
  console.log('Talking points copied:', copies);
  return events;
};
}

// =====================================================
// DETAIL OVERLAY
// =====================================================
function showDetail(key) {
  // Simple detail view for any object
  const overlay = document.getElementById('detail-overlay');
  const card = document.getElementById('detail-card');
  card.innerHTML = '<div class="detail-close" onclick="closeDetail()">&times;</div><div class="detail-title">' + key + '</div><div class="detail-body">Detail-Ansicht für: ' + key + '</div>';
  overlay.classList.add('open');
}

function closeDetail() {
  document.getElementById('detail-overlay').classList.remove('open');
}
</script>
<div style="position:fixed;bottom:0;left:0;right:0;height:20px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;font:400 5pt var(--m);color:var(--muted);z-index:100;gap:12px"><span>Alle Daten aus öffentlich zugänglichen Quellen</span><span>·</span><span>Keine Gewähr für Vollständigkeit oder Richtigkeit</span><span>·</span><span>Vertraulich — nur für den Empfänger bestimmt</span></div>
</body>
</html>
