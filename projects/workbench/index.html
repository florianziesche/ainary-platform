<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ainary Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--surface:#141414;--surface-2:#1a1a1a;--border:#1e1e1e;--border-light:#2a2a2a;--text:#ececec;--text-muted:#8e8e8e;--text-dim:#555;--warm:#d4a853;--danger:#c47070}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);background-image:radial-gradient(circle,rgba(212,168,83,0.04) 1px,transparent 1px);background-size:20px 20px;background-position:10px 10px;color:var(--text);-webkit-font-smoothing:antialiased;height:100vh;display:flex;overflow:hidden}

/* Left */
.left{width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.left-header{padding:20px;border-bottom:1px solid var(--border)}
.left-header h1{font-size:14px;font-weight:600}
.left-header p{font-size:10px;color:var(--text-dim);margin-top:2px}

.pipeline{border-bottom:1px solid var(--border)}
.pipe-stage{display:flex;align-items:center;padding:10px 20px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;gap:12px}
.pipe-stage:hover{background:rgba(255,255,255,0.03)}
.pipe-stage.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.pipe-icon{font-size:12px;width:20px;text-align:center;color:var(--text-dim);font-weight:700}
.pipe-info{flex:1}
.pipe-name{font-size:12px;font-weight:600;color:var(--text-muted)}
.pipe-stage.active .pipe-name{color:var(--text)}
.pipe-count{font-size:10px;color:var(--text-dim);margin-top:1px}
.pipe-bar{width:40px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.pipe-fill{height:100%;background:var(--text-dim);border-radius:2px;transition:width 0.3s}
.pipe-arrow{text-align:center;padding:2px 0;color:var(--border-light);font-size:8px}

.topic-list{flex:1;overflow-y:auto}
.topic-section-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);padding:12px 20px 6px}
.topic-item{padding:10px 20px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;display:flex;align-items:center;gap:10px}
.topic-item:hover{background:rgba(255,255,255,0.02)}
.topic-item.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.topic-dot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.topic-dot.unread{background:var(--warm)}
.topic-info{flex:1;min-width:0}
.topic-name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topic-meta{font-size:10px;color:var(--text-dim);margin-top:1px}
.topic-pct{font-size:10px;color:var(--text-dim)}

.trust-footer{padding:8px 12px;border-top:1px solid var(--border);max-height:180px;overflow-y:auto}
.trust-mini{font-size:9px;color:var(--text-dim)}
.trust-header{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);padding:0 4px 6px;display:flex;justify-content:space-between}
.trust-skill{display:flex;align-items:center;gap:6px;padding:3px 4px;font-size:10px}
.trust-skill-name{width:70px;color:var(--text-dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0}
.trust-skill-bar{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.trust-skill-fill{height:100%;border-radius:2px;transition:width 0.3s}
.trust-skill-score{width:24px;text-align:right;color:var(--text-dim);font-size:9px;flex-shrink:0}

/* Corrections in context */
.ctx-correction{padding:6px 8px;border-left:2px solid var(--danger);margin-bottom:4px;font-size:10px;line-height:1.5;background:rgba(196,112,112,0.04);border-radius:0 3px 3px 0}
.ctx-correction-rule{color:var(--text-muted)}
.ctx-correction-detail{color:var(--text-dim);margin-top:2px}
.ctx-correction-wrong{text-decoration:line-through;color:var(--danger)}
.ctx-correction-right{color:var(--warm)}
.ctx-correction-count{font-size:8px;color:var(--text-dim);margin-top:2px}
.ctx-severity{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;flex-shrink:0}
.ctx-severity.s1{background:var(--text-dim)}
.ctx-severity.s2{background:var(--warm)}
.ctx-severity.s3{background:var(--danger)}

/* Pre-flight badge */
.preflight-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:3px;font-size:9px;font-weight:600;margin-left:8px}
.preflight-badge.pass{background:rgba(74,170,136,0.1);color:#4aa088;border:1px solid rgba(74,170,136,0.2)}
.preflight-badge.warn{background:rgba(212,168,83,0.1);color:var(--warm);border:1px solid rgba(212,168,83,0.2)}
.preflight-badge.fail{background:rgba(196,112,112,0.1);color:var(--danger);border:1px solid rgba(196,112,112,0.2)}

/* Event log in context */
.ctx-event{display:flex;gap:6px;padding:4px 8px;font-size:9px;color:var(--text-dim)}
.ctx-event-time{flex-shrink:0;width:36px;color:var(--text-dim)}
.ctx-event-dot{width:4px;height:4px;border-radius:50%;background:var(--text-dim);margin-top:5px;flex-shrink:0}
.ctx-event-text{flex:1;line-height:1.4}

/* Upload area */
.ctx-upload{border:1px dashed var(--border-light);border-radius:4px;padding:12px;text-align:center;cursor:pointer;transition:all 0.15s;margin-top:4px}
.ctx-upload:hover{border-color:var(--warm);background:rgba(212,168,83,0.04)}
.ctx-upload-text{font-size:10px;color:var(--text-dim)}
.ctx-upload input[type=file]{display:none}
.ctx-add-ref{display:flex;align-items:center;gap:4px;padding:6px 8px;cursor:pointer;font-size:10px;color:var(--text-dim);transition:all 0.1s;margin-top:4px}
.ctx-add-ref:hover{color:var(--warm)}

/* Guardrails */
.guardrail{display:inline-flex;align-items:center;gap:4px;font-size:9px;padding:2px 6px;border-radius:3px;font-weight:600;letter-spacing:0.3px}
.guardrail.auto{background:rgba(80,200,120,0.1);color:#50c878}
.guardrail.review{background:rgba(212,168,83,0.1);color:var(--warm)}
.guardrail.confirm{background:rgba(196,112,112,0.1);color:var(--danger)}

/* Action Buttons */
.action-bar{display:flex;gap:6px;padding:8px 16px;border-top:1px solid var(--border);background:var(--surface)}
.action-btn{padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;border:1px solid var(--border);background:var(--surface-2);color:var(--text);font-family:inherit;transition:all 0.1s;display:flex;align-items:center;gap:5px}
.action-btn:hover{background:var(--border-light);border-color:var(--text-dim)}
.action-btn.primary{background:var(--text);color:var(--bg);border-color:var(--text)}
.action-btn.primary:hover{opacity:0.9}
.action-btn.danger{border-color:rgba(196,112,112,0.3);color:var(--danger)}
.action-btn .guardrail{margin-left:2px}

/* Command Palette */
.cmd-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:300;align-items:flex-start;justify-content:center;padding-top:20vh}
.cmd-overlay.open{display:flex}
.cmd-box{background:var(--surface);border:1px solid var(--border-light);border-radius:12px;width:560px;max-width:90vw;overflow:hidden;box-shadow:0 24px 48px rgba(0,0,0,0.4)}
.cmd-input{width:100%;background:transparent;border:none;border-bottom:1px solid var(--border);padding:16px 20px;font-size:14px;color:var(--text);font-family:inherit;outline:none}
.cmd-input::placeholder{color:var(--text-dim)}
.cmd-results{max-height:320px;overflow-y:auto}
.cmd-item{display:flex;align-items:center;gap:10px;padding:10px 20px;cursor:pointer;transition:background 0.05s}
.cmd-item:hover,.cmd-item.active{background:var(--surface-2)}
.cmd-item-icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text-dim);background:var(--surface-2);border-radius:4px;flex-shrink:0}
.cmd-item-text{flex:1}
.cmd-item-title{font-size:12px}
.cmd-item-sub{font-size:10px;color:var(--text-dim)}
.cmd-item-kbd{font-size:9px;color:var(--text-dim);padding:2px 5px;background:var(--surface-2);border-radius:3px;font-family:monospace}
.cmd-footer{display:flex;gap:12px;padding:8px 20px;border-top:1px solid var(--border);font-size:9px;color:var(--text-dim)}

/* Confirm Dialog */
.confirm-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:400;align-items:center;justify-content:center}
.confirm-overlay.open{display:flex}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;width:420px}
.confirm-box h3{font-size:14px;margin-bottom:8px}
.confirm-box p{font-size:12px;color:var(--text-muted);margin-bottom:16px;line-height:1.5}
.confirm-btns{display:flex;gap:8px;justify-content:flex-end}
.confirm-btns button{padding:8px 16px;border-radius:4px;font-size:12px;cursor:pointer;border:none;font-family:inherit}
.confirm-btns .primary{background:var(--text);color:var(--bg);font-weight:600}
.confirm-btns .secondary{background:none;border:1px solid var(--border);color:var(--text-muted)}

/* Pipeline View */
.pv{display:flex;gap:16px;height:100%;min-height:0}
.pv-col{flex:1;min-width:200px;display:flex;flex-direction:column;gap:0}
.pv-col-header{padding:12px 14px;border-radius:8px 8px 0 0;border:1px solid var(--border);border-bottom:none;display:flex;justify-content:space-between;align-items:center}
.pv-col-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px}
.pv-col-stats{font-size:9px;color:var(--text-dim);text-align:right;line-height:1.5}
.pv-col-body{flex:1;overflow-y:auto;border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;padding:8px;display:flex;flex-direction:column;gap:6px;background:rgba(255,255,255,0.01)}
.pv-card{padding:10px 12px;border-radius:6px;background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:all 0.1s}
.pv-card:hover{border-color:var(--border-light);background:var(--surface-2)}
.pv-card-name{font-size:11px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pv-card-meta{display:flex;gap:6px;align-items:center;font-size:9px;color:var(--text-dim)}
.pv-card-progress{width:40px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.pv-card-progress-fill{height:100%;border-radius:2px;background:var(--text-dim)}
.pv-card-connections{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px}
.pv-card-conn{font-size:8px;padding:1px 4px;border-radius:2px;background:rgba(255,255,255,0.04);color:var(--text-dim)}
.pv-card-findings{font-size:9px;color:var(--warm);margin-top:3px}
.pv-flow{display:flex;align-items:center;justify-content:center;width:32px;flex-shrink:0}
.pv-flow-inner{display:flex;flex-direction:column;align-items:center;gap:2px}
.pv-flow-arrow{color:var(--border-light);font-size:14px}
.pv-flow-rate{font-size:8px;font-weight:600;writing-mode:vertical-rl;text-orientation:mixed}
.pv-header{margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.pv-header h2{font-size:16px;font-weight:700}
.pv-header-stats{display:flex;gap:16px;font-size:11px;color:var(--text-muted)}
.pv-header-stat{display:flex;flex-direction:column;align-items:center}
.pv-header-stat-val{font-size:18px;font-weight:700;color:var(--text)}
.pv-header-stat-label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px}
.pv-orphan-alert{padding:8px 12px;border-radius:6px;background:rgba(196,112,112,0.06);border:1px solid rgba(196,112,112,0.15);margin-top:12px;font-size:10px;color:var(--danger)}
.pv-card.connect-source{border-color:var(--warm);box-shadow:0 0 0 1px var(--warm)}
.pv-card.connect-target:hover{border-color:#4aa088;box-shadow:0 0 0 1px #4aa088}
.pv-connect-bar{position:sticky;top:0;z-index:10;padding:10px 16px;background:var(--surface);border:1px solid var(--warm);border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--warm)}
.pv-connect-bar button{padding:4px 12px;border:1px solid var(--border);background:none;color:var(--text-dim);border-radius:4px;cursor:pointer;font-size:10px;font-family:inherit}
.pv-connect-bar button:hover{border-color:var(--text-dim);color:var(--text)}
.pv-research-lines{margin-top:12px;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--surface)}
.pv-rl-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:8px}
.pv-rl-item{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:11px}
.pv-rl-name{color:var(--text-muted)}
.pv-rl-score{font-weight:600;color:var(--warm)}

/* Findings */
.ctx-finding{padding:8px;border-left:2px solid var(--border-light);margin-bottom:6px;border-radius:0 4px 4px 0;background:rgba(255,255,255,0.015);transition:all 0.15s}
.ctx-finding:hover{background:rgba(255,255,255,0.03)}
.ctx-finding.dead{opacity:0.4;text-decoration:line-through}
.ctx-finding.contested{border-left-color:var(--warm)}
.ctx-finding-claim{font-size:11px;color:var(--text-muted);line-height:1.5}
.ctx-finding-meta{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:9px;color:var(--text-dim)}
.ctx-finding-id{font-family:monospace;font-size:9px}
.conf-badge{display:inline-block;padding:1px 5px;border-radius:2px;font-size:9px;font-weight:600}
.conf-badge.high{background:rgba(74,170,136,0.12);color:#4aa088}
.conf-badge.mid{background:rgba(212,168,83,0.12);color:var(--warm)}
.conf-badge.low{background:rgba(196,112,112,0.12);color:var(--danger)}
.compound-score{font-size:9px;font-weight:600;color:var(--warm)}
.finding-actions{display:flex;gap:4px;margin-top:4px}
.finding-btn{font-size:9px;padding:2px 6px;border:1px solid var(--border);background:none;color:var(--text-dim);border-radius:2px;cursor:pointer;font-family:inherit}
.finding-btn:hover{border-color:var(--text-dim);color:var(--text-muted)}
.ctx-finding-detail{display:none;margin-top:6px;padding:6px 0;border-top:1px solid var(--border);font-size:9px;color:var(--text-dim);line-height:1.6}
.ctx-finding.expanded .ctx-finding-detail{display:block}
.ctx-finding.expanded{background:rgba(255,255,255,0.03)}
.finding-detail-section{margin-bottom:6px}
.finding-detail-label{font-weight:600;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-dim);margin-bottom:2px}
.finding-history-item{display:flex;gap:6px;padding:2px 0}
.finding-history-item .old{text-decoration:line-through;color:var(--danger)}
.finding-history-item .new{color:#4aa088}
.finding-related-item{display:flex;gap:6px;padding:2px 0;cursor:pointer}
.finding-related-item:hover{color:var(--text-muted)}
.save-finding-btn{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border:1px solid var(--border);background:none;color:var(--text-dim);border-radius:3px;cursor:pointer;font-size:9px;font-family:inherit;margin-top:4px;transition:all 0.1s}
.save-finding-btn:hover{border-color:var(--warm);color:var(--warm)}

/* Stage Detail View */
.stage-view{display:none;flex:1;overflow:auto;padding:24px;flex-direction:column}
.stage-view.open{display:flex}
.stage-header{margin-bottom:24px}
.stage-header-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.stage-title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:12px}
.stage-icon{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;border:2px solid}
.stage-metrics{display:flex;gap:20px}
.stage-metric{text-align:center}
.stage-metric-val{font-size:24px;font-weight:700}
.stage-metric-label{font-size:9px;text-transform:uppercase;letter-spacing:0.8px;color:var(--text-dim);margin-top:2px}
.stage-controls{display:flex;gap:8px;align-items:center;margin-bottom:16px}
.stage-sort,.stage-filter{padding:6px 12px;border:1px solid var(--border);background:var(--surface-2);color:var(--text-muted);border-radius:4px;font-size:11px;font-family:inherit;cursor:pointer;transition:all 0.1s}
.stage-sort:hover,.stage-filter:hover{border-color:var(--text-dim);color:var(--text)}
.stage-sort.active,.stage-filter.active{background:var(--warm);color:var(--bg);border-color:var(--warm)}
.stage-findings{display:flex;flex-direction:column;gap:8px}
.evidence-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;letter-spacing:0.5px;display:inline-block}
.evidence-E{background:rgba(74,160,136,0.15);color:#4aa088}
.evidence-I{background:rgba(107,138,171,0.15);color:#6b8aab}
.evidence-J{background:rgba(155,142,196,0.15);color:#9b8ec4}
.evidence-A{background:rgba(212,168,83,0.15);color:#d4a853}
.evidence-none{background:rgba(255,255,255,0.05);color:var(--text-dim)}
.impact-badge{font-size:9px;font-weight:600;padding:2px 6px;border-radius:3px;letter-spacing:0.5px}
.impact-CRITICAL{background:rgba(196,112,112,0.15);color:#c47070}
.impact-HIGH{background:rgba(212,168,83,0.15);color:#d4a853}
.impact-MEDIUM{background:rgba(255,255,255,0.05);color:var(--text-muted)}
.impact-LOW{background:rgba(255,255,255,0.03);color:var(--text-dim)}
.gate-check{display:flex;align-items:center;gap:6px;font-size:10px;padding:3px 0}
.gate-pass{color:#4aa088}
.gate-fail{color:#c47070}
.gate-status{margin-top:8px;padding:8px 12px;border-radius:4px;font-size:10px}
.gate-ready{background:rgba(74,160,136,0.1);border:1px solid rgba(74,160,136,0.2)}
.gate-blocked{background:rgba(196,112,112,0.05);border:1px solid rgba(196,112,112,0.15)}
.stage-finding-card{padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:6px;cursor:pointer;transition:all 0.12s;border-left:3px solid var(--border-light)}
.stage-finding-card:hover{background:var(--surface-2);border-color:var(--border-light)}
.stage-finding-card.expanded{background:var(--surface-2);border-left-color:var(--warm)}
.stage-finding-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.stage-finding-left{flex:1;min-width:0}
.stage-finding-id{font-family:monospace;font-size:9px;color:var(--text-dim);margin-bottom:4px}
.stage-finding-claim{font-size:12px;color:var(--text);line-height:1.6;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.stage-finding-card.expanded .stage-finding-claim{-webkit-line-clamp:unset;display:block}
.stage-finding-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.stage-conf-bar{width:60px;height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.stage-conf-fill{height:100%;border-radius:2px}
.stage-finding-meta{display:flex;align-items:center;gap:6px;margin-top:6px;font-size:9px;color:var(--text-dim);flex-wrap:wrap}
.stage-tag{padding:2px 6px;border-radius:2px;background:rgba(255,255,255,0.05);border:1px solid var(--border)}
.stage-finding-detail{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);line-height:1.6}
.stage-finding-card.expanded .stage-finding-detail{display:block}
.stage-finding-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.stage-action-btn{padding:5px 12px;border:1px solid var(--border);background:none;color:var(--text-muted);border-radius:4px;font-size:10px;font-family:inherit;cursor:pointer;transition:all 0.1s}
.stage-action-btn:hover{border-color:var(--text-dim);color:var(--text)}
.stage-action-btn.primary{background:var(--warm);color:var(--bg);border-color:var(--warm)}
.stage-action-btn.danger{border-color:var(--danger);color:var(--danger)}
.stage-empty{text-align:center;padding:60px 20px;color:var(--text-dim)}
.stage-empty-icon{font-size:32px;opacity:0.15;margin-bottom:12px}
.stage-empty-text{font-size:13px;line-height:1.7}
.stage-rl-group{margin-bottom:16px}
.stage-rl-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--surface-2);border-radius:6px;cursor:pointer;margin-bottom:8px}
.stage-rl-name{font-size:12px;font-weight:600;text-transform:capitalize}
.stage-rl-count{font-size:10px;color:var(--text-dim)}
.stage-rl-body{padding-left:12px}
.stage-rl-group.collapsed .stage-rl-body{display:none}

/* Principles View */
.prin{display:flex;flex-direction:column;gap:24px;max-width:860px;margin:0 auto;width:100%}
.prin-header{display:flex;justify-content:space-between;align-items:flex-end}
.prin-header h2{font-size:20px;font-weight:700;letter-spacing:-0.3px}
.prin-header-sub{font-size:11px;color:var(--text-dim);margin-top:4px}
.prin-header-meta{text-align:right;font-size:10px;color:var(--text-dim);line-height:1.6}
.prin-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);padding-bottom:8px;border-bottom:1px solid var(--border)}
.prin-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:700px){.prin-grid{grid-template-columns:1fr}}
.prin-card{padding:16px 18px;border-radius:8px;background:var(--surface);border:1px solid var(--border);transition:all 0.15s;cursor:default;position:relative;overflow:hidden}
.prin-card:hover{border-color:var(--border-light);background:var(--surface-2)}
.prin-card-num{position:absolute;top:14px;right:16px;font-size:28px;font-weight:800;color:rgba(255,255,255,0.03);line-height:1;pointer-events:none}
.prin-card-title{font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.prin-card-title .approved{width:6px;height:6px;border-radius:50%;background:var(--warm);flex-shrink:0}
.prin-card-desc{font-size:11px;color:var(--text-muted);line-height:1.65}
.prin-card-footer{display:flex;align-items:center;gap:8px;margin-top:10px}
.prin-card-tag{font-size:9px;padding:2px 6px;border-radius:3px;background:rgba(212,168,83,0.08);color:var(--warm);border:1px solid rgba(212,168,83,0.15)}
.prin-card-conf{font-size:9px;color:var(--text-dim);font-weight:600}
.prin-card-source{font-size:9px;color:var(--text-dim);font-family:'SF Mono',Menlo,monospace}
.prin-card.full-width{grid-column:1/-1}
.prin-workflow{padding:20px;border-radius:8px;background:var(--surface);border:1px solid var(--border)}
.prin-wf-title{font-size:12px;font-weight:700;margin-bottom:16px;color:var(--text)}
.prin-wf-flow{display:flex;align-items:center;gap:0;flex-wrap:wrap;justify-content:center}
.prin-wf-node{padding:8px 14px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid var(--border);background:var(--surface-2);text-align:center;min-width:100px}
.prin-wf-node.active{border-color:var(--warm);color:var(--warm)}
.prin-wf-arrow{color:var(--text-dim);font-size:14px;padding:0 4px;flex-shrink:0}
.prin-wf-desc{font-size:10px;color:var(--text-dim);line-height:1.7;margin-top:16px}
.prin-wf-layers{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:16px}
.prin-wf-layer{padding:10px;border-radius:6px;border:1px solid var(--border);text-align:center;font-size:10px;line-height:1.5}
.prin-wf-layer-num{font-size:16px;font-weight:800;color:var(--text-dim);margin-bottom:4px}
.prin-wf-layer-name{font-weight:600;color:var(--text);margin-bottom:2px}
.prin-wf-layer-desc{color:var(--text-dim);font-size:9px}
.prin-wf-layer.l0{border-color:var(--text-dim)}
.prin-wf-layer.l1{border-color:var(--warm)}
.prin-wf-layer.l2{border-color:#6b8aab}
.prin-wf-layer.l3{border-color:#9b8ec4}

/* Finding Inline Form */
.finding-form-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:250;align-items:center;justify-content:center}
.finding-form-overlay.open{display:flex}
.finding-form{background:var(--surface);border:1px solid var(--border-light);border-radius:10px;width:480px;max-width:90vw;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,0.4)}
.finding-form-header{padding:16px 20px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.finding-form-header h3{font-size:13px;font-weight:600;color:var(--text)}
.finding-form-close{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;padding:4px 8px}
.finding-form-close:hover{color:var(--text)}
.finding-form-body{padding:16px 20px}
.finding-field{margin-bottom:14px}
.finding-field label{display:block;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:5px}
.finding-field textarea,.finding-field input,.finding-field select{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:9px 12px;font-size:12px;color:var(--text);font-family:inherit;outline:none;transition:border-color 0.15s}
.finding-field textarea:focus,.finding-field input:focus,.finding-field select:focus{border-color:var(--warm)}
.finding-field textarea{resize:vertical;min-height:60px;line-height:1.5}
.finding-field select{appearance:none;cursor:pointer}
.finding-field .hint{font-size:9px;color:var(--text-dim);margin-top:3px}
.finding-conf-row{display:flex;align-items:center;gap:12px}
.finding-conf-slider{flex:1;accent-color:var(--warm);height:3px}
.finding-conf-val{font-size:12px;font-weight:600;min-width:36px;text-align:right}
.finding-form-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.finding-form-footer .secondary{font-size:11px;color:var(--text-dim);background:none;border:none;cursor:pointer;font-family:inherit}
.finding-form-footer .primary-btn{padding:8px 20px;background:var(--text);color:var(--bg);border:none;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;transition:opacity 0.1s}
.finding-form-footer .primary-btn:hover{opacity:0.9}
.finding-form-footer .primary-btn:disabled{opacity:0.3;cursor:not-allowed}

/* New topic modal */
.new-topic-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;align-items:center;justify-content:center}
.new-topic-overlay.open{display:flex}
.new-topic-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:24px;width:400px;max-width:90vw}
.new-topic-box h3{font-size:14px;margin-bottom:16px}
.new-topic-field{display:block;width:100%;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:8px 12px;font-size:12px;color:var(--text);font-family:inherit;outline:none;margin-bottom:10px}
.new-topic-field:focus{border-color:var(--warm)}
.new-topic-row{display:flex;gap:8px;margin-bottom:10px}
.new-topic-select{flex:1;background:var(--surface-2);border:1px solid var(--border);border-radius:4px;padding:8px;font-size:11px;color:var(--text);font-family:inherit;outline:none;-webkit-appearance:none}
.new-topic-btns{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.new-topic-btns button{padding:8px 16px;border-radius:4px;font-size:12px;cursor:pointer;border:none;font-family:inherit}
.new-topic-btns .primary{background:var(--text);color:var(--bg);font-weight:600}
.new-topic-btns .secondary{background:none;border:1px solid var(--border);color:var(--text-muted)}

/* Folders */
.folder-tree{flex:1;overflow-y:auto;padding:4px 0}
.folder{user-select:none}
.folder-head{display:flex;align-items:center;padding:6px 16px 6px 12px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;gap:6px}
.folder-head:hover{background:rgba(255,255,255,0.03)}
.folder-head.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.folder-chevron{font-size:8px;color:var(--text-dim);width:12px;text-align:center;transition:transform 0.15s;flex-shrink:0}
.folder.collapsed .folder-chevron{transform:rotate(-90deg)}
.folder-icon{width:18px;height:18px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:rgba(255,255,255,0.04);flex-shrink:0}
.folder-name{font-size:11px;font-weight:600;color:var(--text-muted);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.folder-head.active .folder-name{color:var(--text)}
.folder-count{font-size:9px;color:var(--text-dim);flex-shrink:0}
.folder-children{padding-left:12px}
.folder.collapsed .folder-children{display:none}
.folder-drop-zone{min-height:2px;transition:all 0.15s}
.folder-drop-zone.over{min-height:24px;background:rgba(212,168,83,0.08);border:1px dashed rgba(212,168,83,0.3);border-radius:4px;margin:2px 12px}
.folder-actions{display:none;gap:4px;margin-left:auto}
.folder-head:hover .folder-actions{display:flex}
.folder-action{font-size:10px;color:var(--text-dim);cursor:pointer;padding:2px 4px;border-radius:2px}
.folder-action:hover{color:var(--text);background:rgba(255,255,255,0.06)}
.folder-topic{display:flex;align-items:center;padding:6px 16px 6px 20px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;gap:8px}
.folder-topic:hover{background:rgba(255,255,255,0.02)}
.folder-topic.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.folder-topic.dragging{opacity:0.4}
.folder-topic-dot{width:5px;height:5px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.folder-topic-dot.unread{background:var(--warm)}
.folder-topic-name{font-size:11px;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.folder-topic-pct{font-size:9px;color:var(--text-dim)}
.unfiled-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);padding:10px 16px 4px}

/* Priority Badges */
.priority-badge{font-size:8px;text-transform:uppercase;letter-spacing:1px;padding:1px 4px;border-radius:2px;font-weight:600;flex-shrink:0}
.priority-badge.NOW{background:rgba(196,112,112,0.15);color:#c47070}
.priority-badge.HIGH{background:rgba(212,168,83,0.15);color:#d4a853}
.priority-badge.LOW{color:var(--text-dim)}
.priority-badge-lg{font-size:10px;padding:3px 8px;border-radius:3px;font-weight:600;display:inline-block}
.topic-priority{display:flex;align-items:center;gap:8px;margin-top:6px;cursor:pointer;padding:6px 0}
.topic-priority:hover{opacity:0.8}
.priority-conf{font-size:9px;color:var(--text-dim)}
.priority-explanation{display:none;background:var(--surface);border:1px solid var(--border);border-radius:4px;margin-top:8px;padding:12px}
.priority-explanation.open{display:block}
.priority-group-header{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);padding:10px 16px 4px;border-top:1px solid var(--border);margin-top:8px}
.priority-group-header:first-child{border-top:none;margin-top:0}
.sort-toggle{display:flex;gap:4px;padding:8px 16px;border-bottom:1px solid var(--border)}
.sort-toggle-btn{flex:1;padding:4px 8px;font-size:9px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;border:1px solid var(--border);background:none;color:var(--text-dim);border-radius:3px;cursor:pointer;transition:all 0.1s;font-family:inherit}
.sort-toggle-btn.active{background:rgba(255,255,255,0.06);border-color:var(--text-dim);color:var(--text)}
.add-folder-btn{display:flex;align-items:center;gap:6px;padding:8px 16px;cursor:pointer;color:var(--text-dim);font-size:11px;transition:all 0.1s}
.add-folder-btn:hover{color:var(--text);background:rgba(255,255,255,0.03)}
.folder-input{background:var(--surface-2);border:1px solid var(--border-light);border-radius:3px;padding:4px 8px;font-size:11px;color:var(--text);font-family:inherit;outline:none;width:100%}
.folder-input:focus{border-color:var(--warm)}

/* Standards panel in context */
.ctx-standard{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:3px;cursor:pointer;margin-bottom:2px;font-size:11px;color:var(--text-muted);border:1px solid transparent;transition:all 0.12s}
.ctx-standard:hover{background:rgba(255,255,255,0.03);border-color:var(--border)}
.ctx-standard.active{border-color:var(--warm);background:rgba(212,168,83,0.04)}
.ctx-standard-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.ctx-checklist{padding:4px 8px;font-size:10px;color:var(--text-dim);line-height:1.8}
.ctx-check{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer}
.ctx-check-box{width:14px;height:14px;border:1px solid var(--border-light);border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:8px;flex-shrink:0}
.ctx-check.done .ctx-check-box{border-color:var(--warm);color:var(--warm)}
.ctx-check.done span{text-decoration:line-through;color:var(--text-dim)}

/* Right */
.right-wrap{flex:1;display:flex;overflow:hidden}
.right{flex:1;display:flex;flex-direction:column;min-width:0}
.right-header{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.right-header-left h2{font-size:15px;font-weight:600}
.right-header-left .sub{font-size:11px;color:var(--text-dim);margin-top:1px}
.hdr-btns{display:flex;gap:6px}
.hdr-btn{padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit;transition:all 0.12s}
.hdr-btn:hover{border-color:var(--border-light);color:var(--text)}
.hdr-btn.on{background:rgba(255,255,255,0.06);border-color:var(--text-dim);color:var(--text)}

/* Steps */
.steps-bar{padding:12px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0;overflow-x:auto}
.sn{display:flex;align-items:center;gap:0;flex-shrink:0}
.sc{width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--text-dim);flex-shrink:0;cursor:pointer;transition:all 0.15s}
.sc:hover{border-color:var(--text-muted)}
.sc.done{border-color:var(--text-dim);color:var(--text-dim);background:rgba(255,255,255,0.04)}
.sc.now{border-color:var(--warm);color:var(--warm)}
.sl{font-size:9px;color:var(--text-dim);margin-left:3px;margin-right:8px;white-space:nowrap}
.sl.done{color:var(--text-dim);text-decoration:line-through}
.sl.now{color:var(--text-muted)}
.sline{width:16px;height:1px;background:var(--border);flex-shrink:0}
.sline.done{background:var(--text-dim)}

/* Conversation */
.conv{flex:1;overflow-y:auto;padding:20px 24px}
.msg{margin-bottom:16px;max-width:80%}
.msg.mia{margin-right:auto}
.msg.human{margin-left:auto}
.msg.system{margin:0 auto;max-width:100%}
.sender{font-size:10px;color:var(--text-dim);margin-bottom:3px;font-weight:500}
.bubble{padding:12px 16px;border-radius:8px;font-size:12px;line-height:1.7}
.mia .bubble{background:var(--surface);border:1px solid var(--border)}
.human .bubble{background:rgba(255,255,255,0.04);border:1px solid var(--border-light)}
.system .bubble{background:none;border:1px dashed var(--border);text-align:center;color:var(--text-dim);font-size:11px;padding:8px}
.time{font-size:9px;color:var(--text-dim);margin-top:3px}

/* Proposals */
.proposal{margin-top:10px;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.proposal-head{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;font-size:11px}
.proposal-type{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)}
.proposal-confidence{font-size:10px;color:var(--text-dim)}
.proposal-body{padding:0 14px 12px;font-size:12px;color:var(--text-muted);line-height:1.6}

/* Expandable options */
.exp-opt{border:1px solid var(--border);border-radius:6px;margin:6px 14px;cursor:pointer;transition:all 0.15s;overflow:hidden}
.exp-opt:hover{border-color:var(--border-light)}
.exp-opt.open{border-color:var(--text-dim)}
.exp-opt.chosen{border-color:var(--warm)}
.opt-hd{display:flex;align-items:center;gap:8px;padding:10px 12px}
.opt-key{width:20px;height:20px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:var(--surface-2);color:var(--text-dim);border:1px solid var(--border);flex-shrink:0}
.exp-opt.open .opt-key{background:var(--text);color:var(--bg);border-color:var(--text)}
.exp-opt.chosen .opt-key{background:var(--warm);color:var(--bg);border-color:var(--warm)}
.opt-title{font-size:11px;color:var(--text-muted)}
.exp-opt.open .opt-title,.exp-opt.chosen .opt-title{color:var(--text)}
.opt-rec{font-size:9px;color:var(--warm);margin-left:auto}
.opt-body{display:none;padding:0 12px 12px;border-top:1px solid var(--border)}
.exp-opt.open .opt-body{display:block;padding-top:10px}
.opt-desc{font-size:11px;color:var(--text-muted);margin-bottom:8px;line-height:1.5}
.draft-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:11px;color:var(--text-muted);line-height:1.7;white-space:pre-wrap;margin-bottom:8px}
.draft-box b{color:var(--text);font-weight:500}
.draft-label{font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:4px;font-weight:600}

/* Vote row */
.vote-row{display:flex;align-items:center;gap:6px;padding:8px 14px;border-top:1px solid var(--border)}
.vote-btn{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:3px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-dim);font-family:inherit;transition:all 0.15s}
.vote-btn:hover{border-color:var(--border-light);color:var(--text-muted)}
.vote-btn.voted.up{border-color:var(--warm);color:var(--warm);background:rgba(212,168,83,0.06)}
.vote-btn.voted.down{border-color:var(--danger);color:var(--danger);background:rgba(196,112,112,0.06)}
.vote-status{font-size:10px;color:var(--warm);margin-left:auto;display:none}
.vote-status.show{display:block}

/* Action buttons */
.act-row{display:flex;gap:6px;flex-wrap:wrap}
.act{padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;border:none;font-family:inherit;transition:all 0.15s}
.act-p{background:var(--text);color:var(--bg)}
.act-p:hover{background:#fff}
.act-g{background:none;border:1px solid var(--border);color:var(--text-muted)}
.act-g:hover{border-color:var(--border-light);color:var(--text)}

/* Input */
.input-area{padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.input-field{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:12px;color:var(--text);font-family:inherit;resize:none;outline:none;min-height:40px;max-height:120px;line-height:1.5}
.input-field:focus{border-color:var(--text-dim)}
.input-field::placeholder{color:var(--text-dim)}
.send-btn{padding:10px 16px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;flex-shrink:0}
.send-btn:hover{background:#fff}

/* Context panel */
.ctx{width:0;overflow:hidden;border-left:1px solid var(--border);background:var(--surface);transition:width 0.2s;flex-shrink:0}
.ctx.open{width:260px}
.ctx-inner{width:260px;overflow-y:auto;padding:0;height:100%}
.ctx-sec{border-bottom:1px solid var(--border);padding:14px 16px}
.ctx-sec-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px}
.ctx-doc{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:3px;cursor:pointer;margin-bottom:2px;font-size:11px;color:var(--text-muted)}
.ctx-doc:hover{background:rgba(255,255,255,0.03)}
.ctx-doc-icon{width:24px;height:24px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:rgba(255,255,255,0.04);color:var(--text-dim);flex-shrink:0}
.ctx-conn{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:3px;cursor:pointer;margin-bottom:2px;font-size:11px;color:var(--text-muted)}
.ctx-conn:hover{background:rgba(255,255,255,0.03)}
.ctx-conn-dot{width:5px;height:5px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.ctx-rel{font-size:9px;color:var(--text-dim)}
.ctx-truth{padding:6px 8px;border-left:2px solid var(--border-light);margin-bottom:6px;font-size:10px;line-height:1.5;color:var(--text-dim)}

.ctx-doc{cursor:pointer;transition:all 0.12s}
.ctx-doc:hover .ctx-doc-icon{background:var(--warm);color:var(--bg)}

/* File viewer overlay */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.overlay.open{display:flex}
.overlay-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;width:680px;max-width:90vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.overlay-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.overlay-title{font-size:13px;font-weight:600}
.overlay-path{font-size:10px;color:var(--text-dim);margin-top:2px;font-family:monospace}
.overlay-close{width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--text-muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.overlay-close:hover{border-color:var(--text-dim);color:var(--text)}
.overlay-body{flex:1;overflow-y:auto;padding:18px;font-size:12px;line-height:1.8;color:var(--text-muted);white-space:pre-wrap;font-family:'SF Mono',Menlo,monospace}
.overlay-body .loading{padding:20px}
.overlay-actions{display:flex;gap:6px;padding:12px 18px;border-top:1px solid var(--border)}
.overlay-actions button{padding:6px 14px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit}
.overlay-actions button:hover{border-color:var(--text-dim);color:var(--text)}
.overlay-actions button.primary{background:var(--text);color:var(--bg);border-color:var(--text)}

.loading{text-align:center;padding:40px;color:var(--text-dim);font-size:12px}
.sys-indicator{display:flex;align-items:center;gap:8px;padding:10px 20px;font-size:10px;color:var(--text-dim);border-top:1px solid var(--border);cursor:pointer}
.sys-indicator:hover{background:rgba(255,255,255,0.02)}
.sys-dot{width:6px;height:6px;border-radius:50%}
.exec-health{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.exec-health-row{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;border-bottom:1px solid var(--border);font-size:11px}
.exec-health-row:last-child{border-bottom:none}
.exec-health-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.goal-val-btn{width:18px;height:18px;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;font-size:10px;display:inline-flex;align-items:center;justify-content:center}
.goal-val-btn:hover{background:var(--surface-2)}
.goal-add-input{background:transparent;border:none;color:var(--text-muted);font-size:11px;width:100%;outline:none;font-family:Inter,sans-serif}
.goal-add-input::placeholder{color:var(--text-dim)}
.feed-section{margin-bottom:32px}
.feed-item{display:flex;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:11px;align-items:flex-start}
.feed-item:last-child{border-bottom:none}
.feed-agent{font-weight:600;width:90px;flex-shrink:0}
.feed-action{color:var(--text-muted);flex:1}
.feed-time{color:var(--text-dim);font-size:10px;flex-shrink:0}
.feed-result{font-size:9px;padding:1px 5px;border-radius:2px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.feed-impact{font-size:10px;color:var(--warm);margin-left:8px}
.activity-graph{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.graph-row{display:flex;align-items:flex-end;gap:3px;height:80px;padding:0 4px}
.graph-bar-group{display:flex;flex-direction:column;align-items:center;flex:1;gap:2px}
.graph-bar{border-radius:2px 2px 0 0;min-width:8px;transition:height 0.3s}
.graph-stacked{display:flex;flex-direction:column-reverse;align-items:center;width:100%;gap:1px}
.graph-label{font-size:8px;color:var(--text-dim);margin-top:4px;text-align:center}
.graph-legend{display:flex;gap:12px;margin-top:8px;font-size:9px;color:var(--text-dim)}
.graph-legend-dot{width:8px;height:8px;border-radius:2px;display:inline-block;margin-right:4px;vertical-align:middle}
.alert-item{display:flex;align-items:center;gap:8px;padding:6px 12px;font-size:11px;border-radius:4px;margin-bottom:4px}
.alert-inactive{background:rgba(212,168,83,0.1);color:#d4a853}
.alert-failure{background:rgba(196,112,112,0.1);color:#c47070}

/* Executive Tabs */
.exec-tabs{display:flex;gap:0;margin-bottom:24px;border-bottom:1px solid var(--border)}
.exec-tab{padding:10px 20px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.exec-tab:hover{color:var(--text-muted)}
.exec-tab.active{color:#d4a853;border-bottom-color:#d4a853}

/* Decisions */
.decision-item{padding:12px 16px;border-bottom:1px solid var(--border);font-size:11px}
.decision-item:last-child{border-bottom:none}
.decision-id{font-weight:600;color:#d4a853;margin-right:8px}
.decision-question{color:var(--text)}
.decision-meta{margin-top:4px;color:var(--text-dim);font-size:10px}
.decision-followed{font-size:9px;padding:1px 5px;border-radius:2px;font-weight:600;text-transform:uppercase}
.decision-yes{background:rgba(74,160,136,0.15);color:#4aa088}
.decision-no{background:rgba(212,168,83,0.15);color:#d4a853}
.decision-partial{background:rgba(155,142,196,0.15);color:#9b8ec4}

/* Backlog */
.backlog-item{display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid var(--border);font-size:11px}
.backlog-item:last-child{border-bottom:none}
.backlog-desc{flex:1;color:var(--text)}
.backlog-priority{font-size:9px;padding:1px 5px;border-radius:2px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.backlog-actions{display:flex;gap:4px}
.backlog-btn{padding:2px 6px;font-size:9px;border:1px solid var(--border);border-radius:3px;background:transparent;color:var(--text-muted);cursor:pointer}
.backlog-btn:hover{background:var(--surface-2)}
.backlog-add{padding:8px 16px;border-top:1px solid var(--border)}
.backlog-input{background:transparent;border:none;color:var(--text-muted);font-size:11px;width:100%;outline:none;font-family:Inter,sans-serif}

/* Running Tasks */
.running-item{display:flex;align-items:center;gap:10px;padding:8px 16px;border-bottom:1px solid var(--border);font-size:11px}
.running-status{width:6px;height:6px;border-radius:50%;background:#4aa088;flex-shrink:0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* Stats Row */
.stats-row{display:flex;gap:24px;padding:12px 16px;font-size:11px;color:var(--text-muted)}
.stats-item{display:flex;flex-direction:column;gap:2px}
.stats-value{font-size:18px;font-weight:700;color:var(--text)}
.stats-label{font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
</style>
</head>
<body>

<div class="left">
  <div class="left-header">
    <div style="font-size:13px;font-weight:700;letter-spacing:3px;color:#d4a853;font-variant:small-caps;margin-bottom:4px">AINARY</div>
    <h1 style="cursor:pointer;font-size:11px;font-weight:500;color:var(--text-dim);margin-bottom:8px" onclick="togglePipelineView()">Execution Platform v0.12.3 <span id="wsStatus" style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--danger);margin-left:6px;vertical-align:middle;transition:background 0.3s"></span></h1>
    <p style="font-size:10px">Research → Systems → Content → Revenue</p>
  </div>
  <div class="pipeline" id="pipeline"></div>
  <div class="sort-toggle">
    <button class="sort-toggle-btn active" id="sortFolders" onclick="setSortMode('folders')">Sort: Folders</button>
    <button class="sort-toggle-btn" id="sortPriority" onclick="setSortMode('priority')">Sort: Priority</button>
  </div>
  <div class="folder-tree" id="folderTree"><div class="loading">Loading...</div></div>
  <div style="display:flex;gap:4px;padding:4px 12px">
    <div class="add-folder-btn" style="flex:1;padding:6px 8px" onclick="startAddTopic()">+ Topic</div>
    <div class="add-folder-btn" style="flex:1;padding:6px 8px" onclick="startAddFolder()">+ Ordner</div>
  </div>
  <div class="trust-footer" id="trustFooter"></div>
</div>

<div class="right-wrap">
<div class="right">
  <div class="right-header">
    <div class="right-header-left">
      <h2 id="topicTitle">Select a topic</h2>
      <div class="sub" id="topicSub"></div>
    </div>
    <div class="hdr-btns">
      <button class="hdr-btn" id="genCvBtn" style="display:none" onclick="generateCV()">Generate CV</button>
      <button class="hdr-btn" id="ctxBtn" onclick="toggleCtx()">Context</button>
      <button class="hdr-btn" onclick="openFiles()">Files</button>
    </div>
  </div>
  <div class="steps-bar" id="stepsBar"></div>
  <div class="conv" id="conv"><div class="loading">Select a topic to start</div></div>
  <div id="pipelineView" style="display:none;flex:1;overflow:auto;padding:24px"></div>
  <div id="principlesView" style="display:none;flex:1;overflow:auto;padding:32px 24px"></div>
  <div id="stageView" class="stage-view"></div>
  <div id="operationsView" style="display:none;flex:1;overflow:auto;padding:32px 24px"></div>
  <div class="action-bar" id="actionBar" style="display:none"></div>
  <div class="input-area">
    <textarea class="input-field" id="inputField" placeholder="Add context, decide, give feedback..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg()}"></textarea>
    <button class="send-btn" onclick="sendMsg()">Send</button>
  </div>
</div>
<div class="ctx" id="ctxPanel"><div class="ctx-inner" id="ctxInner"></div></div>

<!-- File Viewer Overlay -->
<div class="overlay" id="fileOverlay" onclick="if(event.target===this)closeOverlay()">
  <div class="overlay-box">
    <div class="overlay-hdr">
      <div>
        <div class="overlay-title" id="overlayTitle">File</div>
        <div class="overlay-path" id="overlayPath"></div>
      </div>
      <button class="overlay-close" onclick="closeOverlay()">✕</button>
    </div>
    <div class="overlay-body" id="overlayBody"><div class="loading">Loading...</div></div>
    <div class="overlay-actions">
      <button onclick="copyFileContent()">Copy Content</button>
      <button id="overlayOpenBtn" style="display:none" onclick="openExternal()">Open External</button>
    </div>
  </div>
</div>
</div>

<!-- Email Compose Dialog -->
<div class="confirm-overlay" id="emailOverlay">
  <div class="confirm-box" style="width:560px">
    <h3>Email senden</h3>
    <input class="new-topic-field" id="emailTo" placeholder="An (email@example.com)">
    <input class="new-topic-field" id="emailSubject" placeholder="Betreff">
    <textarea class="new-topic-field" id="emailBody" placeholder="Nachricht..." rows="8" style="resize:vertical;min-height:120px"></textarea>
    <div id="emailAttachments" style="font-size:10px;color:var(--text-dim);margin-bottom:10px"></div>
    <div class="confirm-btns">
      <button class="secondary" onclick="closeEmailDialog()">Abbrechen</button>
      <button class="primary" onclick="sendEmailFromDialog()">Senden</button>
    </div>
  </div>
</div>

<!-- Command Palette (Cmd+K) -->
<div class="cmd-overlay" id="cmdOverlay" onclick="if(event.target===this)closeCmd()">
  <div class="cmd-box">
    <input class="cmd-input" id="cmdInput" placeholder="Suche Topics, Aktionen, Ordner..." oninput="filterCmd(this.value)">
    <div class="cmd-results" id="cmdResults"></div>
    <div class="cmd-footer">
      <span>↑↓ navigieren</span><span>↵ auswählen</span><span>esc schließen</span>
    </div>
  </div>
</div>

<!-- Confirm Dialog (Guardrail: 🔴 CONFIRM) -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3 id="confirmTitle">Aktion bestätigen</h3>
    <p id="confirmDesc"></p>
    <div class="confirm-btns">
      <button class="secondary" onclick="closeConfirm(false)">Abbrechen</button>
      <button class="primary" onclick="closeConfirm(true)">Ausführen</button>
    </div>
  </div>
</div>

<!-- New Topic Modal -->
<div class="new-topic-overlay" id="newTopicOverlay" onclick="if(event.target===this)closeNewTopic()">
  <div class="new-topic-box">
    <h3>Neues Topic</h3>
    <input class="new-topic-field" id="ntName" placeholder="Name (z.B. Glasswing Bewerbung)" autofocus>
    <div class="new-topic-row">
      <select class="new-topic-select" id="ntStage">
        <option value="revenue">Revenue</option>
        <option value="content">Content</option>
        <option value="systems">Systems</option>
        <option value="research">Research</option>
      </select>
      <select class="new-topic-select" id="ntFolder">
        <option value="">Kein Ordner</option>
      </select>
      <select class="new-topic-select" id="ntOutputType">
        <option value="general">General</option>
        <option value="email">Email</option>
        <option value="linkedin">LinkedIn</option>
        <option value="blog">Blog</option>
        <option value="report">Report</option>
        <option value="website">Website</option>
      </select>
    </div>
    <input class="new-topic-field" id="ntContact" placeholder="Kontakt (optional)">
    <input class="new-topic-field" id="ntEmail" placeholder="Email (optional)">
    <div class="new-topic-btns">
      <button class="secondary" onclick="closeNewTopic()">Abbrechen</button>
      <button class="primary" onclick="submitNewTopic()">Erstellen</button>
    </div>
  </div>
</div>

<!-- Finding Form -->
<div class="finding-form-overlay" id="findingOverlay" onclick="if(event.target===this)closeFindingForm()">
  <div class="finding-form">
    <div class="finding-form-header">
      <h3>Save Finding</h3>
      <button class="finding-form-close" onclick="closeFindingForm()">&times;</button>
    </div>
    <div class="finding-form-body">
      <div class="finding-field">
        <label>Claim</label>
        <textarea id="ffClaim" placeholder="What did you learn? State it as a testable claim."></textarea>
        <div class="hint">Be specific. "X leads to Y" is better than "X is interesting".</div>
      </div>
      <div class="finding-field">
        <label>Confidence</label>
        <div class="finding-conf-row">
          <input type="range" class="finding-conf-slider" id="ffConf" min="5" max="95" value="50" oninput="document.getElementById('ffConfVal').textContent=this.value+'%';document.getElementById('ffConfVal').style.color=this.value>=70?'#4aa088':this.value>=30?'var(--warm)':'var(--danger)'">
          <span class="finding-conf-val" id="ffConfVal">50%</span>
        </div>
      </div>
      <div class="finding-field">
        <label>Source Type</label>
        <select id="ffSource">
          <option value="conversation">Conversation</option>
          <option value="own_hypothesis">Own Hypothesis</option>
          <option value="own_data">Own Data / Experience</option>
          <option value="linkedin_poll">LinkedIn Poll</option>
          <option value="industry_report">Industry Report</option>
          <option value="academic_paper">Academic Paper</option>
          <option value="revenue_validated">Revenue Validated</option>
        </select>
      </div>
      <div class="finding-field">
        <label>Tags</label>
        <input id="ffTags" placeholder="e.g. ai_quality, trust, pre_flight (comma-separated)">
      </div>
      <div class="finding-field">
        <label>Context (optional)</label>
        <textarea id="ffContext" placeholder="Why is this important? What evidence supports it?" style="min-height:40px"></textarea>
      </div>
    </div>
    <div class="finding-form-footer">
      <button class="secondary" onclick="closeFindingForm()">Cancel</button>
      <button class="primary-btn" id="ffSubmit" onclick="submitFinding()">Save Finding</button>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:8080/api';
const AGENT_COLORS = {
  'HUNTER': '#c47070',
  'WRITER': '#9b8ec4',
  'RESEARCHER': '#6b8aab',
  'OPERATOR': '#4aa088',
  'DEALMAKER': '#d4a853',
  'FLORIAN': '#ffffff'
};
let currentTopic = null;
let currentFolder = null;
let topicsCache = {};
let foldersCache = [];
let draggedTopicId = null;
let sortMode = 'folders'; // 'folders' or 'priority'

// ── INIT ──
async function init() {
  await loadPipeline();
  await loadFolderTree();
  await loadTrust();
}

// ── PIPELINE ──
async function loadPipeline() {
  const r = await fetch(API+'/pipeline').then(r=>r.json());
  const el = document.getElementById('pipeline');
  const stages = [
    {key:'research',icon:'R',name:'Research'},
    {key:'systems',icon:'S',name:'Systems'},
    {key:'content',icon:'C',name:'Content'},
    {key:'revenue',icon:'€',name:'Revenue'}
  ];
  const flowKeys = ['research_to_systems','systems_to_content','content_to_revenue'];
  el.innerHTML = stages.map((s,i) => {
    const d = r.stages[s.key];
    const pct = Math.round(d.avg_progress);
    
    // Flow arrow between stages
    let arrow = '';
    if (i > 0) {
      const fk = flowKeys[i-1];
      const flow = r.flows && r.flows[fk];
      if (flow && flow.source_count > 0) {
        const convPct = flow.conversion_pct;
        const flowColor = convPct > 50 ? '#4aa088' : convPct > 0 ? 'var(--warm)' : 'var(--text-dim)';
        arrow = `<div class="pipe-arrow" style="display:flex;align-items:center;justify-content:center;gap:6px">
          <span style="color:var(--border-light)">↓</span>
          <span style="font-size:8px;color:${flowColor};font-weight:600">${flow.connected}/${flow.source_count} (${convPct}%)</span>
        </div>`;
      } else {
        arrow = '<div class="pipe-arrow">↓</div>';
      }
    }
    
    return arrow+
    `<div class="pipe-stage" onclick="filterStage('${s.key}',this)">
      <div class="pipe-icon">${s.icon}</div>
      <div class="pipe-info">
        <div class="pipe-name">${s.name}</div>
        <div class="pipe-count">${d.count} items · ${pct}% avg</div>
      </div>
      <div class="pipe-bar"><div class="pipe-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
  
  // Executive Board FIRST, then pipeline stages
  el.innerHTML = `
  <div class="pipe-stage" onclick="showOperations()" style="margin-bottom:4px">
    <div class="pipe-icon" style="background:rgba(212,168,83,0.15);color:#d4a853">E</div>
    <div class="pipe-info">
      <div class="pipe-name" style="color:#d4a853">Executive Board</div>
      <div class="pipe-count" id="ops-score">Score: --</div>
    </div>
  </div>
  <div style="border-bottom:1px solid var(--border);margin:4px 20px 8px"></div>` + el.innerHTML + `
  <div class="sys-indicator" id="sysIndicator" onclick="showOperations()">
    <div class="sys-dot" id="sysDot" style="background:#4aa088"></div>
    <span id="sysLabel">All systems nominal</span>
  </div>
  <div style="border-top:1px solid var(--border);margin-top:8px;padding-top:8px">
    <div style="font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);padding:4px 20px">Demos</div>
    <a href="/view/projects/workbench/demos/glashuette.html" target="_blank" style="display:flex;align-items:center;gap:8px;padding:8px 20px;font-size:11px;color:var(--text-muted);text-decoration:none;cursor:pointer;transition:background 0.1s" onmouseover="this.style.background='rgba(255,255,255,0.02)'" onmouseout="this.style.background='transparent'">
      <span style="color:var(--warm);font-weight:600;font-size:10px">G</span>
      <span>Gemeinde Glashütte</span>
    </a>
  </div>`;
  
  // Load today's score for the Operations item
  loadOperationsScore();
}

async function loadOperationsScore() {
  try {
    const data = await fetch(API + '/standup/today').then(r => r.json());
    const scoreEl = document.getElementById('ops-score');
    if (scoreEl && data.score) {
      scoreEl.textContent = `Score: ${data.score.score_current}`;
    }
  } catch (e) {
    console.error('Failed to load operations score:', e);
  }
}

let activeStageFilter = null;
let stageViewOpen = false;

// Unified View State
const VIEW = {
  current: 'topics',
  stage: null,
  contextMode: 'topic'
};

function switchView(target, opts = {}) {
  const conv = document.getElementById('conv');
  const stageView = document.getElementById('stageView');
  const opsView = document.getElementById('operationsView');
  const pipelineView = document.getElementById('pipelineView');
  const principlesView = document.getElementById('principlesView');
  const steps = document.getElementById('stepsBar');
  const actionBar = document.getElementById('actionBar');
  const input = document.querySelector('.input-area');
  const ctx = document.getElementById('ctxPanel');

  // Hide everything first
  conv.style.display = 'none';
  if (steps) steps.style.display = 'none';
  if (actionBar) actionBar.style.display = 'none';
  if (input) input.style.display = 'none';
  stageView.classList.remove('open');
  if (opsView) opsView.style.display = 'none';
  if (pipelineView) pipelineView.style.display = 'none';
  if (principlesView) principlesView.style.display = 'none';

  // Reset old state variables for backward compatibility
  operationsViewOpen = false;
  pipelineViewOpen = false;
  principlesViewOpen = false;
  stageViewOpen = false;
  activeStageFilter = null;
  document.querySelectorAll('.pipe-stage').forEach(s => s.classList.remove('active'));

  // Show target view
  switch(target) {
    case 'topics':
      conv.style.display = '';
      if (steps) steps.style.display = '';
      if (input) input.style.display = '';
      ctx.style.display = '';
      VIEW.contextMode = 'topic';
      if (currentTopic) selectTopic(currentTopic);
      break;
    case 'executive':
      opsView.style.display = 'flex';
      operationsViewOpen = true;
      ctx.style.display = '';
      VIEW.contextMode = 'global';
      renderOperationsView();
      renderGlobalContext();
      break;
    case 'stage':
      stageView.classList.add('open');
      stageViewOpen = true;
      activeStageFilter = opts.stage;
      ctx.style.display = '';
      VIEW.contextMode = 'global';
      renderStageView(opts.stage);
      renderGlobalContext();
      break;
    case 'pipeline':
      pipelineView.style.display = 'flex';
      pipelineView.style.flexDirection = 'column';
      pipelineViewOpen = true;
      ctx.style.display = 'none';
      renderPipelineView();
      break;
    case 'principles':
      principlesView.style.display = 'flex';
      principlesView.style.flexDirection = 'column';
      principlesViewOpen = true;
      ctx.style.display = 'none';
      renderPrinciplesView();
      break;
  }

  VIEW.current = target;
  VIEW.stage = opts.stage || null;
  updateHeaderButtons();
  loadFolderTree();
}

function updateHeaderButtons() {
  const ctxBtn = document.getElementById('ctxBtn');
  if (ctxBtn) {
    const ctxEnabled = ['topics', 'executive', 'stage'].includes(VIEW.current);
    ctxBtn.style.opacity = ctxEnabled ? '1' : '0.3';
    ctxBtn.style.pointerEvents = ctxEnabled ? 'auto' : 'none';
    ctxBtn.title = ctxEnabled ? 'Context Panel öffnen' : 'Context nicht verfügbar in dieser Ansicht';
  }
}

function renderGlobalContext() {
  const el = document.getElementById('ctxInner');
  if (!el) return;

  let html = '';

  html += '<div class="ctx-sec"><div class="ctx-sec-title">Dokumente</div>';
  const docs = [
    {name:'README', path:'projects/workbench/README.md'},
    {name:'Architecture', path:'projects/workbench/ARCHITECTURE.md'},
    {name:'API Reference', path:'projects/workbench/DOCUMENTATION.md'},
    {name:'DB Schema', path:'projects/workbench/DB-SCHEMA.md'},
    {name:'Formulas', path:'projects/workbench/FORMULAS.md'},
    {name:'Security', path:'projects/workbench/SECURITY.md'},
    {name:'Runbook', path:'projects/workbench/RUNBOOK.md'},
    {name:'Design Doc', path:'projects/workbench/DESIGN-DOC.md'},
  ];
  docs.forEach(d => {
    html += '<a class="ctx-doc" href="/view/' + d.path + '" target="_blank" style="text-decoration:none;color:inherit">' +
      '<div class="ctx-doc-icon">MD</div><div>' + d.name + '</div></a>';
  });
  html += '</div>';

  html += '<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--warm)">Quick Links</div>';
  const links = [
    {name:'GitHub (Private)', url:'https://github.com/florianziesche/ainary-platform'},
    {name:'Landing Page', url:'https://ainaryventures.com'},
    {name:'Glashütte Demo', url:'/view/projects/workbench/demos/glashuette.html'},
  ];
  links.forEach(l => {
    html += '<a class="ctx-doc" href="' + l.url + '" target="_blank" style="text-decoration:none;color:inherit">' +
      '<div class="ctx-doc-icon" style="background:rgba(212,168,83,0.1);color:var(--warm);border-color:rgba(212,168,83,0.2)">→</div><div>' + l.name + '</div></a>';
  });
  html += '</div>';

  html += '<div class="ctx-sec"><div class="ctx-sec-title">Standards</div>';
  const standards = [
    {name:'R2 Deep Dive Research', path:'standards/R2-DEEP-DIVE-RESEARCH.md'},
    {name:'S1 Ersttermin-Prep', path:'standards/S1-ERSTTERMIN-PREP.md'},
    {name:'Agent Context Package', path:'standards/AGENT-CONTEXT-PACKAGE.md'},
  ];
  standards.forEach(s => {
    html += '<a class="ctx-doc" href="/view/' + s.path + '" target="_blank" style="text-decoration:none;color:inherit">' +
      '<div class="ctx-doc-icon">STD</div><div>' + s.name + '</div></a>';
  });
  html += '</div>';

  el.innerHTML = html;
}

function filterStage(stage, el) {
  const wasActive = el.classList.contains('active');
  document.querySelectorAll('.pipe-stage').forEach(s=>s.classList.remove('active'));
  
  if (wasActive) {
    switchView('topics');
  } else {
    el.classList.add('active');
    switchView('stage', {stage});
  }
}

function showStageView(stage) {
  switchView('stage', {stage});
}

function hideStageView() {
  switchView('topics');
}

// ── OPERATIONS VIEW ──
let operationsViewOpen = false;

function showOperations() {
  switchView('executive');
}

function hideOperations() {
  switchView('topics');
}

async function renderOperationsView() {
  const view = document.getElementById('operationsView');
  view.innerHTML = '<div class="loading">Loading Executive Board data...</div>';
  
  try {
    const kpiData = await fetch(API + '/executive/kpis').then(r => r.json());
    const standupData = await fetch(API + '/standup/today').then(r => r.json());
    const history = await fetch(API + '/standup/history?days=14').then(r => r.json());
    const impactData = await fetch(API + '/executive/impact').then(r => r.json()).catch(() => ({totals:[], week:[]}));
    
    const strategic = kpiData.strategic;
    const operational = kpiData.operational;
    const agents = kpiData.agents;
    const goals = kpiData.goals;
    
    // Update sidebar system health indicator
    const sysDot = document.getElementById('sysDot');
    const sysLabel = document.getElementById('sysLabel');
    if (sysDot && sysLabel && kpiData.health) {
      const issues = kpiData.health.issues;
      if (issues === 0) { sysDot.style.background = '#4aa088'; sysLabel.textContent = 'All systems nominal'; }
      else if (issues === 1) { sysDot.style.background = '#d4a853'; sysLabel.textContent = '1 issue detected'; }
      else { sysDot.style.background = '#c47070'; sysLabel.textContent = issues + ' issues detected'; }
    }
    
    const score = standupData.score;
    const tasks = standupData.tasks;
    
    // Helper: format revenue
    const formatRevenue = (amount) => {
      return '€' + amount.toLocaleString('de-DE', {maximumFractionDigits: 0});
    };
    
    // Helper: KPI color
    const kpiColor = (current, target) => {
      const pct = current / target;
      return pct >= 1 ? '#4aa088' : pct >= 0.5 ? '#d4a853' : '#c47070';
    };
    
    // Helper: goal status
    const goalStatus = (goal) => {
      const now = new Date();
      const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
      const dayOfMonth = now.getDate();
      const expectedProgress = dayOfMonth / daysInMonth;
      const actualProgress = goal.current_value / goal.target_value;
      
      if (actualProgress >= 1) return {label: 'DONE', color: '#4aa088'};
      if (actualProgress >= expectedProgress) return {label: 'ON TRACK', color: '#4aa088'};
      if (goal.current_value === 0 && dayOfMonth > 10) return {label: 'AT RISK', color: '#c47070'};
      return {label: 'BEHIND', color: '#d4a853'};
    };
    
    // Helper: last active
    const formatLastActive = (dateStr) => {
      if (!dateStr) return '—';
      const diff = Math.floor((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
      if (diff === 0) return 'today';
      if (diff === 1) return 'yesterday';
      if (diff < 7) return `${diff} days ago`;
      return '7+ days';
    };
    
    const monthName = new Date().toLocaleDateString('en-US', { month: 'long' }).toUpperCase();
    const year = new Date().getFullYear();
    
    view.innerHTML = `
      <div style="max-width:900px;margin:0 auto;width:100%">
        
        <!-- Header -->
        <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:24px">
          <div>
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:4px">AINARY VENTURES</div>
            <h2 style="font-size:20px;font-weight:700;letter-spacing:-0.3px">Executive Board</h2>
          </div>
          <div style="text-align:right;font-size:10px;color:var(--text-dim)">
            ${monthName} ${year}
          </div>
        </div>
        
        <div style="border-bottom:2px solid var(--border);margin-bottom:24px"></div>
        
        <!-- Section 1: Strategic KPIs -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:24px;margin-bottom:32px">
          ${['revenue', 'sends', 'commitments', 'team_health'].map(key => {
            const kpi = strategic[key];
            const color = kpiColor(kpi.current, kpi.target);
            const pct = Math.round((kpi.current / kpi.target) * 100);
            const displayValue = key === 'revenue' ? formatRevenue(kpi.current) : 
                                 key === 'commitments' ? kpi.current + '%' : kpi.current;
            const targetLabel = key === 'revenue' ? formatRevenue(kpi.target) : 
                               key === 'commitments' ? kpi.target + '%' : kpi.target + '/wk';
            return `
              <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px;text-align:center">
                <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:12px">${kpi.label}</div>
                <div style="font-size:36px;font-weight:700;color:${color};line-height:1;margin-bottom:12px">${displayValue}</div>
                <div style="height:3px;background:var(--surface-2);border-radius:2px;overflow:hidden;margin-bottom:8px">
                  <div style="height:100%;width:${Math.min(pct, 100)}%;background:${color};border-radius:2px"></div>
                </div>
                <div style="font-size:10px;color:var(--text-dim)">target: ${targetLabel}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <!-- Section 2: Operational KPIs -->
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px">OPERATIONAL</div>
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:32px;display:flex;gap:20px;flex-wrap:wrap">
          <span>Findings/Week: <strong>${operational.findings_week}</strong></span>
          <span>Pipeline: 
            <span style="color:#8e8e8e">${operational.pipeline.research}R</span> → 
            <span style="color:#6b8aab">${operational.pipeline.systems}S</span> → 
            <span style="color:#9b8ec4">${operational.pipeline.content}C</span> → 
            <span style="color:#d4a853">${operational.pipeline.revenue}€</span>
          </span>
          <span>Outcomes/Month: <strong>${operational.outcomes_month}</strong></span>
          <span>Active: <strong>${operational.active_agents}/${operational.total_agents}</strong> Agents</span>
        </div>
        
        <!-- Section 3: Monthly Goals -->
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">${monthName} GOALS</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:32px">
          ${goals.length > 0 ? goals.map(goal => {
            const status = goalStatus(goal);
            const progress = goal.target_value > 0 ? (goal.current_value / goal.target_value) * 100 : 0;
            const progressLabel = `${goal.current_value}/${goal.target_value}`;
            const folderMap = {'Send 8 VC Emails':'job-applications/','Platform v1.0':'projects/workbench/','Build 5 Standards':'standards/'};
            const folder = Object.entries(folderMap).find(([k]) => goal.description.includes(k));
            return `
              <div style="display:grid;grid-template-columns:1fr 18px 40px 18px 80px 80px 120px;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px">
                <div>${goal.description}</div>
                <button class="goal-val-btn" onclick="updateGoalValue(${goal.id},${goal.current_value - 1})">−</button>
                <div style="font-size:11px;font-weight:600;color:var(--text-muted);text-align:center">${progressLabel}</div>
                <button class="goal-val-btn" onclick="updateGoalValue(${goal.id},${goal.current_value + 1})">+</button>
                <div style="font-size:9px;font-weight:600;padding:2px 8px;border-radius:3px;background:${status.color}20;color:${status.color};text-align:center">${status.label}</div>
                <div style="height:3px;background:var(--surface-2);border-radius:2px;overflow:hidden">
                  <div style="height:100%;width:${Math.min(progress, 100)}%;background:${status.color};border-radius:2px"></div>
                </div>
                <span style="font-size:9px;color:var(--text-dim)">${folder ? '→ ' + folder[1] : ''}</span>
              </div>
            `;
          }).join('') : '<div style="text-align:center;padding:20px;color:var(--text-dim)">No goals set for this month</div>'}
          <div style="padding:8px 16px;border-top:1px solid var(--border)">
            <input class="goal-add-input" placeholder="+ Add goal (Enter to save)" onkeydown="if(event.key==='Enter')addGoalInline(this)">
          </div>
        </div>
        
        <!-- Section 4: System Health -->
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">SYSTEM HEALTH</div>
        <div class="exec-health" style="margin-bottom:32px">
          ${(kpiData.health ? kpiData.health.checks : []).map(h => {
            const dotColor = h.status === 'ok' ? '#4aa088' : h.status === 'warning' ? '#d4a853' : '#c47070';
            return `
              <div class="exec-health-row">
                <div style="display:flex;align-items:center;gap:8px">
                  <div class="exec-health-dot" style="background:${dotColor}"></div>
                  <span>${h.name}</span>
                </div>
                <span style="color:var(--text-dim)">${h.value}</span>
              </div>`;
          }).join('')}
        </div>
        
        <!-- Section 5: Impact Summary -->
        ${(() => {
          const types = [
            {key:'time_saved', label:'Time Saved', fmt: v => (v/60).toFixed(1)+'h', desc:'vs. manual execution, standard tasks'},
            {key:'knowledge', label:'Knowledge', fmt: v => '+'+Math.round(v), desc:'findings, connections, research items'},
            {key:'revenue', label:'Revenue', fmt: v => '€'+Math.round(v), desc:'logged revenue events'}
          ];
          const tMap = {}; impactData.totals.forEach(r => tMap[r.impact_type] = r.total || 0);
          const wMap = {}; impactData.week.forEach(r => wMap[r.impact_type] = r.total || 0);
          const rows = types.map(t => {
            const total = tMap[t.key] || 0;
            const week = wMap[t.key] || 0;
            return `<div style="display:flex;align-items:baseline;gap:16px;padding:6px 0;font-size:12px">
              <div style="width:100px;color:var(--text-dim);font-weight:600">${t.label}</div>
              <div style="width:60px;font-weight:700;color:var(--text)">${t.fmt(total)}</div>
              <div style="width:130px;color:var(--text-muted)">this week: ${t.fmt(week)}</div>
              <div style="color:var(--text-dim);font-size:10px">(${t.desc})</div>
            </div>`;
          }).join('');
          return `
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">IMPACT SUMMARY</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:16px 20px;margin-bottom:32px">
            ${rows}
            <div style="margin-top:10px;font-size:9px;color:var(--text-dim);font-style:italic">Disclaimer: Estimates based on task-type benchmarks. ~70-85% quality vs. senior professional. Human review required.</div>
          </div>`;
        })()}
        
        <!-- Executive Tabs -->
        <div class="exec-tabs">
          <div class="exec-tab active" onclick="switchExecTab('florian')">Florian</div>
          <div class="exec-tab" onclick="switchExecTab('mia')">Mia + Team</div>
        </div>
        
        <!-- Florian Tab -->
        <div id="execFlorian">
          
          <!-- Decision Stats -->
          <div id="decisionStats" style="margin-bottom:24px"></div>
          
          <!-- Daily Standup -->
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">TODAY</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
            <div>
              <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)">Committed Tasks</div>
              <div id="committedTasksList" style="display:flex;flex-direction:column;gap:8px">
                ${tasks.filter(t => t.type === 'committed').map(t => `
                  <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
                    <input type="checkbox" ${t.status === 'done' ? 'checked' : ''} 
                           onchange="toggleTaskStatus(${t.id}, this.checked ? 'done' : 'pending')"
                           style="width:16px;height:16px;cursor:pointer">
                    <div style="flex:1;font-size:12px;${t.status === 'done' ? 'text-decoration:line-through;color:var(--text-dim)' : ''}">${t.description}</div>
                    ${t.is_send ? '<span style="font-size:9px;padding:2px 6px;background:rgba(212,168,83,0.15);color:var(--warm);border-radius:3px;font-weight:600">SEND</span>' : ''}
                  </div>
                `).join('')}
              </div>
              <div style="margin-top:12px">
                <input type="text" id="newTaskInput" placeholder="Add committed task..." 
                       style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;font-size:12px;color:var(--text);font-family:inherit"
                       onkeydown="if(event.key==='Enter')addTask()">
              </div>
            </div>
            
            <div>
              <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)">Score: ${score.score_current}</div>
              <div style="display:flex;gap:8px;align-items:flex-end;height:140px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:6px">
                ${history.slice(-7).map(day => {
                  const barColor = day.score_current >= 100 ? '#4aa088' : day.score_current >= 70 ? '#d4a853' : '#c47070';
                  const height = Math.max(5, (day.score_current / 120) * 100);
                  const date = new Date(day.date).toLocaleDateString('de-DE', { weekday: 'short' });
                  return `
                    <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
                      <div style="font-size:9px;font-weight:600;color:var(--text-muted)">${day.score_current}</div>
                      <div style="width:100%;background:${barColor};border-radius:3px 3px 0 0;height:${height}%"></div>
                      <div style="font-size:8px;color:var(--text-dim)">${date}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          </div>
          
          <!-- Recent Decisions -->
          <div id="recentDecisions"></div>
          
        </div>
        
        <!-- Mia Tab -->
        <div id="execMia" style="display:none">
          
          <!-- Running Tasks -->
          <div id="runningTasks" style="margin-bottom:32px"></div>
          
          <!-- Team Performance -->
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">TEAM</div>
          <div style="border-top:2px solid var(--border);margin-bottom:8px"></div>
          <div style="margin-bottom:32px">
            ${agents.sort((a,b) => b.score - a.score).map(agent => {
              const barColor = agent.score >= 60 ? '#4aa088' : agent.score >= 30 ? '#d4a853' : '#c47070';
              const lastActive = formatLastActive(agent.last_active);
              const isActive = agent.last_active && (new Date() - new Date(agent.last_active)) < 7 * 24 * 60 * 60 * 1000;
              const statusColor = isActive ? 'var(--text-muted)' : '#c47070';
              const statusText = isActive ? 'Active' : 'Inactive';
              return `
                <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
                  <div style="width:100px;font-size:11px;font-weight:600">${agent.name}</div>
                  <div style="flex:1;font-size:10px;color:var(--text-dim)">${agent.role}</div>
                  <div style="width:40px;font-size:11px;font-weight:600;text-align:right">${agent.score}</div>
                  <div style="width:80px;font-size:10px;color:var(--text-dim);text-align:right">${lastActive}</div>
                  <div style="width:150px;height:3px;background:var(--surface-2);border-radius:2px;overflow:hidden">
                    <div style="height:100%;width:${agent.score}%;background:${barColor};border-radius:2px"></div>
                  </div>
                  <div style="width:60px;font-size:10px;color:${statusColor};text-align:right">${statusText}</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <!-- Activity Graph -->
          <div id="activityGraphSection"></div>
          
          <!-- Alerts -->
          <div id="alertsSection"></div>
          
          <!-- Activity Feed -->
          <div id="activityFeedSection"></div>
          
          <!-- Backlog -->
          <div id="backlogSection"></div>
          
        </div>
        
      </div>
    `;
    
    // Render Activity Graph, Alerts, and Feed
    await renderActivitySections();
    
  } catch (e) {
    console.error('Failed to load executive board:', e);
    view.innerHTML = `<div style="text-align:center;padding:60px;color:var(--danger)">Failed to load executive board data</div>`;
  }
}

async function renderActivitySections() {
  try {
    // Fetch all activity data
    const [graphData, digestData, feedData, decisionsData, backlogData] = await Promise.all([
      fetch(API + '/activity/graph').then(r => r.json()),
      fetch(API + '/activity/digest').then(r => r.json()),
      fetch(API + '/activity/feed').then(r => r.json()),
      fetch(API + '/decisions').then(r => r.json()),
      fetch(API + '/backlog').then(r => r.json())
    ]);
    
    // Render Activity Graph
    renderActivityGraph(graphData);
    
    // Render Alerts
    renderAlerts(digestData);
    
    // Render Activity Feed
    renderActivityFeed(feedData);
    
    // Render Decisions
    renderDecisions(decisionsData);
    
    // Render Backlog
    renderBacklog(backlogData);
    
  } catch (e) {
    console.error('Failed to load activity sections:', e);
  }
}

function renderActivityGraph(data) {
  const section = document.getElementById('activityGraphSection');
  if (!section) return;
  
  const totals = data.totals || [];
  const byAgent = data.by_agent || [];
  
  if (totals.length === 0) {
    section.innerHTML = '';
    return;
  }
  
  // Build a map of date -> agent -> count
  const dateMap = {};
  totals.forEach(t => {
    dateMap[t.date] = { total: t.total, agents: {} };
  });
  byAgent.forEach(row => {
    if (dateMap[row.date]) {
      dateMap[row.date].agents[row.agent] = row.actions;
    }
  });
  
  // Find max for scaling
  const maxTotal = Math.max(...totals.map(t => t.total), 1);
  
  // Agent order for stacking
  const agentOrder = ['HUNTER', 'WRITER', 'RESEARCHER', 'OPERATOR', 'DEALMAKER'];
  
  // Generate bars
  const bars = totals.map(day => {
    const dateObj = new Date(day.date);
    const label = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
    const dayData = dateMap[day.date];
    
    // Stack bars for each agent
    const stacked = agentOrder.map(agent => {
      const count = dayData.agents[agent] || 0;
      const height = (count / maxTotal) * 100;
      const color = AGENT_COLORS[agent];
      return `<div class="graph-bar" style="background:${color};height:${height}%;width:100%"></div>`;
    }).join('');
    
    return `
      <div class="graph-bar-group">
        <div class="graph-stacked" style="height:80px">
          ${stacked}
        </div>
        <div class="graph-label">${label}</div>
      </div>
    `;
  }).join('');
  
  const legend = agentOrder.map(agent => {
    const color = AGENT_COLORS[agent];
    return `<span><span class="graph-legend-dot" style="background:${color}"></span>${agent}</span>`;
  }).join('');
  
  section.innerHTML = `
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">ACTIVITY (14 DAYS)</div>
    <div class="activity-graph">
      <div class="graph-row">${bars}</div>
      <div class="graph-legend">${legend}</div>
    </div>
  `;
}

function renderAlerts(data) {
  const section = document.getElementById('alertsSection');
  if (!section) return;
  
  const alerts = data.alerts || [];
  
  if (alerts.length === 0) {
    section.innerHTML = '';
    return;
  }
  
  const alertItems = alerts.map(alert => {
    const cssClass = alert.type === 'inactive' ? 'alert-inactive' : 'alert-failure';
    return `<div class="alert-item ${cssClass}">${alert.message}</div>`;
  }).join('');
  
  section.innerHTML = `
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">ALERTS</div>
    <div style="margin-bottom:32px">${alertItems}</div>
  `;
}

function renderActivityFeed(activities) {
  const section = document.getElementById('activityFeedSection');
  if (!section) return;
  
  const feed = activities.slice(0, 15); // Limit to 15
  
  if (feed.length === 0) {
    section.innerHTML = '';
    return;
  }
  
  // Helper: format time ago
  const timeAgo = (timestamp) => {
    const diff = Date.now() - new Date(timestamp).getTime();
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    if (days > 0) return `${days}d ago`;
    if (hours > 0) return `${hours}h ago`;
    return 'just now';
  };
  
  // Helper: format impact
  const formatImpact = (type, value) => {
    if (!type || value === 0) return '';
    if (type === 'revenue') return `+€${value}`;
    if (type === 'time_saved') return `+${value}min`;
    if (type === 'knowledge') return `+${value} findings`;
    if (type === 'content') return `+${value} items`;
    return `+${value}`;
  };
  
  // Helper: result badge
  const resultBadge = (result) => {
    const colors = {
      'success': '#4aa088',
      'failed': '#c47070',
      'partial': '#d4a853'
    };
    const color = colors[result] || '#8e8e8e';
    return `<span class="feed-result" style="background:${color}20;color:${color}">${result}</span>`;
  };
  
  const items = feed.map(item => {
    const agentColor = AGENT_COLORS[item.agent] || '#8e8e8e';
    const detail = item.detail.length > 80 ? item.detail.substring(0, 80) + '...' : item.detail;
    const impact = formatImpact(item.impact_type, item.impact_value);
    
    return `
      <div class="feed-item">
        <div class="feed-agent" style="color:${agentColor}">${item.agent}</div>
        <div class="feed-action">
          <strong>${item.action}</strong>: ${detail}
          ${impact ? `<span class="feed-impact">${impact}</span>` : ''}
        </div>
        ${resultBadge(item.result)}
        <div class="feed-time">${timeAgo(item.created_at)}</div>
      </div>
    `;
  }).join('');
  
  section.innerHTML = `
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">ACTIVITY FEED</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:32px">
      ${items}
    </div>
  `;
}

// ── Executive Tab Switcher ──

let execTab = 'florian';

function switchExecTab(tab) {
  execTab = tab;
  document.querySelectorAll('.exec-tab').forEach(t => t.classList.remove('active'));
  const clickedTab = Array.from(document.querySelectorAll('.exec-tab')).find(t => t.textContent === (tab === 'florian' ? 'Florian' : 'Mia + Team'));
  if (clickedTab) clickedTab.classList.add('active');
  
  const florianDiv = document.getElementById('execFlorian');
  const miaDiv = document.getElementById('execMia');
  if (florianDiv) florianDiv.style.display = tab === 'florian' ? 'block' : 'none';
  if (miaDiv) miaDiv.style.display = tab === 'mia' ? 'block' : 'none';
}

// ── Decisions ──

function renderDecisions(decisions) {
  const statsSection = document.getElementById('decisionStats');
  const decisionsSection = document.getElementById('recentDecisions');
  if (!decisionsSection) return;
  
  const today = new Date().toISOString().split('T')[0];
  const todayDecisions = decisions.filter(d => d.date === today);
  const totalDecisions = todayDecisions.length;
  const followed = todayDecisions.filter(d => d.recommendation_followed === 1).length;
  const followedPct = totalDecisions > 0 ? Math.round((followed / totalDecisions) * 100) : 0;
  
  if (statsSection && totalDecisions > 0) {
    statsSection.innerHTML = `
      <div class="stats-row">
        <div class="stats-item">
          <div class="stats-value">${totalDecisions}</div>
          <div class="stats-label">Today's Decisions</div>
        </div>
        <div class="stats-item">
          <div class="stats-value">${followedPct}%</div>
          <div class="stats-label">Mia Followed</div>
        </div>
        <div class="stats-item">
          <div class="stats-value">${totalDecisions - followed}</div>
          <div class="stats-label">Florian Pushback</div>
        </div>
      </div>
    `;
  }
  
  if (decisions.length === 0) {
    decisionsSection.innerHTML = '';
    return;
  }
  
  const items = decisions.slice(0, 10).map(d => {
    const followedClass = d.recommendation_followed === 1 ? 'decision-yes' : d.recommendation_followed === 0 ? 'decision-no' : 'decision-partial';
    const followedLabel = d.recommendation_followed === 1 ? 'FOLLOWED' : d.recommendation_followed === 0 ? 'OVERRIDDEN' : 'PARTIAL';
    const questionShort = d.question.length > 60 ? d.question.substring(0, 60) + '...' : d.question;
    
    return `
      <div class="decision-item">
        <div>
          <span class="decision-id">${d.decision_id}</span>
          <span class="decision-question">${questionShort}</span>
          <span class="decision-followed ${followedClass}">${followedLabel}</span>
        </div>
        <div class="decision-meta">
          Mia: ${d.mia_recommendation || '—'} → Florian: ${d.florian_decision || '—'}
          ${d.reason ? `<br><em>${d.reason}</em>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  decisionsSection.innerHTML = `
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">RECENT DECISIONS</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:32px">
      ${items}
    </div>
  `;
}

// ── Backlog ──

function renderBacklog(backlog) {
  const section = document.getElementById('backlogSection');
  if (!section) return;
  
  const priorityColors = {
    'NOW': '#c47070',
    'HIGH': '#d4a853',
    'NORMAL': '#8e8e8e',
    'LOW': '#555'
  };
  
  const items = backlog.map(item => {
    const priorityColor = priorityColors[item.priority] || '#8e8e8e';
    const agent = item.assigned_to || '—';
    
    const isStarted = item.status === 'started';
    return `
      <div class="backlog-item" style="${isStarted ? 'border-left:2px solid #4aa088;background:rgba(74,160,136,0.03)' : ''}">
        ${isStarted ? '<span style="width:6px;height:6px;border-radius:50%;background:#4aa088;flex-shrink:0;animation:pulse 2s infinite"></span>' : ''}
        <span class="backlog-priority" style="background:${priorityColor}20;color:${priorityColor}">${isStarted ? 'AKTIV' : item.priority}</span>
        <div class="backlog-desc">${item.description}</div>
        <span style="font-size:10px;color:var(--text-dim);width:80px;text-align:right">${agent}</span>
        <div class="backlog-actions">
          ${isStarted 
            ? `<button class="backlog-btn" style="color:#4aa088;border-color:#4aa088" onclick="completeBacklogItem(${item.id})" title="Als erledigt markieren">✓ Fertig</button>`
            : `<button class="backlog-btn" onclick="startBacklogItem(${item.id})" title="Jetzt daran arbeiten — wird als aktiv markiert">Starten</button>`}
          <button class="backlog-btn" onclick="deleteBacklogItem(${item.id})" title="Dauerhaft löschen">Löschen</button>
        </div>
      </div>
    `;
  }).join('');
  
  const content = backlog.length > 0 ? items : '<div style="text-align:center;padding:20px;color:var(--text-dim)">No backlog items</div>';
  
  section.innerHTML = `
    <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:12px">BACKLOG</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:32px">
      ${content}
      <div class="backlog-add">
        <input class="backlog-input" id="backlogInput" placeholder="+ Add to backlog (Enter to save)" onkeydown="if(event.key==='Enter')addBacklogItem()">
      </div>
    </div>
  `;
}

async function addBacklogItem() {
  const input = document.getElementById('backlogInput');
  if (!input || !input.value.trim()) return;
  
  try {
    await fetch(API + '/backlog', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: input.value.trim(), source: 'florian', priority: 'NORMAL' })
    });
    input.value = '';
    renderOperationsView();
  } catch (e) {
    console.error('Failed to add backlog item:', e);
  }
}

async function startBacklogItem(id) {
  try {
    await fetch(API + '/backlog/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'started' })
    });
    renderOperationsView();
  } catch (e) {
    console.error('Failed to start backlog item:', e);
  }
}

async function completeBacklogItem(id) {
  try {
    await fetch(API + '/backlog/' + id, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'done' })
    });
    showSystemMsg('Backlog-Item erledigt');
    renderOperationsView();
  } catch (e) {
    console.error('Failed to complete backlog item:', e);
  }
}

async function deleteBacklogItem(id) {
  try {
    await fetch(API + '/backlog/' + id, { method: 'DELETE' });
    renderOperationsView();
  } catch (e) {
    console.error('Failed to delete backlog item:', e);
  }
}

// Note: Running tasks rendering is placeholder - no active running tasks system yet
// This can be populated when sub-agent execution is tracked

function addGoal() {
  const description = prompt('Goal description:');
  if (!description) return;
  const target = parseInt(prompt('Target value:', '1'));
  if (!target || target < 1) return;
  
  fetch(API + '/executive/goals', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ description, target_value: target, current_value: 0 })
  })
  .then(() => renderOperationsView())
  .catch(e => console.error('Failed to add goal:', e));
}

function addGoalInline(input) {
  const desc = input.value.trim();
  if (!desc) return;
  const target = parseInt(prompt('Target value:', '1'));
  if (!target || target < 1) return;
  input.value = '';
  fetch(API + '/executive/goals', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ description: desc, target_value: target, current_value: 0 })
  }).then(() => renderOperationsView()).catch(e => console.error(e));
}

function updateGoalValue(goalId, newValue) {
  if (newValue < 0) newValue = 0;
  fetch(API + '/executive/goals/' + goalId, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ current_value: newValue })
  }).then(() => renderOperationsView()).catch(e => console.error(e));
}

async function toggleTaskStatus(taskId, status) {
  try {
    await fetch(API + `/standup/tasks/${taskId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    
    // Recalculate score
    await fetch(API + '/standup/recalc', { method: 'PUT' });
    
    // Reload view
    renderOperationsView();
    loadOperationsScore();
  } catch (e) {
    console.error('Failed to update task:', e);
  }
}

async function addTask() {
  const input = document.getElementById('newTaskInput');
  const description = input.value.trim();
  if (!description) return;
  
  const isSend = description.toLowerCase().includes('send') || description.toLowerCase().includes('email') || description.toLowerCase().includes('pitch');
  
  try {
    await fetch(API + '/standup/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description, is_send: isSend ? 1 : 0 })
    });
    
    input.value = '';
    renderOperationsView();
    loadOperationsScore();
  } catch (e) {
    console.error('Failed to add task:', e);
  }
}

async function addExtra() {
  const input = document.getElementById('newExtraInput');
  const description = input.value.trim();
  if (!description) return;
  
  const isSend = description.toLowerCase().includes('send') || description.toLowerCase().includes('email') || description.toLowerCase().includes('pitch');
  
  try {
    await fetch(API + '/standup/extra', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description, is_send: isSend ? 1 : 0 })
    });
    
    input.value = '';
    
    // Recalculate score
    await fetch(API + '/standup/recalc', { method: 'PUT' });
    
    renderOperationsView();
    loadOperationsScore();
  } catch (e) {
    console.error('Failed to add extra:', e);
  }
}

// ── STAGE DETAIL VIEW ──
let stageSortBy = 'confidence'; // confidence | date | compound
let stageFilterTag = null;

async function renderStageView(stage) {
  const stageView = document.getElementById('stageView');
  stageView.innerHTML = '<div class="loading">Loading findings...</div>';
  
  try {
    const findings = await fetch(API + '/findings?status=alive').then(r => r.json());
    const stageFindings = findings.filter(f => f.stage === stage);
    
    // Stage config
    const stageConfig = {
      research: {
        name: 'Research',
        icon: 'R',
        color: '#8e8e8e',
        emptyText: 'No research findings yet. Start by capturing hypotheses and learnings.'
      },
      systems: {
        name: 'Systems',
        icon: 'S',
        color: '#6b8aab',
        emptyText: 'No systems findings yet. Promote validated research findings here.'
      },
      content: {
        name: 'Content',
        icon: 'C',
        color: '#9b8ec4',
        emptyText: 'No content findings yet. Promote system insights ready for publication.'
      },
      revenue: {
        name: 'Revenue',
        icon: '€',
        color: '#d4a853',
        emptyText: 'No revenue-linked findings yet. Promote content findings here when they generate value.'
      }
    };
    
    const config = stageConfig[stage] || stageConfig.research;
    
    // Calculate metrics
    const totalCount = stageFindings.length;
    const avgConf = totalCount > 0 ? stageFindings.reduce((s, f) => s + f.confidence, 0) / totalCount : 0;
    const unverifiedCount = stageFindings.filter(f => !f.verified).length;
    
    // Stage-specific metrics
    let metric3Val = 0, metric3Label = '';
    if (stage === 'research') {
      metric3Val = stageFindings.filter(f => (f.tags || []).includes('hypothesis')).length;
      metric3Label = 'Hypotheses';
    } else if (stage === 'systems') {
      metric3Val = stageFindings.filter(f => (f.tags || []).includes('implemented')).length;
      metric3Label = 'Implemented';
    } else if (stage === 'content') {
      metric3Val = stageFindings.filter(f => (f.tags || []).includes('published')).length;
      metric3Label = 'Published';
    } else if (stage === 'revenue') {
      metric3Val = stageFindings.filter(f => (f.tags || []).includes('revenue')).length;
      metric3Label = 'Revenue Linked';
    }
    
    // Collect all tags
    const allTags = new Set();
    stageFindings.forEach(f => (f.tags || []).forEach(t => allTags.add(t)));
    
    // Sort findings
    let sortedFindings = [...stageFindings];
    if (stageSortBy === 'confidence') {
      sortedFindings.sort((a, b) => b.confidence - a.confidence);
    } else if (stageSortBy === 'date') {
      sortedFindings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    } else if (stageSortBy === 'compound') {
      sortedFindings.sort((a, b) => (b.compound_score || 0) - (a.compound_score || 0));
    }
    
    // Filter by tag
    if (stageFilterTag) {
      sortedFindings = sortedFindings.filter(f => (f.tags || []).includes(stageFilterTag));
    }
    
    // Group by research_line for Systems stage
    let groupedFindings = {};
    if (stage === 'systems') {
      sortedFindings.forEach(f => {
        const line = f.research_line || 'uncategorized';
        if (!groupedFindings[line]) groupedFindings[line] = [];
        groupedFindings[line].push(f);
      });
    }
    
    // Build HTML
    let html = `<div class="stage-header">
      <div class="stage-header-top">
        <div class="stage-title">
          <div class="stage-icon" style="border-color:${config.color};color:${config.color}">${config.icon}</div>
          <span>${config.name} Stage</span>
        </div>
        <div class="stage-metrics">
          <div class="stage-metric">
            <div class="stage-metric-val" style="color:${config.color}">${totalCount}</div>
            <div class="stage-metric-label">Total</div>
          </div>
          <div class="stage-metric">
            <div class="stage-metric-val">${Math.round(avgConf * 100)}%</div>
            <div class="stage-metric-label">Avg Confidence</div>
          </div>
          <div class="stage-metric">
            <div class="stage-metric-val">${unverifiedCount}</div>
            <div class="stage-metric-label">Unverified</div>
          </div>
          <div class="stage-metric">
            <div class="stage-metric-val">${metric3Val}</div>
            <div class="stage-metric-label">${metric3Label}</div>
          </div>
        </div>
      </div>
      <div class="stage-controls">
        <span style="font-size:10px;color:var(--text-dim);margin-right:4px">Sort:</span>
        <button class="stage-sort ${stageSortBy === 'confidence' ? 'active' : ''}" onclick="setStageSortBy('confidence','${stage}')">Confidence</button>
        <button class="stage-sort ${stageSortBy === 'date' ? 'active' : ''}" onclick="setStageSortBy('date','${stage}')">Date</button>
        <button class="stage-sort ${stageSortBy === 'compound' ? 'active' : ''}" onclick="setStageSortBy('compound','${stage}')">Compound</button>
        ${allTags.size > 0 ? `<span style="margin-left:12px;font-size:10px;color:var(--text-dim);margin-right:4px">Filter:</span>` : ''}
        ${Array.from(allTags).slice(0, 8).map(tag => 
          `<button class="stage-filter ${stageFilterTag === tag ? 'active' : ''}" onclick="setStageFilterTag('${tag}','${stage}')">${tag}</button>`
        ).join('')}
        ${stageFilterTag ? `<button class="stage-filter" onclick="setStageFilterTag(null,'${stage}')" style="color:var(--danger)">Clear</button>` : ''}
      </div>
    </div>`;
    
    // Empty state
    if (sortedFindings.length === 0) {
      html += `<div class="stage-empty">
        <div class="stage-empty-icon">◇</div>
        <div class="stage-empty-text">${config.emptyText}</div>
      </div>`;
      stageView.innerHTML = html;
      return;
    }
    
    // Findings list (grouped for Systems, flat for others)
    html += '<div class="stage-findings">';
    
    if (stage === 'systems' && Object.keys(groupedFindings).length > 1) {
      // Systems: grouped by research_line
      Object.entries(groupedFindings).sort((a, b) => b[1].length - a[1].length).forEach(([line, lineFindings]) => {
        const lineName = line.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        html += `<div class="stage-rl-group">
          <div class="stage-rl-header" onclick="this.parentElement.classList.toggle('collapsed')">
            <span class="stage-rl-name">${lineName}</span>
            <span class="stage-rl-count">${lineFindings.length} findings</span>
          </div>
          <div class="stage-rl-body">`;
        lineFindings.forEach(f => { html += renderStageFindingCard(f, stage, config.color); });
        html += `</div></div>`;
      });
    } else {
      // Flat list
      sortedFindings.forEach(f => { html += renderStageFindingCard(f, stage, config.color); });
    }
    
    html += '</div>';
    
    stageView.innerHTML = html;
    
  } catch (e) {
    stageView.innerHTML = `<div style="padding:40px;text-align:center;color:var(--danger)">Error loading findings: ${e.message}</div>`;
  }
}

function renderStageFindingCard(f, stage, stageColor) {
  const confPct = Math.round(f.confidence * 100);
  const confColor = confPct >= 70 ? '#4aa088' : confPct >= 30 ? 'var(--warm)' : 'var(--danger)';
  const claimPreview = f.claim.length > 100 ? f.claim.substring(0, 100) + '...' : f.claim;
  const date = new Date(f.created_at).toLocaleDateString('de-DE', {month: 'short', day: 'numeric', year: 'numeric'});
  
  // Stage-specific actions
  let actions = '';
  if (stage === 'research') {
    const verifyBtn = f.verified 
      ? `<button class="stage-action-btn" style="color:#4aa088;pointer-events:none;opacity:0.7" disabled>✓ Verified${f.verified_at ? ' · ' + new Date(f.verified_at).toLocaleDateString('de-DE') : ''}</button>`
      : `<button class="stage-action-btn" id="verify-btn-${f.id}" onclick="event.stopPropagation();verifyFindingInline('${f.id}',this)" title="Bestätigt: Ich habe dieses Finding geprüft und es ist korrekt.">✓ Bestätigen</button>`;
    actions = `
      ${verifyBtn}
      <button class="stage-action-btn primary" id="promote-btn-${f.id}" onclick="event.stopPropagation();promoteFinding('${f.id}','systems')" title="Dieses Finding ist validiert und wird zur Umsetzung in Systems weitergeleitet. Erfordert: Evidence-Type, Quelle, und 'So What'.">→ Weiter zu Systems</button>
      <button class="stage-action-btn danger" id="contest-btn-${f.id}" onclick="event.stopPropagation();contestFinding('${f.id}')" title="Ich bezweifle dieses Finding. Es wird als 'angefochten' markiert und du wirst nach dem Grund gefragt.">Anfechten</button>
    `;
  } else if (stage === 'systems') {
    actions = `
      <button class="stage-action-btn" onclick="event.stopPropagation();markImplemented('${f.id}')" title="Dieses Finding wurde in ein System/Feature umgesetzt. Markiert es als implementiert.">✓ Implementiert</button>
      <button class="stage-action-btn primary" onclick="event.stopPropagation();promoteFinding('${f.id}','content')" title="Dieses System-Finding ist bereit für Veröffentlichung als Artikel, Post oder Dokumentation.">→ Weiter zu Content</button>
    `;
  } else if (stage === 'content') {
    actions = `
      <button class="stage-action-btn" onclick="event.stopPropagation();writeDraft('${f.id}')" title="Erstellt einen Content-Entwurf basierend auf diesem Finding.">Entwurf schreiben</button>
      <button class="stage-action-btn" onclick="event.stopPropagation();markPublished('${f.id}')" title="Dieses Finding wurde als Artikel/Post veröffentlicht.">✓ Veröffentlicht</button>
      <button class="stage-action-btn primary" onclick="event.stopPropagation();promoteFinding('${f.id}','revenue')" title="Dieser Content hat messbar zu Revenue beigetragen (Lead, Sale, Anfrage).">→ Weiter zu Revenue</button>
    `;
  } else if (stage === 'revenue') {
    actions = `
      <button class="stage-action-btn" onclick="event.stopPropagation();logRevenue('${f.id}')" title="Erfasse den konkreten Umsatz der durch dieses Finding generiert wurde.">€ Umsatz erfassen</button>
      <button class="stage-action-btn" onclick="event.stopPropagation();attributeFinding('${f.id}')" title="Verknüpfe diesen Umsatz mit dem ursprünglichen Finding.">Zuordnen</button>
    `;
  }
  
  return `<div class="stage-finding-card" onclick="toggleStageFinding(this,'${f.id}')">
    <div class="stage-finding-header">
      <div class="stage-finding-left">
        <div class="stage-finding-id">#${f.id}</div>
        <div class="stage-finding-claim">${esc(claimPreview)}</div>
        ${f.so_what ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px">→ ${f.so_what.substring(0,100)}${f.so_what.length>100?'...':''}</div>` : ''}
        <div class="stage-finding-meta">
          <span class="stage-tag" style="border-color:${stageColor}30;color:${stageColor}">${f.source_type || 'unknown'}</span>
          <span>${date}</span>
          ${f.verified ? '<span style="color:#4aa088">✓ Verified</span>' : ''}
          ${(f.tags || []).slice(0, 3).map(t => `<span class="stage-tag">${t}</span>`).join('')}
        </div>
      </div>
      <div class="stage-finding-right">
        <div class="stage-conf-bar">
          <div class="stage-conf-fill" style="width:${confPct}%;background:${confColor}"></div>
        </div>
        <span style="font-size:10px;font-weight:600;color:${confColor}">${confPct}%</span>
        <span class="evidence-badge evidence-${f.evidence_type || 'none'}">${f.evidence_type || '?'}</span>
        <span class="impact-badge impact-${f.impact || 'MEDIUM'}">${f.impact || 'MEDIUM'}</span>
      </div>
    </div>
    <div class="stage-finding-detail" id="stage-finding-detail-${f.id}" onclick="event.stopPropagation()">
      <div><strong>Vollständig:</strong><br>${esc(f.claim)}</div>
      ${f.context ? `<div style="margin-top:8px"><strong>Belege:</strong><br>${esc(f.context)}</div>` : ''}
      ${f.research_line ? `<div style="margin-top:8px"><strong>Forschungslinie:</strong> ${f.research_line.replace(/-/g, ' ')}</div>` : ''}
      <div style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <label style="font-size:9px;color:var(--text-dim)">Evidenz:
          <select style="font-size:11px;background:var(--surface-2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:4px 8px;cursor:pointer;min-width:180px" onchange="updateFindingField('${f.id}','evidence_type',this.value)">
            <option value="">— Auswählen —</option>
            <option value="E" ${f.evidence_type==='E'?'selected':''}>E — Studien, Benchmarks</option>
            <option value="I" ${f.evidence_type==='I'?'selected':''}>I — Analysten, Marktdaten</option>
            <option value="J" ${f.evidence_type==='J'?'selected':''}>J — Berichterstattung, Quellen</option>
            <option value="A" ${f.evidence_type==='A'?'selected':''}>A — Erfahrung, Schätzung</option>
          </select>
        </label>
        <label style="font-size:9px;color:var(--text-dim)">Impact:
          <select style="font-size:11px;background:var(--surface-2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:4px 8px;cursor:pointer;min-width:120px" onchange="updateFindingField('${f.id}','impact',this.value)">
            <option value="LOW" ${f.impact==='LOW'?'selected':''}>Niedrig</option>
            <option value="MEDIUM" ${(f.impact||'MEDIUM')==='MEDIUM'?'selected':''}>Mittel</option>
            <option value="HIGH" ${f.impact==='HIGH'?'selected':''}>Hoch</option>
            <option value="CRITICAL" ${f.impact==='CRITICAL'?'selected':''}>Kritisch</option>
          </select>
        </label>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-size:9px;color:var(--text-dim)">BEDEUTUNG (Was folgt daraus?)</span>
          ${!f.so_what ? `<button style="font-size:9px;background:transparent;border:1px solid var(--border);border-radius:3px;color:var(--warm);padding:2px 8px;cursor:pointer" onclick="generateSoWhat('${f.id}')">AI: Generieren</button>` : ''}
        </div>
        <div id="so-what-${f.id}" style="font-size:11px;color:var(--text-muted);padding:6px 8px;background:var(--surface);border:1px solid var(--border);border-radius:4px;min-height:30px">${f.so_what ? esc(f.so_what) : '<span style="color:var(--text-dim);font-style:italic">Noch nicht analysiert</span>'}</div>
      </div>
      ${f.topic_id ? `<div style="margin-top:8px"><a href="#" onclick="event.stopPropagation();event.preventDefault();hideStageView();selectTopic('${f.topic_id}');toggleCtx()" style="font-size:10px;color:var(--warm);text-decoration:none">→ Zum Topic (Dokumente, Referenzen, Details)</a></div>` : ''}
      <div class="stage-finding-actions" style="margin-top:12px">${actions}</div>
    </div>
  </div>`;
}

async function toggleStageFinding(el, findingId) {
  // Collapse all others
  document.querySelectorAll('.stage-finding-card.expanded').forEach(c => {
    if (c !== el) c.classList.remove('expanded');
  });
  el.classList.toggle('expanded');
  // Show gate status when expanding
  if (el.classList.contains('expanded')) {
    try {
      const gateRes = await fetch(API + '/findings/' + findingId + '/gate').then(r => r.json());
      const detail = el.querySelector('.stage-finding-detail');
      if (detail && !detail.querySelector('.gate-status')) {
        let gateHtml = '<div class="gate-status ' + (gateRes.can_promote ? 'gate-ready' : 'gate-blocked') + '">';
        if (gateRes.checks && gateRes.checks.length) {
          gateRes.checks.forEach(c => {
            gateHtml += '<div class="gate-check ' + (c.passed ? 'gate-pass' : 'gate-fail') + '">' +
              (c.passed ? '✓' : '✗') + ' ' + c.name + ': ' + c.actual + ' (need ' + c.required + ')</div>';
          });
        } else {
          gateHtml += '<div class="gate-check" style="color:var(--text-dim)">Final stage — no promotion gate</div>';
        }
        gateHtml += '</div>';
        const actionsDiv = detail.querySelector('.stage-finding-actions');
        if (actionsDiv) actionsDiv.insertAdjacentHTML('beforebegin', gateHtml);
      }
    } catch(e) {}
  }
}

function setStageSortBy(sortBy, stage) {
  stageSortBy = sortBy;
  renderStageView(stage);
}

function setStageFilterTag(tag, stage) {
  stageFilterTag = tag;
  renderStageView(stage);
}

async function generateSoWhat(findingId) {
  const el = document.getElementById('so-what-' + findingId);
  if (!el) return;
  el.innerHTML = '<span style="color:var(--warm)">Analysiere...</span>';
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const prompt = `Analysiere dieses Finding und beantworte in 1-2 Sätzen: Was bedeutet das konkret? Welche Handlung folgt daraus?\n\nFinding: ${finding.claim}\nConfidence: ${Math.round((finding.confidence||0)*100)}%\nTags: ${(finding.tags||[]).join(', ')}`;
    const res = await fetch(API + '/mia/execute', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message: prompt, topic_id: null})
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let soWhat = '';
    while (true) {
      const {done, value: chunk} = await reader.read();
      if (done) break;
      const text = decoder.decode(chunk);
      const lines = text.split('\n');
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          try {
            const d = JSON.parse(line.slice(6));
            if (d.token) soWhat += d.token;
            if (d.content) soWhat = d.content;
          } catch(e) {}
        }
      }
    }
    soWhat = soWhat.trim();
    if (soWhat) {
      el.textContent = soWhat;
      await fetch(API + '/findings/' + findingId, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({so_what: soWhat})
      });
      showSystemMsg('Bedeutung generiert für ' + findingId);
    } else {
      el.innerHTML = '<span style="color:var(--text-dim);font-style:italic">Konnte nicht generiert werden</span>';
    }
  } catch(e) {
    el.innerHTML = '<span style="color:var(--danger)">Fehler: ' + e.message + '</span>';
  }
}

async function updateFindingField(id, field, value) {
  await fetch(API + '/findings/' + id, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({[field]: value})
  });
  showSystemMsg(`${field} updated to "${value}"`);
  // Don't re-render — would collapse the expanded card
}

async function verifyFindingInline(findingId, btn) {
  try {
    const res = await fetch(API + '/findings/' + findingId + '/verify', { method: 'POST' });
    const data = await res.json();
    showSystemMsg(`Finding ${findingId} verified`);
    if (btn) {
      btn.textContent = '✓ Verified' + (data.verified_at ? ' · ' + new Date(data.verified_at).toLocaleDateString('de-DE') : '');
      btn.style.color = '#4aa088';
      btn.style.pointerEvents = 'none';
      btn.style.opacity = '0.7';
    }
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function promoteFinding(findingId, targetStage) {
  try {
    // Check gate first
    const gateRes = await fetch(API + '/findings/' + findingId + '/gate').then(r => r.json());
    if (!gateRes.can_promote) {
      const fails = (gateRes.checks || []).filter(c => !c.passed).map(c => `${c.name}: ${c.actual} (need ${c.required})`).join(', ');
      showSystemMsg(`Gate blocked for ${findingId}: ${fails}`);
      return;
    }
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ stage: targetStage })
    });
    showSystemMsg(`Finding ${findingId} promoted to ${targetStage}`);
    if (activeStageFilter) renderStageView(activeStageFilter);
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function contestFinding(findingId) {
  const reason = prompt('Why are you contesting this finding?');
  if (!reason) return;
  try {
    await fetch(API + '/findings/' + findingId + '/validate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ direction: 'contradict', reason, source_type: 'own_data', killed_by: reason })
    });
    // Also update status with killed_by
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'contested', killed_by: reason })
    });
    showSystemMsg(`Finding ${findingId} contested`);
    // Visual feedback without reload
    const card = document.querySelector(`[onclick*="'${findingId}'"]`);
    if (card) {
      card.style.borderLeftColor = '#c47070';
      const claim = card.querySelector('.stage-finding-claim');
      if (claim) {
        const contestDiv = document.createElement('div');
        contestDiv.style.cssText = 'font-size:10px;color:#c47070;margin-top:4px';
        contestDiv.textContent = 'Contested: ' + reason;
        claim.after(contestDiv);
      }
      // Disable verify and promote buttons
      const verifyBtn = document.getElementById('verify-btn-' + findingId);
      const promoteBtn = document.getElementById('promote-btn-' + findingId);
      const contestBtn = document.getElementById('contest-btn-' + findingId);
      if (verifyBtn) { verifyBtn.disabled = true; verifyBtn.style.opacity = '0.3'; verifyBtn.style.pointerEvents = 'none'; }
      if (promoteBtn) { promoteBtn.disabled = true; promoteBtn.style.opacity = '0.3'; promoteBtn.style.pointerEvents = 'none'; }
      if (contestBtn) { contestBtn.disabled = true; contestBtn.style.opacity = '0.3'; contestBtn.style.pointerEvents = 'none'; }
    }
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function markImplemented(findingId) {
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const tags = [...(finding.tags || [])];
    if (!tags.includes('implemented')) tags.push('implemented');
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tags })
    });
    showSystemMsg(`Finding ${findingId} marked as implemented`);
    if (activeStageFilter) renderStageView(activeStageFilter);
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function writeDraft(findingId) {
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const resp = await fetch(API + '/mia/execute', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        task: 'write_content_draft',
        context: { finding_id: findingId, claim: finding.claim, context: finding.context }
      })
    });
    if (resp.ok) {
      showSystemMsg(`Draft request queued for finding ${findingId}`);
    } else {
      showSystemMsg('Draft generation failed');
    }
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function markPublished(findingId) {
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const tags = [...(finding.tags || [])];
    if (!tags.includes('published')) tags.push('published');
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tags })
    });
    showSystemMsg(`Finding ${findingId} marked as published`);
    if (activeStageFilter) renderStageView(activeStageFilter);
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function logRevenue(findingId) {
  const amount = prompt('Revenue amount (EUR):');
  if (!amount) return;
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const tags = [...(finding.tags || [])];
    if (!tags.includes('revenue')) tags.push('revenue');
    const context = (finding.context || '') + `\n\n[Revenue logged: €${amount} on ${new Date().toISOString().split('T')[0]}]`;
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tags, context })
    });
    showSystemMsg(`Revenue €${amount} logged for finding ${findingId}`);
    if (activeStageFilter) renderStageView(activeStageFilter);
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

async function attributeFinding(findingId) {
  const attribution = prompt('Attribute to (e.g., client name, project):');
  if (!attribution) return;
  try {
    const finding = await fetch(API + '/findings/' + findingId).then(r => r.json());
    const context = (finding.context || '') + `\n\n[Attributed to: ${attribution}]`;
    await fetch(API + '/findings/' + findingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ context })
    });
    showSystemMsg(`Finding ${findingId} attributed to ${attribution}`);
    if (activeStageFilter) renderStageView(activeStageFilter);
  } catch (e) {
    showSystemMsg('Error: ' + e.message);
  }
}

// ── FOLDER TREE ──
async function loadFolderTree() {
  const [folders, topics] = await Promise.all([
    fetch(API+'/folders').then(r=>r.json()),
    fetch(API+'/topics').then(r=>r.json())
  ]);
  foldersCache = folders;
  topicsCache = {};
  topics.forEach(t => topicsCache[t.id] = t);
  window._allTopics = topics; // Cache for Cmd+K
  
  // Filter by stage if active
  const filteredTopics = activeStageFilter 
    ? topics.filter(t => t.stage === activeStageFilter) 
    : topics;
  
  const el = document.getElementById('folderTree');
  let html = '';
  
  // Priority sorting mode
  if (sortMode === 'priority') {
    const priorityOrder = ['NOW', 'HIGH', 'NORMAL', 'LOW'];
    const topicsByPriority = {NOW: [], HIGH: [], NORMAL: [], LOW: []};
    
    filteredTopics.forEach(t => {
      const priority = t.priority || 'NORMAL';
      if (topicsByPriority[priority]) {
        topicsByPriority[priority].push(t);
      } else {
        topicsByPriority['NORMAL'].push(t);
      }
    });
    
    // Render groups
    priorityOrder.forEach(priority => {
      const items = topicsByPriority[priority];
      if (items.length > 0) {
        html += `<div class="priority-group-header">── ${priority} ──</div>`;
        items.forEach(t => { html += renderTopicItem(t); });
      }
    });
    
    el.innerHTML = html;
    return;
  }
  
  // Folder sorting mode (original logic)
  const topicsByFolder = {};
  const unfiled = [];
  filteredTopics.forEach(t => {
    if (t.folder_id) {
      if (!topicsByFolder[t.folder_id]) topicsByFolder[t.folder_id] = [];
      topicsByFolder[t.folder_id].push(t);
    } else {
      unfiled.push(t);
    }
  });
  // Sort within folders
  Object.values(topicsByFolder).forEach(arr => arr.sort((a,b) => (a.folder_position||0) - (b.folder_position||0)));
  
  // Build tree (only root folders for now, nested later)
  const rootFolders = folders.filter(f => !f.parent_id).sort((a,b) => a.position - b.position);
  const childFolders = folders.filter(f => f.parent_id);
  
  function renderFolder(f, depth=0) {
    const items = topicsByFolder[f.id] || [];
    const children = childFolders.filter(c => c.parent_id === f.id).sort((a,b) => a.position - b.position);
    const count = items.length + children.reduce((s,c) => s + (topicsByFolder[c.id]||[]).length, 0);
    const isCollapsed = f.collapsed;
    const colorStyle = f.color ? `color:${f.color}` : '';
    
    html += `<div class="folder${isCollapsed?' collapsed':''}" data-folder-id="${f.id}">
      <div class="folder-head${currentFolder===f.id?' active':''}" 
           onclick="toggleFolder('${f.id}')"
           ondragover="folderDragOver(event,'${f.id}')" ondrop="folderDrop(event,'${f.id}')" ondragleave="folderDragLeave(event)">
        <span class="folder-chevron">▼</span>
        <div class="folder-icon" style="${colorStyle}">${f.icon||'F'}</div>
        <span class="folder-name">${f.name}</span>
        <span class="folder-count">${count}</span>
        <div class="folder-actions">
          <span class="folder-action" onclick="event.stopPropagation();renameFolder('${f.id}')" title="Rename">✎</span>
          <span class="folder-action" onclick="event.stopPropagation();deleteFolder('${f.id}')" title="Delete">✕</span>
        </div>
      </div>
      <div class="folder-children">
        <div class="folder-drop-zone" data-folder="${f.id}" ondragover="zoneDragOver(event)" ondrop="zoneDrop(event,'${f.id}')" ondragleave="zoneDragLeave(event)"></div>`;
    
    children.forEach(c => renderFolder(c, depth+1));
    items.forEach(t => { html += renderTopicItem(t); });
    
    html += `</div></div>`;
  }
  
  rootFolders.forEach(f => renderFolder(f));
  
  // Unfiled topics
  if (unfiled.length) {
    html += `<div class="unfiled-label">Unsortiert</div>`;
    unfiled.forEach(t => { html += renderTopicItem(t); });
  }
  
  el.innerHTML = html;
}

function renderTopicItem(t) {
  const isActive = currentTopic === t.id;
  const priority = t.priority || 'NORMAL';
  let priorityBadge = '';
  if (priority === 'NOW') {
    priorityBadge = '<span class="priority-badge NOW">NOW</span>';
  } else if (priority === 'HIGH') {
    priorityBadge = '<span class="priority-badge HIGH">HIGH</span>';
  } else if (priority === 'LOW') {
    priorityBadge = '<span class="priority-badge LOW">LOW</span>';
  }
  
  return `<div class="folder-topic${isActive?' active':''}" 
              draggable="true" data-topic-id="${t.id}"
              ondragstart="topicDragStart(event,'${t.id}')" ondragend="topicDragEnd(event)"
              onclick="selectTopic('${t.id}')">
    <div class="folder-topic-dot${t.progress<20?' unread':''}"></div>
    <span class="folder-topic-name">${t.name}</span>
    ${priorityBadge}
    <span class="folder-topic-pct">${t.progress}%</span>
  </div>`;
}

// ── SORT MODE ──
function setSortMode(mode) {
  sortMode = mode;
  document.getElementById('sortFolders').classList.toggle('active', mode === 'folders');
  document.getElementById('sortPriority').classList.toggle('active', mode === 'priority');
  loadFolderTree();
}

// ── PRIORITY ──
function togglePriorityExplanation() {
  const el = document.getElementById('priorityExplanation');
  if (el) el.classList.toggle('open');
}

// ── FOLDER ACTIONS ──
async function toggleFolder(folderId) {
  const el = document.querySelector(`[data-folder-id="${folderId}"]`);
  if (!el) return;
  const isCollapsed = el.classList.toggle('collapsed');
  await fetch(API+'/folders/'+folderId, {
    method:'PATCH', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({collapsed: isCollapsed})
  });
}

async function startAddFolder() {
  const name = prompt('Ordner-Name:');
  if (!name) return;
  const id = name.toLowerCase().replace(/[^a-z0-9]/g,'-').replace(/-+/g,'-');
  await fetch(API+'/folders', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id, name})
  });
  loadFolderTree();
}

async function renameFolder(folderId) {
  const f = foldersCache.find(f => f.id === folderId);
  const name = prompt('Neuer Name:', f?.name || '');
  if (!name) return;
  await fetch(API+'/folders/'+folderId, {
    method:'PATCH', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name})
  });
  loadFolderTree();
}

async function deleteFolder(folderId) {
  if (!confirm('Ordner löschen? Topics werden nicht gelöscht.')) return;
  await fetch(API+'/folders/'+folderId, {method:'DELETE'});
  loadFolderTree();
}

// ── DRAG & DROP ──
function topicDragStart(e, topicId) {
  draggedTopicId = topicId;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', topicId);
}

function topicDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedTopicId = null;
  document.querySelectorAll('.folder-drop-zone.over').forEach(z => z.classList.remove('over'));
}

function folderDragOver(e, folderId) {
  e.preventDefault();
  e.currentTarget.style.background = 'rgba(212,168,83,0.06)';
}

function folderDragLeave(e) {
  e.currentTarget.style.background = '';
}

async function folderDrop(e, folderId) {
  e.preventDefault();
  e.currentTarget.style.background = '';
  if (!draggedTopicId) return;
  await fetch(API+'/topics/'+draggedTopicId+'/move', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({folder_id: folderId, position: 0})
  });
  loadFolderTree();
}

function zoneDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
function zoneDragLeave(e) { e.currentTarget.classList.remove('over'); }
async function zoneDrop(e, folderId) {
  e.preventDefault(); e.currentTarget.classList.remove('over');
  if (!draggedTopicId) return;
  await fetch(API+'/topics/'+draggedTopicId+'/move', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({folder_id: folderId, position: 0})
  });
  loadFolderTree();
}

// ── SELECT TOPIC ──
async function selectTopic(id) {
  currentTopic = id;
  // Close special views - restore topics view elements if needed
  if (VIEW.current !== 'topics') {
    const stageView = document.getElementById('stageView');
    const opsView = document.getElementById('operationsView');
    const pipelineView = document.getElementById('pipelineView');
    const principlesView = document.getElementById('principlesView');
    stageView.classList.remove('open');
    if (opsView) opsView.style.display = 'none';
    if (pipelineView) pipelineView.style.display = 'none';
    if (principlesView) principlesView.style.display = 'none';
    document.getElementById('conv').style.display = '';
    const steps = document.getElementById('stepsBar');
    if (steps) steps.style.display = '';
    const input = document.querySelector('.input-area');
    if (input) input.style.display = '';
    document.getElementById('ctxPanel').style.display = '';
    document.querySelectorAll('.pipe-stage').forEach(s => s.classList.remove('active'));
    operationsViewOpen = false;
    pipelineViewOpen = false;
    principlesViewOpen = false;
    stageViewOpen = false;
    activeStageFilter = null;
    VIEW.current = 'topics';
    VIEW.stage = null;
    VIEW.contextMode = 'topic';
    updateHeaderButtons();
  }
  // Highlight in list
  document.querySelectorAll('.topic-item').forEach(t=>t.classList.remove('active'));
  const items = document.querySelectorAll('.topic-item');
  items.forEach(t => { if(t.onclick.toString().includes(id)) t.classList.add('active'); });
  
  // Load full topic
  const topic = await fetch(API+'/topics/'+id).then(r=>r.json());
  const meta = JSON.parse(topic.meta||'{}');
  
  // Header
  const priority = topic.priority || 'NORMAL';
  const priorityClass = priority === 'NOW' ? 'NOW' : priority === 'HIGH' ? 'HIGH' : priority === 'LOW' ? 'LOW' : '';
  const priorityBadge = priorityClass ? `<span class="priority-badge-lg ${priorityClass}">${priority}</span>` : '';
  
  document.getElementById('topicTitle').innerHTML = topic.name + ' <span id="preflightBadge"></span>';
  
  let subHtml = topic.stage + (meta.contact?' · '+meta.contact:'') + (meta.email?' · '+meta.email:'') + (meta.potential?' · '+meta.potential:'');
  
  // Add priority display
  if (priority && priority !== 'NORMAL') {
    const confidence = topic.priority_confidence || 50;
    const reason = topic.priority_reason || 'Auto-calculated';
    subHtml += `<div class="topic-priority" onclick="togglePriorityExplanation()">
      ${priorityBadge}
      <span class="priority-conf">Confidence: ${confidence}%</span>
    </div>
    <div class="priority-explanation" id="priorityExplanation">
      <div style="font-size:11px;color:var(--text-muted);padding:8px 0;border-bottom:1px solid var(--border);margin-bottom:8px">
        ${reason}
      </div>
      <div style="font-size:10px;color:var(--text-dim)">
        Click priority to override manually
      </div>
    </div>`;
  }
  
  document.getElementById('topicSub').innerHTML = subHtml;
  
  // Load pre-flight check
  loadPreflight(topic.id);
  
  // Show Generate CV button for fund topics
  const cvFunds = ['betaworks','bloomberg','bloomberg-beta','conviction','firstmark','generalcatalyst','glasswing','insight','lionheart','lux','point72','ibm-ventures','futuresight'];
  const cvBtn = document.getElementById('genCvBtn');
  cvBtn.style.display = cvFunds.includes(id) ? 'inline-block' : 'none';
  
  // Steps
  renderSteps(topic.steps);
  
  // Messages
  renderMessages(topic.messages);
  
  // Context panel
  renderContext(topic);
  
  // Action bar (guardrails)
  renderActionBar(topic);
  
  // Re-highlight active topic
  loadFolderTree();
}

// ── STEPS ──
function renderSteps(steps) {
  const el = document.getElementById('stepsBar');
  if (!steps.length) { el.innerHTML = ''; return; }
  
  // Find first undone step
  const currentIdx = steps.findIndex(s => !s.done);
  
  el.innerHTML = steps.map((s, i) => {
    const isDone = s.done;
    const isCurrent = i === currentIdx;
    const cls = isDone ? 'done' : (isCurrent ? 'now' : '');
    const check = isDone ? '&#10003;' : (i+1);
    const lineClass = i > 0 ? (steps[i-1].done ? 'done' : '') : '';
    const line = i > 0 ? `<div class="sline ${lineClass}"></div>` : '';
    return `${line}<div class="sn"><div class="sc ${cls}" onclick="toggleStep(${s.id})">${check}</div><span class="sl ${cls}">${s.label}</span></div>`;
  }).join('');
}

async function toggleStep(stepId) {
  await fetch(API+'/steps/'+stepId, {method:'PATCH'});
  if (currentTopic) selectTopic(currentTopic);
}

// ── MESSAGES ──
function renderMessages(messages) {
  const el = document.getElementById('conv');
  if (!messages.length) {
    el.innerHTML = '<div class="msg system"><div class="bubble">No messages yet. Start the conversation below.</div></div>';
    return;
  }
  
  el.innerHTML = messages.map(m => {
    const cls = m.sender === 'mia' ? 'mia' : (m.sender === 'system' ? 'system' : 'human');
    let proposalHtml = '';
    
    if (m.proposals && m.proposals.length) {
      m.proposals.forEach(p => {
        const options = p.options || [];
        const votes = p.votes || {};
        const hasVoted = (votes.up||0) + (votes.down||0) > 0;
        
        proposalHtml += `<div class="proposal">
          <div class="proposal-head">
            <span class="proposal-type">${p.proposal_type}</span>
            ${p.confidence ? `<span class="proposal-confidence">${p.confidence}% — ${p.confidence_reason||''}</span>` : ''}
          </div>
          <div class="proposal-body">${esc(p.content)}</div>`;
        
        // Options
        if (options.length) {
          options.forEach((opt, oi) => {
            const letter = String.fromCharCode(65+oi);
            const isChosen = p.chosen_option === letter;
            proposalHtml += `<div class="exp-opt${isChosen?' chosen':''}" onclick="toggleOpt(this)">
              <div class="opt-hd">
                <span class="opt-key">${letter}</span>
                <span class="opt-title">${opt.title}</span>
                ${opt.recommended?'<span class="opt-rec">Recommended</span>':''}
              </div>
              <div class="opt-body">
                <div class="opt-desc">${opt.description||''}</div>
                ${opt.draft ? `<div class="draft-box"><div class="draft-label">Draft</div>${opt.draft}</div>` : ''}
                <div class="act-row">
                  <button class="act act-p" onclick="event.stopPropagation();chooseOption(${p.id},'${letter}')">Select ${letter}</button>
                  ${opt.draft ? `<button class="act act-g" onclick="event.stopPropagation();copyDraft(this)">Copy</button>` : ''}
                </div>
              </div>
            </div>`;
          });
        }
        
        // Votes
        proposalHtml += `<div class="vote-row">
          <button class="vote-btn${hasVoted&&votes.up?' voted up':''}" onclick="voteProposal(${p.id},'up',this)"><span>↑</span> Useful</button>
          <button class="vote-btn${hasVoted&&votes.down?' voted down':''}" onclick="voteProposal(${p.id},'down',this)"><span>↓</span> Off</button>
          <span class="vote-status${hasVoted?' show':''}">Trust updated</span>
        </div></div>`;
      });
    }
    
    // Escape user content, allow Mia markdown
    const safeContent = m.sender === 'mia' ? m.content.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') : esc(m.content);
    
    const findingBtn = m.sender === 'mia' ? `<button class="save-finding-btn" onclick="event.stopPropagation();openFindingForm(${m.id},'${esc(m.content.substring(0,300).replace(/'/g,'').replace(/\n/g,' '))}')">+ Finding</button>` : '';
    
    return `<div class="msg ${cls}">
      ${cls!=='system'?`<div class="sender">${m.sender==='mia'?'Mia':'Florian'}</div>`:''}
      <div class="bubble">${safeContent}${proposalHtml}${findingBtn}</div>
      <div class="time">${new Date(m.created_at).toLocaleString('de-DE',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
    </div>`;
  }).join('');
  
  el.scrollTop = el.scrollHeight;
}

// ── ACTIONS ──
function toggleOpt(el) {
  const sibs = el.parentElement.querySelectorAll('.exp-opt');
  sibs.forEach(s => { if(s!==el) s.classList.remove('open'); });
  el.classList.toggle('open');
}

async function chooseOption(proposalId, option) {
  await fetch(API+'/proposals/'+proposalId+'/choose', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({option})
  });
  // WebSocket will trigger the reload
}

async function voteProposal(proposalId, dir, btn) {
  await fetch(API+'/proposals/'+proposalId+'/vote', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({direction:dir})
  });
  const row = btn.parentElement;
  row.querySelectorAll('.vote-btn').forEach(b => { b.style.pointerEvents='none'; });
  btn.classList.add('voted',dir);
  row.querySelector('.vote-status').classList.add('show');
  loadTrust(); // Refresh trust scores
}

async function sendMsg() {
  const f = document.getElementById('inputField');
  const t = f.value.trim();
  if (!t || !currentTopic) return;
  f.value = '';
  f.style.height = 'auto';
  await postMessage('human', t);
  
  // Trigger AI response (streaming)
  await streamAIResponse(currentTopic, t);
}

async function streamAIResponse(topicId, userMessage) {
  // Show typing indicator
  const conv = document.getElementById('conv');
  const indicator = document.createElement('div');
  indicator.className = 'msg mia';
  indicator.id = 'aiTyping';
  indicator.innerHTML = `<div class="msg-meta"><span class="msg-sender">Mia</span><span class="msg-time">typing...</span></div><div class="msg-body" id="aiStreamBody" style="opacity:0.7">▊</div>`;
  conv.appendChild(indicator);
  conv.scrollTop = conv.scrollHeight;
  
  try {
    const resp = await fetch(API+'/ai/stream', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message: userMessage, topic_id: topicId})
    });
    
    if (!resp.ok) {
      // Fallback: non-streaming
      indicator.remove();
      const fallback = await fetch(API+'/ai/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: userMessage, topic_id: topicId})
      });
      if (fallback.ok) {
        // Message saved server-side, WebSocket will reload
      } else {
        const err = await fallback.text();
        console.error('AI error:', err);
        showSystemMsg('AI-Fehler: ' + err.slice(0, 100));
      }
      return;
    }
    
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    const body = document.getElementById('aiStreamBody');
    let fullText = '';
    let buffer = '';
    
    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      
      buffer += decoder.decode(value, {stream: true});
      const lines = buffer.split('\n');
      buffer = lines.pop(); // keep incomplete line
      
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const data = JSON.parse(line.slice(6));
          if (data.done) break;
          if (data.text) {
            fullText += data.text;
            body.innerHTML = marked ? marked.parse(fullText) : fullText.replace(/\n/g, '<br>');
            body.style.opacity = '1';
            conv.scrollTop = conv.scrollHeight;
          }
        } catch(e) {}
      }
    }
    
    // Remove typing indicator — WebSocket reload will show the saved message
    indicator.remove();
    // Force reload to get the properly formatted message
    if (currentTopic === topicId) selectTopic(topicId);
    
  } catch(e) {
    if (indicator.parentNode) indicator.remove();
    console.error('Stream error:', e);
    if (e.name === 'TypeError' && e.message.includes('fetch')) {
      showSystemMsg('Backend nicht erreichbar. Server läuft auf localhost:8080?');
    } else if (e.name === 'AbortError') {
      showSystemMsg('AI-Anfrage abgebrochen.');
    } else {
      showSystemMsg('AI-Fehler: ' + (e.message || 'Unbekannt. Mia offline?'));
    }
  }
}

// ── GUARDRAILS ──
// Trust score → permission level
function getGuardrail(skill) {
  const trustMap = {};
  (window._trustSkills || []).forEach(s => { trustMap[s.skill] = s.score; trustMap[s.skill.toLowerCase()] = s.score; });
  const score = trustMap[skill] || trustMap[skill.toLowerCase()] || 30;
  if (score >= 60) return {level: 'auto', label: 'AUTO', color: '#50c878'};
  if (score >= 30) return {level: 'review', label: 'REVIEW', color: '#d4a853'};
  return {level: 'confirm', label: 'CONFIRM', color: '#c47070'};
}

function guardrailBadge(skill) {
  const g = getGuardrail(skill);
  return `<span class="guardrail ${g.level}">${g.label}</span>`;
}

// ── ACTION BAR ──
function renderActionBar(topic) {
  const bar = document.getElementById('actionBar');
  if (!topic) { bar.style.display = 'none'; return; }
  
  const meta = JSON.parse(topic.meta || '{}');
  const actions = [];
  
  // Determine available actions based on topic stage and state
  if (topic.stage === 'revenue') {
    actions.push({id:'generate_cv', label:'CV generieren', skill:'Cv Generation', icon:'◆'});
    actions.push({id:'send_email', label:'Email senden', skill:'Email Drafts', icon:'→', primary:true});
  }
  if (meta.output_type === 'email' || meta.email) {
    actions.push({id:'send_email', label:'Email senden', skill:'Email Drafts', icon:'→', primary:true});
  }
  if (meta.output_type === 'linkedin') {
    actions.push({id:'publish', label:'Veröffentlichen', skill:'Linkedin Content', icon:'↑'});
  }
  if (meta.output_type === 'blog') {
    actions.push({id:'publish', label:'Veröffentlichen', skill:'Linkedin Content', icon:'↑'});
  }
  
  // Always available
  actions.push({id:'ask_mia', label:'Mia fragen', skill:'Research', icon:'?'});
  
  // Dedupe by id
  const seen = new Set();
  const unique = actions.filter(a => { if (seen.has(a.id)) return false; seen.add(a.id); return true; });
  
  bar.innerHTML = unique.map(a => {
    const g = getGuardrail(a.skill);
    return `<button class="action-btn ${a.primary ? 'primary' : ''}" onclick="executeAction('${topic.id}','${a.id}','${a.skill}')">
      ${a.label} ${guardrailBadge(a.skill)}
    </button>`;
  }).join('');
  bar.style.display = unique.length ? 'flex' : 'none';
}

let _confirmResolve = null;

function showConfirm(title, desc) {
  return new Promise(resolve => {
    _confirmResolve = resolve;
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmDesc').textContent = desc;
    document.getElementById('confirmOverlay').classList.add('open');
  });
}

function closeConfirm(result) {
  document.getElementById('confirmOverlay').classList.remove('open');
  if (_confirmResolve) { _confirmResolve(result); _confirmResolve = null; }
}

async function executeAction(topicId, actionType, skill) {
  const g = getGuardrail(skill);
  
  // CONFIRM gate: explicit confirmation required
  if (g.level === 'confirm') {
    const ok = await showConfirm(
      `Bestätigung erforderlich`,
      `Trust für "${skill}" ist niedrig (Score < 30). Diese Aktion ist irreversibel und braucht deine explizite Bestätigung.\n\nAktion: ${actionType}\nTopic: ${topicId}`
    );
    if (!ok) return;
  }
  
  // REVIEW gate: show preview, require explicit "Weiter"
  if (g.level === 'review') {
    const ok = await showConfirm(
      `Review empfohlen`,
      `Trust für "${skill}" liegt im mittleren Bereich (Score 30-59). Bitte prüfe das Ergebnis vor dem Senden.\n\nAktion: ${actionType}`
    );
    if (!ok) return;
  }
  
  // AUTO: proceeds without interruption (trust >= 60)
  
  if (actionType === 'ask_mia') {
    document.getElementById('inputField').focus();
    return;
  }
  
  if (actionType === 'generate_cv') {
    try {
      const resp = await fetch(API+'/actions/generate-cv/'+topicId, {method:'POST'});
      if (resp.ok) selectTopic(topicId);
      else showSystemMsg('CV-Generierung fehlgeschlagen');
    } catch(e) { showSystemMsg('Fehler: '+e.message); }
    return;
  }
  
  if (actionType === 'send_email') {
    openEmailDialog(topicId);
    return;
  }
  
  // Queue action for Mia
  await fetch(API+'/actions/queue', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({topic_id: topicId, action_type: actionType, params: {}})
  });
  selectTopic(topicId);
}

// ── EMAIL DIALOG ──
let _emailTopicId = null;
let _emailAttachments = [];

async function openEmailDialog(topicId) {
  _emailTopicId = topicId;
  _emailAttachments = [];
  
  // Pre-fill from topic data
  const topic = await fetch(API+'/topics/'+topicId).then(r=>r.json());
  const meta = JSON.parse(topic.meta || '{}');
  
  document.getElementById('emailTo').value = meta.email || '';
  document.getElementById('emailSubject').value = meta.subject || 'Venture Partner — AI-Native Operator Background';
  document.getElementById('emailBody').value = '';
  
  // Find attachments (cover letter + CV)
  const docs = topic.documents || [];
  const attachable = docs.filter(d => d.path && (d.doc_type === 'pdf'));
  _emailAttachments = attachable.map(d => d.path);
  
  const attEl = document.getElementById('emailAttachments');
  attEl.innerHTML = _emailAttachments.length 
    ? 'Anhänge: ' + _emailAttachments.map(a => a.split('/').pop()).join(', ')
    : 'Keine Anhänge gefunden';
  
  document.getElementById('emailOverlay').classList.add('open');
  document.getElementById('emailTo').focus();
}

function closeEmailDialog() {
  document.getElementById('emailOverlay').classList.remove('open');
}

async function sendEmailFromDialog() {
  const to = document.getElementById('emailTo').value.trim();
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();
  
  if (!to || !subject || !body) {
    alert('Alle Felder ausfüllen');
    return;
  }
  // Basic email validation
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(to)) {
    alert('Ungültige Email-Adresse: ' + to);
    return;
  }
  if (body.length < 10) {
    alert('Nachricht zu kurz (min. 10 Zeichen)');
    return;
  }
  
  const btn = document.querySelector('#emailOverlay .primary');
  btn.textContent = 'Sende...';
  btn.disabled = true;
  
  try {
    const resp = await fetch(API+'/actions/send-email', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        to, subject, body,
        attachments: _emailAttachments,
        topic_id: _emailTopicId
      })
    });
    
    if (resp.ok) {
      closeEmailDialog();
      if (_emailTopicId) selectTopic(_emailTopicId);
      showSystemMsg('Email gesendet an ' + to);
    } else {
      const err = await resp.json();
      alert('Fehler: ' + (err.detail || 'Unbekannt'));
    }
  } catch(e) {
    alert('Fehler: ' + e.message);
  } finally {
    btn.textContent = 'Senden';
    btn.disabled = false;
  }
}

// ── COMMAND PALETTE ──
let cmdItems = [];
let cmdActiveIdx = 0;

function openCmd() {
  const overlay = document.getElementById('cmdOverlay');
  overlay.classList.add('open');
  document.getElementById('cmdInput').value = '';
  document.getElementById('cmdInput').focus();
  cmdActiveIdx = 0;
  buildCmdItems();
  filterCmd('');
}

function closeCmd() {
  document.getElementById('cmdOverlay').classList.remove('open');
}

function buildCmdItems() {
  cmdItems = [];
  
  // Topics
  (window._allTopics || []).forEach(t => {
    cmdItems.push({type:'topic', id:t.id, title:t.name, sub:`${t.stage} · ${t.progress}%`, icon:'◉', action:() => { selectTopic(t.id); closeCmd(); }});
  });
  
  // Folders
  (window.foldersCache || []).forEach(f => {
    cmdItems.push({type:'folder', id:f.id, title:f.name, sub:'Ordner', icon:'▸', action:() => { closeCmd(); }});
  });
  
  // Actions
  cmdItems.push({type:'action', id:'new-topic', title:'Neues Topic erstellen', sub:'Cmd+N', icon:'+', action:() => { closeCmd(); startAddTopic(); }});
  cmdItems.push({type:'action', id:'new-folder', title:'Neuer Ordner', sub:'', icon:'+', action:() => { closeCmd(); startAddFolder(); }});
  cmdItems.push({type:'action', id:'toggle-ctx', title:'Context Panel toggle', sub:'Cmd+.', icon:'◨', action:() => { closeCmd(); toggleCtx(); }});
  cmdItems.push({type:'action', id:'pipeline', title:'Pipeline Overview', sub:'Cmd+P', icon:'◈', action:() => { closeCmd(); togglePipelineView(); }});
  cmdItems.push({type:'action', id:'principles', title:'Principles & Workflow', sub:'Cmd+I', icon:'◆', action:() => { closeCmd(); togglePrinciplesView(); }});
}

function filterCmd(query) {
  const q = query.toLowerCase();
  const filtered = q ? cmdItems.filter(i => i.title.toLowerCase().includes(q) || (i.sub||'').toLowerCase().includes(q)) : cmdItems;
  const el = document.getElementById('cmdResults');
  cmdActiveIdx = 0;
  
  el.innerHTML = filtered.slice(0, 12).map((item, i) => `
    <div class="cmd-item ${i===0?'active':''}" data-idx="${i}" onclick="cmdItems.find(c=>c.id==='${item.id}')?.action()" onmouseenter="cmdSetActive(${i})">
      <div class="cmd-item-icon">${item.icon}</div>
      <div class="cmd-item-text">
        <div class="cmd-item-title">${item.title}</div>
        ${item.sub ? `<div class="cmd-item-sub">${item.sub}</div>` : ''}
      </div>
    </div>
  `).join('') || '<div style="padding:20px;text-align:center;font-size:11px;color:var(--text-dim)">Keine Ergebnisse</div>';
  
  window._cmdFiltered = filtered.slice(0, 12);
}

function cmdSetActive(idx) {
  cmdActiveIdx = idx;
  document.querySelectorAll('.cmd-item').forEach((el, i) => el.classList.toggle('active', i === idx));
}

function cmdNav(dir) {
  const items = document.querySelectorAll('.cmd-item');
  if (!items.length) return;
  cmdActiveIdx = Math.max(0, Math.min(items.length - 1, cmdActiveIdx + dir));
  items.forEach((el, i) => el.classList.toggle('active', i === cmdActiveIdx));
  items[cmdActiveIdx]?.scrollIntoView({block: 'nearest'});
}

function cmdSelect() {
  const filtered = window._cmdFiltered || [];
  if (filtered[cmdActiveIdx]) filtered[cmdActiveIdx].action();
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showSystemMsg(text) {
  const conv = document.getElementById('conv');
  const div = document.createElement('div');
  div.className = 'msg system';
  div.innerHTML = `<div class="msg-body" style="color:var(--danger);font-size:11px">${esc(text)}</div>`;
  conv.appendChild(div);
  conv.scrollTop = conv.scrollHeight;
}

async function postMessage(sender, content) {
  if (!currentTopic) return;
  await fetch(API+'/topics/'+currentTopic+'/messages', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({sender, content, msg_type:'text'})
  });
}

// ── CONTEXT ──
function renderContext(topic) {
  const el = document.getElementById('ctxInner');
  const meta = JSON.parse(topic.meta||'{}');
  
  let html = '';
  
  // Details
  html += `<div class="ctx-sec"><div class="ctx-sec-title">Details</div>
    <div style="font-size:11px;color:var(--text-muted);line-height:1.7">
    <div><b style="color:var(--text);font-weight:500">${topic.name}</b></div>
    <div>Stage: ${topic.stage} · Progress: ${topic.progress}%</div>
    ${meta.contact?`<div>Contact: ${meta.contact}</div>`:''}
    ${meta.email?`<div>Email: ${meta.email}</div>`:''}
    ${meta.potential?`<div>Potential: ${meta.potential}</div>`:''}
    </div></div>`;
  
  // Documents
  html += `<div class="ctx-sec"><div class="ctx-sec-title">Documents</div>`;
  if (topic.documents && topic.documents.length) {
    topic.documents.forEach(d => {
      const icon = (d.doc_type||'').toUpperCase().slice(0,3);
      let href = '#';
      if (d.url) href = d.url;
      else if (d.path) href = '/view/' + encodeURI(d.path);
      else if (d.doc_type === 'email') href = 'https://mail.google.com/mail/u/0/#search/' + encodeURIComponent(d.name);
      const sub = d.url || d.path || (d.doc_type==='email' ? 'Search in Gmail' : '');
      html += `<a class="ctx-doc" href="${href}" target="_blank" style="text-decoration:none;color:inherit">
        <div class="ctx-doc-icon">${icon}</div>
        <div><div>${d.name}</div>${sub ? `<div style="font-size:9px;color:var(--text-dim)">${sub}</div>` : ''}</div>
      </a>`;
    });
  }
  html += `<div class="ctx-upload" onclick="triggerUpload('${topic.id}','doc')">
    <div class="ctx-upload-text">+ Dokument hochladen</div>
  </div>`;
  html += '</div>';
  
  // References (Golden Standard / Expected Outcome)
  html += `<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--warm)">⬥ References</div>`;
  if (topic.references && topic.references.length) {
    topic.references.forEach(d => {
      const icon = (d.doc_type||'').toUpperCase().slice(0,3);
      let href = '#';
      if (d.url) href = d.url;
      else if (d.path) href = '/view/' + encodeURI(d.path);
      const sub = d.url || d.path || '';
      html += `<a class="ctx-doc" href="${href}" target="_blank" style="text-decoration:none;color:inherit;border-left:2px solid var(--warm);padding-left:6px;margin-left:-6px">
        <div class="ctx-doc-icon" style="background:rgba(212,168,83,0.1);color:var(--warm);border-color:rgba(212,168,83,0.2)">${icon}</div>
        <div><div>${d.name}</div>${sub ? `<div style="font-size:9px;color:var(--text-dim)">${sub}</div>` : ''}</div>
      </a>`;
    });
  }
  html += `<div class="ctx-upload" onclick="triggerUpload('${topic.id}','ref')" style="border-color:rgba(212,168,83,0.2)">
    <div class="ctx-upload-text" style="color:var(--warm)">+ Referenz hochladen</div>
  </div>`;
  html += `<div class="ctx-add-ref" onclick="addReference('${topic.id}')">+ URL/Pfad als Referenz</div>`;
  html += '</div>';

  // Connections (bidirectional with stage badges)
  if (topic.connections && topic.connections.length) {
    const stageColors = {research:'#8e8e8e',systems:'#6b8aab',content:'#9b8ec4',revenue:'var(--warm)'};
    const upstream = topic.connections.filter(c => c.direction === 'upstream');
    const downstream = topic.connections.filter(c => c.direction === 'downstream');
    
    html += `<div class="ctx-sec"><div class="ctx-sec-title">Connected Topics</div>`;
    
    if (upstream.length) {
      html += `<div style="font-size:9px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px">Upstream (feeds into this)</div>`;
      upstream.forEach(c => {
        const sc = stageColors[c.target_stage] || 'var(--text-dim)';
        html += `<a class="ctx-conn" href="#" onclick="event.preventDefault();selectTopic('${c.to_topic}')" style="text-decoration:none;color:inherit">
          <div class="ctx-conn-dot" style="background:${sc}"></div>
          <div><div style="font-size:11px;color:var(--text-muted)">${c.target_name} <span style="font-size:9px;padding:1px 4px;border-radius:2px;background:rgba(255,255,255,0.05);color:${sc}">${c.target_stage||''}</span></div>
          <div class="ctx-rel">${c.relation||''}</div></div>
        </a>`;
      });
    }
    if (downstream.length) {
      html += `<div style="font-size:9px;color:var(--text-dim);margin-bottom:4px;margin-top:${upstream.length?'8':'0'}px;text-transform:uppercase;letter-spacing:0.5px">Downstream (outputs to)</div>`;
      downstream.forEach(c => {
        const sc = stageColors[c.target_stage] || 'var(--text-dim)';
        html += `<a class="ctx-conn" href="#" onclick="event.preventDefault();selectTopic('${c.to_topic}')" style="text-decoration:none;color:inherit">
          <div class="ctx-conn-dot" style="background:${sc}"></div>
          <div><div style="font-size:11px;color:var(--text-muted)">${c.target_name} <span style="font-size:9px;padding:1px 4px;border-radius:2px;background:rgba(255,255,255,0.05);color:${sc}">${c.target_stage||''}</span></div>
          <div class="ctx-rel">${c.relation||''}</div></div>
        </a>`;
      });
    }
    html += '</div>';
  }
  
  // Findings (CKE)
  html += `<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--warm)">Findings</div>
    <div id="ctxFindings"><div style="font-size:10px;color:var(--text-dim)">Loading...</div></div>
  </div>`;
  
  // Quality Gate (dynamic from corrections)
  html += `<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--warm)">⬥ Quality Gate</div>
    <div class="ctx-checklist" id="ctxQualityGate">
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Frage beantwortet?</span></div>
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Externe Zahlen belegt?</span></div>
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Sofort nutzbar?</span></div>
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Links klickbar?</span></div>
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Spelling geprüft?</span></div>
      <div class="ctx-check" onclick="this.classList.toggle('done')"><div class="ctx-check-box">✓</div><span>Max 2 Iterationen</span></div>
    </div>
  </div>`;
  
  // Corrections (loaded async)
  html += `<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--danger)">⬥ Active Corrections</div>
    <div id="ctxCorrections"><div style="font-size:10px;color:var(--text-dim)">Loading...</div></div>
  </div>`;
  
  // Event Log
  html += `<div class="ctx-sec"><div class="ctx-sec-title">⬥ Activity</div>
    <div id="ctxEvents"><div style="font-size:10px;color:var(--text-dim)">No events</div></div>
  </div>`;
  
  el.innerHTML = html;
  
  // Load corrections, events, and findings async
  loadCorrections(topic);
  loadEvents(topic.id);
  loadFindings(topic.id);
}

// ── NEW TOPIC ──
function startAddTopic() {
  const overlay = document.getElementById('newTopicOverlay');
  const folderSelect = document.getElementById('ntFolder');
  // Populate folders
  folderSelect.innerHTML = '<option value="">Kein Ordner</option>' + 
    foldersCache.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
  overlay.classList.add('open');
  document.getElementById('ntName').focus();
}

function closeNewTopic() {
  document.getElementById('newTopicOverlay').classList.remove('open');
  document.getElementById('ntName').value = '';
  document.getElementById('ntContact').value = '';
  document.getElementById('ntEmail').value = '';
}

async function submitNewTopic() {
  const name = document.getElementById('ntName').value.trim();
  if (!name) return;
  const id = name.toLowerCase().replace(/[^a-z0-9äöü]/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
  const stage = document.getElementById('ntStage').value;
  const folderId = document.getElementById('ntFolder').value || null;
  const outputType = document.getElementById('ntOutputType').value;
  const contact = document.getElementById('ntContact').value.trim();
  const email = document.getElementById('ntEmail').value.trim();
  
  const meta = {output_type: outputType};
  if (contact) meta.contact = contact;
  if (email) meta.email = email;
  
  await fetch(API+'/topics', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id, name, stage, meta})
  });
  
  if (folderId) {
    await fetch(API+'/topics/'+id+'/move', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({folder_id: folderId})
    });
  }
  
  closeNewTopic();
  await loadFolderTree();
  selectTopic(id);
}

// ── FILE UPLOAD ──
function triggerUpload(topicId, kind) {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.onchange = async (e) => {
    for (const file of e.target.files) {
      const formData = new FormData();
      formData.append('file', file);
      formData.append('kind', kind);
      await fetch(API+'/topics/'+topicId+'/upload', {method:'POST', body: formData});
    }
    if (currentTopic) selectTopic(currentTopic);
  };
  input.click();
}

async function addReference(topicId) {
  const url = prompt('Reference URL oder Pfad:');
  if (!url) return;
  const name = prompt('Name:', url.split('/').pop() || 'Reference');
  if (!name) return;
  
  const isUrl = url.startsWith('http');
  await fetch(API+'/topics/'+topicId+'/add-reference', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({name, url: isUrl ? url : null, path: isUrl ? null : url, doc_type: 'ref'})
  });
  if (currentTopic) selectTopic(currentTopic);
}

async function loadPreflight(topicId) {
  const badge = document.getElementById('preflightBadge');
  if (!badge) return;
  try {
    const pf = await fetch(API+'/preflight/'+topicId).then(r=>r.json());
    if (pf.total_checks === 0) { badge.innerHTML = ''; return; }
    
    badge.className = 'preflight-badge ' + pf.overall;
    if (pf.overall === 'pass') {
      badge.innerHTML = `${pf.passed}/${pf.total_checks} pass`;
      badge.title = 'Alle Pre-Flight Checks bestanden';
    } else if (pf.overall === 'fail') {
      badge.innerHTML = `${pf.failed} fail`;
      badge.title = `${pf.failed} Checks fehlgeschlagen, ${pf.warned} Warnungen`;
    } else {
      badge.innerHTML = `${pf.warned} warn`;
      badge.title = `${pf.warned} Warnungen, ${pf.passed} bestanden`;
    }
    if (!pf.has_output) {
      badge.className = 'preflight-badge warn';
      badge.innerHTML = `${pf.total_checks} checks`;
      badge.title = 'Kein Output zum Prüfen vorhanden';
    }
  } catch(e) {
    badge.innerHTML = '';
  }
}

async function loadCorrections(topic) {
  const el = document.getElementById('ctxCorrections');
  if (!el) return;
  try {
    // Determine relevant categories based on topic meta
    const meta = JSON.parse(topic.meta || '{}');
    const corrections = await fetch(API+'/corrections').then(r=>r.json());
    
    // Show top corrections by severity, max 8
    const top = corrections.slice(0, 8);
    if (!top.length) { el.innerHTML = '<div style="font-size:10px;color:var(--text-dim)">No corrections</div>'; return; }
    
    el.innerHTML = top.map(c => `
      <div class="ctx-correction">
        <div class="ctx-correction-rule">
          <span class="ctx-severity s${c.severity}"></span>${c.rule}
        </div>
        ${c.wrong || c.rght ? `<div class="ctx-correction-detail">
          ${c.wrong ? `<span class="ctx-correction-wrong">${c.wrong}</span>` : ''}
          ${c.wrong && c.rght ? ' → ' : ''}
          ${c.rght ? `<span class="ctx-correction-right">${c.rght}</span>` : ''}
        </div>` : ''}
        ${c.violation_count > 0 ? `<div class="ctx-correction-count">${c.violation_count} violations</div>` : ''}
      </div>
    `).join('');
  } catch(e) {
    el.innerHTML = '<div style="font-size:10px;color:var(--danger)">Failed to load</div>';
  }
}

async function loadEvents(topicId) {
  const el = document.getElementById('ctxEvents');
  if (!el) return;
  try {
    const events = await fetch(API+'/events/'+topicId+'?limit=10').then(r=>r.json());
    if (!events.length) { el.innerHTML = '<div style="font-size:10px;color:var(--text-dim)">No activity yet</div>'; return; }
    
    el.innerHTML = events.map(e => {
      const t = new Date(e.created_at);
      const time = t.toLocaleTimeString('de-DE', {hour:'2-digit',minute:'2-digit'});
      const detail = JSON.parse(e.detail || '{}');
      let text = e.event_type.replace(/_/g, ' ');
      if (e.event_type === 'correction_violation') text = `Correction violated: #${detail.correction_id}`;
      if (e.event_type === 'trust_feedback') text = `Trust ${detail.direction}: ${detail.skill}`;
      if (e.event_type === 'state_change') text = `State: ${detail.from} → ${detail.to}`;
      return `<div class="ctx-event">
        <span class="ctx-event-time">${time}</span>
        <span class="ctx-event-dot"></span>
        <span class="ctx-event-text">${text}</span>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<div style="font-size:10px;color:var(--danger)">Failed to load</div>';
  }
}

function toggleCtx() {
  const panel = document.getElementById('ctxPanel');
  panel.classList.toggle('open');
  document.getElementById('ctxBtn').classList.toggle('on');
  // If in global mode and opening, render global context
  if (panel.classList.contains('open') && VIEW.contextMode === 'global') {
    renderGlobalContext();
  }
}

function openFiles() {
  if (!currentTopic) return;
  const t = topicsCache[currentTopic];
  if (!t) return;
  // Open the first document link, or toggle context panel
  const meta = JSON.parse(t.meta||'{}');
  if (!document.getElementById('ctxPanel').classList.contains('open')) {
    toggleCtx();
  }
}

// ── TRUST ──
async function loadTrust() {
  let skills = [];
  try { skills = await fetch(API+'/trust/skills').then(r=>r.json()); } catch(e) {}
  window._trustSkills = skills; // Cache for guardrails
  const el = document.getElementById('trustFooter');
  if (!skills.length) { el.innerHTML = '<div class="trust-mini">No trust data</div>'; return; }
  
  const avg = Math.round(skills.reduce((s,t) => s + t.score, 0) / skills.length);
  const barColor = (score) => score >= 60 ? '#4aa088' : score >= 30 ? 'var(--warm)' : 'var(--danger)';
  const label = (s) => s.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
  
  el.innerHTML = `
    <div class="trust-header"><span>Trust per Skill</span><span>Avg: ${avg}</span></div>
    ${skills.map(t => `
      <div class="trust-skill">
        <span class="trust-skill-name" title="${label(t.skill)}">${label(t.skill)}</span>
        <div class="trust-skill-bar"><div class="trust-skill-fill" style="width:${t.score}%;background:${barColor(t.score)}"></div></div>
        <span class="trust-skill-score">${t.score}</span>
      </div>
    `).join('')}
  `;
}

// ── UTILS ──
// ── ACTIONS ──
async function generateCV() {
  if (!currentTopic) return;
  const btn = document.getElementById('genCvBtn');
  btn.textContent = 'Generating...';
  btn.style.pointerEvents = 'none';
  try {
    const r = await fetch(API+'/actions/generate-cv/'+currentTopic, {method:'POST'});
    if (!r.ok) {
      const err = await r.json();
      alert('Error: ' + (err.detail || 'Failed'));
    }
    // WebSocket will update the UI
  } catch(e) {
    alert('Error: ' + e.message);
  }
  btn.textContent = 'Generate CV';
  btn.style.pointerEvents = 'auto';
}

// ── FILE VIEWER ──
let currentFileContent = '';
let currentFileUrl = '';

async function openFile(path, name, type) {
  const overlay = document.getElementById('fileOverlay');
  const title = document.getElementById('overlayTitle');
  const pathEl = document.getElementById('overlayPath');
  const body = document.getElementById('overlayBody');
  const openBtn = document.getElementById('overlayOpenBtn');
  
  title.textContent = name;
  body.innerHTML = '<div class="loading">Loading...</div>';
  overlay.classList.add('open');
  currentFileContent = '';
  currentFileUrl = '';
  
  if (type === 'email') {
    // Open Gmail search for this email context
    const searchUrl = 'https://mail.google.com/mail/u/0/#search/' + encodeURIComponent(name);
    pathEl.textContent = 'Gmail Search';
    body.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:13px;margin-bottom:16px">Search Gmail for "${name}"</div>
      <button class="primary" style="padding:10px 24px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;cursor:pointer" onclick="window.open('${searchUrl}','_blank')">Open in Gmail</button>
    </div>`;
    openBtn.style.display = 'inline-block';
    openBtn.onclick = () => window.open(searchUrl, '_blank');
    return;
  }
  
  if (!path) { body.innerHTML = 'No file path available.'; return; }
  
  pathEl.textContent = path;
  
  // PDF — can't render inline, offer to open
  if (path.endsWith('.pdf')) {
    body.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:13px;margin-bottom:8px">PDF files cannot be previewed inline.</div>
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:16px">${path}</div>
      <button class="primary" style="padding:10px 24px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;cursor:pointer" onclick="alert('Open: ${path}')">Reveal in Finder</button>
    </div>`;
    openBtn.style.display = 'none';
    return;
  }
  
  // Text/MD files — fetch content
  try {
    const r = await fetch(API + '/file?path=' + encodeURIComponent(path));
    if (!r.ok) throw new Error((await r.json()).detail || 'Failed to load');
    const data = await r.json();
    currentFileContent = data.content;
    body.textContent = data.content;
    if (data.truncated) body.innerHTML += '\n\n<span style="color:var(--warm)">[Truncated at 50KB]</span>';
    openBtn.style.display = 'none';
  } catch (e) {
    body.innerHTML = `<div style="color:var(--danger)">${e.message}</div>`;
  }
}

function closeOverlay() {
  document.getElementById('fileOverlay').classList.remove('open');
}

function copyFileContent() {
  if (currentFileContent) {
    navigator.clipboard.writeText(currentFileContent);
    // Brief feedback
    const btn = document.querySelector('.overlay-actions button');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Content', 1500);
  }
}

document.addEventListener('keydown', e => {
  const cmdOpen = document.getElementById('cmdOverlay').classList.contains('open');
  const newTopicOpen = document.getElementById('newTopicOverlay').classList.contains('open');
  const confirmOpen = document.getElementById('confirmOverlay').classList.contains('open');
  const inputFocused = document.activeElement?.tagName === 'TEXTAREA' || document.activeElement?.tagName === 'INPUT';
  
  // Escape: close modals
  if (e.key === 'Escape') { 
    if (cmdOpen) { closeCmd(); e.preventDefault(); return; }
    if (confirmOpen) { closeConfirm(false); e.preventDefault(); return; }
    if (newTopicOpen) { closeNewTopic(); e.preventDefault(); return; }
    closeOverlay(); return;
  }
  
  // Command Palette navigation
  if (cmdOpen) {
    if (e.key === 'ArrowDown') { e.preventDefault(); cmdNav(1); return; }
    if (e.key === 'ArrowUp') { e.preventDefault(); cmdNav(-1); return; }
    if (e.key === 'Enter') { e.preventDefault(); cmdSelect(); return; }
    return;
  }
  
  // New Topic modal
  if (newTopicOpen && e.key === 'Enter') { submitNewTopic(); return; }
  
  // Confirm dialog
  if (confirmOpen && e.key === 'Enter') { closeConfirm(true); return; }
  
  // Cmd+K: Command Palette
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openCmd(); return; }
  
  // Cmd+P: Pipeline View
  if ((e.metaKey || e.ctrlKey) && e.key === 'p') { e.preventDefault(); togglePipelineView(); return; }
  
  // Cmd+I: Principles View
  if ((e.metaKey || e.ctrlKey) && e.key === 'i') { e.preventDefault(); togglePrinciplesView(); return; }
  
  // Cmd+O: Operations
  if ((e.metaKey || e.ctrlKey) && e.key === 'o') { e.preventDefault(); switchView(VIEW.current === 'executive' ? 'topics' : 'executive'); return; }
  
  // Cmd+N: New Topic
  if ((e.metaKey || e.ctrlKey) && e.key === 'n') { e.preventDefault(); startAddTopic(); return; }
  
  // Cmd+.: Toggle Context
  if ((e.metaKey || e.ctrlKey) && e.key === '.') { e.preventDefault(); toggleCtx(); return; }
  
  // Skip shortcuts when typing
  if (inputFocused) return;
  
  // J/K: Navigate topics
  if (e.key === 'j' || e.key === 'k') {
    const topics = window._allTopics || [];
    if (!topics.length) return;
    const idx = topics.findIndex(t => t.id === currentTopic);
    const next = e.key === 'j' ? Math.min(idx + 1, topics.length - 1) : Math.max(idx - 1, 0);
    if (topics[next]) selectTopic(topics[next].id);
    return;
  }
  
  // E: Focus input (edit)
  if (e.key === 'e') { document.getElementById('inputField').focus(); return; }
  
  // C: Toggle context
  if (e.key === 'c') { toggleCtx(); return; }
});

function copyDraft(btn) {
  const draft = btn.closest('.opt-body').querySelector('.draft-box');
  if (draft) navigator.clipboard.writeText(draft.textContent.replace('Draft','').trim());
  btn.textContent = 'Copied';
  setTimeout(()=>btn.textContent='Copy',2000);
}

document.getElementById('inputField').addEventListener('input', function() {
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});

// ── PRINCIPLES VIEW ──
let principlesViewOpen = false;

function togglePrinciplesView() {
  if (VIEW.current === 'principles') { switchView('topics'); }
  else { switchView('principles'); }
}

function renderPrinciplesView() {
  const pv = document.getElementById('principlesView');
  
  const principles = [
    { num: 1, title: 'Research First', desc: 'Research VOR Implementation. 15min Research spart 40min Rework \u2014 bei wichtigen Entscheidungen auch Stunden, Tage oder Wochen. Wichtige Entscheidungen compounden. Ausnahme: Confidence >90%.', conf: '90%', source: 'RF-029', category: 'engineering', tags: ['process'] },
    { num: 2, title: 'Echte Mathematik', desc: 'Wenn es eine echte Formel gibt, die echte Formel benutzen. Keine Shortcuts \u2014 sie f\u00fchren zu Nacharbeit und kosten ein Vielfaches an Zeit und Aufwand.', conf: '95%', source: 'RF-026', category: 'engineering', tags: ['quality'] },
    { num: 3, title: 'Professional Patterns', desc: 'Native Browser-APIs (prompt(), alert()) = Amateur. Immer recherchieren wie der Marktf\u00fchrer der jeweiligen Kategorie es l\u00f6st \u2014 nicht raten, nachschauen.', conf: '90%', source: 'RF-025', category: 'engineering', tags: ['ux'] },
    { num: 4, title: 'Cheapest Check First', desc: 'Pre-Flight mit Regex f\u00e4ngt 80% der Fehler bei 0 Kosten und <50ms. Teure Checks (LLM) nur f\u00fcr was Regex nicht kann.', conf: '90%', source: 'RF-001', category: 'engineering', tags: ['efficiency'] },
    { num: 5, title: 'Beide Richtungen modellieren', desc: 'Unidirektionale Verbindungen verstecken die H\u00e4lfte der Information. Upstream + Downstream immer sichtbar.', conf: '85%', source: 'RF-027', category: 'engineering', tags: ['systems'] },
    { num: 6, title: 'Dogfooding', desc: 'Ein System das vom Erbauer nicht benutzt wird, wird von niemandem benutzt. Erster Test: benutze ich es selbst?', conf: '90%', source: 'RF-031', category: 'process', tags: ['validation'] },
    { num: 7, title: 'AI Output ist overconfident', desc: '84% der LLM-Outputs zeigen h\u00f6here Confidence als tats\u00e4chliche Accuracy (PMC, 9 Modelle, 351 Szenarien). Immer kalibrieren.', conf: '85%', source: 'C002', category: 'process', tags: ['ai', 'calibration'] },
    { num: 8, title: 'Personal > General Intelligence', desc: 'Deep Context f\u00fcr einen Menschen schl\u00e4gt breites Wissen f\u00fcr alle. Unser Moat: Tiefe, nicht Breite.', conf: '\u2014', source: 'Architecture', category: 'strategy', tags: ['moat'] },
    { num: 9, title: 'Ship vs Perfect', desc: 'Reversible Entscheidungen: >80% Confidence \u2192 handeln. Irreversible: >92%. Perfekt nur wenn es sein muss.', conf: '\u2014', source: 'Experience', category: 'strategy', tags: ['decisions'] },
  ];
  
  const engineering = principles.filter(p => p.category === 'engineering');
  const process = principles.filter(p => p.category === 'process');
  const strategy = principles.filter(p => p.category === 'strategy');
  
  let html = `<div class="prin">`;
  
  // Header
  html += `<div class="prin-header">
    <div>
      <h2>Principles</h2>
      <div class="prin-header-sub">L1 Memory \u2014 Florian-approved, highest authority. 9 active principles.</div>
    </div>
    <div class="prin-header-meta">
      Approved: 2026-02-18<br>
      Next review: 2026-03-18<br>
      <span style="color:var(--warm)">Cmd+I</span> to toggle
    </div>
  </div>`;
  
  // Engineering Section
  html += `<div>
    <div class="prin-section-title">Engineering</div>
    <div class="prin-grid" style="margin-top:12px">`;
  engineering.forEach(p => {
    html += renderPrincipleCard(p);
  });
  html += `</div></div>`;
  
  // Process Section
  html += `<div>
    <div class="prin-section-title">Process</div>
    <div class="prin-grid" style="margin-top:12px">`;
  process.forEach(p => {
    html += renderPrincipleCard(p);
  });
  html += `</div></div>`;
  
  // Strategy Section
  html += `<div>
    <div class="prin-section-title">Strategy</div>
    <div class="prin-grid" style="margin-top:12px">`;
  strategy.forEach(p => {
    html += renderPrincipleCard(p);
  });
  html += `</div></div>`;
  
  // Workflow Documentation
  html += `<div>
    <div class="prin-section-title">Knowledge Architecture</div>
    <div class="prin-workflow" style="margin-top:12px">
      <div class="prin-wf-title">4-Layer Hierarchical Memory</div>
      <div class="prin-wf-layers">
        <div class="prin-wf-layer l0">
          <div class="prin-wf-layer-num">L0</div>
          <div class="prin-wf-layer-name">System</div>
          <div class="prin-wf-layer-desc">SOUL.md, USER.md, AGENTS.md<br>Always loaded</div>
        </div>
        <div class="prin-wf-layer l1">
          <div class="prin-wf-layer-num" style="color:var(--warm)">L1</div>
          <div class="prin-wf-layer-name" style="color:var(--warm)">Principles</div>
          <div class="prin-wf-layer-desc">9 rules, Florian-approved<br>Overrides everything below</div>
        </div>
        <div class="prin-wf-layer l2">
          <div class="prin-wf-layer-num" style="color:#6b8aab">L2</div>
          <div class="prin-wf-layer-name">Domain Knowledge</div>
          <div class="prin-wf-layer-desc">Platform Findings (conf>70%)<br>Auto-consolidated weekly</div>
        </div>
        <div class="prin-wf-layer l3">
          <div class="prin-wf-layer-num" style="color:#9b8ec4">L3</div>
          <div class="prin-wf-layer-name">Episodic</div>
          <div class="prin-wf-layer-desc">Daily summaries<br>Decay after 30 days</div>
        </div>
      </div>
    </div>`;
  
  // Consolidation Workflow
  html += `<div class="prin-workflow" style="margin-top:12px">
      <div class="prin-wf-title">Consolidation Pipeline</div>
      <div class="prin-wf-flow">
        <div class="prin-wf-node">Platform DB<div style="font-size:8px;color:var(--text-dim);margin-top:2px">Source of Truth</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node active">Consolidation<div style="font-size:8px;color:var(--text-dim);margin-top:2px">Weekly Cron</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node">memory/semantic/*<div style="font-size:8px;color:var(--text-dim);margin-top:2px">Retrieval Cache</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node">memory_search<div style="font-size:8px;color:var(--text-dim);margin-top:2px">AI Retrieval</div></div>
      </div>
      <div class="prin-wf-desc" style="margin-top:16px">
        <strong>Authoring Layer</strong> (Platform) \u2192 Findings CRUD, Bayesian Updates, Verify/Kill<br>
        <strong>Retrieval Layer</strong> (Memory Files) \u2192 Generated cache, optimized for semantic search<br>
        <strong>Consolidation</strong> \u2192 Runs every Sunday 10:00 CET. Groups by research line, detects clusters, generates prose-style domain files.<br>
        <strong>Fallback</strong> \u2192 If server down, memory files are max 7 days stale but always available.
      </div>
    </div>`;
  
  // Finding Lifecycle
  html += `<div class="prin-workflow" style="margin-top:12px">
      <div class="prin-wf-title">Finding Lifecycle</div>
      <div class="prin-wf-flow">
        <div class="prin-wf-node">Raw Claim<div style="font-size:8px;color:var(--text-dim);margin-top:2px">conf 40-60%</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node">Verified<div style="font-size:8px;color:var(--text-dim);margin-top:2px">Bayesian update</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node active">Principle<div style="font-size:8px;color:var(--text-dim);margin-top:2px">conf >85% + Florian OK</div></div>
      </div>
      <div class="prin-wf-flow" style="margin-top:8px">
        <div class="prin-wf-node" style="border-color:var(--danger);color:var(--danger)">Contested<div style="font-size:8px;margin-top:2px">contradicted</div></div>
        <div class="prin-wf-arrow">\u2192</div>
        <div class="prin-wf-node" style="border-color:var(--danger);opacity:0.5">Dead<div style="font-size:8px;margin-top:2px">killed_by reason</div></div>
      </div>
      <div class="prin-wf-desc" style="margin-top:12px">
        Findings never delete, only die. Status: alive \u2192 contested \u2192 dead with killed_by explanation.<br>
        Confidence is Bayesian with source reliability weights (own_hypothesis 0.40 \u2026 revenue_validated 0.90).<br>
        Promotion to Principle requires: conf >85%, used 3+ times, explicit Florian approval.
      </div>
    </div>`;
  
  html += `</div></div>`;
  
  pv.innerHTML = html;
}

function renderPrincipleCard(p) {
  return `<div class="prin-card">
    <div class="prin-card-num">P${p.num}</div>
    <div class="prin-card-title">
      <span class="approved"></span>
      P${p.num}: ${esc(p.title)}
    </div>
    <div class="prin-card-desc">${esc(p.desc)}</div>
    <div class="prin-card-footer">
      ${p.tags.map(t => `<span class="prin-card-tag">${t}</span>`).join('')}
      ${p.conf !== '\u2014' ? `<span class="prin-card-conf">${p.conf}</span>` : ''}
      <span class="prin-card-source">${esc(p.source)}</span>
    </div>
  </div>`;
}

// ── PIPELINE VIEW ──
let pipelineViewOpen = false;
let connectMode = null; // null or {from: topicId, fromName: string}

async function togglePipelineView() {
  if (VIEW.current === 'pipeline') { switchView('topics'); }
  else { switchView('pipeline'); }
}

async function renderPipelineView() {
  const pv = document.getElementById('pipelineView');
  
  try {
    const [pipeline, detail] = await Promise.all([
      fetch(API+'/pipeline').then(r=>r.json()),
      fetch(API+'/pipeline/detail').then(r=>r.json())
    ]);
    
    const stages = [
      {key:'research', name:'Research', color:'#8e8e8e'},
      {key:'systems', name:'Systems', color:'#6b8aab'},
      {key:'content', name:'Content', color:'#9b8ec4'},
      {key:'revenue', name:'Revenue', color:'var(--warm)'}
    ];
    
    const flowKeys = ['research_to_systems','systems_to_content','content_to_revenue'];
    
    // Connect mode bar
    let html = '';
    if (connectMode) {
      html += `<div class="pv-connect-bar">
        <span>Connecting from <strong>${esc(connectMode.fromName)}</strong> — click a target card</span>
        <button onclick="cancelConnect()">Cancel</button>
      </div>`;
    }
    
    // Header stats
    html += `<div class="pv-header">
      <div>
        <h2>Pipeline Overview</h2>
        <div style="font-size:10px;color:var(--text-dim);margin-top:2px">Research → Systems → Content → Revenue</div>
      </div>
      <div class="pv-header-stats">
        <div class="pv-header-stat"><span class="pv-header-stat-val">${pipeline.total_items}</span><span class="pv-header-stat-label">Topics</span></div>
        <div class="pv-header-stat"><span class="pv-header-stat-val">${pipeline.outcomes}</span><span class="pv-header-stat-label">Completed</span></div>
        <div class="pv-header-stat"><span class="pv-header-stat-val">${pipeline.total_votes}</span><span class="pv-header-stat-label">Votes</span></div>
      </div>
    </div>`;
    
    // Kanban columns with flow arrows
    html += '<div class="pv">';
    
    stages.forEach((s, i) => {
      const topics = detail[s.key] || [];
      const stageStats = pipeline.stages[s.key];
      const pct = Math.round(stageStats.avg_progress);
      
      // Flow arrow between columns
      if (i > 0) {
        const fk = flowKeys[i-1];
        const flow = pipeline.flows && pipeline.flows[fk];
        const convPct = flow ? flow.conversion_pct : 0;
        const flowColor = convPct > 50 ? '#4aa088' : convPct > 0 ? 'var(--warm)' : 'var(--text-dim)';
        html += `<div class="pv-flow">
          <div class="pv-flow-inner">
            <div class="pv-flow-arrow">→</div>
            <div class="pv-flow-rate" style="color:${flowColor}">${flow ? flow.connected : 0}/${flow ? flow.source_count : 0}</div>
          </div>
        </div>`;
      }
      
      html += `<div class="pv-col">
        <div class="pv-col-header" style="border-color:${s.color}30">
          <div class="pv-col-title" style="color:${s.color}">${s.name}</div>
          <div class="pv-col-stats">${topics.length} topics<br>${pct}% avg</div>
        </div>
        <div class="pv-col-body">`;
      
      if (topics.length === 0) {
        html += `<div style="text-align:center;padding:20px 8px;color:var(--text-dim);font-size:10px">
          <div style="opacity:0.15;font-size:16px;margin-bottom:4px">&#9672;</div>
          No ${s.name.toLowerCase()} topics yet
        </div>`;
      }
      
      topics.forEach(t => {
        const connCount = (t.connections_out||[]).length + (t.connections_in||[]).length;
        const stateColor = t.state === 'error' ? 'var(--danger)' : t.state === 'done' ? '#4aa088' : 'var(--text-dim)';
        
        const isSource = connectMode && connectMode.from === t.id;
        const isTarget = connectMode && connectMode.from !== t.id;
        html += `<div class="pv-card${isSource?' connect-source':''}${isTarget?' connect-target':''}" 
          onclick="pvCardClick('${t.id}','${esc(t.name).replace(/'/g,'')}')">
          <div class="pv-card-name">${esc(t.name)}</div>
          <div class="pv-card-meta">
            <div class="pv-card-progress"><div class="pv-card-progress-fill" style="width:${t.progress}%;background:${stateColor}"></div></div>
            <span>${t.progress}%</span>
            ${connCount > 0 ? `<span style="color:var(--warm)">${connCount} conn</span>` : ''}
          </div>`;
        
        // Show connections as tiny badges
        const allConns = [...(t.connections_out||[]), ...(t.connections_in||[])];
        if (allConns.length > 0) {
          html += '<div class="pv-card-connections">';
          allConns.slice(0, 4).forEach(c => {
            const stColor = stages.find(st=>st.key===c.stage);
            html += `<span class="pv-card-conn" style="border-left:2px solid ${stColor?stColor.color:'var(--text-dim)'}">${c.name.substring(0,15)}</span>`;
          });
          if (allConns.length > 4) html += `<span class="pv-card-conn">+${allConns.length-4}</span>`;
          html += '</div>';
        }
        
        // Findings + Connect button
        html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">';
        if (t.findings_alive > 0) {
          html += `<span class="pv-card-findings">${t.findings_alive} finding${t.findings_alive!==1?'s':''}</span>`;
        } else {
          html += '<span></span>';
        }
        if (!connectMode) {
          html += `<button class="finding-btn" onclick="event.stopPropagation();startConnect('${t.id}','${esc(t.name).replace(/'/g,'')}',event)" style="font-size:8px">connect</button>`;
        }
        html += '</div>';
        
        html += '</div>';
      });
      
      html += '</div></div>';
    });
    
    html += '</div>';
    
    // Research lines summary
    if (pipeline.research_lines && pipeline.research_lines.length) {
      html += `<div class="pv-research-lines">
        <div class="pv-rl-title">Research Lines</div>`;
      pipeline.research_lines.forEach(rl => {
        html += `<div class="pv-rl-item">
          <span class="pv-rl-name">${rl.research_line.replace(/-/g,' ')}</span>
          <span><span style="color:var(--text-dim);font-size:10px">${rl.count} findings · avg ${Math.round(rl.avg_conf*100)}%</span> <span class="pv-rl-score">${rl.total_score}</span></span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Orphan alerts
    if (pipeline.orphans && pipeline.orphans.length) {
      html += '<div class="pv-orphan-alert">';
      html += `<strong>Orphan Alert:</strong> ${pipeline.orphans.length} topic${pipeline.orphans.length!==1?'s':''} with no connections for >7 days:`;
      pipeline.orphans.forEach(o => {
        html += ` <span style="cursor:pointer;text-decoration:underline" onclick="togglePipelineView();selectTopic('${o.id}')">${o.name}</span>`;
      });
      html += '</div>';
    }
    
    pv.innerHTML = html;
    
  } catch(e) {
    pv.innerHTML = `<div style="padding:40px;text-align:center;color:var(--danger)">Error loading pipeline: ${e.message}</div>`;
  }
}

function pvCardClick(topicId, topicName) {
  if (!connectMode) {
    // Normal click: navigate to topic - switchView will handle cleanup
    VIEW.current = 'pipeline'; // ensure switchView knows where we are
    selectTopic(topicId);
    return;
  }
  
  if (connectMode.from === topicId) {
    // Clicked same card: cancel
    cancelConnect();
    return;
  }
  
  // Connect mode: create connection
  createConnectionFromPipeline(connectMode.from, topicId, topicName);
}

function startConnect(topicId, topicName, event) {
  event.stopPropagation();
  connectMode = {from: topicId, fromName: topicName};
  renderPipelineView();
}

function cancelConnect() {
  connectMode = null;
  renderPipelineView();
}

async function createConnectionFromPipeline(fromId, toId, toName) {
  const relation = prompt('Relation (how does this connect?):', '');
  if (relation === null) { cancelConnect(); return; }
  
  try {
    const r = await fetch(API+'/connections', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({from: fromId, to: toId, relation: relation || 'related'})
    });
    const data = await r.json();
    if (data.status === 'connected') {
      showSystemMsg(`Connected → ${toName}`);
    }
  } catch(e) {
    showSystemMsg('Error: '+e.message);
  }
  
  connectMode = null;
  renderPipelineView();
}

// ── FINDINGS (CKE) ──

function confBadgeClass(c) { return c >= 0.7 ? 'high' : c >= 0.3 ? 'mid' : 'low'; }

async function loadFindings(topicId) {
  const el = document.getElementById('ctxFindings');
  if (!el) return;
  try {
    const findings = await fetch(API+'/topics/'+topicId+'/findings').then(r=>r.json());
    if (!findings.length) {
      el.innerHTML = `<div style="text-align:center;padding:12px 8px">
        <div style="font-size:18px;opacity:0.15;margin-bottom:6px">&#9672;</div>
        <div style="font-size:10px;color:var(--text-dim);line-height:1.6">No findings yet.<br>Use <span style="color:var(--warm)">+ Finding</span> on Mia messages to extract knowledge.</div>
      </div>`;
      return;
    }
    el.innerHTML = findings.map(f => {
      const cls = f.status === 'dead' ? 'dead' : f.status === 'contested' ? 'contested' : '';
      const confClass = confBadgeClass(f.confidence);
      const tags = (f.tags||[]).slice(0,3).join(', ');
      return `<div class="ctx-finding ${cls}" onclick="toggleFindingDetail(this,'${f.id}')" style="cursor:pointer">
        <div class="ctx-finding-claim">${esc(f.claim)}</div>
        <div class="ctx-finding-meta">
          <span class="ctx-finding-id">${f.id}</span>
          <span class="conf-badge ${confClass}">${Math.round(f.confidence*100)}%</span>
          ${f.verified ? '<span style="color:#4a9" title="Verified">&#10003;</span>' : ''}
          ${f.source_type==='agent_verified' && !f.verified ? '<span style="color:var(--warm)" title="Agent verified, needs human check">&#9888;</span>' : ''}
          ${f.compound_score > 0 ? `<span class="compound-score">${f.compound_score.toFixed(1)}</span>` : ''}
          <span>${f.status}</span>
        </div>
        ${tags ? `<div style="font-size:9px;color:var(--text-dim);margin-top:2px">${tags}</div>` : ''}
        <div class="finding-actions" onclick="event.stopPropagation()">
          <button class="finding-btn" onclick="validateFinding('${f.id}','support')">support</button>
          <button class="finding-btn" onclick="validateFinding('${f.id}','contradict')">contradict</button>
          ${f.status==='contested'?`<button class="finding-btn" style="border-color:var(--danger);color:var(--danger)" onclick="killFinding('${f.id}')">kill</button>`:''}
        </div>
        <div class="ctx-finding-detail" id="finding-detail-${f.id}">
          <div style="text-align:center;color:var(--text-dim);padding:4px">Loading...</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = '<div style="font-size:10px;color:var(--danger)">Error loading findings</div>';
  }
}

async function toggleFindingDetail(el, findingId) {
  const wasExpanded = el.classList.contains('expanded');
  
  // Collapse all others
  document.querySelectorAll('.ctx-finding.expanded').forEach(f => f.classList.remove('expanded'));
  
  if (wasExpanded) return;
  
  el.classList.add('expanded');
  const detailEl = document.getElementById('finding-detail-'+findingId);
  if (!detailEl) return;
  
  try {
    const [finding, related] = await Promise.all([
      fetch(API+'/findings/'+findingId).then(r=>r.json()),
      fetch(API+'/findings/'+findingId+'/related').then(r=>r.json())
    ]);
    
    let html = '';
    
    // Source
    if (finding.source_type || finding.source_detail) {
      html += `<div class="finding-detail-section">
        <div class="finding-detail-label">Source</div>
        <div>${finding.source_type||''} ${finding.source_detail ? '— '+esc(finding.source_detail) : ''}
          ${finding.source_url ? `<br><a href="${esc(finding.source_url)}" target="_blank" style="color:var(--warm);text-decoration:underline;font-size:9px">${esc(finding.source_url.substring(0,60))}</a>` : ''}
        </div>
        ${!finding.verified ? `<button class="finding-btn" style="margin-top:4px;border-color:#4a9;color:#4a9" onclick="event.stopPropagation();verifyFinding('${findingId}',this)">&#10003; Verify</button>` : '<div style="color:#4a9;margin-top:2px">&#10003; Human verified</div>'}
      </div>`;
    }
    
    // Context
    if (finding.context) {
      html += `<div class="finding-detail-section">
        <div class="finding-detail-label">Context</div>
        <div>${esc(finding.context)}</div>
      </div>`;
    }
    
    // Confidence History
    if (finding.confidence_history && finding.confidence_history.length > 1) {
      html += `<div class="finding-detail-section">
        <div class="finding-detail-label">Confidence History</div>`;
      finding.confidence_history.slice(0, 5).forEach(h => {
        const oldPct = Math.round((h.old_confidence||0)*100);
        const newPct = Math.round((h.new_confidence||0)*100);
        html += `<div class="finding-history-item">
          <span class="old">${oldPct}%</span>
          <span>→</span>
          <span class="new">${newPct}%</span>
          <span style="color:var(--text-dim)">${h.reason||''}</span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Related Findings
    if (related.length > 0) {
      html += `<div class="finding-detail-section">
        <div class="finding-detail-label">Related Findings</div>`;
      related.slice(0, 5).forEach(r => {
        const confClass = confBadgeClass(r.confidence);
        html += `<div class="finding-related-item">
          <span style="font-family:monospace">${r.id}</span>
          <span class="conf-badge ${confClass}">${Math.round(r.confidence*100)}%</span>
          <span>${esc(r.claim.substring(0, 60))}${r.claim.length>60?'...':''}</span>
        </div>`;
      });
      html += '</div>';
    }
    
    // Killed by
    if (finding.status === 'dead' && finding.killed_by) {
      html += `<div class="finding-detail-section">
        <div class="finding-detail-label" style="color:var(--danger)">Killed By</div>
        <div>${esc(finding.killed_by)}</div>
      </div>`;
    }
    
    detailEl.innerHTML = html || '<div style="color:var(--text-dim)">No additional details.</div>';
  } catch(e) {
    detailEl.innerHTML = `<div style="color:var(--danger)">Error: ${e.message}</div>`;
  }
}

let _findingMsgId = null;

function openFindingForm(messageId, preview) {
  _findingMsgId = messageId;
  const decoded = preview.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/<br>/g,' ').substring(0,300);
  document.getElementById('ffClaim').value = decoded;
  document.getElementById('ffConf').value = 50;
  document.getElementById('ffConfVal').textContent = '50%';
  document.getElementById('ffConfVal').style.color = 'var(--warm)';
  document.getElementById('ffSource').value = 'conversation';
  document.getElementById('ffTags').value = '';
  document.getElementById('ffContext').value = '';
  document.getElementById('ffSubmit').disabled = false;
  document.getElementById('findingOverlay').classList.add('open');
  setTimeout(() => document.getElementById('ffClaim').focus(), 100);
}

function closeFindingForm() {
  document.getElementById('findingOverlay').classList.remove('open');
  _findingMsgId = null;
}

async function submitFinding() {
  const claim = document.getElementById('ffClaim').value.trim();
  if (!claim) { document.getElementById('ffClaim').style.borderColor = 'var(--danger)'; return; }
  
  const btn = document.getElementById('ffSubmit');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  
  const conf = parseInt(document.getElementById('ffConf').value) / 100;
  const source = document.getElementById('ffSource').value;
  const tagsRaw = document.getElementById('ffTags').value;
  const tags = tagsRaw ? tagsRaw.split(',').map(t=>t.trim().toLowerCase().replace(/\s+/g,'_')).filter(Boolean) : [];
  const context = document.getElementById('ffContext').value.trim();
  
  try {
    const r = await fetch(API+'/findings', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        claim,
        confidence: conf,
        tags,
        source_type: source,
        context: context || undefined,
        extracted_from: _findingMsgId ? 'message_'+_findingMsgId : undefined,
        topic_id: currentTopic
      })
    });
    const data = await r.json();
    if (data.id) {
      closeFindingForm();
      showSystemMsg(`Finding ${data.id} saved (${Math.round(conf*100)}%)`);
      if (data.potential_contradictions && data.potential_contradictions.length) {
        showSystemMsg(`Potential contradiction: ${data.potential_contradictions.map(c=>c.id+': '+c.claim.substring(0,50)).join(' | ')}`);
      }
      loadFindings(currentTopic);
    } else {
      btn.textContent = 'Save Finding';
      btn.disabled = false;
      showSystemMsg('Error: ' + (data.detail || 'Unknown error'));
    }
  } catch(e) {
    btn.textContent = 'Save Finding';
    btn.disabled = false;
    showSystemMsg('Error: '+e.message);
  }
}

// Keyboard: Escape closes finding form
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && document.getElementById('findingOverlay').classList.contains('open')) {
    closeFindingForm();
  }
});

async function validateFinding(findingId, direction) {
  // Inline: use a small prompt for reason (acceptable for single field)
  // But build a proper one later. For now, use confirm-style approach.
  const btn = event.target;
  const oldText = btn.textContent;
  btn.disabled = true;
  btn.textContent = '...';
  
  try {
    const r = await fetch(API+'/findings/'+findingId+'/validate', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        direction,
        source_type: 'own_data',
        reason: direction
      })
    });
    const data = await r.json();
    showSystemMsg(`${findingId}: ${Math.round(data.old_confidence*100)}% → ${Math.round(data.new_confidence*100)}%`);
    loadFindings(currentTopic);
  } catch(e) {
    showSystemMsg('Error: '+e.message);
  } finally {
    btn.textContent = oldText;
    btn.disabled = false;
  }
}

async function killFinding(findingId) {
  const reason = prompt('Why is this finding dead?', '');
  if (!reason) return;
  
  try {
    await fetch(API+'/findings/'+findingId, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ status: 'dead', killed_by: reason })
    });
    showSystemMsg(`${findingId} killed: ${reason}`);
    loadFindings(currentTopic);
  } catch(e) {
    showSystemMsg('Error: '+e.message);
  }
}

async function verifyFinding(findingId, btnEl) {
  try {
    const r = await fetch(API+'/findings/'+findingId+'/verify', {method:'POST'});
    const data = await r.json();
    if (btnEl) btnEl.outerHTML = '<div style="color:#4a9;margin-top:2px">&#10003; Verified ('+Math.round(data.new_confidence*100)+'%)</div>';
    showSystemMsg(`${findingId} verified: ${Math.round(data.old_confidence*100)}% → ${Math.round(data.new_confidence*100)}%`);
    loadFindings(currentTopic);
  } catch(e) {
    showSystemMsg('Error: '+e.message);
  }
}

// ── WEBSOCKET ──
let ws = null;
let wsRetry = 0;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');
  
  ws.onopen = () => {
    wsRetry = 0;
    document.getElementById('wsStatus').style.background = '#4a9';
    // Remove disconnect banner
    const banner = document.getElementById('wsBanner');
    if (banner) banner.remove();
    console.log('[ws] connected');
    // Ping every 30s to keep alive
    ws._ping = setInterval(() => { try { ws.send('ping'); } catch(e) {} }, 30000);
  };
  
  // Debounced reload — collect events, fire once after 300ms
  let _reloadTimer = null;
  let _pendingReloads = {topic: false, list: false, pipeline: false, trust: false};
  
  function scheduleReload(what) {
    _pendingReloads[what] = true;
    if (_reloadTimer) clearTimeout(_reloadTimer);
    _reloadTimer = setTimeout(() => {
      const conv = document.getElementById('conv');
      const wasAtBottom = conv.scrollHeight - conv.scrollTop - conv.clientHeight < 60;
      const oldScroll = conv.scrollTop;
      
      if (_pendingReloads.topic && currentTopic) {
        selectTopic(currentTopic).then(() => {
          // Preserve scroll unless user was at bottom
          if (wasAtBottom) conv.scrollTop = conv.scrollHeight;
          else conv.scrollTop = oldScroll;
        });
      }
      if (_pendingReloads.list) loadFolderTree();
      if (_pendingReloads.pipeline) loadPipeline();
      if (_pendingReloads.trust) loadTrust();
      
      _pendingReloads = {topic: false, list: false, pipeline: false, trust: false};
      _reloadTimer = null;
    }, 300);
  }
  
  ws.onmessage = (e) => {
    const event = JSON.parse(e.data);
    if (event.type === 'pong') return;
    
    if (event.type === 'message') {
      if (event.topic_id === currentTopic) scheduleReload('topic');
      scheduleReload('list');
    }
    
    if (event.type === 'topic_update') {
      if (event.topic_id === currentTopic) scheduleReload('topic');
      scheduleReload('list');
      scheduleReload('pipeline');
    }
    
    if (event.type === 'folder_update') {
      scheduleReload('list');
    }
    
    if (event.type === 'trust_update') {
      scheduleReload('trust');
    }
    
    if (event.type === 'standup_update') {
      if (operationsViewOpen) renderOperationsView();
      loadOperationsScore();
    }
    
    if (event.type === 'finding_created' || event.type === 'finding_updated') {
      if (currentTopic) loadFindings(currentTopic);
    }
  };
  
  ws.onclose = () => {
    document.getElementById('wsStatus').style.background = 'var(--danger)';
    console.log('[ws] disconnected, retry #' + (wsRetry+1));
    clearInterval(ws._ping);
    // Show disconnect banner after 3s
    if (!document.getElementById('wsBanner')) {
      const banner = document.createElement('div');
      banner.id = 'wsBanner';
      banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:var(--danger);color:white;text-align:center;padding:6px;font-size:11px;z-index:500;font-weight:500';
      banner.textContent = 'Verbindung verloren — Reconnect...';
      document.body.appendChild(banner);
    }
    wsRetry++;
    const delay = Math.min(1000 * Math.pow(2, wsRetry), 10000);
    setTimeout(connectWS, delay);
  };
  
  ws.onerror = () => { ws.close(); };
}

// ── START ──
init();
connectWS();
</script>
</body>
</html>
