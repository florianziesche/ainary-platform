<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Execution Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0a;--surface:#141414;--surface-2:#1a1a1a;--border:#1e1e1e;--border-light:#2a2a2a;--text:#ececec;--text-muted:#8e8e8e;--text-dim:#555;--warm:#d4a853;--danger:#c47070}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;height:100vh;display:flex;overflow:hidden}

/* Left */
.left{width:280px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0}
.left-header{padding:20px;border-bottom:1px solid var(--border)}
.left-header h1{font-size:14px;font-weight:600}
.left-header p{font-size:10px;color:var(--text-dim);margin-top:2px}

.pipeline{border-bottom:1px solid var(--border)}
.pipe-stage{display:flex;align-items:center;padding:10px 20px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;gap:12px}
.pipe-stage:hover{background:rgba(255,255,255,0.03)}
.pipe-stage.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.pipe-icon{font-size:12px;width:20px;text-align:center;color:var(--text-dim);font-weight:700}
.pipe-info{flex:1}
.pipe-name{font-size:12px;font-weight:600;color:var(--text-muted)}
.pipe-stage.active .pipe-name{color:var(--text)}
.pipe-count{font-size:10px;color:var(--text-dim);margin-top:1px}
.pipe-bar{width:40px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
.pipe-fill{height:100%;background:var(--text-dim);border-radius:2px;transition:width 0.3s}
.pipe-arrow{text-align:center;padding:2px 0;color:var(--border-light);font-size:8px}

.topic-list{flex:1;overflow-y:auto}
.topic-section-label{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);padding:12px 20px 6px}
.topic-item{padding:10px 20px;cursor:pointer;transition:all 0.1s;border-left:2px solid transparent;display:flex;align-items:center;gap:10px}
.topic-item:hover{background:rgba(255,255,255,0.02)}
.topic-item.active{background:rgba(255,255,255,0.04);border-left-color:var(--text-muted)}
.topic-dot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.topic-dot.unread{background:var(--warm)}
.topic-info{flex:1;min-width:0}
.topic-name{font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.topic-meta{font-size:10px;color:var(--text-dim);margin-top:1px}
.topic-pct{font-size:10px;color:var(--text-dim)}

.trust-footer{padding:10px 20px;border-top:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap}
.trust-mini{font-size:9px;color:var(--text-dim)}

/* Right */
.right-wrap{flex:1;display:flex;overflow:hidden}
.right{flex:1;display:flex;flex-direction:column;min-width:0}
.right-header{padding:14px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.right-header-left h2{font-size:15px;font-weight:600}
.right-header-left .sub{font-size:11px;color:var(--text-dim);margin-top:1px}
.hdr-btns{display:flex;gap:6px}
.hdr-btn{padding:6px 12px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit;transition:all 0.12s}
.hdr-btn:hover{border-color:var(--border-light);color:var(--text)}
.hdr-btn.on{background:rgba(255,255,255,0.06);border-color:var(--text-dim);color:var(--text)}

/* Steps */
.steps-bar{padding:12px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:0;overflow-x:auto}
.sn{display:flex;align-items:center;gap:0;flex-shrink:0}
.sc{width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--text-dim);flex-shrink:0;cursor:pointer;transition:all 0.15s}
.sc:hover{border-color:var(--text-muted)}
.sc.done{border-color:var(--text-dim);color:var(--text-dim);background:rgba(255,255,255,0.04)}
.sc.now{border-color:var(--warm);color:var(--warm)}
.sl{font-size:9px;color:var(--text-dim);margin-left:3px;margin-right:8px;white-space:nowrap}
.sl.done{color:var(--text-dim);text-decoration:line-through}
.sl.now{color:var(--text-muted)}
.sline{width:16px;height:1px;background:var(--border);flex-shrink:0}
.sline.done{background:var(--text-dim)}

/* Conversation */
.conv{flex:1;overflow-y:auto;padding:20px 24px}
.msg{margin-bottom:16px;max-width:80%}
.msg.mia{margin-right:auto}
.msg.human{margin-left:auto}
.msg.system{margin:0 auto;max-width:100%}
.sender{font-size:10px;color:var(--text-dim);margin-bottom:3px;font-weight:500}
.bubble{padding:12px 16px;border-radius:8px;font-size:12px;line-height:1.7}
.mia .bubble{background:var(--surface);border:1px solid var(--border)}
.human .bubble{background:rgba(255,255,255,0.04);border:1px solid var(--border-light)}
.system .bubble{background:none;border:1px dashed var(--border);text-align:center;color:var(--text-dim);font-size:11px;padding:8px}
.time{font-size:9px;color:var(--text-dim);margin-top:3px}

/* Proposals */
.proposal{margin-top:10px;border:1px solid var(--border);border-radius:6px;overflow:hidden}
.proposal-head{padding:10px 14px;display:flex;align-items:center;justify-content:space-between;font-size:11px}
.proposal-type{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim)}
.proposal-confidence{font-size:10px;color:var(--text-dim)}
.proposal-body{padding:0 14px 12px;font-size:12px;color:var(--text-muted);line-height:1.6}

/* Expandable options */
.exp-opt{border:1px solid var(--border);border-radius:6px;margin:6px 14px;cursor:pointer;transition:all 0.15s;overflow:hidden}
.exp-opt:hover{border-color:var(--border-light)}
.exp-opt.open{border-color:var(--text-dim)}
.exp-opt.chosen{border-color:var(--warm)}
.opt-hd{display:flex;align-items:center;gap:8px;padding:10px 12px}
.opt-key{width:20px;height:20px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:var(--surface-2);color:var(--text-dim);border:1px solid var(--border);flex-shrink:0}
.exp-opt.open .opt-key{background:var(--text);color:var(--bg);border-color:var(--text)}
.exp-opt.chosen .opt-key{background:var(--warm);color:var(--bg);border-color:var(--warm)}
.opt-title{font-size:11px;color:var(--text-muted)}
.exp-opt.open .opt-title,.exp-opt.chosen .opt-title{color:var(--text)}
.opt-rec{font-size:9px;color:var(--warm);margin-left:auto}
.opt-body{display:none;padding:0 12px 12px;border-top:1px solid var(--border)}
.exp-opt.open .opt-body{display:block;padding-top:10px}
.opt-desc{font-size:11px;color:var(--text-muted);margin-bottom:8px;line-height:1.5}
.draft-box{background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:11px;color:var(--text-muted);line-height:1.7;white-space:pre-wrap;margin-bottom:8px}
.draft-box b{color:var(--text);font-weight:500}
.draft-label{font-size:9px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);margin-bottom:4px;font-weight:600}

/* Vote row */
.vote-row{display:flex;align-items:center;gap:6px;padding:8px 14px;border-top:1px solid var(--border)}
.vote-btn{display:flex;align-items:center;gap:4px;padding:4px 10px;border-radius:3px;font-size:10px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-dim);font-family:inherit;transition:all 0.15s}
.vote-btn:hover{border-color:var(--border-light);color:var(--text-muted)}
.vote-btn.voted.up{border-color:var(--warm);color:var(--warm);background:rgba(212,168,83,0.06)}
.vote-btn.voted.down{border-color:var(--danger);color:var(--danger);background:rgba(196,112,112,0.06)}
.vote-status{font-size:10px;color:var(--warm);margin-left:auto;display:none}
.vote-status.show{display:block}

/* Action buttons */
.act-row{display:flex;gap:6px;flex-wrap:wrap}
.act{padding:6px 14px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;border:none;font-family:inherit;transition:all 0.15s}
.act-p{background:var(--text);color:var(--bg)}
.act-p:hover{background:#fff}
.act-g{background:none;border:1px solid var(--border);color:var(--text-muted)}
.act-g:hover{border-color:var(--border-light);color:var(--text)}

/* Input */
.input-area{padding:12px 24px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.input-field{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:12px;color:var(--text);font-family:inherit;resize:none;outline:none;min-height:40px;max-height:120px;line-height:1.5}
.input-field:focus{border-color:var(--text-dim)}
.input-field::placeholder{color:var(--text-dim)}
.send-btn{padding:10px 16px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;flex-shrink:0}
.send-btn:hover{background:#fff}

/* Context panel */
.ctx{width:0;overflow:hidden;border-left:1px solid var(--border);background:var(--surface);transition:width 0.2s;flex-shrink:0}
.ctx.open{width:260px}
.ctx-inner{width:260px;overflow-y:auto;padding:0;height:100%}
.ctx-sec{border-bottom:1px solid var(--border);padding:14px 16px}
.ctx-sec-title{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim);margin-bottom:8px}
.ctx-doc{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:3px;cursor:pointer;margin-bottom:2px;font-size:11px;color:var(--text-muted)}
.ctx-doc:hover{background:rgba(255,255,255,0.03)}
.ctx-doc-icon{width:24px;height:24px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;background:rgba(255,255,255,0.04);color:var(--text-dim);flex-shrink:0}
.ctx-conn{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:3px;cursor:pointer;margin-bottom:2px;font-size:11px;color:var(--text-muted)}
.ctx-conn:hover{background:rgba(255,255,255,0.03)}
.ctx-conn-dot{width:5px;height:5px;border-radius:50%;background:var(--text-dim);flex-shrink:0}
.ctx-rel{font-size:9px;color:var(--text-dim)}
.ctx-truth{padding:6px 8px;border-left:2px solid var(--border-light);margin-bottom:6px;font-size:10px;line-height:1.5;color:var(--text-dim)}

.ctx-doc{cursor:pointer;transition:all 0.12s}
.ctx-doc:hover .ctx-doc-icon{background:var(--warm);color:var(--bg)}

/* File viewer overlay */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center}
.overlay.open{display:flex}
.overlay-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;width:680px;max-width:90vw;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.overlay-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border)}
.overlay-title{font-size:13px;font-weight:600}
.overlay-path{font-size:10px;color:var(--text-dim);margin-top:2px;font-family:monospace}
.overlay-close{width:28px;height:28px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--text-muted);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.overlay-close:hover{border-color:var(--text-dim);color:var(--text)}
.overlay-body{flex:1;overflow-y:auto;padding:18px;font-size:12px;line-height:1.8;color:var(--text-muted);white-space:pre-wrap;font-family:'SF Mono',Menlo,monospace}
.overlay-body .loading{padding:20px}
.overlay-actions{display:flex;gap:6px;padding:12px 18px;border-top:1px solid var(--border)}
.overlay-actions button{padding:6px 14px;border-radius:4px;font-size:11px;cursor:pointer;border:1px solid var(--border);background:none;color:var(--text-muted);font-family:inherit}
.overlay-actions button:hover{border-color:var(--text-dim);color:var(--text)}
.overlay-actions button.primary{background:var(--text);color:var(--bg);border-color:var(--text)}

.loading{text-align:center;padding:40px;color:var(--text-dim);font-size:12px}
</style>
</head>
<body>

<div class="left">
  <div class="left-header">
    <h1>Execution Platform <span id="wsStatus" style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--danger);margin-left:6px;vertical-align:middle;transition:background 0.3s"></span></h1>
    <p>Research → Systems → Content → Revenue</p>
  </div>
  <div class="pipeline" id="pipeline"></div>
  <div class="topic-list" id="topicList"><div class="loading">Loading...</div></div>
  <div class="trust-footer" id="trustFooter"></div>
</div>

<div class="right-wrap">
<div class="right">
  <div class="right-header">
    <div class="right-header-left">
      <h2 id="topicTitle">Select a topic</h2>
      <div class="sub" id="topicSub"></div>
    </div>
    <div class="hdr-btns">
      <button class="hdr-btn" id="genCvBtn" style="display:none" onclick="generateCV()">Generate CV</button>
      <button class="hdr-btn" id="ctxBtn" onclick="toggleCtx()">Context</button>
      <button class="hdr-btn" onclick="openFiles()">Files</button>
    </div>
  </div>
  <div class="steps-bar" id="stepsBar"></div>
  <div class="conv" id="conv"><div class="loading">Select a topic to start</div></div>
  <div class="input-area">
    <textarea class="input-field" id="inputField" placeholder="Add context, decide, give feedback..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg()}"></textarea>
    <button class="send-btn" onclick="sendMsg()">Send</button>
  </div>
</div>
<div class="ctx" id="ctxPanel"><div class="ctx-inner" id="ctxInner"></div></div>

<!-- File Viewer Overlay -->
<div class="overlay" id="fileOverlay" onclick="if(event.target===this)closeOverlay()">
  <div class="overlay-box">
    <div class="overlay-hdr">
      <div>
        <div class="overlay-title" id="overlayTitle">File</div>
        <div class="overlay-path" id="overlayPath"></div>
      </div>
      <button class="overlay-close" onclick="closeOverlay()">✕</button>
    </div>
    <div class="overlay-body" id="overlayBody"><div class="loading">Loading...</div></div>
    <div class="overlay-actions">
      <button onclick="copyFileContent()">Copy Content</button>
      <button id="overlayOpenBtn" style="display:none" onclick="openExternal()">Open External</button>
    </div>
  </div>
</div>
</div>

<script>
const API = 'http://localhost:8080/api';
let currentTopic = null;
let topicsCache = {};

// ── INIT ──
async function init() {
  await loadPipeline();
  await loadTopics();
  await loadTrust();
}

// ── PIPELINE ──
async function loadPipeline() {
  const r = await fetch(API+'/pipeline').then(r=>r.json());
  const el = document.getElementById('pipeline');
  const stages = [
    {key:'research',icon:'R',name:'Research'},
    {key:'systems',icon:'S',name:'Systems'},
    {key:'content',icon:'C',name:'Content'},
    {key:'revenue',icon:'€',name:'Revenue'}
  ];
  el.innerHTML = stages.map((s,i) => {
    const d = r.stages[s.key];
    const pct = Math.round(d.avg_progress);
    return (i>0?'<div class="pipe-arrow">↓</div>':'')+
    `<div class="pipe-stage" onclick="filterStage('${s.key}',this)">
      <div class="pipe-icon">${s.icon}</div>
      <div class="pipe-info">
        <div class="pipe-name">${s.name}</div>
        <div class="pipe-count">${d.count} items · ${pct}% avg</div>
      </div>
      <div class="pipe-bar"><div class="pipe-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

// ── TOPICS ──
async function loadTopics(stageFilter) {
  const url = stageFilter ? API+'/topics?stage='+stageFilter : API+'/topics';
  const topics = await fetch(url).then(r=>r.json());
  const el = document.getElementById('topicList');
  
  // Group by stage
  const groups = {};
  topics.forEach(t => {
    topicsCache[t.id] = t;
    if (!groups[t.stage]) groups[t.stage] = [];
    groups[t.stage].push(t);
  });
  
  const stageLabels = {revenue:'Revenue Pipeline',content:'Content Pipeline',systems:'Systems',research:'Research'};
  let html = '';
  for (const stage of ['revenue','content','systems','research']) {
    if (!groups[stage]) continue;
    html += `<div class="topic-section-label">${stageLabels[stage]}</div>`;
    groups[stage].forEach(t => {
      const meta = JSON.parse(t.meta||'{}');
      const isActive = currentTopic === t.id;
      html += `<div class="topic-item${isActive?' active':''}" onclick="selectTopic('${t.id}')">
        <div class="topic-dot${t.progress<20?' unread':''}"></div>
        <div class="topic-info">
          <div class="topic-name">${t.name}</div>
          <div class="topic-meta">${t.stage}${meta.contact?' · '+meta.contact:''}</div>
        </div>
        <div class="topic-pct">${t.progress}%</div>
      </div>`;
    });
  }
  el.innerHTML = html;
}

function filterStage(stage, el) {
  document.querySelectorAll('.pipe-stage').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  loadTopics(stage);
}

// ── SELECT TOPIC ──
async function selectTopic(id) {
  currentTopic = id;
  // Highlight in list
  document.querySelectorAll('.topic-item').forEach(t=>t.classList.remove('active'));
  const items = document.querySelectorAll('.topic-item');
  items.forEach(t => { if(t.onclick.toString().includes(id)) t.classList.add('active'); });
  
  // Load full topic
  const topic = await fetch(API+'/topics/'+id).then(r=>r.json());
  const meta = JSON.parse(topic.meta||'{}');
  
  // Header
  document.getElementById('topicTitle').textContent = topic.name;
  document.getElementById('topicSub').textContent = 
    topic.stage + (meta.contact?' · '+meta.contact:'') + (meta.email?' · '+meta.email:'') + (meta.potential?' · '+meta.potential:'');
  
  // Show Generate CV button for fund topics
  const cvFunds = ['betaworks','bloomberg','bloomberg-beta','conviction','firstmark','generalcatalyst','glasswing','insight','lionheart','lux','point72','ibm-ventures','futuresight'];
  const cvBtn = document.getElementById('genCvBtn');
  cvBtn.style.display = cvFunds.includes(id) ? 'inline-block' : 'none';
  
  // Steps
  renderSteps(topic.steps);
  
  // Messages
  renderMessages(topic.messages);
  
  // Context panel
  renderContext(topic);
  
  // Re-highlight active topic
  loadTopics();
}

// ── STEPS ──
function renderSteps(steps) {
  const el = document.getElementById('stepsBar');
  if (!steps.length) { el.innerHTML = ''; return; }
  
  // Find first undone step
  const currentIdx = steps.findIndex(s => !s.done);
  
  el.innerHTML = steps.map((s, i) => {
    const isDone = s.done;
    const isCurrent = i === currentIdx;
    const cls = isDone ? 'done' : (isCurrent ? 'now' : '');
    const check = isDone ? '&#10003;' : (i+1);
    const lineClass = i > 0 ? (steps[i-1].done ? 'done' : '') : '';
    const line = i > 0 ? `<div class="sline ${lineClass}"></div>` : '';
    return `${line}<div class="sn"><div class="sc ${cls}" onclick="toggleStep(${s.id})">${check}</div><span class="sl ${cls}">${s.label}</span></div>`;
  }).join('');
}

async function toggleStep(stepId) {
  await fetch(API+'/steps/'+stepId, {method:'PATCH'});
  if (currentTopic) selectTopic(currentTopic);
}

// ── MESSAGES ──
function renderMessages(messages) {
  const el = document.getElementById('conv');
  if (!messages.length) {
    el.innerHTML = '<div class="msg system"><div class="bubble">No messages yet. Start the conversation below.</div></div>';
    return;
  }
  
  el.innerHTML = messages.map(m => {
    const cls = m.sender === 'mia' ? 'mia' : (m.sender === 'system' ? 'system' : 'human');
    let proposalHtml = '';
    
    if (m.proposals && m.proposals.length) {
      m.proposals.forEach(p => {
        const options = p.options || [];
        const votes = p.votes || {};
        const hasVoted = (votes.up||0) + (votes.down||0) > 0;
        
        proposalHtml += `<div class="proposal">
          <div class="proposal-head">
            <span class="proposal-type">${p.proposal_type}</span>
            ${p.confidence ? `<span class="proposal-confidence">${p.confidence}% — ${p.confidence_reason||''}</span>` : ''}
          </div>
          <div class="proposal-body">${p.content}</div>`;
        
        // Options
        if (options.length) {
          options.forEach((opt, oi) => {
            const letter = String.fromCharCode(65+oi);
            const isChosen = p.chosen_option === letter;
            proposalHtml += `<div class="exp-opt${isChosen?' chosen':''}" onclick="toggleOpt(this)">
              <div class="opt-hd">
                <span class="opt-key">${letter}</span>
                <span class="opt-title">${opt.title}</span>
                ${opt.recommended?'<span class="opt-rec">Recommended</span>':''}
              </div>
              <div class="opt-body">
                <div class="opt-desc">${opt.description||''}</div>
                ${opt.draft ? `<div class="draft-box"><div class="draft-label">Draft</div>${opt.draft}</div>` : ''}
                <div class="act-row">
                  <button class="act act-p" onclick="event.stopPropagation();chooseOption(${p.id},'${letter}')">Select ${letter}</button>
                  ${opt.draft ? `<button class="act act-g" onclick="event.stopPropagation();copyDraft(this)">Copy</button>` : ''}
                </div>
              </div>
            </div>`;
          });
        }
        
        // Votes
        proposalHtml += `<div class="vote-row">
          <button class="vote-btn${hasVoted&&votes.up?' voted up':''}" onclick="voteProposal(${p.id},'up',this)"><span>↑</span> Useful</button>
          <button class="vote-btn${hasVoted&&votes.down?' voted down':''}" onclick="voteProposal(${p.id},'down',this)"><span>↓</span> Off</button>
          <span class="vote-status${hasVoted?' show':''}">Trust updated</span>
        </div></div>`;
      });
    }
    
    return `<div class="msg ${cls}">
      ${cls!=='system'?`<div class="sender">${m.sender==='mia'?'Mia':'Florian'}</div>`:''}
      <div class="bubble">${m.content}${proposalHtml}</div>
      <div class="time">${new Date(m.created_at).toLocaleString('de-DE',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</div>
    </div>`;
  }).join('');
  
  el.scrollTop = el.scrollHeight;
}

// ── ACTIONS ──
function toggleOpt(el) {
  const sibs = el.parentElement.querySelectorAll('.exp-opt');
  sibs.forEach(s => { if(s!==el) s.classList.remove('open'); });
  el.classList.toggle('open');
}

async function chooseOption(proposalId, option) {
  await fetch(API+'/proposals/'+proposalId+'/choose', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({option})
  });
  // WebSocket will trigger the reload
}

async function voteProposal(proposalId, dir, btn) {
  await fetch(API+'/proposals/'+proposalId+'/vote', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({direction:dir})
  });
  const row = btn.parentElement;
  row.querySelectorAll('.vote-btn').forEach(b => { b.style.pointerEvents='none'; });
  btn.classList.add('voted',dir);
  row.querySelector('.vote-status').classList.add('show');
  loadTrust(); // Refresh trust scores
}

async function sendMsg() {
  const f = document.getElementById('inputField');
  const t = f.value.trim();
  if (!t || !currentTopic) return;
  f.value = '';
  f.style.height = 'auto';
  await postMessage('human', t);
  // WebSocket will trigger the reload
}

async function postMessage(sender, content) {
  if (!currentTopic) return;
  await fetch(API+'/topics/'+currentTopic+'/messages', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({sender, content, msg_type:'text'})
  });
}

// ── CONTEXT ──
function renderContext(topic) {
  const el = document.getElementById('ctxInner');
  const meta = JSON.parse(topic.meta||'{}');
  
  let html = '';
  
  // Details
  html += `<div class="ctx-sec"><div class="ctx-sec-title">Details</div>
    <div style="font-size:11px;color:var(--text-muted);line-height:1.7">
    <div><b style="color:var(--text);font-weight:500">${topic.name}</b></div>
    <div>Stage: ${topic.stage} · Progress: ${topic.progress}%</div>
    ${meta.contact?`<div>Contact: ${meta.contact}</div>`:''}
    ${meta.email?`<div>Email: ${meta.email}</div>`:''}
    ${meta.potential?`<div>Potential: ${meta.potential}</div>`:''}
    </div></div>`;
  
  // Documents
  if (topic.documents && topic.documents.length) {
    html += `<div class="ctx-sec"><div class="ctx-sec-title">Documents</div>`;
    topic.documents.forEach(d => {
      const icon = (d.doc_type||'').toUpperCase().slice(0,3);
      let href = '#';
      if (d.url) href = d.url;
      else if (d.path) href = '/view/' + encodeURI(d.path);
      else if (d.doc_type === 'email') href = 'https://mail.google.com/mail/u/0/#search/' + encodeURIComponent(d.name);
      const sub = d.url || d.path || (d.doc_type==='email' ? 'Search in Gmail' : '');
      html += `<a class="ctx-doc" href="${href}" target="_blank" style="text-decoration:none;color:inherit">
        <div class="ctx-doc-icon">${icon}</div>
        <div><div>${d.name}</div>${sub ? `<div style="font-size:9px;color:var(--text-dim)">${sub}</div>` : ''}</div>
      </a>`;
    });
    html += '</div>';
  }
  
  // References (Golden Standard / Expected Outcome)
  if (topic.references && topic.references.length) {
    html += `<div class="ctx-sec"><div class="ctx-sec-title" style="color:var(--warm)">⬥ References</div>`;
    topic.references.forEach(d => {
      const icon = (d.doc_type||'').toUpperCase().slice(0,3);
      let href = '#';
      if (d.url) href = d.url;
      else if (d.path) href = '/view/' + encodeURI(d.path);
      const sub = d.url || d.path || '';
      html += `<a class="ctx-doc" href="${href}" target="_blank" style="text-decoration:none;color:inherit;border-left:2px solid var(--warm);padding-left:6px;margin-left:-6px">
        <div class="ctx-doc-icon" style="background:rgba(212,168,83,0.1);color:var(--warm);border-color:rgba(212,168,83,0.2)">${icon}</div>
        <div><div>${d.name}</div>${sub ? `<div style="font-size:9px;color:var(--text-dim)">${sub}</div>` : ''}</div>
      </a>`;
    });
    html += '</div>';
  }

  // Connections
  if (topic.connections && topic.connections.length) {
    html += `<div class="ctx-sec"><div class="ctx-sec-title">Connected Topics</div>`;
    topic.connections.forEach(c => {
      html += `<a class="ctx-conn" href="#" onclick="event.preventDefault();selectTopic('${c.to_topic}')" style="text-decoration:none;color:inherit">
        <div class="ctx-conn-dot"></div>
        <div><div style="font-size:11px;color:var(--text-muted)">${c.target_name}</div>
        <div class="ctx-rel">${c.relation||''}</div></div>
      </a>`;
    });
    html += '</div>';
  }
  
  el.innerHTML = html;
}

function toggleCtx() {
  document.getElementById('ctxPanel').classList.toggle('open');
  document.getElementById('ctxBtn').classList.toggle('on');
}

function openFiles() {
  if (!currentTopic) return;
  const t = topicsCache[currentTopic];
  if (!t) return;
  // Open the first document link, or toggle context panel
  const meta = JSON.parse(t.meta||'{}');
  if (!document.getElementById('ctxPanel').classList.contains('open')) {
    toggleCtx();
  }
}

// ── TRUST ──
async function loadTrust() {
  const trust = await fetch(API+'/trust').then(r=>r.json());
  const el = document.getElementById('trustFooter');
  el.innerHTML = trust.map(t => `<div class="trust-mini">${t.agent}: ${t.score}</div>`).join('');
}

// ── UTILS ──
// ── ACTIONS ──
async function generateCV() {
  if (!currentTopic) return;
  const btn = document.getElementById('genCvBtn');
  btn.textContent = 'Generating...';
  btn.style.pointerEvents = 'none';
  try {
    const r = await fetch(API+'/actions/generate-cv/'+currentTopic, {method:'POST'});
    if (!r.ok) {
      const err = await r.json();
      alert('Error: ' + (err.detail || 'Failed'));
    }
    // WebSocket will update the UI
  } catch(e) {
    alert('Error: ' + e.message);
  }
  btn.textContent = 'Generate CV';
  btn.style.pointerEvents = 'auto';
}

// ── FILE VIEWER ──
let currentFileContent = '';
let currentFileUrl = '';

async function openFile(path, name, type) {
  const overlay = document.getElementById('fileOverlay');
  const title = document.getElementById('overlayTitle');
  const pathEl = document.getElementById('overlayPath');
  const body = document.getElementById('overlayBody');
  const openBtn = document.getElementById('overlayOpenBtn');
  
  title.textContent = name;
  body.innerHTML = '<div class="loading">Loading...</div>';
  overlay.classList.add('open');
  currentFileContent = '';
  currentFileUrl = '';
  
  if (type === 'email') {
    // Open Gmail search for this email context
    const searchUrl = 'https://mail.google.com/mail/u/0/#search/' + encodeURIComponent(name);
    pathEl.textContent = 'Gmail Search';
    body.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:13px;margin-bottom:16px">Search Gmail for "${name}"</div>
      <button class="primary" style="padding:10px 24px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;cursor:pointer" onclick="window.open('${searchUrl}','_blank')">Open in Gmail</button>
    </div>`;
    openBtn.style.display = 'inline-block';
    openBtn.onclick = () => window.open(searchUrl, '_blank');
    return;
  }
  
  if (!path) { body.innerHTML = 'No file path available.'; return; }
  
  pathEl.textContent = path;
  
  // PDF — can't render inline, offer to open
  if (path.endsWith('.pdf')) {
    body.innerHTML = `<div style="text-align:center;padding:30px">
      <div style="font-size:13px;margin-bottom:8px">PDF files cannot be previewed inline.</div>
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:16px">${path}</div>
      <button class="primary" style="padding:10px 24px;border-radius:6px;background:var(--text);color:var(--bg);border:none;font-family:inherit;font-size:12px;cursor:pointer" onclick="alert('Open: ${path}')">Reveal in Finder</button>
    </div>`;
    openBtn.style.display = 'none';
    return;
  }
  
  // Text/MD files — fetch content
  try {
    const r = await fetch(API + '/file?path=' + encodeURIComponent(path));
    if (!r.ok) throw new Error((await r.json()).detail || 'Failed to load');
    const data = await r.json();
    currentFileContent = data.content;
    body.textContent = data.content;
    if (data.truncated) body.innerHTML += '\n\n<span style="color:var(--warm)">[Truncated at 50KB]</span>';
    openBtn.style.display = 'none';
  } catch (e) {
    body.innerHTML = `<div style="color:var(--danger)">${e.message}</div>`;
  }
}

function closeOverlay() {
  document.getElementById('fileOverlay').classList.remove('open');
}

function copyFileContent() {
  if (currentFileContent) {
    navigator.clipboard.writeText(currentFileContent);
    // Brief feedback
    const btn = document.querySelector('.overlay-actions button');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy Content', 1500);
  }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeOverlay();
});

function copyDraft(btn) {
  const draft = btn.closest('.opt-body').querySelector('.draft-box');
  if (draft) navigator.clipboard.writeText(draft.textContent.replace('Draft','').trim());
  btn.textContent = 'Copied';
  setTimeout(()=>btn.textContent='Copy',2000);
}

document.getElementById('inputField').addEventListener('input', function() {
  this.style.height='auto';
  this.style.height=Math.min(this.scrollHeight,120)+'px';
});

// ── WEBSOCKET ──
let ws = null;
let wsRetry = 0;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');
  
  ws.onopen = () => {
    wsRetry = 0;
    document.getElementById('wsStatus').style.background = '#4a9'; // green = connected
    console.log('[ws] connected');
    // Ping every 30s to keep alive
    ws._ping = setInterval(() => { try { ws.send('ping'); } catch(e) {} }, 30000);
  };
  
  // Debounced reload — collect events, fire once after 300ms
  let _reloadTimer = null;
  let _pendingReloads = {topic: false, list: false, pipeline: false, trust: false};
  
  function scheduleReload(what) {
    _pendingReloads[what] = true;
    if (_reloadTimer) clearTimeout(_reloadTimer);
    _reloadTimer = setTimeout(() => {
      const conv = document.getElementById('conv');
      const wasAtBottom = conv.scrollHeight - conv.scrollTop - conv.clientHeight < 60;
      const oldScroll = conv.scrollTop;
      
      if (_pendingReloads.topic && currentTopic) {
        selectTopic(currentTopic).then(() => {
          // Preserve scroll unless user was at bottom
          if (wasAtBottom) conv.scrollTop = conv.scrollHeight;
          else conv.scrollTop = oldScroll;
        });
      }
      if (_pendingReloads.list) loadTopics();
      if (_pendingReloads.pipeline) loadPipeline();
      if (_pendingReloads.trust) loadTrust();
      
      _pendingReloads = {topic: false, list: false, pipeline: false, trust: false};
      _reloadTimer = null;
    }, 300);
  }
  
  ws.onmessage = (e) => {
    const event = JSON.parse(e.data);
    if (event.type === 'pong') return;
    
    if (event.type === 'message') {
      if (event.topic_id === currentTopic) scheduleReload('topic');
      scheduleReload('list');
    }
    
    if (event.type === 'topic_update') {
      if (event.topic_id === currentTopic) scheduleReload('topic');
      scheduleReload('list');
      scheduleReload('pipeline');
    }
    
    if (event.type === 'trust_update') {
      scheduleReload('trust');
    }
  };
  
  ws.onclose = () => {
    document.getElementById('wsStatus').style.background = 'var(--danger)'; // red = disconnected
    console.log('[ws] disconnected');
    clearInterval(ws._ping);
    // Reconnect with backoff
    wsRetry++;
    const delay = Math.min(1000 * Math.pow(2, wsRetry), 10000);
    setTimeout(connectWS, delay);
  };
  
  ws.onerror = () => { ws.close(); };
}

// ── START ──
init();
connectWS();
</script>
</body>
</html>
